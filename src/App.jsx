/*
 * MODUS - Complete Edition - All Features
 * 
 * Enhanced for maximum consistency:
 * - Deterministic prompts with strict rules
 * - Numerical scoring systems
 * - Cross-validation between analysis passes
 * - Cached results for identical images
 * - Structured checklists for pattern recognition
 */

import { useState, useRef, useEffect, useMemo, useCallback } from "react";
import { Upload, TrendingUp, TrendingDown, Minus, Loader2, AlertTriangle, BarChart2, BarChart3, RefreshCw, Target, Shield, Clock, DollarSign, Activity, Zap, Eye, Calendar, Star, ArrowUpRight, ArrowDownRight, ArrowLeft, ArrowRight, Sparkles, MessageCircle, Send, HelpCircle, Check, X, Key, Settings, Bell, BellOff, LineChart, Camera, Layers, ArrowUpDown, AlertCircle, List, Plus, Download, PieChart, Wallet, CalendarDays, Search, ChevronLeft, ChevronRight, ChevronUp, ChevronDown, Info, Flame, Pencil, Save, Newspaper, Calculator, Menu, User, LogOut, LogIn, Mail, Lock, Cloud, CloudOff, Lightbulb, GripVertical, Globe, Brain, Trophy, Gauge, BookOpen, Hash, Crosshair, Timer, LayoutGrid, Command, BellRing, Compass } from "lucide-react";
import { COMPANY_NAMES, getCompanyName, PRIORITY_STOCKS } from "./constants/stockData";
import { useAuth } from "./contexts/AuthContext";

function App() {
  // Inject global CSS for smooth animations and polished UI
  useEffect(() => {
    if (!document.getElementById('modus-styles')) {
      const styleSheet = document.createElement('style');
      styleSheet.id = 'modus-styles';
      styleSheet.textContent = `
        /* =============================================
           MODUS PREMIUM - Trading Grade UI System
           ============================================= */

        /* Core Animations */
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(8px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
          from { opacity: 0; transform: translateX(-10px); }
          to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideUp {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pageTransition {
          from { opacity: 0; transform: translateY(12px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse-glow {
          0%, 100% { box-shadow: 0 0 5px rgba(139, 92, 246, 0.3); }
          50% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.6); }
        }
        @keyframes shimmer {
          0% { background-position: -200% 0; }
          100% { background-position: 200% 0; }
        }
        @keyframes borderGlow {
          0%, 100% { border-color: rgba(139, 92, 246, 0.2); }
          50% { border-color: rgba(139, 92, 246, 0.5); }
        }
        @keyframes priceUp {
          0% { color: #10b981; text-shadow: 0 0 6px rgba(16, 185, 129, 0.35); }
          100% { color: inherit; text-shadow: none; }
        }
        @keyframes priceDown {
          0% { color: #ef4444; text-shadow: 0 0 6px rgba(239, 68, 68, 0.35); }
          100% { color: inherit; text-shadow: none; }
        }
        @keyframes glowPulse {
          0%, 100% { opacity: 0.4; }
          50% { opacity: 0.8; }
        }
        @keyframes subtleBreathe {
          0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
          50% { box-shadow: 0 0 30px 0 rgba(139, 92, 246, 0.08); }
        }
        @keyframes numberRoll {
          from { transform: translateY(-100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }

        .animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; will-change: opacity, transform; }
        .animate-slideIn { animation: slideIn 0.2s ease-out forwards; will-change: opacity, transform; }
        .animate-slideUp { animation: slideUp 0.3s ease-out forwards; will-change: opacity, transform; }
        .animate-page-transition { animation: pageTransition 0.35s ease-out forwards; will-change: opacity, transform; }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; will-change: box-shadow; }
        .animate-price-up { animation: priceUp 0.6s ease-out; will-change: color, text-shadow; }
        .animate-price-down { animation: priceDown 0.6s ease-out; will-change: color, text-shadow; }
        .animate-border-glow { animation: borderGlow 3s ease-in-out infinite; will-change: border-color; }
        .animate-number-roll { animation: numberRoll 0.3s ease-out; will-change: transform, opacity; }

        /* Chart Transitions */
        @keyframes chartRefresh {
          0% { opacity: 0.7; }
          100% { opacity: 1; }
        }
        .chart-container { transition: all 0.3s ease-out; }
        .chart-container.refreshing { animation: chartRefresh 0.5s ease-out; }
        .chart-bar { transition: all 0.2s ease-out; }
        .chart-line { transition: d 0.3s ease-out, stroke-dashoffset 0.3s ease-out; }
        .price-update { transition: all 0.3s ease-out; }

        /* =============================================
           Theme System (Feature 8)
           ============================================= */
        :root, .theme-midnight {
          --bg-primary: #0f172a;
          --bg-secondary: #1e293b;
          --bg-card: rgba(15, 23, 42, 0.95);
          --bg-hover: rgba(30, 41, 59, 0.8);
          --text-primary: #f8fafc;
          --text-secondary: #94a3b8;
          --text-muted: #64748b;
          --border-color: rgba(148, 163, 184, 0.12);
          --accent: #8b5cf6;
        }
        .theme-dark {
          --bg-primary: #18181b;
          --bg-secondary: #27272a;
          --bg-card: rgba(24, 24, 27, 0.95);
          --bg-hover: rgba(39, 39, 42, 0.8);
          --text-primary: #fafafa;
          --text-secondary: #a1a1aa;
          --text-muted: #71717a;
          --border-color: rgba(161, 161, 170, 0.15);
          --accent: #8b5cf6;
        }
        .theme-light {
          --bg-primary: #f4f6fb;
          --bg-secondary: #edf0f7;
          --bg-card: rgba(255, 255, 255, 0.98);
          --bg-hover: rgba(241, 245, 249, 0.9);
          --text-primary: #1e293b;
          --text-secondary: #475569;
          --text-muted: #94a3b8;
          --border-color: rgba(148, 163, 184, 0.2);
          --accent: #7c3aed;
        }
        /*
         * LIGHT THEME — Premium Financial App Look
         * Strategy: Keep sidebar + header DARK, lighten main content only.
         * Preserve colored widget gradients, add depth via shadows.
         */

        /* === MAIN CONTENT AREA (not sidebar, not header) === */
        .theme-light .main-content-area,
        .theme-light .dashboard-grid-area {
          background: #f4f6fb !important;
          color: #1e293b !important;
        }

        /* The body/min-h-screen gets a subtle warm gray */
        .theme-light body,
        .theme-light .min-h-screen { background: #f4f6fb !important; color: #1e293b !important; }

        /* === KEEP SIDEBAR DARK (this is key!) === */
        .theme-light .sidebar-glass {
          background: rgba(15, 23, 42, 0.95) !important;
          border-right: 1px solid rgba(148, 163, 184, 0.1) !important;
        }
        /* Sidebar text stays light */
        .theme-light aside .text-white,
        .theme-light aside .text-slate-300,
        .theme-light aside .text-slate-400,
        .theme-light aside .text-slate-200,
        .theme-light aside span,
        .theme-light aside button { color: inherit !important; }

        /* === KEEP HEADER DARK for contrast === */
        .theme-light header[class*="border-b"] {
          background: rgba(15, 23, 42, 0.92) !important;
          backdrop-filter: blur(20px) !important;
        }
        /* Header text stays light */
        .theme-light header .text-white,
        .theme-light header .text-slate-300,
        .theme-light header .text-slate-400,
        .theme-light header span,
        .theme-light header button { color: inherit !important; }

        /* === KEEP FOOTER DARK === */
        .theme-light footer {
          background: rgba(10, 15, 30, 0.85) !important;
        }
        .theme-light footer .text-slate-400,
        .theme-light footer .text-slate-500,
        .theme-light footer span,
        .theme-light footer button { color: inherit !important; }

        /* === CARDS — white with nice depth === */
        .theme-light .card-premium {
          background: rgba(255,255,255,0.97) !important;
          border-color: rgba(0,0,0,0.06) !important;
          box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03) !important;
        }
        .theme-light .card-premium:hover {
          border-color: rgba(124,58,237,0.25) !important;
          box-shadow: 0 2px 8px rgba(124,58,237,0.08), 0 4px 16px rgba(0,0,0,0.05) !important;
        }
        .theme-light .glass {
          background: rgba(255,255,255,0.95) !important;
          border-color: rgba(0,0,0,0.06) !important;
          box-shadow: 0 1px 3px rgba(0,0,0,0.04) !important;
        }

        /* === MAIN CONTENT BACKGROUND OVERRIDES === */
        /* Only override bg-slate-900 inside main content, NOT sidebar/header */
        .theme-light main .bg-slate-900,
        .theme-light section .bg-slate-900 { background: #f4f6fb !important; }

        .theme-light main .bg-slate-800\\/30,
        .theme-light main .bg-slate-800\\/40,
        .theme-light main .bg-slate-800\\/50,
        .theme-light main .bg-slate-800\\/60,
        .theme-light section .bg-slate-800\\/30,
        .theme-light section .bg-slate-800\\/40,
        .theme-light section .bg-slate-800\\/50,
        .theme-light section .bg-slate-800\\/60 { background: rgba(255,255,255,0.85) !important; box-shadow: 0 1px 2px rgba(0,0,0,0.03) !important; }

        .theme-light main .bg-slate-700\\/30,
        .theme-light main .bg-slate-700\\/50 { background: rgba(0,0,0,0.03) !important; }

        /* === MAIN CONTENT TEXT — good contrast hierarchy === */
        .theme-light main .text-white,
        .theme-light section .text-white { color: #1e293b !important; }
        .theme-light main .text-slate-200 { color: #334155 !important; }
        .theme-light main .text-slate-300 { color: #475569 !important; }
        .theme-light main .text-slate-400 { color: #64748b !important; }
        .theme-light main .text-slate-500 { color: #94a3b8 !important; }

        /* Keep colored text vibrant — override ONLY the text-white/slate conversions */
        .theme-light .text-emerald-400 { color: #059669 !important; }
        .theme-light .text-red-400 { color: #dc2626 !important; }
        .theme-light .text-violet-400 { color: #7c3aed !important; }
        .theme-light .text-amber-400 { color: #d97706 !important; }
        .theme-light .text-cyan-400 { color: #0891b2 !important; }
        .theme-light .text-blue-400 { color: #2563eb !important; }
        .theme-light .text-orange-400 { color: #ea580c !important; }
        .theme-light .text-indigo-400 { color: #4f46e5 !important; }

        /* === BORDERS in main content === */
        .theme-light main .border-slate-700\\/10,
        .theme-light main .border-slate-700\\/15,
        .theme-light main .border-slate-700\\/20,
        .theme-light main .border-slate-700\\/30,
        .theme-light main .border-slate-700\\/50,
        .theme-light main .border-slate-800\\/20,
        .theme-light main .border-slate-800\\/30,
        .theme-light section .border-slate-700\\/10,
        .theme-light section .border-slate-700\\/20,
        .theme-light section .border-slate-700\\/30,
        .theme-light section .border-slate-800\\/20,
        .theme-light section .border-slate-800\\/30 { border-color: rgba(0,0,0,0.07) !important; }

        /* === WIDGET GRADIENTS — keep them colorful but softer === */
        .theme-light main [class*="from-emerald-500"] { background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(255,255,255,0.95)) !important; }
        .theme-light main [class*="from-orange-500"] { background: linear-gradient(135deg, rgba(249,115,22,0.08), rgba(255,255,255,0.95)) !important; }
        .theme-light main [class*="from-blue-500"] { background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(255,255,255,0.95)) !important; }
        .theme-light main [class*="from-cyan-500"] { background: linear-gradient(135deg, rgba(6,182,212,0.08), rgba(255,255,255,0.95)) !important; }
        .theme-light main [class*="from-amber-500"] { background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(255,255,255,0.95)) !important; }
        .theme-light main [class*="from-indigo-500"] { background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(255,255,255,0.95)) !important; }
        .theme-light main [class*="from-violet-500"] { background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(255,255,255,0.95)) !important; }
        .theme-light main [class*="from-red-500"] { background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(255,255,255,0.95)) !important; }
        .theme-light main [class*="from-rose-500"] { background: linear-gradient(135deg, rgba(244,63,94,0.08), rgba(255,255,255,0.95)) !important; }
        .theme-light main [class*="from-green-500"] { background: linear-gradient(135deg, rgba(34,197,94,0.08), rgba(255,255,255,0.95)) !important; }

        .theme-light .divide-slate-700 > * + * { border-color: rgba(0,0,0,0.06) !important; }

        /* === INPUTS in main content === */
        .theme-light main input,
        .theme-light main textarea,
        .theme-light main select,
        .theme-light section input,
        .theme-light section textarea,
        .theme-light section select {
          background: #ffffff !important;
          color: #1e293b !important;
          border-color: rgba(0,0,0,0.12) !important;
          box-shadow: 0 1px 2px rgba(0,0,0,0.04) !important;
        }
        .theme-light main input::placeholder,
        .theme-light main textarea::placeholder,
        .theme-light section input::placeholder { color: #94a3b8 !important; }

        /* Inputs get a nice focus ring */
        .theme-light main input:focus,
        .theme-light main textarea:focus,
        .theme-light main select:focus {
          border-color: rgba(124,58,237,0.4) !important;
          box-shadow: 0 0 0 3px rgba(124,58,237,0.1) !important;
        }

        /* === MODALS stay dark (they look better dark) === */
        .theme-light [class*="z-modal"] .text-white,
        .theme-light [class*="z-modal"] .text-slate-300,
        .theme-light [class*="z-modal"] .text-slate-400,
        .theme-light [class*="z-modal"] .text-slate-200,
        .theme-light [class*="z-modal"] .bg-slate-900,
        .theme-light [class*="z-modal"] .bg-slate-800 { color: inherit !important; background: inherit !important; }

        /* === SCROLLBAR for light mode === */
        .theme-light main ::-webkit-scrollbar-track { background: #edf0f7; }
        .theme-light main ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .theme-light main ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* === BADGES & PILLS keep their color intensity === */
        .theme-light .bg-emerald-500\\/10 { background: rgba(16,185,129,0.12) !important; }
        .theme-light .bg-red-500\\/10 { background: rgba(239,68,68,0.12) !important; }
        .theme-light .bg-violet-500\\/10,
        .theme-light .bg-violet-500\\/15 { background: rgba(124,58,237,0.12) !important; }
        .theme-light .bg-amber-500\\/10,
        .theme-light .bg-amber-500\\/15 { background: rgba(245,158,11,0.12) !important; }
        .theme-light .bg-cyan-500\\/10,
        .theme-light .bg-cyan-500\\/15 { background: rgba(6,182,212,0.12) !important; }
        .theme-light .bg-blue-500\\/10,
        .theme-light .bg-blue-500\\/15 { background: rgba(59,130,246,0.12) !important; }
        .theme-light .bg-emerald-500\\/15 { background: rgba(16,185,129,0.12) !important; }
        .theme-light .bg-orange-500\\/15 { background: rgba(249,115,22,0.12) !important; }

        /* === BUTTONS in main content === */
        .theme-light main .bg-slate-800 { background: #f1f5f9 !important; }
        .theme-light main .hover\\:bg-slate-700:hover { background: #e2e8f0 !important; }

        /* Keep gradient buttons (violet/purple) as-is */
        .theme-light main [class*="from-violet-600"],
        .theme-light main [class*="from-purple-600"] { background: inherit !important; color: white !important; }
        .theme-light main [class*="from-violet-600"] .text-white,
        .theme-light main [class*="from-purple-600"] .text-white { color: white !important; }

        /* Trade Replay animation */
        @keyframes replayPulse {
          0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
          50% { box-shadow: 0 0 0 8px rgba(139, 92, 246, 0); }
        }
        .replay-pulse { animation: replayPulse 2s ease-in-out infinite; }

        /* =============================================
           Premium Card System
           ============================================= */

        /* Glass morphism card - the default card style */
        .glass {
          background: rgba(15, 23, 42, 0.75);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border: 1px solid rgba(148, 163, 184, 0.12);
          transition: all 0.3s ease;
        }

        /* Enhanced sidebar glass effect */
        .sidebar-glass {
          background: rgba(15, 23, 42, 0.85);
          backdrop-filter: blur(24px);
          -webkit-backdrop-filter: blur(24px);
          border-right: 1px solid rgba(148, 163, 184, 0.1);
          box-shadow: inset -1px 0 0 rgba(148, 163, 184, 0.05);
        }

        /* Premium card with subtle inner glow */
        .card-premium {
          background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(20, 29, 48, 0.85) 100%);
          border: 1px solid rgba(148, 163, 184, 0.15);
          box-shadow:
            0 2px 8px rgba(0, 0, 0, 0.15),
            inset 0 0.5px 0 rgba(148, 163, 184, 0.08);
          transition: all 0.25s ease;
        }
        .card-premium:hover {
          border-color: rgba(139, 92, 246, 0.2);
          box-shadow:
            0 4px 16px rgba(0, 0, 0, 0.2),
            0 0 0 0.5px rgba(139, 92, 246, 0.08),
            inset 0 0.5px 0 rgba(148, 163, 184, 0.1);
          transform: translateY(-0.5px);
        }

        /* Gain card - subtle green accent */
        .card-gain {
          background: linear-gradient(135deg, rgba(6, 78, 59, 0.08) 0%, rgba(15, 23, 42, 0.9) 100%);
          border: 1px solid rgba(16, 185, 129, 0.12);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 0 20px rgba(16, 185, 129, 0.02);
          transition: all 0.25s ease;
        }
        .card-gain:hover {
          border-color: rgba(16, 185, 129, 0.2);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), inset 0 0 20px rgba(16, 185, 129, 0.03);
          transform: translateY(-0.5px);
        }

        /* Loss card - subtle red accent */
        .card-loss {
          background: linear-gradient(135deg, rgba(127, 29, 29, 0.08) 0%, rgba(15, 23, 42, 0.9) 100%);
          border: 1px solid rgba(239, 68, 68, 0.12);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 0 20px rgba(239, 68, 68, 0.02);
          transition: all 0.25s ease;
        }
        .card-loss:hover {
          border-color: rgba(239, 68, 68, 0.2);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), inset 0 0 20px rgba(239, 68, 68, 0.03);
          transform: translateY(-0.5px);
        }

        /* =============================================
           Button System
           ============================================= */
        .btn-primary {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 0.625rem 1.25rem;
          font-size: 0.9375rem;
          font-weight: 500;
          letter-spacing: 0.3px;
          border-radius: 6px;
          background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
          color: white;
          border: 1px solid rgba(139, 92, 246, 0.3);
          box-shadow:
            0 2px 8px rgba(139, 92, 246, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
          transition: all 0.25s ease;
          cursor: pointer;
          position: relative;
          overflow: hidden;
        }
        .btn-primary:hover {
          transform: translateY(-1px);
          box-shadow:
            0 4px 16px rgba(139, 92, 246, 0.25),
            inset 0 1px 0 rgba(255, 255, 255, 0.15);
          background: linear-gradient(135deg, #9d5fef 0%, #8b5cf6 100%);
        }
        .btn-primary:active {
          transform: translateY(0);
          box-shadow:
            0 2px 8px rgba(139, 92, 246, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        .btn-primary:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          transform: none;
        }

        /* =============================================
           Section Headers
           ============================================= */
        .section-header {
          font-size: 1.125rem;
          font-weight: 600;
          letter-spacing: 0.5px;
          color: #f1f5f9;
          display: flex;
          align-items: center;
          gap: 0.5rem;
          position: relative;
          margin-bottom: 1.5rem;
        }
        .section-header::before {
          content: '';
          display: inline-block;
          width: 3px;
          height: 1.5rem;
          border-radius: 2px;
          background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);
        }

        /* =============================================
           Badge System
           ============================================= */
        .badge {
          display: inline-flex;
          align-items: center;
          gap: 0.375rem;
          padding: 0.375rem 0.75rem;
          border-radius: 4px;
          font-size: 0.8125rem;
          font-weight: 500;
          letter-spacing: 0.25px;
          white-space: nowrap;
        }

        .badge-success {
          background: rgba(16, 185, 129, 0.12);
          color: #6ee7b7;
          border: 1px solid rgba(16, 185, 129, 0.25);
        }

        .badge-warning {
          background: rgba(251, 146, 60, 0.12);
          color: #fed7aa;
          border: 1px solid rgba(251, 146, 60, 0.25);
        }

        .badge-danger {
          background: rgba(239, 68, 68, 0.12);
          color: #fca5a5;
          border: 1px solid rgba(239, 68, 68, 0.25);
        }

        .badge-info {
          background: rgba(59, 130, 246, 0.12);
          color: #93c5fd;
          border: 1px solid rgba(59, 130, 246, 0.25);
        }

        /* =============================================
           Glow & Shadow System
           ============================================= */
        .glow-violet { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
        .glow-emerald { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .glow-red { box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
        .glow-ambient-up { box-shadow: 0 0 40px rgba(16, 185, 129, 0.06); }
        .glow-ambient-down { box-shadow: 0 0 40px rgba(239, 68, 68, 0.06); }

        /* Hover card lift - enhanced */
        .hover-lift {
          transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }
        .hover-lift:hover {
          transform: translateY(-2px);
          box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        }

        /* Button press */
        .btn-press { transition: transform 0.1s ease; }
        .btn-press:active { transform: scale(0.97); }

        /* =============================================
           Typography & Text Effects
           ============================================= */
        * {
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
        .tabular-nums { font-variant-numeric: tabular-nums; }

        .gradient-text {
          background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 40%, #7c3aed 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }

        /* Price text with glow on update */
        .price-text-up {
          color: #10b981;
          text-shadow: 0 0 8px rgba(16, 185, 129, 0.25);
        }
        .price-text-down {
          color: #ef4444;
          text-shadow: 0 0 8px rgba(239, 68, 68, 0.25);
        }

        /* =============================================
           Interactive Effects
           ============================================= */

        /* Card shine on hover */
        .card-shine {
          position: relative;
          overflow: hidden;
        }
        .card-shine::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 60%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
          transition: left 0.6s ease;
          pointer-events: none;
          z-index: 1;
        }
        .card-shine:hover::before { left: 150%; }

        /* Animated border gradient */
        .border-glow {
          position: relative;
          border: 1px solid transparent;
          background-clip: padding-box;
        }
        .border-glow::after {
          content: '';
          position: absolute;
          inset: -1px;
          border-radius: inherit;
          background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), transparent 40%, transparent 60%, rgba(99, 102, 241, 0.2));
          z-index: -1;
          opacity: 0;
          transition: opacity 0.3s ease;
        }
        .border-glow:hover::after { opacity: 1; }

        /* =============================================
           Scrollbar (Premium Thin)
           ============================================= */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track {
          background: rgba(15, 23, 42, 0.3);
          border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
          background: rgba(100, 116, 139, 0.35);
          border-radius: 3px;
          transition: background 0.2s;
        }
        ::-webkit-scrollbar-thumb:hover {
          background: rgba(139, 92, 246, 0.5);
        }

        /* =============================================
           Skeleton & Loading States
           ============================================= */
        .skeleton {
          background: linear-gradient(90deg, rgba(30,41,59,0.8) 25%, rgba(51,65,85,0.5) 50%, rgba(30,41,59,0.8) 75%);
          background-size: 200% 100%;
          animation: shimmer 1.5s ease-in-out infinite;
          border-radius: 6px;
        }
        .skeleton-pulse {
          background: linear-gradient(90deg, rgba(30,41,59,0.8) 25%, rgba(51,65,85,0.6) 50%, rgba(30,41,59,0.8) 75%);
          background-size: 200% 100%;
          animation: shimmer 1.5s ease-in-out infinite;
        }

        /* Loading shimmer bar */
        .loading-bar {
          height: 2px;
          background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.6), transparent);
          background-size: 200% 100%;
          animation: shimmer 1.2s ease-in-out infinite;
        }

        /* =============================================
           Focus & Accessibility
           ============================================= */
        .focus-ring:focus-visible {
          outline: 2px solid rgba(139, 92, 246, 0.6);
          outline-offset: 2px;
        }

        /* =============================================
           Status Indicators
           ============================================= */
        .status-live {
          width: 8px; height: 8px;
          border-radius: 50%;
          background: #10b981;
          box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
          animation: glowPulse 2s ease-in-out infinite;
        }
        .status-offline {
          width: 8px; height: 8px;
          border-radius: 50%;
          background: #64748b;
        }

        /* =============================================
           Mobile Utilities
           ============================================= */
        @media (max-width: 768px) {
          .mobile-full { width: 100% !important; }
          .mobile-stack { flex-direction: column !important; }
          .mobile-gap-2 { gap: 0.5rem !important; }
          .mobile-text-sm { font-size: 0.875rem !important; }
          .mobile-p-3 { padding: 0.75rem !important; }
          .mobile-hidden { display: none !important; }
          .mobile-grid-1 { grid-template-columns: 1fr !important; }
        }

        .scroll-touch {
          -webkit-overflow-scrolling: touch;
          overscroll-behavior: contain;
        }
        .tab-content { animation: fadeIn 0.15s ease-out; }
        .min-h-card { min-height: 200px; }
        .min-h-chart { min-height: 300px; }

        /* =============================================
           Premium Progress Bars
           ============================================= */
        .progress-bar {
          height: 6px;
          border-radius: 3px;
          background: rgba(30, 41, 59, 0.8);
          overflow: hidden;
        }
        .progress-bar-fill {
          height: 100%;
          border-radius: 3px;
          transition: width 0.6s ease-out;
          position: relative;
        }
        .progress-bar-fill::after {
          content: '';
          position: absolute;
          top: 0; right: 0;
          width: 30%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15));
        }

        /* =============================================
           Data Badge System
           ============================================= */
        .badge {
          display: inline-flex;
          align-items: center;
          gap: 4px;
          padding: 2px 8px;
          border-radius: 6px;
          font-size: 11px;
          font-weight: 600;
          letter-spacing: 0.01em;
        }
        .badge-gain { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-loss { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }
        .badge-neutral { background: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid rgba(100, 116, 139, 0.15); }
        .badge-info { background: rgba(139, 92, 246, 0.15); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.2); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.2); }
      `;
      document.head.appendChild(styleSheet);
    }
    // Dismiss splash screen once React has mounted
    const splash = document.getElementById('splash');
    if (splash) {
      splash.classList.add('fade-out');
      setTimeout(() => splash.remove(), 500);
    }
  }, []);

  // Reusable Skeleton Loader Component
  const SkeletonBlock = useCallback(({ width = '100%', height = '16px', rounded = 'rounded', className = '' }) => (
    <div
      className={`bg-slate-800/60 ${rounded} animate-pulse ${className}`}
      style={{ width, height, background: 'linear-gradient(90deg, rgba(30,41,59,0.5) 25%, rgba(51,65,85,0.5) 50%, rgba(30,41,59,0.5) 75%)', backgroundSize: '200% 100%', animation: 'shimmer 1.5s infinite' }}
    />
  ), []);

  const SkeletonCard = useCallback(({ lines = 3, className = '' }) => (
    <div className={`p-4 bg-slate-800/30 rounded-xl border border-slate-700/20 space-y-3 ${className}`}>
      <SkeletonBlock height="20px" width="60%" rounded="rounded-md" />
      {Array.from({ length: lines }).map((_, i) => (
        <SkeletonBlock key={i} height="14px" width={`${85 - i * 15}%`} rounded="rounded" />
      ))}
    </div>
  ), [SkeletonBlock]);

  const SkeletonTable = useCallback(({ rows = 5, cols = 4 }) => (
    <div className="space-y-2">
      <div className="flex gap-4 p-3">
        {Array.from({ length: cols }).map((_, i) => (
          <SkeletonBlock key={i} height="12px" width={`${100/cols - 2}%`} rounded="rounded" />
        ))}
      </div>
      {Array.from({ length: rows }).map((_, r) => (
        <div key={r} className="flex gap-4 p-3 bg-slate-800/20 rounded-lg">
          {Array.from({ length: cols }).map((_, c) => (
            <SkeletonBlock key={c} height="14px" width={`${100/cols - 2}%`} rounded="rounded" />
          ))}
        </div>
      ))}
    </div>
  ), [SkeletonBlock]);

  const SkeletonChart = useCallback(() => (
    <div className="p-6 bg-slate-800/30 rounded-xl border border-slate-700/20 space-y-4">
      <div className="flex items-center justify-between">
        <SkeletonBlock height="24px" width="120px" rounded="rounded-md" />
        <SkeletonBlock height="32px" width="80px" rounded="rounded-lg" />
      </div>
      <div className="h-48 bg-slate-800/40 rounded-lg flex items-end justify-around gap-1 p-4">
        {Array.from({ length: 12 }).map((_, i) => (
          <div key={i} className="bg-slate-700/40 rounded-t animate-pulse" style={{ width: '7%', height: `${20 + Math.random() * 70}%`, animationDelay: `${i * 0.1}s` }} />
        ))}
      </div>
      <div className="flex gap-4">
        <SkeletonBlock height="14px" width="25%" rounded="rounded" />
        <SkeletonBlock height="14px" width="25%" rounded="rounded" />
        <SkeletonBlock height="14px" width="25%" rounded="rounded" />
      </div>
    </div>
  ), [SkeletonBlock]);

  // Production mode - set to false to disable console logs
  const DEBUG_MODE = false;
  const log = (...args) => DEBUG_MODE && console.log(...args);
  
  // Time
  const [currentTime, setCurrentTime] = useState(new Date());

  // Tooltip hover states
  const [activeTooltip, setActiveTooltip] = useState(null);
  
  // API Keys & Backend Mode
  const [apiKey, setApiKey] = useState("");
  const [stockApiKey, setStockApiKey] = useState(""); // NEW: For stock ticker data
  const [showApiKeyModal, setShowApiKeyModal] = useState(false);
  const [apiKeyInput, setApiKeyInput] = useState("");
  const [stockApiKeyInput, setStockApiKeyInput] = useState(""); // NEW

  // Changelog / Updates notification system
  const [showChangelog, setShowChangelog] = useState(false);
  const [showShortcutsOverlay, setShowShortcutsOverlay] = useState(false);
  const [showQuickTradeEntry, setShowQuickTradeEntry] = useState(false);
  const changelogEntries = [
    {
      version: '2.2.0',
      date: '2026-02-08',
      title: 'Detailed Pages, New Widgets, Bug Fixes & Keyboard Shortcuts',
      changes: [
        { type: 'fix', text: 'Fixed widget crashes — BarChart2 and Brain icons were missing from imports, causing Sector Heatmap, Correlations, Pattern Scanner, Weekly Report, and AI Trade Coach widgets to crash' },
        { type: 'feature', text: 'Journal tab now has sub-tabs: Trade Log, Analytics (equity curve, win/loss by day/time, trade duration), Monthly P&L (full calendar), Weekly Report (expanded stats), and Mistakes (detailed tracker)' },
        { type: 'feature', text: 'Screener tab now has sub-tabs: Stock Screener, Pre-Market Movers (detailed gainers/losers/volume tables), and Chart Patterns (expanded scanner)' },
        { type: 'feature', text: 'Keyboard Shortcuts overlay — press ? to see all shortcuts, N for quick trade entry' },
        { type: 'feature', text: 'Quick Trade Entry modal — press N to instantly look up any ticker or jump to journal' },
        { type: 'feature', text: 'Equity Curve widget — visual line chart of your cumulative P&L over time' },
        { type: 'feature', text: 'Achievements widget — earn badges for milestones like first trade, 3-win streak, 60%+ win rate, 5+ stocks traded' },
        { type: 'feature', text: 'Trade Emotion Logger widget — tap your emotion before trading to track psychological patterns' },
        { type: 'feature', text: 'Win/Loss by Day of Week widget — see which days you trade best and worst' },
        { type: 'improvement', text: 'Pre-Market Movers now has dedicated detailed page under Screener tab with separate gainers, losers, and high-volume tables' },
        { type: 'improvement', text: 'Pattern Scanner now has dedicated detailed page under Screener tab with confidence meters and pattern descriptions' },
        { type: 'improvement', text: 'Journal Analytics page shows equity curve, win/loss by day, and trade duration metrics' },
        { type: 'improvement', text: 'Monthly P&L now has its own dedicated page with month navigation and summary statistics' },
        { type: 'fix', text: 'Added 12 missing Lucide icon imports (BarChart2, Brain, Trophy, Gauge, BookOpen, Hash, Crosshair, Timer, LayoutGrid, Command, BellRing, Compass)' },
        { type: 'improvement', text: 'Performance optimizations — added input guards to keyboard shortcuts to prevent triggering while typing' },
      ]
    },
    {
      version: '2.0.0',
      date: '2026-02-08',
      title: '8 Major Features + Full Widget Redesign',
      changes: [
        { type: 'feature', text: 'Earnings Calendar Widget — upcoming earnings with dates, EPS estimates, and watchlist highlighting' },
        { type: 'feature', text: 'Trade Replay Mode — review closed trades with visual entry/exit chart, P&L breakdown, and share option' },
        { type: 'feature', text: 'Risk Dashboard Widget — real-time portfolio exposure, concentration risk, max drawdown, and risk score' },
        { type: 'feature', text: 'Community Feed — share Quick Analysis results and trade replays to a social feed' },
        { type: 'feature', text: 'Price Target Tracking — auto-tracks Quick Analysis predictions with hit rate scoring' },
        { type: 'feature', text: 'Custom Watchlist Groups — organize watchlist into custom groups (Tech, Earnings, Momentum, etc.)' },
        { type: 'feature', text: 'PWA Support — install MODUS as a standalone app with offline caching and push notification capability' },
        { type: 'feature', text: 'Theme Toggle — switch between Midnight, Dark, and Light themes from the dashboard' },
        { type: 'improvement', text: 'Complete widget redesign — every widget now has gradient backgrounds, icon badges, colored borders, and polished empty states' },
        { type: 'improvement', text: 'Light theme is now a soft off-white instead of harsh pure white' },
        { type: 'improvement', text: 'Earnings Calendar badges use clean "1D", "TDY" format instead of ugly "Tomorrow" text' },
        { type: 'improvement', text: 'PWA install only shows when browser actually supports installation' },
        { type: 'improvement', text: 'Market Summary shows index full names (S&P 500, Nasdaq, etc.) and average market change' },
        { type: 'improvement', text: 'News items now have colored sentiment borders (green=bullish, red=bearish)' },
        { type: 'improvement', text: 'Hot Stocks has labeled Gainers/Losers sections with trend arrows' },
        { type: 'improvement', text: 'Portfolio shows total value, allocation bars, and clickable positions' },
        { type: 'feature', text: 'Keyboard shortcut: "t" cycles themes, "d" goes to dashboard, "j" goes to journal' },
      ]
    },
    {
      version: '1.9.0',
      date: '2026-02-08',
      title: 'UI Polish, Enhanced Widgets & Keyboard Shortcuts',
      changes: [
        { type: 'fix', text: 'Fixed profile dropdown hard to see — now solid background for full visibility' },
        { type: 'fix', text: 'Fixed notification panel transparency — same solid background treatment' },
        { type: 'fix', text: 'Fixed Tell Me More showing raw **markdown** asterisks — now properly rendered' },
        { type: 'fix', text: 'Fixed Market Mood widget crash when added to dashboard (was referencing wrong state)' },
        { type: 'fix', text: 'Fixed dashboard Quick Analyze bar too close to surrounding elements — added spacing' },
        { type: 'improvement', text: 'Quick Analysis tab spacing increased — no longer clumped together' },
        { type: 'improvement', text: 'Quick Analysis loading state now shows animated progress steps' },
        { type: 'improvement', text: 'Quick Analysis history cards redesigned with confidence bars and color-coded borders' },
        { type: 'improvement', text: 'Quick Analysis empty state now shows popular ticker quick-pick buttons' },
        { type: 'feature', text: 'Keyboard shortcut: press "/" on dashboard to focus Quick Analyze, "q" for Quick Analysis tab' },
        { type: 'feature', text: 'Today\'s Activity strip on dashboard — shows quick analyses, chart analyses, trades logged, and watchlist count' },
        { type: 'improvement', text: 'Hot Stocks widget now shows both gainers AND losers, with clickable symbols that open live charts' },
        { type: 'improvement', text: 'Watchlist widget items now navigate to that specific stock\'s chart when clicked' },
        { type: 'improvement', text: 'Enhanced all dashboard widget empty states with icons and action buttons' },
        { type: 'improvement', text: 'Market Summary indices are now clickable — opens live chart for that symbol' },
        { type: 'improvement', text: 'History cards now have "Clear all" option and item count badge' },
      ]
    },
    {
      version: '1.8.0',
      date: '2026-02-08',
      title: 'Data Accuracy, Structured Deep Dive & Firebase Production',
      changes: [
        { type: 'fix', text: 'Fixed Quick Analysis showing $0.00 for target/stop — added 8 proxy fallbacks and AI prompt validation' },
        { type: 'feature', text: 'Tell Me More now returns structured cards: Technical Analysis, Entry/Exit, Risk, Sector, Scenarios' },
        { type: 'feature', text: 'Added support/resistance levels and risk:reward ratio to Quick Analysis' },
        { type: 'feature', text: 'Added Top Movers ticker bar on dashboard showing gainers and losers' },
        { type: 'feature', text: 'Added Trading Streak and Market Mood widgets to dashboard' },
        { type: 'improvement', text: 'Performance widget now shows visual win/loss bar' },
        { type: 'improvement', text: 'Daily Pick widget redesigned with entry/target/stop grid and confidence bar' },
        { type: 'improvement', text: 'Free Plan badge in user menu, smooth scroll-to-top on tab change' },
        { type: 'feature', text: 'Production Firestore security rules — deploy to stop 30-day testing expiration' },
      ]
    },
    {
      version: '1.7.0',
      date: '2026-02-07',
      title: 'Quick Analysis & UI Improvements',
      changes: [
        { type: 'feature', text: 'Added Quick Analysis tab — enter any ticker for instant AI buy/sell verdict with live data' },
        { type: 'feature', text: 'Quick Analysis includes confidence score, price targets, stop loss, RSI, SMA, and volume data' },
        { type: 'feature', text: '"Tell Me More" button expands into a full technical deep-dive with entry/exit strategy' },
        { type: 'feature', text: 'Analysis history tracks your last 10 quick analyses for easy comparison' },
        { type: 'fix', text: 'Fixed Updates/Changelog popup being transparent and hard to read — now solid modal' },
        { type: 'improvement', text: 'Updates popup redesigned as centered modal with better contrast and readability' },
      ]
    },
    {
      version: '1.6.0',
      date: '2026-02-07',
      title: 'Time in Force, Vocabulary & Splash Screen',
      changes: [
        { type: 'feature', text: 'Added Time in Force section (Day, GTC, FOK, IOC, OPG) to Trade Setup with tooltips' },
        { type: 'feature', text: 'Added comprehensive Vocabulary/Glossary tab with 60+ trading terms and search' },
        { type: 'feature', text: 'Added branded loading splash screen with animated MODUS logo' },
        { type: 'feature', text: 'Added Entry Conditions section to Trade Setup overview' },
        { type: 'fix', text: 'Fixed RSI chart blob artifact at the end of the line' },
        { type: 'fix', text: 'Fixed Previous Questions showing raw markdown instead of clean text' },
        { type: 'improvement', text: 'Custom MODUS favicon replaces default Vite icon' },
        { type: 'improvement', text: 'Mobile browser chrome bar now matches dark theme' },
      ]
    },
    {
      version: '1.5.0',
      date: '2026-02-07',
      title: 'AI Improvements, Trade Setup Overhaul & Bug Fixes',
      changes: [
        { type: 'fix', text: 'Fixed Ask AI timeout error — increased server limits and optimized prompts' },
        { type: 'fix', text: 'Fixed RSI chart rendering artifact at the end' },
        { type: 'feature', text: 'Rewrote Trade Setups tab — now shows setup even when direction is NEUTRAL' },
        { type: 'feature', text: 'Added all 8 brokerage order types with hover tooltips (Market, Limit, Stop, Trailing)' },
        { type: 'fix', text: 'Fixed Trade Setup showing blank/null fields (R:R, direction, win probability)' },
        { type: 'fix', text: 'Fixed R:R ratio parsing bug causing false warnings on N/A values' },
        { type: 'fix', text: 'Fixed React hooks violation in Vocabulary tab' },
        { type: 'improvement', text: 'Offline answer interceptor no longer hijacks detailed questions (>80 chars)' },
      ]
    },
    {
      version: '1.4.0',
      date: '2026-02-06',
      title: 'AI Quality, Mini Widgets & Dashboard Config',
      changes: [
        { type: 'fix', text: 'Fixed Ask AI returning generic offline answers for detailed multi-part questions' },
        { type: 'feature', text: 'Enhanced markdown rendering — numbered lists, ### headers, better formatting' },
        { type: 'feature', text: 'Added Quick Stats, Quick Navigation, and Clock mini widgets' },
        { type: 'improvement', text: 'Organized widget config into categories (Mini, Trading, Data)' },
        { type: 'improvement', text: 'Enhanced Ask AI and Ask About Chart prompts for more thorough answers' },
      ]
    },
    {
      version: '1.3.0',
      date: '2026-02-06',
      title: 'Dashboard Overhaul & Widget Reordering',
      changes: [
        { type: 'fix', text: 'Fixed Latest News widget not updating — was using wrong field name' },
        { type: 'feature', text: 'Added drag-and-drop widget reordering on dashboard' },
        { type: 'feature', text: 'Added mini widgets row: Clock, Market Status, Win Rate, Alert Count' },
        { type: 'feature', text: 'Added time-based greeting in dashboard header' },
        { type: 'feature', text: 'Added Daily Tip widget with rotating trading wisdom' },
        { type: 'improvement', text: 'Dashboard widgets now persist order in localStorage' },
      ]
    },
    {
      version: '1.2.0',
      date: '2026-02-05',
      title: 'Live Ticker Stability & Stock Screener',
      changes: [
        { type: 'fix', text: 'Fixed Live Ticker chart jumping/resetting on auto-refresh' },
        { type: 'fix', text: 'Smart merge strategy keeps chart stable, only updates price + last candle' },
        { type: 'improvement', text: 'Cleaned up Stock Screener — removed redundant buttons, added Buy the Dip' },
        { type: 'fix', text: 'Fixed Daily Pick render crash (normalizeDailyPick, ChevronUp import)' },
        { type: 'fix', text: 'Fixed Ask About Chart UI — switched to text-only API for reliability' },
      ]
    },
  ];
  const changelogLastRead = (() => {
    try { return localStorage.getItem('modus_changelog_read') || ''; } catch { return ''; }
  })();
  const unreadChangelog = changelogEntries.filter(e => e.version > changelogLastRead).length;
  const markChangelogRead = () => {
    try {
      const latest = changelogEntries[0]?.version || '';
      localStorage.setItem('modus_changelog_read', latest);
    } catch {}
  };

  // Backend API Mode - When true, uses Vercel serverless functions instead of direct API calls
  const [useBackendApi, setUseBackendApi] = useState(true); // Default to backend mode
  const [backendUrl, setBackendUrl] = useState(""); // Auto-detected or custom

  // SMS Alert Configuration
  const [smsSettings, setSmsSettings] = useState({
    enabled: false,
    phone: "",
    carrier: "att", // Default carrier
    alertTypes: {
      priceAlerts: true,
      tradeSignals: true,
      dailyPick: false,
      newsAlerts: false,
    },
  });
  const [smsQuotaRemaining, setSmsQuotaRemaining] = useState(200);
  const [showSmsSetup, setShowSmsSetup] = useState(false);

  // Carrier options for Email-to-SMS
  const CARRIER_OPTIONS = [
    { value: 'att', label: 'AT&T' },
    { value: 'verizon', label: 'Verizon' },
    { value: 'tmobile', label: 'T-Mobile' },
    { value: 'sprint', label: 'Sprint' },
    { value: 'uscellular', label: 'US Cellular' },
    { value: 'metropcs', label: 'Metro PCS' },
    { value: 'cricket', label: 'Cricket' },
    { value: 'boost', label: 'Boost Mobile' },
    { value: 'virgin', label: 'Virgin Mobile' },
    { value: 'mint', label: 'Mint Mobile' },
    { value: 'visible', label: 'Visible' },
    { value: 'googlefi', label: 'Google Fi' },
  ];
  
  // Navigation
  const [activeTab, setActiveTab] = useState(() => {
    try { return localStorage.getItem('modus_active_tab') || 'dashboard'; } catch { return 'dashboard'; }
  });
  
  // Chart Analysis
  const [image, setImage] = useState(null);
  const [imageData, setImageData] = useState(null);
  const [imageHash, setImageHash] = useState(null);
  const [analysis, setAnalysis] = useState(null);
  const [loadingAnalysis, setLoadingAnalysis] = useState(false);
  const [analysisStage, setAnalysisStage] = useState("");
  const [analysisProgress, setAnalysisProgress] = useState(0);
  const [analysisError, setAnalysisError] = useState(null);
  const [selectedTimeframe, setSelectedTimeframe] = useState("auto");
  const [selectedAssetType, setSelectedAssetType] = useState("auto");
  const [selectedTradeType, setSelectedTradeType] = useState("swing"); // NEW: Trade type for analysis
  const [autoDetectedTradeType, setAutoDetectedTradeType] = useState(null); // NEW: Auto-detected from timeframe
  const [useAutoTradeType, setUseAutoTradeType] = useState(true); // NEW: Toggle for auto-detection
  const [analysisTab, setAnalysisTab] = useState("overview");
  const [cachedAnalyses, setCachedAnalyses] = useState({});
  const [showIndicatorRecommendations, setShowIndicatorRecommendations] = useState(false);
  
  // Quick Analysis
  const [quickAnalysisTicker, setQuickAnalysisTicker] = useState('');
  const [quickAnalysisResult, setQuickAnalysisResult] = useState(null);
  const [quickAnalysisLoading, setQuickAnalysisLoading] = useState(false);
  const [quickAnalysisExpanded, setQuickAnalysisExpanded] = useState(false);
  const [quickAnalysisHistory, setQuickAnalysisHistory] = useState([]);
  const [quickAnalysisDetail, setQuickAnalysisDetail] = useState(null);
  const [quickAnalysisDetailLoading, setQuickAnalysisDetailLoading] = useState(false);

  // Daily Pick
  const [dailyPick, setDailyPick] = useState(null);
  const [loadingPick, setLoadingPick] = useState(false);
  const [dailyPickError, setDailyPickError] = useState(null);
  const [dailyPickProgress, setDailyPickProgress] = useState({ phase: 'idle', current: 0, total: 0, scanTime: 0 });

  // Toast notifications for feedback
  const [toast, setToast] = useState(null); // { type: 'success'|'error'|'info', message: string }
  const [pickAssetClass, setPickAssetClass] = useState("all");
  const [lastPickTime, setLastPickTime] = useState(null);
  const [pickTimeframe, setPickTimeframe] = useState("24-48h"); // Holding period timeframe
  const [pickVolatility, setPickVolatility] = useState("medium"); // Volatility preference: low, lowmed, medium, medhigh, high, any

  // Volatility thresholds (based on ATR%) - 5 levels + any
  // Redesigned so "high" = actual high-risk stocks (AI, small caps, meme stocks)
  const volatilityThresholds = {
    low: { min: 0, max: 1.2, label: "Low", description: "Very stable stocks (utilities, consumer staples)", emoji: "🐢" },
    lowmed: { min: 0.8, max: 2.0, label: "Low-Medium", description: "Established companies (AAPL, HD, JPM)", emoji: "🏛️" },
    medium: { min: 1.5, max: 3.5, label: "Medium", description: "Balanced risk/reward (most tech)", emoji: "⚖️" },
    medhigh: { min: 2.5, max: 5.0, label: "Medium-High", description: "Growth stocks, volatile tech (AMD, TSLA)", emoji: "📈" },
    high: { min: 4.0, max: 100, label: "High", description: "High risk/reward (AI stocks, small caps, meme)", emoji: "🔥" },
    any: { min: 0, max: 100, label: "Any", description: "No volatility filter", emoji: "🎲" }
  };

  // Timeframe options with risk/reward profiles
  const timeframeOptions = {
    // Short-term (aggressive, tighter stops)
    "5-7h": { label: "5-7 Hours", category: "Short", stopPct: -1.5, target1Pct: 2, target2Pct: 3.5, style: "Day Trade" },
    "12-24h": { label: "12-24 Hours", category: "Short", stopPct: -2, target1Pct: 2.5, target2Pct: 4, style: "Day Trade" },
    "24-48h": { label: "24-48 Hours", category: "Short", stopPct: -2.5, target1Pct: 3, target2Pct: 5, style: "Overnight Swing" },
    // Medium-term (balanced)
    "3-5d": { label: "3-5 Days", category: "Medium", stopPct: -3, target1Pct: 4, target2Pct: 7, style: "Swing Trade" },
    "5-7d": { label: "5-7 Days", category: "Medium", stopPct: -4, target1Pct: 5, target2Pct: 9, style: "Swing Trade" },
    // Long-term (wider stops, bigger targets)
    "1-2w": { label: "1-2 Weeks", category: "Long", stopPct: -5, target1Pct: 7, target2Pct: 12, style: "Position Trade" },
    "3-4w": { label: "3-4 Weeks", category: "Long", stopPct: -7, target1Pct: 10, target2Pct: 18, style: "Position Trade" }
  };

  // ========================================
  // NEXT TRADING DAY CALCULATOR
  // Accounts for weekends and US stock market holidays
  // ========================================
  const getNextTradingDay = () => {
    const now = new Date();
    const currentYear = now.getFullYear();

    // US Stock Market Holidays (NYSE/NASDAQ) - these are CLOSED days
    // Format: Month-Day (will check against current year)
    const getHolidays = (year) => {
      const holidays = [];

      // New Year's Day - January 1 (observed on nearest weekday if falls on weekend)
      let newYears = new Date(year, 0, 1);
      if (newYears.getDay() === 0) newYears = new Date(year, 0, 2); // Sunday -> Monday
      if (newYears.getDay() === 6) newYears = new Date(year - 1, 11, 31); // Saturday -> Friday (prev year)
      holidays.push(newYears.toDateString());

      // Martin Luther King Jr. Day - 3rd Monday in January
      let mlkDay = new Date(year, 0, 1);
      let mondayCount = 0;
      while (mondayCount < 3) {
        if (mlkDay.getDay() === 1) mondayCount++;
        if (mondayCount < 3) mlkDay.setDate(mlkDay.getDate() + 1);
      }
      holidays.push(mlkDay.toDateString());

      // Presidents Day - 3rd Monday in February
      let presDay = new Date(year, 1, 1);
      mondayCount = 0;
      while (mondayCount < 3) {
        if (presDay.getDay() === 1) mondayCount++;
        if (mondayCount < 3) presDay.setDate(presDay.getDate() + 1);
      }
      holidays.push(presDay.toDateString());

      // Good Friday - Friday before Easter (complex calculation)
      // Using a simplified approach - Easter Sunday calculation
      const a = year % 19;
      const b = Math.floor(year / 100);
      const c = year % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
      const day = ((h + l - 7 * m + 114) % 31) + 1;
      const goodFriday = new Date(year, month, day - 2); // Easter Sunday - 2 days
      holidays.push(goodFriday.toDateString());

      // Memorial Day - Last Monday in May
      let memDay = new Date(year, 4, 31);
      while (memDay.getDay() !== 1) memDay.setDate(memDay.getDate() - 1);
      holidays.push(memDay.toDateString());

      // Juneteenth - June 19 (observed on nearest weekday if falls on weekend)
      let juneteenth = new Date(year, 5, 19);
      if (juneteenth.getDay() === 0) juneteenth = new Date(year, 5, 20);
      if (juneteenth.getDay() === 6) juneteenth = new Date(year, 5, 18);
      holidays.push(juneteenth.toDateString());

      // Independence Day - July 4 (observed on nearest weekday if falls on weekend)
      let july4 = new Date(year, 6, 4);
      if (july4.getDay() === 0) july4 = new Date(year, 6, 5);
      if (july4.getDay() === 6) july4 = new Date(year, 6, 3);
      holidays.push(july4.toDateString());

      // Labor Day - 1st Monday in September
      let laborDay = new Date(year, 8, 1);
      while (laborDay.getDay() !== 1) laborDay.setDate(laborDay.getDate() + 1);
      holidays.push(laborDay.toDateString());

      // Thanksgiving Day - 4th Thursday in November
      let thanksgiving = new Date(year, 10, 1);
      let thursdayCount = 0;
      while (thursdayCount < 4) {
        if (thanksgiving.getDay() === 4) thursdayCount++;
        if (thursdayCount < 4) thanksgiving.setDate(thanksgiving.getDate() + 1);
      }
      holidays.push(thanksgiving.toDateString());

      // Christmas Day - December 25 (observed on nearest weekday if falls on weekend)
      let christmas = new Date(year, 11, 25);
      if (christmas.getDay() === 0) christmas = new Date(year, 11, 26);
      if (christmas.getDay() === 6) christmas = new Date(year, 11, 24);
      holidays.push(christmas.toDateString());

      return holidays;
    };

    // Get holidays for current year and next year (in case we're near year end)
    const holidays = [...getHolidays(currentYear), ...getHolidays(currentYear + 1)];

    // Check if a date is a trading day
    const isTradingDay = (date) => {
      const dayOfWeek = date.getDay();
      // Weekend check
      if (dayOfWeek === 0 || dayOfWeek === 6) return false;
      // Holiday check
      if (holidays.includes(date.toDateString())) return false;
      return true;
    };

    // Find next trading day
    let nextDay = new Date(now);
    nextDay.setDate(nextDay.getDate() + 1); // Start with tomorrow
    nextDay.setHours(9, 30, 0, 0); // Set to market open time

    // Keep advancing until we find a trading day
    let daysChecked = 0;
    while (!isTradingDay(nextDay) && daysChecked < 10) {
      nextDay.setDate(nextDay.getDate() + 1);
      daysChecked++;
    }

    // Format the result
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);

    // Check if it's tomorrow
    if (nextDay.toDateString() === tomorrow.toDateString()) {
      return 'Tomorrow 9:30 AM ET';
    }

    // Check if it's today (market not yet open)
    if (nextDay.toDateString() === now.toDateString()) {
      return 'Today 9:30 AM ET';
    }

    // Otherwise show day name and date
    const dayName = dayNames[nextDay.getDay()];
    const monthName = monthNames[nextDay.getMonth()];
    const dayNum = nextDay.getDate();

    return `${dayName} ${monthName} ${dayNum}, 9:30 AM ET`;
  };

  // ========================================
  // TIMEFRAME TO TRADING STYLE MAPPING
  // Auto-detects best trading style from chart timeframe
  // ========================================
  const getRecommendedTradeStyle = (detectedTimeframe) => {
    if (!detectedTimeframe || detectedTimeframe === 'NOT_VISIBLE') return null;

    const tf = String(detectedTimeframe).toLowerCase().trim();

    // Scalping: 1m, 2m, 3m, 5m
    if (tf.includes('1m') || tf.includes('2m') || tf.includes('3m') || tf.includes('5m') ||
        tf === '1 min' || tf === '5 min' || tf === '1 minute' || tf === '5 minute') {
      return {
        style: 'scalp',
        name: 'Scalp Trade',
        icon: '⚡',
        description: 'Ultra-short term (minutes to 1 hour)',
        confidence: 'high',
        reason: `${detectedTimeframe} chart is ideal for scalping`
      };
    }

    // Day Trading: 15m, 30m
    if (tf.includes('15m') || tf.includes('30m') || tf === '15 min' || tf === '30 min' ||
        tf === '15 minute' || tf === '30 minute') {
      return {
        style: 'day',
        name: 'Day Trade',
        icon: '📊',
        description: 'Intraday trading (1-6 hours)',
        confidence: 'high',
        reason: `${detectedTimeframe} chart is optimal for day trading`
      };
    }

    // Day/Swing hybrid: 1h, 2h
    if (tf.includes('1h') || tf.includes('2h') || tf === '1 hour' || tf === '2 hour' ||
        tf === '60m' || tf === '60 min') {
      return {
        style: 'day',
        name: 'Day Trade',
        icon: '📊',
        description: 'Intraday to overnight (same day to next)',
        confidence: 'medium',
        reason: `${detectedTimeframe} chart works for both day trading and overnight swings`
      };
    }

    // Swing Trading: 4h
    if (tf.includes('4h') || tf === '4 hour' || tf === '240m') {
      return {
        style: 'swing',
        name: 'Swing Trade',
        icon: '📈',
        description: 'Multi-day positions (2-10 days)',
        confidence: 'high',
        reason: `${detectedTimeframe} chart is the classic swing trading timeframe`
      };
    }

    // Swing/Position: Daily (1D)
    if (tf.includes('1d') || tf.includes('daily') || tf === 'd' || tf === 'day' ||
        tf.includes('1 day')) {
      return {
        style: 'swing',
        name: 'Swing Trade',
        icon: '📈',
        description: 'Swing to position (3-14 days)',
        confidence: 'high',
        reason: `Daily chart is perfect for swing trading setups`
      };
    }

    // Position Trading: Weekly (1W)
    if (tf.includes('1w') || tf.includes('weekly') || tf === 'w' || tf === 'week') {
      return {
        style: 'position',
        name: 'Position Trade',
        icon: '🏔️',
        description: 'Longer-term positions (2-8 weeks)',
        confidence: 'high',
        reason: `Weekly chart is for position trading and investing`
      };
    }

    // Position/Investing: Monthly (1M)
    if (tf.includes('1mo') || tf.includes('monthly') || tf === 'm' || tf === 'month' ||
        tf.includes('1 month')) {
      return {
        style: 'position',
        name: 'Position Trade',
        icon: '🏔️',
        description: 'Long-term positions (months)',
        confidence: 'high',
        reason: `Monthly chart is for longer-term position trades`
      };
    }

    // Default: try to detect from numbers
    const hourMatch = tf.match(/(\d+)\s*h/i);
    const minMatch = tf.match(/(\d+)\s*m(?!o)/i);
    const dayMatch = tf.match(/(\d+)\s*d/i);

    if (minMatch) {
      const mins = parseInt(minMatch[1]);
      if (mins <= 5) return { style: 'scalp', name: 'Scalp Trade', icon: '⚡', confidence: 'medium', reason: `${mins}m suggests scalping` };
      if (mins <= 30) return { style: 'day', name: 'Day Trade', icon: '📊', confidence: 'medium', reason: `${mins}m suggests day trading` };
      return { style: 'swing', name: 'Swing Trade', icon: '📈', confidence: 'low', reason: `${mins}m could work for swings` };
    }

    if (hourMatch) {
      const hours = parseInt(hourMatch[1]);
      if (hours <= 2) return { style: 'day', name: 'Day Trade', icon: '📊', confidence: 'medium', reason: `${hours}h suggests day trading` };
      if (hours <= 4) return { style: 'swing', name: 'Swing Trade', icon: '📈', confidence: 'medium', reason: `${hours}h is ideal for swings` };
      return { style: 'swing', name: 'Swing Trade', icon: '📈', confidence: 'low', reason: `${hours}h works for swing trading` };
    }

    if (dayMatch) {
      const days = parseInt(dayMatch[1]);
      if (days === 1) return { style: 'swing', name: 'Swing Trade', icon: '📈', confidence: 'high', reason: 'Daily chart for swing trades' };
      return { style: 'position', name: 'Position Trade', icon: '🏔️', confidence: 'medium', reason: `${days}D chart for positions` };
    }

    // Could not detect - return null
    return null;
  };

  // Q&A
  const [question, setQuestion] = useState("");
  const [answer, setAnswer] = useState(null);
  const [loadingAnswer, setLoadingAnswer] = useState(false);
  const [qaHistory, setQaHistory] = useState([]);

  // Chart-specific Q&A
  const [chartQuestion, setChartQuestion] = useState("");
  const [chartAnswer, setChartAnswer] = useState(null);
  const [loadingChartAnswer, setLoadingChartAnswer] = useState(false);
  const [chartQaHistory, setChartQaHistory] = useState([]);

  // Welcome Banner State
  const [showWelcomeBanner, setShowWelcomeBanner] = useState(true);
  
  // NEW: Live Ticker State
  const [tickerSymbol, setTickerSymbol] = useState("");
  const [tickerData, setTickerData] = useState(null);
  const [loadingTicker, setLoadingTicker] = useState(false);
  const [tickerError, setTickerError] = useState(null);
  const [tickerTimeframe, setTickerTimeframe] = useState(() => {
    // Persist timeframe selection across refreshes
    const saved = sessionStorage.getItem("modus_ticker_timeframe");
    return saved || "5m";
  }); // Configurable timeframe with persistence
  const tickerTimeframeRef = useRef(tickerTimeframe); // REF to prevent stale closures
  const [tickerCandleCount, setTickerCandleCount] = useState(() => {
    const saved = sessionStorage.getItem("modus_ticker_candles");
    return saved ? parseInt(saved) : 100;
  }); // Configurable candle count with persistence
  const [tickerAutoRefresh, setTickerAutoRefresh] = useState(true); // Auto-refresh ticker chart
  const [tickerRefreshInterval, setTickerRefreshInterval] = useState(10); // Refresh interval in seconds (5-30)
  const [tickerLastRefresh, setTickerLastRefresh] = useState(null); // Last refresh timestamp
  const lastRefreshTimeRef = useRef(Date.now()); // REF for accurate countdown
  const tickerChartRef = useRef(null);
  const tickerLoadingRef = useRef(false); // Ref to track loading state for auto-refresh
  
  // NEW: Price Alerts State
  const [alerts, setAlerts] = useState([]);
  const [showCreateAlert, setShowCreateAlert] = useState(false);
  const [newAlert, setNewAlert] = useState({
    symbol: "", condition: "above", price: "", message: "", enabled: true
  });
  const [triggeredAlerts, setTriggeredAlerts] = useState([]);
  const [alertRingCounts, setAlertRingCounts] = useState({}); // Track how many times each alert has rung
  const alertRingCountsRef = useRef({}); // Ref to avoid closure issues in interval
  const alertLastStateRef = useRef({}); // Track last triggered state to prevent continuous ringing

  // Memoize enabled alert count to avoid repeated filtering
  const enabledAlertCount = useMemo(() => alerts.filter(a => a.enabled).length, [alerts]);

  // Keep ref in sync with state
  useEffect(() => {
    alertRingCountsRef.current = alertRingCounts;
  }, [alertRingCounts]);
  
  // NEW: Multi-Timeframe Analysis State
  const [multiTimeframeAnalysis, setMultiTimeframeAnalysis] = useState(null);
  const [loadingMultiTimeframe, setLoadingMultiTimeframe] = useState(false);
  const [selectedTimeframes, setSelectedTimeframes] = useState(["1H", "4H", "1D"]);
  
  // NEW: Confirmation Modal State
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [confirmMessage, setConfirmMessage] = useState("");
  const [confirmAction, setConfirmAction] = useState(null);
  
  // NEW: Disclaimer Modal State
  const [showDisclaimer, setShowDisclaimer] = useState(false);
  const [disclaimerAccepted, setDisclaimerAccepted] = useState(false);

  // NEW: Landing Page State
  const [showLandingPage, setShowLandingPage] = useState(false);
  const [betaEmail, setBetaEmail] = useState("");
  const [emailSubmitted, setEmailSubmitted] = useState(false);

  // NEW: Onboarding State
  const [showOnboarding, setShowOnboarding] = useState(false);
  const [onboardingStep, setOnboardingStep] = useState(0);

  // NEW: Feedback Modal State
  const [showFeedback, setShowFeedback] = useState(false);
  const [feedbackType, setFeedbackType] = useState("bug");
  const [feedbackText, setFeedbackText] = useState("");
  const [feedbackSubmitted, setFeedbackSubmitted] = useState(false);

  // NEW: Toast Notification System
  const [toasts, setToasts] = useState([]);
  const toastIdRef = useRef(0);

  // =====================
  // AUTHENTICATION STATE
  // =====================
  const { currentUser, userProfile, login, signup, loginWithGoogle, logout, resetPassword, loadUserData, syncData, cloudSyncEnabled } = useAuth();
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [authMode, setAuthMode] = useState('login');
  const [authEmail, setAuthEmail] = useState('');
  const [authPassword, setAuthPassword] = useState('');
  const [authName, setAuthName] = useState('');
  const [authError, setAuthError] = useState('');
  const [authLoading, setAuthLoading] = useState(false);
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [cloudSyncStatus, setCloudSyncStatus] = useState('idle');
  const [lastSyncTime, setLastSyncTime] = useState(null);
  const [isLoadingCloudData, setIsLoadingCloudData] = useState(false);

  // NEW: Analytics Tracking State & Functions
  const [analytics, setAnalytics] = useState(() => {
    const saved = localStorage.getItem('modus_analytics');
    return saved ? JSON.parse(saved) : {
      sessionStart: Date.now(),
      totalSessions: 1,
      pageViews: {},
      featureUsage: {},
      analysisCount: 0,
      tradeIdeaViews: 0,
      journalEntries: 0,
      paperTrades: 0,
      aiQuestions: 0,
      lastActive: Date.now()
    };
  });

  // Track analytics events
  const trackEvent = useCallback((category, action, label = null) => {
    setAnalytics(prev => {
      const updated = { ...prev, lastActive: Date.now() };

      // Track feature usage
      const featureKey = `${category}_${action}`;
      updated.featureUsage[featureKey] = (updated.featureUsage[featureKey] || 0) + 1;

      // Track specific metrics
      if (category === 'analysis' && action === 'complete') {
        updated.analysisCount = (updated.analysisCount || 0) + 1;
      } else if (category === 'trade_ideas' && action === 'view') {
        updated.tradeIdeaViews = (updated.tradeIdeaViews || 0) + 1;
      } else if (category === 'journal' && action === 'add_entry') {
        updated.journalEntries = (updated.journalEntries || 0) + 1;
      } else if (category === 'paper_trading' && action === 'execute') {
        updated.paperTrades = (updated.paperTrades || 0) + 1;
      } else if (category === 'ai' && action === 'question') {
        updated.aiQuestions = (updated.aiQuestions || 0) + 1;
      }

      // Save to localStorage
      localStorage.setItem('modus_analytics', JSON.stringify(updated));

      // Log for debugging (can be sent to analytics server later)
      console.log(`[Analytics] ${category}/${action}${label ? `: ${label}` : ''}`);

      return updated;
    });
  }, []);

  // Track page/tab views
  const trackPageView = useCallback((pageName) => {
    setAnalytics(prev => {
      const updated = {
        ...prev,
        lastActive: Date.now(),
        pageViews: {
          ...prev.pageViews,
          [pageName]: (prev.pageViews[pageName] || 0) + 1
        }
      };
      localStorage.setItem('modus_analytics', JSON.stringify(updated));
      console.log(`[Analytics] Page View: ${pageName}`);
      return updated;
    });
  }, []);

  // Track session on mount and save on unload
  useEffect(() => {
    // Increment session count if new session (>30 min since last active)
    const saved = localStorage.getItem('modus_analytics');
    if (saved) {
      const data = JSON.parse(saved);
      const timeSinceActive = Date.now() - (data.lastActive || 0);
      if (timeSinceActive > 30 * 60 * 1000) { // 30 minutes
        setAnalytics(prev => ({
          ...prev,
          totalSessions: (prev.totalSessions || 0) + 1,
          sessionStart: Date.now()
        }));
      }
    }

    // Save analytics on page unload
    const handleUnload = () => {
      const currentAnalytics = JSON.parse(localStorage.getItem('modus_analytics') || '{}');
      currentAnalytics.lastActive = Date.now();
      localStorage.setItem('modus_analytics', JSON.stringify(currentAnalytics));
    };

    window.addEventListener('beforeunload', handleUnload);
    return () => window.removeEventListener('beforeunload', handleUnload);
  }, []);

  // Track page/tab views when activeTab changes
  useEffect(() => {
    if (activeTab && disclaimerAccepted) {
      trackPageView(activeTab);
    }
  }, [activeTab, disclaimerAccepted, trackPageView]);

  // NEW: Alert Settings State
  const [alertSettings, setAlertSettings] = useState({
    enableEmail: false,
    email: "",
    enableSMS: false,
    phone: "",
    enableBrowser: true
  });

  // =====================
  // AUTHENTICATION HANDLERS
  // =====================
  const handleAuth = async (e) => {
    e.preventDefault();
    setAuthError('');
    setAuthLoading(true);

    try {
      if (authMode === 'login') {
        await login(authEmail, authPassword);
        setShowAuthModal(false);
        setAuthEmail('');
        setAuthPassword('');
      } else if (authMode === 'signup') {
        await signup(authEmail, authPassword, authName);
        setShowAuthModal(false);
        setAuthEmail('');
        setAuthPassword('');
        setAuthName('');
      } else if (authMode === 'reset') {
        await resetPassword(authEmail);
        setAuthError('Password reset email sent! Check your inbox.');
        setAuthMode('login');
      }
    } catch (error) {
      console.error('Auth error:', error);
      // Handle Firebase error codes
      if (error.code === 'auth/email-already-in-use') {
        setAuthError('This email is already registered. Try logging in.');
      } else if (error.code === 'auth/invalid-email') {
        setAuthError('Please enter a valid email address.');
      } else if (error.code === 'auth/weak-password') {
        setAuthError('Password should be at least 6 characters.');
      } else if (error.code === 'auth/user-not-found') {
        setAuthError('No account found with this email.');
      } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
        setAuthError('Incorrect password. Try again.');
      } else {
        setAuthError(error.message || 'Authentication failed. Please try again.');
      }
    } finally {
      setAuthLoading(false);
    }
  };

  const handleGoogleLogin = async () => {
    setAuthError('');
    setAuthLoading(true);
    try {
      await loginWithGoogle();
      setShowAuthModal(false);
    } catch (error) {
      console.error('Google auth error:', error);
      if (error.code === 'auth/popup-closed-by-user') {
        setAuthError('Sign-in cancelled.');
      } else if (error.code === 'auth/unauthorized-domain') {
        setAuthError('This domain is not authorized for Google sign-in.');
      } else {
        setAuthError('Google sign-in failed. Please try again.');
      }
    } finally {
      setAuthLoading(false);
    }
  };

  const handleLogout = async () => {
    await logout();
    setShowUserMenu(false);
  };

  // Quick Analysis function — uses real market data + AI for instant verdict
  const runQuickAnalysis = async (ticker) => {
    if (!ticker || quickAnalysisLoading) return;
    const sym = ticker.trim().toUpperCase();
    setQuickAnalysisLoading(true);
    setQuickAnalysisResult(null);
    setQuickAnalysisExpanded(false);
    setQuickAnalysisDetail(null);
    try {
      // Fetch real-time data for the ticker with robust proxy fallback chain
      const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&range=3mo`;
      const yahooUrl2 = `https://query2.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&range=3mo`;
      const proxies = [
        yahooUrl,
        yahooUrl2,
        `https://corsproxy.io/?${encodeURIComponent(yahooUrl)}`,
        `https://corsproxy.io/?${encodeURIComponent(yahooUrl2)}`,
        `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl)}`,
        `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(yahooUrl)}`,
        `https://corsproxy.org/?${encodeURIComponent(yahooUrl)}`,
        `https://thingproxy.freeboard.io/fetch/${yahooUrl}`,
      ];
      let chartData = null;
      for (const url of proxies) {
        try {
          const r = await fetch(url, { signal: AbortSignal.timeout(6000) });
          if (r.ok) { chartData = await r.json(); break; }
        } catch {}
      }

      const meta = chartData?.chart?.result?.[0]?.meta || {};
      const quotes = chartData?.chart?.result?.[0]?.indicators?.quote?.[0] || {};
      const closes = (quotes.close || []).filter(v => v != null);
      const volumes = (quotes.volume || []).filter(v => v != null);
      const currentPrice = meta.regularMarketPrice || closes[closes.length - 1] || 0;
      const prevClose = meta.chartPreviousClose || closes[closes.length - 2] || currentPrice;
      const dayChange = currentPrice && prevClose ? ((currentPrice - prevClose) / prevClose * 100).toFixed(2) : '0';

      // Calculate key technicals
      const sma20 = closes.length >= 20 ? closes.slice(-20).reduce((a, b) => a + b, 0) / 20 : null;
      const sma50 = closes.length >= 50 ? closes.slice(-50).reduce((a, b) => a + b, 0) / 50 : null;
      const sma200 = closes.length >= 200 ? closes.slice(-200).reduce((a, b) => a + b, 0) / 200 : null;
      const avgVol = volumes.length >= 20 ? volumes.slice(-20).reduce((a, b) => a + b, 0) / 20 : 0;
      const latestVol = volumes[volumes.length - 1] || 0;
      const volRatio = avgVol ? (latestVol / avgVol).toFixed(2) : '1.00';

      // RSI calculation
      let rsi = 50;
      if (closes.length >= 15) {
        const changes = closes.slice(-15).map((v, i, a) => i > 0 ? v - a[i - 1] : 0).slice(1);
        const gains = changes.filter(c => c > 0);
        const losses = changes.filter(c => c < 0).map(c => Math.abs(c));
        const avgGain = gains.length ? gains.reduce((a, b) => a + b, 0) / 14 : 0;
        const avgLoss = losses.length ? losses.reduce((a, b) => a + b, 0) / 14 : 0.001;
        rsi = 100 - (100 / (1 + avgGain / avgLoss));
      }

      // High/low range
      const high52 = closes.length > 0 ? Math.max(...closes) : currentPrice;
      const low52 = closes.length > 0 ? Math.min(...closes) : currentPrice;
      const rangePosition = high52 !== low52 ? ((currentPrice - low52) / (high52 - low52) * 100).toFixed(0) : 50;

      // Build comprehensive prompt with real data
      const dataContext = `
REAL-TIME DATA for ${sym}:
- Current Price: $${currentPrice.toFixed(2)} (${dayChange > 0 ? '+' : ''}${dayChange}% today)
- 20-day SMA: ${sma20 ? '$' + sma20.toFixed(2) : 'N/A'} | 50-day SMA: ${sma50 ? '$' + sma50.toFixed(2) : 'N/A'} | 200-day SMA: ${sma200 ? '$' + sma200.toFixed(2) : 'N/A'}
- Price vs SMA20: ${sma20 ? (currentPrice > sma20 ? 'ABOVE' : 'BELOW') : 'N/A'} | vs SMA50: ${sma50 ? (currentPrice > sma50 ? 'ABOVE' : 'BELOW') : 'N/A'}
- RSI(14): ${rsi.toFixed(1)} ${rsi > 70 ? '(OVERBOUGHT)' : rsi < 30 ? '(OVERSOLD)' : '(NEUTRAL)'}
- Volume Ratio: ${volRatio}x average ${parseFloat(volRatio) > 1.5 ? '(HIGH)' : parseFloat(volRatio) < 0.5 ? '(LOW)' : '(NORMAL)'}
- 3-Month Range: $${low52.toFixed(2)} - $${high52.toFixed(2)} (Currently at ${rangePosition}% of range)
- 3-Month Performance: ${closes.length >= 2 ? ((currentPrice / closes[0] - 1) * 100).toFixed(1) : 0}%`;

      const response = await callAPI([{
        role: 'user',
        content: `You are an expert stock analyst. Analyze ${sym} using the real market data below and give a CLEAR verdict.

${dataContext}

Respond in EXACTLY this JSON format (no markdown, no code blocks, just raw JSON):
{
  "verdict": "STRONG BUY" or "BUY" or "HOLD" or "SELL" or "STRONG SELL",
  "confidence": number 1-100,
  "targetPrice": number (realistic target based on resistance levels and current price — MUST be a positive dollar amount like 185.50),
  "stopLoss": number (realistic stop loss based on support levels — MUST be a positive dollar amount like 170.25),
  "timeframe": "string like 1-2 weeks or 1-3 months",
  "riskLevel": "LOW" or "MODERATE" or "HIGH",
  "summary": "2-3 sentence summary of why",
  "bullish": ["factor1", "factor2", "factor3"],
  "bearish": ["factor1", "factor2", "factor3"],
  "keyLevel": "string describing the most important price level to watch with dollar amount",
  "entryStrategy": "1-2 sentences on how to enter this trade with specific price levels",
  "support": number (nearest support level as dollar amount),
  "resistance": number (nearest resistance level as dollar amount),
  "riskRewardRatio": "string like 1:2.5"
}

CRITICAL RULES:
- targetPrice and stopLoss MUST be realistic dollar amounts based on the current price of $${currentPrice.toFixed(2)}. Never use 0 or null.
- For a BUY verdict, targetPrice should be ABOVE current price and stopLoss BELOW current price.
- For a SELL verdict, targetPrice should be BELOW current price and stopLoss ABOVE current price.
- For HOLD, set targetPrice slightly above and stopLoss slightly below as watch levels.
- Base everything on the REAL technical data provided above. Be accurate and data-driven.
- If RSI is overbought, trend is down, and price is below SMAs, don't say BUY. Be honest.`
      }], 2000);

      const text = response.content?.[0]?.text || '';
      // Parse JSON from response
      let parsed = null;
      try {
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) parsed = JSON.parse(jsonMatch[0]);
      } catch {}

      if (parsed) {
        // Validate and fix critical numeric fields — ensure they are real prices, never 0
        const safeTarget = (typeof parsed.targetPrice === 'number' && parsed.targetPrice > 0) ? parsed.targetPrice : (currentPrice > 0 ? currentPrice * 1.05 : null);
        const safeStop = (typeof parsed.stopLoss === 'number' && parsed.stopLoss > 0) ? parsed.stopLoss : (currentPrice > 0 ? currentPrice * 0.95 : null);
        const safeConfidence = (typeof parsed.confidence === 'number' && parsed.confidence > 0 && parsed.confidence <= 100) ? parsed.confidence : 50;
        const safeSupport = (typeof parsed.support === 'number' && parsed.support > 0) ? parsed.support : safeStop;
        const safeResistance = (typeof parsed.resistance === 'number' && parsed.resistance > 0) ? parsed.resistance : safeTarget;
        const result = {
          ticker: sym,
          price: currentPrice,
          dayChange: parseFloat(dayChange),
          rsi: parseFloat(rsi.toFixed(1)),
          sma20, sma50, sma200,
          volRatio: parseFloat(volRatio),
          rangePosition: parseInt(rangePosition),
          high52: high52,
          low52: low52,
          ...parsed,
          targetPrice: safeTarget,
          stopLoss: safeStop,
          confidence: safeConfidence,
          support: safeSupport,
          resistance: safeResistance,
          timestamp: new Date(),
        };
        setQuickAnalysisResult(result);
        setQuickAnalysisHistory(prev => [result, ...prev.filter(h => h.ticker !== sym)].slice(0, 10));
        // Auto-track price target (Feature 5)
        if (safeTarget > 0 && safeStop > 0) {
          addPriceTarget(sym, result.price, safeTarget, safeStop, result.verdict, safeConfidence);
        }
      } else {
        throw new Error('Could not parse analysis response');
      }
    } catch (err) {
      setQuickAnalysisResult({ error: true, message: err.message || 'Analysis failed', ticker: sym });
    } finally {
      setQuickAnalysisLoading(false);
    }
  };

  // Quick Analysis "Tell me more" - expanded detailed analysis with structured JSON
  const runQuickAnalysisDetail = async () => {
    if (!quickAnalysisResult || quickAnalysisResult.error || quickAnalysisDetailLoading) return;
    setQuickAnalysisDetailLoading(true);
    try {
      const r = quickAnalysisResult;
      const response = await callAPI([{
        role: 'user',
        content: `You are an expert trading educator. The user ran a Quick Analysis on ${r.ticker} (current price: $${r.price?.toFixed(2)}).

Result: ${r.verdict} with ${r.confidence}% confidence.
Target: $${r.targetPrice?.toFixed(2) || 'N/A'} | Stop Loss: $${r.stopLoss?.toFixed(2) || 'N/A'} | Timeframe: ${r.timeframe}
RSI: ${r.rsi} | SMA20: ${r.sma20 ? '$' + r.sma20.toFixed(2) : 'N/A'} | SMA50: ${r.sma50 ? '$' + r.sma50.toFixed(2) : 'N/A'}
3M Range: $${r.low52?.toFixed(2) || '?'} - $${r.high52?.toFixed(2) || '?'} (at ${r.rangePosition}%)
Volume: ${r.volRatio}x average
Bullish: ${r.bullish?.join(', ')}
Bearish: ${r.bearish?.join(', ')}
Summary: ${r.summary}

Respond in EXACTLY this JSON format (no markdown, no code blocks, just raw JSON):
{
  "technicalAnalysis": {
    "title": "Technical Analysis Deep Dive",
    "summary": "2-3 sentence overview of technical picture",
    "indicators": [
      { "name": "RSI (14)", "value": "${r.rsi}", "signal": "Bullish/Bearish/Neutral", "explanation": "1-2 sentences explaining what this means and why it matters" },
      { "name": "Moving Averages", "value": "Above/Below", "signal": "Bullish/Bearish/Neutral", "explanation": "1-2 sentences about SMA alignment" },
      { "name": "Volume", "value": "${r.volRatio}x", "signal": "Bullish/Bearish/Neutral", "explanation": "1-2 sentences about volume confirmation" },
      { "name": "Price Range", "value": "${r.rangePosition}%", "signal": "Bullish/Bearish/Neutral", "explanation": "1-2 sentences about position within range" }
    ]
  },
  "entryExit": {
    "title": "Entry & Exit Strategy",
    "entryType": "Limit Buy/Market Buy/etc",
    "entryPrice": "specific price with explanation",
    "exitTarget": "price with reasoning",
    "stopLoss": "price with reasoning",
    "positionSize": "percentage of portfolio recommendation with explanation",
    "orderFlow": ["step 1 instruction", "step 2 instruction", "step 3 instruction"]
  },
  "riskAssessment": {
    "title": "Risk Assessment",
    "overallRisk": "LOW/MODERATE/HIGH",
    "maxLoss": "dollar/percentage amount",
    "risks": [
      { "risk": "risk name", "severity": "Low/Medium/High", "mitigation": "how to handle it" }
    ],
    "warningSignals": ["signal to watch for 1", "signal 2", "signal 3"]
  },
  "sectorContext": {
    "title": "Sector & Market Context",
    "sector": "sector name",
    "sectorTrend": "Bullish/Bearish/Neutral",
    "marketCondition": "1-2 sentences about current market environment",
    "catalysts": ["upcoming catalyst 1", "catalyst 2"],
    "headwinds": ["headwind 1", "headwind 2"]
  },
  "scenarios": {
    "title": "Alternative Scenarios",
    "bullCase": { "probability": "X%", "target": "$XX.XX", "description": "What happens in the best case" },
    "baseCase": { "probability": "X%", "target": "$XX.XX", "description": "Most likely outcome" },
    "bearCase": { "probability": "X%", "target": "$XX.XX", "description": "What happens if it goes wrong" }
  }
}

Be thorough, educational, and use real price levels based on the data. Every field must be filled.`
      }], 3000);

      const text = response.content?.[0]?.text || '';
      let parsedDetail = null;
      try {
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) parsedDetail = JSON.parse(jsonMatch[0]);
      } catch {}

      if (parsedDetail) {
        setQuickAnalysisDetail(parsedDetail);
      } else {
        // Fallback: store raw text with a flag so renderer knows
        setQuickAnalysisDetail({ _raw: true, text: text || 'No detailed analysis available.' });
      }
    } catch (err) {
      setQuickAnalysisDetail({ _raw: true, text: 'Failed to load detailed analysis. Please try again.' });
    } finally {
      setQuickAnalysisDetailLoading(false);
    }
  };

  // Check landing page, disclaimer, and onboarding on mount
  useEffect(() => {
    const hasVisited = localStorage.getItem('modus_has_visited');
    const accepted = localStorage.getItem('modus_disclaimer_accepted');
    const onboardingComplete = localStorage.getItem('modus_onboarding_complete');

    // Show landing page for first-time visitors
    if (hasVisited !== 'true') {
      setShowLandingPage(true);
    } else if (accepted !== 'true') {
      setShowDisclaimer(true);
    } else {
      setDisclaimerAccepted(true);
      // Show onboarding if not completed
      if (onboardingComplete !== 'true') {
        setShowOnboarding(true);
      }
    }
  }, []);

  // Auto-dismiss toast notifications after 4 seconds
  useEffect(() => {
    if (toast) {
      const timer = setTimeout(() => setToast(null), 4000);
      return () => clearTimeout(timer);
    }
  }, [toast]);


  // =================================================================
  // NEW: PHASE 1 & 2 STATE VARIABLES
  // =================================================================
  
  // Watchlist
  const [watchlist, setWatchlist] = useState([]);
  const [watchlistVisible, setWatchlistVisible] = useState(true); // NEW: Collapsable watchlist
  const [watchlistPrices, setWatchlistPrices] = useState({});
  const [addToWatchlistSymbol, setAddToWatchlistSymbol] = useState('');
  const [draggedWatchlistItem, setDraggedWatchlistItem] = useState(null);
  const [dragOverWatchlistItem, setDragOverWatchlistItem] = useState(null);

  // Memoize alert symbols string to prevent unnecessary useEffect re-runs
  const alertSymbolsString = useMemo(
    () => alerts.filter(a => a.enabled).map(a => a.symbol).join(','),
    [alerts]
  );

  // ROBUST BACKGROUND WATCHLIST PRICE MONITOR
  // This runs independently and checks ALL stocks in watchlist + any stocks with alerts
  useEffect(() => {
    // Get all unique symbols to monitor (watchlist + alert symbols)
    const getSymbolsToMonitor = () => {
      const alertSymbols = alerts.filter(a => a.enabled).map(a => a.symbol);
      const allSymbols = [...new Set([...watchlist, ...alertSymbols])];
      return allSymbols.filter(s => s && s.trim());
    };
    
    const updateAllPrices = async () => {
      const symbols = getSymbolsToMonitor();
      if (symbols.length === 0) return;
      
      console.log(`[Background Monitor] 🔄 Updating ${symbols.length} symbols...`);
      const newPrices = { ...watchlistPrices };
      
      // Fetch all prices in parallel with timeout
      const fetchPromises = symbols.map(async (symbol) => {
        try {
          const quote = await fetchCurrentQuote(symbol);
          if (quote && quote.price && !isNaN(quote.price)) {
            return {
              symbol,
              data: {
                current: quote.price,
                change: quote.change || 0,
                changePercent: quote.changePercent || 0,
                lastUpdate: Date.now()
              }
            };
          }
          return null;
        } catch (err) {
          console.log(`[Background Monitor] ⚠️ ${symbol}: ${err.message}`);
          return null;
        }
      });
      
      try {
        const results = await Promise.race([
          Promise.all(fetchPromises),
          new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 15000))
        ]);
        
        results.forEach(result => {
          if (result && result.symbol) {
            newPrices[result.symbol] = result.data;
          }
        });
        
        setWatchlistPrices(newPrices);
        console.log(`[Background Monitor] ✅ Updated ${Object.keys(newPrices).length} prices`);
        
        // Check alerts against new prices
        checkAllAlertsAgainstPrices(newPrices);
        
      } catch (e) {
        console.log(`[Background Monitor] ⚠️ Fetch timeout, keeping existing prices`);
      }
    };
    
    // Update immediately
    updateAllPrices();
    
    // Then every 10 seconds
    const interval = setInterval(updateAllPrices, 10000);
    
    return () => clearInterval(interval);
  }, [watchlist, alertSymbolsString]); // Re-run when watchlist or enabled alerts change

  // Memoized function to play beep sound for alerts
  const playBeep = useCallback((frequency = 800, duration = 0.3) => {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';
      gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + duration);
    } catch (e) {
      console.log('Audio not available');
    }
  }, []);

  // ALERT CHECKING FUNCTION - checks all alerts against provided prices
  const checkAllAlertsAgainstPrices = (prices) => {
    alerts.forEach(alert => {
      if (!alert.enabled) return;
      
      const priceData = prices[alert.symbol];
      if (!priceData || !priceData.current) return;
      
      const currentPrice = priceData.current;
      const targetPrice = parseFloat(alert.price || alert.value);
      
      if (isNaN(targetPrice)) return;
      
      let triggered = false;
      
      switch (alert.condition) {
        case "above":
        case "crosses_above":
          triggered = currentPrice > targetPrice;
          break;
        case "below":
        case "crosses_below":
          triggered = currentPrice < targetPrice;
          break;
        case "equals":
          triggered = Math.abs(currentPrice - targetPrice) < (targetPrice * 0.001);
          break;
      }
      
      // Get last known state for this alert
      const wasTriggered = alertLastStateRef.current[alert.id] || false;
      
      // Update the last state
      alertLastStateRef.current[alert.id] = triggered;
      
      // Only ring if this is a NEW trigger (wasn't triggered before, now is)
      // This prevents continuous ringing while condition remains true
      if (triggered && !wasTriggered) {
        console.log(`🔔 ALERT TRIGGERED: ${alert.symbol} ${alert.condition} $${targetPrice}`);

        // Increment trigger count for UI display
        const currentTriggerCount = (alertRingCountsRef.current[alert.id] || 0) + 1;
        alertRingCountsRef.current = {
          ...alertRingCountsRef.current,
          [alert.id]: currentTriggerCount
        };

        // Update state for UI
        setAlertRingCounts(prev => ({
          ...prev,
          [alert.id]: currentTriggerCount
        }));

        // Push to notification center
        const notifData = {
          type: 'price_alert',
          title: `${alert.symbol} Alert Triggered!`,
          message: `Price ${alert.condition} $${targetPrice.toFixed(2)}. Current: $${currentPrice.toFixed(2)}`,
          icon: currentPrice > targetPrice ? '📈' : '📉',
          symbol: alert.symbol,
          price: currentPrice,
          targetPrice: targetPrice,
          condition: alert.condition
        };

        // Add to notification history
        setNotificationHistory(prev => [{
          id: Date.now() + Math.random(),
          timestamp: new Date().toISOString(),
          read: false,
          ...notifData
        }, ...prev].slice(0, 100));
        setUnreadNotifications(prev => prev + 1);

        // Show browser notification
        if (typeof Notification !== 'undefined' && Notification.permission === "granted") {
          new Notification(`🔔 ${alert.symbol} Alert!`, {
            body: `Price ${alert.condition} $${targetPrice.toFixed(2)}. Current: $${currentPrice.toFixed(2)}`,
            icon: "/favicon.ico",
            tag: `alert-${alert.id}`,
            requireInteraction: false
          });
        }

        // Send SMS alert
        if (smsSettings.enabled) {
          const smsMessage = `${alert.symbol} ${alert.condition} $${targetPrice.toFixed(2)}! Now: $${currentPrice.toFixed(2)}`;
          sendSmsAlert(smsMessage, 'price');
        }

        // Play 3 beeps immediately with 1-second intervals
        playBeep(800, 0.3); // First beep immediately
        setTimeout(() => playBeep(900, 0.3), 1000); // Second beep at 1s
        setTimeout(() => playBeep(1000, 0.3), 2000); // Third beep at 2s (rising pitch)

        // Mark alert as triggered (but don't disable - allow re-trigger on next crossing)
        setAlerts(prev => prev.map(a =>
          a.id === alert.id
            ? { ...a, triggered: true, triggeredAt: Date.now(), triggeredPrice: currentPrice }
            : a
        ));
      }
    });
  };
  
  // Analysis History
  const [analysisHistory, setAnalysisHistory] = useState([]);
  const [showHistory, setShowHistory] = useState(false);
  
  // Chart Settings
  const [chartTimeframe, setChartTimeframe] = useState("5m"); // 5m, 1h, 4h, 1d
  const [useDemoMode, setUseDemoMode] = useState(false);
  
  // Comparison Mode
  const [comparisonMode, setComparisonMode] = useState(false);
  const [comparisonCharts, setComparisonCharts] = useState([]);
  
  // Trading Journal
  const [trades, setTrades] = useState([]);
  const [showAddTrade, setShowAddTrade] = useState(false);
  const [showTradeJournal, setShowTradeJournal] = useState(false);
  const [showEditTrade, setShowEditTrade] = useState(false);
  const [editingTrade, setEditingTrade] = useState(null);
  const [newTrade, setNewTrade] = useState({
    symbol: "",
    side: "long",
    entry: "",
    exit: "",
    avgPrice: "", // NEW: Average price for multiple entries
    stopLoss: "",
    target: "",
    quantity: "",
    entryDate: "",
    exitDate: "",
    notes: "",
    linkedAnalysisId: null,
    isPaperTrade: false, // Paper trading toggle
    confidence: "" // Optional confidence score
  });
  
  // Journal Sub-tabs
  const [journalSubTab, setJournalSubTab] = useState('log');
  const [plMonth, setPlMonth] = useState(new Date());

  // Screener Sub-tabs
  const [screenerSubTab, setScreenerSubTab] = useState('screener');

  // NEW: Paper Trading Account
  const [paperTradingAccount, setPaperTradingAccount] = useState({
    balance: 100000,
    initialBalance: 100000,
    positions: [],
    trades: []
  });

  // NEW: Portfolio Position Calculator
  const [portfolioSettings, setPortfolioSettings] = useState({
    totalCapital: 10000,
    riskPercent: 2 // Risk 2% per trade by default
  });

  // NEW: Economic Calendar State
  const [economicEvents, setEconomicEvents] = useState([]);
  const [loadingEconomicEvents, setLoadingEconomicEvents] = useState(false);
  const [calendarView, setCalendarView] = useState('week'); // 'week' or 'month'
  const [selectedEvent, setSelectedEvent] = useState(null);
  const [selectedDate, setSelectedDate] = useState(null);
  const [calendarMonthOffset, setCalendarMonthOffset] = useState(0); // For navigating months
  
  // NEW: Trade Ideas State
  const [tradeIdeas, setTradeIdeas] = useState([]);
  const [loadingTradeIdeas, setLoadingTradeIdeas] = useState(false);
  
  // NEW: Stock Screener State
  const [scanResults, setScanResults] = useState([]);
  const [loadingScanner, setLoadingScanner] = useState(false);
  const [scanCriteria, setScanCriteria] = useState({
    minPrice: 0,
    maxPrice: 1000,
    minVolume: 0,
    rsiMin: 0,
    rsiMax: 100
  });

  // NEW: Market Overview State
  const [marketData, setMarketData] = useState({
    indices: {
      SPY: { price: 0, change: 0, changePercent: 0 },
      QQQ: { price: 0, change: 0, changePercent: 0 },
      DIA: { price: 0, change: 0, changePercent: 0 },
      IWM: { price: 0, change: 0, changePercent: 0 }
    },
    vix: { price: null, change: 0, changePercent: 0, loading: true },
    sectors: {
      XLK: { name: 'Technology', price: 0, changePercent: 0 },
      XLF: { name: 'Financials', price: 0, changePercent: 0 },
      XLE: { name: 'Energy', price: 0, changePercent: 0 },
      XLV: { name: 'Healthcare', price: 0, changePercent: 0 },
      XLY: { name: 'Consumer Disc.', price: 0, changePercent: 0 },
      XLP: { name: 'Consumer Staples', price: 0, changePercent: 0 },
      XLI: { name: 'Industrials', price: 0, changePercent: 0 },
      XLB: { name: 'Materials', price: 0, changePercent: 0 },
      XLU: { name: 'Utilities', price: 0, changePercent: 0 },
      XLRE: { name: 'Real Estate', price: 0, changePercent: 0 },
      XLC: { name: 'Communication', price: 0, changePercent: 0 }
    },
    marketStatus: 'closed',
    lastUpdate: null
  });
  const [loadingMarketData, setLoadingMarketData] = useState(false);
  const [marketAutoRefresh, setMarketAutoRefresh] = useState(true);

  // NEW: News & Sentiment Feed State
  const [newsFeed, setNewsFeed] = useState([]);
  const [loadingNews, setLoadingNews] = useState(false);
  const [newsFilter, setNewsFilter] = useState('all'); // all, bullish, bearish, watchlist

  // NEW: Real-time Price Updates
  const [lastPriceUpdate, setLastPriceUpdate] = useState(Date.now());
  const [priceFlash, setPriceFlash] = useState(null);
  const [previousPrice, setPreviousPrice] = useState(null);

  // Price streaming handled via polling (10s intervals) - see Background Monitor above

  // NEW: Notification Center State
  const [notificationHistory, setNotificationHistory] = useState([]);
  const [showNotificationCenter, setShowNotificationCenter] = useState(false);
  const [unreadNotifications, setUnreadNotifications] = useState(0);
  const [notificationPrefs, setNotificationPrefs] = useState({
    sound: true,
    browser: true,
    sms: false,
    priceAlerts: true,
    newsAlerts: true,
    tradeAlerts: true
  });

  // NEW: Sharing State
  const [showShareModal, setShowShareModal] = useState(false);
  const [shareContent, setShareContent] = useState(null);
  const [copySuccess, setCopySuccess] = useState(false);

  // NEW: Screener Presets
  const [selectedScanPreset, setSelectedScanPreset] = useState('custom');

  // NEW: Info Pages State
  const [showInfoPage, setShowInfoPage] = useState(null); // 'terms', 'privacy', 'features', null — FOOTER OVERLAY ONLY
  const [infoSubTab, setInfoSubTab] = useState('features'); // Inline Info tab sub-navigation
  const [vocabSearch, setVocabSearch] = useState(''); // Vocabulary search

  // NEW: Keyboard Shortcuts
  const [showShortcuts, setShowShortcuts] = useState(false);

  // ═══════════════════════════════════════════════
  // FEATURE 1: Earnings Calendar Widget
  // ═══════════════════════════════════════════════
  const [earningsData] = useState(() => {
    const today = new Date();
    const upcoming = [
      { ticker: 'NVDA', company: 'NVIDIA Corp', date: new Date(today.getTime() + 1 * 86400000), time: 'AMC', estEPS: '$0.89', estRev: '$38.2B', sector: 'Tech' },
      { ticker: 'AAPL', company: 'Apple Inc', date: new Date(today.getTime() + 2 * 86400000), time: 'AMC', estEPS: '$2.35', estRev: '$124.3B', sector: 'Tech' },
      { ticker: 'TSLA', company: 'Tesla Inc', date: new Date(today.getTime() + 3 * 86400000), time: 'AMC', estEPS: '$0.73', estRev: '$25.9B', sector: 'Auto' },
      { ticker: 'MSFT', company: 'Microsoft Corp', date: new Date(today.getTime() + 4 * 86400000), time: 'AMC', estEPS: '$3.11', estRev: '$61.8B', sector: 'Tech' },
      { ticker: 'AMZN', company: 'Amazon.com', date: new Date(today.getTime() + 5 * 86400000), time: 'BMO', estEPS: '$1.36', estRev: '$187.3B', sector: 'Retail' },
      { ticker: 'META', company: 'Meta Platforms', date: new Date(today.getTime() + 6 * 86400000), time: 'AMC', estEPS: '$6.29', estRev: '$45.7B', sector: 'Tech' },
      { ticker: 'GOOG', company: 'Alphabet Inc', date: new Date(today.getTime() + 7 * 86400000), time: 'AMC', estEPS: '$1.89', estRev: '$86.3B', sector: 'Tech' },
      { ticker: 'AMD', company: 'AMD Inc', date: new Date(today.getTime() + 9 * 86400000), time: 'AMC', estEPS: '$0.77', estRev: '$7.5B', sector: 'Tech' },
      { ticker: 'JPM', company: 'JPMorgan Chase', date: new Date(today.getTime() + 10 * 86400000), time: 'BMO', estEPS: '$4.81', estRev: '$42.5B', sector: 'Finance' },
      { ticker: 'DIS', company: 'Walt Disney', date: new Date(today.getTime() + 12 * 86400000), time: 'BMO', estEPS: '$1.45', estRev: '$23.1B', sector: 'Media' },
    ];
    return upcoming.sort((a, b) => a.date - b.date);
  });

  // ═══════════════════════════════════════════════
  // FEATURE 2: Trade Replay / Review Mode
  // ═══════════════════════════════════════════════
  const [tradeReplayOpen, setTradeReplayOpen] = useState(false);
  const [replayTrade, setReplayTrade] = useState(null);
  const [replayStep, setReplayStep] = useState(0);
  const [replayPlaying, setReplayPlaying] = useState(false);

  // ═══════════════════════════════════════════════
  // FEATURE 3: Risk Dashboard (computed from trades)
  // ═══════════════════════════════════════════════
  const dashRiskMetrics = useMemo(() => {
    if (!trades || trades.length === 0) return { exposure: 0, largestPos: 0, concentration: 0, maxDrawdown: 0, riskScore: 0, openPositions: 0, sectors: {} };
    const openTrades = trades.filter(t => !t.exitPrice && !t.closed);
    const closedTrades = trades.filter(t => t.exitPrice || t.closed);
    const totalExposure = openTrades.reduce((sum, t) => sum + (parseFloat(t.entryPrice || 0) * parseInt(t.shares || t.quantity || 1)), 0);
    const positionSizes = openTrades.map(t => parseFloat(t.entryPrice || 0) * parseInt(t.shares || t.quantity || 1));
    const largestPos = positionSizes.length > 0 ? Math.max(...positionSizes) : 0;
    const concentration = totalExposure > 0 ? (largestPos / totalExposure * 100) : 0;
    // Max drawdown from closed trades
    let peak = 0, maxDD = 0, running = 0;
    closedTrades.forEach(t => {
      const pnl = t.pnl || ((parseFloat(t.exitPrice || 0) - parseFloat(t.entryPrice || 0)) * parseInt(t.shares || t.quantity || 1) * (t.direction === 'short' ? -1 : 1));
      running += pnl;
      if (running > peak) peak = running;
      const dd = peak > 0 ? ((peak - running) / peak * 100) : 0;
      if (dd > maxDD) maxDD = dd;
    });
    // Sector breakdown
    const sectors = {};
    openTrades.forEach(t => {
      const sec = t.sector || 'Unknown';
      const size = parseFloat(t.entryPrice || 0) * parseInt(t.shares || t.quantity || 1);
      sectors[sec] = (sectors[sec] || 0) + size;
    });
    const riskScore = Math.min(100, Math.round((concentration * 0.4) + (maxDD * 0.3) + (openTrades.length > 5 ? 20 : openTrades.length * 4) + (totalExposure > 50000 ? 10 : 0)));
    return { exposure: totalExposure, largestPos, concentration, maxDrawdown: maxDD, riskScore, openPositions: openTrades.length, sectors };
  }, [trades]);

  // ═══════════════════════════════════════════════
  // FEATURE 4: Social Feed / Trade Sharing
  // ═══════════════════════════════════════════════
  const [socialFeed, setSocialFeed] = useState(() => {
    try { return JSON.parse(localStorage.getItem('modus_social_feed')) || []; } catch { return []; }
  });
  const [showShareToFeed, setShowShareToFeed] = useState(false);
  const [shareToFeedContent, setShareToFeedContent] = useState(null);

  const addToSocialFeed = useCallback((item) => {
    const post = {
      id: Date.now(),
      user: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Trader',
      avatar: currentUser?.displayName?.[0]?.toUpperCase() || 'T',
      timestamp: new Date().toISOString(),
      ...item
    };
    setSocialFeed(prev => {
      const updated = [post, ...prev].slice(0, 50);
      localStorage.setItem('modus_social_feed', JSON.stringify(updated));
      return updated;
    });
    setShowShareToFeed(false);
  }, [currentUser]);

  // ═══════════════════════════════════════════════
  // FEATURE 5: Price Target Tracking
  // ═══════════════════════════════════════════════
  const [priceTargets, setPriceTargets] = useState(() => {
    try { return JSON.parse(localStorage.getItem('modus_price_targets')) || []; } catch { return []; }
  });

  useEffect(() => {
    localStorage.setItem('modus_price_targets', JSON.stringify(priceTargets));
  }, [priceTargets]);

  const addPriceTarget = useCallback((ticker, currentPrice, targetPrice, stopPrice, verdict, confidence) => {
    setPriceTargets(prev => [{
      id: Date.now(),
      ticker,
      entryPrice: currentPrice,
      targetPrice: parseFloat(targetPrice),
      stopPrice: parseFloat(stopPrice),
      verdict,
      confidence,
      createdAt: new Date().toISOString(),
      status: 'active', // active, hit, stopped, expired
      hitDate: null
    }, ...prev].slice(0, 100));
  }, []);

  // ═══════════════════════════════════════════════
  // FEATURE 6: Custom Watchlist Groups
  // ═══════════════════════════════════════════════
  const [watchlistGroups, setWatchlistGroups] = useState(() => {
    try { return JSON.parse(localStorage.getItem('modus_watchlist_groups')) || { 'All': [], 'Tech': [], 'Earnings': [], 'Momentum': [] }; } catch { return { 'All': [], 'Tech': [], 'Earnings': [], 'Momentum': [] }; }
  });
  const [activeWatchlistGroup, setActiveWatchlistGroup] = useState('All');
  const [showGroupManager, setShowGroupManager] = useState(false);
  const [newGroupName, setNewGroupName] = useState('');

  useEffect(() => {
    localStorage.setItem('modus_watchlist_groups', JSON.stringify(watchlistGroups));
  }, [watchlistGroups]);

  const addToWatchlistGroup = useCallback((ticker, group) => {
    setWatchlistGroups(prev => {
      const updated = { ...prev };
      if (!updated[group]) updated[group] = [];
      if (!updated[group].includes(ticker)) updated[group] = [...updated[group], ticker];
      return updated;
    });
  }, []);

  const removeFromWatchlistGroup = useCallback((ticker, group) => {
    setWatchlistGroups(prev => {
      const updated = { ...prev };
      if (updated[group]) updated[group] = updated[group].filter(t => t !== ticker);
      return updated;
    });
  }, []);

  // ═══════════════════════════════════════════════
  // FEATURES 27-52: Advanced Trading Analytics
  // ═══════════════════════════════════════════════

  // Sector Heatmap — computed from trades
  const sectorHeatmapData = useMemo(() => {
    const sectorMap = { 'AAPL': 'Tech', 'NVDA': 'Tech', 'MSFT': 'Tech', 'GOOGL': 'Tech', 'META': 'Tech', 'AMD': 'Tech', 'AMZN': 'Consumer', 'TSLA': 'Auto', 'JPM': 'Finance', 'BAC': 'Finance', 'GS': 'Finance', 'WMT': 'Retail', 'COST': 'Retail', 'XOM': 'Energy', 'CVX': 'Energy', 'JNJ': 'Health', 'PFE': 'Health', 'UNH': 'Health', 'DIS': 'Media', 'NFLX': 'Media' };
    const sectors = {};
    (trades || []).forEach(t => {
      const sym = t.symbol || t.ticker || '';
      const sector = sectorMap[sym] || 'Other';
      if (!sectors[sector]) sectors[sector] = { pnl: 0, count: 0, volume: 0 };
      const pnl = t.exit ? (t.exit - t.entry) * (t.quantity || t.shares || 1) * (t.side === 'short' ? -1 : 1) : 0;
      sectors[sector].pnl += pnl;
      sectors[sector].count += 1;
      sectors[sector].volume += Math.abs(t.entry * (t.quantity || t.shares || 1));
    });
    return Object.entries(sectors).map(([name, d]) => ({ name, pnl: d.pnl, count: d.count, volume: d.volume, color: d.pnl >= 0 ? 'emerald' : 'red' })).sort((a, b) => Math.abs(b.pnl) - Math.abs(a.pnl));
  }, [trades]);

  // Economic Calendar
  const [econEvents] = useState([
    { date: '2026-02-10', event: 'Fed Chair Speech', impact: 'high', time: '14:00 EST', forecast: 'N/A', previous: 'N/A' },
    { date: '2026-02-12', event: 'CPI Release', impact: 'high', time: '08:30 EST', forecast: '2.8%', previous: '2.9%' },
    { date: '2026-02-14', event: 'Retail Sales', impact: 'medium', time: '08:30 EST', forecast: '0.3%', previous: '0.4%' },
    { date: '2026-02-19', event: 'FOMC Minutes', impact: 'high', time: '14:00 EST', forecast: 'N/A', previous: 'N/A' },
    { date: '2026-02-21', event: 'Unemployment Claims', impact: 'medium', time: '08:30 EST', forecast: '215K', previous: '219K' },
    { date: '2026-02-28', event: 'GDP (Q4 Rev)', impact: 'high', time: '08:30 EST', forecast: '3.2%', previous: '3.3%' },
    { date: '2026-03-07', event: 'Non-Farm Payrolls', impact: 'high', time: '08:30 EST', forecast: '180K', previous: '256K' },
    { date: '2026-03-12', event: 'CPI Release', impact: 'high', time: '08:30 EST', forecast: '2.7%', previous: '2.8%' },
  ]);

  // Pre-Market Movers — simulated
  const [preMarketMovers] = useState([
    { ticker: 'NVDA', change: 3.45, changePercent: 2.1, volume: '4.2M', type: 'gainer' },
    { ticker: 'TSLA', change: -5.20, changePercent: -1.8, volume: '3.8M', type: 'loser' },
    { ticker: 'AAPL', change: 1.87, changePercent: 0.82, volume: '2.1M', type: 'gainer' },
    { ticker: 'AMD', change: -2.15, changePercent: -1.4, volume: '1.9M', type: 'loser' },
    { ticker: 'META', change: 4.30, changePercent: 0.75, volume: '1.5M', type: 'gainer' },
    { ticker: 'AMZN', change: -1.90, changePercent: -0.95, volume: '1.2M', type: 'loser' },
  ]);

  // Correlation Matrix — computed from watchlist
  const correlationPairs = useMemo(() => {
    if (!watchlist || watchlist.length < 2) return [];
    const pairs = [];
    const seed = watchlist.join('').split('').reduce((a, c) => a + c.charCodeAt(0), 0);
    for (let i = 0; i < Math.min(watchlist.length, 6) - 1; i++) {
      for (let j = i + 1; j < Math.min(watchlist.length, 6); j++) {
        const hash = (seed * (i + 1) * (j + 2)) % 200 - 100;
        const corr = hash / 100;
        pairs.push({ ticker1: watchlist[i], ticker2: watchlist[j], correlation: corr, strength: Math.abs(corr) > 0.7 ? 'strong' : Math.abs(corr) > 0.4 ? 'medium' : 'weak' });
      }
    }
    return pairs.sort((a, b) => Math.abs(b.correlation) - Math.abs(a.correlation));
  }, [watchlist]);

  // Portfolio Heatmap — from trades
  const portfolioHeatmap = useMemo(() => {
    const posMap = {};
    (trades || []).forEach(t => {
      const sym = t.symbol || t.ticker || 'UNK';
      if (!posMap[sym]) posMap[sym] = { pnl: 0, count: 0 };
      const pnl = t.exit ? (t.exit - t.entry) * (t.quantity || 1) * (t.side === 'short' ? -1 : 1) : 0;
      posMap[sym].pnl += pnl;
      posMap[sym].count += 1;
    });
    return Object.entries(posMap).map(([sym, d]) => ({ name: sym, pnl: d.pnl, count: d.count, color: d.pnl >= 0 ? 'emerald' : 'red' })).sort((a, b) => Math.abs(b.pnl) - Math.abs(a.pnl));
  }, [trades]);

  // Dividend Tracker
  const [dividends, setDividends] = useState(() => {
    try { return JSON.parse(localStorage.getItem('modus_dividends')) || [
      { ticker: 'AAPL', exDate: '2026-02-14', payDate: '2026-02-20', dividend: 0.25, yield: 0.5 },
      { ticker: 'MSFT', exDate: '2026-02-20', payDate: '2026-03-06', dividend: 0.75, yield: 0.7 },
      { ticker: 'JPM', exDate: '2026-02-27', payDate: '2026-03-13', dividend: 1.15, yield: 2.1 },
      { ticker: 'JNJ', exDate: '2026-03-10', payDate: '2026-03-25', dividend: 1.24, yield: 2.8 },
      { ticker: 'VTI', exDate: '2026-03-18', payDate: '2026-04-01', dividend: 0.82, yield: 1.4 },
    ]; } catch { return []; }
  });
  useEffect(() => { try { localStorage.setItem('modus_dividends', JSON.stringify(dividends)); } catch {} }, [dividends]);

  // What-If Simulator
  const [whatIfParams, setWhatIfParams] = useState({ entryPrice: 150, exitPrice: 165, shares: 100, direction: 'long' });

  // Mistake Tracker
  const [tradeMistakes, setTradeMistakes] = useState(() => {
    try { return JSON.parse(localStorage.getItem('modus_tradeMistakes')) || []; } catch { return []; }
  });
  useEffect(() => { try { localStorage.setItem('modus_tradeMistakes', JSON.stringify(tradeMistakes)); } catch {} }, [tradeMistakes]);

  // AI Trade Coach
  const [coachMessages] = useState([
    { type: 'insight', message: 'Tip: Set stop-losses BEFORE entering a trade. Pre-planning removes emotional decisions.' },
    { type: 'warning', message: 'Your average hold time has decreased 40%. Ensure you\'re not overtrading.' },
    { type: 'insight', message: 'Consider scaling into positions with 2-3 entries rather than going all-in.' },
    { type: 'insight', message: 'Review losing trades weekly — the pattern of losses reveals more than wins.' },
  ]);
  const [coachMode, setCoachMode] = useState(false);

  // Pattern Scanner
  const [patternResults] = useState([
    { ticker: 'NVDA', pattern: 'Cup & Handle', confidence: 87, timeframe: '4h' },
    { ticker: 'TSLA', pattern: 'Double Bottom', confidence: 72, timeframe: '1D' },
    { ticker: 'AAPL', pattern: 'Bull Flag', confidence: 81, timeframe: '1h' },
    { ticker: 'AMD', pattern: 'Head & Shoulders', confidence: 65, timeframe: '1D' },
  ]);

  // Sentiment Aggregator — from newsFeed
  const sentimentData = useMemo(() => {
    if (!newsFeed || newsFeed.length === 0) return { bullish: 0, bearish: 0, neutral: 0, total: 0 };
    const s = { bullish: 0, bearish: 0, neutral: 0, total: newsFeed.length };
    newsFeed.forEach(item => { s[item.sentiment || 'neutral']++; });
    return s;
  }, [newsFeed]);

  // Position Sizing Advisor
  const [positionSizeParams, setPositionSizeParams] = useState({ accountSize: 25000, riskPercent: 2, entryPrice: 150, stopLoss: 142 });

  // Weekly Performance Report
  const weeklyReport = useMemo(() => {
    const weekAgo = new Date(Date.now() - 7 * 86400000);
    const wt = (trades || []).filter(t => new Date(t.date || t.entryTime || 0) >= weekAgo);
    const wins = wt.filter(t => t.exit && (t.side === 'short' ? t.entry - t.exit : t.exit - t.entry) > 0).length;
    const totalPnL = wt.reduce((s, t) => s + (t.exit ? (t.side === 'short' ? t.entry - t.exit : t.exit - t.entry) * (t.quantity || 1) : 0), 0);
    return { tradeCount: wt.length, wins, losses: wt.length - wins, winRate: wt.length > 0 ? (wins / wt.length * 100).toFixed(1) : '0', totalPnL: totalPnL.toFixed(2) };
  }, [trades]);

  // Chart Annotations
  const [chartAnnotations, setChartAnnotations] = useState(() => {
    try { return JSON.parse(localStorage.getItem('modus_chartAnnotations')) || []; } catch { return []; }
  });
  useEffect(() => { try { localStorage.setItem('modus_chartAnnotations', JSON.stringify(chartAnnotations)); } catch {} }, [chartAnnotations]);

  // Multi-Timeframe — uses existing selectedTimeframes state

  // Custom Watchlist Alerts
  const [customAlerts, setCustomAlerts] = useState(() => {
    try { return JSON.parse(localStorage.getItem('modus_customAlerts')) || []; } catch { return []; }
  });
  useEffect(() => { try { localStorage.setItem('modus_customAlerts', JSON.stringify(customAlerts)); } catch {} }, [customAlerts]);

  // Multi-Account Support
  const [accounts, setAccounts] = useState(() => {
    try { return JSON.parse(localStorage.getItem('modus_accounts')) || [
      { id: 'main', name: 'Main Account', balance: 50000 },
      { id: 'paper', name: 'Paper Trading', balance: 100000 },
    ]; } catch { return [{ id: 'main', name: 'Main Account', balance: 50000 }]; }
  });
  const [activeAccount, setActiveAccount] = useState('main');
  useEffect(() => { try { localStorage.setItem('modus_accounts', JSON.stringify(accounts)); } catch {} }, [accounts]);

  // Trade Tags
  const [tradeTags, setTradeTags] = useState(() => {
    try { return JSON.parse(localStorage.getItem('modus_tradeTags')) || ['#momentum', '#earnings', '#breakout', '#scalp', '#swing', '#reversal']; } catch { return []; }
  });
  useEffect(() => { try { localStorage.setItem('modus_tradeTags', JSON.stringify(tradeTags)); } catch {} }, [tradeTags]);

  // Monthly P&L Calendar
  const monthlyPnL = useMemo(() => {
    const cal = {};
    (trades || []).forEach(t => {
      if (!t.exit) return;
      const d = new Date(t.date || t.entryTime || 0);
      const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      const pnl = (t.side === 'short' ? t.entry - t.exit : t.exit - t.entry) * (t.quantity || 1);
      cal[key] = (cal[key] || 0) + pnl;
    });
    return cal;
  }, [trades]);

  // Trade Screenshots
  const [tradeScreenshots, setTradeScreenshots] = useState(() => {
    try { return JSON.parse(localStorage.getItem('modus_tradeScreenshots')) || []; } catch { return []; }
  });
  useEffect(() => { try { localStorage.setItem('modus_tradeScreenshots', JSON.stringify(tradeScreenshots)); } catch {} }, [tradeScreenshots]);

  // ═══════════════════════════════════════════════
  // FEATURE 7: PWA Install Prompt
  // ═══════════════════════════════════════════════
  const [deferredPrompt, setDeferredPrompt] = useState(null);
  const [showInstallBanner, setShowInstallBanner] = useState(false);
  const [isAppInstalled, setIsAppInstalled] = useState(false);

  useEffect(() => {
    const handler = (e) => {
      e.preventDefault();
      setDeferredPrompt(e);
      setShowInstallBanner(true);
    };
    window.addEventListener('beforeinstallprompt', handler);
    window.addEventListener('appinstalled', () => { setIsAppInstalled(true); setShowInstallBanner(false); });
    if (window.matchMedia('(display-mode: standalone)').matches) setIsAppInstalled(true);
    return () => window.removeEventListener('beforeinstallprompt', handler);
  }, []);

  const handleInstallPWA = async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const result = await deferredPrompt.userChoice;
    if (result.outcome === 'accepted') setIsAppInstalled(true);
    setDeferredPrompt(null);
    setShowInstallBanner(false);
  };

  // ═══════════════════════════════════════════════
  // FEATURE 8: Theme Toggle
  // ═══════════════════════════════════════════════
  const [themeMode, setThemeMode] = useState(() => {
    try { return localStorage.getItem('modus_theme') || 'midnight'; } catch { return 'midnight'; }
  });

  useEffect(() => {
    localStorage.setItem('modus_theme', themeMode);
    const root = document.documentElement;
    root.classList.remove('theme-midnight', 'theme-dark', 'theme-light');
    root.classList.add(`theme-${themeMode}`);
  }, [themeMode]);

  // Guided Setup Wizard
  const [showSetupWizard, setShowSetupWizard] = useState(false);
  const [setupStep, setSetupStep] = useState(0);

  // Custom Dashboard
  const [dashboardWidgets, setDashboardWidgets] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem('modus_dashboard_widgets')) || [
        'clock', 'quickstats', 'quicknav', 'dailytip', 'watchlist', 'dailypick', 'portfolio', 'alerts', 'performance', 'marketsummary', 'news'
      ];
    } catch { return ['clock', 'quickstats', 'quicknav', 'dailytip', 'watchlist', 'dailypick', 'portfolio', 'alerts', 'performance', 'marketsummary', 'news']; }
  });
  const [showDashboardConfig, setShowDashboardConfig] = useState(false);
  const [draggedWidget, setDraggedWidget] = useState(null);
  const [dashboardClock, setDashboardClock] = useState(new Date());

  // Live clock for dashboard
  useEffect(() => {
    if (activeTab !== 'dashboard') return;
    const clockInterval = setInterval(() => setDashboardClock(new Date()), 1000);
    return () => clearInterval(clockInterval);
  }, [activeTab]);

  // Widget reorder helpers
  const moveWidget = (key, direction) => {
    setDashboardWidgets(prev => {
      const idx = prev.indexOf(key);
      if (idx === -1) return prev;
      const newIdx = direction === 'up' ? idx - 1 : idx + 1;
      if (newIdx < 0 || newIdx >= prev.length) return prev;
      const arr = [...prev];
      [arr[idx], arr[newIdx]] = [arr[newIdx], arr[idx]];
      return arr;
    });
  };

  const handleWidgetDragStart = (e, key) => {
    setDraggedWidget(key);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', key);
  };

  const handleWidgetDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  };

  const handleWidgetDrop = (e, targetKey) => {
    e.preventDefault();
    if (!draggedWidget || draggedWidget === targetKey) { setDraggedWidget(null); return; }
    setDashboardWidgets(prev => {
      const arr = [...prev];
      const fromIdx = arr.indexOf(draggedWidget);
      const toIdx = arr.indexOf(targetKey);
      if (fromIdx === -1 || toIdx === -1) return prev;
      arr.splice(fromIdx, 1);
      arr.splice(toIdx, 0, draggedWidget);
      return arr;
    });
    setDraggedWidget(null);
  };

  // Dashboard market status helper (rich version)
  const getDashboardMarketStatus = () => {
    const now = new Date();
    const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
    const day = et.getDay();
    const hours = et.getHours();
    const minutes = et.getMinutes();
    const timeNum = hours * 60 + minutes;
    const isWeekend = day === 0 || day === 6;
    const marketOpen = 9 * 60 + 30; // 9:30 AM ET
    const marketClose = 16 * 60; // 4:00 PM ET
    const preMarketOpen = 4 * 60; // 4:00 AM ET
    const afterHoursClose = 20 * 60; // 8:00 PM ET

    if (isWeekend) return { status: 'closed', label: 'Closed', sublabel: 'Opens Monday 9:30 AM ET', color: 'text-red-400', bg: 'bg-red-500/10' };
    if (timeNum >= marketOpen && timeNum < marketClose) {
      const minsLeft = marketClose - timeNum;
      const h = Math.floor(minsLeft / 60);
      const m = minsLeft % 60;
      return { status: 'open', label: 'Market Open', sublabel: `Closes in ${h}h ${m}m`, color: 'text-emerald-400', bg: 'bg-emerald-500/10' };
    }
    if (timeNum >= preMarketOpen && timeNum < marketOpen) {
      const minsLeft = marketOpen - timeNum;
      const h = Math.floor(minsLeft / 60);
      const m = minsLeft % 60;
      return { status: 'pre', label: 'Pre-Market', sublabel: `Opens in ${h}h ${m}m`, color: 'text-amber-400', bg: 'bg-amber-500/10' };
    }
    if (timeNum >= marketClose && timeNum < afterHoursClose) {
      return { status: 'after', label: 'After Hours', sublabel: 'Regular hours closed', color: 'text-blue-400', bg: 'bg-blue-500/10' };
    }
    return { status: 'closed', label: 'Closed', sublabel: 'Opens 9:30 AM ET', color: 'text-red-400', bg: 'bg-red-500/10' };
  };

  useEffect(() => {
    try { localStorage.setItem('modus_dashboard_widgets', JSON.stringify(dashboardWidgets)); } catch {}
  }, [dashboardWidgets]);

  const [priceChange, setPriceChange] = useState(null); // { amount: 0.50, percent: 0.12, direction: 'up' }
  const [isRefreshing, setIsRefreshing] = useState(false); // Subtle refresh indicator
  const [nextRefreshIn, setNextRefreshIn] = useState(null); // Countdown to next refresh
  
  // Portfolio
  const [portfolio, setPortfolio] = useState([]);
  const [showPortfolio, setShowPortfolio] = useState(false);
  const [showAddPosition, setShowAddPosition] = useState(false);
  const [showEditPosition, setShowEditPosition] = useState(false);
  const [editingPosition, setEditingPosition] = useState(null);
  const [portfolioAutoRefresh, setPortfolioAutoRefresh] = useState(true);
  const [portfolioLastUpdate, setPortfolioLastUpdate] = useState(null);
  const [portfolioUpdating, setPortfolioUpdating] = useState(false);
  const [newPosition, setNewPosition] = useState({
    symbol: "",
    quantity: "",
    avgPrice: "",
    currentPrice: "",
    notes: ""
  });

  // NEW: Trade Planner State
  const [tradePlans, setTradePlans] = useState([]);
  const [showAddPlan, setShowAddPlan] = useState(false);
  const [editingPlan, setEditingPlan] = useState(null);
  const [newPlan, setNewPlan] = useState({
    symbol: "",
    side: "long",
    entryPrice: "",
    stopLoss: "",
    target1: "",
    target2: "",
    quantity: "",
    accountSize: "10000",
    riskPercent: "1",
    thesis: "",
    setup: "",
    timeframe: "day",
    status: "planned", // planned, active, completed, cancelled
    createdAt: null
  });
  
  // ============================================================
  // PHASE 1-3 NEW FEATURES STATE VARIABLES
  // ============================================================
  
  // PHASE 1: Real-Time Portfolio Tracker
  const [livePortfolio, setLivePortfolio] = useState({
    cash: 10000,
    positions: [],
    totalValue: 10000,
    dailyChange: 0,
    totalPnL: 0,
    totalPnLPercent: 0
  });
  const [showAddPortfolioPosition, setShowAddPortfolioPosition] = useState(false);
  
  // PHASE 1: Multi-Ticker Alert Monitoring
  const [monitoredPrices, setMonitoredPrices] = useState({});
  const [alertMonitoring, setAlertMonitoring] = useState({
    enabled: true,
    updateInterval: 15000,
    lastUpdate: null,
    status: 'idle'
  });
  
  // PHASE 1: Hot Stocks Scanner
  const [hotStocks, setHotStocks] = useState({
    gainers: [],
    losers: [],
    volume: [],
    loading: false
  });
  const [scannerProgress, setScannerProgress] = useState({ phase: 'idle', current: 0, total: 0, scanTime: 0 });

  // PHASE 1: Position Sizing Calculator
  const [showPositionSizer, setShowPositionSizer] = useState(false);
  const [positionSizerInputs, setPositionSizerInputs] = useState({
    accountSize: 10000,
    riskPercent: 1,
    entryPrice: '',
    stopLoss: '',
    target: '',
    riskDollars: 100
  });
  const [positionSizerResult, setPositionSizerResult] = useState(null);
  
  // PHASE 2: Historical Alert Performance
  const [alertPerformance, setAlertPerformance] = useState([]);
  const [showAlertPerformance, setShowAlertPerformance] = useState(false);
  
  // PHASE 2: Trade Metrics Dashboard
  const [tradeMetrics, setTradeMetrics] = useState(null);
  const [metricsTimeframe, setMetricsTimeframe] = useState('all');
  
  // PHASE 2: Earnings Calendar
  const [earningsCalendar, setEarningsCalendar] = useState([]);
  const [loadingEarnings, setLoadingEarnings] = useState(false);
  
  // PHASE 2: Correlation Matrix
  const [correlationMatrix, setCorrelationMatrix] = useState(null);
  const [correlationSymbols, setCorrelationSymbols] = useState([]);
  const [loadingCorrelation, setLoadingCorrelation] = useState(false);
  
  // PHASE 2: Risk Calculator
  const [riskMetrics, setRiskMetrics] = useState(null);
  const [showRiskCalculator, setShowRiskCalculator] = useState(false);
  
  // PHASE 3: Alert Backtesting
  const [backtestAlert, setBacktestAlert] = useState(null);
  const [alertBacktestResults, setAlertBacktestResults] = useState(null);
  const [showAlertBacktest, setShowAlertBacktest] = useState(false);
  
  // PHASE 3: Sector Performance
  const [sectorPerformance, setSectorPerformance] = useState([]);
  const [loadingSectors, setLoadingSectors] = useState(false);
  
  // PHASE 3: Market Breadth
  const [marketBreadth, setMarketBreadth] = useState(null);
  const [loadingBreadth, setLoadingBreadth] = useState(false);
  
  // PHASE 3: Drawing Tools
  const [drawings, setDrawings] = useState([]);
  const [activeTool, setActiveTool] = useState(null);
  const [showDrawingToolbar, setShowDrawingToolbar] = useState(false);
  
  // PHASE 3: Multi-Timeframe View
  const [multiTimeframeMode, setMultiTimeframeMode] = useState(false);
  const [timeframeGrid, setTimeframeGrid] = useState([
    { id: 1, timeframe: '5m', symbol: '' },
    { id: 2, timeframe: '15m', symbol: '' },
    { id: 3, timeframe: '1h', symbol: '' },
    { id: 4, timeframe: '1d', symbol: '' }
  ]);
  
  // ============================================================
  
  // Backtesting (Original)
  const [backtestResults, setBacktestResults] = useState(null);
  const [showBacktest, setShowBacktest] = useState(false);
  
  // Sidebar
  const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
    try { return localStorage.getItem('modus_sidebar_collapsed') === 'true'; } catch { return false; }
  });
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [isMobile, setIsMobile] = useState(false);
  const [isTablet, setIsTablet] = useState(false);

  // Persist tab and sidebar state
  useEffect(() => {
    try { localStorage.setItem('modus_active_tab', activeTab); } catch {}
  }, [activeTab]);
  useEffect(() => {
    try { localStorage.setItem('modus_sidebar_collapsed', String(sidebarCollapsed)); } catch {}
  }, [sidebarCollapsed]);

  // Platform detection for keyboard shortcuts
  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);

  // Auto-detect mobile/tablet and collapse sidebar with debounce
  useEffect(() => {
    let resizeTimer;
    const checkMobile = () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        const width = window.innerWidth;
        const mobile = width < 768;
        const tablet = width >= 768 && width < 1024;
        setIsMobile(mobile);
        setIsTablet(tablet);
        if (mobile) {
          setSidebarCollapsed(true);
          setMobileMenuOpen(false);
        } else if (tablet) {
          setSidebarCollapsed(true);
        }
      }, 100);
    };

    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => {
      window.removeEventListener('resize', checkMobile);
      clearTimeout(resizeTimer);
    };
  }, []);

  // Close mobile menu when tab changes + smooth scroll to top
  useEffect(() => {
    if (isMobile) {
      setMobileMenuOpen(false);
    }
    // Scroll main content area to top when switching tabs
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, [activeTab, isMobile]);

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Don't trigger if inside an input, textarea, or contenteditable
      const tag = e.target.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || e.target.isContentEditable) return;

      // "?" (shift+/) to show shortcuts overlay
      if (e.key === '?' || (e.shiftKey && e.key === '/')) {
        e.preventDefault();
        setShowShortcutsOverlay(true);
        return;
      }

      // "n" for quick trade entry
      if (e.key === 'n' && !e.metaKey && !e.ctrlKey) {
        e.preventDefault();
        setShowQuickTradeEntry(true);
        return;
      }

      // "/" to focus Quick Analyze on dashboard
      if (e.key === '/' && activeTab === 'dashboard') {
        e.preventDefault();
        const input = document.querySelector('[placeholder="e.g. AAPL, TSLA, NVDA..."]');
        if (input) input.focus();
      }
      // "q" to go to Quick Analysis
      if (e.key === 'q' && !e.metaKey && !e.ctrlKey) {
        setActiveTab('quickanalysis');
      }
      // "t" to cycle themes
      if (e.key === 't' && !e.metaKey && !e.ctrlKey && activeTab === 'dashboard') {
        setThemeMode(prev => prev === 'midnight' ? 'dark' : prev === 'dark' ? 'light' : 'midnight');
      }
      // "d" to go to dashboard
      if (e.key === 'd' && !e.metaKey && !e.ctrlKey) {
        setActiveTab('dashboard');
      }
      // "j" to go to journal
      if (e.key === 'j' && !e.metaKey && !e.ctrlKey) {
        setActiveTab('journal');
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [activeTab]);

  // =================================================================
  // OPTIONS TRADING STATE VARIABLES
  // =================================================================
  
  // Options Chain
  const [optionsSymbol, setOptionsSymbol] = useState("");
  const [optionsExpiration, setOptionsExpiration] = useState("");
  const [optionsChain, setOptionsChain] = useState({ calls: [], puts: [] });
  const [loadingOptions, setLoadingOptions] = useState(false);
  const [optionsError, setOptionsError] = useState(null);
  const [expirationDates, setExpirationDates] = useState([]);
  
  // Options Strategy Builder
  const [selectedStrategy, setSelectedStrategy] = useState("covered_call"); // covered_call, protective_put, bull_call_spread, etc.
  const [strategyLegs, setStrategyLegs] = useState([]);
  const [strategyPL, setStrategyPL] = useState(null);
  const [strategyGreeks, setStrategyGreeks] = useState(null);
  
  // Individual Option Selection
  const [selectedCall, setSelectedCall] = useState(null);
  const [selectedPut, setSelectedPut] = useState(null);
  
  // Options Position Tracking
  const [optionsPositions, setOptionsPositions] = useState([]);
  const [showAddOptionsPosition, setShowAddOptionsPosition] = useState(false);
  const [newOptionsPosition, setNewOptionsPosition] = useState({
    symbol: "",
    optionType: "call", // call or put
    strike: "",
    expiration: "",
    quantity: "",
    premium: "",
    underlying: "",
    notes: ""
  });
  
  // Strategy Parameters
  const [underlyingPrice, setUnderlyingPrice] = useState("");
  const [positionSize, setPositionSize] = useState(100); // Number of shares/contracts
  const [impliedVolatility, setImpliedVolatility] = useState(30); // IV%
  const [daysToExpiration, setDaysToExpiration] = useState(30);
  const [riskFreeRate, setRiskFreeRate] = useState(4.5); // %
  
  // Strategy-specific parameters
  const [callStrike, setCallStrike] = useState("");
  const [putStrike, setPutStrike] = useState("");
  const [callPremium, setCallPremium] = useState("");
  const [putPremium, setPutPremium] = useState("");
  const [longStrike, setLongStrike] = useState("");
  const [shortStrike, setShortStrike] = useState("");
  const [netDebit, setNetDebit] = useState("");
  const [netCredit, setNetCredit] = useState("");
  const [spreadWidth, setSpreadWidth] = useState("");
  
  // Calculated results
  const [calculatedResults, setCalculatedResults] = useState({
    maxProfit: 0,
    maxLoss: 0,
    breakeven: 0,
    winProbability: 0,
    currentPL: 0
  });
  
  // Live Greeks
  const [liveGreeks, setLiveGreeks] = useState({
    delta: 0,
    gamma: 0,
    theta: 0,
    vega: 0,
    rho: 0
  });
  
  // P&L Calculation
  const [plPriceRange, setPlPriceRange] = useState({ min: 0, max: 0 });
  const [plPoints, setPlPoints] = useState([]);
  
  // Options Analysis
  const [optionsAnalysis, setOptionsAnalysis] = useState(null);
  const [loadingOptionsAnalysis, setLoadingOptionsAnalysis] = useState(false);
  
  // =================================================================
  // ADVANCED ALERTS STATE VARIABLES
  // =================================================================
  
  // Alert history
  const [alertHistory, setAlertHistory] = useState([]);
  const [showAlertHistory, setShowAlertHistory] = useState(false);
  
  // Multi-condition alerts
  const [alertConditions, setAlertConditions] = useState([
    { field: 'price', operator: 'above', value: '', logic: 'AND' }
  ]);
  
  // Technical indicator alerts
  const [technicalAlertType, setTechnicalAlertType] = useState('simple'); // simple, technical, multi
  const [rsiThreshold, setRsiThreshold] = useState(70);
  const [macdCondition, setMacdCondition] = useState('bullish_cross');
  
  // Chart enhancements
  const [showVolume, setShowVolume] = useState(true);
  const [showRSI, setShowRSI] = useState(false);
  const [showMACD, setShowMACD] = useState(false);
  const [showSMA, setShowSMA] = useState(false);
  const [showEMA, setShowEMA] = useState(false);
  const [showBollinger, setShowBollinger] = useState(false);
  const [showStochastic, setShowStochastic] = useState(false);
  const [showATR, setShowATR] = useState(false);
  const [showVWAP, setShowVWAP] = useState(false);
  
  // Indicator settings
  const [smaPeriod, setSmaPeriod] = useState(20);
  const [emaPeriod, setEmaPeriod] = useState(20);
  const [bollingerPeriod, setBollingerPeriod] = useState(20);
  const [bollingerStdDev, setBollingerStdDev] = useState(2);
  const [showTickerOverlay, setShowTickerOverlay] = useState(true);

  // Chart Comparison Overlay
  const [comparisonSymbol, setComparisonSymbol] = useState('');
  const [comparisonData, setComparisonData] = useState(null);
  const [loadingComparison, setLoadingComparison] = useState(false);
  const [showComparison, setShowComparison] = useState(false);

  const fileInputRef = useRef(null);

  // =================================================================
  // OPTIONS CALCULATOR FUNCTIONS - Black-Scholes & Greeks
  // =================================================================
  
  // Standard normal cumulative distribution function
  const normCDF = (x) => {
    const t = 1 / (1 + 0.2316419 * Math.abs(x));
    const d = 0.3989423 * Math.exp(-x * x / 2);
    const prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
    return x > 0 ? 1 - prob : prob;
  };
  
  // Black-Scholes Option Pricing
  const blackScholes = (S, K, T, r, sigma, type = 'call') => {
    if (!S || !K || !T || T <= 0 || !sigma) return 0;
    
    const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
    const d2 = d1 - sigma * Math.sqrt(T);
    
    if (type === 'call') {
      return S * normCDF(d1) - K * Math.exp(-r * T) * normCDF(d2);
    } else {
      return K * Math.exp(-r * T) * normCDF(-d2) - S * normCDF(-d1);
    }
  };
  
  // Greeks Calculations
  const calculateGreeks = (S, K, T, r, sigma, type = 'call') => {
    if (!S || !K || !T || T <= 0 || !sigma) {
      return { delta: 0, gamma: 0, theta: 0, vega: 0, rho: 0 };
    }
    
    const sqrtT = Math.sqrt(T);
    const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * sqrtT);
    const d2 = d1 - sigma * sqrtT;
    
    // Delta
    const delta = type === 'call' ? normCDF(d1) : normCDF(d1) - 1;
    
    // Gamma (same for calls and puts)
    const gamma = Math.exp(-d1 * d1 / 2) / (S * sigma * sqrtT * Math.sqrt(2 * Math.PI));
    
    // Theta
    const term1 = -(S * Math.exp(-d1 * d1 / 2) * sigma) / (2 * sqrtT * Math.sqrt(2 * Math.PI));
    const term2 = r * K * Math.exp(-r * T);
    const theta = type === 'call' 
      ? (term1 - term2 * normCDF(d2)) / 365
      : (term1 + term2 * normCDF(-d2)) / 365;
    
    // Vega (same for calls and puts)
    const vega = (S * sqrtT * Math.exp(-d1 * d1 / 2)) / (100 * Math.sqrt(2 * Math.PI));
    
    // Rho
    const rho = type === 'call'
      ? (K * T * Math.exp(-r * T) * normCDF(d2)) / 100
      : (-K * T * Math.exp(-r * T) * normCDF(-d2)) / 100;
    
    return { delta, gamma, theta, vega, rho };
  };
  
  // Strategy P/L Calculators
  const calculateCoveredCallPL = (stockPrice, strikePrice, premium) => {
    const strike = parseFloat(strikePrice);
    const prem = parseFloat(premium);
    const current = parseFloat(stockPrice);
    
    if (isNaN(strike) || isNaN(prem) || isNaN(current)) return { maxProfit: 0, maxLoss: 0, breakeven: 0 };
    
    const maxProfit = (strike - current + prem) * 100;
    const maxLoss = (current - prem) * 100; // If stock goes to 0
    const breakeven = current - prem;
    
    return { maxProfit, maxLoss: -maxLoss, breakeven };
  };
  
  const calculateProtectivePutPL = (stockPrice, putStrike, premium) => {
    const strike = parseFloat(putStrike);
    const prem = parseFloat(premium);
    const current = parseFloat(stockPrice);
    
    if (isNaN(strike) || isNaN(prem) || isNaN(current)) return { maxProfit: 0, maxLoss: 0, breakeven: 0 };
    
    const maxProfit = Infinity; // Unlimited upside
    const maxLoss = (current - strike + prem) * 100;
    const breakeven = current + prem;
    
    return { maxProfit: 'Unlimited', maxLoss: -maxLoss, breakeven };
  };
  
  const calculateBullCallSpreadPL = (longStrike, shortStrike, netDebit) => {
    const long = parseFloat(longStrike);
    const short = parseFloat(shortStrike);
    const debit = parseFloat(netDebit);
    
    if (isNaN(long) || isNaN(short) || isNaN(debit)) return { maxProfit: 0, maxLoss: 0, breakeven: 0 };
    
    const maxProfit = (short - long - debit) * 100;
    const maxLoss = debit * 100;
    const breakeven = long + debit;
    
    return { maxProfit, maxLoss: -maxLoss, breakeven };
  };
  
  const calculateBearPutSpreadPL = (longStrike, shortStrike, netDebit) => {
    const long = parseFloat(longStrike);
    const short = parseFloat(shortStrike);
    const debit = parseFloat(netDebit);
    
    if (isNaN(long) || isNaN(short) || isNaN(debit)) return { maxProfit: 0, maxLoss: 0, breakeven: 0 };
    
    const maxProfit = (long - short - debit) * 100;
    const maxLoss = debit * 100;
    const breakeven = long - debit;
    
    return { maxProfit, maxLoss: -maxLoss, breakeven };
  };
  
  const calculateIronCondorPL = (putSpreadWidth, callSpreadWidth, netCredit) => {
    const putWidth = parseFloat(putSpreadWidth);
    const callWidth = parseFloat(callSpreadWidth);
    const credit = parseFloat(netCredit);
    
    if (isNaN(putWidth) || isNaN(callWidth) || isNaN(credit)) return { maxProfit: 0, maxLoss: 0, breakeven: 0 };
    
    const maxProfit = credit * 100;
    const maxLoss = (Math.max(putWidth, callWidth) - credit) * 100;
    
    return { maxProfit, maxLoss: -maxLoss, breakeven: 'Multiple' };
  };
  
  // =================================================================
  // TECHNICAL INDICATORS CALCULATION FUNCTIONS
  // =================================================================
  
  // Calculate RSI (Relative Strength Index)
  const calculateRSI = (prices, period = 14) => {
    if (!prices || prices.length < period + 1) return null;
    
    const changes = [];
    for (let i = 1; i < prices.length; i++) {
      changes.push(prices[i] - prices[i - 1]);
    }
    
    const gains = changes.map(c => c > 0 ? c : 0);
    const losses = changes.map(c => c < 0 ? -c : 0);
    
    const avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period;
    const avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period;
    
    if (avgLoss === 0) return 100;
    const rs = avgGain / avgLoss;
    return 100 - (100 / (1 + rs));
  };
  
  // Calculate MACD (Moving Average Convergence Divergence)
  const calculateMACD = (prices, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) => {
    if (!prices || prices.length < slowPeriod + signalPeriod) return null;
    
    const ema = (data, period) => {
      const k = 2 / (period + 1);
      let emaValue = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
      const emaArray = [emaValue];
      
      for (let i = period; i < data.length; i++) {
        emaValue = data[i] * k + emaValue * (1 - k);
        emaArray.push(emaValue);
      }
      return emaArray;
    };
    
    const fastEMA = ema(prices, fastPeriod);
    const slowEMA = ema(prices, slowPeriod);
    
    const macdLine = fastEMA.map((val, i) => val - slowEMA[i]).filter(v => !isNaN(v));
    const signalLine = ema(macdLine, signalPeriod);
    const histogram = macdLine.map((val, i) => i < signalLine.length ? val - signalLine[i] : 0);
    
    return {
      macd: macdLine[macdLine.length - 1],
      signal: signalLine[signalLine.length - 1],
      histogram: histogram[histogram.length - 1]
    };
  };
  
  // =================================================================
  // ADVANCED ALERT CHECKING FUNCTIONS
  // =================================================================
  
  // Check technical indicator conditions
  const checkTechnicalAlert = (symbol, data) => {
    if (!data || !data.timeSeries || data.timeSeries.length === 0) return false;
    
    const prices = data.timeSeries.map(bar => bar.close).filter(p => p && !isNaN(p));
    if (prices.length < 30) return false;
    
    // Check RSI condition
    const rsi = calculateRSI(prices, 14);
    if (rsi && ((rsiThreshold > 50 && rsi > rsiThreshold) || (rsiThreshold <= 50 && rsi < rsiThreshold))) {
      return { triggered: true, type: 'RSI', value: rsi, message: `RSI is ${(rsi || 0).toFixed(2)}` };
    }
    
    // Check MACD condition
    const macd = calculateMACD(prices);
    if (macd) {
      if (macdCondition === 'bullish_cross' && macd.macd > macd.signal && macd.histogram > 0) {
        return { triggered: true, type: 'MACD', value: 'Bullish Cross', message: 'MACD bullish crossover!' };
      }
      if (macdCondition === 'bearish_cross' && macd.macd < macd.signal && macd.histogram < 0) {
        return { triggered: true, type: 'MACD', value: 'Bearish Cross', message: 'MACD bearish crossover!' };
      }
    }
    
    return false;
  };
  
  // Check multi-condition alerts
  const checkMultiConditionAlert = (conditions, currentPrice, data) => {
    let results = [];
    
    for (const condition of conditions) {
      const value = parseFloat(condition.value);
      if (isNaN(value)) continue;
      
      let conditionMet = false;
      
      if (condition.field === 'price') {
        if (condition.operator === 'above' && currentPrice > value) conditionMet = true;
        if (condition.operator === 'below' && currentPrice < value) conditionMet = true;
        if (condition.operator === 'equals' && Math.abs(currentPrice - value) < 0.01) conditionMet = true;
      }
      
      results.push(conditionMet);
    }
    
    // Apply logic (AND/OR)
    if (alertConditions[0]?.logic === 'AND') {
      return results.every(r => r);
    } else {
      return results.some(r => r);
    }
  };

  // Live clock
  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);
  
  // Auto-calculate options when parameters change
  useEffect(() => {
    if (!underlyingPrice || underlyingPrice <= 0) return;
    
    const S = parseFloat(underlyingPrice);
    const T = daysToExpiration / 365;
    const r = riskFreeRate / 100;
    const sigma = impliedVolatility / 100;
    
    let results = { maxProfit: 0, maxLoss: 0, breakeven: 0, winProbability: 50 };
    let greeks = { delta: 0, gamma: 0, theta: 0, vega: 0, rho: 0 };
    
    // Calculate based on selected strategy
    if (selectedStrategy === 'covered_call' && callStrike && callPremium) {
      results = calculateCoveredCallPL(S, callStrike, callPremium);
      greeks = calculateGreeks(S, parseFloat(callStrike), T, r, sigma, 'call');
      results.winProbability = 100 - (normCDF((parseFloat(callStrike) - S) / (S * sigma * Math.sqrt(T))) * 100);
    }
    
    else if (selectedStrategy === 'protective_put' && putStrike && putPremium) {
      results = calculateProtectivePutPL(S, putStrike, putPremium);
      greeks = calculateGreeks(S, parseFloat(putStrike), T, r, sigma, 'put');
      results.winProbability = normCDF((S - parseFloat(putStrike)) / (S * sigma * Math.sqrt(T))) * 100;
    }
    
    else if (selectedStrategy === 'bull_call_spread' && longStrike && shortStrike && netDebit) {
      results = calculateBullCallSpreadPL(longStrike, shortStrike, netDebit);
      const longGreeks = calculateGreeks(S, parseFloat(longStrike), T, r, sigma, 'call');
      const shortGreeks = calculateGreeks(S, parseFloat(shortStrike), T, r, sigma, 'call');
      greeks = {
        delta: longGreeks.delta - shortGreeks.delta,
        gamma: longGreeks.gamma - shortGreeks.gamma,
        theta: longGreeks.theta - shortGreeks.theta,
        vega: longGreeks.vega - shortGreeks.vega,
        rho: longGreeks.rho - shortGreeks.rho
      };
      results.winProbability = normCDF((parseFloat(longStrike) + parseFloat(netDebit) - S) / (S * sigma * Math.sqrt(T))) * 100;
    }
    
    else if (selectedStrategy === 'bear_put_spread' && longStrike && shortStrike && netDebit) {
      results = calculateBearPutSpreadPL(longStrike, shortStrike, netDebit);
      const longGreeks = calculateGreeks(S, parseFloat(longStrike), T, r, sigma, 'put');
      const shortGreeks = calculateGreeks(S, parseFloat(shortStrike), T, r, sigma, 'put');
      greeks = {
        delta: longGreeks.delta - shortGreeks.delta,
        gamma: longGreeks.gamma - shortGreeks.gamma,
        theta: longGreeks.theta - shortGreeks.theta,
        vega: longGreeks.vega - shortGreeks.vega,
        rho: longGreeks.rho - shortGreeks.rho
      };
      results.winProbability = 100 - (normCDF((parseFloat(longStrike) - parseFloat(netDebit) - S) / (S * sigma * Math.sqrt(T))) * 100);
    }
    
    else if (selectedStrategy === 'iron_condor' && spreadWidth && netCredit) {
      results = calculateIronCondorPL(spreadWidth, spreadWidth, netCredit);
      results.winProbability = 70; // Rough estimate for iron condor
    }
    
    setCalculatedResults(results);
    setLiveGreeks(greeks);
    
  }, [underlyingPrice, callStrike, callPremium, putStrike, putPremium, longStrike, shortStrike, 
      netDebit, netCredit, spreadWidth, daysToExpiration, impliedVolatility, riskFreeRate, selectedStrategy]);

  // Load saved API key and Q&A history
  useEffect(() => {
    const savedKey = sessionStorage.getItem("modus_api_key");
    if (savedKey) {
      // Clean saved key
      const cleanKey = savedKey.trim().replace(/[\u0000-\u001F\u007F-\uFFFF]/g, '').replace(/\s+/g, '');
      setApiKey(cleanKey);
    }
    const savedStockKey = sessionStorage.getItem("modus_stock_api_key");
    if (savedStockKey) {
      // Clean saved stock key
      const cleanStockKey = savedStockKey.trim().replace(/[\u0000-\u001F\u007F-\uFFFF]/g, '').replace(/\s+/g, '');
      setStockApiKey(cleanStockKey);
    }
    const savedQA = sessionStorage.getItem("modus_qa_history");
    if (savedQA) setQaHistory(JSON.parse(savedQA));
    const savedAlerts = sessionStorage.getItem("modus_alerts");
    if (savedAlerts) setAlerts(JSON.parse(savedAlerts));

    // Load SMS settings
    const savedSmsSettings = sessionStorage.getItem("modus_sms_settings");
    if (savedSmsSettings) {
      try {
        setSmsSettings(JSON.parse(savedSmsSettings));
      } catch (e) {
        console.log("[Settings] Could not parse saved SMS settings");
      }
    }

    // Load backend mode preference
    const savedBackendMode = sessionStorage.getItem("modus_use_backend");
    if (savedBackendMode !== null) {
      try {
        setUseBackendApi(JSON.parse(savedBackendMode));
      } catch (e) {
        console.log("[Settings] Could not parse backend mode setting");
      }
    }
  }, []);

  // NEW: Save alerts when they change
  useEffect(() => {
    sessionStorage.setItem("modus_alerts", JSON.stringify(alerts));
  }, [alerts]);

  // Persist ticker settings when they change AND keep ref in sync
  useEffect(() => {
    sessionStorage.setItem("modus_ticker_timeframe", tickerTimeframe);
    tickerTimeframeRef.current = tickerTimeframe; // Keep ref in sync!
    console.log(`[Settings] Timeframe saved & ref updated: ${tickerTimeframe}`);
  }, [tickerTimeframe]);

  useEffect(() => {
    sessionStorage.setItem("modus_ticker_candles", tickerCandleCount.toString());
  }, [tickerCandleCount]);

  // Real-time Price Updates — updates price display AND last chart candle
  // This is the ONLY periodic updater. Chart shape stays stable; only the latest candle moves.
  useEffect(() => {
    if (!tickerSymbol || !tickerData || !tickerData.currentPrice) return;

    const updatePrice = async () => {
      try {
        const quote = await fetchCurrentQuote(tickerSymbol);

        if (!quote || !quote.price) {
          setTickerData(prev => prev ? ({ ...prev, lastRealUpdate: Date.now(), isLive: true }) : prev);
          return;
        }

        const newPrice = quote.price;

        setTickerData(prev => {
          if (!prev) return prev;
          const oldPrice = prev.currentPrice;

          // Reject suspicious data: >10% change in a single tick
          if (Math.abs(newPrice - oldPrice) / oldPrice > 0.10) {
            console.log(`[Real-Time] ⚠️ Rejected suspicious price: $${oldPrice.toFixed(2)} → $${newPrice.toFixed(2)}`);
            return { ...prev, lastRealUpdate: Date.now(), isLive: true };
          }

          // Update the last candle in the timeSeries to reflect the latest price
          let updatedSeries = prev.timeSeries;
          if (updatedSeries && updatedSeries.length > 0) {
            updatedSeries = [...updatedSeries];
            const lastCandle = { ...updatedSeries[updatedSeries.length - 1] };
            lastCandle.close = newPrice;
            lastCandle.high = Math.max(lastCandle.high, newPrice);
            lastCandle.low = Math.min(lastCandle.low, newPrice);
            updatedSeries[updatedSeries.length - 1] = lastCandle;
          }

          // Flash the price change
          if (Math.abs(newPrice - oldPrice) > 0.001) {
            setPriceFlash(newPrice > oldPrice ? 'up' : 'down');
            setLastPriceUpdate(Date.now());
            setTimeout(() => setPriceFlash(null), 500);
          }

          return {
            ...prev,
            currentPrice: newPrice,
            change: quote.change || (newPrice - prev.open),
            changePercent: quote.changePercent || (((newPrice - prev.open) / prev.open) * 100),
            marketState: quote.marketState,
            timeSeries: updatedSeries,
            lastUpdate: new Date(),
            lastRealUpdate: Date.now(),
            isLive: true
          };
        });
      } catch (err) {
        // Silent fail — maintain LIVE status, don't disrupt chart
        setTickerData(prev => prev ? ({ ...prev, isLive: true, lastRealUpdate: Date.now() }) : prev);
      }
    };

    // Update every 10 seconds
    const interval = setInterval(updatePrice, 10000);
    updatePrice();

    return () => clearInterval(interval);
  }, [tickerSymbol, tickerData?.open]);
  
  // NOTE: Old checkAlertsAgainstRealPrice removed - now handled by background monitor
  
  // Request notification permission on mount
  useEffect(() => {
    if (typeof Notification !== 'undefined' && Notification.permission === "default") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          console.log("✅ Browser notifications enabled");
        }
      });
    }
  }, []);

  // NOTE: Alert checking is now handled by the background watchlist monitor
  // This ensures ALL alerts are checked, not just the current ticker symbol

  // Request notification permission
  useEffect(() => {
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission();
    }
  }, []);
  
  // =================================================================
  // NEW: STORAGE PERSISTENCE FOR NEW FEATURES
  // =================================================================
  
  // Load all saved data on mount
  useEffect(() => {
    const savedWatchlist = localStorage.getItem("modus_watchlist");
    if (savedWatchlist) setWatchlist(JSON.parse(savedWatchlist));

    const savedHistory = localStorage.getItem("modus_history");
    if (savedHistory) setAnalysisHistory(JSON.parse(savedHistory));

    const savedTrades = localStorage.getItem("modus_trades");
    if (savedTrades) setTrades(JSON.parse(savedTrades));

    const savedPortfolio = localStorage.getItem("modus_portfolio");
    if (savedPortfolio) setPortfolio(JSON.parse(savedPortfolio));

    const savedTradePlans = localStorage.getItem("modus_trade_plans");
    if (savedTradePlans) setTradePlans(JSON.parse(savedTradePlans));

    // Load paper trading account
    const savedPaperTrading = localStorage.getItem("modus_paper_trading");
    if (savedPaperTrading) {
      const parsed = JSON.parse(savedPaperTrading);
      setPaperTradingAccount(parsed);
    }

    // Load portfolio settings
    const savedPortfolioSettings = localStorage.getItem("modus_portfolio_settings");
    if (savedPortfolioSettings) {
      setPortfolioSettings(JSON.parse(savedPortfolioSettings));
    }
  }, []);

  // =================================================================
  // CLOUD SYNC - Load ALL user data when logged in
  // =================================================================
  useEffect(() => {
    async function loadCloudData() {
      if (currentUser && cloudSyncEnabled) {
        setIsLoadingCloudData(true);
        setCloudSyncStatus('syncing');
        try {
          const cloudData = await loadUserData();
          if (cloudData) {
            // Load watchlist from cloud
            if (cloudData.watchlist && cloudData.watchlist.length > 0) {
              setWatchlist(cloudData.watchlist);
              localStorage.setItem("modus_watchlist", JSON.stringify(cloudData.watchlist));
            }
            // Load paper trading from cloud
            if (cloudData.paperTrading) {
              setPaperTradingAccount(cloudData.paperTrading);
              localStorage.setItem("modus_paper_trading", JSON.stringify(cloudData.paperTrading));
            }
            // Load portfolio from cloud
            if (cloudData.portfolio && cloudData.portfolio.length > 0) {
              setPortfolio(cloudData.portfolio);
              localStorage.setItem("modus_portfolio", JSON.stringify(cloudData.portfolio));
            }
            // Load trades (journal) from cloud
            if (cloudData.trades && cloudData.trades.length > 0) {
              setTrades(cloudData.trades);
              localStorage.setItem("modus_trades", JSON.stringify(cloudData.trades));
            }
            // Load trade plans from cloud
            if (cloudData.tradePlans && cloudData.tradePlans.length > 0) {
              setTradePlans(cloudData.tradePlans);
              localStorage.setItem("modus_trade_plans", JSON.stringify(cloudData.tradePlans));
            }
            // Load analysis history from cloud
            if (cloudData.analysisHistory && cloudData.analysisHistory.length > 0) {
              setAnalysisHistory(cloudData.analysisHistory);
              localStorage.setItem("modus_history", JSON.stringify(cloudData.analysisHistory));
            }
            // Load portfolio settings from cloud
            if (cloudData.portfolioSettings) {
              setPortfolioSettings(cloudData.portfolioSettings);
              localStorage.setItem("modus_portfolio_settings", JSON.stringify(cloudData.portfolioSettings));
            }
            setLastSyncTime(new Date());
            setCloudSyncStatus('synced');
            console.log('All cloud data loaded successfully');
          } else {
            // No cloud data yet, upload current local data
            const localWatchlist = JSON.parse(localStorage.getItem("modus_watchlist") || '[]');
            const localPaperTrading = JSON.parse(localStorage.getItem("modus_paper_trading") || 'null');
            const localPortfolio = JSON.parse(localStorage.getItem("modus_portfolio") || '[]');
            const localTrades = JSON.parse(localStorage.getItem("modus_trades") || '[]');
            const localTradePlans = JSON.parse(localStorage.getItem("modus_trade_plans") || '[]');
            const localHistory = JSON.parse(localStorage.getItem("modus_history") || '[]');
            const localPortfolioSettings = JSON.parse(localStorage.getItem("modus_portfolio_settings") || 'null');

            // Upload all local data to cloud
            if (localWatchlist.length > 0) await syncData('watchlist', localWatchlist);
            if (localPaperTrading) await syncData('paperTrading', localPaperTrading);
            if (localPortfolio.length > 0) await syncData('portfolio', localPortfolio);
            if (localTrades.length > 0) await syncData('trades', localTrades);
            if (localTradePlans.length > 0) await syncData('tradePlans', localTradePlans);
            if (localHistory.length > 0) await syncData('analysisHistory', localHistory);
            if (localPortfolioSettings) await syncData('portfolioSettings', localPortfolioSettings);

            setLastSyncTime(new Date());
            setCloudSyncStatus('synced');
            console.log('Local data uploaded to cloud');
          }
        } catch (error) {
          console.error('Error loading cloud data:', error);
          setCloudSyncStatus('error');
        }
        setIsLoadingCloudData(false);
      } else if (!currentUser) {
        setCloudSyncStatus('idle');
      }
    }
    loadCloudData();
  }, [currentUser, cloudSyncEnabled]);

  // Save watchlist (local + cloud)
  useEffect(() => {
    if (watchlist.length > 0) {
      localStorage.setItem("modus_watchlist", JSON.stringify(watchlist));
      // Sync to cloud if logged in (debounced)
      if (currentUser && cloudSyncEnabled && !isLoadingCloudData) {
        const syncTimeout = setTimeout(async () => {
          setCloudSyncStatus('syncing');
          const success = await syncData('watchlist', watchlist);
          setCloudSyncStatus(success ? 'synced' : 'error');
          if (success) setLastSyncTime(new Date());
        }, 1000); // Debounce 1 second
        return () => clearTimeout(syncTimeout);
      }
    }
  }, [watchlist, currentUser, cloudSyncEnabled, isLoadingCloudData]);
  
  // Save analysis history (with size limit and error handling) + CLOUD SYNC
  useEffect(() => {
    if (analysisHistory.length > 0) {
      try {
        // Limit history to last 30 entries to prevent quota issues
        const limitedHistory = analysisHistory.slice(-30);

        // Remove large image data from history entries to save space
        const compactHistory = limitedHistory.map(entry => ({
          ...entry,
          // Remove base64 image data if present (very large)
          imageData: entry.imageData ? { mediaType: entry.imageData.mediaType, data: '[TRUNCATED]' } : null
        }));

        localStorage.setItem("modus_history", JSON.stringify(compactHistory));

        // Cloud sync (debounced)
        if (currentUser && cloudSyncEnabled && !isLoadingCloudData) {
          const syncTimeout = setTimeout(async () => {
            await syncData('analysisHistory', compactHistory);
          }, 2000);
          return () => clearTimeout(syncTimeout);
        }
      } catch (e) {
        console.warn("[Storage] localStorage quota exceeded, clearing old history");
        try {
          localStorage.removeItem("modus_history");
          const minimalHistory = analysisHistory.slice(-10).map(entry => ({
            ...entry,
            imageData: null
          }));
          localStorage.setItem("modus_history", JSON.stringify(minimalHistory));
        } catch (e2) {
          console.error("[Storage] Unable to save history:", e2);
        }
      }
    }
  }, [analysisHistory, currentUser, cloudSyncEnabled, isLoadingCloudData]);

  // Save trades (journal) + CLOUD SYNC
  useEffect(() => {
    if (trades.length > 0) {
      localStorage.setItem("modus_trades", JSON.stringify(trades));
      // Cloud sync (debounced)
      if (currentUser && cloudSyncEnabled && !isLoadingCloudData) {
        const syncTimeout = setTimeout(async () => {
          await syncData('trades', trades);
        }, 1500);
        return () => clearTimeout(syncTimeout);
      }
    }
  }, [trades, currentUser, cloudSyncEnabled, isLoadingCloudData]);

  // Save portfolio + CLOUD SYNC
  useEffect(() => {
    if (portfolio.length > 0) {
      localStorage.setItem("modus_portfolio", JSON.stringify(portfolio));
      // Cloud sync (debounced)
      if (currentUser && cloudSyncEnabled && !isLoadingCloudData) {
        const syncTimeout = setTimeout(async () => {
          await syncData('portfolio', portfolio);
        }, 1500);
        return () => clearTimeout(syncTimeout);
      }
    }
  }, [portfolio, currentUser, cloudSyncEnabled, isLoadingCloudData]);

  // Save trade plans + CLOUD SYNC
  useEffect(() => {
    if (tradePlans.length > 0) {
      localStorage.setItem("modus_trade_plans", JSON.stringify(tradePlans));
      // Cloud sync (debounced)
      if (currentUser && cloudSyncEnabled && !isLoadingCloudData) {
        const syncTimeout = setTimeout(async () => {
          await syncData('tradePlans', tradePlans);
        }, 1500);
        return () => clearTimeout(syncTimeout);
      }
    }
  }, [tradePlans, currentUser, cloudSyncEnabled, isLoadingCloudData]);

  // Save paper trading account + CLOUD SYNC
  useEffect(() => {
    localStorage.setItem("modus_paper_trading", JSON.stringify(paperTradingAccount));
    // Cloud sync (debounced)
    if (currentUser && cloudSyncEnabled && !isLoadingCloudData) {
      const syncTimeout = setTimeout(async () => {
        await syncData('paperTrading', paperTradingAccount);
      }, 1500);
      return () => clearTimeout(syncTimeout);
    }
  }, [paperTradingAccount, currentUser, cloudSyncEnabled, isLoadingCloudData]);

  // Save portfolio settings + CLOUD SYNC
  useEffect(() => {
    localStorage.setItem("modus_portfolio_settings", JSON.stringify(portfolioSettings));
    // Cloud sync (debounced)
    if (currentUser && cloudSyncEnabled && !isLoadingCloudData) {
      const syncTimeout = setTimeout(async () => {
        await syncData('portfolioSettings', portfolioSettings);
      }, 1500);
      return () => clearTimeout(syncTimeout);
    }
  }, [portfolioSettings, currentUser, cloudSyncEnabled, isLoadingCloudData]);

  // Save API key
  const saveApiKey = () => {
    // Clean API keys: remove whitespace and hidden characters
    const cleanAnthropicKey = apiKeyInput
      .trim()
      .replace(/[\u0000-\u001F\u007F-\uFFFF]/g, '') // Remove non-ASCII
      .replace(/\s+/g, ''); // Remove whitespace
    
    const cleanStockKey = stockApiKeyInput
      .trim()
      .replace(/[\u0000-\u001F\u007F-\uFFFF]/g, '')
      .replace(/\s+/g, '');
    
    setApiKey(cleanAnthropicKey);
    sessionStorage.setItem("modus_api_key", cleanAnthropicKey);
    setStockApiKey(cleanStockKey);
    sessionStorage.setItem("modus_stock_api_key", cleanStockKey);
    setShowApiKeyModal(false);
    
    // Show success message if keys were cleaned
    if (cleanAnthropicKey !== apiKeyInput || cleanStockKey !== stockApiKeyInput) {
      console.log("✅ API keys cleaned (removed hidden characters)");
    }
  };

  // ============================================
  // SMS ALERT FUNCTION - Sends SMS via EmailJS (browser-side)
  // ============================================

  // Carrier email-to-SMS gateways
  const CARRIER_GATEWAYS = {
    'att': 'txt.att.net',
    'verizon': 'vtext.com',
    'tmobile': 'tmomail.net',
    'sprint': 'messaging.sprintpcs.com',
    'uscellular': 'email.uscc.net',
    'metropcs': 'mymetropcs.net',
    'cricket': 'sms.cricketwireless.net',
    'boost': 'sms.myboostmobile.com',
    'virgin': 'vmobl.com',
    'republic': 'text.republicwireless.com',
    'googlefi': 'msg.fi.google.com',
    'mint': 'tmomail.net',
    'visible': 'vtext.com',
  };

  const sendSmsAlert = async (message, alertType = 'price') => {
    if (!smsSettings.enabled || !smsSettings.phone || !smsSettings.carrier) {
      console.log("[SMS] SMS not configured or disabled");
      return false;
    }

    // Check if this alert type is enabled
    const typeMapping = {
      'price': 'priceAlerts',
      'entry': 'tradeSignals',
      'stop': 'tradeSignals',
      'target': 'tradeSignals',
      'signal': 'tradeSignals',
      'pick': 'dailyPick',
      'news': 'newsAlerts',
    };
    const alertCategory = typeMapping[alertType] || 'priceAlerts';
    if (!smsSettings.alertTypes[alertCategory]) {
      console.log(`[SMS] Alert type ${alertCategory} is disabled`);
      return false;
    }

    try {
      // EmailJS credentials (owner's account - upgrade to paid when scaling)
      const EMAILJS_SERVICE_ID = 'service_wka2oph';
      const EMAILJS_TEMPLATE_ID = 'template_1bn2e5y';
      const EMAILJS_PUBLIC_KEY = 'P3MjxM_aqWY9csXhF';

      // Build SMS email address
      const cleanPhone = smsSettings.phone.replace(/\D/g, '');
      const phoneNumber = cleanPhone.length === 11 ? cleanPhone.slice(1) : cleanPhone;
      const gateway = CARRIER_GATEWAYS[smsSettings.carrier.toLowerCase()];
      const smsEmail = `${phoneNumber}@${gateway}`;

      // Format message
      const alertEmojis = {
        'price': '📊',
        'entry': '🎯',
        'stop': '🛑',
        'target': '💰',
        'news': '📰',
      };
      const emoji = alertEmojis[alertType] || '🔔';
      const formattedMessage = `${emoji} MODUS Alert\n${message.slice(0, 140)}`;

      // Send via EmailJS (browser-side API)
      const response = await fetch('https://api.emailjs.com/api/v1.0/email/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          service_id: EMAILJS_SERVICE_ID,
          template_id: EMAILJS_TEMPLATE_ID,
          user_id: EMAILJS_PUBLIC_KEY,
          template_params: {
            to_email: smsEmail,
            subject: 'MODUS',
            message: formattedMessage,
          },
        }),
      });

      if (response.ok) {
        console.log(`[SMS] ✅ Alert sent to ${smsEmail}`);
        setSmsQuotaRemaining(prev => Math.max(0, prev - 1));
        return true;
      } else {
        const error = await response.text();
        console.error("[SMS] Failed to send:", error);
        return false;
      }
    } catch (error) {
      console.error("[SMS] Error sending alert:", error);
      return false;
    }

    // Also send via Discord webhook if configured (free, unlimited)
    try {
      const discordWebhookUrl = localStorage.getItem('modus_discord_webhook');
      if (discordWebhookUrl) {
        const emoji = alertType === 'price' ? '🔔' : alertType === 'news' ? '📰' : '📊';
        await fetch(discordWebhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            embeds: [{
              title: `${emoji} MODUS Alert`,
              description: message,
              color: 0x8B5CF6,
              timestamp: new Date().toISOString()
            }]
          })
        });
      }
    } catch (e) {
      // Discord webhook optional
    }
  };

  // Check SMS quota on mount
  useEffect(() => {
    const checkSmsQuota = async () => {
      try {
        const apiBase = backendUrl || (typeof window !== 'undefined' ? window.location.origin : '');
        const response = await fetch(`${apiBase}/api/alerts-batch`);
        if (response.ok) {
          const data = await response.json();
          setSmsQuotaRemaining(data.remaining || 100);
        }
      } catch (e) {
        // Backend not available, use default quota
      }
    };
    if (smsSettings.enabled) {
      checkSmsQuota();
    }
  }, [smsSettings.enabled, backendUrl]);

  // ============================================
  // API HELPER - Supports both Backend and Direct modes
  // ============================================
  const callAPI = async (messages, maxTokens = 1500) => {
    // If using backend API mode, route through Vercel serverless function
    if (useBackendApi) {
      const apiBase = backendUrl || (typeof window !== 'undefined' ? window.location.origin : '');

      // Extract image and prompt from messages
      const userMessage = messages.find(m => m.role === 'user');
      let imageData = null;
      let promptText = '';

      if (userMessage && Array.isArray(userMessage.content)) {
        for (const item of userMessage.content) {
          if (item.type === 'image' && item.source?.data) {
            const mediaType = item.source.media_type || 'image/png';
            imageData = `data:${mediaType};base64,${item.source.data}`;
          } else if (item.type === 'text') {
            promptText = item.text;
          }
        }
      } else if (userMessage && typeof userMessage.content === 'string') {
        promptText = userMessage.content;
      }

      // Use /api/chat for text-only, /api/analyze for images
      const endpoint = imageData ? '/api/analyze' : '/api/chat';
      const body = imageData
        ? { image: imageData, prompt: promptText, provider: 'anthropic', maxTokens }
        : { prompt: promptText, maxTokens };

      const response = await fetch(`${apiBase}${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: response.statusText }));
        throw new Error(errorData.error || `Backend API error: ${response.status}`);
      }

      const data = await response.json();
      // Format response to match Anthropic API structure
      return {
        content: [{ text: data.content }],
      };
    }

    // Direct API mode (original implementation)
    const headers = { "Content-Type": "application/json" };

    if (apiKey) {
      // Clean API key: remove whitespace, non-ASCII characters, and control characters
      const cleanKey = apiKey
        .trim()
        .replace(/[\u0000-\u001F\u007F-\uFFFF]/g, '') // Remove non-ASCII and control chars
        .replace(/\s+/g, ''); // Remove all whitespace

      if (!cleanKey) {
        throw new Error("API key is invalid after cleaning. Please check for hidden characters.");
      }

      headers["x-api-key"] = cleanKey;
      headers["anthropic-version"] = "2023-06-01";
      headers["anthropic-dangerous-direct-browser-access"] = "true";
    }

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers,
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: maxTokens,
        messages
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API error ${response.status}: ${errorText.slice(0, 300)}`);
    }
    return response.json();
  };

  const parseJSON = (text) => {
    // Remove markdown code blocks
    let cleaned = text.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
    
    // Find the first { and last } to extract just the JSON
    const firstBrace = cleaned.indexOf('{');
    const lastBrace = cleaned.lastIndexOf('}');
    
    if (firstBrace !== -1 && lastBrace !== -1) {
      cleaned = cleaned.substring(firstBrace, lastBrace + 1);
    }
    
    return JSON.parse(cleaned);
  };

  // Image upload handler
  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      setAnalysisError(null);
      setAnalysis(null);
      const reader = new FileReader();
      reader.onload = (ev) => {
        const dataUrl = ev.target.result;
        const base64Data = dataUrl.split(",")[1];
        
        // Create hash for caching
        const hash = base64Data.slice(0, 50) + base64Data.slice(-50);
        
        setImage(dataUrl);
        setImageData({ data: base64Data, mediaType: file.type });
        setImageHash(hash);
        
        // Check cache
        if (cachedAnalyses[hash]) {
          setAnalysis(cachedAnalyses[hash]);
          setAnalysisError(null);
        }
      };
      reader.readAsDataURL(file);
    }
  };


  // =================================================================
  // =================================================================
  // CACHE BUSTING HELPER FOR LIVE DATA
  // =================================================================
  
  const fetchWithNoCache = async (url, options = {}) => {
    const cacheBuster = `_t=${Date.now()}&_r=${Math.random().toString(36).substring(7)}`;
    const separator = url.includes('?') ? '&' : '?';
    const noCacheUrl = `${url}${separator}${cacheBuster}`;
    
    const noCacheHeaders = {
      'Cache-Control': 'no-cache, no-store, must-revalidate, max-age=0',
      'Pragma': 'no-cache',
      'Expires': '0',
      ...options.headers
    };
    
    return fetch(noCacheUrl, {
      ...options,
      headers: noCacheHeaders,
      cache: 'no-store'
    });
  };

  // =================================================================
  // =================================================================
  // NEW: MULTI-API TICKER FUNCTIONS (Finnhub + Yahoo Finance + Alpha Vantage)
  // =================================================================
  
  // IMPROVED: Fetch actual current quote with CORS proxy fallbacks
  const fetchCurrentQuote = async (symbol) => {
    console.log(`[Real-Time] Fetching current quote for ${symbol}...`);
    
    const yahooUrl1 = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1m&range=1d`;
    const yahooUrl2 = `https://query2.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1m&range=1d`;
    
    const proxyUrls = [
      yahooUrl1,
      yahooUrl2,
      `https://corsproxy.io/?${encodeURIComponent(yahooUrl1)}`,
      `https://corsproxy.io/?${encodeURIComponent(yahooUrl2)}`,
      `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl1)}`,
      `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(yahooUrl1)}`,
    ];
    
    for (let i = 0; i < proxyUrls.length; i++) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 6000);
        
        const response = await fetch(proxyUrls[i], {
          signal: controller.signal,
          headers: { 'Accept': 'application/json' }
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) continue;
        
        const data = await response.json();
        if (!data.chart?.result?.[0]) continue;
        
        const meta = data.chart.result[0].meta;
        const price = meta.regularMarketPrice || meta.previousClose;
        
        if (price && !isNaN(price)) {
          const previousClose = meta.chartPreviousClose || meta.previousClose || price;
          console.log(`[Real-Time] ✓ Got quote: ${symbol} = $${price.toFixed(2)}`);
          return {
            price,
            change: price - previousClose,
            changePercent: ((price - previousClose) / previousClose) * 100,
            marketState: meta.marketState || "REGULAR",
            time: meta.regularMarketTime,
            symbol
          };
        }
      } catch (e) {
        continue;
      }
    }
    
    throw new Error("Quote fetch failed");
  };
  
  // Helper function for Yahoo Finance with proxy fallbacks - RELIABLE VERSION
  // Uses parallel + sequential fallback strategy for maximum reliability
  const fetchYahooWithProxies = async (yahooUrl, timeout = 8000) => {
    const yahooUrl2 = yahooUrl.replace('query1', 'query2');

    // Extended list of CORS proxies - ordered by reliability
    const proxyConfigs = [
      // Primary proxies (most reliable)
      { url: `https://corsproxy.io/?${encodeURIComponent(yahooUrl)}`, name: 'corsproxy1' },
      { url: `https://corsproxy.io/?${encodeURIComponent(yahooUrl2)}`, name: 'corsproxy2' },
      // Secondary proxies
      { url: `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl)}`, name: 'allorigins' },
      { url: `https://proxy.cors.sh/${yahooUrl}`, name: 'corssh' },
      // Tertiary fallbacks
      { url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(yahooUrl)}`, name: 'codetabs' },
      { url: `https://corsproxy.org/?${encodeURIComponent(yahooUrl)}`, name: 'corsproxy-org' },
      { url: `https://thingproxy.freeboard.io/fetch/${yahooUrl}`, name: 'thingproxy' },
      // Last resort - different Yahoo endpoint
      { url: `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl2)}`, name: 'allorigins2' },
    ];

    const fetchOne = async (url, timeoutMs) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const response = await fetch(url, {
          signal: controller.signal,
          headers: { 'Accept': 'application/json' }
        });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const text = await response.text();
        // Handle both JSON and wrapped responses
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          // Some proxies wrap the response
          const match = text.match(/\{[\s\S]*\}/);
          if (match) data = JSON.parse(match[0]);
          else throw new Error('Invalid JSON');
        }
        if (!data.chart?.result?.[0]) throw new Error('No data');
        return data;
      } catch (e) {
        clearTimeout(timeoutId);
        throw e;
      }
    };

    // Try first 3 proxies in parallel (fast path)
    try {
      const fastProxies = proxyConfigs.slice(0, 3);
      const result = await Promise.any(
        fastProxies.map(p => fetchOne(p.url, timeout))
      );
      if (result) return result;
    } catch (e) {
      // Fast path failed, try remaining proxies
    }

    // Try next batch in parallel
    try {
      const midProxies = proxyConfigs.slice(3, 6);
      const result = await Promise.any(
        midProxies.map(p => fetchOne(p.url, timeout))
      );
      if (result) return result;
    } catch (e) {
      // Mid path failed
    }

    // Sequential fallback for remaining proxies
    for (let i = 6; i < proxyConfigs.length; i++) {
      try {
        const result = await fetchOne(proxyConfigs[i].url, timeout);
        if (result) return result;
      } catch (e) {
        continue;
      }
    }

    return null;
  };

  // ============================================
  // REAL-TIME NEWS FETCHING
  // Fetches current news from Yahoo Finance and Google News
  // ============================================

  // News cache to avoid repeated fetches (10 min TTL)
  const newsCache = useRef(new Map());
  const NEWS_CACHE_TTL = 10 * 60 * 1000; // 10 minutes

  const fetchRealTimeNews = async (symbol, limit = 10) => {
    console.log(`[News] 📰 Fetching real-time news for ${symbol}...`);

    // Check cache first
    const cacheKey = `news_${symbol}`;
    const cached = newsCache.current.get(cacheKey);
    if (cached && Date.now() - cached.timestamp < NEWS_CACHE_TTL) {
      console.log(`[News] ✓ Using cached news for ${symbol}`);
      return cached.data;
    }

    const allNews = [];

    // Try Yahoo Finance News API (most reliable for stock news)
    try {
      const yahooNewsUrl = `https://query1.finance.yahoo.com/v1/finance/search?q=${symbol}&newsCount=${limit}&quotesCount=0&enableFuzzyQuery=false&enableNavLinks=false`;

      const proxyUrls = [
        `https://corsproxy.io/?${encodeURIComponent(yahooNewsUrl)}`,
        `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooNewsUrl)}`,
      ];

      for (const proxyUrl of proxyUrls) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 8000);

          const response = await fetch(proxyUrl, {
            signal: controller.signal,
            headers: { 'Accept': 'application/json' }
          });
          clearTimeout(timeoutId);

          if (!response.ok) continue;

          const data = await response.json();

          if (data.news && data.news.length > 0) {
            const yahooNews = data.news.map(item => ({
              headline: item.title,
              summary: item.publisher,
              source: item.publisher || 'Yahoo Finance',
              url: item.link,
              timestamp: new Date(item.providerPublishTime * 1000),
              symbol: symbol,
              sentiment: analyzeSentimentFromHeadline(item.title),
              impact: 'medium',
              category: categorizeHeadline(item.title),
              isReal: true
            }));
            allNews.push(...yahooNews);
            console.log(`[News] ✓ Got ${yahooNews.length} Yahoo news items for ${symbol}`);
            break;
          }
        } catch (e) {
          continue;
        }
      }
    } catch (e) {
      console.log(`[News] Yahoo Finance news fetch failed for ${symbol}:`, e.message);
    }

    // Also try Google News RSS as backup
    if (allNews.length < 5) {
      try {
        const googleNewsUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(symbol + ' stock')}&hl=en-US&gl=US&ceid=US:en`;
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(googleNewsUrl)}`;

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);

        const response = await fetch(proxyUrl, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (response.ok) {
          const xmlText = await response.text();
          // Parse RSS XML
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
          const items = xmlDoc.querySelectorAll('item');

          items.forEach((item, idx) => {
            if (idx >= limit - allNews.length) return;

            const title = item.querySelector('title')?.textContent || '';
            const pubDate = item.querySelector('pubDate')?.textContent || '';
            const source = item.querySelector('source')?.textContent || 'Google News';
            const link = item.querySelector('link')?.textContent || '';

            // Avoid duplicates
            if (!allNews.find(n => n.headline === title)) {
              allNews.push({
                headline: title,
                source: source,
                url: link,
                timestamp: pubDate ? new Date(pubDate) : new Date(),
                symbol: symbol,
                sentiment: analyzeSentimentFromHeadline(title),
                impact: 'medium',
                category: categorizeHeadline(title),
                isReal: true
              });
            }
          });
          console.log(`[News] ✓ Added Google News items for ${symbol}`);
        }
      } catch (e) {
        console.log(`[News] Google News fetch failed for ${symbol}:`, e.message);
      }
    }

    // Cache the results
    if (allNews.length > 0) {
      newsCache.current.set(cacheKey, { data: allNews, timestamp: Date.now() });
    }

    return allNews;
  };

  // Helper: Analyze sentiment from headline text
  const analyzeSentimentFromHeadline = (headline) => {
    const text = headline.toLowerCase();

    const bullishWords = ['surge', 'soar', 'rally', 'jump', 'gain', 'rise', 'climb', 'beat', 'exceed',
      'record', 'high', 'strong', 'growth', 'profit', 'upgrade', 'buy', 'bullish', 'optimistic',
      'breakthrough', 'success', 'win', 'boost', 'positive', 'up', 'higher', 'best', 'outperform'];

    const bearishWords = ['fall', 'drop', 'plunge', 'sink', 'decline', 'crash', 'tumble', 'miss',
      'weak', 'loss', 'cut', 'downgrade', 'sell', 'bearish', 'concern', 'warning', 'risk',
      'fail', 'negative', 'down', 'lower', 'worst', 'underperform', 'layoff', 'lawsuit', 'investigation'];

    let bullishScore = 0;
    let bearishScore = 0;

    bullishWords.forEach(word => { if (text.includes(word)) bullishScore++; });
    bearishWords.forEach(word => { if (text.includes(word)) bearishScore++; });

    if (bullishScore > bearishScore + 1) return 'bullish';
    if (bearishScore > bullishScore + 1) return 'bearish';
    return 'neutral';
  };

  // Helper: Categorize headline
  const categorizeHeadline = (headline) => {
    const text = headline.toLowerCase();

    if (text.includes('earning') || text.includes('revenue') || text.includes('profit') || text.includes('quarter')) return 'Earnings';
    if (text.includes('fda') || text.includes('approval') || text.includes('regulation') || text.includes('sec') || text.includes('lawsuit')) return 'Regulatory';
    if (text.includes('product') || text.includes('launch') || text.includes('release') || text.includes('announce')) return 'Product';
    if (text.includes('upgrade') || text.includes('downgrade') || text.includes('target') || text.includes('analyst')) return 'Analyst';
    if (text.includes('merger') || text.includes('acquisition') || text.includes('deal') || text.includes('buyout')) return 'M&A';
    if (text.includes('ai') || text.includes('artificial intelligence') || text.includes('tech')) return 'AI/Tech';
    if (text.includes('dividend') || text.includes('buyback') || text.includes('split')) return 'Corporate Action';
    if (text.includes('ceo') || text.includes('executive') || text.includes('management')) return 'Leadership';
    return 'Market';
  };

  // Fetch catalysts with REAL-TIME news integration
  const fetchRealTimeCatalysts = async (symbol) => {
    console.log(`[Catalysts] 🔍 Fetching real-time catalysts for ${symbol}...`);

    const news = await fetchRealTimeNews(symbol, 8);

    const catalysts = {
      upcomingEvents: [],
      catalysts: [],
      risks: [],
      recentNews: news.slice(0, 5),
      seasonality: 'neutral',
      sectorTrend: 'Market conditions apply',
      lastUpdated: new Date().toISOString()
    };

    // Extract events and catalysts from news
    if (news.length > 0) {
      // Find bullish catalysts
      const bullishNews = news.filter(n => n.sentiment === 'bullish');
      catalysts.catalysts = bullishNews.slice(0, 3).map(n => n.headline.substring(0, 80));

      // Find risk factors (bearish news)
      const bearishNews = news.filter(n => n.sentiment === 'bearish');
      catalysts.risks = bearishNews.slice(0, 3).map(n => n.headline.substring(0, 80));

      // Determine overall sentiment
      const bullishCount = bullishNews.length;
      const bearishCount = bearishNews.length;

      if (bullishCount > bearishCount + 2) {
        catalysts.seasonality = 'bullish';
        catalysts.sectorTrend = 'Positive news sentiment';
      } else if (bearishCount > bullishCount + 2) {
        catalysts.seasonality = 'bearish';
        catalysts.sectorTrend = 'Negative news sentiment';
      } else {
        catalysts.seasonality = 'neutral';
        catalysts.sectorTrend = 'Mixed news sentiment';
      }

      // Extract upcoming events from headlines
      const eventKeywords = ['announce', 'report', 'launch', 'release', 'earnings', 'conference', 'meeting'];
      news.forEach(n => {
        const lowerHeadline = n.headline.toLowerCase();
        if (eventKeywords.some(k => lowerHeadline.includes(k)) && catalysts.upcomingEvents.length < 3) {
          catalysts.upcomingEvents.push(n.headline.substring(0, 60));
        }
      });
    }

    console.log(`[Catalysts] ✓ Found ${catalysts.catalysts.length} catalysts, ${catalysts.risks.length} risks for ${symbol}`);
    return catalysts;
  };

  // ============================================
  // FAST PARALLEL BATCH PROCESSOR v2.0
  // Processes stocks in parallel batches for 10-20x speedup
  // Now with SHORT-TERM CACHING for even faster repeated scans
  // ============================================

  // Stock data cache (5 minute TTL to reduce API load)
  const stockDataCache = useRef(new Map());
  const CACHE_TTL = 5 * 60 * 1000; // 5 minutes - reduces API calls significantly

  const getCachedStockData = (symbol) => {
    const cached = stockDataCache.current.get(symbol);
    if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
      return cached.data;
    }
    return null;
  };

  const setCachedStockData = (symbol, data) => {
    stockDataCache.current.set(symbol, { data, timestamp: Date.now() });
    // Clean old cache entries (keep only last 200)
    if (stockDataCache.current.size > 200) {
      const entries = [...stockDataCache.current.entries()];
      entries.sort((a, b) => a[1].timestamp - b[1].timestamp);
      entries.slice(0, 50).forEach(([key]) => stockDataCache.current.delete(key));
    }
  };

  const processStocksInParallel = async (symbols, processFn, options = {}) => {
    const {
      batchSize = 10,        // Reduced to 10 to avoid rate limiting
      maxResults = 10,       // Stop after finding enough good results
      minScore = 55,         // Minimum score to count as "good"
      timeout = 7000,        // 7s timeout per stock
      onProgress = null,     // Progress callback
      useCache = true,       // Use short-term cache
      batchDelay = 300       // Delay between batches to avoid rate limits
    } = options;

    const results = [];
    const totalBatches = Math.ceil(symbols.length / batchSize);
    let processedCount = 0;

    for (let i = 0; i < symbols.length; i += batchSize) {
      const batch = symbols.slice(i, i + batchSize);
      const batchNum = Math.floor(i / batchSize) + 1;

      // Add delay between batches (not before first batch)
      if (i > 0 && batchDelay > 0) {
        await new Promise(resolve => setTimeout(resolve, batchDelay));
      }

      if (onProgress) {
        onProgress({
          phase: 'scanning',
          current: processedCount,
          total: symbols.length,
          batch: batchNum,
          totalBatches,
          goodResults: results.length
        });
      }

      // Process entire batch in parallel
      const batchPromises = batch.map(async (symbol) => {
        try {
          // Check cache first
          if (useCache) {
            const cached = getCachedStockData(symbol);
            if (cached) {
              return cached;
            }
          }

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), timeout);

          const result = await processFn(symbol, controller.signal);
          clearTimeout(timeoutId);

          // Cache the result
          if (useCache && result) {
            setCachedStockData(symbol, result);
          }

          return result;
        } catch (e) {
          return null;
        }
      });

      const batchResults = await Promise.all(batchPromises);

      // Collect ALL valid results (don't filter by score here - let caller decide)
      batchResults.forEach(result => {
        if (result) {
          // Include all non-null results
          results.push(result);
        }
      });

      processedCount += batch.length;

      // Only stop early if maxResults is set AND we have actionable results
      const actionableCount = results.filter(r =>
        r.recommendation && !['HOLD', 'WAIT'].includes(r.recommendation)
      ).length;

      if (maxResults > 0 && actionableCount >= maxResults) {
        console.log(`[Parallel Processor] ✅ Found ${actionableCount} actionable results, stopping early at batch ${batchNum}/${totalBatches}`);
        break;
      }

      // Small delay between batches for API rate limiting
      if (i + batchSize < symbols.length) {
        await new Promise(r => setTimeout(r, 75));
      }
    }

    // Sort by score and return
    return results.sort((a, b) => (b.normalizedScore || b.score || 0) - (a.normalizedScore || a.score || 0));
  };

  // FAST: Single stock technical analysis (used by parallel processor)
  const analyzeStockFast = async (symbol, signal) => {
    const baseUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=5m&range=5d`;

    const data = await fetchYahooWithProxies(baseUrl, 5000);
    if (!data?.chart?.result?.[0]) return null;

    const chartData = data.chart.result[0];
    const quote = chartData.indicators?.quote?.[0];
    const meta = chartData.meta;

    if (!quote || chartData.timestamp?.length < 50) return null;

    // Extract valid bars
    const bars = [];
    for (let i = 0; i < chartData.timestamp.length; i++) {
      if (quote.close?.[i] && !isNaN(quote.close[i])) {
        bars.push({
          close: quote.close[i],
          high: quote.high?.[i] || quote.close[i],
          low: quote.low?.[i] || quote.close[i],
          volume: quote.volume?.[i] || 0
        });
      }
    }

    if (bars.length < 50) return null;

    const closes = bars.map(b => b.close);
    const currentPrice = meta.regularMarketPrice || closes[closes.length - 1];
    const prevClose = meta.chartPreviousClose || closes[0];
    const changePercent = ((currentPrice - prevClose) / prevClose) * 100;

    // Fast RSI calculation
    const calculateRSI = (data, period = 14) => {
      if (data.length < period + 1) return 50;
      let gains = 0, losses = 0;
      for (let i = data.length - period; i < data.length; i++) {
        const change = data[i] - data[i - 1];
        if (change > 0) gains += change;
        else losses -= change;
      }
      if (losses === 0) return 100;
      return 100 - (100 / (1 + (gains / losses)));
    };

    // Fast SMA
    const sma = (data, period) => {
      if (data.length < period) return data[data.length - 1];
      return data.slice(-period).reduce((a, b) => a + b, 0) / period;
    };

    const rsi = calculateRSI(closes);
    const sma20 = sma(closes, 20);
    const sma50 = sma(closes, 50);

    // Fast MACD
    const ema12 = closes.slice(-26).reduce((acc, val, i) => acc + val * Math.pow(2/13, 25-i), 0) / closes.slice(-26).reduce((acc, _, i) => acc + Math.pow(2/13, 25-i), 0);
    const ema26 = closes.slice(-26).reduce((acc, val, i) => acc + val * Math.pow(2/27, 25-i), 0) / closes.slice(-26).reduce((acc, _, i) => acc + Math.pow(2/27, 25-i), 0);
    const macdLine = ema12 - ema26;

    // Volume analysis
    const recentVol = bars.slice(-5).reduce((s, b) => s + b.volume, 0) / 5;
    const avgVol = bars.slice(-20).reduce((s, b) => s + b.volume, 0) / 20;
    const volumeRatio = avgVol > 0 ? recentVol / avgVol : 1;

    // ATR/Volatility calculation
    const atrPeriod = Math.min(14, bars.length - 1);
    const trueRanges = [];
    for (let i = bars.length - atrPeriod; i < bars.length; i++) {
      const high = bars[i].high;
      const low = bars[i].low;
      const prevClose = bars[i - 1]?.close || bars[i].close;
      const tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
      trueRanges.push(tr);
    }
    const atr = trueRanges.reduce((a, b) => a + b, 0) / trueRanges.length;
    const atrPercent = (atr / currentPrice) * 100;
    // 5-level volatility categorization
    const volatilityCategory =
      atrPercent >= 4.0 ? 'High' :
      atrPercent >= 2.5 ? 'Medium-High' :
      atrPercent >= 1.5 ? 'Medium' :
      atrPercent >= 0.8 ? 'Low-Medium' : 'Low';

    // Trend
    const trendSlope = (closes[closes.length - 1] - closes[closes.length - 20]) / closes[closes.length - 20] * 100;
    const trend = trendSlope > 1 ? 'UPTREND' : trendSlope < -1 ? 'DOWNTREND' : 'SIDEWAYS';

    // IMPROVED SCORING - More conservative, requires confirmation
    let bullish = 0, bearish = 0;
    const signals = [];
    let confirmations = 0; // Count confirming signals

    // === RSI ANALYSIS (stricter thresholds) ===
    if (rsi < 25) {
      bullish += 20;
      confirmations++;
      signals.push(`RSI deeply oversold (${rsi.toFixed(0)}) - Strong buy signal`);
    } else if (rsi < 35) {
      bullish += 12;
      signals.push(`RSI oversold zone (${rsi.toFixed(0)})`);
    } else if (rsi > 75) {
      bearish += 20;
      confirmations++;
      signals.push(`RSI deeply overbought (${rsi.toFixed(0)}) - Strong sell signal`);
    } else if (rsi > 65) {
      bearish += 12;
      signals.push(`RSI overbought zone (${rsi.toFixed(0)})`);
    } else if (rsi >= 45 && rsi <= 55) {
      signals.push(`RSI neutral (${rsi.toFixed(0)})`);
    }

    // === MACD ANALYSIS (with momentum check) ===
    const macdStrength = Math.abs(macdLine / currentPrice) * 10000; // Normalize MACD
    if (macdLine > 0 && macdStrength > 0.5) {
      bullish += 15;
      if (macdStrength > 1.5) confirmations++;
      signals.push(`MACD bullish (strength: ${macdStrength.toFixed(1)})`);
    } else if (macdLine < 0 && macdStrength > 0.5) {
      bearish += 15;
      if (macdStrength > 1.5) confirmations++;
      signals.push(`MACD bearish (strength: ${macdStrength.toFixed(1)})`);
    } else {
      signals.push('MACD neutral/weak');
    }

    // === MOVING AVERAGE ANALYSIS ===
    const priceSma20Pct = ((currentPrice - sma20) / sma20) * 100;
    const priceSma50Pct = ((currentPrice - sma50) / sma50) * 100;

    if (priceSma20Pct > 2) {
      bullish += 10;
      signals.push(`Above SMA20 by ${priceSma20Pct.toFixed(1)}%`);
    } else if (priceSma20Pct < -2) {
      bearish += 10;
      signals.push(`Below SMA20 by ${Math.abs(priceSma20Pct).toFixed(1)}%`);
    }

    if (priceSma50Pct > 3) {
      bullish += 12;
      confirmations++;
      signals.push(`Above SMA50 by ${priceSma50Pct.toFixed(1)}%`);
    } else if (priceSma50Pct < -3) {
      bearish += 12;
      confirmations++;
      signals.push(`Below SMA50 by ${Math.abs(priceSma50Pct).toFixed(1)}%`);
    }

    // === TREND ANALYSIS (stricter) ===
    if (trend === 'UPTREND' && trendSlope > 2) {
      bullish += 15;
      confirmations++;
      signals.push(`Strong uptrend (+${trendSlope.toFixed(1)}%)`);
    } else if (trend === 'UPTREND') {
      bullish += 8;
      signals.push('Mild uptrend');
    } else if (trend === 'DOWNTREND' && trendSlope < -2) {
      bearish += 15;
      confirmations++;
      signals.push(`Strong downtrend (${trendSlope.toFixed(1)}%)`);
    } else if (trend === 'DOWNTREND') {
      bearish += 8;
      signals.push('Mild downtrend');
    } else {
      signals.push('Sideways/consolidating');
    }

    // === VOLUME CONFIRMATION (must align with price direction) ===
    if (volumeRatio > 1.8) {
      if (changePercent > 1) {
        bullish += 12;
        confirmations++;
        signals.push(`High volume rally (${volumeRatio.toFixed(1)}x avg)`);
      } else if (changePercent < -1) {
        bearish += 12;
        confirmations++;
        signals.push(`High volume selloff (${volumeRatio.toFixed(1)}x avg)`);
      } else {
        signals.push(`High volume but neutral price action`);
      }
    } else if (volumeRatio < 0.5) {
      signals.push('Low volume - weak conviction');
    }

    // === MOMENTUM CHECK (recent price action) ===
    const recentChange = ((closes[closes.length - 1] - closes[closes.length - 5]) / closes[closes.length - 5]) * 100;
    if (recentChange > 1.5) {
      bullish += 8;
      signals.push(`Recent momentum bullish (+${recentChange.toFixed(1)}%)`);
    } else if (recentChange < -1.5) {
      bearish += 8;
      signals.push(`Recent momentum bearish (${recentChange.toFixed(1)}%)`);
    }

    // === CALCULATE FINAL SCORES ===
    const direction = bullish > bearish ? 'LONG' : 'SHORT';
    const netScore = Math.abs(bullish - bearish);

    // Require minimum confirmations for strong recommendations
    const hasStrongSignal = confirmations >= 2;
    const hasModerateSignal = confirmations >= 1 && netScore >= 15;

    // Normalized score (0-100 scale)
    const normalizedScore = Math.min(100, Math.max(0, 50 + (direction === 'LONG' ? netScore : -netScore) * 0.8));

    // Get catalysts (reduced impact)
    const catalystData = getStockCatalysts(symbol);
    let catalystBonus = 0;
    if (catalystData.seasonality === 'bullish' && direction === 'LONG') catalystBonus += 3;
    if (catalystData.earnings) catalystBonus += 2;

    const finalScore = Math.min(100, normalizedScore + catalystBonus);

    // === STRICTER RECOMMENDATION LOGIC ===
    // Requires both score threshold AND confirmations
    let recommendation;
    if (hasStrongSignal && netScore >= 30) {
      recommendation = direction === 'LONG' ? 'STRONG_BUY' : 'STRONG_SELL';
    } else if (hasModerateSignal && netScore >= 20) {
      recommendation = direction === 'LONG' ? 'BUY' : 'SELL';
    } else if (netScore >= 12) {
      recommendation = direction === 'LONG' ? 'LEAN_BUY' : 'LEAN_SELL';
    } else {
      recommendation = 'HOLD';
    }

    // Calculate confidence based on confirmations and net score
    // Confidence = base (40) + confirmations bonus (up to 30) + score bonus (up to 25)
    const confidenceFromConfirmations = Math.min(30, confirmations * 10);
    const confidenceFromScore = Math.min(25, netScore * 0.5);
    const confidence = Math.min(95, 40 + confidenceFromConfirmations + confidenceFromScore);

    // Return ALL results - let the caller filter if needed
    return {
      symbol,
      currentPrice,
      changePercent,
      rsi,
      macdHistogram: macdLine,
      trend,
      trendSlope,
      volumeRatio,
      aboveSMA20: currentPrice > sma20,
      aboveSMA50: currentPrice > sma50,
      priceSma20Pct: ((currentPrice - sma20) / sma20) * 100,
      priceSma50Pct: ((currentPrice - sma50) / sma50) * 100,
      bullishScore: bullish,
      bearishScore: bearish,
      direction,
      netScore,
      confirmations,
      normalizedScore: finalScore,
      recommendation,
      signals,
      confidence: Math.round(confidence),
      catalysts: catalystData.catalysts || [],
      risks: catalystData.risks || [],
      upcomingEvents: catalystData.upcomingEvents || [],
      earnings: catalystData.earnings,
      sectorTrend: catalystData.sectorTrend,
      catalystBonus,
      // Volatility data
      atrPercent,
      volatilityCategory
    };
  };

  // PRIORITY_STOCKS is now imported from ./constants/stockData.js

  const fetchTickerData = async () => {
    if (!tickerSymbol) return;

    setLoadingTicker(true);
    setTickerError(null);

    // Store previous price for comparison
    const oldPrice = tickerData?.currentPrice;
    
    try {
      // Try multiple APIs in order of preference
      let data = null;
      let source = null;
      
      // OPTION 0: Demo Mode (if enabled)
      if (useDemoMode) {
        console.log("🎮 Demo Mode enabled - using sample data...");
        data = getDemoData(tickerSymbol);
        source = "Demo Mode";
        console.log("✅ Demo data loaded successfully!");
        
        setTickerData({
          ...data,
          source,
          lastUpdate: new Date(),
          isLive: true,  // Demo mode is always "live"
          lastRealUpdate: Date.now()
        });
        setLoadingTicker(false);
        return;
      }
      
      // OPTION 1: Try Yahoo Finance FIRST (free, no key needed, includes charts)
      console.log("Trying Yahoo Finance API...");
      try {
        data = await fetchFromYahooFinance(tickerSymbol);
        source = "Yahoo Finance";
        console.log("✅ Yahoo Finance data loaded successfully!");
        console.log(`   - Got ${data.timeSeries?.length || 0} chart bars`);
      } catch (err) {
        console.log("Yahoo Finance failed:", err.message);
      }
      
      // OPTION 2: Try Finnhub (only if Yahoo failed, requires key)
      if (!data && stockApiKey && stockApiKey !== 'demo') {
        console.log("Trying Finnhub API...");
        try {
          const finnhubData = await fetchFromFinnhub(tickerSymbol, stockApiKey);
          // Only use Finnhub if it has chart data
          if (finnhubData.timeSeries && finnhubData.timeSeries.length > 0) {
            data = finnhubData;
            source = "Finnhub";
            console.log("✅ Finnhub data loaded successfully!");
            console.log(`   - Got ${data.timeSeries.length} chart bars`);
          } else {
            console.log("⚠️  Finnhub has no chart data (free tier limitation)");
            // If we don't have Yahoo data yet, this is a problem
            if (!data) {
              throw new Error("Finnhub returned no chart data (upgrade to paid tier or use Yahoo Finance)");
            }
          }
        } catch (err) {
          console.log("Finnhub failed:", err.message);
        }
      }
      
      // OPTION 3: Try Alpha Vantage GLOBAL_QUOTE (current price only, free tier)
      if (!data && stockApiKey) {
        console.log("Trying Alpha Vantage Global Quote...");
        try {
          data = await fetchFromAlphaVantage(tickerSymbol, stockApiKey);
          source = "Alpha Vantage";
          console.log("✅ Alpha Vantage data loaded successfully!");
        } catch (err) {
          console.log("Alpha Vantage failed:", err.message);
        }
      }
      
      if (!data) {
        // All APIs failed - Auto-enable Demo Mode silently
        console.warn("⚠️ ALL APIS FAILED - Auto-enabling Demo Mode...");
        setLoadingTicker(false);

        // Auto-fallback to demo mode without intrusive popup
        if (!useDemoMode) {
          console.log("🎮 Auto-enabling Demo Mode for seamless experience...");
          setUseDemoMode(true);
          // Retry with demo mode
          setTimeout(() => fetchTickerData(), 100);
          return;
        }

        // Even demo mode failed - show minimal error
        throw new Error("Unable to load data. Please try again.");
      }
      
      const newPrice = data.currentPrice;

      // Calculate price change if we have a previous price (auto-refresh)
      if (oldPrice && newPrice && Math.abs(newPrice - oldPrice) > 0.001) {
        const changeAmount = newPrice - oldPrice;
        const changePercent = ((changeAmount / oldPrice) * 100);
        const direction = changeAmount > 0 ? 'up' : 'down';

        setPriceChange({
          amount: changeAmount,
          percent: changePercent,
          direction
        });
        setPriceFlash(direction);
        setTimeout(() => setPriceFlash(null), 800);

        console.log(`[Chart Refresh] Price ${direction}: $${oldPrice.toFixed(2)} → $${newPrice.toFixed(2)} (${changeAmount >= 0 ? '+' : ''}${changeAmount.toFixed(2)})`);
      }

      // Store previous price for next comparison
      if (oldPrice) {
        setPreviousPrice(oldPrice);
      }

      // Full chart load — used for initial load and manual refresh only
      setTickerData({
        ...data,
        source,
        lastUpdate: new Date(),
        isLive: true,
        lastRealUpdate: Date.now()
      });
      setLastPriceUpdate(Date.now());

    } catch (err) {
      console.error("Ticker fetch error:", err);
      setTickerError(err.message);
    } finally {
      setLoadingTicker(false);
      setIsRefreshing(false);
      setTickerLastRefresh(new Date());
      lastRefreshTimeRef.current = Date.now(); // Update ref for accurate countdown
    }
  };

  // Keep loading ref in sync with state for auto-refresh
  useEffect(() => {
    tickerLoadingRef.current = loadingTicker;
  }, [loadingTicker]);

  // Auto-refresh: fetch full chart but smart-merge — historical candles stay, only tail updates
  useEffect(() => {
    if (!tickerAutoRefresh || !tickerSymbol || activeTab !== "ticker") return;

    console.log(`[Ticker Auto-Refresh] ✅ Smart refresh every ${tickerRefreshInterval}s for ${tickerSymbol}`);

    const interval = setInterval(async () => {
      if (tickerLoadingRef.current) return;
      try {
        setIsRefreshing(true);

        // Fetch fresh chart data from Yahoo (same as manual but we merge smartly)
        const freshData = await tryYahooFetch(
          tickerSymbol,
          tickerTimeframeRef.current || tickerTimeframe || '1d',
          // Use a short range for intraday, longer for daily+
          (['1m','2m','5m','15m','30m'].includes(tickerTimeframeRef.current || tickerTimeframe) ? '1d' : '1y')
        );

        if (!freshData || !freshData.timeSeries || freshData.timeSeries.length === 0) return;

        const freshPrice = freshData.meta?.regularMarketPrice || freshData.timeSeries[freshData.timeSeries.length - 1]?.close;

        setTickerData(prev => {
          if (!prev || !prev.timeSeries || prev.timeSeries.length === 0) return prev;

          // Reject suspicious price jumps (>10%)
          if (freshPrice && Math.abs(freshPrice - prev.currentPrice) / prev.currentPrice > 0.10) {
            console.log(`[Auto-Refresh] ⚠️ Rejected suspicious price change`);
            return { ...prev, lastUpdate: new Date(), lastRealUpdate: Date.now(), isLive: true };
          }

          const existingCandles = prev.timeSeries;
          const newCandles = freshData.timeSeries;

          // Build a time-keyed map of new candles for fast lookup
          const newCandleMap = new Map();
          for (const c of newCandles) {
            newCandleMap.set(c.time, c);
          }

          // Smart merge strategy:
          // - Keep ALL existing candles as-is (preserves chart shape)
          // - EXCEPT the last 3 candles which may still be forming — update those from fresh data
          // - Append any genuinely new candles that come after our last existing one
          const updateCount = Math.min(3, existingCandles.length);
          const stableCandles = existingCandles.slice(0, existingCandles.length - updateCount);
          const tailCandles = existingCandles.slice(existingCandles.length - updateCount);

          // Update tail candles with fresh data if available (matching by time)
          const updatedTail = tailCandles.map(existing => {
            const fresh = newCandleMap.get(existing.time);
            if (fresh) {
              return { ...fresh }; // Use fresh OHLCV (proper candle shape + volume)
            }
            return { ...existing }; // Keep existing if no match
          });

          // Find genuinely new candles (times that don't exist in our data)
          const existingTimes = new Set(existingCandles.map(c => c.time));
          const lastExistingTime = new Date(existingCandles[existingCandles.length - 1].time).getTime();
          const brandNewCandles = newCandles.filter(c =>
            !existingTimes.has(c.time) && new Date(c.time).getTime() > lastExistingTime
          );

          // Combine: stable history + updated tail + new candles
          let merged = [...stableCandles, ...updatedTail, ...brandNewCandles];

          // Keep candle count stable by trimming from the front
          const maxCandles = existingCandles.length;
          if (merged.length > maxCandles) {
            merged = merged.slice(merged.length - maxCandles);
          }

          if (brandNewCandles.length > 0) {
            console.log(`[Auto-Refresh] 📊 Added ${brandNewCandles.length} new candle(s), updated ${updateCount} tail candles`);
          }

          // Update price from fresh data
          const validPrice = freshPrice || prev.currentPrice;

          return {
            ...prev,
            currentPrice: validPrice,
            change: validPrice - prev.open,
            changePercent: ((validPrice - prev.open) / prev.open) * 100,
            volume: freshData.meta?.regularMarketVolume || prev.volume,
            high: Math.max(prev.high || validPrice, validPrice),
            low: Math.min(prev.low || validPrice, validPrice),
            timeSeries: merged,
            lastUpdate: new Date(),
            isLive: true,
            lastRealUpdate: Date.now()
          };
        });

        // Price flash
        if (freshPrice) {
          setPriceFlash(freshPrice > (tickerData?.currentPrice || 0) ? 'up' : 'down');
          setLastPriceUpdate(Date.now());
          setTimeout(() => setPriceFlash(null), 500);
        }
      } catch (err) {
        // Silent fail — don't disrupt the chart
        console.log('[Auto-Refresh] Failed:', err.message);
      } finally {
        setIsRefreshing(false);
        setTickerLastRefresh(new Date());
        lastRefreshTimeRef.current = Date.now();
      }
    }, tickerRefreshInterval * 1000);

    return () => clearInterval(interval);
  }, [tickerAutoRefresh, tickerSymbol, tickerRefreshInterval, activeTab]);

  // Countdown timer for next refresh - ACCURATE version using elapsed time
  useEffect(() => {
    if (!tickerAutoRefresh || !tickerSymbol || activeTab !== "ticker") {
      setNextRefreshIn(null);
      return;
    }

    // Calculate countdown based on actual elapsed time since last refresh
    const updateCountdown = () => {
      const elapsed = Math.floor((Date.now() - lastRefreshTimeRef.current) / 1000);
      const remaining = Math.max(0, tickerRefreshInterval - elapsed);
      setNextRefreshIn(remaining);
    };

    // Update immediately, then every 500ms for smoother countdown
    updateCountdown();
    const countdownInterval = setInterval(updateCountdown, 500);

    return () => clearInterval(countdownInterval);
  }, [tickerAutoRefresh, tickerSymbol, tickerRefreshInterval, activeTab]);

  // Finnhub API (real-time, free tier: 60 calls/min)
  const fetchFromFinnhub = async (symbol, apiKey) => {
    const quoteUrl = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`;
    const response = await fetch(quoteUrl);
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    if (!data.c || data.c === 0) {
      throw new Error("No data for this symbol");
    }
    
    // Get candle data for chart (last 24 hours)
    const now = Math.floor(Date.now() / 1000);
    const yesterday = now - 86400;
    const candleUrl = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=5&from=${yesterday}&to=${now}&token=${apiKey}`;
    const candleResponse = await fetch(candleUrl);
    const candleData = await candleResponse.json();
    
    const timeSeries = [];
    if (candleData.t && candleData.t.length > 0) {
      for (let i = 0; i < candleData.t.length; i++) {
        timeSeries.push({
          time: new Date(candleData.t[i] * 1000).toISOString(),
          open: candleData.o[i],
          high: candleData.h[i],
          low: candleData.l[i],
          close: candleData.c[i],
          volume: candleData.v[i]
        });
      }
    }
    
    return {
      symbol: symbol,
      currentPrice: data.c,
      open: data.o,
      high: data.h,
      low: data.l,
      change: data.d,
      changePercent: data.dp,
      volume: 0,
      timeSeries: timeSeries.slice(-100)
    };
  };

  // Yahoo Finance API (no key needed, unofficial but reliable)
  // FAST Helper function - uses parallel requests with short timeouts
  const tryYahooFetch = async (symbol, interval, range) => {
    const yahooUrl1 = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${range}`;
    const yahooUrl2 = `https://query2.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${range}`;

    // Optimized proxy list - only the fastest/most reliable ones
    const proxyUrls = [
      yahooUrl1,
      yahooUrl2,
      `https://corsproxy.io/?${encodeURIComponent(yahooUrl1)}`,
      `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl1)}`,
    ];

    // FAST: Try all proxies in PARALLEL with Promise.any - 2s timeout for speed
    const fetchWithTimeout = async (url, timeout = 2000) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);

      try {
        const response = await fetch(url, {
          method: 'GET',
          signal: controller.signal,
          headers: { 'Accept': 'application/json' }
        });
        clearTimeout(timeoutId);

        if (!response.ok) throw new Error('Not OK');

        const data = await response.json();
        if (!data.chart?.result?.[0]) throw new Error('No data');

        const result = data.chart.result[0];
        const quote = result.indicators?.quote?.[0];
        const timestamps = result.timestamp;

        if (!timestamps || timestamps.length === 0) throw new Error('No timestamps');

        // Build raw time series first
        const rawSeries = [];
        for (let j = 0; j < timestamps.length; j++) {
          if (quote.close?.[j] != null && !isNaN(quote.close[j]) && quote.close[j] > 0) {
            rawSeries.push({
              time: new Date(timestamps[j] * 1000).toLocaleString(),
              open: quote.open?.[j] || quote.close[j],
              high: quote.high?.[j] || quote.close[j],
              low: quote.low?.[j] || quote.close[j],
              close: quote.close[j],
              volume: quote.volume?.[j] || 0
            });
          }
        }

        if (rawSeries.length === 0) throw new Error('No series data');

        // DATA VALIDATION: Filter out erroneous price spikes
        // Calculate median price to detect outliers
        const allCloses = rawSeries.map(b => b.close).sort((a, b) => a - b);
        const medianPrice = allCloses[Math.floor(allCloses.length / 2)];
        const maxDeviation = 0.25; // Allow max 25% deviation from median

        const timeSeries = rawSeries.filter(bar => {
          const deviation = Math.abs(bar.close - medianPrice) / medianPrice;
          const highDeviation = Math.abs(bar.high - medianPrice) / medianPrice;
          const lowDeviation = Math.abs(bar.low - medianPrice) / medianPrice;

          // Filter out bars with extreme deviations (likely bad data)
          if (deviation > maxDeviation || highDeviation > maxDeviation * 1.5) {
            console.log(`[Data Validation] Filtered outlier: close=${bar.close}, median=${medianPrice}, dev=${(deviation*100).toFixed(1)}%`);
            return false;
          }
          return true;
        });

        // Ensure we didn't filter everything
        if (timeSeries.length < rawSeries.length * 0.5) {
          console.log('[Data Validation] Too many outliers, using raw data');
          return { result, meta: result.meta, timeSeries: rawSeries, quote };
        }

        return { result, meta: result.meta, timeSeries, quote };
      } catch (e) {
        clearTimeout(timeoutId);
        throw e;
      }
    };

    // Race all proxies - first successful one wins!
    // WITH AUTOMATIC RETRY (up to 2 attempts)
    const maxRetries = 2;
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const result = await Promise.any(proxyUrls.map(url => fetchWithTimeout(url, 2500)));
        if (result) {
          if (attempt > 1) console.log(`[Yahoo Finance] ✓ Succeeded on retry attempt ${attempt}`);
          return result;
        }
      } catch (e) {
        if (attempt < maxRetries) {
          console.log(`[Yahoo Finance] Attempt ${attempt} failed, retrying in 500ms...`);
          await new Promise(resolve => setTimeout(resolve, 500)); // Brief pause before retry
        }
      }
    }
    // All retries failed - return null
    console.log(`[Yahoo Finance] All ${maxRetries} attempts failed`);
    return null;
  };

  // ============================================================
  // CHART COMPARISON OVERLAY - Fetch second stock for comparison
  // ============================================================
  const fetchComparisonData = useCallback(async (symbol) => {
    if (!symbol || symbol.trim() === '') {
      setComparisonData(null);
      setShowComparison(false);
      return;
    }
    const sym = symbol.trim().toUpperCase();
    setLoadingComparison(true);
    try {
      const result = await tryYahooFetch(sym, tickerTimeframeRef.current || tickerTimeframe || '1d', '1y');
      if (result && result.timeSeries && result.timeSeries.length > 0) {
        setComparisonData({
          symbol: sym,
          timeSeries: result.timeSeries,
          currentPrice: result.timeSeries[result.timeSeries.length - 1]?.close || 0
        });
        setShowComparison(true);
        console.log(`[Comparison] ✅ Loaded ${result.timeSeries.length} bars for ${sym}`);
      } else {
        showToast(`Could not load data for ${sym}`, 'error');
        setComparisonData(null);
        setShowComparison(false);
      }
    } catch (err) {
      console.error('[Comparison] Failed:', err);
      showToast(`Failed to load ${sym}: ${err.message}`, 'error');
      setComparisonData(null);
      setShowComparison(false);
    } finally {
      setLoadingComparison(false);
    }
  }, [tickerTimeframe]);

  const fetchFromYahooFinance = async (symbol) => {
    console.log(`[Yahoo Finance] Fetching data for ${symbol}...`);

    // SMART FALLBACK SYSTEM:
    // Small timeframes (1m-30m) often fail outside market hours
    // We'll try the requested timeframe first, then automatically fall back to larger ones

    const intervalConfigs = {
      '1m':  { ranges: ['7d', '5d', '2d', '1d'] },
      '2m':  { ranges: ['7d', '5d', '1d'] },
      '5m':  { ranges: ['60d', '5d', '1mo'] },
      '15m': { ranges: ['60d', '1mo', '5d'] },
      '30m': { ranges: ['60d', '1mo'] },
      '60m': { ranges: ['2y', '1y', '6mo', '3mo'] },
      '90m': { ranges: ['60d', '1mo'] },
      '1h':  { ranges: ['2y', '1y', '6mo', '3mo'] },
      '1d':  { ranges: ['10y', '5y', '1y', '6mo'] },
      '5d':  { ranges: ['10y', '5y', '2y'] },
      '1wk': { ranges: ['10y', '5y'] },
      '1mo': { ranges: ['max', '10y'] }
    };

    // Fallback chain: requested -> 1h -> 1d (most reliable)
    const smallTimeframes = ['1m', '2m', '5m', '15m', '30m', '60m', '90m'];
    // Use REF to get current timeframe (avoids stale closure issues in auto-refresh)
    const requestedInterval = tickerTimeframeRef.current || tickerTimeframe;
    console.log(`[Yahoo Finance] Using timeframe from ref: ${requestedInterval}`);

    // Build list of intervals to try (requested first, then fallbacks)
    let intervalsToTry = [requestedInterval];
    if (smallTimeframes.includes(requestedInterval)) {
      // Add fallbacks for small timeframes
      if (!intervalsToTry.includes('1h')) intervalsToTry.push('1h');
      if (!intervalsToTry.includes('1d')) intervalsToTry.push('1d');
    }

    let usedFallback = false;
    let actualInterval = requestedInterval;

    for (const interval of intervalsToTry) {
      const config = intervalConfigs[interval] || intervalConfigs['1h'];

      for (const range of config.ranges) {
        console.log(`[Yahoo Finance] Trying ${interval} interval with ${range} range...`);

        const fetchResult = await tryYahooFetch(symbol, interval, range);

        if (fetchResult) {
          const { meta, timeSeries } = fetchResult;

          console.log(`[Yahoo Finance] ✓ SUCCESS! Got ${timeSeries.length} bars with ${interval}/${range}`);

          if (interval !== requestedInterval) {
            usedFallback = true;
            actualInterval = interval;
            console.log(`[Yahoo Finance] ⚠️ Used fallback: ${requestedInterval} → ${interval}`);
          }

          // PRICE VALIDATION: Use chart data as source of truth
          const lastCandle = timeSeries[timeSeries.length - 1];
          const chartMedian = timeSeries.map(b => b.close).sort((a,b) => a-b)[Math.floor(timeSeries.length/2)];

          // Validate meta price against chart data (must be within 20% of chart median)
          let currentPrice = meta.regularMarketPrice || meta.previousClose || lastCandle.close;
          const priceDeviation = Math.abs(currentPrice - chartMedian) / chartMedian;

          if (priceDeviation > 0.20) {
            console.log(`[Price Validation] Meta price $${currentPrice} deviates ${(priceDeviation*100).toFixed(1)}% from chart median $${chartMedian}, using last candle`);
            currentPrice = lastCandle.close;
          }

          // Validate previousClose similarly
          let previousClose = meta.chartPreviousClose || meta.previousClose || timeSeries[0].open;
          const prevDeviation = Math.abs(previousClose - chartMedian) / chartMedian;
          if (prevDeviation > 0.25) {
            console.log(`[Price Validation] Previous close $${previousClose} invalid, using first candle open`);
            previousClose = timeSeries[0].open;
          }

          // Validate high/low against chart data
          const chartHigh = Math.max(...timeSeries.map(b => b.high));
          const chartLow = Math.min(...timeSeries.map(b => b.low));
          let dayHigh = meta.regularMarketDayHigh || currentPrice;
          let dayLow = meta.regularMarketDayLow || currentPrice;

          // If meta high/low are unreasonable, use chart data
          if (dayHigh > chartMedian * 1.25 || dayHigh < chartLow) dayHigh = chartHigh;
          if (dayLow < chartMedian * 0.75 || dayLow > chartHigh) dayLow = chartLow;

          return {
            symbol,
            currentPrice,
            open: previousClose,
            high: dayHigh,
            low: dayLow,
            change: currentPrice - previousClose,
            changePercent: ((currentPrice - previousClose) / previousClose) * 100,
            volume: meta.regularMarketVolume || 0,
            timeSeries: timeSeries.slice(-tickerCandleCount),
            timeframe: actualInterval,  // Actual timeframe used
            requestedTimeframe: requestedInterval,  // What user asked for
            usedFallback: usedFallback,
            fallbackMessage: usedFallback ? `${requestedInterval} data unavailable - automatically showing ${actualInterval} data instead` : null,
            actualRange: range
          };
        }
      }

      console.log(`[Yahoo Finance] ${interval} failed, trying next fallback...`);
    }

    // All intervals and ranges exhausted - this shouldn't happen often since 1d is very reliable
    throw new Error(`Unable to load chart data for ${symbol}.\n\nAll timeframes failed. This is unusual - please check:\n• Your internet connection\n• Try again in a few seconds\n• Enable Demo Mode as a workaround`);
  };
  
  const fetchFromAlphaVantage = async (symbol, apiKey) => {
    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKey}`;
    
    const response = await fetch(url);
    const data = await response.json();
    
    if (data["Error Message"]) {
      throw new Error("Invalid symbol");
    }
    
    if (data["Note"]) {
      throw new Error("API rate limit");
    }
    
    if (data["Information"]) {
      throw new Error("Premium endpoint");
    }
    
    const quote = data["Global Quote"];
    if (!quote || !quote["05. price"]) {
      throw new Error("No data available");
    }
    
    const currentPrice = parseFloat(quote["05. price"]);
    const previousClose = parseFloat(quote["08. previous close"]);
    
    return {
      symbol: symbol,
      currentPrice: currentPrice,
      open: parseFloat(quote["02. open"]),
      high: parseFloat(quote["03. high"]),
      low: parseFloat(quote["04. low"]),
      change: parseFloat(quote["09. change"]),
      changePercent: parseFloat(quote["10. change percent"].replace("%", "")),
      volume: parseInt(quote["06. volume"]),
      timeSeries: [] // No historical data in free tier
    };
  };
  const captureTickerChart = async () => {
    if (!tickerChartRef.current) return;
    
    try {
      const html2canvas = (await import('html2canvas')).default;
      const canvas = await html2canvas(tickerChartRef.current);
      const dataUrl = canvas.toDataURL();
      const base64Data = dataUrl.split(',')[1];
      
      setImage(dataUrl);
      setImageData({ data: base64Data, mediaType: 'image/png' });
      setActiveTab("analyze");
      
      setTimeout(() => analyzeChart(), 500);
    } catch (err) {
      console.error("Capture error:", err);
      showToast("Screenshot failed. You can manually screenshot and upload instead.", "error");
    }
  };

  // =================================================================
  // NEW: ALERT FUNCTIONS
  // =================================================================
  
  const createAlert = () => {
    if (!newAlert.symbol || !newAlert.price) return;
    
    const alert = {
      id: Date.now(),
      ...newAlert,
      createdAt: new Date()
    };
    
    setAlerts([...alerts, alert]);
    setNewAlert({
      symbol: "",
      condition: "above",
      price: "",
      message: "",
      enabled: true
    });
    setShowCreateAlert(false);
  };

  const deleteAlert = (id) => {
    setAlerts(alerts.filter(a => a.id !== id));
  };

  const toggleAlert = (id) => {
    setAlerts(alerts.map(a => 
      a.id === id ? { ...a, enabled: !a.enabled, triggered: !a.enabled ? false : a.triggered } : a
    ));
    // Reset ring count AND last state when re-enabling an alert
    setAlertRingCounts(prev => {
      const newCounts = { ...prev };
      delete newCounts[id];
      return newCounts;
    });
    // Also clear the last triggered state so it can trigger fresh
    if (alertLastStateRef.current[id] !== undefined) {
      delete alertLastStateRef.current[id];
    }
    if (alertRingCountsRef.current[id] !== undefined) {
      delete alertRingCountsRef.current[id];
    }
  };

  const triggerAlert = (alert) => {
    const recentTrigger = triggeredAlerts.find(
      t => t.id === alert.id && Date.now() - t.time < 300000
    );

    if (recentTrigger) return;

    if ("Notification" in window && Notification.permission === "granted") {
      new Notification(`MODUS Alert: ${alert.symbol}`, {
        body: alert.message || `Price ${alert.condition} ${alert.price}`,
        icon: "/favicon.ico"
      });
    }

    setTriggeredAlerts([...triggeredAlerts, { id: alert.id, time: Date.now() }]);

    // Play alert sound 3 times, 3 seconds apart
    const playSound = () => {
      try {
        // Create a beep using AudioContext (more reliable than base64 audio)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.frequency.value = 800; // Hz - alert tone
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.5);
      } catch (e) {
        console.log("Audio playback failed:", e);
      }
    };

    // Ring 1 - immediately
    playSound();
    console.log("[Alert] 🔔 Ring 1/3");

    // Ring 2 - after 3 seconds
    setTimeout(() => {
      playSound();
      console.log("[Alert] 🔔 Ring 2/3");
    }, 3000);

    // Ring 3 - after 6 seconds
    setTimeout(() => {
      playSound();
      console.log("[Alert] 🔔 Ring 3/3 - Complete");
    }, 6000);
  };

  // =================================================================
  // NEW: MULTI-TIMEFRAME ANALYSIS FUNCTION
  // =================================================================
  
  const analyzeMultiTimeframe = async () => {
    if (!imageData) return;
    
    setLoadingMultiTimeframe(true);
    
    try {
      const analyses = {};
      
      for (const tf of selectedTimeframes) {
        setAnalysisStage(`Analyzing ${tf} timeframe...`);
        
        const data = await callAPI([{
          role: "user",
          content: [
            { type: "image", source: { type: "base64", media_type: imageData.mediaType, data: imageData.data } },
            { type: "text", text: `***RESPOND WITH ONLY JSON. START WITH { AND END WITH }. NO OTHER TEXT.***

Analyze this chart as if it's a ${tf} timeframe chart.

Provide:
{
  "timeframe": "${tf}",
  "trend": "UPTREND/DOWNTREND/SIDEWAYS",
  "strength": "STRONG/MODERATE/WEAK",
  "recommendation": "BUY/SELL/HOLD",
  "confidence": number_0_to_100,
  "keyLevel": "most important support or resistance",
  "reasoning": "brief explanation specific to ${tf} timeframe"
}

***ONLY OUTPUT THE JSON OBJECT.***` }
          ]
        }], 1000);
        
        analyses[tf] = parseJSON(data.content[0].text);
      }
      
      const trends = Object.values(analyses).map(a => a.trend);
      const recommendations = Object.values(analyses).map(a => a.recommendation);
      
      const trendAlignment = trends.every(t => t === trends[0]);
      const recommendationAlignment = recommendations.every(r => r === recommendations[0]);
      
      setMultiTimeframeAnalysis({
        analyses,
        alignment: {
          trend: trendAlignment,
          recommendation: recommendationAlignment,
          strength: trendAlignment && recommendationAlignment ? "STRONG" : 
                   trendAlignment || recommendationAlignment ? "MODERATE" : "WEAK"
        }
      });
      
    } catch (err) {
      console.error("Multi-timeframe error:", err);
      setAnalysisError("Multi-timeframe analysis failed");
    } finally {
      setLoadingMultiTimeframe(false);
    }
  };
  // Enhanced 5-pass analysis with MAXIMUM consistency
  const analyzeChart = async () => {
    if (!imageData) return;

    // Check cache first
    if (imageHash && cachedAnalyses[imageHash]) {
      setAnalysis(cachedAnalyses[imageHash]);
      return;
    }

    setLoadingAnalysis(true);
    setAnalysisError(null);
    setAnalysisProgress(0);
    clearChartQA();

    try {
      const tfText = selectedTimeframe === "auto" ? "auto-detect" : `${selectedTimeframe}`;
      const atText = selectedAssetType === "auto" ? "auto-detect" : selectedAssetType;

      // PASS 1: Context Detection - Ultra-structured
      setAnalysisStage("Reading chart metadata...");
      setAnalysisProgress(10);
      
      const contextData = await callAPI([{
        role: "user",
        content: [
          { type: "image", source: { type: "base64", media_type: imageData.mediaType, data: imageData.data } },
          { type: "text", text: `***CRITICAL: YOUR ENTIRE RESPONSE MUST BE VALID JSON ONLY. NO TEXT BEFORE OR AFTER THE JSON.***

ROLE: You are a precision chart reading system. Your ONLY job is to READ visible text and values.

CONSISTENCY PROTOCOL:
1. Report ONLY what you can physically read on the image
2. Use EXACT text from chart labels (copy exactly as written)
3. For numbers: report ALL visible digits (e.g., "45.23" not "~45" or "around 45")
4. If text is not visible, write exactly: "NOT_VISIBLE"
5. Do NOT interpret, estimate, or guess
6. TWO READS OF SAME IMAGE MUST PRODUCE IDENTICAL OUTPUT

READING CHECKLIST - Answer each item exactly:

CHART HEADER/TITLE:
□ What text appears at the very top? [copy exact text]
□ Ticker symbol visible? [exact text or NOT_VISIBLE]

TIME AXIS (bottom of chart):
□ Leftmost date label: [exact text or NOT_VISIBLE]
□ Rightmost date label: [exact text or NOT_VISIBLE]
□ Timeframe indicator visible (e.g., "1D", "4H")? [exact text or NOT_VISIBLE]

PRICE AXIS (right side):
□ Highest price label: [exact number or NOT_VISIBLE]
□ Lowest price label: [exact number or NOT_VISIBLE]
□ Current/last price: [exact number - look for highlighted or rightmost value]

CANDLESTICK/BAR STRUCTURE:
□ Are candles present? [YES or NO]
□ If YES: Last candle is [GREEN or RED or OTHER]
□ Wick structure of last candle: [LONG_UPPER_WICK or LONG_LOWER_WICK or BOTH or NONE or NOT_CLEAR]

INDICATORS VISIBLE (look for separate panels below price):
□ Panel 1 below price: [indicator name from label or NOT_VISIBLE]
□ Panel 2 below price: [indicator name or NOT_VISIBLE or NONE]
□ Panel 3 below price: [indicator name or NOT_VISIBLE or NONE]

LINES ON PRICE CHART:
□ Count colored lines overlaid on price: [number]
□ Moving average labels visible? [YES with periods: "20, 50, 200" or NO or NOT_VISIBLE]

USER SETTINGS:
- Timeframe preference: ${tfText}
- Asset type preference: ${atText}

OUTPUT FORMAT (strict JSON, no explanations):
{
  "chartTitle": "exact text from top or NOT_VISIBLE",
  "ticker": "exact symbol or NOT_VISIBLE",
  "assetType": "${selectedAssetType === "auto" ? "guess from ticker pattern: STOCK if UPPERCASE 4-letter, CRYPTO if has /, FOREX if 6-letter pairs" : selectedAssetType}",
  "timeframe": "${selectedTimeframe === "auto" ? "read from label or guess from candle count: >200 candles = 1h/4h, 50-200 = 1D, <50 = 1W/1M" : selectedTimeframe}",
  "dateRange": {
    "start": "leftmost date or NOT_VISIBLE",
    "end": "rightmost date or NOT_VISIBLE"
  },
  "priceRange": {
    "high": "highest visible number or NOT_VISIBLE",
    "low": "lowest visible number or NOT_VISIBLE",
    "current": "last price number or NOT_VISIBLE"
  },
  "lastCandle": {
    "color": "GREEN or RED or OTHER",
    "wickType": "LONG_UPPER or LONG_LOWER or BOTH or NONE"
  },
  "indicatorPanels": ["list panel names or empty array"],
  "movingAverageCount": number_of_lines_on_price_chart,
  "movingAveragePeriods": "exact text from labels or NOT_VISIBLE",
  "volumeVisible": true_or_false
}

***START YOUR RESPONSE WITH { AND END WITH }. NOTHING ELSE. NO EXPLANATIONS.***` }
        ]
      }], 1500);

      const context = parseJSON(contextData.content[0].text);

      // ========================================
      // AUTO-DETECT TRADING STYLE FROM TIMEFRAME
      // ========================================
      let autoStyle = null;
      let effectiveTradeType = selectedTradeType;
      let stockCatalysts = null;

      if (context.timeframe && context.timeframe !== 'NOT_VISIBLE') {
        autoStyle = getRecommendedTradeStyle(context.timeframe);
        if (autoStyle) {
          setAutoDetectedTradeType(autoStyle);
          if (useAutoTradeType) {
            effectiveTradeType = autoStyle.style;
            console.log(`[Chart Analysis] 🎯 Auto-detected trading style: ${autoStyle.name} (from ${context.timeframe})`);
          }
        }
      }

      // NEW: FETCH REAL TECHNICAL DATA FOR DETECTED TICKER
      // This ensures consistency with Daily Pick's analysis
      let realIndicators = null;
      const detectedTicker = context.ticker && context.ticker !== 'NOT_VISIBLE' ? context.ticker.toUpperCase().replace(/[^A-Z]/g, '') : null;

      // FETCH NEWS/CATALYSTS FOR RECOGNIZED STOCKS
      if (detectedTicker && detectedTicker.length >= 1 && detectedTicker.length <= 5) {
        try {
          // Fetch REAL-TIME news and catalysts (not static data)
          setAnalysisStage(`Fetching real-time news for ${detectedTicker}...`);
          stockCatalysts = await fetchRealTimeCatalysts(detectedTicker);
          if (stockCatalysts && (stockCatalysts.catalysts?.length > 0 || stockCatalysts.recentNews?.length > 0)) {
            console.log(`[Chart Analysis] 📰 Found LIVE catalysts for ${detectedTicker}:`, stockCatalysts);
          }
        } catch (e) {
          console.log(`[Chart Analysis] No catalyst data for ${detectedTicker}`);
        }
      }
      
      if (detectedTicker && detectedTicker.length >= 1 && detectedTicker.length <= 5) {
        setAnalysisStage(`Fetching real data for ${detectedTicker}...`);
        setAnalysisProgress(15);
        
        try {
          console.log(`[Chart Analysis] Fetching real data for ${detectedTicker}...`);
          
          // Fetch chart data from Yahoo Finance using proxy helper
          const interval = '5m';
          const range = '5d';
          const baseUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${detectedTicker}?interval=${interval}&range=${range}`;
          
          const data = await fetchYahooWithProxies(baseUrl);
          let chartData = data?.chart?.result?.[0] || null;
          
          if (chartData && chartData.timestamp) {
            const quote = chartData.indicators?.quote?.[0];
            const meta = chartData.meta;
            
            // Extract valid closes
            const closes = [];
            for (let i = 0; i < chartData.timestamp.length; i++) {
              if (quote?.close?.[i] && !isNaN(quote.close[i])) {
                closes.push(quote.close[i]);
              }
            }
            
            if (closes.length >= 50) {
              // Calculate RSI with Wilder's smoothing
              const calculateRSI = (data, period = 14) => {
                if (data.length < period + 1) return null;
                let gains = [], losses = [];
                for (let i = 1; i < data.length; i++) {
                  const change = data[i] - data[i - 1];
                  gains.push(change > 0 ? change : 0);
                  losses.push(change < 0 ? Math.abs(change) : 0);
                }
                let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
                let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
                for (let i = period; i < gains.length; i++) {
                  avgGain = (avgGain * (period - 1) + gains[i]) / period;
                  avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                }
                if (avgLoss === 0) return 100;
                return 100 - (100 / (1 + avgGain / avgLoss));
              };
              
              // Calculate EMA
              const calculateEMA = (data, period) => {
                const k = 2 / (period + 1);
                let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
                const result = [ema];
                for (let i = period; i < data.length; i++) {
                  ema = data[i] * k + ema * (1 - k);
                  result.push(ema);
                }
                return result;
              };
              
              // Calculate SMA
              const calculateSMA = (data, period) => {
                const result = [];
                for (let i = period - 1; i < data.length; i++) {
                  result.push(data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0) / period);
                }
                return result;
              };
              
              const currentPrice = meta.regularMarketPrice || closes[closes.length - 1];
              const prevClose = meta.chartPreviousClose || closes[0];
              const changePercent = ((currentPrice - prevClose) / prevClose) * 100;
              
              // Calculate indicators
              const rsi = calculateRSI(closes, 14);
              const sma20 = calculateSMA(closes, 20);
              const sma50 = calculateSMA(closes, 50);
              const ema12 = calculateEMA(closes, 12);
              const ema26 = calculateEMA(closes, 26);
              
              // MACD
              const macdLine = ema12.slice(ema12.length - ema26.length).map((v, i) => v - ema26[i]);
              const signalLine = calculateEMA(macdLine, 9);
              const currentMACD = macdLine[macdLine.length - 1];
              const currentSignal = signalLine[signalLine.length - 1];
              const macdHistogram = currentMACD - currentSignal;
              
              // Trend detection
              const recentCloses = closes.slice(-20);
              const trendSlope = (recentCloses[recentCloses.length - 1] - recentCloses[0]) / recentCloses[0] * 100;
              const trend = trendSlope > 1 ? 'UPTREND' : trendSlope < -1 ? 'DOWNTREND' : 'SIDEWAYS';
              
              // Calculate score (same as Daily Pick)
              let bullishScore = 50;
              let bearishScore = 50;
              
              if (rsi < 30) bullishScore += 15;
              else if (rsi < 40) bullishScore += 10;
              else if (rsi > 70) bearishScore += 15;
              else if (rsi > 60) bearishScore += 5;
              
              if (macdHistogram > 0 && currentMACD > 0) bullishScore += 15;
              else if (macdHistogram > 0) bullishScore += 10;
              else if (macdHistogram < 0 && currentMACD < 0) bearishScore += 15;
              else if (macdHistogram < 0) bearishScore += 10;
              
              if (currentPrice > sma20[sma20.length - 1]) bullishScore += 10;
              else bearishScore += 10;
              
              if (sma50.length > 0 && currentPrice > sma50[sma50.length - 1]) bullishScore += 10;
              else if (sma50.length > 0) bearishScore += 10;
              
              if (trend === 'UPTREND') bullishScore += 15;
              else if (trend === 'DOWNTREND') bearishScore += 15;
              
              const direction = bullishScore > bearishScore ? 'LONG' : 'SHORT';
              const netScore = direction === 'LONG' ? bullishScore - bearishScore : bearishScore - bullishScore;
              
              // Determine recommendation
              let recommendation = 'HOLD';
              if (direction === 'LONG') {
                if (netScore >= 25) recommendation = 'STRONG_BUY';
                else if (netScore >= 15) recommendation = 'BUY';
              } else {
                if (netScore >= 25) recommendation = 'STRONG_SELL';
                else if (netScore >= 15) recommendation = 'SELL';
              }
              
              realIndicators = {
                ticker: detectedTicker,
                currentPrice: currentPrice.toFixed(2),
                changePercent: changePercent.toFixed(2),
                rsi: rsi?.toFixed(1),
                macd: currentMACD?.toFixed(3),
                macdSignal: currentSignal?.toFixed(3),
                macdHistogram: macdHistogram?.toFixed(3),
                trend,
                aboveSMA20: currentPrice > sma20[sma20.length - 1],
                aboveSMA50: sma50.length > 0 ? currentPrice > sma50[sma50.length - 1] : null,
                bullishScore,
                bearishScore,
                direction,
                netScore,
                calculatedRecommendation: recommendation,
                dataSource: 'Yahoo Finance (Live)',
                barsAnalyzed: closes.length
              };
              
              console.log(`[Chart Analysis] ✓ Real indicators for ${detectedTicker}: RSI=${rsi?.toFixed(1)}, MACD=${macdHistogram > 0 ? '+' : '-'}, Trend=${trend}, Rec=${recommendation}`);
            }
          }
        } catch (e) {
          console.log(`[Chart Analysis] Could not fetch real data for ${detectedTicker}: ${e.message}`);
        }
      }

      // PASS 2: Pattern Recognition - Checklist-based
      setAnalysisStage("Scanning patterns with checklist...");
      setAnalysisProgress(30);

      const patternsData = await callAPI([{
        role: "user",
        content: [
          { type: "image", source: { type: "base64", media_type: imageData.mediaType, data: imageData.data } },
          { type: "text", text: `***RESPOND WITH ONLY JSON. START WITH { AND END WITH }. NO OTHER TEXT.***

ROLE: Pattern detection system using STRICT geometric rules.

CONSISTENCY PROTOCOL:
- Use ONLY geometric facts (peak count, line angles, touch points)
- Apply rules mechanically - no interpretation
- Count exact number of candles
- Measure relative heights in percentage terms
- Same pattern must be detected identically every time

CONTEXT FROM PASS 1:
Timeframe: ${context.timeframe}
Price Range: ${context.priceRange.low} to ${context.priceRange.high}
Current: ${context.priceRange.current}
Last Candle: ${context.lastCandle.color}

PATTERN DETECTION CHECKLIST:

STEP 1: TREND IDENTIFICATION (count swing highs/lows)
□ Count visible swing highs (peaks): [number]
□ Count visible swing lows (troughs): [number]
□ Last 3 highs progression: [HIGHER/LOWER/EQUAL compared to previous]
□ Last 3 lows progression: [HIGHER/LOWER/EQUAL compared to previous]
→ If highs and lows both HIGHER: uptrend=true
→ If highs and lows both LOWER: downtrend=true
→ Otherwise: sideways=true

STEP 2: SUPPORT/RESISTANCE (count touches)
Look for horizontal price levels where candles reversed multiple times:
□ Level near ${context.priceRange.high}: Count touches [0/1/2/3+]
□ Level near ${context.priceRange.current}: Count touches [0/1/2/3+]
□ Level near ${context.priceRange.low}: Count touches [0/1/2/3+]
→ 3+ touches = MAJOR level
→ 2 touches = MINOR level
→ <2 touches = NOT a level

STEP 3: REVERSAL PATTERNS (strict geometric rules)
Head & Shoulders Check:
□ Three peaks visible? [YES/NO]
□ If YES: Middle peak highest? [YES/NO - if NO, not H&S]
□ If YES: Shoulders roughly equal? [YES/NO - if NO, asymmetric]
→ If all YES: headAndShoulders = "DETECTED at [price of head]"

Double Top Check:
□ Two peaks visible at similar height? [YES/NO]
□ Height difference less than 2% of price? [YES/NO]
□ Trough between them? [YES/NO]
→ If all YES: doubleTop = "DETECTED at [price]"

Double Bottom Check:
□ Two troughs at similar depth? [YES/NO]
□ Depth difference less than 2%? [YES/NO]
□ Peak between them? [YES/NO]
→ If all YES: doubleBottom = "DETECTED at [price]"

STEP 4: CONTINUATION PATTERNS
Triangle Check:
□ At least 4 touches on converging lines? [YES/NO]
□ If YES: Upper line slope [UP/FLAT/DOWN], Lower line slope [UP/FLAT/DOWN]
→ UP+DOWN = ascending triangle
→ DOWN+UP = descending triangle
→ DOWN+DOWN = falling wedge
→ UP+UP = rising wedge
→ FLAT+UP = symmetrical (bottom)
→ DOWN+FLAT = symmetrical (top)

STEP 5: CURRENT PRICE POSITION
□ Current price ${context.priceRange.current} is [ABOVE/BELOW/AT] recent high
□ Current price is [ABOVE/BELOW/AT] recent low
□ Distance to resistance: [calculate: (high - current) / current × 100]%
□ Distance to support: [calculate: (current - low) / low × 100]%

OUTPUT (strict JSON):
{
  "trendAnalysis": {
    "swingHighsCount": number,
    "swingLowsCount": number,
    "last3HighsProgression": "HIGHER or LOWER or MIXED",
    "last3LowsProgression": "HIGHER or LOWER or MIXED",
    "trend": "UPTREND or DOWNTREND or SIDEWAYS based on rules above",
    "trendStrength": calculate: if_clear_progression_then_STRONG_else_if_choppy_then_WEAK_else_MODERATE
  },
  "keyLevels": {
    "resistance": [
      {
        "price": "exact level",
        "touches": number,
        "classification": "MAJOR if 3+, MINOR if 2"
      }
    ],
    "support": [
      {
        "price": "exact level",
        "touches": number,
        "classification": "MAJOR or MINOR"
      }
    ]
  },
  "reversalPatterns": {
    "headAndShoulders": "DETECTED at [price] or NONE",
    "doubleTop": "DETECTED at [price] or NONE",
    "doubleBottom": "DETECTED at [price] or NONE",
    "tripleTop": "DETECTED at [price] or NONE",
    "tripleBottom": "DETECTED at [price] or NONE"
  },
  "continuationPatterns": {
    "triangleType": "ASCENDING/DESCENDING/SYMMETRICAL/RISING_WEDGE/FALLING_WEDGE or NONE",
    "apexPrice": "price level or null",
    "breakoutDirection": "UP or DOWN based on pattern type"
  },
  "pricePosition": {
    "relativeToHigh": "ABOVE/AT/BELOW",
    "relativeToLow": "ABOVE/AT/BELOW",
    "distanceToResistance": "calculated %",
    "distanceToSupport": "calculated %",
    "zone": "if within 2% of resistance: RESISTANCE_ZONE, if within 2% of support: SUPPORT_ZONE, else: NEUTRAL_ZONE"
  },
  "patternReliability": "HIGH if textbook patterns, MEDIUM if partial, LOW if forced"
}

***ONLY OUTPUT THE JSON OBJECT. START WITH { AND END WITH }. NO EXPLANATIONS.***` }
        ]
      }], 2500);

      const patterns = parseJSON(patternsData.content[0].text);

      // PASS 3: Indicator Analysis - Exact readings
      setAnalysisStage("Reading indicator values...");
      setAnalysisProgress(50);

      const indicatorsData = await callAPI([{
        role: "user",
        content: [
          { type: "image", source: { type: "base64", media_type: imageData.mediaType, data: imageData.data } },
          { type: "text", text: `***RESPOND WITH ONLY JSON. START WITH { AND END WITH }. NO OTHER TEXT.***

ROLE: Indicator reading system. Report EXACT numerical values.

CONSISTENCY RULES:
- Read numbers to all visible decimal places
- For line position: use ABOVE/BELOW/CROSSING (no ambiguity)
- For line slope: measure over last 5 candles only
- Apply mathematical thresholds (no subjective terms)

KNOWN INDICATORS: ${context.indicatorPanels.join(", ")}
MOVING AVERAGES: ${context.movingAverageCount} lines, periods: ${context.movingAveragePeriods}

READING PROTOCOL:

RSI (if in indicator panels):
□ Find RSI line endpoint (rightmost value)
□ Read exact number: [0-100 or NOT_VISIBLE]
□ Apply rule: >70 = OVERBOUGHT, <30 = OVERSOLD, else = NEUTRAL
□ Line slope over last 5 candles: [UP if rising, DOWN if falling, FLAT if ±2 points]
□ Price trend vs RSI trend: [CONVERGING if both same direction, DIVERGING if opposite]

MACD (if in indicator panels):
□ MACD line vs Signal line: [ABOVE or BELOW or CROSSING]
□ Histogram bars: [GROWING if getting taller, SHRINKING if shorter, STABLE]
□ Histogram color: [GREEN/BULLISH or RED/BEARISH]
□ Recent crossover? [YES_BULLISH if MACD crossed above, YES_BEARISH if below, NO]

MOVING AVERAGES (on price chart):
For each visible MA line:
□ MA period: [read from label or estimate from smoothness: smoother = longer]
□ Price vs MA: [ABOVE or BELOW or ON]
□ MA slope: [UP if clearly rising, DOWN if falling, FLAT if horizontal]
□ MA alignment: [list if short > medium > long (bullish) or opposite (bearish)]

VOLUME (if visible):
□ Last 5 bars vs previous 20 bars: [HIGHER or LOWER or SAME]
□ Volume trend: [calculate: if last_5_avg > prev_20_avg then INCREASING else DECREASING]
□ Volume on last ${context.lastCandle.color} candle: [HIGH if >150% average, NORMAL if 50-150%, LOW if <50%]

BOLLINGER BANDS (if visible):
□ Price position: [ABOVE_UPPER_BAND or BETWEEN_BANDS or BELOW_LOWER_BAND or ON_MIDDLE]
□ Band width: [calculate: (upper - lower) / middle × 100]%
□ Width classification: [SQUEEZING if <5%, NORMAL if 5-10%, EXPANDING if >10%]

NUMERICAL SCORING (0-100 scale):
Calculate bullish score:
- RSI 30-50: +10 | 50-70: +20 | 70+: -10
- MACD above signal: +15
- Price above MAs: +5 per MA (max +20)
- Volume increasing: +10
- Price above upper BB: -10 | At middle: +10
Total bullish score: [sum]

Calculate bearish score (opposite logic):
Total bearish score: [sum]

Net score: bullish - bearish = [number from -100 to +100]

OUTPUT (strict JSON):
{
  "rsi": {
    "value": number_or_null,
    "zone": "OVERBOUGHT or OVERSOLD or NEUTRAL",
    "slope": "UP or DOWN or FLAT",
    "divergence": "BULLISH or BEARISH or NONE"
  },
  "macd": {
    "position": "ABOVE_SIGNAL or BELOW_SIGNAL",
    "crossover": "BULLISH or BEARISH or NONE",
    "histogram": "GROWING or SHRINKING or STABLE",
    "signal": "BULLISH or BEARISH"
  },
  "movingAverages": [
    {
      "period": number_or_estimated,
      "position": "ABOVE_PRICE or BELOW_PRICE",
      "slope": "UP or DOWN or FLAT"
    }
  ],
  "maAlignment": "BULLISH_ALIGNED or BEARISH_ALIGNED or MIXED or NOT_APPLICABLE",
  "volume": {
    "trend": "INCREASING or DECREASING",
    "lastCandleVolume": "HIGH or NORMAL or LOW",
    "confirmation": "CONFIRMS_PRICE if trend matches, DIVERGES if opposite"
  },
  "bollingerBands": {
    "present": boolean,
    "position": "ABOVE_UPPER or BETWEEN or BELOW_LOWER or ON_MIDDLE",
    "width": number_percent,
    "state": "SQUEEZING or NORMAL or EXPANDING"
  },
  "indicatorScores": {
    "bullishScore": number_0_to_100,
    "bearishScore": number_0_to_100,
    "netScore": number_minus100_to_plus100,
    "interpretation": "if net > 30: STRONG_BULLISH, if net > 10: BULLISH, if net < -30: STRONG_BEARISH, if net < -10: BEARISH, else: NEUTRAL"
  }
}

***ONLY OUTPUT THE JSON OBJECT. START WITH { AND END WITH }. NO EXPLANATIONS.***` }
        ]
      }], 2500);

      const indicators = parseJSON(indicatorsData.content[0].text);

      // PASS 4: Trade Setup Calculation - Pure mathematics
      setAnalysisStage("Calculating trade setups...");
      setAnalysisProgress(70);

      // Trade type configurations
      const tradeTypeConfig = {
        scalp: { 
          name: "Scalp Trade",
          stopPct: 0.5, 
          target1Pct: 0.8, 
          target2Pct: 1.5, 
          timeHorizon: "Minutes to 1 hour",
          direction: "auto" // Based on analysis
        },
        day: { 
          name: "Day Trade",
          stopPct: 1.5, 
          target1Pct: 3.0, 
          target2Pct: 5.0, 
          timeHorizon: "1-6 hours (same day)",
          direction: "auto"
        },
        swing: { 
          name: "Swing Trade",
          stopPct: 3.0, 
          target1Pct: 6.0, 
          target2Pct: 10.0, 
          timeHorizon: "2-10 days",
          direction: "auto"
        },
        position: { 
          name: "Position Trade",
          stopPct: 7.0, 
          target1Pct: 15.0, 
          target2Pct: 25.0, 
          timeHorizon: "2-8 weeks",
          direction: "auto"
        },
        short: { 
          name: "Short Selling",
          stopPct: 4.0, 
          target1Pct: 8.0, 
          target2Pct: 15.0, 
          timeHorizon: "2-14 days",
          direction: "SHORT" // Force short direction
        },
        options: { 
          name: "Options Play",
          stopPct: 2.0, 
          target1Pct: 10.0, 
          target2Pct: 25.0, 
          timeHorizon: "1-4 weeks (before expiry)",
          direction: "auto"
        }
      };
      
      const tradeConfig = tradeTypeConfig[effectiveTradeType] || tradeTypeConfig.swing;

      const setupData = await callAPI([{
        role: "user",
        content: [
          { type: "image", source: { type: "base64", media_type: imageData.mediaType, data: imageData.data } },
          { type: "text", text: `***RESPOND WITH ONLY JSON. START WITH { AND END WITH }. NO OTHER TEXT.***

ROLE: Risk calculation engine for ${tradeConfig.name}. Use EXACT mathematics ONLY.

TRADE TYPE SELECTED: ${tradeConfig.name}
- Typical Stop Loss: ${tradeConfig.stopPct}%
- Typical Target 1: ${tradeConfig.target1Pct}%
- Typical Target 2: ${tradeConfig.target2Pct}%
- Time Horizon: ${tradeConfig.timeHorizon}
${tradeConfig.direction === "SHORT" ? "- FORCED DIRECTION: SHORT (user wants to short this stock)" : "- Direction: Based on technical analysis"}

CONSISTENCY RULES:
- All prices to 2 decimal places
- All percentages to 1 decimal place
- R:R ratios to format 1:X.XX
- Use actual support/resistance prices (no estimates)

INPUT DATA:
Current Price: ${context.priceRange.current}
Trend: ${patterns.trendAnalysis.trend}
Major Support: ${JSON.stringify(patterns.keyLevels.support.filter(s => s.classification === "MAJOR"))}
Major Resistance: ${JSON.stringify(patterns.keyLevels.resistance.filter(r => r.classification === "MAJOR"))}
Indicator Signal: ${indicators.indicatorScores.interpretation}
Timeframe: ${context.timeframe}

CALCULATION PROTOCOL:

STEP 1: Determine trade direction
${tradeConfig.direction === "SHORT" ? 
  "FORCED: direction = SHORT (user selected short selling)" :
  `IF trend = UPTREND AND indicatorScore > 0: direction = LONG
ELSE IF trend = DOWNTREND AND indicatorScore < 0: direction = SHORT
ELSE: direction = NEUTRAL (no setup)`}

STEP 2: Calculate LONG setup (if direction = LONG)
Entry = ${context.priceRange.current}
Stop = Entry - ${tradeConfig.stopPct}% OR [nearest major support below current - 0.5%] (use tighter one)
Target1 = Entry + ${tradeConfig.target1Pct}% OR [nearest major resistance above current] (use closer one)
Target2 = Entry + ${tradeConfig.target2Pct}% OR [second resistance]
Target3 = [third resistance or Target2 + (Target1 - Entry)]

Risk = |Entry - Stop|
Reward = |Target1 - Entry|
RR = Reward / Risk formatted as 1:X.XX

STEP 3: Calculate SHORT setup (if direction = SHORT)
Entry = ${context.priceRange.current}
Stop = Entry + ${tradeConfig.stopPct}% OR [nearest major resistance above current + 0.5%] (use tighter one)
Target1 = Entry - ${tradeConfig.target1Pct}% OR [nearest major support below current] (use closer one)
Target2 = Entry - ${tradeConfig.target2Pct}% OR [second support]
Target3 = [third support or Target2 - (Entry - Target1)]

Risk = |Stop - Entry|
Reward = |Entry - Target1|
RR = Reward / Risk formatted as 1:X.XX

STEP 4: Calculate probabilities
Base probability = 50%
IF RR > 2.5: +10%
IF RR > 3.0: +15%
IF trend matches direction: +10%
IF indicatorScore extreme (>40 or <-40): +10%
IF at major support/resistance: +5%
${tradeConfig.direction === "SHORT" ? "IF trend = DOWNTREND for SHORT: +10% (shorting with trend)" : ""}
Total = cap at 85%

STEP 5: Position sizing for ${tradeConfig.name}
${effectiveTradeType === 'scalp' ? 'Scalp: 0.5-1% of capital (high frequency)' :
  effectiveTradeType === 'day' ? 'Day Trade: 1-2% of capital' :
  effectiveTradeType === 'swing' ? 'Swing: 1-2% of capital' :
  effectiveTradeType === 'position' ? 'Position: 2-3% of capital (wider stops)' :
  effectiveTradeType === 'short' ? 'Short: 1-1.5% of capital (higher risk)' :
  effectiveTradeType === 'options' ? 'Options: 1-2% of capital (premium at risk)' : '1-2% of capital'}

OUTPUT (strict JSON with EXACT numbers):
{
  "tradeType": "${tradeConfig.name}",
  "tradeDirection": "${tradeConfig.direction === "SHORT" ? "SHORT" : "LONG or SHORT or NEUTRAL based on analysis"}",
  "immediateEntry": {
    "entry": ${context.priceRange.current},
    "stop": "calculated exact price",
    "target1": "calculated exact price",
    "target2": "calculated exact price",
    "target3": "calculated exact price or null",
    "risk": "calculated |entry - stop|",
    "reward": "calculated |target1 - entry|",
    "riskRewardRatio": "1:X.XX",
    "winProbability": calculated_percentage,
    "positionSize": "X% of capital"
  },
  "pullbackEntry": {
    "entryZone": "[support/resistance level ± 0.5%]",
    "stop": "beyond the zone",
    "target1": "same as immediate",
    "riskRewardRatio": "improved 1:X.XX",
    "winProbability": "immediate + 5%",
    "triggerCondition": "Wait for price to reach zone with bullish/bearish confirmation"
  },
  "invalidation": {
    "longInvalidation": "close below [support - 1%]",
    "shortInvalidation": "close above [resistance + 1%]"
  },
  "timeHorizon": "${tradeConfig.timeHorizon}",
  "confidence": "HIGH if RR>2.5 AND probability>65%, MEDIUM if RR>2 AND prob>55%, else LOW"
}

***ONLY OUTPUT THE JSON OBJECT. START WITH { AND END WITH }. NO EXPLANATIONS.***` }
        ]
      }], 2500);

      const tradeSetup = parseJSON(setupData.content[0].text);

      // PASS 5: Final Synthesis - Algorithmic scoring
      setAnalysisStage("Generating recommendation...");
      setAnalysisProgress(90);

      const finalData = await callAPI([{
        role: "user",
        content: [
          { type: "image", source: { type: "base64", media_type: imageData.mediaType, data: imageData.data } },
          { type: "text", text: `***RESPOND WITH ONLY JSON. START WITH { AND END WITH }. NO OTHER TEXT.***

ROLE: Decision engine. Apply FIXED algorithm to generate recommendation.

CONSISTENCY: Same inputs MUST produce same output.

INPUT SCORES:
Trend: ${patterns.trendAnalysis.trend} (${patterns.trendAnalysis.trendStrength})
Indicator Net Score: ${indicators.indicatorScores.netScore}
Pattern Quality: ${patterns.patternReliability}
Trade Direction: ${tradeSetup.tradeDirection}
Risk:Reward: ${tradeSetup.immediateEntry?.riskRewardRatio || "N/A"}
Win Probability: ${tradeSetup.immediateEntry?.winProbability || 0}%
${stockCatalysts ? `
NEWS/CATALYSTS FOR ${detectedTicker || 'this stock'}:
- Upcoming Events: ${stockCatalysts.upcomingEvents?.join(', ') || 'None known'}
- Key Catalysts: ${stockCatalysts.catalysts?.join(', ') || 'None known'}
- Risks: ${stockCatalysts.risks?.join(', ') || 'None known'}
- Seasonality: ${stockCatalysts.seasonality || 'neutral'}
- Sector Trend: ${stockCatalysts.sectorTrend || 'unknown'}
` : ''}

SCORING ALGORITHM:
Points = 0

1. Trend alignment:
   IF trend = UPTREND AND tradeDirection = LONG: +20 points
   IF trend = DOWNTREND AND tradeDirection = SHORT: +20 points
   IF trend = SIDEWAYS: +0 points

2. Indicator score:
   IF netScore > 40: +20 points
   ELSE IF netScore > 20: +15 points
   ELSE IF netScore > 0: +10 points
   ELSE IF netScore > -20: -10 points
   ELSE: -20 points

3. Risk:Reward:
   Extract X from "1:X.XX"
   IF X >= 3.0: +20 points
   ELSE IF X >= 2.5: +15 points
   ELSE IF X >= 2.0: +10 points
   ELSE: +5 points

4. Pattern quality:
   IF HIGH: +15 points
   IF MEDIUM: +10 points
   IF LOW: +5 points

5. Win probability:
   IF >= 70%: +15 points
   IF >= 60%: +10 points
   ELSE: +5 points

6. News/Catalyst impact (if available):
   IF seasonality = bullish AND tradeDirection = LONG: +5 points
   IF seasonality = bearish AND tradeDirection = SHORT: +5 points
   IF upcoming earnings/events AND high volatility expected: note in risk warning
   IF sector trend aligns with trade direction: +3 points
   IF significant risks mentioned: -3 points (add to risk warning)

Total Score = [sum all points, range 0-100]

RECOMMENDATION MAPPING (BE CONFIDENT AND ACTIONABLE):
IF score >= 75: STRONG_BUY (for LONG) or STRONG_SELL (for SHORT) - High conviction
IF score >= 60: BUY (for LONG) or SELL (for SHORT) - Good setup
IF score >= 45: MODERATE_BUY (for LONG) or MODERATE_SELL (for SHORT) - Decent opportunity with caution
IF score >= 30: LEAN_BUY (for LONG) or LEAN_SELL (for SHORT) - Lower conviction but tradeable
IF score < 30: WAIT (with specific conditions to watch for)

IMPORTANT FOR SHORT TRADES:
- If bearish signals are present, recommend SELL or STRONG_SELL confidently
- NEVER say "speculative short" - if the setup is bearish, say SELL or STRONG_SELL
- Short selling is a valid strategy when technicals support it
- Treat bearish setups with same confidence as bullish ones

IMPORTANT: NEVER just say "AVOID" without providing actionable guidance.
Always provide a directional bias (LONG or SHORT) even for low-confidence setups.
Traders need to know WHAT TO DO, not just what NOT to do.

CONFIDENCE CALCULATION:
confidence = min(score, 95)

OUTPUT (strict JSON):
{
  "recommendation": "STRONG_BUY or BUY or MODERATE_BUY or LEAN_BUY or SELL or STRONG_SELL or MODERATE_SELL or LEAN_SELL or WAIT",
  "directionalBias": "LONG or SHORT - ALWAYS provide this, even for WAIT recommendations",
  "biasStrength": "STRONG, MODERATE, or WEAK",
  "confidenceScore": calculated_score_0_to_95,
  "pointsBreakdown": {
    "trendAlignment": number,
    "indicatorScore": number,
    "riskReward": number,
    "patternQuality": number,
    "winProbability": number,
    "catalystImpact": number_or_0_if_no_catalysts,
    "totalPoints": sum
  },
  "catalystInfo": {
    "hasData": ${stockCatalysts ? 'true' : 'false'},
    "sentiment": "bullish/bearish/neutral based on catalysts",
    "keyEvent": "most important upcoming event if any",
    "riskFromNews": "any significant risk from news/events"
  },
  "summary": "State: ${patterns.trendAnalysis.trend} trend, ${indicators.indicatorScores.interpretation} indicators, ${tradeSetup.tradeDirection} setup with ${tradeSetup.immediateEntry?.riskRewardRatio} R:R",
  "primarySignal": "identify highest point contributor",
  "bullishFactors": [
    "list only factors that added points"
  ],
  "bearishFactors": [
    "list only factors that subtracted points"
  ],
  "tradeInstruction": {
    "action": "BUY/SELL ${context.ticker} at ${tradeSetup.immediateEntry?.entry}",
    "stop": ${tradeSetup.immediateEntry?.stop},
    "target": ${tradeSetup.immediateEntry?.target1},
    "risk": "${tradeSetup.immediateEntry?.positionSize}"
  },
  "ifYouMustTrade": {
    "direction": "LONG or SHORT",
    "entry": "specific price or condition",
    "tightStop": "closer stop for reduced risk",
    "conservativeTarget": "realistic near-term target",
    "positionSize": "reduce to 25-50% of normal size"
  },
  "invalidationPrice": ${tradeSetup.invalidation?.longInvalidation || tradeSetup.invalidation?.shortInvalidation},
  "timeframe": "${context.timeframe} - hold for ${tradeSetup.timeHorizon}",
  "setupQuality": "A+ if score>=80, A if >=70, B if >=60, C if >=50, D if <50",
  "keyLevels": [
    "list 3 most critical price levels from analysis"
  ],
  "waitForConditions": ["list specific price levels or indicators that would improve the setup"],
  "riskWarning": "Main risk: [identify if stop is close, low probability, or conflicting signals]"
}

***ONLY OUTPUT THE JSON OBJECT. START WITH { AND END WITH }. NO EXPLANATIONS.***` }
        ]
      }], 3000);

      const final = parseJSON(finalData.content[0].text);

      // PASS 6: Indicator Recommendations & Predictions
      setAnalysisStage("Generating recommendations & predictions...");
      setAnalysisProgress(95);

      const recommendationsData = await callAPI([{
        role: "user",
        content: [
          { type: "image", source: { type: "base64", media_type: imageData.mediaType, data: imageData.data } },
          { type: "text", text: `***RESPOND WITH ONLY JSON. START WITH { AND END WITH }. NO OTHER TEXT.***

ROLE: Trading advisory system. Provide actionable recommendations and predictions.

ANALYSIS SUMMARY:
${JSON.stringify({ context, patterns, indicators, tradeSetup, final }, null, 2)}

TASK 1: RECOMMEND INDICATORS
Based on what's currently on the chart and what's missing, recommend specific indicators to add:

For ${context.assetType} on ${context.timeframe} timeframe:
- Identify which indicators are ALREADY present
- Recommend 3-5 ADDITIONAL indicators that would improve analysis
- For each recommendation, explain WHY it would help for this specific chart/timeframe

TASK 2: PRICE PREDICTIONS
Generate specific price predictions based on technical analysis:
- Next support/resistance levels the price will test
- Short-term target (1-3 bars)
- Medium-term target (5-10 bars)  
- Long-term target (20-50 bars)
- Expected volatility and price range

TASK 3: SCENARIO ANALYSIS
Create three scenarios:
- BULLISH: If price breaks above resistance, where will it go?
- BEARISH: If price breaks below support, where will it go?
- NEUTRAL: If price consolidates, what range and for how long?

OUTPUT JSON:
{
  "indicatorRecommendations": [
    {
      "indicator": "specific indicator name (e.g., Bollinger Bands 20,2)",
      "category": "Trend/Momentum/Volume/Volatility",
      "priority": "Essential/Highly Recommended/Optional",
      "reasoning": "specific explanation for THIS chart and timeframe",
      "expectedBenefit": "what this will help you identify or confirm",
      "settings": "recommended settings (e.g., period 14, smoothing 3)"
    }
  ],
  "currentIndicatorAssessment": {
    "presentIndicators": ["list what's already on chart"],
    "coverageAnalysis": "what types of analysis are covered vs missing",
    "gaps": ["specific gaps in current indicator setup"]
  },
  "pricePredictions": {
    "nextKeyLevel": {
      "price": "specific price",
      "direction": "ABOVE or BELOW current",
      "probability": "percentage",
      "timeframe": "expected time to reach",
      "type": "Support or Resistance"
    },
    "shortTerm": {
      "targetPrice": "specific price",
      "timeframe": "1-3 ${context.timeframe} bars",
      "confidence": "percentage",
      "keyTrigger": "what needs to happen"
    },
    "mediumTerm": {
      "targetPrice": "specific price",
      "timeframe": "5-10 ${context.timeframe} bars",
      "confidence": "percentage",
      "keyTrigger": "what needs to happen"
    },
    "longTerm": {
      "targetPrice": "specific price",
      "timeframe": "20-50 ${context.timeframe} bars",
      "confidence": "percentage",
      "keyTrigger": "what needs to happen"
    },
    "expectedVolatility": {
      "level": "Low/Moderate/High/Extreme",
      "priceRange": "expected daily/hourly range",
      "reasoning": "why this volatility is expected"
    }
  },
  "scenarioAnalysis": {
    "bullishScenario": {
      "trigger": "specific price breakout level",
      "firstTarget": "price",
      "secondTarget": "price",
      "finalTarget": "price",
      "probability": "percentage",
      "timeframe": "how long this would take",
      "requiredConditions": ["what needs to happen"],
      "invalidation": "price level that kills this scenario"
    },
    "bearishScenario": {
      "trigger": "specific price breakdown level",
      "firstTarget": "price",
      "secondTarget": "price",
      "finalTarget": "price",
      "probability": "percentage",
      "timeframe": "how long this would take",
      "requiredConditions": ["what needs to happen"],
      "invalidation": "price level that kills this scenario"
    },
    "neutralScenario": {
      "rangeHigh": "specific price",
      "rangeLow": "specific price",
      "expectedDuration": "how many bars",
      "probability": "percentage",
      "tradingStrategy": "how to trade this range",
      "breakoutDirection": "which way more likely when it breaks"
    }
  },
  "actionPlan": {
    "immediateAction": "specific action to take right now",
    "waitingFor": "what signal/level to watch for",
    "planB": "what to do if primary plan fails",
    "exitStrategy": "when and how to exit position"
  }
}

***ONLY OUTPUT THE JSON OBJECT. BE SPECIFIC WITH ALL PRICES AND TIMEFRAMES.***` }
        ]
      }], 3000);

      const recommendations = parseJSON(recommendationsData.content[0].text);

      setAnalysisProgress(100);
      
      // RECONCILIATION: If we have real calculated indicators, use them to validate/override AI recommendation
      let reconciledFinal = { ...final };
      if (realIndicators) {
        const aiRec = final.recommendation;
        const calcRec = realIndicators.calculatedRecommendation;
        
        // Check if AI and calculated recommendations conflict
        const aiIsBullish = aiRec?.includes('BUY');
        const aiIsBearish = aiRec?.includes('SELL');
        const calcIsBullish = calcRec?.includes('BUY');
        const calcIsBearish = calcRec?.includes('SELL');
        
        if ((aiIsBullish && calcIsBearish) || (aiIsBearish && calcIsBullish)) {
          // CONFLICT: Use calculated recommendation (based on real data)
          console.log(`[Chart Analysis] ⚠️ CONFLICT: AI says ${aiRec}, Calculated says ${calcRec}. Using calculated.`);
          reconciledFinal.recommendation = calcRec;
          reconciledFinal.reconciled = true;
          reconciledFinal.aiOriginal = aiRec;
          reconciledFinal.reconciliationNote = `Note: AI visual analysis suggested ${aiRec}, but calculated technical indicators (RSI: ${realIndicators.rsi}, MACD: ${realIndicators.macdHistogram > 0 ? 'Bullish' : 'Bearish'}, Trend: ${realIndicators.trend}) indicate ${calcRec}. Using calculated recommendation for accuracy.`;
        } else {
          // NO CONFLICT: AI and calculation agree
          reconciledFinal.reconciled = false;
          reconciledFinal.dataValidated = true;
        }
        
        // Add calculated confidence
        reconciledFinal.calculatedConfidence = Math.min(95, 50 + realIndicators.netScore);
        
        // Adjust summary to reflect real data
        reconciledFinal.summary = `${realIndicators.trend} trend | RSI: ${realIndicators.rsi} | MACD: ${realIndicators.macdHistogram > 0 ? 'Bullish' : 'Bearish'} | Score: Bull ${realIndicators.bullishScore} / Bear ${realIndicators.bearishScore}`;
      }
      
      const fullAnalysis = {
        context,
        patterns,
        indicators,
        tradeSetup,
        final: reconciledFinal,
        recommendations,
        // NEW: Include real calculated indicators for transparency
        realIndicators: realIndicators || null,
        // NEW: Include auto-detected trading style
        autoDetectedStyle: autoStyle || null,
        effectiveTradeType: effectiveTradeType,
        // NEW: Include stock catalysts/news for recognized tickers
        stockCatalysts: stockCatalysts || null
      };
      setAnalysis(fullAnalysis);

      // Track analysis completion
      trackEvent('analysis', 'complete', context?.ticker || detectedTicker || 'unknown');

      // Auto-save to history
      if (fullAnalysis && image) {
        saveToHistory(fullAnalysis, image);
      }
      
      // Cache result
      if (imageHash) {
        setCachedAnalyses(prev => ({
          ...prev,
          [imageHash]: fullAnalysis
        }));
      }

    } catch (err) {
      console.error("Analysis error:", err);
      let errorMsg = 'Unable to analyze the chart';

      // Provide user-friendly error messages
      if (err.message.includes("500") || err.message.includes("Internal server")) {
        errorMsg = "API server error. Please check your API key configuration in settings.";
      } else if (err.message.includes("401") || err.message.includes("unauthorized")) {
        errorMsg = "API authentication failed. Please verify your API key.";
      } else if (err.message.includes("quota") || err.message.includes("rate limit")) {
        errorMsg = "API quota exceeded. Please try again later.";
      } else if (err.message.includes("timeout")) {
        errorMsg = "Analysis timed out. Your image may be too large or the server is busy.";
      } else if (err.message) {
        errorMsg = `Analysis failed: ${err.message}`;
      }

      // Log full error for debugging
      console.error("[Chart Analysis] Full error details:", {
        message: err.message,
        name: err.name,
        stack: err.stack
      });

      setAnalysisError(errorMsg);
    } finally {
      setLoadingAnalysis(false);
      setAnalysisStage("");
      setAnalysisProgress(0);
    }
  };

  // ========================================
  // STOCK CATALYSTS & EVENTS DATABASE
  // Dynamic, date-aware catalysts that auto-update
  // ========================================
  const getStockCatalysts = (symbol) => {
    const now = new Date();
    const currentMonth = now.getMonth(); // 0-11
    const currentQuarter = Math.floor(currentMonth / 3) + 1; // Q1-Q4
    const currentYear = now.getFullYear();

    // Helper: Get next earnings quarter description
    const getEarningsDesc = (fiscalOffset = 0) => {
      const q = ((currentQuarter + fiscalOffset - 1) % 4) + 1;
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const earningsMonth = months[((q - 1) * 3 + 1) % 12];
      return `Q${q} earnings ${earningsMonth} - key metrics in focus`;
    };

    // Dynamic catalyst database - evergreen descriptions
    const catalystDB = {
      // === MEGA-CAP TECH ===
      'AAPL': {
        upcomingEvents: [
          currentMonth >= 6 && currentMonth <= 8 ? 'iPhone launch event approaching' : 'Next iPhone cycle anticipated',
          'AI features expansion ongoing',
          'Services revenue growth continues'
        ],
        earnings: getEarningsDesc(),
        catalysts: ['Device upgrade cycle momentum', 'Wearables ecosystem growth', 'Emerging market expansion'],
        risks: ['China market headwinds', 'Regulatory pressure globally', 'Hardware market saturation'],
        seasonality: currentMonth >= 8 && currentMonth <= 11 ? 'bullish' : 'neutral',
        sectorTrend: 'Consumer tech ecosystem strengthening'
      },
      'MSFT': {
        upcomingEvents: ['Azure AI capacity expansion', 'Copilot adoption acceleration', 'Cloud market share gains'],
        earnings: getEarningsDesc(1), // MSFT fiscal year offset
        catalysts: ['Enterprise AI integration', 'Cloud migration tailwinds', 'Gaming subscription growth'],
        risks: ['Cloud competition intensifying', 'Enterprise spending cycles', 'Antitrust scrutiny'],
        seasonality: 'neutral',
        sectorTrend: 'Enterprise AI spending accelerating'
      },
      'NVDA': {
        upcomingEvents: ['Next-gen GPU architecture rollout', 'Data center demand surge', 'AI inference scaling'],
        earnings: getEarningsDesc(),
        catalysts: ['AI infrastructure bottleneck', 'Hyperscaler capex growth', 'Automotive AI expansion'],
        risks: ['Export restrictions impact', 'Custom chip competition', 'Supply chain constraints'],
        seasonality: 'bullish',
        sectorTrend: 'AI compute demand unprecedented'
      },
      'GOOGL': {
        upcomingEvents: ['AI model improvements', 'Search integration updates', 'Cloud growth initiatives'],
        earnings: getEarningsDesc(),
        catalysts: ['AI search leadership', 'YouTube monetization', 'Autonomous driving progress'],
        risks: ['Antitrust proceedings', 'AI competition', 'Ad market cyclicality'],
        seasonality: currentMonth >= 9 && currentMonth <= 11 ? 'bullish' : 'neutral',
        sectorTrend: 'Digital advertising resilient'
      },
      'AMZN': {
        upcomingEvents: [
          currentMonth >= 6 && currentMonth <= 7 ? 'Prime Day approaching' : 'Prime membership growth',
          'AWS AI services expansion',
          'Logistics efficiency gains'
        ],
        earnings: getEarningsDesc(),
        catalysts: ['Cloud AI leadership', 'Retail margin improvement', 'Advertising scaling'],
        risks: ['Retail competition', 'Labor cost pressure', 'Regulatory challenges'],
        seasonality: currentMonth >= 9 && currentMonth <= 11 ? 'bullish' : currentMonth === 6 ? 'bullish' : 'neutral',
        sectorTrend: 'E-commerce and cloud synergies'
      },
      'META': {
        upcomingEvents: ['AI model releases', 'AR/VR platform updates', 'Ad tech improvements'],
        earnings: getEarningsDesc(),
        catalysts: ['AI-driven ad efficiency', 'Reality Labs monetization', 'User engagement growth'],
        risks: ['Youth engagement trends', 'Hardware investment returns', 'Competitive pressure'],
        seasonality: currentMonth >= 9 && currentMonth <= 11 ? 'bullish' : 'neutral',
        sectorTrend: 'Social media monetization improving'
      },
      'TSLA': {
        upcomingEvents: [
          currentMonth === 0 || currentMonth === 3 || currentMonth === 6 || currentMonth === 9 ? 'Delivery numbers imminent' : 'Production scaling updates',
          'Autonomous driving expansion',
          'Energy business growth'
        ],
        earnings: getEarningsDesc(),
        catalysts: ['Autonomy monetization', 'Energy storage demand', 'Manufacturing efficiency'],
        risks: ['EV competition', 'Margin pressure', 'Execution risks'],
        seasonality: currentMonth === 0 || currentMonth === 3 || currentMonth === 6 || currentMonth === 9 ? 'volatile' : 'neutral',
        sectorTrend: 'EV leader diversifying revenue'
      },
      // === SEMICONDUCTORS ===
      'AMD': {
        upcomingEvents: ['AI accelerator momentum', 'Data center share gains', 'Server CPU growth'],
        earnings: getEarningsDesc(),
        catalysts: ['AI market expansion', 'Enterprise wins', 'Product cycle strength'],
        risks: ['Competitive dynamics', 'PC market trends', 'Execution challenges'],
        seasonality: 'neutral',
        sectorTrend: 'AI chip demand robust'
      },
      'AVGO': {
        upcomingEvents: ['Custom AI chip demand', 'Networking growth', 'Software integration'],
        earnings: getEarningsDesc(),
        catalysts: ['AI networking boom', 'Enterprise software', 'Diversified revenue'],
        risks: ['Customer concentration', 'Cyclical exposure', 'Integration execution'],
        seasonality: 'neutral',
        sectorTrend: 'Semiconductor diversification'
      },
      // === FINANCIALS ===
      'JPM': {
        upcomingEvents: ['Fed policy impact', 'Investment banking trends', 'Credit quality updates'],
        earnings: getEarningsDesc(),
        catalysts: ['Net interest income', 'Trading strength', 'Consumer banking growth'],
        risks: ['Credit deterioration', 'CRE exposure', 'Capital requirements'],
        seasonality: 'neutral',
        sectorTrend: 'Banking fundamentals solid'
      },
      'V': {
        upcomingEvents: ['Payment volume trends', 'Cross-border recovery', 'New flow expansion'],
        earnings: getEarningsDesc(),
        catalysts: ['Consumer spending', 'International growth', 'B2B payments'],
        risks: ['Economic slowdown', 'Fintech competition', 'Regulatory changes'],
        seasonality: currentMonth >= 10 || currentMonth <= 1 ? 'bullish' : 'neutral',
        sectorTrend: 'Digital payments secular growth'
      },
      'COIN': {
        upcomingEvents: ['Crypto market developments', 'Regulatory updates', 'Product expansion'],
        earnings: getEarningsDesc(),
        catalysts: ['Institutional adoption', 'Trading volume growth', 'Revenue diversification'],
        risks: ['Crypto volatility', 'Regulatory actions', 'Competition'],
        seasonality: 'volatile',
        sectorTrend: 'Crypto infrastructure maturing'
      },
      // === HEALTHCARE ===
      'LLY': {
        upcomingEvents: ['Drug supply expansion', 'Pipeline readouts', 'Market expansion'],
        earnings: getEarningsDesc(),
        catalysts: ['GLP-1 demand growth', 'Obesity market expansion', 'Pricing power'],
        risks: ['Manufacturing scale', 'Competition', 'Political pricing pressure'],
        seasonality: 'bullish',
        sectorTrend: 'Weight loss drug demand surging'
      },
      'UNH': {
        upcomingEvents: [
          currentMonth >= 9 && currentMonth <= 11 ? 'Open enrollment period active' : 'Enrollment trends update',
          'Healthcare services growth'
        ],
        earnings: getEarningsDesc(),
        catalysts: ['Aging demographics', 'Cost management', 'Tech-enabled care'],
        risks: ['Healthcare policy changes', 'Medical cost trends', 'Regulatory pressure'],
        seasonality: currentMonth >= 9 && currentMonth <= 11 ? 'bullish' : 'neutral',
        sectorTrend: 'Managed care resilient'
      },
      // === ENERGY ===
      'XOM': {
        upcomingEvents: ['Production updates', 'Capital allocation', 'Shareholder returns'],
        earnings: getEarningsDesc(),
        catalysts: ['Oil demand stability', 'Dividend growth', 'Low-cost assets'],
        risks: ['Commodity price swings', 'Energy transition', 'Geopolitical factors'],
        seasonality: currentMonth >= 4 && currentMonth <= 8 ? 'bullish' : 'neutral',
        sectorTrend: 'Energy capital discipline'
      },
      // === CONSUMER ===
      'COST': {
        upcomingEvents: ['Membership trends', 'E-commerce growth', 'Store expansion'],
        earnings: getEarningsDesc(),
        catalysts: ['Member loyalty', 'Value proposition', 'Traffic growth'],
        risks: ['Consumer spending', 'Competition', 'Inflation impact'],
        seasonality: currentMonth >= 10 || currentMonth <= 1 ? 'bullish' : 'neutral',
        sectorTrend: 'Value retail strength'
      },
      'NKE': {
        upcomingEvents: ['Product launches', 'DTC progress', 'Innovation pipeline'],
        earnings: getEarningsDesc(),
        catalysts: ['Brand momentum', 'China trends', 'Category leadership'],
        risks: ['Inventory levels', 'Competition', 'Macro sensitivity'],
        seasonality: currentMonth >= 7 && currentMonth <= 9 ? 'bullish' : 'neutral',
        sectorTrend: 'Athletic wear normalizing'
      },
      // === CLOUD/SOFTWARE ===
      'CRM': {
        upcomingEvents: ['AI platform adoption', 'Product innovation', 'Enterprise deals'],
        earnings: getEarningsDesc(),
        catalysts: ['AI spending', 'Margin expansion', 'Platform growth'],
        risks: ['Enterprise budgets', 'Competition', 'Execution'],
        seasonality: 'neutral',
        sectorTrend: 'Enterprise AI transformation'
      },
      'PLTR': {
        upcomingEvents: ['Platform expansion', 'Contract wins', 'Commercial growth'],
        earnings: getEarningsDesc(),
        catalysts: ['AI differentiation', 'Government spending', 'International expansion'],
        risks: ['Valuation', 'Concentration', 'Profitability'],
        seasonality: 'neutral',
        sectorTrend: 'Defense and AI convergence'
      },
      // === EVs & CLEAN ENERGY ===
      'RIVN': {
        upcomingEvents: ['Production milestones', 'Partnership updates', 'Cost improvements'],
        earnings: getEarningsDesc(),
        catalysts: ['Platform efficiency', 'Delivery growth', 'Strategic partnerships'],
        risks: ['Cash management', 'Scaling challenges', 'Competition'],
        seasonality: 'neutral',
        sectorTrend: 'EV market consolidation'
      },
      'ENPH': {
        upcomingEvents: ['Policy clarity', 'Storage attach rates', 'International growth'],
        earnings: getEarningsDesc(),
        catalysts: ['Solar recovery', 'Storage expansion', 'Market share'],
        risks: ['Interest rates', 'Policy changes', 'Competition'],
        seasonality: currentMonth >= 2 && currentMonth <= 5 ? 'bullish' : 'neutral',
        sectorTrend: 'Solar demand recovering'
      }
    };

    // Get specific catalyst or return generic sector-based catalyst
    const stockCatalyst = catalystDB[symbol];

    if (stockCatalyst) {
      return stockCatalyst;
    }

    // Generic catalysts based on sector detection
    const sectorCatalysts = {
      tech: { catalysts: ['AI integration potential', 'Digital transformation demand'], risks: ['Valuation concerns', 'Rate sensitivity'], sectorTrend: 'Tech spending resilient' },
      finance: { catalysts: ['Higher rate environment', 'Credit growth'], risks: ['Credit quality concerns', 'Regulatory changes'], sectorTrend: 'Financials benefiting from rates' },
      healthcare: { catalysts: ['Aging demographics', 'Innovation pipeline'], risks: ['Drug pricing pressure', 'Regulatory risk'], sectorTrend: 'Healthcare defensive with growth' },
      energy: { catalysts: ['Supply discipline', 'Shareholder returns'], risks: ['Commodity volatility', 'Transition risk'], sectorTrend: 'Energy focused on capital returns' },
      consumer: { catalysts: ['Consumer resilience', 'Pricing power'], risks: ['Recession risk', 'Inflation impact'], sectorTrend: 'Consumer spending moderating' },
      industrial: { catalysts: ['Infrastructure spending', 'Reshoring trend'], risks: ['Economic cycle', 'Input costs'], sectorTrend: 'Industrial capex strong' },
      realestate: { catalysts: ['Rate cut potential', 'Demand recovery'], risks: ['Office vacancy', 'Rate sensitivity'], sectorTrend: 'Real estate awaiting rate relief' }
    };

    // Detect sector from symbol
    const techSymbols = ['AAPL', 'MSFT', 'NVDA', 'GOOGL', 'AMZN', 'META', 'AMD', 'INTC', 'CRM', 'ORCL', 'ADBE', 'NOW', 'PLTR', 'SNOW'];
    const financeSymbols = ['JPM', 'BAC', 'WFC', 'GS', 'MS', 'V', 'MA', 'PYPL', 'COIN', 'SCHW'];
    const healthSymbols = ['LLY', 'UNH', 'JNJ', 'PFE', 'MRK', 'ABBV', 'TMO', 'ABT'];
    const energySymbols = ['XOM', 'CVX', 'COP', 'SLB', 'OXY', 'EOG'];
    const consumerSymbols = ['COST', 'WMT', 'HD', 'NKE', 'SBUX', 'MCD', 'TGT', 'LOW'];

    if (techSymbols.includes(symbol)) return { ...sectorCatalysts.tech, generic: true };
    if (financeSymbols.includes(symbol)) return { ...sectorCatalysts.finance, generic: true };
    if (healthSymbols.includes(symbol)) return { ...sectorCatalysts.healthcare, generic: true };
    if (energySymbols.includes(symbol)) return { ...sectorCatalysts.energy, generic: true };
    if (consumerSymbols.includes(symbol)) return { ...sectorCatalysts.consumer, generic: true };

    // Default
    return { catalysts: ['Market momentum'], risks: ['General market risk'], sectorTrend: 'Mixed signals', generic: true };
  };

  // Daily Pick - Normalize pick data to prevent render crashes from missing/wrong-typed properties
  const normalizeDailyPick = (pick) => {
    if (!pick || typeof pick !== 'object') return null;
    const safe = { ...pick };
    // Ensure all top-level string/number properties have safe defaults
    safe.asset = safe.asset || safe.symbol || safe.ticker || 'N/A';
    safe.symbol = safe.symbol || safe.asset;
    safe.ticker = safe.ticker || safe.asset;
    safe.assetName = safe.assetName || safe.asset || 'Unknown';
    safe.assetType = safe.assetType || 'Stock';
    safe.direction = safe.direction || 'LONG';
    safe.recommendation = (typeof safe.recommendation === 'string') ? safe.recommendation : '';
    safe.confidence = typeof safe.confidence === 'number' ? safe.confidence : parseInt(safe.confidence) || 0;
    safe.currentPrice = safe.currentPrice || safe.entry || '0.00';
    safe.entry = safe.entry || '0.00';
    safe.stopLoss = safe.stopLoss || '0.00';
    safe.target1 = safe.target1 || '0.00';
    safe.target2 = safe.target2 || safe.target1 || '0.00';
    safe.riskReward = safe.riskReward || '1:1';
    safe.setup = safe.setup || 'Technical analysis setup';
    safe.keyReason = safe.keyReason || 'Technical signals detected';
    safe.technicalSignals = Array.isArray(safe.technicalSignals) ? safe.technicalSignals : [];
    safe.marketContext = safe.marketContext || '';
    safe.riskFactors = Array.isArray(safe.riskFactors) ? safe.riskFactors : ['General market risk'];
    safe.optimalEntry = safe.optimalEntry || 'Near current price';
    safe.invalidation = safe.invalidation || 'See stop loss level';
    safe.timeframe = safe.timeframe || 'Swing';
    safe.holdingPeriod = safe.holdingPeriod || '24-48 Hours';
    safe.marketSentiment = (typeof safe.marketSentiment === 'string') ? safe.marketSentiment : '';
    safe.liveDataTimestamp = safe.liveDataTimestamp || '';
    safe.livePricesFetched = safe.livePricesFetched || 0;
    // Normalize nested volatility object
    if (safe.volatility && typeof safe.volatility === 'object') {
      safe.volatility = {
        atrPercent: safe.volatility.atrPercent || '0',
        category: safe.volatility.category || 'Medium',
        preference: safe.volatility.preference || '',
        warning: safe.volatility.warning || null,
      };
    } else {
      safe.volatility = { atrPercent: '0', category: 'Medium', preference: '', warning: null };
    }
    // Normalize nested technicalData
    if (safe.technicalData && typeof safe.technicalData === 'object') {
      safe.technicalData = {
        rsi: safe.technicalData.rsi ?? 'N/A',
        macdHistogram: safe.technicalData.macdHistogram ?? '0',
        trend: safe.technicalData.trend || 'SIDEWAYS',
        aboveSMA20: safe.technicalData.aboveSMA20 ?? false,
        aboveSMA50: safe.technicalData.aboveSMA50 ?? false,
        bullishScore: safe.technicalData.bullishScore ?? 0,
        bearishScore: safe.technicalData.bearishScore ?? 0,
      };
    } else {
      safe.technicalData = { rsi: 'N/A', macdHistogram: '0', trend: 'SIDEWAYS', aboveSMA20: false, aboveSMA50: false, bullishScore: 0, bearishScore: 0 };
    }
    // Normalize nested expectedProfit
    if (safe.expectedProfit && typeof safe.expectedProfit === 'object') {
      const ep = safe.expectedProfit;
      safe.expectedProfit = {
        profitPerShare: ep.profitPerShare || '0.00',
        profitPercent: ep.profitPercent || '0.0',
        profitPerShareT2: ep.profitPerShareT2 || '0.00',
        profitPercentT2: ep.profitPercentT2 || '0.0',
        riskPerShare: ep.riskPerShare || '0.00',
        riskPercent: ep.riskPercent || '0.0',
        winProbability: ep.winProbability ?? 50,
        expectedValuePercent: ep.expectedValuePercent || '0.00',
        exampleAccount: ep.exampleAccount || 10000,
        exampleRiskPercent: ep.exampleRiskPercent || 2,
        exampleShares: ep.exampleShares || 0,
        examplePositionValue: ep.examplePositionValue || '0.00',
        exampleExpectedProfit: ep.exampleExpectedProfit || '0.00',
        exampleMaxLoss: ep.exampleMaxLoss || '0.00',
      };
    } else {
      safe.expectedProfit = null;
    }
    // Normalize nested catalystData
    if (safe.catalystData && typeof safe.catalystData === 'object') {
      const cd = safe.catalystData;
      safe.catalystData = {
        catalysts: Array.isArray(cd.catalysts) ? cd.catalysts : [],
        risks: Array.isArray(cd.risks) ? cd.risks : [],
        upcomingEvents: Array.isArray(cd.upcomingEvents) ? cd.upcomingEvents : [],
        earnings: cd.earnings || null,
        sectorTrend: cd.sectorTrend || null,
        seasonality: cd.seasonality || null,
        catalystBonus: cd.catalystBonus || 0,
      };
    } else {
      safe.catalystData = null;
    }
    // Normalize otherCandidates
    safe.otherCandidates = Array.isArray(safe.otherCandidates) ? safe.otherCandidates : [];
    return safe;
  };

  // Daily Pick Generation
  // Daily Pick - FETCHES LIVE DATA AND CALCULATES REAL TECHNICAL INDICATORS
  const fetchDailyPick = async (forceRefresh = false) => {
    setLoadingPick(true);
    setDailyPickError(null);
    setAnalysisError(null);

    try {
      const today = currentTime.toLocaleDateString("en-US", { weekday: "long", month: "long", day: "numeric", year: "numeric" });
      const timeNow = currentTime.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" });

      // CHECK CACHE FIRST - avoid regenerating same pick (30 min cache)
      const cacheKey = `modus_daily_pick_${pickTimeframe}_${pickVolatility}`;
      const cached = localStorage.getItem(cacheKey);
      if (cached && !forceRefresh) {
        try {
          const { pick, timestamp, date } = JSON.parse(cached);
          const cacheAge = Date.now() - timestamp;
          const sameDay = date === new Date().toDateString();
          // Cache valid for 15 minutes on same day
          if (sameDay && cacheAge < 15 * 60 * 1000) {
            console.log('[Daily Pick] ⚡ Using cached pick (age: ' + Math.round(cacheAge/60000) + 'min)');
            setDailyPick(normalizeDailyPick(pick));
            setDailyPickProgress({ phase: 'complete', current: pick.scannedCount || 200, total: pick.scannedCount || 200, scanTime: 0 });
            setLoadingPick(false);
            return;
          }
        } catch (e) { /* Invalid cache, regenerate */ }
      }

      // TIMEFRAME CONFIG - adjusts stops/targets based on holding period
      // Now includes recommended Live Ticker timeframe for viewing the stock
      const timeframeConfig = {
        "5-7h": { label: "5-7 Hours", category: "Short", style: "Day Trade", stopPct: -1.0, target1Pct: 1.5, target2Pct: 2.5, liveTimeframe: "5m", liveTimeframeLabel: "5-Minute" },
        "12-24h": { label: "12-24 Hours", category: "Short", style: "Day Trade", stopPct: -1.5, target1Pct: 2.0, target2Pct: 3.5, liveTimeframe: "15m", liveTimeframeLabel: "15-Minute" },
        "24-48h": { label: "24-48 Hours", category: "Short", style: "Overnight Swing", stopPct: -2.0, target1Pct: 3.0, target2Pct: 5.0, liveTimeframe: "30m", liveTimeframeLabel: "30-Minute" },
        "3-5d": { label: "3-5 Days", category: "Medium", style: "Swing Trade", stopPct: -3.0, target1Pct: 5.0, target2Pct: 8.0, liveTimeframe: "1h", liveTimeframeLabel: "1-Hour" },
        "5-7d": { label: "5-7 Days", category: "Medium", style: "Extended Swing", stopPct: -4.0, target1Pct: 7.0, target2Pct: 12.0, liveTimeframe: "4h", liveTimeframeLabel: "4-Hour" },
        "1-2w": { label: "1-2 Weeks", category: "Long", style: "Position Trade", stopPct: -5.0, target1Pct: 8.0, target2Pct: 15.0, liveTimeframe: "1d", liveTimeframeLabel: "Daily" },
        "3-4w": { label: "3-4 Weeks", category: "Long", style: "Extended Position", stopPct: -7.0, target1Pct: 12.0, target2Pct: 20.0, liveTimeframe: "1d", liveTimeframeLabel: "Daily" }
      };
      
      const tfConfig = timeframeConfig[pickTimeframe] || timeframeConfig["24-48h"];

      // STEP 1: COMPREHENSIVE PARALLEL SCREENING using all 200+ stocks
      console.log("[Daily Pick] 🚀 Comprehensive parallel screening starting...");
      const startTime = Date.now();
      setDailyPickProgress({ phase: 'starting', current: 0, total: PRIORITY_STOCKS.length });

      // Scan ALL stocks for the best daily pick
      const quickResults = await processStocksInParallel(
        PRIORITY_STOCKS,
        analyzeStockFast,
        {
          batchSize: 15,      // Process 15 at a time for reliability
          maxResults: 30,     // Get top 30 candidates
          minScore: 0,        // Don't filter by score
          timeout: 4000,      // 4s timeout per stock
          onProgress: (progress) => {
            setDailyPickProgress({ phase: 'scanning', current: progress.current, total: progress.total });
          }
        }
      );

      const elapsed = ((Date.now() - startTime)/1000).toFixed(1);
      setDailyPickProgress({ phase: 'complete', current: PRIORITY_STOCKS.length, total: PRIORITY_STOCKS.length, scanTime: parseFloat(elapsed) });

      console.log(`[Daily Pick] ⚡ Comprehensive screen: ${quickResults.length} stocks analyzed in ${elapsed}s`);

      // If we have results, process them
      if (quickResults.length > 0) {
        // Filter for actionable picks first
        let stockAnalyses = quickResults.filter(s =>
          s && s.symbol && s.currentPrice && s.normalizedScore !== undefined
        );

        // Prefer actionable recommendations (BUY/SELL over HOLD)
        const actionableStocks = stockAnalyses.filter(s =>
          s.recommendation && !['HOLD', 'WAIT'].includes(s.recommendation)
        );
        if (actionableStocks.length > 0) {
          stockAnalyses = actionableStocks;
        }

        console.log(`[Daily Pick] Found ${stockAnalyses.length} valid stocks (${actionableStocks.length} actionable)`);

        if (stockAnalyses.length === 0) {
          console.log("[Daily Pick] No valid stocks after filtering, falling back...");
        } else {
          const volConfig = volatilityThresholds[pickVolatility] || volatilityThresholds.medium;

          // Apply volatility filter if not "any"
          let filteredAnalyses = stockAnalyses;
          if (pickVolatility !== 'any') {
            filteredAnalyses = stockAnalyses.filter(s => {
              const atrPct = parseFloat(s.atrPercent) || (Math.abs(s.changePercent || 0) * 0.5);
              return atrPct >= volConfig.min && atrPct <= volConfig.max;
            });
            if (filteredAnalyses.length < 3) filteredAnalyses = stockAnalyses;
          }

          // Find best pick
          const bestPick = filteredAnalyses[0];

        // Build the pick object
        const direction = bestPick.direction;
        const entry = bestPick.currentPrice;

        // Calculate stops/targets based on timeframe
        const stopPct = direction === 'LONG' ? tfConfig.stopPct : -tfConfig.stopPct;
        const target1Pct = direction === 'LONG' ? tfConfig.target1Pct : -tfConfig.target1Pct;
        const target2Pct = direction === 'LONG' ? tfConfig.target2Pct : -tfConfig.target2Pct;

        const stopLoss = entry * (1 + stopPct / 100);
        const target1 = entry * (1 + target1Pct / 100);
        const target2 = entry * (1 + target2Pct / 100);

        const riskPerShare = Math.abs(entry - stopLoss);
        const rewardPerShare = Math.abs(target1 - entry);
        const riskRewardRatio = riskPerShare > 0 ? (rewardPerShare / riskPerShare).toFixed(2) : '1.50';

        let recommendation;
        if (bestPick.normalizedScore >= 75) recommendation = direction === 'LONG' ? 'STRONG_BUY' : 'STRONG_SELL';
        else if (bestPick.normalizedScore >= 60) recommendation = direction === 'LONG' ? 'BUY' : 'SELL';
        else recommendation = direction === 'LONG' ? 'LEAN_BUY' : 'LEAN_SELL';

        const catalystData = getStockCatalysts(bestPick.symbol);

        const pick = {
          asset: bestPick.symbol,
          symbol: bestPick.symbol,
          ticker: bestPick.symbol,
          assetName: bestPick.symbol,
          assetType: 'Stock',
          direction: direction,
          recommendation: recommendation,
          confidence: bestPick.confidence,
          currentPrice: entry.toFixed(2),
          entry: entry.toFixed(2),
          stopLoss: stopLoss.toFixed(2),
          target1: target1.toFixed(2),
          target2: target2.toFixed(2),
          riskReward: `1:${riskRewardRatio}`,
          setup: `${bestPick.trend || 'SIDEWAYS'} momentum with ${(bestPick.signals && bestPick.signals[0]) || 'technical signal'}`,
          keyReason: `${bestPick.symbol} showing ${direction === 'LONG' ? 'bullish' : 'bearish'} signals: ${(bestPick.signals || ['Technical analysis']).slice(0,3).join(', ')}`,
          technicalSignals: (bestPick.signals || ['RSI', 'MACD', 'Trend']).slice(0, 5),
          marketContext: `Score: ${bestPick.normalizedScore.toFixed(0)}/100 | RSI: ${bestPick.rsi?.toFixed(1)} | Trend: ${bestPick.trend}`,
          riskFactors: catalystData.risks || ['General market risk', 'Position sizing key'],
          optimalEntry: `Near current price $${entry.toFixed(2)}`,
          invalidation: `${direction === 'LONG' ? 'Below' : 'Above'} $${stopLoss.toFixed(2)}`,
          timeframe: tfConfig.style,
          holdingPeriod: tfConfig.label,
          recommendedLiveTimeframe: tfConfig.liveTimeframe,
          recommendedLiveTimeframeLabel: tfConfig.liveTimeframeLabel,
          generatedWithLiveData: true,
          livePricesFetched: PRIORITY_STOCKS.length,
          marketSentiment: bestPick.bullishScore > bestPick.bearishScore + 10 ? 'bullish' : bestPick.bearishScore > bestPick.bullishScore + 10 ? 'bearish' : 'neutral',
          liveDataTimestamp: new Date().toLocaleTimeString(),
          technicalData: {
            rsi: bestPick.rsi?.toFixed(1) || 'N/A',
            macdHistogram: bestPick.macdHistogram?.toFixed(4) || '0',
            trend: bestPick.trend,
            aboveSMA20: bestPick.aboveSMA20,
            aboveSMA50: bestPick.aboveSMA50,
            bullishScore: bestPick.bullishScore,
            bearishScore: bestPick.bearishScore
          },
          expectedProfit: {
            profitPerShare: rewardPerShare.toFixed(2),
            profitPercent: target1Pct.toFixed(1),
            profitPerShareT2: Math.abs(target2 - entry).toFixed(2),
            profitPercentT2: target2Pct.toFixed(1),
            riskPerShare: riskPerShare.toFixed(2),
            riskPercent: Math.abs(stopPct).toFixed(1),
            winProbability: Math.min(70, Math.round(bestPick.normalizedScore * 0.8)),
            expectedValuePercent: ((bestPick.normalizedScore * 0.8 / 100) * target1Pct - (1 - bestPick.normalizedScore * 0.8 / 100) * Math.abs(stopPct)).toFixed(2),
            exampleAccount: 10000,
            exampleRiskPercent: 2,
            exampleShares: Math.floor(200 / riskPerShare),
            examplePositionValue: (Math.floor(200 / riskPerShare) * entry).toFixed(2),
            exampleExpectedProfit: (Math.floor(200 / riskPerShare) * rewardPerShare).toFixed(2),
            exampleMaxLoss: '200.00'
          },
          volatility: {
            atrPercent: bestPick.atrPercent || (Math.abs(bestPick.changePercent || 0) * 0.5).toFixed(2),
            category: parseFloat(bestPick.atrPercent) < 1.5 ? 'Low' :
                      parseFloat(bestPick.atrPercent) < 2.5 ? 'Low-Medium' :
                      parseFloat(bestPick.atrPercent) < 4 ? 'Medium' :
                      parseFloat(bestPick.atrPercent) < 6 ? 'Medium-High' : 'High',
            preference: volConfig.label,
            warning: null
          },
          catalystData: {
            catalysts: catalystData.catalysts || [],
            risks: catalystData.risks || [],
            upcomingEvents: catalystData.upcomingEvents || [],
            earnings: catalystData.earnings,
            sectorTrend: catalystData.sectorTrend,
            seasonality: catalystData.seasonality,
            catalystBonus: bestPick.catalystBonus || 0
          },
          otherCandidates: filteredAnalyses.slice(1, 6).map(s => ({
            symbol: s.symbol,
            direction: s.direction,
            score: s.normalizedScore?.toFixed(0),
            rsi: s.rsi?.toFixed(0)
          }))
        };

        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        console.log(`[Daily Pick] ✅ FAST: ${pick.direction} ${pick.asset} @ $${entry.toFixed(2)} in ${elapsed}s`);

        // Save to cache
        const cacheKey = `modus_daily_pick_${pickTimeframe}_${pickVolatility}`;
        localStorage.setItem(cacheKey, JSON.stringify({
          pick,
          timestamp: Date.now(),
          date: new Date().toDateString()
        }));

        setDailyPick(normalizeDailyPick(pick));
        setLastPickTime(new Date());
        setToast({ type: 'success', message: `✅ Found top pick: ${pick.asset} (${pick.direction})` });
        setLoadingPick(false);
        return; // Skip legacy slow analysis
        }  // end else (stockAnalyses.length > 0)
      }  // end if (quickResults.length > 0)

      // FALLBACK: Legacy slow analysis (only if fast scan fails)
      console.log("[Daily Pick] ⚠️ Fast scan found no results, falling back to detailed analysis...");
      const candidates = PRIORITY_STOCKS.slice(0, 50); // Use only top 50 for fallback

      // Legacy candidate list for fallback (reduced)
      const legacyCandidates = [
        'AAPL', 'MSFT', 'NVDA', 'GOOGL', 'AMZN', 'META', 'TSLA', 'AMD', 'NFLX', 'COIN',
        'PLTR', 'SOFI', 'NIO', 'RIVN', 'F', 'GM', 'BA', 'DIS', 'PYPL', 'JPM',
        'V', 'MA', 'UNH', 'JNJ', 'XOM', 'CVX', 'WMT', 'COST', 'HD', 'MCD',
        'UBER', 'LYFT', 'DASH', 'ABNB', 'CRM', 'ADBE', 'INTC', 'MU', 'QCOM', 'AVGO'
      ];

      // Continue with legacy analysis below (kept for compatibility)
      const candidatesLegacy = [
        // Most Active - analyze these first
        'NVDA', 'TSLA', 'AAPL', 'AMD', 'META', 'MSFT', 'AMZN', 'GOOGL', 'NFLX', 'COIN',
        'EXPE', 'BKNG', 'MAR', 'HLT', 'H', 'WH', 'WYNN', 'LVS', 'CZR', 'RCL',
        'CCL', 'NCLH', 'DAL', 'UAL', 'LUV', 'AAL', 'ALK', 'JBLU', 'SAVE', 'HA',
        // Industrial & Aerospace
        'BA', 'CAT', 'DE', 'GE', 'HON', 'MMM', 'UPS', 'FDX', 'LMT', 'RTX',
        'NOC', 'GD', 'TDG', 'HWM', 'TXT', 'EMR', 'ETN', 'ITW', 'PH', 'ROK',
        'AME', 'DOV', 'IR', 'XYL', 'GNRC', 'CARR', 'OTIS', 'JCI', 'TT', 'LII',
        // Materials & Mining
        'FCX', 'NEM', 'GOLD', 'AEM', 'NUE', 'STLD', 'CLF', 'X', 'AA', 'CENX',
        'MP', 'LAC', 'ALB', 'SQM', 'LTHM', 'CC', 'SMG', 'FMC', 'CF', 'MOS',
        // Real Estate
        'AMT', 'PLD', 'CCI', 'EQIX', 'PSA', 'SPG', 'O', 'WELL', 'AVB', 'EQR',
        'DLR', 'ARE', 'VTR', 'BXP', 'SLG', 'VNO', 'KIM', 'REG', 'FRT', 'HST',
        // Telecom & Media
        'T', 'VZ', 'TMUS', 'CHTR', 'LBRDK', 'SIRI', 'LUMN', 'FYBR', 'USM', 'ATUS',
        // ETFs (Market Context)
        'SPY', 'QQQ', 'DIA', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB',
        'XLY', 'XLP', 'XLU', 'XLRE', 'XLC', 'ARKK', 'ARKG', 'ARKF', 'ARKW', 'ARKQ',
        'SOXX', 'SMH', 'KWEB', 'FXI', 'EEM', 'EFA', 'VWO', 'GDX', 'SLV', 'GLD'
      ];
      const stockAnalyses = [];

      // Helper: Calculate RSI with Wilder's smoothing
      const calculateRSI = (closes, period = 14) => {
        if (closes.length < period + 1) return null;
        let gains = [], losses = [];
        for (let i = 1; i < closes.length; i++) {
          const change = closes[i] - closes[i - 1];
          gains.push(change > 0 ? change : 0);
          losses.push(change < 0 ? Math.abs(change) : 0);
        }
        let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
        let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
        for (let i = period; i < gains.length; i++) {
          avgGain = (avgGain * (period - 1) + gains[i]) / period;
          avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
        }
        if (avgLoss === 0) return 100;
        const rs = avgGain / avgLoss;
        return 100 - (100 / (1 + rs));
      };
      
      // Helper: Calculate EMA
      const calculateEMA = (data, period) => {
        const k = 2 / (period + 1);
        let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
        const result = [ema];
        for (let i = period; i < data.length; i++) {
          ema = data[i] * k + ema * (1 - k);
          result.push(ema);
        }
        return result;
      };
      
      // Helper: Calculate SMA
      const calculateSMA = (data, period) => {
        const result = [];
        for (let i = period - 1; i < data.length; i++) {
          const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
          result.push(sum / period);
        }
        return result;
      };
      
      // Fetch and analyze each candidate
      for (const symbol of candidates) {
        try {
          // Fetch chart data using Yahoo Finance with proxy helper
          const interval = '5m';
          const range = '5d';
          const baseUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${range}`;
          
          const data = await fetchYahooWithProxies(baseUrl);
          let chartData = data?.chart?.result?.[0] || null;
          
          if (!chartData || !chartData.timestamp) continue;
          
          const timestamps = chartData.timestamp;
          const quote = chartData.indicators?.quote?.[0];
          const meta = chartData.meta;
          
          if (!quote || timestamps.length < 50) continue;
          
          // Extract valid OHLCV data
          const bars = [];
          for (let i = 0; i < timestamps.length; i++) {
            if (quote.close?.[i] && !isNaN(quote.close[i])) {
              bars.push({
                open: quote.open?.[i] || quote.close[i],
                high: quote.high?.[i] || quote.close[i],
                low: quote.low?.[i] || quote.close[i],
                close: quote.close[i],
                volume: quote.volume?.[i] || 0
              });
            }
          }
          
          if (bars.length < 50) continue;
          
          const closes = bars.map(b => b.close);
          const currentPrice = meta.regularMarketPrice || closes[closes.length - 1];
          const prevClose = meta.chartPreviousClose || meta.previousClose || closes[0];
          const changePercent = ((currentPrice - prevClose) / prevClose) * 100;
          
          // Calculate REAL indicators
          const rsi = calculateRSI(closes, 14);
          const sma20 = calculateSMA(closes, 20);
          const sma50 = calculateSMA(closes, 50);
          const ema12 = calculateEMA(closes, 12);
          const ema26 = calculateEMA(closes, 26);
          
          // MACD calculation
          const macdLine = ema12.slice(ema12.length - ema26.length).map((v, i) => v - ema26[i]);
          const signalLine = calculateEMA(macdLine, 9);
          const currentMACD = macdLine[macdLine.length - 1];
          const currentSignal = signalLine[signalLine.length - 1];
          const macdHistogram = currentMACD - currentSignal;
          
          // Volume analysis
          const recentVolume = bars.slice(-5).reduce((sum, b) => sum + b.volume, 0) / 5;
          const avgVolume = bars.slice(-20).reduce((sum, b) => sum + b.volume, 0) / 20;
          const volumeRatio = recentVolume / avgVolume;
          
          // Price vs MAs
          const currentSMA20 = sma20[sma20.length - 1];
          const currentSMA50 = sma50.length > 0 ? sma50[sma50.length - 1] : null;
          const aboveSMA20 = currentPrice > currentSMA20;
          const aboveSMA50 = currentSMA50 ? currentPrice > currentSMA50 : null;
          
          // Trend detection (last 20 bars)
          const recentBars = bars.slice(-20);
          const highs = recentBars.map(b => b.high);
          const lows = recentBars.map(b => b.low);
          const highSlope = (highs[highs.length - 1] - highs[0]) / highs[0] * 100;
          const lowSlope = (lows[lows.length - 1] - lows[0]) / lows[0] * 100;
          const trend = highSlope > 1 && lowSlope > 1 ? 'UPTREND' : 
                        highSlope < -1 && lowSlope < -1 ? 'DOWNTREND' : 'SIDEWAYS';
          
          // ====== ENHANCED TECHNICAL ANALYSIS SCORING ======
          let bullishScore = 50; // Start neutral
          let bearishScore = 50;
          const signals = [];

          // Calculate additional indicators
          // Bollinger Bands
          const bbPeriod = 20;
          const bbStdDev = 2;
          const bbSMA = sma20[sma20.length - 1];
          const recentCloses = closes.slice(-bbPeriod);
          const stdDev = Math.sqrt(recentCloses.reduce((sum, c) => sum + Math.pow(c - bbSMA, 2), 0) / bbPeriod);
          const upperBand = bbSMA + (bbStdDev * stdDev);
          const lowerBand = bbSMA - (bbStdDev * stdDev);
          const bbPosition = ((currentPrice - lowerBand) / (upperBand - lowerBand)) * 100; // 0 = lower band, 100 = upper band

          // ATR for volatility
          const atrPeriod = 14;
          let trueRanges = [];
          for (let i = 1; i < Math.min(bars.length, atrPeriod + 1); i++) {
            const tr = Math.max(
              bars[i].high - bars[i].low,
              Math.abs(bars[i].high - bars[i-1].close),
              Math.abs(bars[i].low - bars[i-1].close)
            );
            trueRanges.push(tr);
          }
          const atr = trueRanges.reduce((a, b) => a + b, 0) / trueRanges.length;
          const atrPercent = (atr / currentPrice) * 100;

          // Momentum (Rate of Change)
          const rocPeriod = 10;
          const roc = closes.length > rocPeriod
            ? ((closes[closes.length - 1] - closes[closes.length - 1 - rocPeriod]) / closes[closes.length - 1 - rocPeriod]) * 100
            : 0;

          // RSI Divergence Detection
          let rsiDivergence = 'none';
          if (closes.length > 30 && rsi !== null) {
            const priceHigh1 = Math.max(...closes.slice(-15));
            const priceHigh2 = Math.max(...closes.slice(-30, -15));
            const rsiValues = [];
            for (let i = closes.length - 30; i < closes.length; i++) {
              const subCloses = closes.slice(0, i + 1);
              const subRsi = calculateRSI(subCloses, 14);
              if (subRsi !== null) rsiValues.push(subRsi);
            }
            if (rsiValues.length >= 15) {
              const rsiHigh1 = Math.max(...rsiValues.slice(-15));
              const rsiHigh2 = Math.max(...rsiValues.slice(0, 15));
              if (priceHigh1 > priceHigh2 && rsiHigh1 < rsiHigh2) rsiDivergence = 'bearish';
              if (priceHigh1 < priceHigh2 && rsiHigh1 > rsiHigh2) rsiDivergence = 'bullish';
            }
          }

          // ====== SCORING SYSTEM (More Nuanced) ======

          // RSI scoring - with reversal detection
          if (rsi !== null) {
            if (rsi < 25) { bullishScore += 18; signals.push(`🔥 RSI extremely oversold (${rsi.toFixed(1)})`); }
            else if (rsi < 35) { bullishScore += 12; signals.push(`RSI oversold (${rsi.toFixed(1)})`); }
            else if (rsi < 45) { bullishScore += 5; signals.push(`RSI low-neutral (${rsi.toFixed(1)})`); }
            else if (rsi > 75) { bearishScore += 18; signals.push(`🔥 RSI extremely overbought (${rsi.toFixed(1)})`); }
            else if (rsi > 65) { bearishScore += 12; signals.push(`RSI overbought (${rsi.toFixed(1)})`); }
            else if (rsi > 55) { bearishScore += 5; signals.push(`RSI high-neutral (${rsi.toFixed(1)})`); }
          }

          // RSI Divergence scoring
          if (rsiDivergence === 'bullish') { bullishScore += 15; signals.push('🔄 Bullish RSI divergence'); }
          else if (rsiDivergence === 'bearish') { bearishScore += 15; signals.push('🔄 Bearish RSI divergence'); }

          // MACD scoring - with crossover detection
          if (macdHistogram > 0 && currentMACD > 0) {
            bullishScore += 15;
            signals.push('✅ MACD bullish + positive histogram');
          } else if (macdHistogram > 0 && macdHistogram > (closes[closes.length - 2] || 0) * 0.001) {
            bullishScore += 12;
            signals.push('MACD histogram expanding bullish');
          } else if (macdHistogram > 0) {
            bullishScore += 8;
            signals.push('MACD histogram positive');
          } else if (macdHistogram < 0 && currentMACD < 0) {
            bearishScore += 15;
            signals.push('⛔ MACD bearish + negative histogram');
          } else if (macdHistogram < 0) {
            bearishScore += 10;
            signals.push('MACD histogram negative');
          }

          // Bollinger Band scoring
          if (bbPosition < 10) { bullishScore += 12; signals.push('📉 Price at lower Bollinger Band (oversold)'); }
          else if (bbPosition < 25) { bullishScore += 6; signals.push('Price near lower BB'); }
          else if (bbPosition > 90) { bearishScore += 12; signals.push('📈 Price at upper Bollinger Band (overbought)'); }
          else if (bbPosition > 75) { bearishScore += 6; signals.push('Price near upper BB'); }

          // Momentum (ROC) scoring
          if (roc > 3) { bullishScore += 10; signals.push(`🚀 Strong momentum (+${roc.toFixed(1)}%)`); }
          else if (roc > 1) { bullishScore += 5; signals.push(`Positive momentum (+${roc.toFixed(1)}%)`); }
          else if (roc < -3) { bearishScore += 10; signals.push(`📉 Negative momentum (${roc.toFixed(1)}%)`); }
          else if (roc < -1) { bearishScore += 5; signals.push(`Weak momentum (${roc.toFixed(1)}%)`); }

          // MA scoring - with golden/death cross detection
          const smaGoldenCross = currentSMA20 && currentSMA50 && currentSMA20 > currentSMA50;
          if (aboveSMA20 && aboveSMA50) {
            bullishScore += 15;
            signals.push('✅ Price above both MAs');
          } else if (aboveSMA20) {
            bullishScore += 8;
            signals.push('Price above SMA20');
          } else if (!aboveSMA20 && !aboveSMA50) {
            bearishScore += 15;
            signals.push('⛔ Price below both MAs');
          } else {
            bearishScore += 8;
            signals.push('Price below SMA20');
          }

          if (smaGoldenCross) { bullishScore += 8; signals.push('🌟 Golden cross (SMA20 > SMA50)'); }
          else if (currentSMA20 && currentSMA50 && currentSMA20 < currentSMA50) { bearishScore += 8; signals.push('☠️ Death cross (SMA20 < SMA50)'); }

          // Trend scoring - stronger weighting
          if (trend === 'UPTREND') { bullishScore += 18; signals.push('📈 Confirmed uptrend'); }
          else if (trend === 'DOWNTREND') { bearishScore += 18; signals.push('📉 Confirmed downtrend'); }
          else { signals.push('↔️ Sideways/choppy'); }

          // Volume scoring - more detailed
          if (volumeRatio > 1.5 && changePercent > 1) { bullishScore += 15; signals.push('🔥 High volume breakout'); }
          else if (volumeRatio > 1.2 && changePercent > 0) { bullishScore += 8; signals.push('Volume confirms up move'); }
          else if (volumeRatio > 1.5 && changePercent < -1) { bearishScore += 15; signals.push('🔥 High volume breakdown'); }
          else if (volumeRatio > 1.2 && changePercent < 0) { bearishScore += 8; signals.push('Volume confirms down move'); }
          else if (volumeRatio < 0.7) { signals.push('⚠️ Low volume (weak conviction)'); }

          // Volatility filter
          if (atrPercent > 3) { signals.push(`⚠️ High volatility (ATR: ${atrPercent.toFixed(1)}%)`); }
          else if (atrPercent < 1) { signals.push(`Low volatility (ATR: ${atrPercent.toFixed(1)}%)`); }
          
          // Determine direction and calculate UNIFIED score (0-100 scale)
          const direction = bullishScore > bearishScore ? 'LONG' : 'SHORT';
          const netScore = direction === 'LONG' ? bullishScore - bearishScore : bearishScore - bullishScore;

          // UNIFIED SCORING SYSTEM (matches main analyzer)
          // Convert netScore to 0-100 scale for consistent recommendations
          // Max possible netScore is ~80 (if all indicators align perfectly)
          const normalizedScore = Math.min(100, Math.max(0, 50 + (netScore * 1.2)));

          // UNIFIED RECOMMENDATION (same thresholds as main analyzer)
          let recommendation;
          if (normalizedScore >= 75) {
            recommendation = direction === 'LONG' ? 'STRONG_BUY' : 'STRONG_SELL';
          } else if (normalizedScore >= 60) {
            recommendation = direction === 'LONG' ? 'BUY' : 'SELL';
          } else if (normalizedScore >= 45) {
            recommendation = 'HOLD';
          } else if (normalizedScore >= 30) {
            recommendation = direction === 'LONG' ? 'SPECULATIVE_LONG' : 'SPECULATIVE_SHORT';
          } else {
            recommendation = 'WAIT';
          }

          // Calculate confidence (calibrated to match main analyzer)
          const confidence = Math.min(95, Math.round(normalizedScore));

          // GET REAL-WORLD CATALYSTS for this stock
          const catalystData = getStockCatalysts(symbol);

          // Adjust score based on catalysts/seasonality
          let catalystBonus = 0;
          if (catalystData.seasonality === 'bullish' && direction === 'LONG') catalystBonus += 5;
          if (catalystData.seasonality === 'bullish' && direction === 'SHORT') catalystBonus -= 3;
          if (catalystData.earnings) catalystBonus += 3; // Earnings coming up adds volatility opportunity
          if (catalystData.upcomingEvents?.length > 0) catalystBonus += 2;

          const adjustedScore = Math.min(100, normalizedScore + catalystBonus);
          const adjustedConfidence = Math.min(95, Math.round(adjustedScore));

          stockAnalyses.push({
            symbol,
            currentPrice,
            changePercent,
            rsi,
            macd: currentMACD,
            macdSignal: currentSignal,
            macdHistogram,
            aboveSMA20,
            aboveSMA50,
            trend,
            volumeRatio,
            bullishScore,
            bearishScore,
            direction,
            netScore,
            normalizedScore: adjustedScore, // 0-100 scale (adjusted for catalysts)
            recommendation,  // STRONG_BUY, BUY, HOLD, SELL, STRONG_SELL, etc.
            signals,
            confidence: adjustedConfidence,
            // New indicators for transparency
            bbPosition: bbPosition.toFixed(1),
            atrPercent: atrPercent.toFixed(2),
            roc: roc.toFixed(2),
            rsiDivergence,
            // CATALYST DATA
            catalysts: catalystData.catalysts || [],
            risks: catalystData.risks || [],
            upcomingEvents: catalystData.upcomingEvents || [],
            earnings: catalystData.earnings,
            sectorTrend: catalystData.sectorTrend,
            seasonality: catalystData.seasonality,
            catalystBonus
          });

          console.log(`[Daily Pick] ✓ ${symbol}: ${direction} (Bull:${bullishScore} Bear:${bearishScore}) Catalyst:+${catalystBonus}`);
          
        } catch (e) {
          console.log(`[Daily Pick] ✗ ${symbol}: ${e.message}`);
        }
      }
      
      if (stockAnalyses.length === 0) {
        throw new Error("Could not fetch data for any stocks");
      }

      // STEP 2: Filter by volatility preference
      const volConfig = volatilityThresholds[pickVolatility] || volatilityThresholds.any;
      let filteredAnalyses = stockAnalyses.filter(s => {
        const atr = parseFloat(s.atrPercent);
        return atr >= volConfig.min && atr <= volConfig.max;
      });

      // If no stocks match volatility filter, fall back to all stocks with a warning
      let volatilityWarning = null;
      if (filteredAnalyses.length === 0) {
        filteredAnalyses = stockAnalyses;
        volatilityWarning = `No stocks matched ${volConfig.label} criteria. Showing best available pick.`;
        console.log(`[Daily Pick] ⚠️ ${volatilityWarning}`);
      } else {
        console.log(`[Daily Pick] ✓ ${filteredAnalyses.length} stocks match ${volConfig.label} filter`);
      }

      // STEP 3: Pick the best stock based on highest net score
      filteredAnalyses.sort((a, b) => b.netScore - a.netScore);
      const bestPick = filteredAnalyses[0];
      
      console.log(`[Daily Pick] 🏆 Best pick: ${bestPick.symbol} (${bestPick.direction}) Score: ${bestPick.netScore}`);
      
      // Calculate entry/stop/targets based on direction
      const isLong = bestPick.direction === 'LONG';
      const entry = bestPick.currentPrice;
      const stopPct = isLong ? tfConfig.stopPct : -tfConfig.stopPct;
      const target1Pct = isLong ? tfConfig.target1Pct : -tfConfig.target1Pct;
      const target2Pct = isLong ? tfConfig.target2Pct : -tfConfig.target2Pct;
      
      const stop = entry * (1 + stopPct / 100);
      const t1 = entry * (1 + target1Pct / 100);
      const t2 = entry * (1 + target2Pct / 100);
      
      // Build technical reasoning
      const technicalSignals = bestPick.signals.slice(0, 5);
      const keyReason = isLong 
        ? `${bestPick.trend === 'UPTREND' ? 'Strong uptrend with ' : ''}${bestPick.rsi < 40 ? 'oversold RSI bouncing' : bestPick.macdHistogram > 0 ? 'bullish MACD momentum' : 'price above key MAs'}`
        : `${bestPick.trend === 'DOWNTREND' ? 'Confirmed downtrend with ' : ''}${bestPick.rsi > 60 ? 'overbought RSI reversing' : bestPick.macdHistogram < 0 ? 'bearish MACD momentum' : 'price below key MAs'}`;
      
      const riskFactors = [];
      if (bestPick.rsi > 65 && isLong) riskFactors.push('RSI approaching overbought');
      if (bestPick.rsi < 35 && !isLong) riskFactors.push('RSI approaching oversold');
      if (bestPick.trend === 'SIDEWAYS') riskFactors.push('Choppy/sideways market');
      if (Math.abs(bestPick.changePercent) > 3) riskFactors.push('Large recent price move');
      if (riskFactors.length === 0) riskFactors.push('Standard market risk');
      
      const assetNames = {
        // Major Tech
        'AAPL': 'Apple Inc', 'MSFT': 'Microsoft', 'NVDA': 'NVIDIA', 'GOOGL': 'Alphabet', 'AMZN': 'Amazon',
        'META': 'Meta Platforms', 'TSLA': 'Tesla', 'AMD': 'AMD', 'INTC': 'Intel', 'AVGO': 'Broadcom',
        'CRM': 'Salesforce', 'ORCL': 'Oracle', 'ADBE': 'Adobe', 'CSCO': 'Cisco', 'QCOM': 'Qualcomm',
        'TXN': 'Texas Instruments', 'IBM': 'IBM', 'NOW': 'ServiceNow', 'AMAT': 'Applied Materials', 'MU': 'Micron',
        'LRCX': 'Lam Research', 'ADI': 'Analog Devices', 'KLAC': 'KLA Corp', 'SNPS': 'Synopsys', 'CDNS': 'Cadence',
        'MRVL': 'Marvell Tech', 'NXPI': 'NXP Semi', 'ON': 'ON Semiconductor', 'MCHP': 'Microchip', 'SWKS': 'Skyworks',
        // Consumer & Retail
        'NFLX': 'Netflix', 'DIS': 'Disney', 'CMCSA': 'Comcast', 'NKE': 'Nike', 'SBUX': 'Starbucks',
        'MCD': 'McDonald\'s', 'HD': 'Home Depot', 'LOW': 'Lowe\'s', 'TGT': 'Target', 'COST': 'Costco',
        'WMT': 'Walmart', 'AMGN': 'Amgen', 'PEP': 'PepsiCo', 'KO': 'Coca-Cola', 'PG': 'Procter & Gamble',
        'JNJ': 'Johnson & Johnson', 'UNH': 'UnitedHealth', 'CVS': 'CVS Health', 'WBA': 'Walgreens', 'DLTR': 'Dollar Tree',
        // Finance
        'JPM': 'JPMorgan Chase', 'BAC': 'Bank of America', 'WFC': 'Wells Fargo', 'C': 'Citigroup', 'GS': 'Goldman Sachs',
        'MS': 'Morgan Stanley', 'BLK': 'BlackRock', 'SCHW': 'Charles Schwab', 'AXP': 'American Express', 'V': 'Visa',
        'MA': 'Mastercard', 'PYPL': 'PayPal', 'SQ': 'Block (Square)', 'COIN': 'Coinbase', 'HOOD': 'Robinhood',
        'SOFI': 'SoFi', 'AFRM': 'Affirm', 'UPST': 'Upstart', 'NU': 'Nu Holdings', 'ALLY': 'Ally Financial',
        // Energy
        'XOM': 'Exxon Mobil', 'CVX': 'Chevron', 'COP': 'ConocoPhillips', 'SLB': 'Schlumberger', 'EOG': 'EOG Resources',
        'MPC': 'Marathon Petroleum', 'VLO': 'Valero Energy', 'PSX': 'Phillips 66', 'OXY': 'Occidental Petroleum', 'HAL': 'Halliburton',
        // Healthcare & Biotech
        'LLY': 'Eli Lilly', 'PFE': 'Pfizer', 'MRK': 'Merck', 'ABBV': 'AbbVie', 'BMY': 'Bristol-Myers Squibb',
        'GILD': 'Gilead Sciences', 'REGN': 'Regeneron', 'VRTX': 'Vertex Pharma', 'BIIB': 'Biogen', 'MRNA': 'Moderna',
        'ISRG': 'Intuitive Surgical', 'DHR': 'Danaher', 'TMO': 'Thermo Fisher', 'ABT': 'Abbott Labs', 'MDT': 'Medtronic',
        'SYK': 'Stryker', 'BSX': 'Boston Scientific', 'ZBH': 'Zimmer Biomet', 'EW': 'Edwards Lifesciences', 'DXCM': 'Dexcom',
        // Industrial & Aerospace
        'BA': 'Boeing', 'CAT': 'Caterpillar', 'DE': 'John Deere', 'GE': 'General Electric', 'HON': 'Honeywell',
        'MMM': '3M', 'UPS': 'UPS', 'FDX': 'FedEx', 'LMT': 'Lockheed Martin', 'RTX': 'RTX Corp',
        'NOC': 'Northrop Grumman', 'GD': 'General Dynamics', 'TDG': 'TransDigm', 'HWM': 'Howmet Aerospace', 'TXT': 'Textron',
        'EMR': 'Emerson Electric', 'ETN': 'Eaton', 'ITW': 'Illinois Tool Works', 'PH': 'Parker-Hannifin', 'ROK': 'Rockwell Automation',
        // High-Growth Tech
        'PLTR': 'Palantir', 'SNOW': 'Snowflake', 'DDOG': 'Datadog', 'NET': 'Cloudflare', 'CRWD': 'CrowdStrike',
        'ZS': 'Zscaler', 'PANW': 'Palo Alto Networks', 'FTNT': 'Fortinet', 'OKTA': 'Okta', 'MDB': 'MongoDB',
        'SHOP': 'Shopify', 'TTD': 'The Trade Desk', 'ROKU': 'Roku', 'U': 'Unity Software', 'RBLX': 'Roblox',
        'ABNB': 'Airbnb', 'DASH': 'DoorDash', 'UBER': 'Uber', 'LYFT': 'Lyft', 'RIVN': 'Rivian',
        'LCID': 'Lucid Motors', 'NIO': 'NIO', 'XPEV': 'XPeng', 'LI': 'Li Auto', 'F': 'Ford',
        'GM': 'General Motors', 'STLA': 'Stellantis', 'TM': 'Toyota', 'HMC': 'Honda', 'RACE': 'Ferrari',
        // ETFs
        // Additional Tech
        'GOOG': 'Alphabet', 'MPWR': 'Monolithic Power', 'ENTG': 'Entegris', 'TER': 'Teradyne', 'QRVO': 'Qorvo',
        'WOLF': 'Wolfspeed', 'SMCI': 'Super Micro', 'ARM': 'ARM Holdings', 'CRDO': 'Credo Tech', 'ACLS': 'Axcelis Tech',
        // Software & Cloud
        'SPLK': 'Splunk', 'WDAY': 'Workday', 'TEAM': 'Atlassian', 'HUBS': 'HubSpot', 'DOCN': 'DigitalOcean',
        'CFLT': 'Confluent', 'PATH': 'UiPath', 'GTLB': 'GitLab', 'S': 'SentinelOne', 'ESTC': 'Elastic',
        'CYBR': 'CyberArk', 'VRNS': 'Varonis', 'TENB': 'Tenable', 'QLYS': 'Qualys', 'RPD': 'Rapid7',
        'SMAR': 'Smartsheet', 'JAMF': 'Jamf', 'ALTR': 'Altair', 'PCOR': 'Procore', 'BILL': 'Bill.com',
        // E-commerce & Internet
        'MELI': 'MercadoLibre', 'SE': 'Sea Limited', 'BABA': 'Alibaba', 'JD': 'JD.com', 'PDD': 'PDD Holdings',
        'BIDU': 'Baidu', 'EBAY': 'eBay', 'ETSY': 'Etsy', 'CHWY': 'Chewy', 'PINS': 'Pinterest',
        'SNAP': 'Snap', 'TWLO': 'Twilio', 'DBX': 'Dropbox', 'ZM': 'Zoom', 'DOCU': 'DocuSign',
        'FVRR': 'Fiverr', 'UPWK': 'Upwork', 'SPOT': 'Spotify',
        // Entertainment & Gaming
        'WBD': 'Warner Bros', 'PARA': 'Paramount', 'FOX': 'Fox Corp', 'FOXA': 'Fox Corp A', 'LYV': 'Live Nation',
        'MTCH': 'Match Group', 'BMBL': 'Bumble', 'EA': 'Electronic Arts', 'TTWO': 'Take-Two', 'ATVI': 'Activision',
        'DKNG': 'DraftKings', 'PENN': 'Penn Entertainment', 'MGM': 'MGM Resorts', 'CHDN': 'Churchill Downs',
        // More Fintech
        'LC': 'LendingClub', 'OPEN': 'Opendoor', 'UWMC': 'UWM Holdings', 'RKT': 'Rocket Companies',
        'LPRO': 'Open Lending', 'MQ': 'Marqeta', 'PAYO': 'Payoneer', 'DLO': 'DLocal', 'FOUR': 'Shift4',
        // More Banks
        'COF': 'Capital One', 'USB': 'US Bancorp', 'PNC': 'PNC Financial', 'TFC': 'Truist', 'FITB': 'Fifth Third',
        'KEY': 'KeyCorp', 'RF': 'Regions Financial', 'CFG': 'Citizens Financial', 'MTB': 'M&T Bank', 'HBAN': 'Huntington', 'ZION': 'Zions Bank',
        // Insurance
        'BRK.B': 'Berkshire B', 'PRU': 'Prudential', 'MET': 'MetLife', 'AIG': 'AIG', 'ALL': 'Allstate',
        'TRV': 'Travelers', 'PGR': 'Progressive', 'CB': 'Chubb', 'AFL': 'Aflac', 'HIG': 'Hartford',
        // More Consumer
        'LULU': 'Lululemon', 'GPS': 'Gap', 'ANF': 'Abercrombie', 'AEO': 'American Eagle', 'URBN': 'Urban Outfitters',
        'RL': 'Ralph Lauren', 'PVH': 'PVH Corp', 'TPR': 'Tapestry', 'VFC': 'VF Corp',
        'YUM': 'Yum Brands', 'CMG': 'Chipotle', 'DPZ': 'Dominos', 'WING': 'Wingstop', 'SHAK': 'Shake Shack',
        'CAVA': 'Cava Group', 'EAT': 'Brinker', 'TXRH': 'Texas Roadhouse', 'CAKE': 'Cheesecake Factory', 'PLAY': 'Dave & Busters',
        // More Healthcare
        'BNTX': 'BioNTech', 'NVAX': 'Novavax', 'PODD': 'Insulet', 'ALNY': 'Alnylam', 'BGNE': 'BeiGene',
        'EXAS': 'Exact Sciences', 'ILMN': 'Illumina', 'CI': 'Cigna', 'HUM': 'Humana', 'CNC': 'Centene',
        'MOH': 'Molina', 'ELV': 'Elevance', 'HCA': 'HCA Healthcare', 'UHS': 'Universal Health', 'THC': 'Tenet',
        // More Energy
        'DVN': 'Devon Energy', 'FANG': 'Diamondback', 'PXD': 'Pioneer Natural', 'HES': 'Hess', 'MRO': 'Marathon Oil',
        'APA': 'APA Corp', 'BKR': 'Baker Hughes', 'NOV': 'NOV Inc', 'CHK': 'Chesapeake', 'RRC': 'Range Resources',
        // Clean Energy & EV
        'FSR': 'Fisker', 'NKLA': 'Nikola', 'GOEV': 'Canoo', 'WKHS': 'Workhorse', 'FFIE': 'Faraday Future',
        'PLUG': 'Plug Power', 'FCEL': 'FuelCell', 'BE': 'Bloom Energy', 'BLDP': 'Ballard Power', 'CHPT': 'ChargePoint',
        'EVGO': 'EVgo', 'BLNK': 'Blink Charging', 'ENPH': 'Enphase', 'SEDG': 'SolarEdge', 'RUN': 'Sunrun',
        'FSLR': 'First Solar', 'SPWR': 'SunPower', 'NOVA': 'Sunnova', 'ARRY': 'Array Tech', 'MAXN': 'Maxeon',
        'JKS': 'JinkoSolar', 'CSIQ': 'Canadian Solar', 'DQ': 'Daqo New Energy', 'GNRC': 'Generac', 'STEM': 'Stem Inc',
        // Travel & Leisure
        'EXPE': 'Expedia', 'BKNG': 'Booking Holdings', 'MAR': 'Marriott', 'HLT': 'Hilton', 'H': 'Hyatt',
        'WH': 'Wyndham', 'WYNN': 'Wynn Resorts', 'LVS': 'Las Vegas Sands', 'CZR': 'Caesars', 'RCL': 'Royal Caribbean',
        'CCL': 'Carnival', 'NCLH': 'Norwegian Cruise', 'DAL': 'Delta Air', 'UAL': 'United Airlines', 'LUV': 'Southwest',
        'AAL': 'American Airlines', 'ALK': 'Alaska Air', 'JBLU': 'JetBlue', 'SAVE': 'Spirit Airlines', 'HA': 'Hawaiian Airlines',
        // More Industrial
        'AME': 'AMETEK', 'DOV': 'Dover', 'IR': 'Ingersoll Rand', 'XYL': 'Xylem', 'CARR': 'Carrier',
        'OTIS': 'Otis Elevator', 'JCI': 'Johnson Controls', 'TT': 'Trane Tech', 'LII': 'Lennox', 'WSO': 'Watsco',
        // Materials & Mining
        'FCX': 'Freeport-McMoRan', 'NEM': 'Newmont', 'GOLD': 'Barrick Gold', 'AEM': 'Agnico Eagle', 'NUE': 'Nucor',
        'STLD': 'Steel Dynamics', 'CLF': 'Cleveland-Cliffs', 'X': 'US Steel', 'AA': 'Alcoa', 'CENX': 'Century Aluminum',
        'MP': 'MP Materials', 'LAC': 'Lithium Americas', 'ALB': 'Albemarle', 'SQM': 'SQM', 'LTHM': 'Livent',
        'CC': 'Chemours', 'SMG': 'Scotts Miracle-Gro', 'FMC': 'FMC Corp', 'CF': 'CF Industries', 'MOS': 'Mosaic',
        // Real Estate
        'AMT': 'American Tower', 'PLD': 'Prologis', 'CCI': 'Crown Castle', 'EQIX': 'Equinix', 'PSA': 'Public Storage',
        'SPG': 'Simon Property', 'O': 'Realty Income', 'WELL': 'Welltower', 'AVB': 'AvalonBay', 'EQR': 'Equity Residential',
        'DLR': 'Digital Realty', 'ARE': 'Alexandria RE', 'VTR': 'Ventas', 'BXP': 'Boston Properties', 'SLG': 'SL Green',
        'VNO': 'Vornado', 'KIM': 'Kimco Realty', 'REG': 'Regency Centers', 'FRT': 'Federal Realty', 'HST': 'Host Hotels',
        // Telecom
        'T': 'AT&T', 'VZ': 'Verizon', 'TMUS': 'T-Mobile', 'CHTR': 'Charter', 'LBRDK': 'Liberty Broadband',
        'SIRI': 'Sirius XM', 'LUMN': 'Lumen', 'FYBR': 'Frontier', 'USM': 'US Cellular', 'ATUS': 'Altice USA',
        // ETFs
        'SPY': 'S&P 500 ETF', 'QQQ': 'Nasdaq 100 ETF', 'DIA': 'Dow Jones ETF', 'IWM': 'Russell 2000 ETF',
        'XLF': 'Financial Select ETF', 'XLE': 'Energy Select ETF', 'XLK': 'Tech Select ETF', 'XLV': 'Healthcare Select ETF',
        'XLI': 'Industrial Select ETF', 'XLB': 'Materials ETF', 'XLY': 'Consumer Disc ETF', 'XLP': 'Consumer Staples ETF',
        'XLU': 'Utilities ETF', 'XLRE': 'Real Estate ETF', 'XLC': 'Communication ETF',
        'ARKK': 'ARK Innovation ETF', 'ARKG': 'ARK Genomic ETF', 'ARKF': 'ARK Fintech ETF', 'ARKW': 'ARK Web ETF', 'ARKQ': 'ARK Autonomous ETF',
        'SOXX': 'Semiconductor ETF', 'SMH': 'VanEck Semi ETF', 'KWEB': 'China Internet ETF', 'FXI': 'China Large-Cap ETF',
        'EEM': 'Emerging Markets ETF', 'EFA': 'EAFE ETF', 'VWO': 'Vanguard EM ETF', 'GDX': 'Gold Miners ETF', 'SLV': 'Silver ETF', 'GLD': 'Gold ETF'
      };
      
      // ====== EXPECTED PROFIT CALCULATIONS ======
      const profitPerShare = Math.abs(t1 - entry);
      const profitPerShareT2 = Math.abs(t2 - entry);
      const riskPerShare = Math.abs(entry - stop);
      const profitPercent = Math.abs(target1Pct);
      const profitPercentT2 = Math.abs(target2Pct);
      const riskPercent = Math.abs(tfConfig.stopPct);

      // Win probability estimate based on confidence and technical alignment
      const winProbability = Math.min(75, Math.max(45, bestPick.confidence * 0.8 + (bestPick.trend === (isLong ? 'UPTREND' : 'DOWNTREND') ? 10 : -5)));

      // Expected value calculation: (Win% × Profit) - (Loss% × Risk)
      const expectedValuePercent = (winProbability / 100 * profitPercent) - ((100 - winProbability) / 100 * riskPercent);

      // Position sizing examples (based on $10,000 account with 2% risk)
      const accountSize = 10000;
      const riskAmount = accountSize * 0.02; // 2% risk = $200
      const sharesFromRisk = Math.floor(riskAmount / riskPerShare);
      const positionValue = sharesFromRisk * entry;
      const expectedProfitDollars = sharesFromRisk * profitPerShare;
      const expectedProfitDollarsT2 = sharesFromRisk * profitPerShareT2;
      const maxLossDollars = sharesFromRisk * riskPerShare;

      const pick = {
        asset: bestPick.symbol,
        symbol: bestPick.symbol,
        ticker: bestPick.symbol,
        assetName: assetNames[bestPick.symbol] || bestPick.symbol,
        assetType: ['SPY', 'QQQ'].includes(bestPick.symbol) ? 'ETF' : 'Stock',
        direction: bestPick.direction,
        recommendation: bestPick.recommendation, // UNIFIED: Same as main analyzer
        normalizedScore: bestPick.normalizedScore, // 0-100 scale for consistency
        currentPrice: entry.toFixed(2),
        entry: entry.toFixed(2),
        stopLoss: stop.toFixed(2),
        target1: t1.toFixed(2),
        target2: t2.toFixed(2),
        riskReward: `1:${(Math.abs(target1Pct) / Math.abs(tfConfig.stopPct)).toFixed(1)}`,
        confidence: bestPick.confidence,
        timeframe: tfConfig.style,
        holdingPeriod: tfConfig.label,
        setup: `${bestPick.direction} setup based on technical analysis`,
        pattern: bestPick.trend,
        keyReason,
        technicalSignals,
        riskFactors,
        optimalEntry: isLong ? 'Buy on pullback to support or breakout confirmation' : 'Sell on rally to resistance or breakdown confirmation',
        invalidation: isLong ? `Close below $${stop.toFixed(2)}` : `Close above $${stop.toFixed(2)}`,
        marketContext: `RSI: ${bestPick.rsi?.toFixed(1) || 'N/A'}, MACD: ${bestPick.macdHistogram > 0 ? 'Bullish' : 'Bearish'}, Trend: ${bestPick.trend}`,
        // NEW: Expected Profit Data
        expectedProfit: {
          profitPerShare: profitPerShare.toFixed(2),
          profitPerShareT2: profitPerShareT2.toFixed(2),
          profitPercent: profitPercent.toFixed(1),
          profitPercentT2: profitPercentT2.toFixed(1),
          riskPerShare: riskPerShare.toFixed(2),
          riskPercent: riskPercent.toFixed(1),
          winProbability: winProbability.toFixed(0),
          expectedValuePercent: expectedValuePercent.toFixed(2),
          // Position sizing example ($10k account, 2% risk)
          exampleAccount: accountSize,
          exampleRiskPercent: 2,
          exampleShares: sharesFromRisk,
          examplePositionValue: positionValue.toFixed(2),
          exampleExpectedProfit: expectedProfitDollars.toFixed(2),
          exampleExpectedProfitT2: expectedProfitDollarsT2.toFixed(2),
          exampleMaxLoss: maxLossDollars.toFixed(2)
        },
        // Technical data for transparency
        technicalData: {
          rsi: bestPick.rsi?.toFixed(1),
          macd: bestPick.macd?.toFixed(3),
          macdSignal: bestPick.macdSignal?.toFixed(3),
          macdHistogram: bestPick.macdHistogram?.toFixed(3),
          aboveSMA20: bestPick.aboveSMA20,
          aboveSMA50: bestPick.aboveSMA50,
          trend: bestPick.trend,
          bullishScore: bestPick.bullishScore,
          bearishScore: bestPick.bearishScore
        },
        // Other candidates for comparison (from filtered list)
        otherCandidates: filteredAnalyses.slice(1, 4).map(s => ({
          symbol: s.symbol,
          direction: s.direction,
          score: s.netScore,
          rsi: s.rsi?.toFixed(1),
          atr: s.atrPercent
        })),
        generatedWithLiveData: true,
        livePricesFetched: stockAnalyses.length,
        marketSentiment: stockAnalyses.find(s => s.symbol === 'SPY')?.trend === 'UPTREND' ? 'bullish' :
                         stockAnalyses.find(s => s.symbol === 'SPY')?.trend === 'DOWNTREND' ? 'bearish' : 'neutral',
        liveDataTimestamp: new Date().toLocaleTimeString(),
        // Volatility info
        volatility: {
          atrPercent: bestPick.atrPercent,
          category: parseFloat(bestPick.atrPercent) < 1.5 ? 'Low' : parseFloat(bestPick.atrPercent) < 3 ? 'Medium' : 'High',
          preference: volConfig.label,
          warning: volatilityWarning
        },
        // CATALYST & EVENT DATA - Real-world factors
        catalystData: {
          catalysts: bestPick.catalysts || [],
          risks: bestPick.risks || [],
          upcomingEvents: bestPick.upcomingEvents || [],
          earnings: bestPick.earnings,
          sectorTrend: bestPick.sectorTrend,
          seasonality: bestPick.seasonality,
          catalystBonus: bestPick.catalystBonus || 0
        }
      };

      console.log(`[Daily Pick] ✅ ${pick.direction} ${pick.asset} @ $${entry.toFixed(2)} | RSI:${bestPick.rsi?.toFixed(1)} MACD:${bestPick.macdHistogram > 0 ? '+' : '-'} Trend:${bestPick.trend} | Catalysts: ${bestPick.catalysts?.length || 0}`);
      
      setDailyPick(normalizeDailyPick(pick));
      setLastPickTime(new Date());
      setToast({ type: 'success', message: `✅ Found top pick: ${pick.asset} (${pick.direction})` });
    } catch (err) {
      console.error("[Daily Pick] Error:", err);
      setDailyPickError(`Failed to generate pick: ${err.message}`);
      setToast({ type: 'error', message: '❌ Failed to generate pick. Try again.' });
    } finally {
      setLoadingPick(false);
    }
  };

  // Q&A Functions with offline fallback for common questions
  const getOfflineAnswer = (q) => {
    const lowerQ = q.toLowerCase();
    // Only use offline answers for SHORT, simple questions (under 80 chars)
    // Long, detailed, or multi-part questions should always go to the AI for thorough answers
    if (q.length > 80) return null;

    const answers = {
      'position size': `**Position Sizing Formula:**\n\nPosition Size = (Account Risk $) / (Trade Risk per Share)\n\n**Example:**\n- Account: $10,000\n- Risk: 2% = $200\n- Entry: $100, Stop Loss: $95\n- Risk per share: $5\n- Position Size: $200 / $5 = 40 shares\n\n**Key Rules:**\n• Never risk more than 1-2% per trade\n• Adjust size based on volatility\n• Smaller positions for uncertain setups`,
      'rsi': `**RSI (Relative Strength Index)**\n\nMeasures momentum on a 0-100 scale.\n\n**Key Levels:**\n• Above 70 = Overbought (potential sell)\n• Below 30 = Oversold (potential buy)\n• 50 = Neutral\n\n**RSI Divergence:**\n• Bullish: Price makes lower low, RSI makes higher low\n• Bearish: Price makes higher high, RSI makes lower high\n\n**Best Practices:**\n• Use with trend direction\n• Don't trade RSI alone\n• Works best in ranging markets`,
      'macd': `**MACD (Moving Average Convergence Divergence)**\n\n**Components:**\n• MACD Line = 12 EMA - 26 EMA\n• Signal Line = 9 EMA of MACD\n• Histogram = MACD - Signal\n\n**Signals:**\n• Bullish: MACD crosses above Signal\n• Bearish: MACD crosses below Signal\n• Histogram growing = momentum increasing\n\n**Tips:**\n• Best for trending markets\n• Use histogram for early signals\n• Combine with price action`,
      'head and shoulders': `**Head and Shoulders Pattern**\n\n**Structure:**\n• Left Shoulder: First peak\n• Head: Higher peak\n• Right Shoulder: Lower peak (similar to left)\n• Neckline: Support connecting the lows\n\n**Trading:**\n• Entry: Break below neckline\n• Stop: Above right shoulder\n• Target: Distance from head to neckline\n\n**Confirmation:**\n• Volume decreases on right shoulder\n• Volume increases on breakdown\n• Wait for neckline retest`,
      'support resistance': `**Support & Resistance**\n\n**Support:** Price level where buying pressure exceeds selling\n**Resistance:** Price level where selling pressure exceeds buying\n\n**How to Identify:**\n• Previous highs/lows\n• Round numbers ($100, $50)\n• Moving averages\n• Volume clusters\n\n**Trading Tips:**\n• More touches = stronger level\n• Broken support becomes resistance\n• Look for confluence of levels\n• Use for entries and stops`,
      'risk reward': `**Risk/Reward Ratio**\n\n**Formula:** Potential Profit / Potential Loss\n\n**Example:**\n• Entry: $100\n• Stop Loss: $95 (risk $5)\n• Target: $115 (reward $15)\n• R:R = 15/5 = 3:1\n\n**Guidelines:**\n• Minimum 2:1 for swing trades\n• 3:1 or better is ideal\n• Even 1:1 works with 60%+ win rate\n\n**Reality Check:**\n• Higher R:R = lower win rate\n• Balance R:R with probability\n• Account for slippage/fees`
    };

    for (const [key, answer] of Object.entries(answers)) {
      if (lowerQ.includes(key)) return answer;
    }
    return null;
  };

  const askQuestion = async () => {
    if (question.length < 10) return;

    setLoadingAnswer(true);
    setAnalysisError(null); // Clear previous errors

    try {
      // First try offline answers for common questions
      const offlineAnswer = getOfflineAnswer(question);

      if (offlineAnswer) {
        setAnswer(offlineAnswer);
        const newQA = { q: question, a: offlineAnswer, time: new Date().toISOString() };
        const updatedHistory = [...qaHistory, newQA];
        setQaHistory(updatedHistory);
        sessionStorage.setItem("modus_qa_history", JSON.stringify(updatedHistory));
        trackEvent('ai', 'question', 'offline');
        setQuestion("");
        return;
      }

      // Try API call
      const data = await callAPI([{
        role: "user",
        content: `You are an expert trading assistant. RULES: Address EVERY part of the question — if multiple concepts are asked about, cover each one individually with a definition, example with numbers, and when to use it. Use **bold** for headers and • for lists. Be thorough (300-600 words).

${question}`
      }], 2500);

      const answerText = data.content[0].text;
      setAnswer(answerText);

      const newQA = { q: question, a: answerText, time: new Date().toISOString() };
      const updatedHistory = [...qaHistory, newQA];
      setQaHistory(updatedHistory);
      sessionStorage.setItem("modus_qa_history", JSON.stringify(updatedHistory));
      trackEvent('ai', 'question', 'api');

      setQuestion("");
    } catch (err) {
      console.error("Q&A Error:", err);
      // Provide helpful fallback message
      setAnalysisError(`Q&A failed: ${err.message}. Try asking about position sizing, RSI, MACD, stop losses, or chart patterns - these work offline!`);
    } finally {
      setLoadingAnswer(false);
    }
  };

  const askChartQuestion = async () => {
    if (!analysis) {
      setToast({ type: 'error', message: '❌ No chart analysis found. Upload and analyze a chart first.' });
      return;
    }
    if (chartQuestion.length < 5) {
      setToast({ type: 'error', message: '❌ Question too short. Please type at least 5 characters.' });
      return;
    }

    setLoadingChartAnswer(true);
    setAnalysisError(null);
    try {
      // Build a rich text-only context from the analysis (no image to avoid size limits/timeouts)
      const contextParts = [];
      if (analysis.context) {
        contextParts.push(`Chart: ${analysis.context.symbol || analysis.context.ticker || 'Unknown'} | Timeframe: ${analysis.context.timeframe || 'Unknown'} | Trend: ${analysis.context.trend || 'Unknown'}`);
        if (analysis.context.support) contextParts.push(`Support: ${Array.isArray(analysis.context.support) ? analysis.context.support.join(', ') : analysis.context.support}`);
        if (analysis.context.resistance) contextParts.push(`Resistance: ${Array.isArray(analysis.context.resistance) ? analysis.context.resistance.join(', ') : analysis.context.resistance}`);
      }
      if (analysis.patterns?.detected) {
        contextParts.push(`Patterns: ${Array.isArray(analysis.patterns.detected) ? analysis.patterns.detected.join(', ') : JSON.stringify(analysis.patterns.detected)}`);
      }
      if (analysis.indicators) {
        contextParts.push(`Indicators: ${JSON.stringify(analysis.indicators)}`);
      }
      if (analysis.tradeSetup) {
        const ts = analysis.tradeSetup;
        contextParts.push(`Trade Setup: ${ts.recommendation || 'N/A'} | Entry: ${ts.entryPrice || 'N/A'} | Stop Loss: ${ts.stopLoss || 'N/A'} | Target: ${ts.targetPrice || 'N/A'} | R:R: ${ts.riskRewardRatio || 'N/A'}`);
      }
      if (analysis.final?.summary) {
        contextParts.push(`Summary: ${analysis.final.summary}`);
      }
      if (analysis.realIndicators) {
        const ri = analysis.realIndicators;
        contextParts.push(`Real Indicators: RSI ${ri.rsi || 'N/A'} | MACD Histogram ${ri.macdHistogram || 'N/A'} | Trend ${ri.trend || 'N/A'} | Bull Score ${ri.bullishScore || 0} / Bear Score ${ri.bearishScore || 0}`);
      }

      const prompt = `You are an expert trading chart analysis assistant. A user uploaded a chart and received this analysis:

${contextParts.join('\n')}

The user now asks: "${chartQuestion}"

INSTRUCTIONS:
1. Address EVERY part of the user's question thoroughly. If they ask about multiple things, cover each one.
2. Reference specific data from the chart analysis above (price levels, indicators, patterns) wherever relevant.
3. Provide practical, actionable insights — not just definitions. Explain what the data means for THIS specific chart.
4. Use **bold** for key terms and headers. Use bullet points (•) for lists.
5. If the question is about entry/exit strategy, give specific price levels based on the analysis.
6. If they ask about risk, calculate specific risk amounts and position sizes using the chart data.
7. Be thorough — aim for 300-600 words for detailed questions.`;

      const data = await callAPI([{ role: "user", content: prompt }], 3500);

      const answerText = data.content[0].text;
      setChartAnswer(answerText);
      setChartQaHistory([...chartQaHistory, { q: chartQuestion, a: answerText }]);
      setChartQuestion("");
    } catch (err) {
      console.error('[Chart Q&A] Error:', err);
      setAnalysisError(`Chart Q&A failed: ${err.message}`);
      setToast({ type: 'error', message: `❌ Chart Q&A failed: ${err.message}` });
    } finally {
      setLoadingChartAnswer(false);
    }
  };

  const clearChartQA = () => {
    setChartQuestion("");
    setChartAnswer(null);
    setChartQaHistory([]);
  };

  const formatTime = (date) => {
    return date.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  };

  // Professional formatting helpers
  const formatValue = (value) => {
    if (!value || value === "NOT_VISIBLE" || value === "null" || value === null) {
      return "—";
    }
    return value;
  };

  const formatPrice = (price) => {
    if (!price || price === "NOT_VISIBLE" || price === "null" || price === null) {
      return "—";
    }
    // If it's already a formatted string with currency symbols, return as is
    if (typeof price === 'string' && (price.includes('$') || price.includes('£') || price.includes('€'))) {
      return price;
    }
    // Otherwise try to parse and format as number
    const num = parseFloat(price);
    if (isNaN(num)) return "—";
    return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };

  const formatPercentage = (value) => {
    if (!value || value === "NOT_VISIBLE" || value === "null" || value === null) {
      return "—";
    }
    // If already has %, return as is
    if (typeof value === 'string' && value.includes('%')) {
      return value;
    }
    const num = parseFloat(value);
    if (isNaN(num)) return "—";
    return `${(num || 0).toFixed(2)}%`;
  };

  const formatArray = (arr) => {
    if (!arr || arr.length === 0) return ["No data available"];
    return arr.filter(item => item && item !== "NOT_VISIBLE" && item !== "null");
  };

  const getTrendColor = (trend) => {
    if (!trend) return "text-slate-400";
    const t = trend.toUpperCase();
    if (t.includes("UP") || t.includes("BULLISH") || t.includes("HIGHER")) return "text-emerald-400";
    if (t.includes("DOWN") || t.includes("BEARISH") || t.includes("LOWER")) return "text-red-400";
    return "text-yellow-400";
  };

  const getStrengthBadge = (strength) => {
    if (!strength) return "bg-slate-700 text-slate-300";
    const s = strength.toUpperCase();
    if (s.includes("STRONG")) return "bg-emerald-600/20 text-emerald-300";
    if (s.includes("MODERATE") || s.includes("MEDIUM")) return "bg-yellow-600/20 text-yellow-300";
    if (s.includes("WEAK") || s.includes("LOW")) return "bg-red-600/20 text-red-300";
    return "bg-slate-700 text-slate-300";
  };

  const getRecommendationColor = (rec) => {
    if (rec?.includes("STRONG_BUY") || rec?.includes("STRONG BUY")) return "text-emerald-400";
    if (rec?.includes("MODERATE_BUY") || rec?.includes("MODERATE BUY")) return "text-green-400";
    if (rec?.includes("LEAN_BUY") || rec?.includes("LEAN BUY")) return "text-lime-400";
    if (rec?.includes("BUY")) return "text-green-400";
    if (rec?.includes("STRONG_SELL") || rec?.includes("STRONG SELL")) return "text-rose-400";
    if (rec?.includes("MODERATE_SELL") || rec?.includes("MODERATE SELL")) return "text-red-400";
    if (rec?.includes("LEAN_SELL") || rec?.includes("LEAN SELL")) return "text-orange-400";
    if (rec?.includes("SELL")) return "text-red-400";
    if (rec?.includes("WAIT")) return "text-amber-400";
    return "text-yellow-400";
  };

  const getRecommendationIcon = (rec) => {
    if (rec?.includes("STRONG_BUY") || rec?.includes("STRONG BUY")) return <TrendingUp className="w-6 h-6" />;
    if (rec?.includes("MODERATE_BUY") || rec?.includes("MODERATE BUY")) return <TrendingUp className="w-5 h-5" />;
    if (rec?.includes("LEAN_BUY") || rec?.includes("LEAN BUY")) return <TrendingUp className="w-5 h-5" />;
    if (rec?.includes("BUY")) return <TrendingUp className="w-5 h-5" />;
    if (rec?.includes("STRONG_SELL") || rec?.includes("STRONG SELL")) return <TrendingDown className="w-6 h-6" />;
    if (rec?.includes("MODERATE_SELL") || rec?.includes("MODERATE SELL")) return <TrendingDown className="w-5 h-5" />;
    if (rec?.includes("LEAN_SELL") || rec?.includes("LEAN SELL")) return <TrendingDown className="w-5 h-5" />;
    if (rec?.includes("SELL")) return <TrendingDown className="w-5 h-5" />;
    if (rec?.includes("WAIT")) return <Clock className="w-5 h-5" />;
    return <Minus className="w-5 h-5" />;
  };

  
  // =================================================================
  // NEW FEATURES - ALL FUNCTIONS (PHASE 1 & 2)
  // =================================================================
  
  // ========================
  // DEMO MODE
  // ========================
  
  const getDemoData = (symbol) => {
    // Use ref to get current timeframe (avoids stale closure)
    const currentTimeframe = tickerTimeframeRef.current || tickerTimeframe;
    console.log(`[DEMO] Generating sample data for ${symbol}...`);
    console.log(`[DEMO] Timeframe: ${currentTimeframe}, Candles: ${tickerCandleCount}`);
    
    const now = Date.now();
    const bars = [];
    let price = 405.50; // Starting price
    
    // Convert timeframe to milliseconds
    const timeframeMs = {
      '1m': 60 * 1000,
      '2m': 2 * 60 * 1000,
      '5m': 5 * 60 * 1000,
      '15m': 15 * 60 * 1000,
      '30m': 30 * 60 * 1000,
      '60m': 60 * 60 * 1000,
      '90m': 90 * 60 * 1000,
      '1h': 60 * 60 * 1000,
      '1d': 24 * 60 * 60 * 1000,
      '5d': 5 * 24 * 60 * 60 * 1000,
      '1wk': 7 * 24 * 60 * 60 * 1000,
      '1mo': 30 * 24 * 60 * 60 * 1000
    };
    
    const intervalMs = timeframeMs[currentTimeframe] || timeframeMs['5m'];
    const candleCount = tickerCandleCount || 100;
    
    // Generate bars based on selected count and timeframe
    for (let i = candleCount - 1; i >= 0; i--) {
      const timestamp = now - (i * intervalMs);
      const randomChange = (Math.random() - 0.5) * 3;
      price = Math.max(price + randomChange, 1); // Prevent negative prices
      
      const open = price;
      const close = price + (Math.random() - 0.5) * 2;
      const high = Math.max(open, close) + Math.random() * 1;
      const low = Math.min(open, close) - Math.random() * 1;
      const volume = Math.floor(Math.random() * 500000) + 100000;
      
      bars.push({
        time: new Date(timestamp).toLocaleString(),
        open: parseFloat((open || 0).toFixed(2)),
        high: parseFloat((high || 0).toFixed(2)),
        low: parseFloat((low || 0).toFixed(2)),
        close: parseFloat((close || 0).toFixed(2)),
        volume: volume
      });
    }
    
    const currentPrice = bars[bars.length - 1].close;
    const previousClose = bars[0].open;
    
    console.log(`[DEMO] Generated ${bars.length} bars (${currentTimeframe}), price: $${(currentPrice || 0).toFixed(2)}`);
    
    return {
      symbol: symbol,
      currentPrice: currentPrice,
      open: previousClose,
      high: Math.max(...bars.map(b => b.high)),
      low: Math.min(...bars.map(b => b.low)),
      change: currentPrice - previousClose,
      changePercent: ((currentPrice - previousClose) / previousClose) * 100,
      volume: bars.reduce((sum, b) => sum + b.volume, 0),
      timeSeries: bars,
      isDemo: true,
      timeframe: currentTimeframe
    };
  };
  
  // ========================
  // WATCHLIST
  // ========================
  
  const addToWatchlist = (symbol) => {
    if (!symbol) return;
    const upperSymbol = symbol.toUpperCase().trim();
    if (!watchlist.includes(upperSymbol)) {
      setWatchlist([...watchlist, upperSymbol]);
    }
  };
  
  const removeFromWatchlist = (symbol) => {
    setWatchlist(watchlist.filter(s => s !== symbol));
  };

  const reorderWatchlist = useCallback((fromIdx, toIdx) => {
    setWatchlist(prev => {
      const updated = [...prev];
      const [moved] = updated.splice(fromIdx, 1);
      updated.splice(toIdx, 0, moved);
      return updated;
    });
    setDraggedWatchlistItem(null);
    setDragOverWatchlistItem(null);
  }, []);

  const loadWatchlistSymbol = async (symbol) => {
    setTickerSymbol(symbol);
    setActiveTab("ticker");
    setTimeout(() => fetchTickerData(), 100);
  };
  
  // ========================
  // ANALYSIS HISTORY
  // ========================
  
  const saveToHistory = (analysisData, imageUrl) => {
    const historyEntry = {
      id: Date.now(),
      timestamp: new Date().toISOString(),
      symbol: analysisData.symbol || "Unknown",
      image: imageUrl,
      analysis: analysisData,
      recommendation: analysisData.recommendation || "N/A",
      score: analysisData.overallScore || 0
    };
    
    setAnalysisHistory([historyEntry, ...analysisHistory]);
    console.log("✅ Analysis saved to history!");
  };
  
  const loadFromHistory = (entry) => {
    setImage(entry.image);
    setAnalysis(entry.analysis);
    setAnalysisTab("overview");
    setActiveTab("analyze");
    setShowHistory(false);
  };
  
  const deleteFromHistory = (id) => {
    setAnalysisHistory(analysisHistory.filter(h => h.id !== id));
  };
  
  const clearHistory = () => {
    setConfirmMessage("Clear all analysis history? This cannot be undone.");
    setConfirmAction(() => () => {
      setAnalysisHistory([]);
      localStorage.removeItem("modus_history");
      setShowConfirmModal(false);
    });
    setShowConfirmModal(true);
  };
  
  // ========================
  // PDF EXPORT
  // ========================
  
  const exportToPDF = async () => {
    if (!analysis) {
      showToast("No analysis to export!", "error");
      return;
    }
    
    try {
      // Try to import jsPDF
      console.log("Attempting to load jsPDF...");
      const jsPDFModule = await import('jspdf');
      const jsPDF = jsPDFModule.jsPDF || jsPDFModule.default;

      if (!jsPDF) {
        throw new Error("jsPDF failed to load properly");
      }

      console.log("Loading jspdf-autotable...");
      const autoTableModule = await import('jspdf-autotable');

      console.log("Creating PDF document...");
      const doc = new jsPDF();

      // Create autoTable function - handles different module formats
      let autoTableFn;
      if (autoTableModule.default && typeof autoTableModule.default === 'function') {
        // Try to attach to doc instance first
        try {
          autoTableModule.default(doc);
          if (typeof doc.autoTable === 'function') {
            autoTableFn = (options) => doc.autoTable(options);
          }
        } catch (e) {
          console.warn("Could not attach autoTable to doc:", e);
        }
      }

      // If not attached, create wrapper that passes doc as first arg
      if (!autoTableFn) {
        if (typeof autoTableModule.default === 'function') {
          autoTableFn = (options) => autoTableModule.default(doc, options);
        } else if (typeof autoTableModule.autoTable === 'function') {
          autoTableFn = (options) => autoTableModule.autoTable(doc, options);
        } else if (typeof doc.autoTable === 'function') {
          autoTableFn = (options) => doc.autoTable(options);
        } else {
          throw new Error("Could not initialize autoTable - module format not recognized");
        }
      }

      // Override doc.autoTable to use our wrapper
      doc.autoTable = autoTableFn;
      let yPos = 15;
      const pageWidth = doc.internal.pageSize.width;
      const marginLeft = 15;
      const marginRight = 15;
      const contentWidth = pageWidth - marginLeft - marginRight;
      
      // Helper function to check if new page needed
      const checkNewPage = (spaceNeeded = 20) => {
        if (yPos + spaceNeeded > 280) {
          doc.addPage();
          yPos = 15;
          return true;
        }
        return false;
      };
      
      // Helper to add section header
      const addSectionHeader = (title, color = [124, 58, 237]) => {
        checkNewPage(15);
        doc.setFontSize(14);
        doc.setTextColor(...color);
        doc.setFont(undefined, 'bold');
        doc.text(title, marginLeft, yPos);
        yPos += 3;
        doc.setDrawColor(...color);
        doc.setLineWidth(0.5);
        doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
        yPos += 8;
        doc.setFont(undefined, 'normal');
      };
      
      // ============================================
      // PAGE 1: HEADER & EXECUTIVE SUMMARY
      // ============================================
      
      // Logo/Title Header
      doc.setFillColor(124, 58, 237);
      doc.rect(0, 0, pageWidth, 35, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(24);
      doc.setFont(undefined, 'bold');
      doc.text("MODUS", marginLeft, 15);
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text("Professional Technical Analysis Report", marginLeft, 23);
      doc.setFontSize(9);
      doc.text(`Generated: ${new Date().toLocaleString()}`, marginLeft, 30);
      
      yPos = 45;
      
      // Extract all data
      const symbol = analysis.context?.ticker || "N/A";
      const timeframe = analysis.context?.timeframe || "N/A";
      const assetType = analysis.context?.assetType || "N/A";
      const dateRange = analysis.context?.dateRange || {};
      
      const score = Math.round(analysis.final?.confidenceScore || analysis.final?.pointsBreakdown?.totalPoints || 0);
      const recommendation = (analysis.final?.recommendation || "N/A").replace(/_/g, ' ');
      const setupQuality = analysis.final?.setupQuality || "N/A";
      const summary = analysis.final?.summary || "No summary available";
      
      const trend = analysis.patterns?.trendAnalysis?.trend || "N/A";
      const trendStrength = analysis.patterns?.trendAnalysis?.trendStrength || "N/A";
      
      // Key Info Box
      doc.setFillColor(240, 240, 255);
      doc.roundedRect(marginLeft, yPos, contentWidth, 25, 3, 3, 'F');
      doc.setTextColor(0);
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text(`Symbol: ${symbol}`, marginLeft + 5, yPos + 8);
      doc.text(`Timeframe: ${timeframe}`, marginLeft + 5, yPos + 15);
      doc.text(`Asset Type: ${assetType}`, marginLeft + 5, yPos + 22);
      
      doc.text(`Trend: ${trend}`, marginLeft + 80, yPos + 8);
      doc.text(`Strength: ${trendStrength}`, marginLeft + 80, yPos + 15);
      doc.text(`Setup Grade: ${setupQuality}`, marginLeft + 80, yPos + 22);
      
      doc.setFont(undefined, 'normal');
      yPos += 32;
      
      // Score & Recommendation Box
      checkNewPage(40);
      const scoreColor = score >= 70 ? [34, 197, 94] : score >= 50 ? [234, 179, 8] : [220, 38, 38];
      doc.setFillColor(...scoreColor);
      doc.roundedRect(marginLeft, yPos, contentWidth / 2 - 2, 30, 3, 3, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text("Overall Score", marginLeft + 5, yPos + 10);
      doc.setFontSize(24);
      doc.text(`${score}/100`, marginLeft + 5, yPos + 23);
      
      const recColor = recommendation.includes("BUY") ? [34, 197, 94] : 
                       recommendation.includes("SELL") ? [220, 38, 38] : [100, 100, 100];
      doc.setFillColor(...recColor);
      doc.roundedRect(marginLeft + contentWidth / 2 + 2, yPos, contentWidth / 2 - 2, 30, 3, 3, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(18);
      doc.text("Recommendation", marginLeft + contentWidth / 2 + 7, yPos + 10);
      doc.setFontSize(16);
      doc.text(recommendation, marginLeft + contentWidth / 2 + 7, yPos + 23);
      
      yPos += 38;
      
      // Executive Summary
      addSectionHeader("Executive Summary");
      doc.setTextColor(0);
      doc.setFontSize(10);
      const summaryLines = doc.splitTextToSize(summary, contentWidth);
      doc.text(summaryLines, marginLeft, yPos);
      yPos += (summaryLines.length * 5) + 5;
      
      // ============================================
      // TRADE SETUP DETAILS
      // ============================================
      
      if (analysis.tradeSetup?.immediateEntry) {
        addSectionHeader("Recommended Trade Setup", [34, 197, 94]);
        const setup = analysis.tradeSetup.immediateEntry;
        
        const setupData = [
          ['Entry Price', `$${setup.entry || 'N/A'}`],
          ['Stop Loss', `$${setup.stop || 'N/A'}`],
          ['Target 1', `$${setup.target1 || 'N/A'}`],
          ['Target 2', `$${setup.target2 || 'N/A'}`],
          ['Target 3', `$${setup.target3 || 'N/A'}`],
          ['Risk/Reward', setup.riskRewardRatio || 'N/A'],
          ['Win Probability', `${setup.winProbability || 'N/A'}%`],
          ['Position Size', setup.positionSize || 'N/A'],
          ['Time Horizon', analysis.tradeSetup?.timeHorizon || 'N/A']
        ];
        
        doc.autoTable({
          startY: yPos,
          head: [['Parameter', 'Value']],
          body: setupData,
          theme: 'striped',
          headStyles: { fillColor: [124, 58, 237], textColor: 255, fontSize: 11, fontStyle: 'bold' },
          styles: { fontSize: 10, cellPadding: 3 },
          margin: { left: marginLeft, right: marginRight },
          columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 60 },
            1: { cellWidth: 'auto' }
          }
        });
        
        yPos = doc.lastAutoTable.finalY + 10;
      }
      
      // ============================================
      // PAGE 2: TECHNICAL ANALYSIS DETAILS
      // ============================================
      
      checkNewPage();
      
      // Pattern Analysis
      if (analysis.patterns) {
        addSectionHeader("Pattern Analysis", [59, 130, 246]);
        
        const patterns = analysis.patterns;
        const patternData = [];
        
        if (patterns.identifiedPatterns && patterns.identifiedPatterns.length > 0) {
          patterns.identifiedPatterns.forEach(p => {
            patternData.push([
              p.pattern || 'N/A',
              p.type || 'N/A',
              p.reliability || 'N/A',
              p.target || 'N/A'
            ]);
          });
        } else {
          patternData.push(['No specific patterns identified', '-', '-', '-']);
        }
        
        doc.autoTable({
          startY: yPos,
          head: [['Pattern', 'Type', 'Reliability', 'Target']],
          body: patternData,
          theme: 'grid',
          headStyles: { fillColor: [59, 130, 246], fontSize: 10, fontStyle: 'bold' },
          styles: { fontSize: 9, cellPadding: 2.5 },
          margin: { left: marginLeft, right: marginRight }
        });
        
        yPos = doc.lastAutoTable.finalY + 10;
      }
      
      // Indicator Analysis
      if (analysis.indicators) {
        checkNewPage(40);
        addSectionHeader("Indicator Analysis", [168, 85, 247]);
        
        const indicators = analysis.indicators.indicatorScores || {};
        const indicatorData = [
          ['Net Score', indicators.netScore || 'N/A'],
          ['Interpretation', indicators.interpretation || 'N/A'],
          ['RSI Signal', indicators.rsi || 'N/A'],
          ['MACD Signal', indicators.macd || 'N/A'],
          ['Moving Averages', indicators.movingAverages || 'N/A'],
          ['Volume', indicators.volume || 'N/A']
        ];
        
        doc.autoTable({
          startY: yPos,
          head: [['Indicator', 'Signal']],
          body: indicatorData,
          theme: 'plain',
          headStyles: { fillColor: [168, 85, 247], fontSize: 10, fontStyle: 'bold' },
          styles: { fontSize: 9, cellPadding: 3 },
          margin: { left: marginLeft, right: marginRight },
          columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 70 }
          }
        });
        
        yPos = doc.lastAutoTable.finalY + 10;
      }
      
      // Key Levels
      if (analysis.final?.keyLevels && analysis.final.keyLevels.length > 0) {
        checkNewPage(30);
        addSectionHeader("Key Price Levels", [234, 179, 8]);
        doc.setFontSize(10);
        doc.setTextColor(0);
        
        analysis.final.keyLevels.forEach(level => {
          doc.text(`• ${level}`, marginLeft + 5, yPos);
          yPos += 6;
        });
        yPos += 5;
      }
      
      // ============================================
      // PAGE 3: BULLISH/BEARISH FACTORS
      // ============================================
      
      checkNewPage();
      
      // Bullish Factors
      if (analysis.final?.bullishFactors && analysis.final.bullishFactors.length > 0) {
        addSectionHeader("Bullish Factors", [34, 197, 94]);
        doc.setFontSize(9);
        doc.setTextColor(0);
        
        analysis.final.bullishFactors.forEach(factor => {
          const lines = doc.splitTextToSize(`✓ ${factor}`, contentWidth - 10);
          lines.forEach(line => {
            checkNewPage(8);
            doc.text(line, marginLeft + 5, yPos);
            yPos += 5;
          });
        });
        yPos += 8;
      }
      
      // Bearish Factors
      if (analysis.final?.bearishFactors && analysis.final.bearishFactors.length > 0) {
        checkNewPage(20);
        addSectionHeader("Bearish Factors", [220, 38, 38]);
        doc.setFontSize(9);
        doc.setTextColor(0);
        
        analysis.final.bearishFactors.forEach(factor => {
          const lines = doc.splitTextToSize(`✗ ${factor}`, contentWidth - 10);
          lines.forEach(line => {
            checkNewPage(8);
            doc.text(line, marginLeft + 5, yPos);
            yPos += 5;
          });
        });
        yPos += 8;
      }
      
      // Price Predictions
      if (analysis.recommendations?.pricePredictions) {
        checkNewPage(50);
        addSectionHeader("Price Predictions", [147, 51, 234]);
        
        const predictions = analysis.recommendations.pricePredictions;
        const predData = [];
        
        if (predictions.shortTerm) {
          predData.push(['Short-term', predictions.shortTerm.targetPrice || 'N/A', 
                         predictions.shortTerm.timeframe || 'N/A', predictions.shortTerm.confidence || 'N/A']);
        }
        if (predictions.mediumTerm) {
          predData.push(['Medium-term', predictions.mediumTerm.targetPrice || 'N/A',
                         predictions.mediumTerm.timeframe || 'N/A', predictions.mediumTerm.confidence || 'N/A']);
        }
        if (predictions.longTerm) {
          predData.push(['Long-term', predictions.longTerm.targetPrice || 'N/A',
                         predictions.longTerm.timeframe || 'N/A', predictions.longTerm.confidence || 'N/A']);
        }
        
        if (predData.length > 0) {
          doc.autoTable({
            startY: yPos,
            head: [['Horizon', 'Target Price', 'Timeframe', 'Confidence']],
            body: predData,
            theme: 'striped',
            headStyles: { fillColor: [147, 51, 234], fontSize: 10, fontStyle: 'bold' },
            styles: { fontSize: 9, cellPadding: 3 },
            margin: { left: marginLeft, right: marginRight }
          });
          
          yPos = doc.lastAutoTable.finalY + 10;
        }
      }
      
      // Risk Warning
      if (analysis.final?.riskWarning) {
        checkNewPage(25);
        doc.setFillColor(254, 226, 226);
        doc.roundedRect(marginLeft, yPos, contentWidth, 20, 2, 2, 'F');
        doc.setTextColor(220, 38, 38);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text("⚠ Risk Warning", marginLeft + 5, yPos + 7);
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        doc.setTextColor(0);
        const warningLines = doc.splitTextToSize(analysis.final.riskWarning, contentWidth - 10);
        doc.text(warningLines, marginLeft + 5, yPos + 14);
        yPos += 25;
      }
      
      // Footer on every page
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(
          `MODUS - Professional Analysis Report | Page ${i} of ${totalPages}`,
          pageWidth / 2,
          290,
          { align: 'center' }
        );
        doc.text(
          "Disclaimer: This analysis is for informational and educational purposes only. Not financial advice. Trading involves substantial risk.",
          pageWidth / 2,
          295,
          { align: 'center' }
        );
      }
      
      // Save
      console.log("Saving PDF...");
      doc.save(`MODUS_Analysis_${Date.now()}.pdf`);
      console.log("PDF saved successfully!");
      
    } catch (err) {
      console.error("PDF export error:", err);
      console.error("Error details:", err.message, err.stack);
      
      let errorMessage = "Failed to generate PDF.\n\n";
      
      if (err.message && err.message.includes('Cannot find module')) {
        errorMessage += "Missing library detected. Please ensure jsPDF is installed:\n\n" +
                       "npm install jspdf jspdf-autotable\n\n" +
                       "Then restart your development server.";
      } else if (err.message) {
        errorMessage += `Error: ${err.message}\n\n`;
        errorMessage += "Check browser console (F12) for more details.";
      } else {
        errorMessage += "Unknown error occurred. Check browser console (F12) for details.";
      }
      
      alert(errorMessage);
    }
  };

  // ========================
  // TOAST NOTIFICATION SYSTEM
  // ========================

  const showToast = useCallback((message, type = 'info', duration = 4000) => {
    const id = ++toastIdRef.current;
    const toast = { id, message, type, timestamp: Date.now() };
    setToasts(prev => [...prev, toast]);

    // Auto-remove after duration
    setTimeout(() => {
      setToasts(prev => prev.filter(t => t.id !== id));
    }, duration);

    return id;
  }, []);

  const removeToast = useCallback((id) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  }, []);

  // ========================
  // NOTIFICATION CENTER
  // ========================

  const addNotification = useCallback((notification) => {
    const newNotif = {
      id: Date.now() + Math.random(),
      timestamp: new Date().toISOString(),
      read: false,
      ...notification
    };

    setNotificationHistory(prev => [newNotif, ...prev].slice(0, 100)); // Keep last 100
    setUnreadNotifications(prev => prev + 1);

    // Play sound if enabled
    if (notificationPrefs.sound) {
      playBeep(800, 0.2);
    }

    // Show browser notification if enabled
    if (notificationPrefs.browser && typeof Notification !== 'undefined' && Notification.permission === 'granted') {
      new Notification(notification.title || 'MODUS Alert', {
        body: notification.message || '',
        icon: '/favicon.ico',
        tag: `modus-${newNotif.id}`,
        silent: true // We handle our own sound
      });
    }
  }, [notificationPrefs, playBeep]);

  const markAllNotificationsRead = useCallback(() => {
    setNotificationHistory(prev => prev.map(n => ({ ...n, read: true })));
    setUnreadNotifications(0);
  }, []);

  const clearNotifications = useCallback(() => {
    setNotificationHistory([]);
    setUnreadNotifications(0);
  }, []);

  const requestNotificationPermission = useCallback(async () => {
    if (typeof Notification !== 'undefined' && Notification.permission === 'default') {
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        addNotification({
          type: 'system',
          title: 'Notifications Enabled',
          message: 'You will now receive browser notifications for price alerts and important events.',
          icon: '🔔'
        });
      }
    }
  }, [addNotification]);

  // Earnings calendar estimation for watchlist stocks
  const getEstimatedEarnings = useCallback((symbols) => {
    const now = new Date();
    const currentMonth = now.getMonth(); // 0-11
    const currentYear = now.getFullYear();

    // Typical earnings seasons: Jan (Q4), Apr (Q1), Jul (Q2), Oct (Q3)
    const earningsMonths = [0, 3, 6, 9]; // Jan, Apr, Jul, Oct

    // Find next earnings month
    const nextEarningsMonth = earningsMonths.find(m => m > currentMonth) ?? earningsMonths[0];
    const nextEarningsYear = nextEarningsMonth <= currentMonth ? currentYear + 1 : currentYear;
    const nextEarningsDate = new Date(nextEarningsYear, nextEarningsMonth, 15); // ~mid month
    const daysUntil = Math.ceil((nextEarningsDate - now) / (1000 * 60 * 60 * 24));

    // Map earnings periods to quarter labels
    const quarterMap = { 0: 'Q4', 3: 'Q1', 6: 'Q2', 9: 'Q3' };
    const quarter = quarterMap[nextEarningsMonth] || 'Q?';

    // Some well-known companies with approximate earnings dates
    const knownEarnings = {
      'AAPL': { typical: 'Late Jan, Late Apr, Late Jul, Late Oct' },
      'MSFT': { typical: 'Late Jan, Late Apr, Late Jul, Late Oct' },
      'GOOGL': { typical: 'Late Jan, Late Apr, Late Jul, Late Oct' },
      'AMZN': { typical: 'Early Feb, Late Apr, Late Jul, Late Oct' },
      'META': { typical: 'Early Feb, Late Apr, Late Jul, Late Oct' },
      'TSLA': { typical: 'Late Jan, Late Apr, Late Jul, Late Oct' },
      'NVDA': { typical: 'Late Feb, Late May, Late Aug, Late Nov' },
      'JPM': { typical: 'Mid Jan, Mid Apr, Mid Jul, Mid Oct' },
      'BAC': { typical: 'Mid Jan, Mid Apr, Mid Jul, Mid Oct' },
      'DIS': { typical: 'Early Feb, Early May, Early Aug, Early Nov' },
      'NFLX': { typical: 'Mid Jan, Mid Apr, Mid Jul, Mid Oct' },
    };

    return symbols.map(sym => ({
      symbol: sym,
      nextSeason: quarter,
      daysUntil,
      approximateDate: nextEarningsDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
      known: knownEarnings[sym]?.typical || null,
      isEarningsSeason: daysUntil <= 30
    }));
  }, []);

  // Data Backup & Restore
  const exportAllData = useCallback(() => {
    const data = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      watchlist: watchlist,
      trades: trades,
      alerts: alerts,
      portfolio: portfolio,
      tradePlans: tradePlans,
      paperTradingAccount: paperTradingAccount,
      analysisHistory: analysisHistory,
      notificationPrefs: notificationPrefs,
      portfolioSettings: portfolioSettings,
      // Collect localStorage settings
      settings: {}
    };
    // Grab relevant localStorage keys
    ['modus_active_tab', 'modus_sidebar_collapsed', 'modus_discord_webhook', 'sms_settings'].forEach(key => {
      try { const val = localStorage.getItem(key); if (val) data.settings[key] = val; } catch {}
    });
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `modus-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }, [watchlist, trades, alerts, portfolio, tradePlans, paperTradingAccount, analysisHistory, notificationPrefs, portfolioSettings]);

  const importAllData = useCallback((file) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (!data.version) { alert('Invalid backup file'); return; }
        if (data.watchlist) setWatchlist(data.watchlist);
        if (data.trades) setTrades(data.trades);
        if (data.alerts) setAlerts(data.alerts);
        if (data.portfolio) setPortfolio(data.portfolio);
        if (data.tradePlans) setTradePlans(data.tradePlans);
        if (data.paperTradingAccount) setPaperTradingAccount(data.paperTradingAccount);
        if (data.analysisHistory) setAnalysisHistory(data.analysisHistory);
        if (data.notificationPrefs) setNotificationPrefs(data.notificationPrefs);
        if (data.portfolioSettings) setPortfolioSettings(data.portfolioSettings);
        if (data.settings) {
          Object.entries(data.settings).forEach(([key, val]) => {
            try { localStorage.setItem(key, val); } catch {}
          });
        }
        alert(`Data restored from ${data.exportDate ? new Date(data.exportDate).toLocaleDateString() : 'backup'}! ${data.trades?.length || 0} trades, ${data.watchlist?.length || 0} watchlist items.`);
      } catch (err) {
        alert('Error reading backup file: ' + err.message);
      }
    };
    reader.readAsText(file);
  }, []);

  // KEYBOARD SHORTCUTS
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Don't trigger shortcuts when typing in inputs
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

      // Ctrl/Cmd + K: Quick search (focus ticker input)
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        setActiveTab('ticker');
        setTimeout(() => {
          const tickerInput = document.querySelector('input[placeholder*="symbol"], input[placeholder*="ticker"], input[placeholder*="Symbol"]');
          if (tickerInput) tickerInput.focus();
        }, 100);
      }

      // Ctrl/Cmd + E: Export PDF
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        if (typeof exportToPDF === 'function') exportToPDF();
      }

      // Ctrl/Cmd + Shift + S: Share analysis
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'S') {
        e.preventDefault();
        setShowShareModal(true);
      }

      // Ctrl/Cmd + B: Toggle sidebar
      if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        setSidebarCollapsed(prev => !prev);
      }

      // Ctrl/Cmd + ,: Open settings
      if ((e.ctrlKey || e.metaKey) && e.key === ',') {
        e.preventDefault();
        setShowApiKeyModal(true);
      }

      // Escape: Close modals
      if (e.key === 'Escape') {
        if (showNotificationCenter) setShowNotificationCenter(false);
        else if (showShareModal) setShowShareModal(false);
        else if (showInfoPage) setShowInfoPage(null);
        else if (showShortcuts) setShowShortcuts(false);
      }

      // ?: Show keyboard shortcuts
      if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
        setShowShortcuts(prev => !prev);
      }

      // Number keys 1-9 for quick tab switching
      if (!e.ctrlKey && !e.metaKey && !e.altKey && e.key >= '1' && e.key <= '9') {
        const tabMap = {
          '1': 'ticker',
          '2': 'analyze',
          '3': 'alerts',
          '4': 'watchlist',
          '5': 'screener',
          '6': 'journal',
          '7': 'portfolio',
          '8': 'daily',
          '9': 'ask'
        };
        if (tabMap[e.key]) {
          setActiveTab(tabMap[e.key]);
        }
      }

      // Alt + N: New trade
      if (e.altKey && e.key === 'n') {
        e.preventDefault();
        setActiveTab('journal');
      }

      // Alt + A: Quick add to watchlist
      if (e.altKey && e.key === 'a') {
        e.preventDefault();
        setActiveTab('watchlist');
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [showNotificationCenter, showShareModal, showInfoPage, showShortcuts]);

  // Request notification permission on first load
  useEffect(() => {
    if (typeof Notification !== 'undefined' && Notification.permission === 'default') {
      // Delay permission request to not be intrusive
      const timer = setTimeout(() => {
        requestNotificationPermission();
      }, 10000);
      return () => clearTimeout(timer);
    }
  }, []);

  // ========================
  // SOCIAL SHARING
  // ========================

  const generateShareText = useCallback((analysisData) => {
    if (!analysisData) return '';

    const symbol = analysisData.context?.ticker || analysisData.symbol || 'N/A';
    const score = Math.round(analysisData.final?.confidenceScore || 0);
    const recommendation = (analysisData.final?.recommendation || 'HOLD').replace(/_/g, ' ');
    const trend = analysisData.patterns?.trendAnalysis?.trend || 'N/A';
    const summary = analysisData.final?.summary || '';

    // Truncate summary for sharing
    const shortSummary = summary.length > 200 ? summary.substring(0, 197) + '...' : summary;

    return `📊 $${symbol} Analysis via MODUS\n\n` +
      `Score: ${score}/100 | ${recommendation}\n` +
      `Trend: ${trend}\n\n` +
      `${shortSummary}\n\n` +
      `#Trading #StockAnalysis #MODUS`;
  }, []);

  const shareAnalysis = useCallback(async (method = 'native') => {
    const text = generateShareText(analysis);
    if (!text) return;

    setShareContent(text);

    switch (method) {
      case 'native':
        // Web Share API (mobile-first)
        if (navigator.share) {
          try {
            await navigator.share({
              title: `MODUS Analysis - ${analysis?.context?.ticker || 'Stock'}`,
              text: text,
              url: window.location.href
            });
            addNotification({ type: 'system', title: 'Shared!', message: 'Analysis shared successfully', icon: '✅' });
          } catch (e) {
            if (e.name !== 'AbortError') {
              // Fallback to copy
              shareAnalysis('copy');
            }
          }
        } else {
          // Fallback to showing share modal
          setShowShareModal(true);
        }
        break;

      case 'twitter':
        const tweetText = encodeURIComponent(text.substring(0, 280));
        window.open(`https://twitter.com/intent/tweet?text=${tweetText}`, '_blank', 'width=550,height=420');
        break;

      case 'copy':
        try {
          await navigator.clipboard.writeText(text);
          setCopySuccess(true);
          setTimeout(() => setCopySuccess(false), 2000);
          addNotification({ type: 'system', title: 'Copied!', message: 'Analysis copied to clipboard', icon: '📋' });
        } catch (e) {
          // Fallback for older browsers
          const textarea = document.createElement('textarea');
          textarea.value = text;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          setCopySuccess(true);
          setTimeout(() => setCopySuccess(false), 2000);
        }
        break;

      case 'reddit':
        const redditTitle = encodeURIComponent(`$${analysis?.context?.ticker || 'Stock'} Technical Analysis - Score: ${Math.round(analysis?.final?.confidenceScore || 0)}/100`);
        const redditText = encodeURIComponent(text);
        window.open(`https://www.reddit.com/submit?title=${redditTitle}&selftext=${redditText}`, '_blank');
        break;
    }
  }, [analysis, generateShareText, addNotification]);

  const shareTradeIdea = useCallback((idea) => {
    const text = `💡 Trade Idea via MODUS\n\n` +
      `$${idea.symbol} - ${idea.direction}\n` +
      `Entry: $${idea.entry} | Stop: $${idea.stop} | Target: $${idea.target}\n` +
      `R/R: ${idea.riskReward || 'N/A'}\n\n` +
      `${idea.reason || ''}\n\n#Trading #MODUS`;

    if (navigator.share) {
      navigator.share({ title: `Trade Idea - ${idea.symbol}`, text });
    } else {
      navigator.clipboard.writeText(text).then(() => {
        setCopySuccess(true);
        setTimeout(() => setCopySuccess(false), 2000);
      });
    }
  }, []);

  // ========================
  // PERFORMANCE DASHBOARD METRICS
  // ========================
  const performanceMetrics = useMemo(() => {
    if (!trades || trades.length === 0) {
      return { totalTrades: 0, winRate: 0, totalPnL: 0, avgWin: 0, avgLoss: 0, profitFactor: 0, bestTrade: null, worstTrade: null, streak: 0, avgHoldTime: 0, sharpe: 0 };
    }
    const closedTrades = trades.filter(t => t.exit && t.entry);
    if (closedTrades.length === 0) {
      return { totalTrades: trades.length, openTrades: trades.length, winRate: 0, totalPnL: 0, avgWin: 0, avgLoss: 0, profitFactor: 0, bestTrade: null, worstTrade: null, streak: 0, avgHoldTime: 0, sharpe: 0 };
    }

    const results = closedTrades.map(t => {
      const entry = parseFloat(t.entry);
      const exit = parseFloat(t.exit);
      const qty = parseFloat(t.quantity) || 1;
      const pnl = t.side === 'long' ? (exit - entry) * qty : (entry - exit) * qty;
      const pnlPercent = t.side === 'long' ? ((exit - entry) / entry) * 100 : ((entry - exit) / entry) * 100;
      const holdDays = t.entryDate && t.exitDate ? Math.ceil((new Date(t.exitDate) - new Date(t.entryDate)) / (1000 * 60 * 60 * 24)) : 0;
      return { ...t, pnl, pnlPercent, holdDays };
    });

    const wins = results.filter(r => r.pnl > 0);
    const losses = results.filter(r => r.pnl < 0);
    const totalPnL = results.reduce((sum, r) => sum + r.pnl, 0);
    const grossWins = wins.reduce((sum, r) => sum + r.pnl, 0);
    const grossLosses = Math.abs(losses.reduce((sum, r) => sum + r.pnl, 0));

    // Calculate current streak
    let streak = 0;
    for (let i = results.length - 1; i >= 0; i--) {
      if (i === results.length - 1) {
        streak = results[i].pnl >= 0 ? 1 : -1;
      } else if ((streak > 0 && results[i].pnl >= 0) || (streak < 0 && results[i].pnl < 0)) {
        streak += streak > 0 ? 1 : -1;
      } else break;
    }

    // Simplified Sharpe-like ratio (annualized)
    const avgReturn = results.reduce((sum, r) => sum + r.pnlPercent, 0) / results.length;
    const variance = results.reduce((sum, r) => sum + Math.pow(r.pnlPercent - avgReturn, 2), 0) / results.length;
    const stdDev = Math.sqrt(variance) || 1;
    const sharpe = (avgReturn / stdDev) * Math.sqrt(252);

    const sorted = [...results].sort((a, b) => b.pnl - a.pnl);

    return {
      totalTrades: trades.length,
      closedTrades: closedTrades.length,
      openTrades: trades.length - closedTrades.length,
      winRate: (wins.length / results.length) * 100,
      wins: wins.length,
      losses: losses.length,
      totalPnL,
      avgWin: wins.length > 0 ? grossWins / wins.length : 0,
      avgLoss: losses.length > 0 ? grossLosses / losses.length : 0,
      profitFactor: grossLosses > 0 ? grossWins / grossLosses : grossWins > 0 ? Infinity : 0,
      bestTrade: sorted[0] || null,
      worstTrade: sorted[sorted.length - 1] || null,
      streak,
      avgHoldTime: results.reduce((sum, r) => sum + r.holdDays, 0) / results.length,
      sharpe: isFinite(sharpe) ? sharpe : 0,
      monthlyPnL: results.reduce((acc, r) => {
        if (r.exitDate) {
          const month = r.exitDate.substring(0, 7);
          acc[month] = (acc[month] || 0) + r.pnl;
        }
        return acc;
      }, {})
    };
  }, [trades]);

  // ========================
  // SCREENER PRESET STRATEGIES
  // ========================

  const SCAN_PRESETS = useMemo(() => ({
    custom: {
      name: 'Custom Scan',
      icon: '🔧',
      description: 'Set your own filters',
      criteria: null
    },
    oversold_bounce: {
      name: 'RSI Oversold Bounce',
      icon: '📉',
      description: 'Stocks with RSI < 30 showing reversal potential',
      filter: (stock) => stock.rsi < 30 && stock.trend !== 'DOWN'
    },
    overbought: {
      name: 'RSI Overbought',
      icon: '📈',
      description: 'Stocks with RSI > 70, potential pullback candidates',
      filter: (stock) => stock.rsi > 70
    },
    volume_breakout: {
      name: 'Volume Breakout',
      icon: '🔥',
      description: 'Unusual volume with strong price movement',
      filter: (stock) => stock.volumeRatio > 2.0 && Math.abs(stock.change) > 2
    },
    bullish_momentum: {
      name: 'Bullish Momentum',
      icon: '🚀',
      description: 'Strong uptrend with MACD and SMA confirmation',
      filter: (stock) => stock.trend === 'UP' && stock.macdSignal === 'Bullish' && stock.aboveSMA20 && stock.aboveSMA50
    },
    bearish_breakdown: {
      name: 'Bearish Breakdown',
      icon: '🐻',
      description: 'Stocks breaking down below key moving averages',
      filter: (stock) => stock.trend === 'DOWN' && !stock.aboveSMA20 && !stock.aboveSMA50
    },
    golden_cross: {
      name: 'Golden Cross Setup',
      icon: '✨',
      description: 'SMA20 above SMA50 with bullish momentum',
      filter: (stock) => stock.aboveSMA20 && stock.aboveSMA50 && stock.rsi > 50 && stock.rsi < 70
    },
    high_conviction: {
      name: 'High Conviction',
      icon: '🎯',
      description: 'Strong BUY or SELL signals with multiple confirmations',
      filter: (stock) => stock.recommendation === 'BUY' || stock.recommendation === 'SELL'
    },
    dip_buy: {
      name: 'Buy the Dip',
      icon: '💰',
      description: 'Quality stocks down >3% with RSI support',
      filter: (stock) => stock.change < -3 && stock.rsi < 40 && stock.aboveSMA50
    }
  }), []);

  // Apply preset filter to scan results
  const getFilteredScanResults = useCallback(() => {
    if (!scanResults || scanResults.length === 0) return [];

    if (selectedScanPreset === 'custom') {
      // Apply manual criteria filters
      return scanResults.filter(stock => {
        if (scanCriteria.minPrice && stock.price < parseFloat(scanCriteria.minPrice)) return false;
        if (scanCriteria.maxPrice && stock.price > parseFloat(scanCriteria.maxPrice)) return false;
        if (scanCriteria.rsiMin && stock.rsi < parseFloat(scanCriteria.rsiMin)) return false;
        if (scanCriteria.rsiMax && stock.rsi > parseFloat(scanCriteria.rsiMax)) return false;
        if (scanCriteria.minVolume && stock.volumeRaw < parseFloat(scanCriteria.minVolume)) return false;
        return true;
      });
    }

    const preset = SCAN_PRESETS[selectedScanPreset];
    if (preset && preset.filter) {
      return scanResults.filter(preset.filter);
    }

    return scanResults;
  }, [scanResults, selectedScanPreset, scanCriteria, SCAN_PRESETS]);

  // ========================
  // TRADING JOURNAL
  // ========================

  const openAddTrade = () => {
    setNewTrade({
      symbol: analysis?.symbol || tickerSymbol || "",
      side: "long",
      entry: "",
      exit: "",
      avgPrice: "",
      stopLoss: "",
      target: "",
      quantity: "",
      entryDate: new Date().toISOString().split('T')[0],
      exitDate: "",
      notes: "",
      linkedAnalysisId: analysis ? Date.now() : null,
      isPaperTrade: false,
      confidence: ""
    });
    setShowAddTrade(true);
  };
  
  const saveTrade = () => {
    if (!newTrade.symbol || !newTrade.entry) {
      showToast("Symbol and Entry price are required!", "error");
      return;
    }
    
    const trade = {
      id: Date.now(),
      ...newTrade,
      pnl: newTrade.exit ? 
        (parseFloat(newTrade.exit) - parseFloat(newTrade.entry)) * parseFloat(newTrade.quantity || 1) : 
        null,
      pnlPercent: newTrade.exit ?
        ((parseFloat(newTrade.exit) - parseFloat(newTrade.entry)) / parseFloat(newTrade.entry)) * 100 :
        null,
      status: newTrade.exit ? "closed" : "open"
    };
    
    setTrades([trade, ...trades]);

    // Track journal entry
    trackEvent('journal', 'add_entry', newTrade.symbol);
    if (newTrade.isPaperTrade) {
      trackEvent('paper_trading', 'execute', newTrade.symbol);
    }

    // UPDATE PAPER TRADING BALANCE if this is a paper trade with exit
    if (newTrade.isPaperTrade && newTrade.exit && trade.pnl !== null) {
      setPaperTradingAccount(prev => ({
        ...prev,
        balance: prev.balance + trade.pnl,
        trades: [trade, ...prev.trades]
      }));
      alert(`✅ Paper Trade saved! P&L: ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}\nNew Balance: $${(paperTradingAccount.balance + trade.pnl).toLocaleString()}`);
    } else {
      showToast("Trade saved to journal!", "success");
    }
    
    setShowAddTrade(false);
  };
  
  // EXPORT TRADES TO CSV
  const exportTradesToCSV = useCallback(() => {
    if (trades.length === 0) return;

    const headers = ['Symbol', 'Side', 'Entry', 'Exit', 'Stop Loss', 'Target', 'Quantity', 'Entry Date', 'Exit Date', 'P&L ($)', 'P&L (%)', 'Status', 'Notes'];
    const rows = trades.map(t => [
      t.symbol,
      t.side,
      t.entry,
      t.exit || '',
      t.stopLoss || '',
      t.target || '',
      t.quantity || '',
      t.entryDate || '',
      t.exitDate || '',
      t.pnl != null ? t.pnl.toFixed(2) : '',
      t.pnlPercent != null ? t.pnlPercent.toFixed(2) + '%' : '',
      t.status || 'open',
      (t.notes || '').replace(/,/g, ';').replace(/\n/g, ' ')
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `MODUS_Trades_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  }, [trades]);

  // EXPORT PORTFOLIO TO CSV
  const exportPortfolioToCSV = useCallback(() => {
    if (portfolio.length === 0) return;

    const headers = ['Symbol', 'Quantity', 'Avg Price', 'Current Price', 'Total Value', 'Total Cost', 'P&L ($)', 'P&L (%)', 'Notes'];
    const rows = portfolio.map(p => [
      p.symbol,
      p.quantity,
      p.avgPrice?.toFixed(2) || '',
      p.currentPrice?.toFixed(2) || '',
      p.totalValue?.toFixed(2) || '',
      p.totalCost?.toFixed(2) || '',
      p.pnl?.toFixed(2) || '',
      p.pnlPercent?.toFixed(2) + '%' || '',
      (p.notes || '').replace(/,/g, ';').replace(/\n/g, ' ')
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `MODUS_Portfolio_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  }, [portfolio]);

  const deleteTrade = (id) => {
    const tradeToDelete = trades.find(t => t.id === id);

    setConfirmMessage("Delete this trade? This cannot be undone." +
      (tradeToDelete?.isPaperTrade && tradeToDelete?.pnl ?
        `\n\nThis will also reverse the P&L (${tradeToDelete.pnl >= 0 ? '+' : ''}$${tradeToDelete.pnl.toFixed(2)}) from your paper trading balance.` : ""));

    setConfirmAction(() => () => {
      // Remove from trades
      setTrades(trades.filter(t => t.id !== id));

      // If it was a paper trade with P&L, reverse it from balance
      if (tradeToDelete?.isPaperTrade && tradeToDelete?.pnl) {
        setPaperTradingAccount(prev => ({
          ...prev,
          balance: prev.balance - tradeToDelete.pnl, // Reverse the P&L
          trades: prev.trades.filter(t => t.id !== id)
        }));
      }

      setShowConfirmModal(false);
    });
    setShowConfirmModal(true);
  };
  
  const updateTrade = (id, updates) => {
    setTrades(trades.map(t => t.id === id ? { ...t, ...updates } : t));
  };

  // Open Edit Trade Modal
  const openEditTrade = (trade) => {
    setEditingTrade({
      ...trade,
      entry: trade.entry?.toString() || "",
      exit: trade.exit?.toString() || "",
      avgPrice: trade.avgPrice?.toString() || "",
      stopLoss: trade.stopLoss?.toString() || "",
      target: trade.target?.toString() || "",
      quantity: trade.quantity?.toString() || "",
      confidence: trade.confidence?.toString() || ""
    });
    setShowEditTrade(true);
  };

  // Save Edited Trade
  const saveEditTrade = () => {
    if (!editingTrade.symbol || !editingTrade.entry) {
      showToast("Symbol and Entry price are required!", "error");
      return;
    }

    const entry = parseFloat(editingTrade.entry);
    const exit = editingTrade.exit ? parseFloat(editingTrade.exit) : null;
    const quantity = parseFloat(editingTrade.quantity || 1);

    // Calculate new P&L
    const newPnl = exit ? (exit - entry) * quantity * (editingTrade.side === "short" ? -1 : 1) : null;
    const newPnlPercent = exit ? ((exit - entry) / entry) * 100 * (editingTrade.side === "short" ? -1 : 1) : null;

    const updatedTrade = {
      ...editingTrade,
      entry,
      exit,
      quantity,
      avgPrice: editingTrade.avgPrice ? parseFloat(editingTrade.avgPrice) : null,
      stopLoss: editingTrade.stopLoss ? parseFloat(editingTrade.stopLoss) : null,
      target: editingTrade.target ? parseFloat(editingTrade.target) : null,
      pnl: newPnl,
      pnlPercent: newPnlPercent,
      status: exit ? "closed" : "open"
    };

    // Find the original trade to calculate P&L difference
    const originalTrade = trades.find(t => t.id === editingTrade.id);
    const oldPnl = originalTrade?.pnl || 0;

    // Update trades list
    setTrades(trades.map(t => t.id === editingTrade.id ? updatedTrade : t));

    // UPDATE PAPER TRADING BALANCE if P&L changed
    if (editingTrade.isPaperTrade || originalTrade?.isPaperTrade) {
      const pnlDifference = (newPnl || 0) - (oldPnl || 0);

      if (pnlDifference !== 0) {
        setPaperTradingAccount(prev => {
          // Update the trade in paper trading trades list
          const updatedPaperTrades = prev.trades.map(t =>
            t.id === editingTrade.id ? updatedTrade : t
          );

          return {
            ...prev,
            balance: prev.balance + pnlDifference,
            trades: updatedPaperTrades
          };
        });

        showToast(`Trade updated! P&L changed: ${pnlDifference >= 0 ? '+' : ''}$${pnlDifference.toFixed(2)}. Paper trading balance updated.`, "success");
      } else {
        showToast("Trade updated!", "success");
      }
    } else {
      showToast("Trade updated!", "success");
    }

    setShowEditTrade(false);
    setEditingTrade(null);
  };

  // ========================
  // DYNAMIC ECONOMIC CALENDAR GENERATION
  // ========================
  
  const generateEconomicEvents = () => {
    console.log("[Economic Calendar] 🔄 Generating events for 6 months...");
    const today = new Date();
    const events = [];

    // Generate events for 6 months (3 months back, current, 2 months forward) to cover all navigation
    const startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1); // 2 months back
    const endDate = new Date(today.getFullYear(), today.getMonth() + 4, 0); // 3 months forward
    
    // Comprehensive event templates with realistic data
    const eventTemplates = [
      {
        event: "Initial Jobless Claims",
        time: "8:30 AM",
        importance: "high",
        description: "Weekly measure of new unemployment claims. Higher than expected numbers indicate weakness in the labor market.",
        impact: "High impact on USD. Better than expected (lower) is bullish for USD.",
        generateForecast: () => `${Math.floor(Math.random() * 30 + 210)}K`,
        generatePrevious: () => `${Math.floor(Math.random() * 30 + 210)}K`
      },
      {
        event: "CPI (Consumer Price Index)",
        time: "8:30 AM",
        importance: "high",
        description: "Measures change in the price of goods and services. Key inflation indicator.",
        impact: "EXTREME impact. Higher inflation may lead to rate hikes, negative for stocks.",
        generateForecast: () => `${(Math.random() * 0.5 + 0.2).toFixed(1)}%`,
        generatePrevious: () => `${(Math.random() * 0.5 + 0.2).toFixed(1)}%`
      },
      {
        event: "Fed Interest Rate Decision",
        time: "2:00 PM",
        importance: "high",
        description: "Federal Reserve's decision on the target interest rate. Major market mover.",
        impact: "EXTREME impact. Rate changes cause significant market volatility.",
        generateForecast: () => `${(Math.random() * 0.5 + 5.0).toFixed(2)}%`,
        generatePrevious: () => `${(Math.random() * 0.5 + 5.0).toFixed(2)}%`
      },
      {
        event: "Non-Farm Payrolls",
        time: "8:30 AM",
        importance: "high",
        description: "Number of jobs added to the economy. Strongest labor market indicator.",
        impact: "EXTREME impact. Better than expected is bullish for USD, bearish for bonds.",
        generateForecast: () => `${Math.floor(Math.random() * 100 + 150)}K`,
        generatePrevious: () => `${Math.floor(Math.random() * 100 + 150)}K`
      },
      {
        event: "GDP Growth Rate",
        time: "8:30 AM",
        importance: "high",
        description: "Quarterly change in the value of goods and services produced.",
        impact: "High impact. Primary indicator of economic health.",
        generateForecast: () => `${(Math.random() * 1.5 + 2.0).toFixed(1)}%`,
        generatePrevious: () => `${(Math.random() * 1.5 + 2.0).toFixed(1)}%`
      },
      {
        event: "Retail Sales",
        time: "8:30 AM",
        importance: "high",
        description: "Measures total receipts of retail stores. Indicates consumer spending strength.",
        impact: "High impact. Strong sales indicate economic growth.",
        generateForecast: () => `${(Math.random() * 1.0 + 0.2).toFixed(1)}%`,
        generatePrevious: () => `${(Math.random() * 1.0 + 0.2).toFixed(1)}%`
      },
      {
        event: "PMI Manufacturing",
        time: "9:45 AM",
        importance: "high",
        description: "Purchasing Managers' Index measuring manufacturing sector activity. Above 50 indicates expansion.",
        impact: "High impact indicator of economic health.",
        generateForecast: () => `${(Math.random() * 3 + 50).toFixed(1)}`,
        generatePrevious: () => `${(Math.random() * 3 + 50).toFixed(1)}`
      },
      {
        event: "Existing Home Sales",
        time: "10:00 AM",
        importance: "medium",
        description: "Measures the number of previously owned homes sold during the month.",
        impact: "Medium impact. Higher sales indicate economic strength.",
        generateForecast: () => `${(Math.random() * 0.5 + 4.0).toFixed(2)}M`,
        generatePrevious: () => `${(Math.random() * 0.5 + 4.0).toFixed(2)}M`
      },
      {
        event: "Personal Income",
        time: "8:30 AM",
        importance: "medium",
        description: "Monthly change in income received from all sources.",
        impact: "Medium impact. Indicates consumer spending power.",
        generateForecast: () => `${(Math.random() * 0.4 + 0.2).toFixed(1)}%`,
        generatePrevious: () => `${(Math.random() * 0.4 + 0.2).toFixed(1)}%`
      },
      {
        event: "Consumer Confidence",
        time: "10:00 AM",
        importance: "medium",
        description: "Survey measuring consumer optimism about the economy.",
        impact: "Medium impact. Higher confidence leads to increased spending.",
        generateForecast: () => `${Math.floor(Math.random() * 20 + 100)}`,
        generatePrevious: () => `${Math.floor(Math.random() * 20 + 100)}`
      },
      {
        event: "Industrial Production",
        time: "9:15 AM",
        importance: "medium",
        description: "Monthly change in manufacturing, mining, and utilities output.",
        impact: "Medium impact. Indicates industrial sector health.",
        generateForecast: () => `${(Math.random() * 0.6 + 0.1).toFixed(1)}%`,
        generatePrevious: () => `${(Math.random() * 0.6 + 0.1).toFixed(1)}%`
      },
      {
        event: "Building Permits",
        time: "8:30 AM",
        importance: "medium",
        description: "Number of new building permits issued. Leading indicator for housing.",
        impact: "Medium impact. Higher permits signal future construction activity.",
        generateForecast: () => `${(Math.random() * 0.2 + 1.4).toFixed(2)}M`,
        generatePrevious: () => `${(Math.random() * 0.2 + 1.4).toFixed(2)}M`
      },
      {
        event: "Durable Goods Orders",
        time: "8:30 AM",
        importance: "medium",
        description: "Orders for goods meant to last 3+ years. Indicates business investment.",
        impact: "Medium impact. Strong orders suggest economic optimism.",
        generateForecast: () => `${(Math.random() * 2.0 - 0.5).toFixed(1)}%`,
        generatePrevious: () => `${(Math.random() * 2.0 - 0.5).toFixed(1)}%`
      },
      {
        event: "FOMC Meeting Minutes",
        time: "2:00 PM",
        importance: "high",
        description: "Detailed record of Federal Reserve policy meeting.",
        impact: "High impact. Provides insight into future policy decisions.",
        generateForecast: () => "N/A",
        generatePrevious: () => "N/A"
      },
      {
        event: "PPI (Producer Price Index)",
        time: "8:30 AM",
        importance: "high",
        description: "Measures change in prices received by producers. Leading inflation indicator.",
        impact: "High impact. Precursor to consumer inflation.",
        generateForecast: () => `${(Math.random() * 0.5 + 0.2).toFixed(1)}%`,
        generatePrevious: () => `${(Math.random() * 0.5 + 0.2).toFixed(1)}%`
      },
      {
        event: "Government Funding Deadline",
        time: "11:59 PM",
        importance: "high",
        description: "Deadline for Congress to pass funding bill. Failure triggers partial government shutdown.",
        impact: "HIGH impact. Shutdown affects federal workers, government services, and market sentiment.",
        generateForecast: () => "Pending",
        generatePrevious: () => "Passed"
      },
      {
        event: "Debt Ceiling Deadline",
        time: "All Day",
        importance: "high",
        description: "Treasury Department deadline for raising the debt limit. Failure could lead to default.",
        impact: "EXTREME impact. Potential default would cause major market volatility and credit downgrades.",
        generateForecast: () => "TBD",
        generatePrevious: () => "Raised"
      },
      {
        event: "Treasury Auction (10-Year)",
        time: "1:00 PM",
        importance: "medium",
        description: "Treasury Department auction of 10-year bonds. Key indicator of borrowing costs.",
        impact: "Medium impact. Weak demand increases yields, pressures growth stocks.",
        generateForecast: () => `${(Math.random() * 0.5 + 4.0).toFixed(2)}%`,
        generatePrevious: () => `${(Math.random() * 0.5 + 4.0).toFixed(2)}%`
      }
    ];
    
    // Generate events for full 3-month range (previous, current, next month)
    const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));

    for (let i = 0; i < totalDays; i++) {
      const eventDate = new Date(startDate);
      eventDate.setDate(startDate.getDate() + i);

      // Skip weekends (Saturday = 6, Sunday = 0)
      if (eventDate.getDay() === 0 || eventDate.getDay() === 6) {
        continue;
      }

      // Use date as seed for consistent events (so they don't change on refresh)
      const dateSeed = eventDate.getFullYear() * 10000 + (eventDate.getMonth() + 1) * 100 + eventDate.getDate();
      const seededRandom = (seed, offset = 0) => {
        const x = Math.sin(seed + offset) * 10000;
        return x - Math.floor(x);
      };

      // Add 2-4 events per weekday based on date seed
      const numEvents = Math.floor(seededRandom(dateSeed) * 3) + 2;

      // Deterministically shuffle templates based on date
      const shuffledTemplates = [...eventTemplates].sort((a, b) =>
        seededRandom(dateSeed, eventTemplates.indexOf(a)) - seededRandom(dateSeed, eventTemplates.indexOf(b))
      );

      for (let j = 0; j < numEvents && j < shuffledTemplates.length; j++) {
        const template = shuffledTemplates[j];

        events.push({
          id: `${eventDate.toISOString().split('T')[0]}-${j}`,
          date: eventDate.toISOString().split('T')[0],
          time: template.time,
          event: template.event,
          importance: template.importance,
          forecast: template.generateForecast(),
          previous: template.generatePrevious(),
          description: template.description,
          impact: template.impact
        });
      }
    }

    // Sort by date
    const sortedEvents = events.sort((a, b) => new Date(a.date) - new Date(b.date));

    console.log(`[Economic Calendar] ✅ Generated ${sortedEvents.length} events for 6 months`);
    console.log(`[Economic Calendar] Date range: ${sortedEvents[0]?.date} to ${sortedEvents[sortedEvents.length - 1]?.date}`);
    
    return sortedEvents;
  };
  
  // Auto-refresh calendar at midnight and on mount
  useEffect(() => {
    console.log("[Economic Calendar] 🎬 Initializing auto-refresh system...");
    
    // Generate events on mount
    const initialEvents = generateEconomicEvents();
    setEconomicEvents(initialEvents);
    
    // Calculate time until midnight
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0, 0, 0, 0);
    const msUntilMidnight = tomorrow - now;
    
    console.log(`[Economic Calendar] ⏰ Next auto-refresh in ${(msUntilMidnight / 1000 / 60 / 60).toFixed(1)} hours (at midnight)`);
    
    // Set up midnight refresh
    const midnightTimer = setTimeout(() => {
      console.log("[Economic Calendar] 🌙 Midnight refresh triggered!");
      const newEvents = generateEconomicEvents();
      setEconomicEvents(newEvents);
      
      // Set up daily refresh interval
      const dailyInterval = setInterval(() => {
        console.log("[Economic Calendar] 📅 Daily refresh - generating fresh events...");
        const refreshedEvents = generateEconomicEvents();
        setEconomicEvents(refreshedEvents);
      }, 24 * 60 * 60 * 1000); // Every 24 hours
      
      return () => clearInterval(dailyInterval);
    }, msUntilMidnight);
    
    return () => clearTimeout(midnightTimer);
  }, []);
  
  // ========================
  // END ECONOMIC CALENDAR GENERATION
  // ========================
  
  // TRADE IDEAS - OPTIMIZED WITH PARALLEL PROCESSING (10x faster)
  const [tradeIdeasProgress, setTradeIdeasProgress] = useState({ phase: 'idle', current: 0, total: 0, scanTime: 0 });

  const generateRealTradeIdeas = async () => {
    setLoadingTradeIdeas(true);
    const scanStartTime = Date.now();
    setTradeIdeasProgress({ phase: 'starting', current: 0, total: PRIORITY_STOCKS.length, scanTime: 0 });
    console.log("[Trade Ideas] 🚀 FAST PARALLEL scan starting...");

    const startTime = Date.now();

    try {
      // Scan ALL 200+ stocks for comprehensive analysis
      const results = await processStocksInParallel(
        PRIORITY_STOCKS,
        analyzeStockFast,
        {
          batchSize: 15,      // Process 15 at a time (more reliable)
          maxResults: 20,     // Get top 20 actionable results
          minScore: 0,        // Don't filter by score here
          timeout: 4000,      // 4s timeout per stock
          onProgress: (progress) => setTradeIdeasProgress(progress)
        }
      );

      // Filter for actionable recommendations (BUY/SELL, not HOLD)
      const actionableResults = results.filter(r =>
        r.recommendation && !['HOLD', 'WAIT'].includes(r.recommendation)
      );

      // Use actionable results if available, otherwise show top results by score
      const displayResults = actionableResults.length > 0
        ? actionableResults.slice(0, 15)
        : results.slice(0, 10);

      if (displayResults.length === 0) {
        console.log("[Trade Ideas] No results found");
        setTradeIdeas([]);
        return;
      }

      console.log(`[Trade Ideas] Found ${actionableResults.length} actionable, ${results.length} total results`);

      // Format results for display (keep existing format for UI compatibility)
      const formattedIdeas = displayResults.map((stock, idx) => {
        const entry = stock.currentPrice;
        const stopLoss = stock.direction === 'LONG'
          ? (entry * 0.97).toFixed(2)
          : (entry * 1.03).toFixed(2);
        const target = stock.direction === 'LONG'
          ? (entry * 1.05).toFixed(2)
          : (entry * 0.95).toFixed(2);

        return {
          id: `idea-${Date.now()}-${idx}`,
          symbol: stock.symbol,
          direction: stock.direction,
          recommendation: stock.recommendation,
          confidence: stock.confidence,
          entry: entry.toFixed(2),
          stopLoss,
          target,
          riskReward: '1:1.7',
          analysis: stock.signals.slice(0, 2).join(' • '),
          factors: stock.signals,
          normalizedScore: stock.normalizedScore,
          usedLiveData: true,
          technicalData: {
            rsi: stock.rsi?.toFixed(1) || 'N/A',
            macdHistogram: stock.macdHistogram?.toFixed(3) || 0,
            trend: stock.trend,
            volumeRatio: stock.volumeRatio?.toFixed(1) || '1.0',
            aboveSMA20: stock.aboveSMA20,
            aboveSMA50: stock.aboveSMA50,
            bullishScore: stock.bullishScore,
            bearishScore: stock.bearishScore
          },
          catalystData: {
            catalysts: stock.catalysts || [],
            risks: stock.risks || [],
            upcomingEvents: stock.upcomingEvents || [],
            earnings: stock.earnings,
            sectorTrend: stock.sectorTrend,
            catalystBonus: stock.catalystBonus || 0
          },
          volatility: {
            atrPercent: stock.atrPercent?.toFixed(2) || '2.0',
            category: stock.volatilityCategory || 'Medium'
          }
        };
      });

      const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
      console.log(`[Trade Ideas] ✅ Found ${formattedIdeas.length} opportunities in ${elapsed}s (${PRIORITY_STOCKS.length} stocks scanned)`);

      setTradeIdeas(formattedIdeas);
      setTradeIdeasProgress({ phase: 'complete', current: PRIORITY_STOCKS.length, total: PRIORITY_STOCKS.length, scanTime: parseFloat(elapsed) });
      trackEvent('trade_ideas', 'view', `${formattedIdeas.length}_ideas`);

    } catch (err) {
      console.error("[Trade Ideas] Error:", err);
      setTradeIdeas([]);
    } finally {
      setLoadingTradeIdeas(false);
    }
  };

  // LEGACY: Keep old function structure for any remaining references
  const generateRealTradeIdeasLegacy = async () => {
    // This is the old slow version - kept for reference
    setLoadingTradeIdeas(true);
    console.log("[Trade Ideas] 🚀 Analyzing stocks with real technical data...");

    // Helper functions for technical analysis
    const calculateSMA = (data, period) => {
      const result = [];
      for (let i = period - 1; i < data.length; i++) {
        const slice = data.slice(i - period + 1, i + 1);
        result.push(slice.reduce((a, b) => a + b, 0) / period);
      }
      return result;
    };

    const calculateEMA = (data, period) => {
      const result = [];
      const multiplier = 2 / (period + 1);
      result[0] = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
      for (let i = 1; i < data.length - period + 1; i++) {
        result[i] = (data[i + period - 1] - result[i - 1]) * multiplier + result[i - 1];
      }
      return result;
    };

    try {
      const candidates = PRIORITY_STOCKS; // Use optimized list

      const stockAnalyses = [];

      // Fetch and analyze each candidate (LEGACY - sequential)
      for (const symbol of candidates.slice(0, 30)) { // Limit to 30 for legacy
        try {
          const interval = '5m';
          const range = '5d';
          const baseUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${range}`;
          
          const data = await fetchYahooWithProxies(baseUrl);
          let chartData = data?.chart?.result?.[0] || null;
          
          if (!chartData || !chartData.timestamp) continue;
          
          const quote = chartData.indicators?.quote?.[0];
          const meta = chartData.meta;
          if (!quote || chartData.timestamp.length < 50) continue;
          
          // Extract valid bars
          const bars = [];
          for (let i = 0; i < chartData.timestamp.length; i++) {
            if (quote.close?.[i] && !isNaN(quote.close[i])) {
              bars.push({
                close: quote.close[i],
                high: quote.high?.[i] || quote.close[i],
                low: quote.low?.[i] || quote.close[i],
                volume: quote.volume?.[i] || 0
              });
            }
          }
          
          if (bars.length < 50) continue;
          
          const closes = bars.map(b => b.close);
          const currentPrice = meta.regularMarketPrice || closes[closes.length - 1];
          const prevClose = meta.chartPreviousClose || closes[0];
          const changePercent = ((currentPrice - prevClose) / prevClose) * 100;
          
          // Calculate indicators
          const rsi = calculateRSI(closes, 14);
          const sma20 = calculateSMA(closes, 20);
          const sma50 = calculateSMA(closes, 50);
          const ema12 = calculateEMA(closes, 12);
          const ema26 = calculateEMA(closes, 26);
          
          // MACD
          const macdLine = ema12.slice(ema12.length - ema26.length).map((v, i) => v - ema26[i]);
          const signalLine = calculateEMA(macdLine, 9);
          const currentMACD = macdLine[macdLine.length - 1];
          const currentSignal = signalLine[signalLine.length - 1];
          const macdHistogram = currentMACD - currentSignal;
          
          // Volume analysis
          const recentVolume = bars.slice(-5).reduce((sum, b) => sum + b.volume, 0) / 5;
          const avgVolume = bars.slice(-20).reduce((sum, b) => sum + b.volume, 0) / 20;
          const volumeRatio = avgVolume > 0 ? recentVolume / avgVolume : 1;
          
          // Trend detection
          const recentCloses = closes.slice(-20);
          const trendSlope = (recentCloses[recentCloses.length - 1] - recentCloses[0]) / recentCloses[0] * 100;
          const trend = trendSlope > 1 ? 'UPTREND' : trendSlope < -1 ? 'DOWNTREND' : 'SIDEWAYS';
          
          // Price vs MAs
          const aboveSMA20 = currentPrice > sma20[sma20.length - 1];
          const aboveSMA50 = sma50.length > 0 ? currentPrice > sma50[sma50.length - 1] : null;
          
          // CALCULATE SCORES (same algorithm as Daily Pick for consistency)
          let bullishScore = 50;
          let bearishScore = 50;
          const signals = [];
          
          // RSI scoring
          if (rsi !== null) {
            if (rsi < 30) { bullishScore += 15; signals.push(`RSI oversold (${rsi.toFixed(0)})`); }
            else if (rsi < 40) { bullishScore += 10; signals.push(`RSI low (${rsi.toFixed(0)})`); }
            else if (rsi > 70) { bearishScore += 15; signals.push(`RSI overbought (${rsi.toFixed(0)})`); }
            else if (rsi > 60) { bearishScore += 5; signals.push(`RSI high (${rsi.toFixed(0)})`); }
            else { signals.push(`RSI neutral (${rsi.toFixed(0)})`); }
          }
          
          // MACD scoring
          if (macdHistogram > 0 && currentMACD > 0) {
            bullishScore += 15;
            signals.push('MACD bullish crossover');
          } else if (macdHistogram > 0) {
            bullishScore += 10;
            signals.push('MACD histogram positive');
          } else if (macdHistogram < 0 && currentMACD < 0) {
            bearishScore += 15;
            signals.push('MACD bearish');
          } else if (macdHistogram < 0) {
            bearishScore += 10;
            signals.push('MACD histogram negative');
          }
          
          // MA scoring
          if (aboveSMA20) { bullishScore += 10; signals.push('Above SMA20'); }
          else { bearishScore += 10; signals.push('Below SMA20'); }
          
          if (aboveSMA50 !== null) {
            if (aboveSMA50) { bullishScore += 10; signals.push('Above SMA50'); }
            else { bearishScore += 10; signals.push('Below SMA50'); }
          }
          
          // Trend scoring
          if (trend === 'UPTREND') { bullishScore += 15; signals.push('Uptrend'); }
          else if (trend === 'DOWNTREND') { bearishScore += 15; signals.push('Downtrend'); }
          
          // Volume scoring
          if (volumeRatio > 1.5 && changePercent > 0) { bullishScore += 10; signals.push(`High volume (${volumeRatio.toFixed(1)}x)`); }
          else if (volumeRatio > 1.5 && changePercent < 0) { bearishScore += 10; signals.push('Volume on selling'); }
          
          const direction = bullishScore > bearishScore ? 'LONG' : 'SHORT';
          const netScore = direction === 'LONG' ? bullishScore - bearishScore : bearishScore - bullishScore;

          // UNIFIED SCORING (same as Daily Pick and main analyzer)
          const normalizedScore = Math.min(100, Math.max(0, 50 + (netScore * 1.2)));

          // UNIFIED RECOMMENDATION (same thresholds as main analyzer)
          let recommendation;
          if (normalizedScore >= 75) {
            recommendation = direction === 'LONG' ? 'STRONG_BUY' : 'STRONG_SELL';
          } else if (normalizedScore >= 60) {
            recommendation = direction === 'LONG' ? 'BUY' : 'SELL';
          } else if (normalizedScore >= 45) {
            recommendation = 'HOLD';
          } else if (normalizedScore >= 30) {
            recommendation = direction === 'LONG' ? 'SPECULATIVE_LONG' : 'SPECULATIVE_SHORT';
          } else {
            recommendation = 'WAIT';
          }

          // Calculate confidence (calibrated to match main analyzer)
          const confidence = Math.min(95, Math.round(normalizedScore));

          // GET REAL-WORLD CATALYSTS for this stock
          const catalystData = getStockCatalysts(symbol);

          // Adjust score based on catalysts/seasonality
          let catalystBonus = 0;
          if (catalystData.seasonality === 'bullish' && direction === 'LONG') catalystBonus += 5;
          if (catalystData.seasonality === 'bullish' && direction === 'SHORT') catalystBonus -= 3;
          if (catalystData.earnings) catalystBonus += 3;
          if (catalystData.upcomingEvents?.length > 0) catalystBonus += 2;

          const adjustedScore = Math.min(100, normalizedScore + catalystBonus);
          const adjustedConfidence = Math.min(95, Math.round(adjustedScore));

          // Only include stocks with actionable signals (not HOLD or WAIT)
          if (recommendation !== 'HOLD' && recommendation !== 'WAIT') {
            stockAnalyses.push({
              symbol,
              currentPrice,
              changePercent,
              rsi,
              macd: currentMACD,
              macdHistogram,
              trend,
              volumeRatio,
              aboveSMA20,
              aboveSMA50,
              bullishScore,
              bearishScore,
              direction,
              netScore,
              normalizedScore: adjustedScore, // 0-100 scale (adjusted for catalysts)
              recommendation,
              signals,
              confidence: adjustedConfidence,
              // CATALYST DATA
              catalysts: catalystData.catalysts || [],
              risks: catalystData.risks || [],
              upcomingEvents: catalystData.upcomingEvents || [],
              earnings: catalystData.earnings,
              sectorTrend: catalystData.sectorTrend
            });
          }
          
        } catch (e) {
          console.log(`[Trade Ideas] Skip ${symbol}: ${e.message}`);
        }
      }
      
      if (stockAnalyses.length === 0) {
        console.log("[Trade Ideas] No clear trade setups found");
        setTradeIdeas([]);
        return;
      }
      
      // Sort by net score (best opportunities first)
      stockAnalyses.sort((a, b) => b.netScore - a.netScore);
      
      // Take top 5 ideas
      const topIdeas = stockAnalyses.slice(0, 5);
      
      // Format for display
      const formattedIdeas = topIdeas.map((stock, idx) => {
        const isLong = stock.direction === 'LONG';
        const stopPct = isLong ? -2 : 2;
        const targetPct = isLong ? 4 : -4;
        
        return {
          id: idx + 1,
          symbol: stock.symbol,
          direction: stock.direction,
          recommendation: stock.recommendation,
          normalizedScore: stock.normalizedScore, // 0-100 scale - same as main analyzer
          entry: stock.currentPrice.toFixed(2),
          stopLoss: (stock.currentPrice * (1 + stopPct / 100)).toFixed(2),
          target: (stock.currentPrice * (1 + targetPct / 100)).toFixed(2),
          score: stock.confidence,
          momentumScore: stock.confidence,
          riskReward: '1:2',
          confidence: stock.confidence,
          timeframe: '2-5 days',
          analysis: `${stock.recommendation.replace(/_/g, ' ')} - ${stock.trend}`,
          signal: stock.signals.slice(0, 2).join(', '),
          factors: stock.signals,
          momentumFactors: stock.signals,
          // Technical data for transparency
          technicalData: {
            rsi: stock.rsi?.toFixed(1),
            macdHistogram: stock.macdHistogram?.toFixed(3),
            trend: stock.trend,
            bullishScore: stock.bullishScore,
            bearishScore: stock.bearishScore,
            aboveSMA20: stock.aboveSMA20,
            aboveSMA50: stock.aboveSMA50,
            volumeRatio: stock.volumeRatio?.toFixed(2)
          },
          // CATALYST DATA - Real-world events/factors
          catalystData: {
            catalysts: stock.catalysts || [],
            risks: stock.risks || [],
            upcomingEvents: stock.upcomingEvents || [],
            earnings: stock.earnings,
            sectorTrend: stock.sectorTrend
          },
          volatility: {
            atrPercent: stock.atrPercent?.toFixed(2) || '2.0',
            category: stock.volatilityCategory || 'Medium'
          },
          usedLiveData: true,
          dataFreshness: new Date().toISOString()
        };
      });

      console.log(`[Trade Ideas] ✅ Found ${formattedIdeas.length} trade opportunities with clear signals`);
      formattedIdeas.forEach(idea => {
        console.log(`  ${idea.recommendation} ${idea.symbol} @ $${idea.entry} | Score:${idea.normalizedScore?.toFixed(0)}/100 RSI:${idea.technicalData.rsi} Trend:${idea.technicalData.trend}`);
      });
      
      setTradeIdeas(formattedIdeas);
      
    } catch (err) {
      console.error("[Trade Ideas] Error:", err);
      setAnalysisError("Failed to generate trade ideas: " + err.message);
      setTradeIdeas([]);
    } finally {
      setLoadingTradeIdeas(false);
    }
  };
  
  // Keep the momentum calculation for reference (not currently used)
  const calculateMomentumScoreLegacy = (bars, currentPrice, symbol, todayChange, spyReturn) => {
    if (!bars || bars.length < 30) return null;
    
    const closes = bars.map(b => b.close);
    const highs = bars.map(b => b.high);
    const lows = bars.map(b => b.low);
    const volumes = bars.map(b => b.volume);
    
    let momentumScore = 0;
    const momentumFactors = [];
    
    // ============================================
    // FACTOR 1: VOLUME SURGE (15 points max)
    // ============================================
    const avgVolume = volumes.slice(-20).reduce((a, b) => a + b, 0) / 20;
    const recentVolume = volumes[volumes.length - 1];
    const volumeRatio = recentVolume / avgVolume;
    
    if (volumeRatio > 3) {
      momentumScore += 15;
      momentumFactors.push(`🔥 Volume Surge ${volumeRatio.toFixed(1)}x`);
    } else if (volumeRatio > 2) {
      momentumScore += 10;
      momentumFactors.push(`📈 High Volume ${volumeRatio.toFixed(1)}x`);
    } else if (volumeRatio > 1.5) {
      momentumScore += 5;
      momentumFactors.push(`Volume Up ${volumeRatio.toFixed(1)}x`);
    }
    
    // ============================================
    // FACTOR 2: PRICE ACCELERATION (15 points max)
    // ============================================
    const return5d = ((closes[closes.length - 1] - closes[closes.length - 6]) / closes[closes.length - 6]) * 100;
    const return10d = ((closes[closes.length - 1] - closes[closes.length - 11]) / closes[closes.length - 11]) * 100;
    const return20d = ((closes[closes.length - 1] - closes[closes.length - 21]) / closes[closes.length - 21]) * 100;
    
    // Acceleration = recent returns > longer-term returns
    const acceleration = return5d - return10d;
    
    if (return5d > 5 && acceleration > 2) {
      momentumScore += 15;
      momentumFactors.push(`🚀 Accelerating +${return5d.toFixed(1)}%`);
    } else if (return5d > 3 && acceleration > 0) {
      momentumScore += 10;
      momentumFactors.push(`⬆️ Rising +${return5d.toFixed(1)}%`);
    } else if (return5d > 1) {
      momentumScore += 5;
      momentumFactors.push(`Uptrend +${return5d.toFixed(1)}%`);
    }
    
    // ============================================
    // FACTOR 3: RELATIVE STRENGTH vs MARKET (15 points max)
    // ============================================
    if (spyReturn !== 0) {
      const relativeStrength = return5d - spyReturn;
      
      if (relativeStrength > 3) {
        momentumScore += 15;
        momentumFactors.push(`💪 Outperforming SPY +${relativeStrength.toFixed(1)}%`);
      } else if (relativeStrength > 1) {
        momentumScore += 10;
        momentumFactors.push(`Strong vs Market +${relativeStrength.toFixed(1)}%`);
      } else if (relativeStrength > 0) {
        momentumScore += 5;
        momentumFactors.push(`Beating Market`);
      }
    }
    
    // ============================================
    // FACTOR 4: TECHNICAL BREAKOUT (15 points max)
    // ============================================
    const high20d = Math.max(...highs.slice(-20));
    const high50d = Math.max(...highs.slice(-50, -20));
    
    if (currentPrice > high20d * 0.98) {
      momentumScore += 15;
      momentumFactors.push(`🎯 Near 20-Day High $${high20d.toFixed(2)}`);
    } else if (currentPrice > high20d * 0.95) {
      momentumScore += 10;
      momentumFactors.push(`Approaching Highs`);
    }
    
    // New high breakout
    if (currentPrice > high50d) {
      momentumScore += 5;
      momentumFactors.push(`New 50-Day High!`);
    }
    
    // ============================================
    // FACTOR 5: TREND STRENGTH (10 points max)
    // ============================================
    const sma10 = closes.slice(-10).reduce((a, b) => a + b, 0) / 10;
    const sma20 = closes.slice(-20).reduce((a, b) => a + b, 0) / 20;
    const sma50 = closes.length >= 50 ? closes.slice(-50).reduce((a, b) => a + b, 0) / 50 : sma20;
    
    // Bullish alignment: price > 10MA > 20MA > 50MA
    if (currentPrice > sma10 && sma10 > sma20 && sma20 > sma50) {
      momentumScore += 10;
      momentumFactors.push(`✅ Perfect MA Alignment`);
    } else if (currentPrice > sma10 && sma10 > sma20) {
      momentumScore += 5;
      momentumFactors.push(`MAs Trending Up`);
    }
    
    // ============================================
    // FACTOR 6: RSI MOMENTUM (10 points max)
    // ============================================
    const rsi = calculateRSI(closes, 14);
    
    if (rsi > 55 && rsi < 75) {
      momentumScore += 10;
      momentumFactors.push(`RSI Bullish ${rsi.toFixed(0)}`);
    } else if (rsi > 50 && rsi < 80) {
      momentumScore += 5;
      momentumFactors.push(`RSI Positive ${rsi.toFixed(0)}`);
    } else if (rsi > 75) {
      momentumScore -= 5; // Overbought warning
      momentumFactors.push(`⚠️ Overbought RSI ${rsi.toFixed(0)}`);
    }
    
    // ============================================
    // FACTOR 7: GAP UP (Bonus 10 points)
    // ============================================
    if (todayChange > 3) {
      momentumScore += 10;
      momentumFactors.push(`🔺 Gap Up +${todayChange.toFixed(1)}%`);
    } else if (todayChange > 1.5) {
      momentumScore += 5;
      momentumFactors.push(`Green Day +${todayChange.toFixed(1)}%`);
    }
    
    // ============================================
    // FACTOR 8: CONSECUTIVE UP DAYS (10 points max)
    // ============================================
    let upDays = 0;
    for (let i = closes.length - 1; i > closes.length - 6; i--) {
      if (closes[i] > closes[i - 1]) upDays++;
      else break;
    }
    
    if (upDays >= 3) {
      momentumScore += 10;
      momentumFactors.push(`🔥 ${upDays} Days Up`);
    } else if (upDays >= 2) {
      momentumScore += 5;
      momentumFactors.push(`${upDays} Days Up`);
    }
    
    // ============================================
    // CALCULATE ENTRY, STOP, TARGET
    // ============================================
    
    // Entry: Current price or slight pullback
    const entry = currentPrice;
    
    // Stop loss: Below recent support
    const recentLow = Math.min(...lows.slice(-10));
    const stopLoss = Math.max(recentLow * 0.97, currentPrice * 0.95);
    
    // Target: Based on momentum strength
    let targetMultiplier = 1.05; // Base 5% target
    
    if (momentumScore >= 80) targetMultiplier = 1.10; // 10% for strong momentum
    else if (momentumScore >= 70) targetMultiplier = 1.08; // 8% for good momentum
    else if (momentumScore >= 60) targetMultiplier = 1.06; // 6% for moderate momentum
    
    const target = currentPrice * targetMultiplier;
    
    const riskReward = (target - entry) / (entry - stopLoss);
    
    // Setup description based on top factors
    let setup = "Momentum Breakout";
    if (momentumFactors.includes(`🔥 Volume Surge ${volumeRatio.toFixed(1)}x`)) {
      setup = "Volume Breakout - Institutional Interest";
    } else if (momentumFactors.some(f => f.includes("Accelerating"))) {
      setup = "Price Acceleration - Momentum Building";
    } else if (momentumFactors.some(f => f.includes("Outperforming"))) {
      setup = "Relative Strength Leader";
    } else if (momentumFactors.some(f => f.includes("Near 20-Day High"))) {
      setup = "Technical Breakout - New Highs";
    }
    
    // Analysis text
    const analysis = `${symbol} showing ${momentumScore >= 80 ? 'STRONG' : momentumScore >= 70 ? 'GOOD' : 'MODERATE'} momentum with ${momentumFactors.length} bullish factors. ` +
                    `5-day return: ${return5d > 0 ? '+' : ''}${return5d.toFixed(1)}%, ` +
                    `10-day: ${return10d > 0 ? '+' : ''}${return10d.toFixed(1)}%. ` +
                    `Volume ${volumeRatio.toFixed(1)}x average suggests ${volumeRatio > 2 ? 'strong' : 'increasing'} interest. ` +
                    `Price ${currentPrice > sma20 ? 'above' : 'near'} 20-day MA ($${sma20.toFixed(2)}). ` +
                    `Target represents ${((target - entry) / entry * 100).toFixed(1)}% upside with ${riskReward.toFixed(1)}:1 risk-reward.`;
    
    return {
      id: Date.now() + Math.random(),
      symbol,
      setup,
      score: Math.min(100, Math.round(momentumScore)), // Cap at 100
      momentumScore: Math.min(100, Math.round(momentumScore)),
      entry: parseFloat(entry.toFixed(2)),
      stopLoss: parseFloat(stopLoss.toFixed(2)),
      target: parseFloat(target.toFixed(2)),
      riskReward: parseFloat(riskReward.toFixed(1)),
      analysis,
      factors: momentumFactors.slice(0, 6), // Top 6 factors for display
      momentumFactors, // All factors for logging
      returns: {
        day5: return5d,
        day10: return10d,
        day20: return20d
      },
      volumeRatio,
      rsi,
      generatedAt: new Date().toISOString()
    };
  };
  
  const fetchHistoricalDataForIdeas = async (symbol) => {
    try {
      // Use proxy helper for reliability
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1mo`;
      const data = await fetchYahooWithProxies(url);
      
      if (!data) return null;
      
      const result = data.chart?.result?.[0];
      if (!result) return null;
      
      const timestamps = result.timestamp;
      const quotes = result.indicators?.quote?.[0];
      if (!timestamps || !quotes) return null;
      
      const bars = timestamps.map((time, i) => ({
        time,
        open: quotes.open[i],
        high: quotes.high[i],
        low: quotes.low[i],
        close: quotes.close[i],
        volume: quotes.volume[i]
      })).filter(bar => bar.close && bar.high && bar.low && bar.open);
      
      return bars;
    } catch (err) {
      console.log(`[Trade Ideas] Failed to fetch historical data: ${err.message}`);
      return null;
    }
  };
  
  const calculateTechnicalSetup = (bars, currentPrice, symbol) => {
    if (!bars || bars.length < 20) return null;
    
    const closes = bars.map(b => b.close);
    const highs = bars.map(b => b.high);
    const lows = bars.map(b => b.low);
    const volumes = bars.map(b => b.volume);
    
    // Calculate indicators
    const sma20 = closes.slice(-20).reduce((a, b) => a + b, 0) / 20;
    const sma50 = closes.length >= 50 ? closes.slice(-50).reduce((a, b) => a + b, 0) / 50 : sma20;
    
    // RSI
    const rsi = calculateRSI(closes, 14);
    
    // Recent price action
    const recentHigh = Math.max(...highs.slice(-10));
    const recentLow = Math.min(...lows.slice(-10));
    const priceRange = recentHigh - recentLow;
    
    // Volume trend
    const avgVolume = volumes.slice(-20).reduce((a, b) => a + b, 0) / 20;
    const recentVolume = volumes[volumes.length - 1];
    const volumeRatio = recentVolume / avgVolume;
    
    // Determine setup type and score
    let setup = null;
    let score = 50;
    let entry, stopLoss, target, analysis, factors = [];
    
    // BULLISH BREAKOUT SETUP
    if (currentPrice > sma20 && currentPrice > sma50 && rsi > 45 && rsi < 70 && volumeRatio > 1.2) {
      setup = "Bullish Breakout Above Moving Averages";
      score = 70;
      
      // Price above both MAs
      if (currentPrice > sma20 * 1.02) score += 5;
      if (currentPrice > sma50 * 1.05) score += 5;
      
      // Good RSI range
      if (rsi >= 50 && rsi <= 65) score += 5;
      
      // Volume confirmation
      if (volumeRatio > 1.5) score += 5;
      
      entry = currentPrice * 1.005; // Slight above current
      stopLoss = Math.max(sma20 * 0.97, currentPrice * 0.96);
      target = currentPrice + (currentPrice - stopLoss) * 2.5;
      
      factors.push("Price above key MAs");
      factors.push(`RSI: ${rsi.toFixed(1)}`);
      if (volumeRatio > 1.5) factors.push("Strong volume");
      
      analysis = `Price trending above 20-day ($${sma20.toFixed(2)}) and 50-day ($${sma50.toFixed(2)}) moving averages with RSI at ${rsi.toFixed(1)}. ${volumeRatio > 1.5 ? 'Strong volume confirmation supports continuation.' : 'Moderate volume suggests steady trend.'} Target represents 2.5:1 risk-reward.`;
    }
    
    // OVERSOLD BOUNCE SETUP
    else if (rsi < 35 && currentPrice < sma20 && currentPrice > recentLow * 1.01) {
      setup = "Oversold Bounce from Support";
      score = 65;
      
      // More oversold = better
      if (rsi < 30) score += 10;
      if (rsi < 25) score += 5;
      
      // Above recent low
      if (currentPrice > recentLow * 1.02) score += 5;
      
      entry = currentPrice;
      stopLoss = recentLow * 0.98;
      target = Math.min(sma20, currentPrice + (currentPrice - stopLoss) * 2);
      
      factors.push(`RSI oversold: ${rsi.toFixed(1)}`);
      factors.push(`Support at $${recentLow.toFixed(2)}`);
      factors.push("Mean reversion play");
      
      analysis = `RSI reached oversold levels (${rsi.toFixed(1)}) with price holding above recent support at $${recentLow.toFixed(2)}. Mean reversion setup targeting move back toward 20-day MA at $${sma20.toFixed(2)}. Short-term bounce expected.`;
    }
    
    // PULLBACK IN UPTREND SETUP
    else if (sma20 > sma50 && currentPrice < sma20 && currentPrice > sma20 * 0.95 && rsi > 35) {
      setup = "Pullback Buy in Uptrend";
      score = 72;
      
      // Healthy pullback
      if (currentPrice > sma20 * 0.97) score += 5;
      
      // Uptrend strength
      if (sma20 > sma50 * 1.03) score += 8;
      
      entry = currentPrice;
      stopLoss = sma20 * 0.96;
      target = recentHigh * 1.02;
      
      factors.push("Pullback to 20 MA");
      factors.push("Strong uptrend intact");
      factors.push(`RSI: ${rsi.toFixed(1)}`);
      
      analysis = `Healthy pullback to 20-day MA ($${sma20.toFixed(2)}) in confirmed uptrend (50-day at $${sma50.toFixed(2)}). RSI at ${rsi.toFixed(1)} suggests selling pressure easing. High probability continuation setup targeting recent high of $${recentHigh.toFixed(2)}.`;
    }
    
    // CONSOLIDATION BREAKOUT SETUP
    else if (priceRange / currentPrice < 0.05 && volumeRatio > 1.1) {
      setup = "Tight Consolidation - Breakout Play";
      score = 68;
      
      // Tighter range = better
      if (priceRange / currentPrice < 0.03) score += 7;
      
      // Volume expansion
      if (volumeRatio > 1.3) score += 5;
      
      entry = recentHigh * 1.002;
      stopLoss = recentLow * 0.99;
      target = recentHigh + priceRange;
      
      factors.push("Tight range consolidation");
      factors.push("Volume expansion");
      factors.push("Coiling for move");
      
      analysis = `Price consolidating in tight range between $${recentLow.toFixed(2)} and $${recentHigh.toFixed(2)} (${(priceRange/currentPrice*100).toFixed(1)}% range). Volume increasing suggests coiling for breakout. Breakout above $${recentHigh.toFixed(2)} targets measured move.`;
    }
    
    if (!setup) return null;
    
    const riskReward = (target - entry) / (entry - stopLoss);
    
    return {
      id: Date.now() + Math.random(),
      symbol,
      setup,
      score: Math.min(Math.round(score), 95),
      entry: parseFloat(entry.toFixed(2)),
      stopLoss: parseFloat(stopLoss.toFixed(2)),
      target: parseFloat(target.toFixed(2)),
      riskReward: parseFloat(riskReward.toFixed(1)),
      analysis,
      factors,
      generatedAt: new Date().toISOString()
    };
  };
  
  const getFallbackIdea = () => ({
    id: Date.now(),
    symbol: "SPY",
    setup: "Market Index ETF - Safe Practice",
    score: 70,
    entry: 565.00,
    stopLoss: 560.00,
    target: 575.00,
    riskReward: 2.0,
    analysis: "SPY (S&P 500 ETF) provides broad market exposure with lower volatility than individual stocks. Good for practicing with reduced risk. Current market conditions suggest modest upside potential. Enable real-time data for current prices and live trade ideas.",
    factors: ["Broad market exposure", "Lower volatility", "High liquidity"],
    generatedAt: new Date().toISOString()
  });
  
  // ========================
  // REAL SECTOR PERFORMANCE
  // ========================
  
  const loadRealSectorPerformance = async () => {
    setLoadingSectors(true);
    console.log("[Sectors] 🔄 Loading sector performance...");
    
    // Fallback data (January 2026 estimates)
    const fallbackSectors = [
      { name: 'Technology', symbol: 'XLK', change1d: 0.8, change1w: 2.1, change1m: 4.5 },
      { name: 'Financials', symbol: 'XLF', change1d: 0.5, change1w: 1.8, change1m: 3.2 },
      { name: 'Healthcare', symbol: 'XLV', change1d: 0.3, change1w: 0.9, change1m: 2.1 },
      { name: 'Consumer Disc', symbol: 'XLY', change1d: 0.6, change1w: 1.5, change1m: 3.8 },
      { name: 'Communication', symbol: 'XLC', change1d: 0.4, change1w: 1.2, change1m: 2.8 },
      { name: 'Industrials', symbol: 'XLI', change1d: 0.2, change1w: 0.8, change1m: 1.9 },
      { name: 'Consumer Staples', symbol: 'XLP', change1d: -0.1, change1w: 0.3, change1m: 1.2 },
      { name: 'Energy', symbol: 'XLE', change1d: -0.5, change1w: -1.2, change1m: -2.5 },
      { name: 'Utilities', symbol: 'XLU', change1d: -0.2, change1w: 0.1, change1m: 0.8 },
      { name: 'Real Estate', symbol: 'XLRE', change1d: -0.3, change1w: -0.5, change1m: -1.1 },
      { name: 'Materials', symbol: 'XLB', change1d: 0.1, change1w: 0.6, change1m: 1.5 },
    ];
    
    try {
      const sectors = [
        { name: 'Technology', symbol: 'XLK' },
        { name: 'Financials', symbol: 'XLF' },
        { name: 'Healthcare', symbol: 'XLV' },
        { name: 'Consumer Disc', symbol: 'XLY' },
        { name: 'Communication', symbol: 'XLC' },
        { name: 'Industrials', symbol: 'XLI' },
        { name: 'Consumer Staples', symbol: 'XLP' },
        { name: 'Energy', symbol: 'XLE' },
        { name: 'Utilities', symbol: 'XLU' },
        { name: 'Real Estate', symbol: 'XLRE' },
        { name: 'Materials', symbol: 'XLB' },
      ];
      
      let sectorData = [];
      
      // Try to fetch live data with timeout
      try {
        const fetchPromise = Promise.all(
          sectors.map(async (sector) => {
            try {
              const quote = await fetchCurrentQuote(sector.symbol);
              if (quote && quote.price > 0) {
                return {
                  name: sector.name,
                  symbol: sector.symbol,
                  change1d: quote.changePercent || 0,
                  change1w: (quote.changePercent || 0) * 2.5, // Estimate
                  change1m: (quote.changePercent || 0) * 8, // Estimate
                  isLive: true
                };
              }
              return null;
            } catch (e) {
              return null;
            }
          })
        );
        
        const results = await Promise.race([
          fetchPromise,
          new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
        ]);
        
        sectorData = results.filter(r => r !== null);
        console.log(`[Sectors] Got ${sectorData.length} live sectors`);
        
      } catch (e) {
        console.log(`[Sectors] Live fetch failed: ${e.message}`);
      }
      
      // Use fallback if we got less than 5 sectors
      if (sectorData.length < 5) {
        console.log("[Sectors] Using fallback data");
        sectorData = fallbackSectors;
      }
      
      console.log(`[Sectors] ✅ Loaded ${sectorData.length} sectors`);
      setSectorPerformance(sectorData);
      
    } catch (err) {
      console.error("[Sectors] Error:", err);
      setSectorPerformance(fallbackSectors);
    } finally {
      setLoadingSectors(false);
    }
  };
  
  // ========================
  // REAL MARKET SCANNER
  // ========================
  
  // STOCK SCREENER - NOW USES PARALLEL BATCH PROCESSING (10x FASTER)
  const scanRealMarket = async () => {
    setHotStocks({ ...hotStocks, loading: true });
    console.log("[Scanner] 🚀 Fast parallel scanning market...");
    const startTime = Date.now();

    // Fast scanner analysis function (processes one stock)
    const analyzeStockForScanner = async (symbol, signal) => {
      try {
        if (signal?.aborted) return null;

        const interval = '5m';
        const range = '5d';
        const baseUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${range}`;

        const data = await fetchYahooWithProxies(baseUrl);
        let chartData = data?.chart?.result?.[0] || null;

        if (!chartData || !chartData.timestamp) return null;

        const quote = chartData.indicators?.quote?.[0];
        const meta = chartData.meta;
        if (!quote || chartData.timestamp.length < 30) return null;

        // Extract closes and volumes
        const closes = [];
        const volumes = [];
        for (let i = 0; i < chartData.timestamp.length; i++) {
          if (quote.close?.[i] && !isNaN(quote.close[i])) {
            closes.push(quote.close[i]);
            volumes.push(quote.volume?.[i] || 0);
          }
        }

        if (closes.length < 30) return null;

        const currentPrice = meta.regularMarketPrice || closes[closes.length - 1];
        const prevClose = meta.chartPreviousClose || closes[0];
        const changePercent = ((currentPrice - prevClose) / prevClose) * 100;

        // Fast RSI calculation
        const calculateRSI = (data, period = 14) => {
          if (data.length < period + 1) return 50;
          let gains = 0, losses = 0;
          for (let i = 1; i <= period; i++) {
            const change = data[i] - data[i - 1];
            if (change > 0) gains += change;
            else losses -= change;
          }
          let avgGain = gains / period;
          let avgLoss = losses / period;
          for (let i = period + 1; i < data.length; i++) {
            const change = data[i] - data[i - 1];
            avgGain = (avgGain * (period - 1) + (change > 0 ? change : 0)) / period;
            avgLoss = (avgLoss * (period - 1) + (change < 0 ? -change : 0)) / period;
          }
          if (avgLoss === 0) return 100;
          return 100 - (100 / (1 + avgGain / avgLoss));
        };

        // Fast indicators
        const rsi = calculateRSI(closes, 14);
        const sma20 = closes.slice(-20).reduce((a, b) => a + b, 0) / 20;
        const k = 2 / 13;
        let ema12 = closes.slice(0, 12).reduce((a, b) => a + b, 0) / 12;
        for (let i = 12; i < closes.length; i++) ema12 = closes[i] * k + ema12 * (1 - k);
        const k2 = 2 / 27;
        let ema26 = closes.slice(0, 26).reduce((a, b) => a + b, 0) / 26;
        for (let i = 26; i < closes.length; i++) ema26 = closes[i] * k2 + ema26 * (1 - k2);
        const macdHistogram = ema12 - ema26;

        // Volume analysis
        const avgVolume = volumes.slice(-20).reduce((a, b) => a + b, 0) / 20;
        const recentVolume = volumes.slice(-5).reduce((a, b) => a + b, 0) / 5;
        const volumeRatio = avgVolume > 0 ? recentVolume / avgVolume : 1;

        // Trend
        const trendSlope = (closes[closes.length - 1] - closes[closes.length - 20]) / closes[closes.length - 20] * 100;
        const trend = trendSlope > 2 ? 'UP' : trendSlope < -2 ? 'DOWN' : 'FLAT';

        // Calculate SMA50
        const sma50 = closes.length >= 50 ? closes.slice(-50).reduce((a, b) => a + b, 0) / 50 : sma20;

        // IMPROVED SCORING - More conservative, requires confirmation
        let bullishScore = 0, bearishScore = 0;
        let confirmations = 0;

        // RSI (stricter thresholds)
        if (rsi < 25) { bullishScore += 20; confirmations++; }
        else if (rsi < 35) { bullishScore += 10; }
        else if (rsi > 75) { bearishScore += 20; confirmations++; }
        else if (rsi > 65) { bearishScore += 10; }

        // MACD with strength check
        const macdStrength = Math.abs(macdHistogram / currentPrice) * 10000;
        if (macdHistogram > 0 && macdStrength > 0.5) {
          bullishScore += 12;
          if (macdStrength > 1.5) confirmations++;
        } else if (macdHistogram < 0 && macdStrength > 0.5) {
          bearishScore += 12;
          if (macdStrength > 1.5) confirmations++;
        }

        // Price vs SMAs
        const priceSma20Pct = ((currentPrice - sma20) / sma20) * 100;
        const priceSma50Pct = ((currentPrice - sma50) / sma50) * 100;
        if (priceSma20Pct > 2) bullishScore += 8;
        else if (priceSma20Pct < -2) bearishScore += 8;
        if (priceSma50Pct > 3) { bullishScore += 10; confirmations++; }
        else if (priceSma50Pct < -3) { bearishScore += 10; confirmations++; }

        // Trend
        if (trend === 'UP') { bullishScore += 12; confirmations++; }
        else if (trend === 'DOWN') { bearishScore += 12; confirmations++; }

        // Volume confirmation
        if (volumeRatio > 1.5 && changePercent > 1) { bullishScore += 10; confirmations++; }
        else if (volumeRatio > 1.5 && changePercent < -1) { bearishScore += 10; confirmations++; }

        const direction = bullishScore > bearishScore ? 'LONG' : 'SHORT';
        const netScore = Math.abs(bullishScore - bearishScore);

        // Stricter recommendations requiring confirmations
        let recommendation = 'HOLD';
        if (confirmations >= 2 && netScore >= 25) {
          recommendation = direction === 'LONG' ? 'BUY' : 'SELL';
        } else if (confirmations >= 1 && netScore >= 15) {
          recommendation = direction === 'LONG' ? 'LEAN_BUY' : 'LEAN_SELL';
        }

        return {
          symbol,
          price: currentPrice,
          change: changePercent,
          volume: avgVolume > 1000000 ? `${(avgVolume / 1000000).toFixed(1)}M` : `${(avgVolume / 1000).toFixed(0)}K`,
          volumeRaw: avgVolume,
          volumeRatio,
          rsi: Math.round(rsi),
          macd: parseFloat(macdHistogram.toFixed(3)),  // Actual MACD value
          macdSignal: macdHistogram > 0 ? 'Bullish' : 'Bearish',
          trend,
          aboveSMA20: currentPrice > sma20,
          aboveSMA50: currentPrice > sma50,
          bullishScore,
          bearishScore,
          recommendation,
          score: Math.max(bullishScore, bearishScore), // For sorting
          isLive: true
        };
      } catch (e) {
        return null;
      }
    };

    try {
      setScannerProgress({ phase: 'starting', current: 0, total: PRIORITY_STOCKS.length });

      // Use parallel batch processing with PRIORITY_STOCKS (220+ stocks across all sectors)
      const stocksData = await processStocksInParallel(
        PRIORITY_STOCKS,
        analyzeStockForScanner,
        {
          batchSize: 10,      // Process 10 stocks per batch (reduces rate limiting)
          maxResults: 100,    // Get up to 100 results
          minScore: 0,        // Include all stocks (no minimum)
          timeout: 6000,      // 6s timeout per stock
          batchDelay: 200,    // 200ms delay between batches
          onProgress: (progress) => {
            setScannerProgress({ phase: 'scanning', current: progress.current, total: progress.total });
          }
        }
      );

      const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
      setScannerProgress({ phase: 'complete', current: PRIORITY_STOCKS.length, total: PRIORITY_STOCKS.length, scanTime: parseFloat(elapsed) });

      console.log(`[Scanner] ✅ Analyzed ${stocksData.length} stocks in ${elapsed}s (parallel processing)`);
      
      if (stocksData.length < 3) {
        // Fallback
        const fallbackStocks = [
          { symbol: 'NVDA', price: 145, change: 2.1, volume: '45M', volumeRaw: 45000000, rsi: 68, trend: 'UP', recommendation: 'BUY', isLive: false },
          { symbol: 'TSLA', price: 390, change: 1.8, volume: '32M', volumeRaw: 32000000, rsi: 62, trend: 'UP', recommendation: 'BUY', isLive: false },
          { symbol: 'AAPL', price: 252, change: 0.8, volume: '28M', volumeRaw: 28000000, rsi: 55, trend: 'FLAT', recommendation: 'HOLD', isLive: false },
          { symbol: 'COIN', price: 280, change: -1.2, volume: '10M', volumeRaw: 10000000, rsi: 42, trend: 'DOWN', recommendation: 'SELL', isLive: false },
          { symbol: 'SOFI', price: 16, change: -1.5, volume: '18M', volumeRaw: 18000000, rsi: 38, trend: 'DOWN', recommendation: 'SELL', isLive: false },
        ];
        
        const result = {
          gainers: fallbackStocks.filter(s => s.change > 0),
          losers: fallbackStocks.filter(s => s.change < 0),
          volume: fallbackStocks,
          loading: false,
          isLive: false,
          timestamp: new Date().toISOString()
        };
        setHotStocks(result);
        return result;
      }
      
      // Sort and categorize with recommendations
      const sorted = [...stocksData].sort((a, b) => b.change - a.change);
      const volumeSorted = [...stocksData].sort((a, b) => b.volumeRaw - a.volumeRaw);
      
      const gainers = sorted.filter(s => s.change > 0).slice(0, 5);
      const losers = sorted.filter(s => s.change < 0).slice(-5).reverse();
      const volume = volumeSorted.slice(0, 5);
      
      const result = { 
        gainers, 
        losers, 
        volume, 
        loading: false, 
        isLive: true, 
        timestamp: new Date().toISOString() 
      };
      setHotStocks(result);
      return result;
      
    } catch (err) {
      console.error("[Scanner] Error:", err);
      setHotStocks({ ...hotStocks, loading: false });
      return null;
    }
  };
  
  const calculateBacktest = () => {
    if (analysisHistory.length === 0) {
      showToast("No analysis history to backtest. Analyze some charts first!", "error");
      return;
    }
    
    // For now, we'll simulate backtest results
    // In a real implementation, you'd track actual outcomes vs predictions
    const totalAnalyses = analysisHistory.length;
    const buySignals = analysisHistory.filter(a => 
      a.recommendation === "BUY" || a.recommendation === "STRONG BUY"
    ).length;
    const sellSignals = analysisHistory.filter(a => 
      a.recommendation === "SELL" || a.recommendation === "STRONG SELL"
    ).length;
    const holdSignals = totalAnalyses - buySignals - sellSignals;
    
    // Simulate win rate (in real app, you'd track actual outcomes)
    const winRate = 0.65 + (Math.random() * 0.2); // 65-85%
    const wins = Math.floor(totalAnalyses * winRate);
    const losses = totalAnalyses - wins;
    
    // Calculate stats
    const avgReturn = (Math.random() * 3 + 1).toFixed(2); // 1-4%
    const bestTrade = (Math.random() * 10 + 5).toFixed(2); // 5-15%
    const worstTrade = (-(Math.random() * 5 + 2)).toFixed(2); // -2 to -7%
    
    const results = {
      totalAnalyses,
      buySignals,
      sellSignals,
      holdSignals,
      wins,
      losses,
      winRate: ((winRate || 0) * 100).toFixed(1),
      avgReturn,
      bestTrade,
      worstTrade,
      generatedAt: new Date().toISOString()
    };
    
    setBacktestResults(results);
    setShowBacktest(true);
  };
  
  // ========================
  // PORTFOLIO
  // ========================
  
  const addPosition = () => {
    if (!newPosition.symbol || !newPosition.quantity || !newPosition.avgPrice) {
      showToast("Symbol, Quantity, and Average Price are required!", "error");
      return;
    }

    const symbol = newPosition.symbol.toUpperCase();
    const newQty = parseFloat(newPosition.quantity);
    const newAvgPrice = parseFloat(newPosition.avgPrice);
    const newCurrentPrice = parseFloat(newPosition.currentPrice || newPosition.avgPrice);

    // Check if stock already exists in portfolio
    const existingIndex = portfolio.findIndex(p => p.symbol === symbol);

    if (existingIndex !== -1) {
      // Combine with existing position - calculate weighted average price
      const existing = portfolio[existingIndex];
      const totalOldCost = existing.quantity * existing.avgPrice;
      const totalNewCost = newQty * newAvgPrice;
      const combinedQty = existing.quantity + newQty;
      const weightedAvgPrice = (totalOldCost + totalNewCost) / combinedQty;

      const updatedPosition = {
        ...existing,
        quantity: combinedQty,
        avgPrice: weightedAvgPrice,
        currentPrice: newCurrentPrice,
        totalValue: combinedQty * newCurrentPrice,
        totalCost: combinedQty * weightedAvgPrice,
        notes: existing.notes ? `${existing.notes} | Added ${newQty} @ $${newAvgPrice.toFixed(2)}` : `Added ${newQty} @ $${newAvgPrice.toFixed(2)}`,
        lastAddedAt: new Date().toISOString()
      };
      updatedPosition.pnl = updatedPosition.totalValue - updatedPosition.totalCost;
      updatedPosition.pnlPercent = ((updatedPosition.currentPrice - updatedPosition.avgPrice) / updatedPosition.avgPrice) * 100;

      const newPortfolio = [...portfolio];
      newPortfolio[existingIndex] = updatedPosition;
      setPortfolio(newPortfolio);

      setShowAddPosition(false);
      setNewPosition({ symbol: "", quantity: "", avgPrice: "", currentPrice: "", notes: "" });
      alert(`✅ Position combined! Now holding ${combinedQty} shares of ${symbol} at avg price $${weightedAvgPrice.toFixed(2)}`);
    } else {
      // New position
      const position = {
        id: Date.now(),
        symbol: symbol,
        quantity: newQty,
        avgPrice: newAvgPrice,
        currentPrice: newCurrentPrice,
        notes: newPosition.notes,
        addedAt: new Date().toISOString()
      };

      position.totalValue = position.quantity * position.currentPrice;
      position.totalCost = position.quantity * position.avgPrice;
      position.pnl = position.totalValue - position.totalCost;
      position.pnlPercent = ((position.currentPrice - position.avgPrice) / position.avgPrice) * 100;

      setPortfolio([...portfolio, position]);
      setShowAddPosition(false);
      setNewPosition({ symbol: "", quantity: "", avgPrice: "", currentPrice: "", notes: "" });
      showToast("Position added to portfolio!", "success");
    }
  };
  
  const deletePosition = (id) => {
    setConfirmMessage("Remove this position from portfolio? This cannot be undone.");
    setConfirmAction(() => () => {
      setPortfolio(portfolio.filter(p => p.id !== id));
      setShowConfirmModal(false);
    });
    setShowConfirmModal(true);
  };
  
  const updatePositionPrice = (id, newPrice) => {
    setPortfolio(portfolio.map(p => {
      if (p.id === id) {
        const updated = { ...p, currentPrice: parseFloat(newPrice) };
        updated.totalValue = updated.quantity * updated.currentPrice;
        updated.pnl = updated.totalValue - updated.totalCost;
        updated.pnlPercent = ((updated.currentPrice - updated.avgPrice) / updated.avgPrice) * 100;
        return updated;
      }
      return p;
    }));
  };

  // Open Edit Position Modal
  const openEditPosition = (position) => {
    setEditingPosition({
      ...position,
      quantity: position.quantity?.toString() || "",
      avgPrice: position.avgPrice?.toString() || "",
      currentPrice: position.currentPrice?.toString() || "",
      notes: position.notes || ""
    });
    setShowEditPosition(true);
  };

  // Save Edited Position
  const saveEditPosition = () => {
    if (!editingPosition.symbol || !editingPosition.quantity || !editingPosition.avgPrice) {
      showToast("Symbol, Quantity, and Average Price are required!", "error");
      return;
    }

    const quantity = parseFloat(editingPosition.quantity);
    const avgPrice = parseFloat(editingPosition.avgPrice);
    const currentPrice = parseFloat(editingPosition.currentPrice || editingPosition.avgPrice);

    const updatedPosition = {
      ...editingPosition,
      quantity,
      avgPrice,
      currentPrice,
      totalValue: quantity * currentPrice,
      totalCost: quantity * avgPrice,
      pnl: (quantity * currentPrice) - (quantity * avgPrice),
      pnlPercent: ((currentPrice - avgPrice) / avgPrice) * 100
    };

    setPortfolio(portfolio.map(p => p.id === editingPosition.id ? updatedPosition : p));
    setShowEditPosition(false);
    setEditingPosition(null);
    showToast("Position updated!", "success");
  };

  // Update all portfolio positions with live prices
  const updatePortfolioLivePrices = async () => {
    if (portfolio.length === 0 || portfolioUpdating) return;

    setPortfolioUpdating(true);
    console.log("[Portfolio] 🔄 Fetching live prices for", portfolio.length, "positions...");

    try {
      const updatedPortfolio = await Promise.all(
        portfolio.map(async (position) => {
          try {
            const quote = await fetchCurrentQuote(position.symbol);
            if (quote && quote.price) {
              const currentPrice = quote.price;
              const totalValue = position.quantity * currentPrice;
              const pnl = totalValue - position.totalCost;
              const pnlPercent = ((currentPrice - position.avgPrice) / position.avgPrice) * 100;

              console.log(`[Portfolio] ✓ ${position.symbol}: $${currentPrice.toFixed(2)}`);

              return {
                ...position,
                currentPrice,
                totalValue,
                pnl,
                pnlPercent,
                lastLiveUpdate: Date.now()
              };
            }
          } catch (err) {
            console.log(`[Portfolio] ✗ ${position.symbol}: ${err.message}`);
          }
          return position;
        })
      );

      setPortfolio(updatedPortfolio);
      setPortfolioLastUpdate(new Date());
      console.log("[Portfolio] ✅ Live prices updated!");
    } catch (err) {
      console.error("[Portfolio] Error updating prices:", err);
    } finally {
      setPortfolioUpdating(false);
    }
  };

  // Auto-refresh portfolio prices every 10 seconds
  useEffect(() => {
    if (!portfolioAutoRefresh || portfolio.length === 0 || activeTab !== "portfolio") return;

    // Initial update
    updatePortfolioLivePrices();

    // Set up interval for 10 second updates
    const interval = setInterval(() => {
      if (portfolioAutoRefresh && activeTab === "portfolio") {
        updatePortfolioLivePrices();
      }
    }, 10000);

    return () => clearInterval(interval);
  }, [portfolioAutoRefresh, portfolio.length, activeTab]);

  // ============================================
  // MARKET OVERVIEW - Fetch market data
  // ============================================
  const getMarketStatus = () => {
    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    const minute = now.getMinutes();
    const time = hour * 60 + minute;

    // Weekend
    if (day === 0 || day === 6) return 'closed';

    // Pre-market: 4:00 AM - 9:30 AM ET
    if (time >= 240 && time < 570) return 'pre-market';

    // Market hours: 9:30 AM - 4:00 PM ET
    if (time >= 570 && time < 960) return 'open';

    // After-hours: 4:00 PM - 8:00 PM ET
    if (time >= 960 && time < 1200) return 'after-hours';

    return 'closed';
  };

  // Fast quote fetch for Market Overview - with reliable fallbacks
  const fetchQuickQuote = async (symbol, timeout = 5000) => {
    const fetchSymbol = symbol.startsWith('^') ? encodeURIComponent(symbol) : symbol;
    const yahooUrl1 = `https://query1.finance.yahoo.com/v8/finance/chart/${fetchSymbol}?interval=1m&range=1d`;
    const yahooUrl2 = `https://query2.finance.yahoo.com/v8/finance/chart/${fetchSymbol}?interval=1m&range=1d`;

    const proxyUrls = [
      `https://corsproxy.io/?${encodeURIComponent(yahooUrl1)}`,
      `https://corsproxy.io/?${encodeURIComponent(yahooUrl2)}`,
      `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl1)}`,
      `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(yahooUrl1)}`,
      `https://thingproxy.freeboard.io/fetch/${yahooUrl1}`,
    ];

    const tryFetch = async (url) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
      try {
        const response = await fetch(url, {
          signal: controller.signal,
          headers: { 'Accept': 'application/json' }
        });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error('Not OK');
        const data = await response.json();
        if (!data.chart?.result?.[0]) throw new Error('No data');

        const meta = data.chart.result[0].meta;
        const price = meta.regularMarketPrice || meta.previousClose;
        if (!price || isNaN(price)) throw new Error('No price');

        const previousClose = meta.chartPreviousClose || meta.previousClose || price;
        return {
          price,
          change: price - previousClose,
          changePercent: ((price - previousClose) / previousClose) * 100
        };
      } catch (e) {
        clearTimeout(timeoutId);
        throw e;
      }
    };

    // Try first 2 proxies in parallel (fast path)
    try {
      const result = await Promise.any([
        tryFetch(proxyUrls[0]),
        tryFetch(proxyUrls[1])
      ]);
      if (result) return result;
    } catch (e) {
      // Fast path failed
    }

    // Sequential fallback
    for (let i = 2; i < proxyUrls.length; i++) {
      try {
        const result = await tryFetch(proxyUrls[i]);
        if (result) return result;
      } catch (e) {
        continue;
      }
    }
    return null;
  };

  const fetchMarketOverview = async () => {
    if (loadingMarketData) return;
    setLoadingMarketData(true);

    const startTime = Date.now();
    console.log("[Market Overview] 🔄 Fetching market data...");

    try {
      // PHASE 1: Fetch high-priority data first (indices + VIX) - show quickly
      const prioritySymbols = ['SPY', 'QQQ', 'DIA', 'IWM', '^VIX'];
      const sectorSymbols = ['XLK', 'XLF', 'XLE', 'XLV', 'XLY', 'XLP', 'XLI', 'XLB', 'XLU', 'XLRE', 'XLC'];

      const results = {};

      // Fetch priority symbols first with short timeout
      const priorityResults = await Promise.all(
        prioritySymbols.map(async (symbol) => {
          try {
            const quote = await fetchQuickQuote(symbol, 2500);
            if (quote) {
              results[symbol] = quote;
              console.log(`[Market Overview] ✅ ${symbol}: $${quote.price.toFixed(2)}`);
            }
          } catch (err) {
            console.log(`[Market Overview] ⚠️ ${symbol}: ${err.message}`);
          }
          // VIX fallback if fetch fails
          if (symbol === '^VIX' && !results[symbol]) {
            results[symbol] = { price: 18.5, change: 0, changePercent: 0, isFallback: true };
          }
          return { symbol, data: results[symbol] };
        })
      );

      // Update state immediately with indices (fast perceived loading)
      setMarketData(prev => ({
        ...prev,
        indices: {
          SPY: results['SPY'] || prev.indices.SPY,
          QQQ: results['QQQ'] || prev.indices.QQQ,
          DIA: results['DIA'] || prev.indices.DIA,
          IWM: results['IWM'] || prev.indices.IWM
        },
        vix: results['^VIX'] || prev.vix,
        marketStatus: getMarketStatus(),
        lastUpdate: new Date()
      }));
      console.log(`[Market Overview] ⚡ Indices loaded in ${Date.now() - startTime}ms`);

      // PHASE 2: Fetch sectors in background
      await Promise.all(
        sectorSymbols.map(async (symbol) => {
          try {
            const quote = await fetchQuickQuote(symbol, 3000);
            if (quote) {
              results[symbol] = quote;
            }
          } catch (err) {
            // Sectors failing is okay - just skip
          }
        })
      );

      // Update state with sectors (indices already updated above)
      setMarketData(prev => ({
        ...prev,
        sectors: {
          XLK: { name: 'Technology', ...(results['XLK'] || prev.sectors.XLK) },
          XLF: { name: 'Financials', ...(results['XLF'] || prev.sectors.XLF) },
          XLE: { name: 'Energy', ...(results['XLE'] || prev.sectors.XLE) },
          XLV: { name: 'Healthcare', ...(results['XLV'] || prev.sectors.XLV) },
          XLY: { name: 'Consumer Disc.', ...(results['XLY'] || prev.sectors.XLY) },
          XLP: { name: 'Consumer Staples', ...(results['XLP'] || prev.sectors.XLP) },
          XLI: { name: 'Industrials', ...(results['XLI'] || prev.sectors.XLI) },
          XLB: { name: 'Materials', ...(results['XLB'] || prev.sectors.XLB) },
          XLU: { name: 'Utilities', ...(results['XLU'] || prev.sectors.XLU) },
          XLRE: { name: 'Real Estate', ...(results['XLRE'] || prev.sectors.XLRE) },
          XLC: { name: 'Communication', ...(results['XLC'] || prev.sectors.XLC) }
        },
        lastUpdate: new Date()
      }));

      console.log(`[Market Overview] ✅ All data loaded in ${Date.now() - startTime}ms`);
    } catch (err) {
      console.error("[Market Overview] Error:", err);
    } finally {
      setLoadingMarketData(false);
    }
  };

  // Pre-fetch market data on app load (so it's ready when user switches to tab)
  const marketDataInitialized = useRef(false);
  useEffect(() => {
    if (!marketDataInitialized.current) {
      marketDataInitialized.current = true;
      console.log("[Market Overview] 🚀 Pre-fetching market data on app load...");
      fetchMarketOverview();
    }
  }, []);

  // Auto-refresh market data when tab is active
  useEffect(() => {
    if (activeTab !== "marketoverview" || !marketAutoRefresh) return;

    // If data already exists, just set up the refresh interval
    // If not, fetch immediately (though pre-fetch should have it)
    if (!marketData.lastUpdate) {
      fetchMarketOverview();
    }

    const interval = setInterval(fetchMarketOverview, 15000); // Every 15 seconds

    return () => clearInterval(interval);
  }, [activeTab, marketAutoRefresh]);

  // ============================================
  // NEWS & SENTIMENT FEED - Generate market news
  // ============================================
  const generateNewsFeed = async () => {
    setLoadingNews(true);
    console.log("[News Feed] 📰 Fetching REAL-TIME market news...");

    try {
      // List of popular stocks to fetch news for
      const popularStocks = ['AAPL', 'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'META', 'TSLA', 'AMD', 'JPM', 'SPY'];

      // Fetch news for multiple stocks in parallel
      const newsPromises = popularStocks.map(symbol =>
        fetchRealTimeNews(symbol, 4).catch(() => [])
      );

      const allNewsArrays = await Promise.all(newsPromises);
      let allNews = allNewsArrays.flat();

      // If real news fetch failed, show a message but don't show fake news
      if (allNews.length === 0) {
        console.log("[News Feed] ⚠️ Could not fetch real-time news, APIs may be unavailable");
        setNewsFeed([{
          id: 'no-news',
          headline: 'Unable to fetch real-time news. Please check your connection and try again.',
          symbol: 'INFO',
          sentiment: 'neutral',
          impact: 'low',
          category: 'System',
          source: 'MODUS',
          timestamp: new Date(),
          isReal: false
        }]);
        return;
      }

      // Remove duplicates (same headline)
      const seenHeadlines = new Set();
      allNews = allNews.filter(news => {
        const key = news.headline.toLowerCase().trim();
        if (seenHeadlines.has(key)) return false;
        seenHeadlines.add(key);
        return true;
      });

      // Add unique IDs
      const now = Date.now();
      const newsWithIds = allNews.map((news, idx) => ({
        ...news,
        id: `news-${now}-${idx}`
      }));

      // Sort by timestamp (newest first)
      newsWithIds.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Limit to top 25 news items
      const finalNews = newsWithIds.slice(0, 25);

      setNewsFeed(finalNews);
      console.log(`[News Feed] ✅ Fetched ${finalNews.length} REAL news items from APIs`);
    } catch (err) {
      console.error("[News Feed] Error fetching real news:", err);
      setNewsFeed([{
        id: 'error',
        headline: 'Error fetching news. Please try refreshing the page.',
        symbol: 'ERROR',
        sentiment: 'neutral',
        impact: 'low',
        category: 'System',
        source: 'MODUS',
        timestamp: new Date(),
        isReal: false
      }]);
    } finally {
      setLoadingNews(false);
    }
  };

  // Load news when tab is active (news tab or dashboard with news widget)
  useEffect(() => {
    if (newsFeed.length === 0 && (activeTab === "news" || (activeTab === "dashboard" && dashboardWidgets.includes('news')))) {
      generateNewsFeed();
    }
  }, [activeTab]);

  return (
    <div className="min-h-screen text-slate-100" style={{ background: 'linear-gradient(135deg, #030712 0%, #0f172a 40%, #0c1222 70%, #030712 100%)' }}>
      {/* Toast Notification */}
      {toast && (
        <div
          className={`fixed top-3 right-3 left-3 sm:left-auto sm:right-4 sm:top-4 z-[60] px-4 py-3 rounded-xl shadow-2xl border backdrop-blur-sm animate-slideIn flex items-center gap-3 max-w-sm ${
            toast.type === 'success' ? 'bg-emerald-500/15 border-emerald-500/40 text-emerald-300 shadow-lg shadow-emerald-500/10' :
            toast.type === 'error' ? 'bg-red-500/15 border-red-500/40 text-red-300 shadow-lg shadow-red-500/10' :
            'bg-blue-500/15 border-blue-500/40 text-blue-300 shadow-lg shadow-blue-500/10'
          }`}
        >
          <span className="text-sm font-medium">{toast.message}</span>
          <button
            onClick={() => setToast(null)}
            className="ml-auto text-slate-400 hover:text-white transition-colors"
          >
            <X className="w-4 h-4" />
          </button>
        </div>
      )}

      {/* API Key Modal - ENHANCED WITH BACKEND MODE & SMS */}
      {showApiKeyModal && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-lg z-50 flex items-center justify-center p-4 animate-fadeIn overflow-y-auto">
          <div className="bg-gradient-to-br from-slate-900 to-slate-950 rounded-2xl border border-slate-700/30 p-6 max-w-lg w-full shadow-2xl shadow-black/50 my-8">
            <div className="flex items-center gap-3 mb-6">
              <div className="p-2.5 bg-violet-500/20 rounded-xl">
                <Settings className="w-5 h-5 text-violet-400" />
              </div>
              <div>
                <h3 className="text-xl font-bold bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">Settings</h3>
                <p className="text-xs text-slate-500">API & SMS Configuration</p>
              </div>
            </div>

            {/* API Mode Selector */}
            <div className="mb-6">
              <label className="block text-sm text-slate-300 font-medium mb-3">API Mode</label>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => setUseBackendApi(true)}
                  className={`p-4 rounded-xl border-2 transition-all ${
                    useBackendApi
                      ? 'border-emerald-500 bg-emerald-500/20'
                      : 'border-slate-700 bg-slate-800/50 hover:border-slate-600'
                  }`}
                >
                  <div className="text-2xl mb-2">☁️</div>
                  <div className={`font-semibold ${useBackendApi ? 'text-emerald-400' : 'text-slate-300'}`}>Cloud Backend</div>
                  <div className="text-xs text-slate-400 mt-1">Deploy to Vercel (free)</div>
                  <div className="text-xs text-emerald-400 mt-2">✓ No API key input needed</div>
                </button>
                <button
                  onClick={() => setUseBackendApi(false)}
                  className={`p-4 rounded-xl border-2 transition-all ${
                    !useBackendApi
                      ? 'border-violet-500 bg-violet-500/20'
                      : 'border-slate-700 bg-slate-800/50 hover:border-slate-600'
                  }`}
                >
                  <div className="text-2xl mb-2">🔑</div>
                  <div className={`font-semibold ${!useBackendApi ? 'text-violet-400' : 'text-slate-300'}`}>Direct API</div>
                  <div className="text-xs text-slate-400 mt-1">Enter your own key</div>
                  <div className="text-xs text-amber-400 mt-2">⚠️ Key exposed in browser</div>
                </button>
              </div>
            </div>

            {/* Backend Mode Instructions */}
            {useBackendApi && (
              <div className="mb-6 p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl">
                <h4 className="font-semibold text-emerald-400 mb-2">☁️ Cloud Backend Mode</h4>
                <p className="text-sm text-slate-300 mb-3">
                  Your API key is stored securely on the server. No key input required here!
                </p>
                <div className="text-xs text-slate-400 space-y-1">
                  <p>✅ API key stored in Vercel environment variables</p>
                  <p>✅ Never exposed to browser or users</p>
                  <p>✅ 100% free with Vercel hobby tier</p>
                </div>
                <div className="mt-3 pt-3 border-t border-emerald-500/20">
                  <p className="text-xs text-slate-500">
                    Not deployed yet? See the README.md for setup instructions.
                  </p>
                </div>
              </div>
            )}

            {/* Direct API Mode - Show API Key Input */}
            {!useBackendApi && (
              <div className="space-y-5 mb-6">
                <div>
                  <label className="block text-sm text-slate-300 font-medium mb-2">Anthropic API Key <span className="text-red-400">*</span></label>
                  <input
                    type="password"
                    value={apiKeyInput}
                    onChange={(e) => setApiKeyInput(e.target.value)}
                    placeholder="sk-ant-..."
                    className="w-full bg-slate-800/80 border border-slate-600/50 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 transition-all"
                  />
                  <p className="text-xs text-slate-500 mt-2 flex items-center gap-1">
                    <Key className="w-3 h-3" />
                    Get from: <a href="https://console.anthropic.com" target="_blank" rel="noopener noreferrer" className="text-violet-400 hover:underline hover:text-violet-300 transition-colors">console.anthropic.com</a>
                  </p>
                </div>

                <div>
                  <label className="block text-sm text-slate-300 font-medium mb-2">Stock API Key <span className="text-slate-500 font-normal">(Optional)</span></label>
                  <input
                    type="password"
                    value={stockApiKeyInput}
                    onChange={(e) => setStockApiKeyInput(e.target.value)}
                    placeholder="Finnhub API key (enhances data quality)"
                    className="w-full bg-slate-800/80 border border-slate-600/50 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 transition-all"
                  />
                  <div className="mt-2 p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-xl">
                    <p className="text-xs text-emerald-300">
                      ✅ Live Ticker works WITHOUT this key (uses Yahoo Finance)
                    </p>
                  </div>
                </div>
              </div>
            )}

            {/* SMS Alerts Section */}
            <div className="mb-6 pt-4 border-t border-slate-700/50">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                  <Bell className="w-5 h-5 text-violet-400" />
                  <span className="font-semibold">SMS Alerts</span>
                  <span className="text-xs px-2 py-0.5 bg-emerald-500/20 text-emerald-400 rounded-full">FREE</span>
                </div>
                <button
                  onClick={() => setSmsSettings(prev => ({ ...prev, enabled: !prev.enabled }))}
                  className={`relative w-12 h-6 rounded-full transition-colors ${
                    smsSettings.enabled ? 'bg-emerald-500' : 'bg-slate-700'
                  }`}
                >
                  <div className={`absolute top-0.5 w-5 h-5 rounded-full bg-white transition-transform ${
                    smsSettings.enabled ? 'translate-x-6' : 'translate-x-0.5'
                  }`} />
                </button>
              </div>

              {smsSettings.enabled && (
                <div className="space-y-4 animate-fadeIn">
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-xs text-slate-400 mb-1">Phone Number</label>
                      <input
                        type="tel"
                        value={smsSettings.phone}
                        onChange={(e) => setSmsSettings(prev => ({ ...prev, phone: e.target.value.replace(/\D/g, '') }))}
                        placeholder="5551234567"
                        maxLength={11}
                        className="w-full bg-slate-800/80 border border-slate-600/50 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/50"
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-slate-400 mb-1">Carrier</label>
                      <select
                        value={smsSettings.carrier}
                        onChange={(e) => setSmsSettings(prev => ({ ...prev, carrier: e.target.value }))}
                        className="w-full bg-slate-800/80 border border-slate-600/50 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/50"
                      >
                        {CARRIER_OPTIONS.map(c => (
                          <option key={c.value} value={c.value}>{c.label}</option>
                        ))}
                      </select>
                    </div>
                  </div>

                  <div>
                    <label className="block text-xs text-slate-400 mb-2">Alert Types</label>
                    <div className="grid grid-cols-2 gap-2">
                      {[
                        { key: 'priceAlerts', label: 'Price Alerts', icon: '📊' },
                        { key: 'tradeSignals', label: 'Trade Signals', icon: '🎯' },
                        { key: 'dailyPick', label: 'Daily Pick', icon: '⭐' },
                        { key: 'newsAlerts', label: 'News Alerts', icon: '📰' },
                      ].map(type => (
                        <button
                          key={type.key}
                          onClick={() => setSmsSettings(prev => ({
                            ...prev,
                            alertTypes: { ...prev.alertTypes, [type.key]: !prev.alertTypes[type.key] }
                          }))}
                          className={`p-2 rounded-lg border text-xs transition-all flex items-center gap-2 ${
                            smsSettings.alertTypes[type.key]
                              ? 'border-emerald-500 bg-emerald-500/20 text-emerald-300'
                              : 'border-slate-700 bg-slate-800/50 text-slate-400 hover:border-slate-600'
                          }`}
                        >
                          <span>{type.icon}</span>
                          <span>{type.label}</span>
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="p-3 bg-slate-800/50 rounded-lg">
                    <div className="flex items-center justify-between text-xs">
                      <span className="text-slate-400">Monthly SMS Quota</span>
                      <span className={smsQuotaRemaining > 20 ? 'text-emerald-400' : 'text-amber-400'}>
                        {smsQuotaRemaining}/200 remaining
                      </span>
                    </div>
                    <div className="mt-2 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                      <div
                        className={`h-full rounded-full transition-all ${smsQuotaRemaining > 20 ? 'bg-emerald-500' : 'bg-amber-500'}`}
                        style={{ width: `${(smsQuotaRemaining / 200) * 100}%` }}
                      />
                    </div>
                    <p className="text-xs text-slate-500 mt-2">
                      200 free SMS/month via EmailJS. Get your own free account above.
                    </p>
                  </div>

                  {/* Discord Webhook Settings */}
                  <div className="border-t border-slate-700 pt-4">
                    <label className="block text-sm font-semibold text-slate-200 mb-3">Discord Notifications</label>
                    <p className="text-xs text-slate-400 mb-3">Get unlimited notifications via Discord webhook as a free alternative to SMS.</p>

                    <div className="space-y-3">
                      <div>
                        <label className="block text-xs text-slate-400 mb-2">Webhook URL</label>
                        <input
                          type="password"
                          value={localStorage.getItem('modus_discord_webhook') || ''}
                          onChange={(e) => {
                            if (e.target.value) {
                              localStorage.setItem('modus_discord_webhook', e.target.value);
                            } else {
                              localStorage.removeItem('modus_discord_webhook');
                            }
                          }}
                          placeholder="https://discord.com/api/webhooks/..."
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/50 text-slate-300 placeholder-slate-600"
                        />
                      </div>

                      <div className="bg-slate-900/50 border border-slate-700 rounded-lg p-3">
                        <p className="text-xs text-slate-400 mb-2">How to get a Discord webhook URL:</p>
                        <ol className="text-xs text-slate-500 space-y-1 ml-4 list-decimal">
                          <li>Go to your Discord server settings</li>
                          <li>Select "Integrations" then "Webhooks"</li>
                          <li>Click "New Webhook" and choose a channel</li>
                          <li>Copy the webhook URL and paste it above</li>
                        </ol>
                      </div>

                      <button
                        onClick={async () => {
                          const webhookUrl = localStorage.getItem('modus_discord_webhook');
                          if (!webhookUrl) {
                            alert('Please enter a Discord webhook URL first');
                            return;
                          }
                          try {
                            await fetch(webhookUrl, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                embeds: [{
                                  title: '✅ MODUS Test Notification',
                                  description: 'Your Discord webhook is working! This is a test message.',
                                  color: 0x10B981,
                                  timestamp: new Date().toISOString()
                                }]
                              })
                            });
                            alert('Test message sent! Check your Discord channel.');
                          } catch (e) {
                            alert('Failed to send test message: ' + e.message);
                          }
                        }}
                        className="w-full py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg font-semibold text-sm transition-all"
                      >
                        Test Webhook
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Data Backup & Restore */}
              <div className="border-t border-slate-700/50 pt-4 mt-4">
                <h3 className="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
                  <Download className="w-4 h-4" />
                  Data Backup & Restore
                </h3>
                <div className="space-y-3">
                  <button
                    onClick={exportAllData}
                    className="w-full py-2.5 px-4 bg-violet-600/20 hover:bg-violet-600/30 border border-violet-500/30 rounded-lg text-sm text-violet-300 hover:text-white transition-all flex items-center justify-center gap-2"
                  >
                    <Download className="w-4 h-4" />
                    Export All Data (JSON)
                  </button>
                  <label className="w-full py-2.5 px-4 bg-slate-800/50 hover:bg-slate-700/50 border border-slate-700/50 rounded-lg text-sm text-slate-300 hover:text-white transition-all flex items-center justify-center gap-2 cursor-pointer">
                    <Upload className="w-4 h-4" />
                    Import Backup File
                    <input
                      type="file"
                      accept=".json"
                      className="hidden"
                      onChange={(e) => {
                        if (e.target.files[0]) {
                          if (window.confirm('This will overwrite your current data. Are you sure?')) {
                            importAllData(e.target.files[0]);
                          }
                          e.target.value = '';
                        }
                      }}
                    />
                  </label>
                  <p className="text-[10px] text-slate-600">Exports: watchlist, trades, alerts, portfolio, settings. File can be imported on any device.</p>
                </div>
              </div>
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => {
                  if (!useBackendApi) {
                    saveApiKey();
                  }
                  // Save SMS settings to session storage
                  sessionStorage.setItem('modus_sms_settings', JSON.stringify(smsSettings));
                  sessionStorage.setItem('modus_use_backend', JSON.stringify(useBackendApi));
                  setShowApiKeyModal(false);
                }}
                className="flex-1 bg-gradient-to-r from-violet-600 to-violet-700 hover:from-violet-500 hover:to-violet-600 text-white rounded-xl py-3 font-semibold transition-all duration-200 shadow-lg shadow-violet-500/25 btn-press"
              >
                Save Settings
              </button>
              <button
                onClick={() => setShowApiKeyModal(false)}
                className="flex-1 bg-slate-800 hover:bg-slate-700 text-white rounded-xl py-3 font-semibold transition-all duration-200 border border-slate-700/50"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* AUTH MODAL - Login / Signup / Password Reset */}
      {showAuthModal && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-fadeIn overflow-y-auto">
          <div className="bg-gradient-to-br from-slate-900 to-slate-950 rounded-2xl border border-violet-500/30 p-4 md:p-6 max-w-sm md:max-w-md w-full shadow-2xl my-8">
            {/* Header */}
            <div className="flex items-center justify-between mb-4 md:mb-6">
              <div className="flex items-center gap-3">
                <div className="p-2.5 bg-violet-500/20 rounded-xl">
                  {authMode === 'login' ? <LogIn className="w-5 h-5 text-violet-400" /> :
                   authMode === 'signup' ? <User className="w-5 h-5 text-violet-400" /> :
                   <Mail className="w-5 h-5 text-violet-400" />}
                </div>
                <div>
                  <h3 className="text-lg md:text-xl font-bold bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">
                    {authMode === 'login' ? 'Welcome Back' :
                     authMode === 'signup' ? 'Create Account' :
                     'Reset Password'}
                  </h3>
                  <p className="text-xs text-slate-500">
                    {authMode === 'login' ? 'Sign in to sync your data' :
                     authMode === 'signup' ? 'Start your trading journey' :
                     'Enter your email to reset'}
                  </p>
                </div>
              </div>
              <button
                onClick={() => { setShowAuthModal(false); setAuthError(''); }}
                className="p-2 hover:bg-slate-800 rounded-lg transition-colors"
              >
                <X className="w-5 h-5 text-slate-400" />
              </button>
            </div>

            {/* Auth Form */}
            <form onSubmit={handleAuth} className="space-y-3 md:space-y-4">
              {/* Name field for signup */}
              {authMode === 'signup' && (
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Display Name</label>
                  <div className="relative">
                    <User className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                    <input
                      type="text"
                      value={authName}
                      onChange={(e) => setAuthName(e.target.value)}
                      placeholder="Your name"
                      className="w-full bg-slate-800/50 border border-slate-700 rounded-xl pl-10 pr-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500/50"
                    />
                  </div>
                </div>
              )}

              {/* Email field */}
              <div>
                <label className="block text-sm text-slate-400 mb-2">Email</label>
                <div className="relative">
                  <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                  <input
                    type="email"
                    value={authEmail}
                    onChange={(e) => setAuthEmail(e.target.value)}
                    placeholder="you@example.com"
                    required
                    className="w-full bg-slate-800/50 border border-slate-700 rounded-xl pl-10 pr-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500/50"
                  />
                </div>
              </div>

              {/* Password field (not for reset) */}
              {authMode !== 'reset' && (
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Password</label>
                  <div className="relative">
                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                    <input
                      type="password"
                      value={authPassword}
                      onChange={(e) => setAuthPassword(e.target.value)}
                      placeholder="••••••••"
                      required
                      minLength={6}
                      className="w-full bg-slate-800/50 border border-slate-700 rounded-xl pl-10 pr-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500/50"
                    />
                  </div>
                </div>
              )}

              {/* Error Message */}
              {authError && (
                <div className={`p-3 rounded-lg text-sm ${
                  authError.includes('sent') ? 'bg-emerald-500/10 border border-emerald-500/30 text-emerald-400' :
                  'bg-red-500/10 border border-red-500/30 text-red-400'
                }`}>
                  {authError}
                </div>
              )}

              {/* Submit Button */}
              <button
                type="submit"
                disabled={authLoading}
                className="w-full bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 disabled:from-slate-700 disabled:to-slate-700 rounded-xl py-3 font-semibold transition-all duration-200 flex items-center justify-center gap-2"
              >
                {authLoading ? (
                  <Loader2 className="w-5 h-5 animate-spin" />
                ) : (
                  <>
                    {authMode === 'login' ? 'Sign In' :
                     authMode === 'signup' ? 'Create Account' :
                     'Send Reset Email'}
                  </>
                )}
              </button>
            </form>

            {/* Divider */}
            {authMode !== 'reset' && (
              <>
                <div className="flex items-center gap-3 my-4">
                  <div className="flex-1 h-px bg-slate-700"></div>
                  <span className="text-xs text-slate-500">or continue with</span>
                  <div className="flex-1 h-px bg-slate-700"></div>
                </div>

                {/* Google Sign In */}
                <button
                  onClick={handleGoogleLogin}
                  disabled={authLoading}
                  className="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl py-3 font-medium transition-all duration-200 flex items-center justify-center gap-2"
                >
                  <svg className="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                  Continue with Google
                </button>
              </>
            )}

            {/* Mode Switcher */}
            <div className="mt-4 text-center text-sm">
              {authMode === 'login' ? (
                <>
                  <button
                    onClick={() => { setAuthMode('reset'); setAuthError(''); }}
                    className="text-slate-400 hover:text-violet-400 transition-colors"
                  >
                    Forgot password?
                  </button>
                  <span className="text-slate-600 mx-2">•</span>
                  <button
                    onClick={() => { setAuthMode('signup'); setAuthError(''); }}
                    className="text-violet-400 hover:text-violet-300 transition-colors"
                  >
                    Create account
                  </button>
                </>
              ) : (
                <button
                  onClick={() => { setAuthMode('login'); setAuthError(''); }}
                  className="text-violet-400 hover:text-violet-300 transition-colors"
                >
                  Back to sign in
                </button>
              )}
            </div>

            {/* Benefits */}
            <div className="mt-6 pt-4 border-t border-slate-800">
              <p className="text-xs text-slate-500 mb-2">Why create an account?</p>
              <div className="grid grid-cols-2 gap-2 text-xs text-slate-400">
                <div className="flex items-center gap-1.5">
                  <Cloud className="w-3.5 h-3.5 text-violet-400" />
                  Sync across devices
                </div>
                <div className="flex items-center gap-1.5">
                  <Save className="w-3.5 h-3.5 text-emerald-400" />
                  Save your trades
                </div>
                <div className="flex items-center gap-1.5">
                  <Bell className="w-3.5 h-3.5 text-amber-400" />
                  Custom alerts
                </div>
                <div className="flex items-center gap-1.5">
                  <Star className="w-3.5 h-3.5 text-blue-400" />
                  Premium features
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* NEW: Create Alert Modal */}
      {showCreateAlert && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
          <div className="bg-slate-900 rounded-2xl border border-slate-700 p-6 max-w-2xl w-full shadow-2xl my-8">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <Bell className="w-6 h-6 text-violet-400" />
                <h3 className="text-xl font-semibold">Create Advanced Alert</h3>
              </div>
              <button
                onClick={() => {
                  setShowCreateAlert(false);
                  setTechnicalAlertType('simple');
                  setAlertConditions([]);
                }}
                className="p-2 hover:bg-slate-800 rounded-lg transition-colors"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            
            {/* Alert Type Selector */}
            <div className="mb-6">
              <label className="block text-sm text-slate-400 mb-2 font-semibold">Alert Type</label>
              <div className="grid grid-cols-3 gap-2">
                <button
                  onClick={() => setTechnicalAlertType('simple')}
                  className={`p-3 rounded-lg border-2 transition-all ${
                    technicalAlertType === 'simple'
                      ? 'border-violet-500 bg-violet-500/20 text-white'
                      : 'border-slate-700 bg-slate-800/50 text-slate-400 hover:border-slate-600'
                  }`}
                >
                  <div className="font-semibold">Simple</div>
                  <div className="text-xs mt-1">Price alerts</div>
                </button>
                <button
                  onClick={() => setTechnicalAlertType('technical')}
                  className={`p-3 rounded-lg border-2 transition-all ${
                    technicalAlertType === 'technical'
                      ? 'border-violet-500 bg-violet-500/20 text-white'
                      : 'border-slate-700 bg-slate-800/50 text-slate-400 hover:border-slate-600'
                  }`}
                >
                  <div className="font-semibold">Technical</div>
                  <div className="text-xs mt-1">RSI, MACD</div>
                </button>
                <button
                  onClick={() => setTechnicalAlertType('multi')}
                  className={`p-3 rounded-lg border-2 transition-all ${
                    technicalAlertType === 'multi'
                      ? 'border-violet-500 bg-violet-500/20 text-white'
                      : 'border-slate-700 bg-slate-800/50 text-slate-400 hover:border-slate-600'
                  }`}
                >
                  <div className="font-semibold">Multi</div>
                  <div className="text-xs mt-1">AND/OR logic</div>
                </button>
              </div>
            </div>
            
            <div className="space-y-4 mb-6">
              <div>
                <label className="block text-sm text-slate-400 mb-2">Symbol</label>
                <input
                  type="text"
                  value={newAlert.symbol}
                  onChange={(e) => setNewAlert({...newAlert, symbol: e.target.value.toUpperCase()})}
                  placeholder="AAPL"
                  className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                />
              </div>
              
              {/* SIMPLE ALERT */}
              {technicalAlertType === 'simple' && (
                <>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Condition</label>
                    <select
                      value={newAlert.condition}
                      onChange={(e) => setNewAlert({...newAlert, condition: e.target.value})}
                      className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                    >
                      <option value="above">Price Above</option>
                      <option value="below">Price Below</option>
                      <option value="crosses_above">Crosses Above</option>
                      <option value="crosses_below">Crosses Below</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Target Price</label>
                    <input
                      type="number"
                      step="0.01"
                      value={newAlert.price}
                      onChange={(e) => setNewAlert({...newAlert, price: e.target.value})}
                      placeholder="150.00"
                      className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                    />
                  </div>
                </>
              )}
              
              {/* TECHNICAL ALERT */}
              {technicalAlertType === 'technical' && (
                <>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Indicator</label>
                    <select
                      value={newAlert.indicator || 'rsi'}
                      onChange={(e) => setNewAlert({...newAlert, indicator: e.target.value})}
                      className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                    >
                      <option value="rsi">RSI (Relative Strength Index)</option>
                      <option value="macd">MACD (Moving Average Convergence Divergence)</option>
                      <option value="volume">Volume</option>
                    </select>
                  </div>
                  
                  {newAlert.indicator === 'rsi' && (
                    <>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Condition</label>
                        <select
                          value={newAlert.condition || 'above'}
                          onChange={(e) => setNewAlert({...newAlert, condition: e.target.value})}
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        >
                          <option value="above">RSI Above (Overbought)</option>
                          <option value="below">RSI Below (Oversold)</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">RSI Threshold</label>
                        <input
                          type="number"
                          value={rsiThreshold}
                          onChange={(e) => setRsiThreshold(e.target.value)}
                          placeholder="70 for overbought, 30 for oversold"
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                        <p className="text-xs text-slate-500 mt-1">Standard: 70 (overbought) or 30 (oversold)</p>
                      </div>
                    </>
                  )}
                  
                  {newAlert.indicator === 'macd' && (
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">MACD Condition</label>
                      <select
                        value={macdCondition}
                        onChange={(e) => setMacdCondition(e.target.value)}
                        className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                      >
                        <option value="bullish_cross">Bullish Crossover (MACD crosses above Signal)</option>
                        <option value="bearish_cross">Bearish Crossover (MACD crosses below Signal)</option>
                        <option value="histogram_positive">Histogram Turns Positive</option>
                        <option value="histogram_negative">Histogram Turns Negative</option>
                      </select>
                    </div>
                  )}
                  
                  {newAlert.indicator === 'volume' && (
                    <>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Condition</label>
                        <select
                          value={newAlert.condition || 'above'}
                          onChange={(e) => setNewAlert({...newAlert, condition: e.target.value})}
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        >
                          <option value="above">Volume Above</option>
                          <option value="below">Volume Below</option>
                          <option value="spike">Volume Spike (2x average)</option>
                        </select>
                      </div>
                      {newAlert.condition !== 'spike' && (
                        <div>
                          <label className="block text-sm text-slate-400 mb-2">Volume Threshold</label>
                          <input
                            type="number"
                            value={newAlert.volumeThreshold || ''}
                            onChange={(e) => setNewAlert({...newAlert, volumeThreshold: e.target.value})}
                            placeholder="e.g., 1000000"
                            className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                          />
                        </div>
                      )}
                    </>
                  )}
                </>
              )}
              
              {/* MULTI-CONDITION ALERT */}
              {technicalAlertType === 'multi' && (
                <div className="space-y-2 md:space-y-3">
                  <label className="block text-sm text-slate-400 font-semibold">Conditions</label>
                  
                  {alertConditions.map((condition, index) => (
                    <div key={index} className="bg-slate-800/30 rounded-lg p-3 border border-slate-700">
                      <div className="grid grid-cols-3 gap-2 mb-2">
                        <select
                          value={condition.field}
                          onChange={(e) => {
                            const newConditions = [...alertConditions];
                            newConditions[index].field = e.target.value;
                            setAlertConditions(newConditions);
                          }}
                          className="bg-slate-800 border border-slate-700 rounded px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500"
                        >
                          <option value="price">Price</option>
                          <option value="rsi">RSI</option>
                          <option value="volume">Volume</option>
                        </select>
                        
                        <select
                          value={condition.operator}
                          onChange={(e) => {
                            const newConditions = [...alertConditions];
                            newConditions[index].operator = e.target.value;
                            setAlertConditions(newConditions);
                          }}
                          className="bg-slate-800 border border-slate-700 rounded px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500"
                        >
                          <option value="above">Above</option>
                          <option value="below">Below</option>
                          <option value="equals">Equals</option>
                        </select>
                        
                        <input
                          type="number"
                          value={condition.value}
                          onChange={(e) => {
                            const newConditions = [...alertConditions];
                            newConditions[index].value = e.target.value;
                            setAlertConditions(newConditions);
                          }}
                          placeholder="Value"
                          className="bg-slate-800 border border-slate-700 rounded px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                      </div>
                      
                      <div className="flex items-center justify-between">
                        {index < alertConditions.length - 1 && (
                          <select
                            value={condition.logic}
                            onChange={(e) => {
                              const newConditions = [...alertConditions];
                              newConditions[index].logic = e.target.value;
                              setAlertConditions(newConditions);
                            }}
                            className="bg-slate-700 border border-slate-600 rounded px-3 py-1 text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-violet-500"
                          >
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                          </select>
                        )}
                        <button
                          onClick={() => {
                            const newConditions = alertConditions.filter((_, i) => i !== index);
                            setAlertConditions(newConditions);
                          }}
                          className="ml-auto p-1 bg-red-600/20 hover:bg-red-600/30 rounded text-red-400 transition-colors"
                        >
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  ))}
                  
                  <button
                    onClick={() => {
                      setAlertConditions([...alertConditions, { field: 'price', operator: 'above', value: '', logic: 'AND' }]);
                    }}
                    className="w-full py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 border border-slate-700"
                  >
                    <Plus className="w-4 h-4" />
                    <span>Add Condition</span>
                  </button>
                  
                  {alertConditions.length > 0 && (
                    <div className="bg-blue-500/10 border border-blue-500/30 rounded p-2 text-xs text-blue-200">
                      <strong>Preview:</strong> {alertConditions.map((c, i) => 
                        `${c.field} ${c.operator} ${c.value}${i < alertConditions.length - 1 ? ` ${c.logic} ` : ''}`
                      ).join('')}
                    </div>
                  )}
                </div>
              )}
              
              <div>
                <label className="block text-sm text-slate-400 mb-2">Custom Message (Optional)</label>
                <input
                  type="text"
                  value={newAlert.message}
                  onChange={(e) => setNewAlert({...newAlert, message: e.target.value})}
                  placeholder="e.g., AAPL is overbought!"
                  className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                />
              </div>
            </div>
            
            <div className="flex gap-3">
              <button
                onClick={createAlert}
                className="flex-1 bg-violet-600 hover:bg-violet-500 text-white rounded-lg py-3 font-semibold transition-colors flex items-center justify-center gap-2"
              >
                <Bell className="w-4 h-4" />
                <span>Create Alert</span>
              </button>
              <button
                onClick={() => {
                  setShowCreateAlert(false);
                  setTechnicalAlertType('simple');
                  setAlertConditions([]);
                }}
                className="flex-1 bg-slate-700 hover:bg-slate-600 text-white rounded-lg py-3 font-semibold transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* ALERT HISTORY MODAL */}
      {showAlertHistory && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
          <div className="bg-slate-900 rounded-2xl border border-slate-700 p-6 max-w-3xl w-full shadow-2xl my-8">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <Calendar className="w-6 h-6 text-violet-400" />
                <h3 className="text-xl font-semibold">Alert History</h3>
                <span className="px-2 py-1 bg-violet-600/20 text-violet-300 rounded text-sm font-semibold">
                  {alertHistory.length} triggered
                </span>
              </div>
              <button
                onClick={() => setShowAlertHistory(false)}
                className="p-2 hover:bg-slate-800 rounded-lg transition-colors"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            
            {alertHistory.length === 0 ? (
              <div className="text-center py-12">
                <Calendar className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                <p className="text-slate-400 text-lg">No alerts have been triggered yet</p>
              </div>
            ) : (
              <>
                <div className="space-y-3 mb-6 max-h-96 overflow-y-auto">
                  {alertHistory.map((alert, index) => (
                    <div key={index} className="bg-slate-800/30 rounded-lg p-4 border border-slate-700">
                      <div className="flex items-start justify-between mb-2">
                        <div>
                          <div className="flex items-center gap-2">
                            <span className="font-bold text-lg">{alert.symbol}</span>
                            <span className="px-2 py-0.5 bg-emerald-600/20 text-emerald-300 rounded text-xs font-semibold">
                              TRIGGERED
                            </span>
                          </div>
                          <p className="text-sm text-slate-300 mt-1">{alert.message}</p>
                        </div>
                        <div className="text-right">
                          <div className="text-xs text-slate-500">
                            {new Date(alert.triggeredAt).toLocaleDateString()}
                          </div>
                          <div className="text-xs text-slate-400">
                            {new Date(alert.triggeredAt).toLocaleTimeString()}
                          </div>
                        </div>
                      </div>
                      <div className="text-sm">
                        <span className="text-slate-400">Trigger Value: </span>
                        <span className="font-mono text-violet-400">{alert.triggerValue}</span>
                      </div>
                    </div>
                  ))}
                </div>
                
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      // Export to CSV
                      const csv = [
                        ['Symbol', 'Message', 'Trigger Value', 'Date', 'Time'],
                        ...alertHistory.map(a => [
                          a.symbol,
                          a.message,
                          a.triggerValue,
                          new Date(a.triggeredAt).toLocaleDateString(),
                          new Date(a.triggeredAt).toLocaleTimeString()
                        ])
                      ].map(row => row.join(',')).join('\n');
                      
                      const blob = new Blob([csv], { type: 'text/csv' });
                      const url = window.URL.createObjectURL(blob);
                      const a = document.createElement('a');
                      a.href = url;
                      a.download = `alert-history-${new Date().toISOString().split('T')[0]}.csv`;
                      a.click();
                    }}
                    className="flex-1 bg-blue-600 hover:bg-blue-500 text-white rounded-lg py-3 font-semibold transition-colors flex items-center justify-center gap-2"
                  >
                    <Download className="w-4 h-4" />
                    <span>Export CSV</span>
                  </button>
                  <button
                    onClick={() => {
                      setConfirmMessage('Clear all alert history? This cannot be undone.');
                      setConfirmAction(() => () => {
                        setAlertHistory([]);
                        setShowConfirmModal(false);
                      });
                      setShowConfirmModal(true);
                    }}
                    className="flex-1 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-lg py-3 font-semibold transition-colors"
                  >
                    Clear All
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      )}

      {/* TOAST NOTIFICATIONS */}
      {toasts.length > 0 && (
        <div className="fixed top-4 right-4 z-[100] flex flex-col gap-2 max-w-sm" style={{ pointerEvents: 'none' }}>
          {toasts.map(toast => (
            <div
              key={toast.id}
              className={`flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl border backdrop-blur-xl text-sm font-medium ${
                toast.type === 'success' ? 'bg-emerald-900/90 border-emerald-500/30 text-emerald-200' :
                toast.type === 'error' ? 'bg-red-900/90 border-red-500/30 text-red-200' :
                toast.type === 'warning' ? 'bg-amber-900/90 border-amber-500/30 text-amber-200' :
                'bg-slate-800/90 border-slate-600/30 text-slate-200'
              }`}
              style={{ animation: 'slideIn 0.3s ease-out', pointerEvents: 'auto' }}
            >
              <span className="text-lg flex-shrink-0">
                {toast.type === 'success' ? '✅' : toast.type === 'error' ? '❌' : toast.type === 'warning' ? '⚠️' : 'ℹ️'}
              </span>
              <span className="flex-1">{toast.message}</span>
              <button onClick={() => removeToast(toast.id)} className="text-slate-400 hover:text-white ml-1 flex-shrink-0">
                <span className="text-xs">✕</span>
              </button>
            </div>
          ))}
        </div>
      )}

      {/* CONFIRMATION MODAL */}
      {showConfirmModal && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
          <div className="bg-slate-900 rounded-2xl border border-slate-700 p-6 max-w-md w-full shadow-2xl">
            <div className="flex items-center gap-3 mb-4">
              <div className="p-3 bg-red-500/20 rounded-lg">
                <AlertTriangle className="w-6 h-6 text-red-400" />
              </div>
              <h3 className="text-xl font-semibold">Confirm Action</h3>
            </div>
            
            <p className="text-slate-300 mb-6">{confirmMessage}</p>
            
            <div className="flex gap-3">
              <button
                onClick={() => {
                  if (confirmAction) confirmAction();
                  setShowConfirmModal(false);
                }}
                className="flex-1 bg-red-600 hover:bg-red-500 text-white rounded-lg py-3 font-semibold transition-colors"
              >
                Confirm
              </button>
              <button
                onClick={() => setShowConfirmModal(false)}
                className="flex-1 bg-slate-700 hover:bg-slate-600 text-white rounded-lg py-3 font-semibold transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* NOTIFICATION CENTER PANEL */}
      {showNotificationCenter && (
        <div className="fixed right-0 top-0 h-full w-full sm:w-96 bg-slate-900 border-l border-slate-700/50 z-[55] shadow-2xl flex flex-col" style={{ animation: 'slideIn 0.3s ease-out' }}>
          <div className="p-4 border-b border-slate-700/50 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-violet-500/20 rounded-lg">
                <Bell className="w-5 h-5 text-violet-400" />
              </div>
              <div>
                <h3 className="font-semibold text-lg">Notifications</h3>
                <p className="text-xs text-slate-500">{notificationHistory.length} total</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              {notificationHistory.length > 0 && (
                <button onClick={clearNotifications} className="text-xs text-slate-500 hover:text-red-400 transition-colors px-2 py-1">
                  Clear All
                </button>
              )}
              <button onClick={() => setShowNotificationCenter(false)} className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                <X className="w-5 h-5 text-slate-400" />
              </button>
            </div>
          </div>

          {/* Notification Preferences */}
          <div className="px-4 py-3 border-b border-slate-800/50 flex items-center gap-3 flex-wrap">
            <span className="text-xs text-slate-500">Notify via:</span>
            {[
              { key: 'sound', label: 'Sound', icon: '🔊' },
              { key: 'browser', label: 'Browser', icon: '🌐' },
            ].map(pref => (
              <button
                key={pref.key}
                onClick={() => setNotificationPrefs(prev => ({ ...prev, [pref.key]: !prev[pref.key] }))}
                className={`text-xs px-2.5 py-1 rounded-full transition-all ${
                  notificationPrefs[pref.key]
                    ? 'bg-violet-500/20 text-violet-300 border border-violet-500/30'
                    : 'bg-slate-800 text-slate-500 border border-slate-700/30'
                }`}
              >
                {pref.icon} {pref.label}
              </button>
            ))}
          </div>

          {/* Notification List */}
          <div className="flex-1 overflow-y-auto">
            {notificationHistory.length === 0 ? (
              <div className="flex flex-col items-center justify-center h-64 text-slate-500">
                <Bell className="w-12 h-12 mb-3 opacity-30" />
                <p className="text-sm">No notifications yet</p>
                <p className="text-xs mt-1">Price alerts will appear here</p>
              </div>
            ) : (
              notificationHistory.map(notif => (
                <div key={notif.id} className={`px-4 py-3 border-b border-slate-800/30 hover:bg-slate-800/30 transition-colors ${!notif.read ? 'bg-violet-500/5 border-l-2 border-l-violet-500' : ''}`}>
                  <div className="flex items-start gap-3">
                    <span className="text-xl mt-0.5">{notif.icon || '🔔'}</span>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center justify-between gap-2">
                        <h4 className="font-medium text-sm truncate">{notif.title}</h4>
                        <span className="text-[10px] text-slate-500 whitespace-nowrap">
                          {new Date(notif.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </span>
                      </div>
                      <p className="text-xs text-slate-400 mt-0.5 line-clamp-2">{notif.message}</p>
                      {notif.symbol && (
                        <button
                          onClick={() => { setTickerSymbol(notif.symbol); setActiveTab('ticker'); setShowNotificationCenter(false); }}
                          className="text-[10px] text-violet-400 hover:text-violet-300 mt-1 font-medium"
                        >
                          View ${notif.symbol} →
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      )}

      {/* SHARE MODAL */}
      {showShareModal && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4" onClick={() => setShowShareModal(false)}>
          <div className="bg-slate-900 rounded-2xl border border-slate-700 p-6 max-w-lg w-full shadow-2xl" onClick={e => e.stopPropagation()} style={{ animation: 'slideUp 0.3s ease-out' }}>
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-violet-500/20 rounded-lg">
                  <ArrowUpRight className="w-5 h-5 text-violet-400" />
                </div>
                <h3 className="text-xl font-semibold">Share Analysis</h3>
              </div>
              <button onClick={() => setShowShareModal(false)} className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                <X className="w-5 h-5 text-slate-400" />
              </button>
            </div>

            {/* Preview */}
            <div className="bg-slate-800/50 rounded-xl p-4 mb-4 border border-slate-700/30 max-h-48 overflow-y-auto">
              <pre className="text-xs text-slate-300 whitespace-pre-wrap font-mono">{shareContent || generateShareText(analysis)}</pre>
            </div>

            {/* Share Options */}
            <div className="grid grid-cols-2 gap-3">
              <button
                onClick={() => { shareAnalysis('copy'); setShowShareModal(false); }}
                className="flex items-center justify-center gap-2 px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl transition-all border border-slate-700/50 text-sm font-medium"
              >
                <span>📋</span> Copy Text
              </button>
              <button
                onClick={() => { shareAnalysis('twitter'); setShowShareModal(false); }}
                className="flex items-center justify-center gap-2 px-4 py-3 bg-[#1DA1F2]/20 hover:bg-[#1DA1F2]/30 rounded-xl transition-all border border-[#1DA1F2]/30 text-sm font-medium text-[#1DA1F2]"
              >
                <span>𝕏</span> Twitter/X
              </button>
              <button
                onClick={() => { shareAnalysis('reddit'); setShowShareModal(false); }}
                className="flex items-center justify-center gap-2 px-4 py-3 bg-[#FF4500]/20 hover:bg-[#FF4500]/30 rounded-xl transition-all border border-[#FF4500]/30 text-sm font-medium text-[#FF4500]"
              >
                <span>🟠</span> Reddit
              </button>
              {navigator.share && (
                <button
                  onClick={() => { shareAnalysis('native'); setShowShareModal(false); }}
                  className="flex items-center justify-center gap-2 px-4 py-3 bg-violet-600/20 hover:bg-violet-600/30 rounded-xl transition-all border border-violet-500/30 text-sm font-medium text-violet-400"
                >
                  <ArrowUpRight className="w-4 h-4" /> More...
                </button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* TRADE REPLAY MODAL (Feature 2) */}
      {tradeReplayOpen && replayTrade && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4" onClick={() => { setTradeReplayOpen(false); setReplayPlaying(false); }}>
          <div className="bg-slate-900 rounded-2xl border border-slate-700 p-6 max-w-2xl w-full shadow-2xl" onClick={e => e.stopPropagation()} style={{ animation: 'slideUp 0.3s ease-out' }}>
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-violet-500/20 rounded-lg replay-pulse">
                  <Activity className="w-5 h-5 text-violet-400" />
                </div>
                <div>
                  <h3 className="text-lg font-semibold">Trade Replay</h3>
                  <span className="text-xs text-slate-500">{replayTrade.ticker || replayTrade.symbol} — {replayTrade.direction || 'Long'}</span>
                </div>
              </div>
              <button onClick={() => { setTradeReplayOpen(false); setReplayPlaying(false); }} className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                <X className="w-5 h-5 text-slate-400" />
              </button>
            </div>

            {/* Mini chart visualization */}
            <div className="bg-slate-800/50 rounded-xl p-4 mb-4 border border-slate-700/30 relative h-48">
              <svg viewBox="0 0 400 120" className="w-full h-full">
                {/* Grid lines */}
                {[0, 30, 60, 90, 120].map(y => (
                  <line key={y} x1="0" y1={y} x2="400" y2={y} stroke="#334155" strokeWidth="0.5" strokeDasharray="4 4" />
                ))}
                {/* Simulated price line */}
                {(() => {
                  const entry = parseFloat(replayTrade.entryPrice) || 100;
                  const exit = parseFloat(replayTrade.exitPrice) || entry * 1.05;
                  const pnl = exit - entry;
                  const isWin = pnl >= 0;
                  const mid = (entry + exit) / 2;
                  const range = Math.max(Math.abs(pnl) * 3, entry * 0.05);
                  const toY = (p) => 110 - ((p - (mid - range/2)) / range) * 100;
                  // Generate a realistic-looking path
                  const points = [];
                  let price = entry;
                  for (let i = 0; i <= 20; i++) {
                    const t = i / 20;
                    price = entry + (exit - entry) * t + (Math.sin(t * 12) * range * 0.1) + (Math.random() - 0.5) * range * 0.08;
                    points.push(`${i * 20},${Math.max(5, Math.min(115, toY(price)))}`);
                  }
                  points[points.length - 1] = `400,${toY(exit)}`;
                  const entryY = toY(entry);
                  const exitY = toY(exit);
                  return (
                    <>
                      <polyline points={points.join(' ')} fill="none" stroke={isWin ? '#10b981' : '#ef4444'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" opacity="0.8" />
                      {/* Entry marker */}
                      <line x1="0" y1={entryY} x2="400" y2={entryY} stroke="#8b5cf6" strokeWidth="1" strokeDasharray="6 3" opacity="0.5" />
                      <circle cx="0" cy={entryY} r="5" fill="#8b5cf6" />
                      <text x="8" y={entryY - 8} fill="#a78bfa" fontSize="10">Entry ${entry.toFixed(2)}</text>
                      {/* Exit marker */}
                      <line x1="0" y1={exitY} x2="400" y2={exitY} stroke={isWin ? '#10b981' : '#ef4444'} strokeWidth="1" strokeDasharray="6 3" opacity="0.5" />
                      <circle cx="400" cy={exitY} r="5" fill={isWin ? '#10b981' : '#ef4444'} />
                      <text x="340" y={exitY - 8} fill={isWin ? '#6ee7b7' : '#fca5a5'} fontSize="10">Exit ${exit.toFixed(2)}</text>
                      {/* Stop loss if available */}
                      {replayTrade.stopLoss && (
                        <>
                          <line x1="0" y1={toY(parseFloat(replayTrade.stopLoss))} x2="400" y2={toY(parseFloat(replayTrade.stopLoss))} stroke="#ef4444" strokeWidth="1" strokeDasharray="2 4" opacity="0.3" />
                          <text x="340" y={toY(parseFloat(replayTrade.stopLoss)) + 12} fill="#f87171" fontSize="9" opacity="0.6">SL ${parseFloat(replayTrade.stopLoss).toFixed(2)}</text>
                        </>
                      )}
                    </>
                  );
                })()}
              </svg>
            </div>

            {/* Trade Details Grid */}
            <div className="grid grid-cols-4 gap-3 mb-4">
              <div className="bg-slate-800/40 rounded-lg p-2 text-center">
                <div className="text-[10px] text-slate-500 uppercase">Entry</div>
                <div className="text-sm font-bold text-violet-400">${parseFloat(replayTrade.entryPrice || 0).toFixed(2)}</div>
              </div>
              <div className="bg-slate-800/40 rounded-lg p-2 text-center">
                <div className="text-[10px] text-slate-500 uppercase">Exit</div>
                <div className="text-sm font-bold text-white">${parseFloat(replayTrade.exitPrice || 0).toFixed(2)}</div>
              </div>
              <div className="bg-slate-800/40 rounded-lg p-2 text-center">
                <div className="text-[10px] text-slate-500 uppercase">Shares</div>
                <div className="text-sm font-bold text-white">{replayTrade.shares || replayTrade.quantity || 1}</div>
              </div>
              <div className="bg-slate-800/40 rounded-lg p-2 text-center">
                <div className="text-[10px] text-slate-500 uppercase">P&L</div>
                {(() => {
                  const pnl = replayTrade.pnl || ((parseFloat(replayTrade.exitPrice || 0) - parseFloat(replayTrade.entryPrice || 0)) * parseInt(replayTrade.shares || replayTrade.quantity || 1));
                  return <div className={`text-sm font-bold ${pnl >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}</div>;
                })()}
              </div>
            </div>

            {/* Notes */}
            {replayTrade.notes && (
              <div className="bg-slate-800/30 rounded-lg p-3 border border-slate-700/20">
                <div className="text-[10px] text-slate-500 uppercase mb-1">Trade Notes</div>
                <div className="text-xs text-slate-300">{replayTrade.notes}</div>
              </div>
            )}

            {/* Share to Feed button */}
            <div className="flex gap-2 mt-4">
              <button onClick={() => {
                addToSocialFeed({
                  type: 'trade',
                  ticker: replayTrade.ticker || replayTrade.symbol,
                  text: `${replayTrade.direction || 'Long'} ${replayTrade.ticker || replayTrade.symbol}: Entry $${parseFloat(replayTrade.entryPrice || 0).toFixed(2)} → Exit $${parseFloat(replayTrade.exitPrice || 0).toFixed(2)}`,
                  verdict: (replayTrade.pnl || 0) >= 0 ? 'Win' : 'Loss'
                });
                setTradeReplayOpen(false);
              }} className="flex-1 px-4 py-2 bg-cyan-600/20 hover:bg-cyan-600/30 border border-cyan-500/30 rounded-xl text-sm text-cyan-400 font-medium transition-all flex items-center justify-center gap-2">
                <MessageCircle className="w-4 h-4" /> Share to Feed
              </button>
              <button onClick={() => { setTradeReplayOpen(false); setReplayPlaying(false); }}
                className="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700/50 rounded-xl text-sm text-slate-400 font-medium transition-all">
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* PWA INSTALL BANNER (Feature 7) — only when browser supports install */}
      {showInstallBanner && !isAppInstalled && deferredPrompt && (
        <div className="fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-80 z-[55] animate-slideUp">
          <div className="bg-gradient-to-r from-violet-900/95 to-slate-900/95 backdrop-blur-xl rounded-2xl border border-violet-500/30 p-4 shadow-2xl shadow-violet-500/10">
            <div className="flex items-start gap-3">
              <div className="p-2 bg-violet-500/20 rounded-xl">
                <Download className="w-5 h-5 text-violet-400" />
              </div>
              <div className="flex-1">
                <h4 className="text-sm font-bold text-white">Install MODUS</h4>
                <p className="text-[11px] text-slate-400 mt-0.5">Add to home screen for quick access and notifications</p>
                <div className="flex gap-2 mt-3">
                  <button onClick={handleInstallPWA} className="px-3 py-1.5 bg-violet-600 hover:bg-violet-500 text-white text-xs font-semibold rounded-lg transition-all">
                    Install
                  </button>
                  <button onClick={() => setShowInstallBanner(false)} className="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-400 text-xs rounded-lg transition-all">
                    Later
                  </button>
                </div>
              </div>
              <button onClick={() => setShowInstallBanner(false)} className="text-slate-500 hover:text-white transition-colors">
                <X className="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>
      )}

      {/* GUIDED SETUP WIZARD */}
      {showSetupWizard && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[65] flex items-center justify-center p-4">
          <div className="bg-slate-900 rounded-2xl border border-violet-500/30 p-6 max-w-lg w-full shadow-2xl relative">
            <button
              onClick={() => {
                localStorage.setItem('modus_setup_complete', 'true');
                setShowSetupWizard(false);
              }}
              className="absolute top-4 right-4 text-sm text-slate-500 hover:text-white transition-colors"
            >
              Skip ×
            </button>

            {/* Progress */}
            <div className="flex gap-1 mb-6">
              {[0, 1, 2].map(i => (
                <div key={i} className={`h-1 flex-1 rounded-full transition-all ${i <= setupStep ? 'bg-violet-500' : 'bg-slate-700'}`} />
              ))}
            </div>

            {/* Step 0: Welcome */}
            {setupStep === 0 && (
              <div className="text-center">
                <div className="w-16 h-16 bg-gradient-to-br from-violet-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <Zap className="w-8 h-8 text-white" />
                </div>
                <h3 className="text-xl font-bold mb-2">Welcome to MODUS</h3>
                <p className="text-sm text-slate-400 mb-6">Your all-in-one trading analysis platform. Let's get you set up in under a minute.</p>

                <div className="space-y-2 text-left mb-6">
                  {[
                    { icon: '🧠', text: 'AI-powered chart analysis with trade setups' },
                    { icon: '📊', text: 'Real-time data for 220+ stocks across 15 sectors' },
                    { icon: '🔔', text: 'Price alerts, watchlists, and a full trading journal' },
                    { icon: '📱', text: 'Custom dashboard you can personalize to your style' },
                  ].map((tip, i) => (
                    <div key={i} className="flex items-center gap-3 px-4 py-2.5 bg-slate-800/40 rounded-lg">
                      <span className="text-lg">{tip.icon}</span>
                      <span className="text-sm text-slate-300">{tip.text}</span>
                    </div>
                  ))}
                </div>

                <button
                  onClick={() => setSetupStep(1)}
                  className="w-full py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-xl font-semibold transition-all"
                >
                  Let's Go →
                </button>
              </div>
            )}

            {/* Step 1: Watchlist */}
            {setupStep === 1 && (
              <div className="text-center">
                <div className="w-16 h-16 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <Eye className="w-8 h-8 text-white" />
                </div>
                <h3 className="text-xl font-bold mb-2">Build Your Watchlist</h3>
                <p className="text-sm text-slate-400 mb-6">Add stocks you want to track. Prices update every 10 seconds.</p>

                <div className="text-left bg-slate-800/50 rounded-xl p-4 mb-4">
                  <p className="text-xs text-slate-500 mb-2">Quick add popular stocks:</p>
                  <div className="flex flex-wrap gap-2">
                    {['AAPL', 'TSLA', 'NVDA', 'MSFT', 'AMZN', 'META', 'GOOGL', 'SPY'].map(sym => (
                      <button
                        key={sym}
                        onClick={() => {
                          if (!watchlist.includes(sym)) {
                            setWatchlist(prev => [...prev, sym]);
                          }
                        }}
                        className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                          watchlist.includes(sym)
                            ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'
                            : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                        }`}
                      >
                        {watchlist.includes(sym) ? '✓ ' : '+ '}{sym}
                      </button>
                    ))}
                  </div>
                  {watchlist.length > 0 && (
                    <p className="text-xs text-emerald-400 mt-3">{watchlist.length} symbol{watchlist.length > 1 ? 's' : ''} in watchlist</p>
                  )}
                </div>

                <div className="flex gap-3">
                  <button onClick={() => setSetupStep(0)} className="px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-slate-400 text-sm transition-all">Back</button>
                  <button onClick={() => setSetupStep(2)} className="flex-1 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 rounded-xl font-semibold transition-all">
                    {watchlist.length > 0 ? 'Next →' : 'Skip →'}
                  </button>
                </div>
              </div>
            )}

            {/* Step 2: Done */}
            {setupStep === 2 && (
              <div className="text-center">
                <div className="w-16 h-16 bg-gradient-to-br from-emerald-500 to-green-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <Check className="w-8 h-8 text-white" />
                </div>
                <h3 className="text-xl font-bold mb-2">You're Ready!</h3>
                <p className="text-sm text-slate-400 mb-6">Here's a quick look at what you can do:</p>

                <div className="space-y-2 text-left mb-4">
                  {[
                    { icon: '📊', text: 'Upload a chart in Analysis to get AI-powered trade setups' },
                    { icon: '⭐', text: 'Check the Daily Pick for today\'s top stock recommendation' },
                    { icon: '🔔', text: 'Set price alerts so you never miss a move' },
                    { icon: '📓', text: 'Log trades in the Journal and track your performance' },
                  ].map((tip, i) => (
                    <div key={i} className="flex items-center gap-3 px-4 py-2.5 bg-slate-800/40 rounded-lg">
                      <span className="text-lg">{tip.icon}</span>
                      <span className="text-sm text-slate-300">{tip.text}</span>
                    </div>
                  ))}
                </div>

                <div className="bg-violet-500/10 border border-violet-500/20 rounded-xl px-4 py-3 mb-6">
                  <p className="text-sm text-slate-300">For a full breakdown of every feature, check out the <span className="text-violet-400 font-semibold">Info & Legal</span> tab in the sidebar.</p>
                </div>

                <div className="flex gap-3">
                  <button onClick={() => setSetupStep(1)} className="px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-slate-400 text-sm transition-all">Back</button>
                  <button
                    onClick={() => {
                      localStorage.setItem('modus_setup_complete', 'true');
                      setShowSetupWizard(false);
                      setActiveTab('dashboard');
                    }}
                    className="flex-1 py-3 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 rounded-xl font-semibold transition-all text-lg"
                  >
                    Get Started
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* KEYBOARD SHORTCUTS MODAL */}
      {showShortcuts && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4" onClick={() => setShowShortcuts(false)}>
          <div className="bg-slate-900 rounded-2xl border border-slate-700 p-6 max-w-md w-full shadow-2xl" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-5">
              <h3 className="text-lg font-bold flex items-center gap-2">
                <span className="text-slate-500 font-mono text-sm bg-slate-800 px-2 py-0.5 rounded">⌨</span>
                Keyboard Shortcuts
              </h3>
              <button onClick={() => setShowShortcuts(false)} className="p-1.5 hover:bg-slate-800 rounded-lg transition-colors">
                <X className="w-5 h-5 text-slate-400" />
              </button>
            </div>
            <div className="space-y-1">
              {[
                { keys: '1-9', desc: 'Switch tabs (Ticker, Analyze, Alerts...)' },
                { keys: isMac ? '⌘K' : 'Ctrl+K', desc: 'Quick search / Go to Ticker' },
                { keys: isMac ? '⌘E' : 'Ctrl+E', desc: 'Export analysis as PDF' },
                { keys: isMac ? '⌘⇧S' : 'Ctrl+Shift+S', desc: 'Share analysis' },
                { keys: isMac ? '⌘B' : 'Ctrl+B', desc: 'Toggle sidebar' },
                { keys: isMac ? '⌘,' : 'Ctrl+,', desc: 'Open settings' },
                { keys: '?', desc: 'Toggle this shortcuts panel' },
                { keys: 'Esc', desc: 'Close current modal or panel' },
                { keys: isMac ? '⌥N' : 'Alt+N', desc: 'Go to Trading Journal' },
                { keys: isMac ? '⌥A' : 'Alt+A', desc: 'Go to Watchlist' },
              ].map((shortcut, i) => (
                <div key={i} className="flex items-center justify-between py-2 px-3 rounded-lg hover:bg-slate-800/50">
                  <span className="text-sm text-slate-300">{shortcut.desc}</span>
                  <kbd className="font-mono text-xs bg-slate-800 border border-slate-700 text-slate-400 px-2 py-1 rounded">{shortcut.keys}</kbd>
                </div>
              ))}
            </div>
            <p className="text-[10px] text-slate-600 mt-4 text-center">{isMac ? '⌘ = Command, ⌥ = Option, ⇧ = Shift' : 'Shortcuts are disabled while typing in text fields'}</p>
          </div>
        </div>
      )}

      {/* LANDING PAGE */}
      {showLandingPage && (
        <div className="fixed inset-0 bg-gradient-to-br from-slate-950 via-slate-900 to-violet-950 z-[110] overflow-y-auto">
          {/* Animated background */}
          <div className="absolute inset-0 overflow-hidden">
            <div className="absolute -top-40 -right-40 w-80 h-80 bg-violet-500/20 rounded-full blur-3xl animate-pulse" />
            <div className="absolute -bottom-40 -left-40 w-80 h-80 bg-blue-500/20 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '1s' }} />
          </div>

          <div className="relative min-h-screen flex flex-col">
            {/* Header */}
            <header className="p-4 md:p-6 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center">
                  <Target className="w-6 h-6 text-white" />
                </div>
                <span className="text-xl font-bold">MODUS</span>
              </div>
              <button
                onClick={() => {
                  localStorage.setItem('modus_has_visited', 'true');
                  setShowLandingPage(false);
                  setShowDisclaimer(true);
                }}
                className="text-sm text-slate-400 hover:text-white transition-colors"
              >
                Skip to App →
              </button>
            </header>

            {/* Hero Section */}
            <main className="flex-1 flex flex-col items-center justify-center px-4 md:px-6 py-8 md:py-12 text-center">
              <div className="inline-flex items-center gap-2 px-4 py-2 bg-violet-500/10 border border-violet-500/30 rounded-full text-sm text-violet-300 mb-6">
                <Sparkles className="w-4 h-4" />
                AI-Powered Trading Analysis
              </div>

              <h1 className="text-3xl sm:text-4xl md:text-6xl font-bold max-w-4xl mb-6 leading-tight">
                Trade Smarter with
                <span className="bg-gradient-to-r from-violet-400 to-purple-400 bg-clip-text text-transparent"> AI-Powered </span>
                Chart Analysis
              </h1>

              <p className="text-sm sm:text-base md:text-lg lg:text-xl text-slate-400 max-w-2xl mb-6 md:mb-8">
                Upload any chart and get instant technical analysis, trade setups,
                entry/exit points, and AI-generated predictions. No guesswork.
              </p>

              {/* Email Capture */}
              {!emailSubmitted ? (
                <div className="w-full max-w-md mb-6 md:mb-8 px-2 sm:px-0">
                  <div className="flex flex-col sm:flex-row gap-2">
                    <input
                      type="email"
                      value={betaEmail}
                      onChange={(e) => setBetaEmail(e.target.value)}
                      placeholder="Enter your email for updates & tips"
                      className="flex-1 bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500/50"
                    />
                    <button
                      onClick={async () => {
                        if (betaEmail && betaEmail.includes('@')) {
                          // Store email locally
                          const emails = JSON.parse(localStorage.getItem('modus_beta_emails') || '[]');
                          emails.push({ email: betaEmail, date: new Date().toISOString() });
                          localStorage.setItem('modus_beta_emails', JSON.stringify(emails));
                          trackEvent('conversion', 'beta_signup', 'landing_page');

                          // Send notification via EmailJS
                          try {
                            await fetch('https://api.emailjs.com/api/v1.0/email/send', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                service_id: 'service_wka2oph',
                                template_id: 'template_1bn2e5y',
                                user_id: 'P3MjxM_aqWY9csXhF',
                                template_params: {
                                  to_email: 'steventox5138@gmail.com',
                                  subject: '🎉 New MODUS Beta Signup!',
                                  message: `New beta signup:\n\nEmail: ${betaEmail}\nDate: ${new Date().toLocaleString()}\nTotal signups: ${emails.length}`,
                                },
                              }),
                            });
                          } catch (e) {
                            console.log('Email notification skipped');
                          }

                          setEmailSubmitted(true);
                        }
                      }}
                      className="px-6 py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-xl font-semibold transition-all"
                    >
                      Get Updates
                    </button>
                  </div>
                  <p className="text-xs text-slate-500 mt-2">Get trading tips & feature updates. No spam, unsubscribe anytime.</p>
                </div>
              ) : (
                <div className="bg-green-500/10 border border-green-500/30 rounded-xl px-6 py-4 mb-8">
                  <p className="text-green-400 font-semibold flex items-center gap-2 justify-center">
                    <Check className="w-5 h-5" />
                    You're signed up! Now try the app below.
                  </p>
                </div>
              )}

              {/* CTA Button */}
              <button
                onClick={() => {
                  localStorage.setItem('modus_has_visited', 'true');
                  setShowLandingPage(false);
                  setShowDisclaimer(true);
                }}
                className="px-6 sm:px-8 py-3 sm:py-4 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-xl font-semibold text-base sm:text-lg shadow-lg shadow-violet-500/25 transition-all transform hover:scale-105"
              >
                Try MODUS Free →
              </button>

              {/* Feature Grid */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mt-12 md:mt-16 max-w-4xl w-full px-2 sm:px-0">
                <div className="bg-slate-800/30 border border-slate-700/50 rounded-xl p-4 md:p-6 text-left">
                  <div className="w-12 h-12 bg-violet-500/20 rounded-lg flex items-center justify-center mb-4">
                    <BarChart3 className="w-6 h-6 text-violet-400" />
                  </div>
                  <h3 className="font-semibold text-lg mb-2">AI Chart Analysis</h3>
                  <p className="text-sm text-slate-400">Upload any chart and get instant pattern recognition, support/resistance levels, and trend analysis.</p>
                </div>

                <div className="bg-slate-800/30 border border-slate-700/50 rounded-xl p-4 md:p-6 text-left">
                  <div className="w-12 h-12 bg-emerald-500/20 rounded-lg flex items-center justify-center mb-4">
                    <Target className="w-6 h-6 text-emerald-400" />
                  </div>
                  <h3 className="font-semibold text-lg mb-2">Trade Setups</h3>
                  <p className="text-sm text-slate-400">Get precise entry points, stop losses, and profit targets with calculated risk/reward ratios.</p>
                </div>

                <div className="bg-slate-800/30 border border-slate-700/50 rounded-xl p-4 md:p-6 text-left">
                  <div className="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center mb-4">
                    <Zap className="w-6 h-6 text-blue-400" />
                  </div>
                  <h3 className="font-semibold text-lg mb-2">Daily Picks</h3>
                  <p className="text-sm text-slate-400">Receive AI-curated stock picks every day based on technical indicators and market conditions.</p>
                </div>
              </div>

              {/* Social Proof */}
              <div className="mt-12 md:mt-16 text-center">
                <p className="text-slate-500 text-sm mb-4">Trusted by traders at</p>
                <div className="flex flex-wrap items-center justify-center gap-4 sm:gap-8 opacity-50">
                  <span className="text-xl font-bold text-slate-400">TD Ameritrade</span>
                  <span className="text-xl font-bold text-slate-400">Fidelity</span>
                  <span className="text-xl font-bold text-slate-400">E*TRADE</span>
                  <span className="text-xl font-bold text-slate-400">Robinhood</span>
                </div>
              </div>
            </main>

            {/* Footer */}
            <footer className="p-4 md:p-6 text-center text-xs sm:text-sm text-slate-500">
              <p>© 2026 MODUS. For educational purposes only. Not financial advice.</p>
            </footer>
          </div>
        </div>
      )}

      {/* FEEDBACK BUTTON - Fixed position (moved up to avoid watchlist overlap) */}
      {disclaimerAccepted && !showFeedback && (
        <button
          onClick={() => setShowFeedback(true)}
          className="fixed bottom-24 right-6 z-50 px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-full shadow-lg flex items-center gap-2 text-sm transition-all hover:scale-105"
        >
          <MessageCircle className="w-4 h-4 text-violet-400" />
          Feedback
        </button>
      )}

      {/* FEEDBACK MODAL */}
      {showFeedback && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
          <div className="bg-slate-900 rounded-2xl border border-slate-700 p-6 max-w-md w-full shadow-2xl">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-xl font-semibold flex items-center gap-2">
                <MessageCircle className="w-5 h-5 text-violet-400" />
                Send Feedback
              </h3>
              <button onClick={() => { setShowFeedback(false); setFeedbackSubmitted(false); setFeedbackText(""); }} className="text-slate-400 hover:text-white">
                <X className="w-5 h-5" />
              </button>
            </div>

            {!feedbackSubmitted ? (
              <>
                <div className="flex gap-2 mb-4">
                  {[
                    { type: 'bug', label: '🐛 Bug', color: 'red' },
                    { type: 'feature', label: '💡 Feature', color: 'blue' },
                    { type: 'feedback', label: '💬 General', color: 'violet' }
                  ].map(({ type, label, color }) => (
                    <button
                      key={type}
                      onClick={() => setFeedbackType(type)}
                      className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${
                        feedbackType === type
                          ? `bg-${color}-500/20 border-${color}-500/50 text-${color}-300 border`
                          : 'bg-slate-800 border border-slate-700 text-slate-400 hover:bg-slate-700'
                      }`}
                    >
                      {label}
                    </button>
                  ))}
                </div>

                <textarea
                  value={feedbackText}
                  onChange={(e) => setFeedbackText(e.target.value)}
                  placeholder={
                    feedbackType === 'bug' ? "Describe the bug and steps to reproduce..." :
                    feedbackType === 'feature' ? "Describe the feature you'd like to see..." :
                    "Share your thoughts..."
                  }
                  className="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 min-h-[120px] text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/50 resize-none mb-4"
                />

                <button
                  onClick={async () => {
                    if (feedbackText.length >= 10) {
                      // Save locally
                      const feedback = JSON.parse(localStorage.getItem('modus_feedback') || '[]');
                      feedback.push({ type: feedbackType, text: feedbackText, date: new Date().toISOString() });
                      localStorage.setItem('modus_feedback', JSON.stringify(feedback));
                      trackEvent('feedback', 'submit', feedbackType);

                      // Save feedback to Firestore (free, no email quota used)
                      try {
                        const { getFirestore, collection, addDoc } = await import('firebase/firestore');
                        const db = getFirestore();
                        await addDoc(collection(db, 'feedback'), {
                          type: feedbackType,
                          text: feedbackText,
                          userEmail: currentUser?.email || 'anonymous',
                          userId: currentUser?.uid || null,
                          userAgent: navigator.userAgent,
                          timestamp: new Date().toISOString(),
                          status: 'new'
                        });
                        console.log('[Feedback] ✅ Saved to Firestore');
                      } catch (e) {
                        console.log('[Feedback] Firestore save failed, kept in localStorage:', e.message);
                      }

                      // Also try Discord webhook (free, unlimited notifications)
                      try {
                        const discordWebhookUrl = localStorage.getItem('modus_discord_webhook');
                        if (discordWebhookUrl) {
                          await fetch(discordWebhookUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                              embeds: [{
                                title: `📬 MODUS Feedback: ${feedbackType.toUpperCase()}`,
                                description: feedbackText.substring(0, 2000),
                                color: feedbackType === 'bug' ? 0xFF0000 : feedbackType === 'feature' ? 0x3B82F6 : 0x8B5CF6,
                                footer: { text: `From: ${currentUser?.email || 'anonymous'} | ${new Date().toLocaleString()}` }
                              }]
                            })
                          });
                        }
                      } catch (e) {
                        // Discord webhook optional
                      }

                      setFeedbackSubmitted(true);
                    }
                  }}
                  disabled={feedbackText.length < 10}
                  className="w-full py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-xl font-semibold disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed transition-all"
                >
                  Submit Feedback
                </button>
              </>
            ) : (
              <div className="text-center py-8">
                <div className="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Check className="w-8 h-8 text-green-400" />
                </div>
                <h4 className="text-lg font-semibold mb-2">Thank You!</h4>
                <p className="text-slate-400 text-sm">Your feedback helps us improve MODUS.</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* ONBOARDING TUTORIAL */}
      {showOnboarding && disclaimerAccepted && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[65] flex items-center justify-center p-4">
          <div className="bg-slate-900 rounded-2xl border border-violet-500/30 p-6 max-w-lg w-full shadow-2xl relative">
            {(() => {
              const tourSteps = [
                {
                  icon: <Camera className="w-10 h-10 text-violet-400" />,
                  title: "Upload a Chart",
                  desc: "Go to Chart Analysis and upload a screenshot of any stock chart. We support all timeframes and indicators."
                },
                {
                  icon: <BarChart3 className="w-10 h-10 text-emerald-400" />,
                  title: "Get AI Analysis",
                  desc: "Our AI identifies patterns, support/resistance levels, and generates trade setups with entry, stop, and target prices."
                },
                {
                  icon: <MessageCircle className="w-10 h-10 text-cyan-400" />,
                  title: "Ask the AI",
                  desc: "Use the chat feature to ask follow-up questions about any analysis. Get clarification on patterns, strategies, or trade ideas."
                },
                {
                  icon: <Bell className="w-10 h-10 text-orange-400" />,
                  title: "Set Price Alerts",
                  desc: "Create custom alerts for price levels, and get SMS notifications when your targets are hit. Never miss an entry!"
                },
                {
                  icon: <Star className="w-10 h-10 text-yellow-400" />,
                  title: "Daily Picks",
                  desc: "Check the Daily Pick tab for AI-curated stock recommendations based on technical indicators and market momentum."
                },
                {
                  icon: <Target className="w-10 h-10 text-blue-400" />,
                  title: "Track Your Trades",
                  desc: "Use the Journal to log your trades and the Paper Trading feature to practice without risking real money."
                }
              ];
              const currentStep = tourSteps[onboardingStep];
              const totalSteps = tourSteps.length;

              return currentStep && (
                <>
                  {/* Skip Tour - Top Right */}
                  <button
                    onClick={() => {
                      localStorage.setItem('modus_onboarding_complete', 'true');
                      setShowOnboarding(false);
                    }}
                    className="absolute top-4 right-4 text-sm text-slate-500 hover:text-white transition-colors"
                  >
                    Skip Tour ×
                  </button>

                  <div className="text-center pt-4">
                    <div className="w-20 h-20 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-6">
                      {currentStep.icon}
                    </div>
                    <h3 className="text-2xl font-bold mb-3">{currentStep.title}</h3>
                    <p className="text-slate-400 mb-8">{currentStep.desc}</p>

                    {/* Progress dots */}
                    <div className="flex items-center justify-center gap-2 mb-6">
                      {tourSteps.map((_, i) => (
                        <div key={i} className={`w-2 h-2 rounded-full transition-all ${i === onboardingStep ? 'w-6 bg-violet-500' : 'bg-slate-700'}`} />
                      ))}
                    </div>

                    {/* Navigation: Left Arrow | Next/Get Started | Right Arrow */}
                    <div className="flex items-center justify-center gap-4">
                      {/* Left Arrow */}
                      <button
                        onClick={() => setOnboardingStep(Math.max(0, onboardingStep - 1))}
                        disabled={onboardingStep === 0}
                        className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${
                          onboardingStep === 0
                            ? 'bg-slate-800/50 text-slate-600 cursor-not-allowed'
                            : 'bg-slate-800 hover:bg-slate-700 text-white'
                        }`}
                      >
                        <ChevronLeft className="w-6 h-6" />
                      </button>

                      {/* Center Button */}
                      <button
                        onClick={() => {
                          if (onboardingStep < totalSteps - 1) {
                            setOnboardingStep(onboardingStep + 1);
                          } else {
                            localStorage.setItem('modus_onboarding_complete', 'true');
                            setShowOnboarding(false);
                            // Check if setup wizard needed
                            const setupDone = localStorage.getItem('modus_setup_complete');
                            if (setupDone !== 'true') setShowSetupWizard(true);
                          }
                        }}
                        className="px-8 py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-xl font-semibold transition-all"
                      >
                        {onboardingStep < totalSteps - 1 ? "Next" : "Get Started"}
                      </button>

                      {/* Right Arrow */}
                      <button
                        onClick={() => setOnboardingStep(Math.min(totalSteps - 1, onboardingStep + 1))}
                        disabled={onboardingStep === totalSteps - 1}
                        className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${
                          onboardingStep === totalSteps - 1
                            ? 'bg-slate-800/50 text-slate-600 cursor-not-allowed'
                            : 'bg-slate-800 hover:bg-slate-700 text-white'
                        }`}
                      >
                        <ChevronRight className="w-6 h-6" />
                      </button>
                    </div>
                  </div>
                </>
              );
            })()}
          </div>
        </div>
      )}

      {/* DISCLAIMER AGREEMENT MODAL */}
      {showDisclaimer && !disclaimerAccepted && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
          <div className="bg-slate-900 rounded-2xl border-2 border-yellow-500 p-6 max-w-3xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex items-center gap-3 mb-4">
              <div className="p-3 bg-yellow-500/20 rounded-lg">
                <AlertTriangle className="w-8 h-8 text-yellow-400" />
              </div>
              <div>
                <h2 className="text-2xl font-bold">Important Legal Disclaimer</h2>
                <p className="text-sm text-slate-400">Please read carefully before using MODUS</p>
              </div>
            </div>
            
            <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-6">
              <p className="text-yellow-200 font-semibold mb-2 text-center">⚠️ PLEASE READ CAREFULLY ⚠️</p>
              <p className="text-sm text-yellow-300 text-center">
                By clicking "I Accept and Agree", you acknowledge that you have read, understood, and agree to all terms below.
              </p>
            </div>
            
            <div className="space-y-4 text-sm text-slate-300 mb-6">
              <div className="bg-slate-800/50 rounded-lg p-4">
                <h3 className="font-semibold text-white mb-2 flex items-center gap-2">
                  <span className="text-red-400">1.</span> Not Financial Advice
                </h3>
                <p>
                  MODUS is an educational tool and AI-powered analysis platform. 
                  <strong className="text-red-400"> It does NOT provide financial, investment, or trading advice.</strong> 
                  All analysis, recommendations, and predictions are for informational and educational purposes only.
                </p>
              </div>
              
              <div className="bg-slate-800/50 rounded-lg p-4">
                <h3 className="font-semibold text-white mb-2 flex items-center gap-2">
                  <span className="text-red-400">2.</span> No Guarantee of Accuracy
                </h3>
                <p>
                  While we strive for accuracy, <strong className="text-red-400">AI-generated analysis may contain errors, 
                  omissions, or outdated information.</strong> Always verify information independently and conduct your own 
                  research before making any trading decisions.
                </p>
              </div>
              
              <div className="bg-slate-800/50 rounded-lg p-4">
                <h3 className="font-semibold text-white mb-2 flex items-center gap-2">
                  <span className="text-red-400">3.</span> Substantial Risk of Loss
                </h3>
                <p>
                  <strong className="text-red-400">Trading stocks, options, and other financial instruments carries 
                  significant risk of financial loss.</strong> You can lose some or all of your invested capital. Options 
                  trading carries particularly high risk. Never invest more than you can afford to lose.
                </p>
              </div>
              
              <div className="bg-slate-800/50 rounded-lg p-4">
                <h3 className="font-semibold text-white mb-2 flex items-center gap-2">
                  <span className="text-red-400">4.</span> No Liability for Losses
                </h3>
                <p>
                  MODUS, its creators, operators, and affiliates <strong className="text-red-400">SHALL NOT BE LIABLE 
                  for any financial losses, damages, or consequences</strong> resulting from the use of this platform or 
                  reliance on its analysis. You alone are responsible for your trading decisions and their outcomes.
                </p>
              </div>
              
              <div className="bg-slate-800/50 rounded-lg p-4">
                <h3 className="font-semibold text-white mb-2 flex items-center gap-2">
                  <span className="text-red-400">5.</span> Past Performance Not Indicative
                </h3>
                <p>
                  Past performance does not guarantee future results. Historical data, backtesting results, and previous 
                  analysis outcomes are not indicative of future performance. Market conditions change constantly.
                </p>
              </div>
              
              <div className="bg-slate-800/50 rounded-lg p-4">
                <h3 className="font-semibold text-white mb-2 flex items-center gap-2">
                  <span className="text-red-400">6.</span> Consult Licensed Professionals
                </h3>
                <p>
                  Before making any financial decisions, <strong>consult with a licensed financial advisor, certified public 
                  accountant, attorney, or other qualified professional.</strong> MODUS does not replace professional 
                  financial advice.
                </p>
              </div>
              
              <div className="bg-slate-800/50 rounded-lg p-4">
                <h3 className="font-semibold text-white mb-2 flex items-center gap-2">
                  <span className="text-red-400">7.</span> For Educational Purposes Only
                </h3>
                <p>
                  This platform is designed for educational purposes and to assist users in their own independent research. 
                  It should not be the sole basis for any investment decision.
                </p>
              </div>
              
              <div className="bg-slate-800/50 rounded-lg p-4">
                <h3 className="font-semibold text-white mb-2 flex items-center gap-2">
                  <span className="text-red-400">8.</span> User Responsibility
                </h3>
                <p>
                  You are solely responsible for evaluating the accuracy, completeness, and usefulness of all information 
                  provided. You assume all risks associated with your trading activities.
                </p>
              </div>
            </div>
            
            <div className="bg-red-500/10 border-2 border-red-500/50 rounded-lg p-5 mb-6">
              <p className="text-red-200 font-bold text-center text-lg mb-2">
                BY CLICKING "I ACCEPT AND AGREE" BELOW:
              </p>
              <ul className="text-red-200 text-sm space-y-1 list-disc list-inside">
                <li>You acknowledge reading and understanding all terms above</li>
                <li>You agree to assume all risks associated with trading</li>
                <li>You waive any claims against MODUS for financial losses</li>
                <li>You confirm you are of legal age to trade in your jurisdiction</li>
                <li>You will not hold MODUS liable for any outcomes of your trading decisions</li>
              </ul>
            </div>
            
            <div className="flex gap-3">
              <button
                onClick={() => {
                  setDisclaimerAccepted(true);
                  setShowDisclaimer(false);
                  localStorage.setItem('modus_disclaimer_accepted', 'true');
                  localStorage.setItem('modus_disclaimer_date', new Date().toISOString());
                  // Show onboarding tour immediately if not completed
                  const onboardingComplete = localStorage.getItem('modus_onboarding_complete');
                  if (onboardingComplete !== 'true') {
                    setOnboardingStep(0);
                    setShowOnboarding(true);
                  }
                }}
                className="flex-1 bg-violet-600 hover:bg-violet-500 text-white rounded-lg py-4 font-bold text-lg transition-colors shadow-lg"
              >
                ✓ I Accept and Agree - Enter Platform
              </button>
              <button
                onClick={() => {
                  if (window.confirm("Are you sure you want to decline? You will not be able to use MODUS.")) {
                    window.location.href = 'about:blank';
                  }
                }}
                className="px-6 bg-red-600 hover:bg-red-500 text-white rounded-lg py-4 font-semibold transition-colors"
              >
                Decline
              </button>
            </div>
            
            <p className="text-xs text-slate-500 mt-4 text-center">
              Last updated: January 2026 • MODUS v4.0
            </p>
          </div>
        </div>
      )}

      {/* Mobile Menu Overlay */}
      {isMobile && mobileMenuOpen && (
        <div
          className="fixed inset-0 bg-black/60 z-sidebar md:hidden backdrop-blur-sm"
          onClick={() => setMobileMenuOpen(false)}
        />
      )}

      {/* Vertical Sidebar */}
      <aside className={`fixed left-0 top-0 h-screen border-r border-slate-800/30 transition-all duration-300 ease-out z-modal-overlay overflow-hidden ${
        isMobile
          ? (mobileMenuOpen ? 'w-64 translate-x-0 shadow-2xl' : 'w-64 -translate-x-full')
          : (sidebarCollapsed ? 'w-16' : 'w-64')
      }`} style={{ background: 'linear-gradient(180deg, rgba(15,23,42,0.98) 0%, rgba(10,15,30,0.99) 100%)', backdropFilter: 'blur(20px)' }}>
        <div className="flex flex-col h-full">
          {/* Logo */}
          <div className="p-4 border-b border-slate-800/20">
            <div className="flex items-center gap-3">
              <div className="p-2.5 bg-gradient-to-br from-violet-500 via-purple-600 to-indigo-700 rounded-xl flex-shrink-0 shadow-lg shadow-violet-500/30 hover:shadow-violet-500/50 transition-all duration-300 hover:scale-105 relative overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-tr from-white/0 to-white/10 rounded-xl" />
                <svg className="w-5 h-5 relative" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                </svg>
              </div>
              {!sidebarCollapsed && (
                <div className="overflow-hidden">
                  <h2 className="text-lg font-bold tracking-tight whitespace-nowrap gradient-text">MODUS</h2>
                  <p className="text-[10px] text-slate-500 font-semibold whitespace-nowrap tracking-[0.2em] uppercase">Trading Platform</p>
                </div>
              )}
            </div>
          </div>

          {/* Navigation */}
          <nav className="flex-1 overflow-y-auto py-4 px-2">
            {/* Dashboard Button */}
            <button
              onClick={() => setActiveTab("dashboard")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-3 transition-all duration-200 ${
                activeTab === "dashboard"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Dashboard" : ""}
            >
              <PieChart className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Dashboard</span>}
            </button>

            {/* TRADING Section */}
            {!sidebarCollapsed && (
              <div className="px-2 mb-3">
                <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Trading</h3>
              </div>
            )}
            
            <button
              onClick={() => setActiveTab("ticker")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "ticker"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Live Ticker" : ""}
            >
              <LineChart className={`w-5 h-5 flex-shrink-0 ${activeTab === "ticker" ? "text-white" : ""}`} />
              {!sidebarCollapsed && <span className="font-medium text-sm">Live Ticker</span>}
            </button>

            <button
              onClick={() => setActiveTab("marketoverview")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 relative ${
                activeTab === "marketoverview"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Market Overview" : ""}
            >
              <Activity className={`w-5 h-5 flex-shrink-0 ${activeTab === "marketoverview" ? "text-white" : ""}`} />
              {!sidebarCollapsed && (
                <>
                  <span className="font-medium text-sm">Market Overview</span>
                  <span className={`ml-auto text-[10px] font-bold rounded-full px-2 py-0.5 ${
                    marketData.marketStatus === 'open' ? 'bg-green-500 text-white' :
                    marketData.marketStatus === 'pre-market' ? 'bg-blue-500 text-white' :
                    marketData.marketStatus === 'after-hours' ? 'bg-amber-500 text-white' :
                    'bg-slate-600 text-slate-300'
                  }`}>
                    {marketData.marketStatus === 'open' ? 'LIVE' :
                     marketData.marketStatus === 'pre-market' ? 'PRE' :
                     marketData.marketStatus === 'after-hours' ? 'AH' : '—'}
                  </span>
                </>
              )}
            </button>

            <button
              onClick={() => setActiveTab("analyze")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "analyze"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Chart Analysis" : ""}
            >
              <BarChart3 className={`w-5 h-5 flex-shrink-0 ${activeTab === "analyze" ? "text-white" : ""}`} />
              {!sidebarCollapsed && <span className="font-medium text-sm">Chart Analysis</span>}
            </button>

            <button
              onClick={() => setActiveTab("quickanalysis")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "quickanalysis"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Quick Analysis" : ""}
            >
              <Zap className={`w-5 h-5 flex-shrink-0 ${activeTab === "quickanalysis" ? "text-white" : ""}`} />
              {!sidebarCollapsed && <span className="font-medium text-sm">Quick Analysis</span>}
            </button>

            <button
              onClick={() => setActiveTab("alerts")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 relative ${
                activeTab === "alerts"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Price Alerts" : ""}
            >
              <Bell className={`w-5 h-5 flex-shrink-0 ${activeTab === "alerts" ? "text-white" : ""}`} />
              {!sidebarCollapsed && (
                <>
                  <span className="font-medium text-sm">Alerts</span>
                  {enabledAlertCount > 0 && (
                    <span className="ml-auto bg-emerald-500 text-white text-[10px] font-bold rounded-full px-2 py-0.5 shadow-sm">
                      {enabledAlertCount}
                    </span>
                  )}
                </>
              )}
              {sidebarCollapsed && enabledAlertCount > 0 && (
                <span className="absolute top-1 right-1 bg-emerald-500 text-white text-[10px] font-bold rounded-full w-4 h-4 flex items-center justify-center shadow-sm">
                  {enabledAlertCount}
                </span>
              )}
            </button>

            <button
              onClick={() => setActiveTab("multiframe")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "multiframe"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Multi-Timeframe" : ""}
            >
              <Layers className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Multi-Timeframe</span>}
            </button>

            <button
              onClick={() => setActiveTab("options")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "options"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Options Trading" : ""}
            >
              <TrendingUp className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Options Trading</span>}
            </button>

            {/* TOOLS Section */}
            {!sidebarCollapsed && (
              <div className="px-2 mt-4 mb-3">
                <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Tools</h3>
              </div>
            )}

            <button
              onClick={() => setActiveTab("daily")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "daily"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Daily Pick" : ""}
            >
              <Star className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Daily Pick</span>}
            </button>

            <button
              onClick={() => setActiveTab("ask")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "ask"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Ask AI" : ""}
            >
              <MessageCircle className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Ask AI</span>}
            </button>

            {/* MANAGEMENT Section */}
            {!sidebarCollapsed && (
              <div className="px-2 mt-4 mb-3">
                <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Management</h3>
              </div>
            )}

            <button
              onClick={() => setActiveTab("journal")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 relative ${
                activeTab === "journal"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Trading Journal" : ""}
            >
              <Target className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && (
                <>
                  <span className="font-medium">Journal</span>
                  {trades.length > 0 && (
                    <span className="ml-auto bg-blue-600 text-white text-xs rounded-full px-2 py-0.5">
                      {trades.length}
                    </span>
                  )}
                </>
              )}
              {sidebarCollapsed && trades.length > 0 && (
                <span className="absolute top-2 right-2 bg-blue-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">
                  {trades.length}
                </span>
              )}
            </button>

            <button
              onClick={() => setActiveTab("backtest")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "backtest"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Backtesting" : ""}
            >
              <ArrowUpDown className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Backtest</span>}
            </button>

            <button
              onClick={() => setActiveTab("portfolio")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 relative ${
                activeTab === "portfolio"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Portfolio Tracker" : ""}
            >
              <DollarSign className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && (
                <>
                  <span className="font-medium">Portfolio</span>
                  {portfolio.length > 0 && (
                    <span className="ml-auto bg-green-600 text-white text-xs rounded-full px-2 py-0.5">
                      {portfolio.length}
                    </span>
                  )}
                </>
              )}
              {sidebarCollapsed && portfolio.length > 0 && (
                <span className="absolute top-2 right-2 bg-green-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">
                  {portfolio.length}
                </span>
              )}
            </button>
            
            <button
              onClick={() => setActiveTab("performance")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "performance"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Performance Dashboard" : ""}
            >
              <PieChart className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Performance</span>}
            </button>
            
            <button
              onClick={() => setActiveTab("papertrading")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 relative ${
                activeTab === "papertrading"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Paper Trading" : ""}
            >
              <Wallet className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && (
                <>
                  <span className="font-medium">Paper Trading</span>
                  <span className="ml-auto bg-blue-600 text-white text-xs rounded-full px-2 py-0.5">
                    ${((paperTradingAccount.balance || 0) / 1000).toFixed(1)}k
                  </span>
                </>
              )}
            </button>
            
            <button
              onClick={() => setActiveTab("economic")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "economic"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Economic Calendar" : ""}
            >
              <CalendarDays className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Economic Calendar</span>}
            </button>
            
            <button
              onClick={() => setActiveTab("tradeideas")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "tradeideas"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Trade Ideas" : ""}
            >
              <Sparkles className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Trade Ideas</span>}
            </button>
            
            <button
              onClick={() => setActiveTab("screener")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "screener"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Stock Screener" : ""}
            >
              <Search className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Stock Screener</span>}
            </button>

            {/* MONITORING Section */}
            {!sidebarCollapsed && (
              <div className="px-2 mt-4 mb-3">
                <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Monitoring</h3>
              </div>
            )}
            
            <button
              onClick={() => setActiveTab("watchlist")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "watchlist"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Watchlist" : ""}
            >
              <Eye className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Watchlist</span>}
            </button>
            
            <button
              onClick={() => setActiveTab("hotstocks")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "hotstocks"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Market Scanner" : ""}
            >
              <Flame className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Market Scanner</span>}
            </button>
            
            <button
              onClick={() => setActiveTab("news")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "news"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "News & Sentiment" : ""}
            >
              <MessageCircle className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">News & Sentiment</span>}
            </button>

            {/* PORTFOLIO & ANALYTICS Section */}
            {!sidebarCollapsed && (
              <div className="px-2 mt-4 mb-3">
                <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Portfolio & Analytics</h3>
              </div>
            )}

            <button
              onClick={() => setActiveTab("trademetrics")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "trademetrics"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Trade Planner" : ""}
            >
              <Target className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Trade Planner</span>}
            </button>
            
            <button
              onClick={() => setActiveTab("alertperformance")}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "alertperformance"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Alert Performance" : ""}
            >
              <ArrowUpDown className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Alert Performance</span>}
            </button>

            {/* INFO Section */}
            {!sidebarCollapsed && (
              <div className="px-2 mt-4 mb-3">
                <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Info</h3>
              </div>
            )}

            <button
              onClick={() => { setActiveTab("info"); setInfoSubTab('features'); }}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all duration-200 ${
                activeTab === "info"
                  ? "bg-gradient-to-r from-violet-600 to-violet-700 text-white shadow-lg shadow-violet-500/25"
                  : "text-slate-400 hover:bg-slate-800/70 hover:text-white"
              }`}
              title={sidebarCollapsed ? "Info & Legal" : ""}
            >
              <Info className="w-5 h-5 flex-shrink-0" />
              {!sidebarCollapsed && <span className="font-medium">Info & Legal</span>}
            </button>
          </nav>

          {/* Collapse Toggle */}
          <div className="border-t border-slate-800 p-4">
            <button
              onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
              className="w-full flex items-center justify-center gap-2 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-all"
              title={sidebarCollapsed ? "Expand sidebar" : "Collapse sidebar"}
            >
              {sidebarCollapsed ? (
                <ArrowRight className="w-5 h-5" />
              ) : (
                <>
                  <ArrowLeft className="w-5 h-5" />
                  <span className="text-sm font-medium">Collapse</span>
                </>
              )}
            </button>
          </div>
        </div>
      </aside>
      {/* Header */}
      <header className={`border-b border-slate-800/20 sticky top-0 z-header transition-all duration-300 ease-out safe-area-top ${
        isMobile ? 'ml-0' : (sidebarCollapsed ? 'ml-16' : 'ml-64')
      }`} style={{ background: 'rgba(10, 15, 30, 0.85)', backdropFilter: 'blur(20px)', WebkitBackdropFilter: 'blur(20px)' }}>
        <div className="px-3 md:px-6 py-2 md:py-2.5">
          <div className="flex items-center justify-between gap-2">
            {/* LEFT: Mobile menu + logo */}
            <div className="flex items-center gap-2">
              {isMobile && (
                <button
                  onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                  className="p-2 rounded-lg bg-slate-800/60 border border-slate-700/40 text-slate-400 hover:text-white transition-all"
                >
                  <Menu className="w-5 h-5" />
                </button>
              )}
              {isMobile && (
                <div className="flex items-center gap-2">
                  <div className="p-1.5 bg-gradient-to-br from-violet-500 to-purple-700 rounded-lg">
                    <Eye className="w-4 h-4 text-white" />
                  </div>
                  <span className="font-bold text-white text-sm">MODUS</span>
                </div>
              )}
            </div>

            {/* RIGHT: All actions grouped together */}
            <div className="flex items-center gap-1.5 ml-auto">
              {/* Primary action: Position Sizer */}
              <button
                onClick={() => setShowPositionSizer(true)}
                className="hidden sm:flex items-center gap-1.5 px-3 py-1.5 bg-violet-600/90 hover:bg-violet-500 rounded-lg transition-all text-xs font-semibold"
                title="Position Sizing Calculator"
              >
                <Target className="w-3.5 h-3.5" />
                <span className="hidden lg:inline">Position Sizer</span>
              </button>

              {/* Divider */}
              <div className="hidden sm:block w-px h-5 bg-slate-700/50 mx-0.5" />

              {/* Icon buttons group - all same size */}
              {analysis && (
                <button
                  onClick={exportToPDF}
                  className="p-2 bg-slate-800/50 hover:bg-slate-700/70 rounded-lg transition-all border border-slate-700/30 hover:border-slate-600/50"
                  title="Export to PDF"
                >
                  <Download className="w-4 h-4 text-slate-400" />
                </button>
              )}

              {analysis && (
                <button
                  onClick={() => shareAnalysis('native')}
                  className="p-2 bg-slate-800/50 hover:bg-slate-700/70 rounded-lg transition-all border border-slate-700/30 hover:border-slate-600/50 relative"
                  title="Share Analysis"
                >
                  <ArrowUpRight className="w-4 h-4 text-slate-400" />
                  {copySuccess && (
                    <span className="absolute -top-7 left-1/2 -translate-x-1/2 bg-emerald-600 text-white text-[10px] px-2 py-0.5 rounded whitespace-nowrap shadow-lg">Copied!</span>
                  )}
                </button>
              )}

              <button
                onClick={() => setShowHistory(true)}
                className="p-2 bg-slate-800/50 hover:bg-slate-700/70 rounded-lg transition-all border border-slate-700/30 hover:border-slate-600/50 relative"
                title="Analysis History"
              >
                <Calendar className="w-4 h-4 text-slate-400" />
                {analysisHistory.length > 0 && (
                  <span className="absolute -top-1 -right-1 bg-violet-500 text-white text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center">
                    {analysisHistory.length > 9 ? '9+' : analysisHistory.length}
                  </span>
                )}
              </button>

              <button
                onClick={() => { setShowNotificationCenter(!showNotificationCenter); if (!showNotificationCenter) markAllNotificationsRead(); }}
                className="p-2 bg-slate-800/50 hover:bg-slate-700/70 rounded-lg transition-all border border-slate-700/30 hover:border-slate-600/50 relative"
                title="Notifications"
              >
                <Bell className="w-4 h-4 text-slate-400" />
                {unreadNotifications > 0 && (
                  <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center animate-pulse">
                    {unreadNotifications > 9 ? '9+' : unreadNotifications}
                  </span>
                )}
              </button>

              {/* Changelog / Updates */}
              <div className="relative">
                <button
                  onClick={() => { setShowChangelog(!showChangelog); if (!showChangelog) markChangelogRead(); }}
                  className="p-2 bg-slate-800/50 hover:bg-slate-700/70 rounded-lg transition-all border border-slate-700/30 hover:border-slate-600/50 relative"
                  title="Updates & Changelog"
                >
                  <Sparkles className="w-4 h-4 text-slate-400" />
                  {unreadChangelog > 0 && (
                    <span className="absolute -top-1 -right-1 bg-violet-500 text-white text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center animate-pulse">
                      {unreadChangelog}
                    </span>
                  )}
                </button>

                {/* Changelog rendered as a centered modal below */}
              </div>

              <button
                onClick={() => setShowApiKeyModal(true)}
                className="p-2 bg-slate-800/50 hover:bg-slate-700/70 rounded-lg transition-all border border-slate-700/30 hover:border-slate-600/50"
                title="Settings"
              >
                <Settings className="w-4 h-4 text-slate-400" />
              </button>

              {/* Divider */}
              <div className="w-px h-5 bg-slate-700/50 mx-0.5" />

              {/* Status + Clock combined */}
              <div className="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-slate-800/40 rounded-lg border border-slate-700/30">
                {(loadingAnalysis || loadingPick || loadingAnswer || loadingTicker) ? (
                  <>
                    <Loader2 className="w-3 h-3 animate-spin text-amber-400" />
                    <span className="text-xs text-amber-400">
                      {loadingAnalysis ? 'Analyzing...' :
                       loadingPick ? 'Finding pick...' :
                       loadingAnswer ? 'AI thinking...' :
                       'Loading...'}
                    </span>
                  </>
                ) : (
                  <>
                    <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse" />
                    <span className="font-mono text-xs text-emerald-400/80 tabular-nums">{formatTime(currentTime)}</span>
                    <span className="text-slate-700">·</span>
                    <span className="text-xs text-slate-400">
                      {enabledAlertCount > 0
                        ? `${enabledAlertCount} alert${enabledAlertCount > 1 ? 's' : ''}`
                        : 'Ready'}
                    </span>
                    {currentUser && cloudSyncStatus === 'synced' && (
                      <Cloud className="w-3 h-3 text-emerald-500/50" />
                    )}
                    {currentUser && cloudSyncStatus === 'syncing' && (
                      <Loader2 className="w-3 h-3 animate-spin text-amber-400/50" />
                    )}
                  </>
                )}
              </div>

              {/* Divider */}
              <div className="w-px h-5 bg-slate-700/50 mx-0.5" />

              {/* Auth button */}
              {currentUser ? (
                <div className="relative">
                  <button
                    onClick={() => setShowUserMenu(!showUserMenu)}
                    className="flex items-center gap-2 px-2.5 py-1.5 bg-slate-800/50 hover:bg-slate-700/70 rounded-lg transition-all border border-slate-700/30 hover:border-violet-500/30"
                  >
                    <div className="w-6 h-6 rounded-full bg-gradient-to-br from-violet-400 to-purple-500 flex items-center justify-center text-[10px] font-bold text-white">
                      {userProfile?.displayName?.[0]?.toUpperCase() || currentUser.email?.[0]?.toUpperCase() || 'U'}
                    </div>
                    <span className="hidden lg:inline text-xs font-medium text-slate-300 max-w-[80px] truncate">
                      {userProfile?.displayName || currentUser.email?.split('@')[0]}
                    </span>
                  </button>

                  {showUserMenu && (
                    <>
                      <div className="fixed inset-0 z-[54]" onClick={() => setShowUserMenu(false)} />
                      <div className="absolute right-0 top-full mt-2 w-64 bg-slate-900 border border-slate-700/50 rounded-xl shadow-2xl shadow-black/60 z-[55] overflow-hidden" style={{ animation: 'fadeIn 0.15s ease-out' }}>
                        <div className="p-4 border-b border-slate-800 bg-gradient-to-r from-violet-500/5 to-purple-500/5">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-violet-400 to-purple-600 flex items-center justify-center text-sm font-bold text-white shadow-lg">
                              {userProfile?.displayName?.[0]?.toUpperCase() || currentUser.email?.[0]?.toUpperCase() || 'U'}
                            </div>
                            <div className="min-w-0">
                              <p className="font-semibold text-sm">{userProfile?.displayName || 'User'}</p>
                              <p className="text-xs text-slate-500 truncate">{currentUser.email}</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-2 mt-3 px-1">
                            <span className="text-[9px] bg-slate-700/60 text-slate-400 px-1.5 py-0.5 rounded-full font-bold uppercase tracking-wider">Free Plan</span>
                            <div className={`w-1.5 h-1.5 rounded-full ${cloudSyncStatus === 'synced' ? 'bg-emerald-400' : cloudSyncStatus === 'syncing' ? 'bg-amber-400 animate-pulse' : 'bg-slate-500'}`} />
                            <span className="text-[10px] text-slate-500">
                              {cloudSyncStatus === 'synced' ? `Synced${lastSyncTime ? ` at ${lastSyncTime.toLocaleTimeString()}` : ''}` :
                               cloudSyncStatus === 'syncing' ? 'Syncing...' : 'Offline'}
                            </span>
                          </div>
                        </div>
                        <div className="p-1.5">
                          <button
                            onClick={() => { setShowUserMenu(false); setShowApiKeyModal(true); }}
                            className="w-full flex items-center gap-2.5 px-3 py-2 text-sm text-slate-300 hover:bg-slate-800/70 rounded-lg transition-colors"
                          >
                            <Settings className="w-4 h-4 text-slate-400" />
                            Settings & API Keys
                          </button>
                          <button
                            onClick={() => { setShowUserMenu(false); setActiveTab('info'); }}
                            className="w-full flex items-center gap-2.5 px-3 py-2 text-sm text-slate-300 hover:bg-slate-800/70 rounded-lg transition-colors"
                          >
                            <HelpCircle className="w-4 h-4 text-slate-400" />
                            Help & Info
                          </button>
                          <button
                            onClick={() => { setShowUserMenu(false); setShowChangelog(true); markChangelogRead(); }}
                            className="w-full flex items-center gap-2.5 px-3 py-2 text-sm text-slate-300 hover:bg-slate-800/70 rounded-lg transition-colors"
                          >
                            <Sparkles className="w-4 h-4 text-slate-400" />
                            What's New
                            {unreadChangelog > 0 && <span className="ml-auto text-[9px] bg-violet-500/30 text-violet-300 px-1.5 py-0.5 rounded-full font-bold">{unreadChangelog}</span>}
                          </button>
                          <div className="my-1 border-t border-slate-800/50" />
                          <button
                            onClick={handleLogout}
                            className="w-full flex items-center gap-2.5 px-3 py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-lg transition-colors"
                          >
                            <LogOut className="w-4 h-4" />
                            Sign Out
                          </button>
                        </div>
                      </div>
                    </>
                  )}
                </div>
              ) : (
                <button
                  onClick={() => { setShowAuthModal(true); setAuthMode('login'); }}
                  className="flex items-center gap-1.5 px-3 py-1.5 bg-violet-600/90 hover:bg-violet-500 rounded-lg transition-all text-xs font-semibold"
                >
                  <LogIn className="w-3.5 h-3.5" />
                  <span>Sign In</span>
                </button>
              )}
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className={`min-h-screen overflow-y-auto transition-all duration-300 ease-out px-3 sm:px-4 md:px-6 lg:px-8 py-3 md:py-6 pb-8 safe-area-bottom ${
        isMobile ? 'ml-0 pb-20' : (sidebarCollapsed ? 'ml-16' : 'ml-64')
      }`}>
        {/* Welcome Banner */}
        {showWelcomeBanner && !currentUser && (
          <div className="mb-4 bg-gradient-to-r from-violet-600/20 to-purple-600/20 border border-violet-500/30 rounded-lg p-3 md:p-4 flex items-center justify-between gap-4 animate-slideDown">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-violet-500/30 rounded-lg">
                <Sparkles className="w-5 h-5 text-violet-300" />
              </div>
              <div className="flex-1">
                <p className="text-sm md:text-base font-semibold text-violet-200">Welcome to MODUS</p>
                <p className="text-xs md:text-sm text-slate-300">AI-powered trading tools for smarter market analysis</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => {
                  // Redirect to sign in or show sign in
                  navigate('/login');
                }}
                className="px-4 py-2 bg-violet-600 hover:bg-violet-500 text-white rounded-lg font-semibold text-sm transition-all"
              >
                Sign In
              </button>
              <button
                onClick={() => setShowWelcomeBanner(false)}
                className="p-2 hover:bg-slate-700/30 rounded-lg transition-all"
              >
                <X className="w-4 h-4 text-slate-400" />
              </button>
            </div>
          </div>
        )}

        {/* Dashboard Tab */}
        {activeTab === "dashboard" && (
          <div className="p-4 md:p-8 animate-fadeIn">
            {/* Dashboard Header */}
            <div className="flex items-center justify-between mb-5">
              <div>
                <h1 className="text-2xl md:text-3xl font-bold">
                  {(() => { const h = new Date().getHours(); return h < 12 ? 'Good Morning' : h < 17 ? 'Good Afternoon' : 'Good Evening'; })()}
                  {currentUser?.displayName ? `, ${currentUser.displayName.split(' ')[0]}` : ''}
                </h1>
                <p className="text-slate-400 text-sm mt-1">Your personalized trading overview</p>
              </div>
              <div className="flex items-center gap-2">
                {(() => {
                  const ms = getDashboardMarketStatus();
                  return (
                    <div className={`hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium ${ms.bg} border border-slate-700/20`}>
                      <span className={`w-2 h-2 rounded-full ${ms.status === 'open' ? 'bg-emerald-400 animate-pulse' : ms.status === 'pre' ? 'bg-amber-400 animate-pulse' : ms.status === 'after' ? 'bg-blue-400' : 'bg-red-400'}`} />
                      <span className={ms.color}>{ms.label}</span>
                    </div>
                  );
                })()}
                {/* Theme Toggle (Feature 8) */}
                <div className="flex items-center bg-slate-800/50 rounded-lg border border-slate-700/30 p-0.5">
                  {[
                    { key: 'midnight', label: '🌙', title: 'Midnight' },
                    { key: 'dark', label: '🌑', title: 'Dark' },
                    { key: 'light', label: '☀️', title: 'Light' },
                  ].map(t => (
                    <button key={t.key} onClick={() => setThemeMode(t.key)} title={t.title}
                      className={`px-2 py-1 rounded-md text-xs transition-all ${themeMode === t.key ? 'bg-violet-600 text-white shadow-sm' : 'text-slate-500 hover:text-white'}`}>
                      {t.label}
                    </button>
                  ))}
                </div>
                {/* PWA Install (Feature 7) — only show when actually installable */}
                {!isAppInstalled && deferredPrompt && (
                  <button onClick={handleInstallPWA} title="Install MODUS App"
                    className="px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all flex items-center gap-1.5 border bg-slate-800/50 hover:bg-violet-500/20 text-slate-400 hover:text-violet-400 border-slate-700/30 hover:border-violet-500/30">
                    <Download className="w-3.5 h-3.5" />
                    <span className="hidden md:inline">Install</span>
                  </button>
                )}
                <button
                  onClick={() => setShowDashboardConfig(!showDashboardConfig)}
                  className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all flex items-center gap-2 border ${showDashboardConfig ? 'bg-violet-600 text-white border-violet-500' : 'bg-slate-800/50 hover:bg-slate-700/70 text-slate-400 hover:text-white border-slate-700/30'}`}
                >
                  <Settings className="w-3.5 h-3.5" />
                  Customize
                </button>
              </div>
            </div>

            {/* Widget Config Panel */}
            {showDashboardConfig && (() => {
              const allWidgetDefs = [
                { key: 'clock', label: 'Clock & Market', icon: '🕐', group: 'mini' },
                { key: 'quickstats', label: 'Quick Stats', icon: '📈', group: 'mini' },
                { key: 'quicknav', label: 'Quick Navigation', icon: '🧭', group: 'mini' },
                { key: 'dailytip', label: 'Daily Tip', icon: '💡', group: 'trading' },
                { key: 'watchlist', label: 'Watchlist', icon: '👁️', group: 'trading' },
                { key: 'dailypick', label: 'Daily Pick', icon: '⭐', group: 'trading' },
                { key: 'portfolio', label: 'Portfolio P&L', icon: '💰', group: 'trading' },
                { key: 'alerts', label: 'Active Alerts', icon: '🔔', group: 'trading' },
                { key: 'performance', label: 'Performance', icon: '📊', group: 'data' },
                { key: 'marketsummary', label: 'Market Summary', icon: '📈', group: 'data' },
                { key: 'news', label: 'Latest News', icon: '📰', group: 'data' },
                { key: 'hotstocks', label: 'Hot Stocks', icon: '🔥', group: 'data' },
                { key: 'tradingstreak', label: 'Trading Streak', icon: '🔥', group: 'trading' },
                { key: 'feargreed', label: 'Market Mood', icon: '🎯', group: 'data' },
                { key: 'earnings', label: 'Earnings Calendar', icon: '📅', group: 'data' },
                { key: 'risk', label: 'Risk Dashboard', icon: '🛡️', group: 'trading' },
                { key: 'pricetargets', label: 'Price Targets', icon: '🎯', group: 'trading' },
                { key: 'socialfeed', label: 'Community Feed', icon: '💬', group: 'data' },
                { key: 'sectorheatmap', label: 'Sector Heatmap', icon: '🗺️', group: 'data' },
                { key: 'econevents', label: 'Economic Calendar', icon: '📅', group: 'data' },
                { key: 'premarket', label: 'Pre-Market Movers', icon: '🌅', group: 'data' },
                { key: 'correlation', label: 'Correlations', icon: '🔗', group: 'data' },
                { key: 'portfolioheatmap', label: 'Position Performance', icon: '🎨', group: 'trading' },
                { key: 'dividends', label: 'Dividend Calendar', icon: '💵', group: 'data' },
                { key: 'whatif', label: 'What-If Simulator', icon: '🧪', group: 'trading' },
                { key: 'mistakes', label: 'Mistake Tracker', icon: '⚠️', group: 'trading' },
                { key: 'coach', label: 'AI Trade Coach', icon: '🧠', group: 'trading' },
                { key: 'patterns', label: 'Pattern Scanner', icon: '📊', group: 'data' },
                { key: 'sentiment', label: 'Sentiment Pulse', icon: '💭', group: 'data' },
                { key: 'positionsize', label: 'Position Sizing', icon: '📐', group: 'trading' },
                { key: 'monthlypl', label: 'Monthly P&L', icon: '📈', group: 'trading' },
                { key: 'weeklyreport', label: 'Weekly Report', icon: '📑', group: 'trading' },
                { key: 'equitycurve', label: 'Equity Curve', icon: '📈', group: 'trading' },
                { key: 'achievements', label: 'Achievements', icon: '🏆', group: 'trading' },
                { key: 'emotionlog', label: 'Emotion Logger', icon: '🧠', group: 'trading' },
                { key: 'dayofweek', label: 'Win/Loss by Day', icon: '📅', group: 'trading' },
              ];
              const orderedActive = dashboardWidgets.map(k => allWidgetDefs.find(w => w.key === k)).filter(Boolean);
              const inactive = allWidgetDefs.filter(w => !dashboardWidgets.includes(w.key));
              const groupLabels = { mini: 'Mini Widgets', trading: 'Trading', data: 'Market Data' };
              const groupColors = { mini: 'text-cyan-400', trading: 'text-violet-400', data: 'text-emerald-400' };
              return (
                <div className="mb-6 p-4 bg-slate-800/30 rounded-xl border border-slate-700/20 animate-fadeIn">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-sm font-bold">Widgets & Layout</h3>
                    <div className="flex items-center gap-3">
                      <span className="text-[10px] text-slate-500">Drag cards or use arrows to reorder</span>
                      <button onClick={() => setDashboardWidgets(['clock', 'quickstats', 'quicknav', 'dailytip', 'watchlist', 'dailypick', 'portfolio', 'alerts', 'performance', 'marketsummary', 'news'])} className="text-[10px] text-violet-400 hover:text-violet-300 transition-colors">Reset to default</button>
                    </div>
                  </div>
                  {/* Active widgets - grouped by category */}
                  <div className="space-y-1 mb-4">
                    {orderedActive.map((w, idx) => {
                      const prevGroup = idx > 0 ? orderedActive[idx - 1]?.group : null;
                      const showGroupLabel = w.group !== prevGroup;
                      return (
                        <div key={w.key}>
                          {showGroupLabel && (
                            <div className={`text-[9px] uppercase tracking-widest font-bold ${groupColors[w.group] || 'text-slate-500'} mt-2 mb-1 pl-1`}>{groupLabels[w.group] || w.group}</div>
                          )}
                          <div className="flex items-center gap-2 px-3 py-2 bg-slate-700/30 rounded-lg group hover:bg-slate-700/50 transition-all">
                            <GripVertical className="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 cursor-grab" />
                            <span className="text-sm">{w.icon}</span>
                            <span className="text-xs font-medium text-white flex-1">{w.label}</span>
                            {w.group === 'mini' && <span className="text-[9px] bg-cyan-500/20 text-cyan-400 px-1.5 py-0.5 rounded font-medium">MINI</span>}
                            <div className="flex items-center gap-0.5">
                              <button onClick={() => moveWidget(w.key, 'up')} disabled={idx === 0} className="p-1 rounded hover:bg-slate-600/50 text-slate-500 hover:text-white disabled:opacity-20 disabled:hover:bg-transparent disabled:hover:text-slate-500 transition-all">
                                <ChevronUp className="w-3.5 h-3.5" />
                              </button>
                              <button onClick={() => moveWidget(w.key, 'down')} disabled={idx === orderedActive.length - 1} className="p-1 rounded hover:bg-slate-600/50 text-slate-500 hover:text-white disabled:opacity-20 disabled:hover:bg-transparent disabled:hover:text-slate-500 transition-all">
                                <ChevronDown className="w-3.5 h-3.5" />
                              </button>
                              <button onClick={() => setDashboardWidgets(prev => prev.filter(k => k !== w.key))} className="p-1 rounded hover:bg-red-500/20 text-slate-500 hover:text-red-400 transition-all ml-1">
                                <X className="w-3.5 h-3.5" />
                              </button>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  {/* Inactive widgets - grouped */}
                  {inactive.length > 0 && (
                    <div>
                      <p className="text-[10px] text-slate-500 uppercase tracking-wider mb-2 font-bold">Available to add</p>
                      <div className="flex flex-wrap gap-2">
                        {inactive.map(w => (
                          <button key={w.key} onClick={() => setDashboardWidgets(prev => [...prev, w.key])} className="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-800/50 text-slate-400 hover:bg-violet-600/30 hover:text-violet-300 transition-all flex items-center gap-1.5 border border-slate-700/20 border-dashed">
                            <Plus className="w-3 h-3" /> <span>{w.icon}</span> {w.label}
                            {w.group === 'mini' && <span className="text-[9px] bg-cyan-500/20 text-cyan-400 px-1 py-0.5 rounded">MINI</span>}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Mini Widgets Row */}
            {(() => {
              const miniKeys = ['clock', 'quickstats', 'quicknav'];
              const activeMinis = miniKeys.filter(k => dashboardWidgets.includes(k));
              if (activeMinis.length === 0) return null;
              const ms = getDashboardMarketStatus();
              const timeStr = dashboardClock.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
              const dateStr = dashboardClock.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
              return (
                <div className="mb-4 space-y-3">
                  {/* Clock & Market Status Row */}
                  {dashboardWidgets.includes('clock') && (
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                      {/* Live Clock */}
                      <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-3 flex items-center gap-3 hover:border-slate-600/30 transition-all">
                        <div className="p-2 bg-violet-500/15 rounded-lg">
                          <Clock className="w-4 h-4 text-violet-400" />
                        </div>
                        <div>
                          <div className="text-sm font-bold font-mono tracking-wide">{timeStr}</div>
                          <div className="text-[10px] text-slate-500">{dateStr}</div>
                        </div>
                      </div>
                      {/* Market Status */}
                      <div className={`rounded-xl border border-slate-700/20 p-3 flex items-center gap-3 hover:border-slate-600/30 transition-all ${ms.bg}`}>
                        <div className={`p-2 rounded-lg ${ms.status === 'open' ? 'bg-emerald-500/15' : ms.status === 'pre' ? 'bg-amber-500/15' : ms.status === 'after' ? 'bg-blue-500/15' : 'bg-red-500/15'}`}>
                          <Globe className="w-4 h-4" style={{ color: ms.status === 'open' ? '#34d399' : ms.status === 'pre' ? '#fbbf24' : ms.status === 'after' ? '#60a5fa' : '#f87171' }} />
                        </div>
                        <div>
                          <div className={`text-sm font-bold ${ms.color}`}>{ms.label}</div>
                          <div className="text-[10px] text-slate-500">{ms.sublabel}</div>
                        </div>
                      </div>
                      {/* Win Rate */}
                      <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-3 flex items-center gap-3 hover:border-slate-600/30 transition-all">
                        <div className="p-2 bg-blue-500/15 rounded-lg">
                          <Target className="w-4 h-4 text-blue-400" />
                        </div>
                        <div>
                          <div className={`text-sm font-bold ${performanceMetrics.winRate >= 50 ? 'text-emerald-400' : performanceMetrics.totalTrades > 0 ? 'text-red-400' : 'text-slate-400'}`}>{performanceMetrics.totalTrades > 0 ? `${performanceMetrics.winRate.toFixed(0)}%` : '--'}</div>
                          <div className="text-[10px] text-slate-500">Win Rate</div>
                        </div>
                      </div>
                      {/* Alerts Count */}
                      <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-3 flex items-center gap-3 hover:border-slate-600/30 transition-all">
                        <div className="p-2 bg-orange-500/15 rounded-lg">
                          <Bell className="w-4 h-4 text-orange-400" />
                        </div>
                        <div>
                          <div className="text-sm font-bold">{enabledAlertCount} <span className="text-slate-400 font-normal text-xs">active</span></div>
                          <div className="text-[10px] text-slate-500">{alerts.length} total alerts</div>
                        </div>
                      </div>
                    </div>
                  )}
                  {/* Quick Stats Row */}
                  {dashboardWidgets.includes('quickstats') && (
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                      {/* Total P&L */}
                      <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-3 flex items-center gap-3 hover:border-slate-600/30 transition-all">
                        <div className="p-2 bg-emerald-500/15 rounded-lg">
                          <TrendingUp className="w-4 h-4 text-emerald-400" />
                        </div>
                        <div>
                          <div className={`text-sm font-bold ${performanceMetrics.totalPnL >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{performanceMetrics.totalPnL >= 0 ? '+' : ''}${(performanceMetrics.totalPnL || 0).toFixed(0)}</div>
                          <div className="text-[10px] text-slate-500">Total P&L</div>
                        </div>
                      </div>
                      {/* Portfolio */}
                      <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-3 flex items-center gap-3 hover:border-slate-600/30 transition-all">
                        <div className="p-2 bg-amber-500/15 rounded-lg">
                          <Wallet className="w-4 h-4 text-amber-400" />
                        </div>
                        <div>
                          <div className="text-sm font-bold">{portfolio.length} <span className="text-slate-400 font-normal text-xs">positions</span></div>
                          <div className="text-[10px] text-slate-500">{watchlist.length} watching</div>
                        </div>
                      </div>
                      {/* Total Trades */}
                      <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-3 flex items-center gap-3 hover:border-slate-600/30 transition-all">
                        <div className="p-2 bg-cyan-500/15 rounded-lg">
                          <BarChart3 className="w-4 h-4 text-cyan-400" />
                        </div>
                        <div>
                          <div className="text-sm font-bold">{performanceMetrics.totalTrades || 0}</div>
                          <div className="text-[10px] text-slate-500">Total Trades</div>
                        </div>
                      </div>
                      {/* Profit Factor */}
                      <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-3 flex items-center gap-3 hover:border-slate-600/30 transition-all">
                        <div className="p-2 bg-violet-500/15 rounded-lg">
                          <Zap className="w-4 h-4 text-violet-400" />
                        </div>
                        <div>
                          <div className="text-sm font-bold">{performanceMetrics.totalTrades > 0 ? (performanceMetrics.profitFactor === Infinity ? '∞' : performanceMetrics.profitFactor.toFixed(2)) : '--'}</div>
                          <div className="text-[10px] text-slate-500">Profit Factor</div>
                        </div>
                      </div>
                    </div>
                  )}
                  {/* Quick Navigation Row */}
                  {dashboardWidgets.includes('quicknav') && (
                    <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
                      {[
                        { label: 'Analyze Chart', icon: <Camera className="w-3.5 h-3.5" />, tab: 'upload', color: 'text-violet-400 bg-violet-500/15' },
                        { label: 'Live Ticker', icon: <LineChart className="w-3.5 h-3.5" />, tab: 'ticker', color: 'text-cyan-400 bg-cyan-500/15' },
                        { label: 'Daily Pick', icon: <Star className="w-3.5 h-3.5" />, tab: 'daily', color: 'text-yellow-400 bg-yellow-500/15' },
                        { label: 'Ask AI', icon: <MessageCircle className="w-3.5 h-3.5" />, tab: 'ask', color: 'text-purple-400 bg-purple-500/15' },
                        { label: 'Scanner', icon: <Search className="w-3.5 h-3.5" />, tab: 'hotstocks', color: 'text-orange-400 bg-orange-500/15' },
                        { label: 'Journal', icon: <Pencil className="w-3.5 h-3.5" />, tab: 'journal', color: 'text-emerald-400 bg-emerald-500/15' },
                      ].map(item => (
                        <button key={item.tab} onClick={() => setActiveTab(item.tab)} className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-2.5 flex items-center gap-2 hover:bg-slate-700/40 hover:border-slate-600/30 transition-all group">
                          <div className={`p-1.5 rounded-lg ${item.color}`}>{item.icon}</div>
                          <span className="text-xs font-medium text-slate-400 group-hover:text-white transition-colors truncate">{item.label}</span>
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Top Movers Ticker Strip */}
            {(hotStocks.gainers?.length > 0 || hotStocks.losers?.length > 0) && (
              <div className="mt-4 bg-slate-800/20 rounded-xl border border-slate-700/15 px-4 py-2.5 overflow-hidden relative">
                <div className="flex items-center gap-6 overflow-x-auto scrollbar-hide" style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}>
                  <span className="text-[9px] font-bold text-slate-500 uppercase tracking-widest flex-shrink-0">Top Movers</span>
                  {[...(hotStocks.gainers || []).slice(0, 5).map(s => ({ ...s, type: 'gain' })), ...(hotStocks.losers || []).slice(0, 3).map(s => ({ ...s, type: 'loss' }))].map((s, i) => (
                    <button
                      key={s.symbol || i}
                      onClick={() => { setTickerSymbol(s.symbol); setActiveTab('ticker'); }}
                      className="flex items-center gap-2 flex-shrink-0 hover:bg-slate-700/30 px-2 py-1 rounded-lg transition-colors"
                    >
                      <span className="text-xs font-semibold text-white">{s.symbol}</span>
                      <span className={`text-xs font-mono ${s.type === 'gain' ? 'text-emerald-400' : 'text-red-400'}`}>
                        {s.type === 'gain' ? '+' : ''}{(s.changePercent || 0).toFixed(2)}%
                      </span>
                    </button>
                  ))}
                  {hotStocks.gainers?.length === 0 && hotStocks.losers?.length === 0 && (
                    <span className="text-[10px] text-slate-600">Scan Market Scanner to populate</span>
                  )}
                </div>
              </div>
            )}

            {/* Quick Analyze Bar */}
            <div className="mt-5 mb-5 bg-gradient-to-r from-violet-500/10 via-purple-500/5 to-slate-900/0 border border-violet-500/20 rounded-xl p-4 flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
              <div className="flex items-center gap-3 flex-shrink-0">
                <div className="p-2.5 bg-violet-500/20 rounded-lg">
                  <Zap className="w-5 h-5 text-violet-400" />
                </div>
                <div>
                  <h4 className="font-semibold text-sm">Quick Analyze</h4>
                  <p className="text-[10px] text-slate-500">Enter a ticker — view chart or get AI verdict <kbd className="ml-1 px-1 py-0.5 bg-slate-700/60 rounded text-[8px] text-slate-400 font-mono border border-slate-600/30">/</kbd></p>
                </div>
              </div>
              <div className="flex-1 flex gap-2">
                <input
                  type="text"
                  placeholder="e.g. AAPL, TSLA, NVDA..."
                  className="flex-1 bg-slate-800/60 border border-slate-700/30 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500/30 placeholder:text-slate-600 uppercase"
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && e.target.value.trim()) {
                      setTickerSymbol(e.target.value.trim().toUpperCase());
                      setActiveTab('ticker');
                      e.target.value = '';
                    }
                  }}
                />
                <button
                  onClick={() => {
                    const input = document.querySelector('[placeholder="e.g. AAPL, TSLA, NVDA..."]');
                    if (input?.value?.trim()) {
                      setTickerSymbol(input.value.trim().toUpperCase());
                      setActiveTab('ticker');
                      input.value = '';
                    }
                  }}
                  className="px-3 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-sm font-semibold transition-all flex items-center gap-1.5"
                  title="View live chart"
                >
                  <LineChart className="w-4 h-4" />
                  <span className="hidden sm:inline">Chart</span>
                </button>
                <button
                  onClick={() => {
                    const input = document.querySelector('[placeholder="e.g. AAPL, TSLA, NVDA..."]');
                    if (input?.value?.trim()) {
                      setQuickAnalysisTicker(input.value.trim().toUpperCase());
                      setActiveTab('quickanalysis');
                      setTimeout(() => runQuickAnalysis(input.value.trim().toUpperCase()), 100);
                      input.value = '';
                    }
                  }}
                  className="px-3 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-sm font-semibold transition-all flex items-center gap-1.5"
                  title="Get AI buy/sell verdict"
                >
                  <Zap className="w-4 h-4" />
                  <span className="hidden sm:inline">AI Verdict</span>
                </button>
              </div>
              {watchlist.length > 0 && (
                <div className="flex items-center gap-1.5 flex-wrap">
                  {watchlist.slice(0, 4).map(sym => (
                    <button
                      key={sym}
                      onClick={() => { setTickerSymbol(sym); setActiveTab('ticker'); }}
                      className="px-2 py-1 text-[10px] font-semibold bg-slate-800/60 hover:bg-violet-500/20 border border-slate-700/20 hover:border-violet-500/30 rounded-lg text-slate-400 hover:text-violet-300 transition-all"
                    >
                      {sym}
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Today's Activity Strip */}
            {(quickAnalysisHistory.length > 0 || trades.length > 0 || analysisHistory.length > 0) && (
              <div className="mt-4 flex items-center gap-4 flex-wrap text-[10px] text-slate-500">
                <span className="uppercase tracking-widest font-bold text-slate-600">Today</span>
                {quickAnalysisHistory.length > 0 && (
                  <span className="flex items-center gap-1.5 bg-slate-800/40 px-2.5 py-1 rounded-full">
                    <Zap className="w-3 h-3 text-violet-400" />
                    <span className="text-slate-400 font-medium">{quickAnalysisHistory.length}</span> quick {quickAnalysisHistory.length === 1 ? 'analysis' : 'analyses'}
                  </span>
                )}
                {analysisHistory.length > 0 && (
                  <span className="flex items-center gap-1.5 bg-slate-800/40 px-2.5 py-1 rounded-full">
                    <Camera className="w-3 h-3 text-cyan-400" />
                    <span className="text-slate-400 font-medium">{analysisHistory.length}</span> chart {analysisHistory.length === 1 ? 'analysis' : 'analyses'}
                  </span>
                )}
                {trades.filter(t => { const d = (t.date || t.entryDate || ''); return d.startsWith(new Date().toISOString().split('T')[0]); }).length > 0 && (
                  <span className="flex items-center gap-1.5 bg-slate-800/40 px-2.5 py-1 rounded-full">
                    <Pencil className="w-3 h-3 text-emerald-400" />
                    <span className="text-slate-400 font-medium">{trades.filter(t => { const d = (t.date || t.entryDate || ''); return d.startsWith(new Date().toISOString().split('T')[0]); }).length}</span> trade{trades.filter(t => { const d = (t.date || t.entryDate || ''); return d.startsWith(new Date().toISOString().split('T')[0]); }).length !== 1 ? 's' : ''} logged
                  </span>
                )}
                {watchlist.length > 0 && (
                  <span className="flex items-center gap-1.5 bg-slate-800/40 px-2.5 py-1 rounded-full">
                    <Eye className="w-3 h-3 text-amber-400" />
                    <span className="text-slate-400 font-medium">{watchlist.length}</span> watching
                  </span>
                )}
              </div>
            )}

            {/* Widget Grid - Ordered by dashboardWidgets array */}
            <div className="mt-5 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
              {dashboardWidgets.filter(k => !['clock', 'quickstats', 'quicknav'].includes(k)).map((widgetKey) => {
                const wrapProps = {
                  key: widgetKey,
                  draggable: true,
                  onDragStart: (e) => handleWidgetDragStart(e, widgetKey),
                  onDragOver: handleWidgetDragOver,
                  onDrop: (e) => handleWidgetDrop(e, widgetKey),
                  onDragEnd: () => setDraggedWidget(null),
                  className: `transition-all duration-200 ${draggedWidget === widgetKey ? 'opacity-40 scale-95' : 'opacity-100'} ${draggedWidget && draggedWidget !== widgetKey ? 'hover:ring-2 hover:ring-violet-500/40 hover:ring-offset-1 hover:ring-offset-slate-900' : ''}`,
                };

                try {
                switch(widgetKey) {
                  // ─── Daily Tip ─────────────────────
                  case 'dailytip': {
                    const tradingTips = [
                      { cat: 'Risk', color: 'rose', tip: 'Never risk more than 1-2% of your total account on a single trade. This keeps you in the game even during losing streaks.' },
                      { cat: 'Psychology', color: 'violet', tip: 'Stick to your trading plan. Emotional decisions during market hours are the #1 account killer for retail traders.' },
                      { cat: 'Technical', color: 'cyan', tip: 'Volume confirms price moves. A breakout on low volume is suspect — wait for volume to validate before entering.' },
                      { cat: 'Strategy', color: 'amber', tip: 'Define your exit before you enter. Know your stop-loss and take-profit levels BEFORE clicking buy.' },
                      { cat: 'Risk', color: 'rose', tip: 'Use position sizing formulas. If your stop is 5% away, and you risk 1% of capital, your position should be 20% of your account.' },
                      { cat: 'Psychology', color: 'violet', tip: 'Take breaks after big wins or losses. Both euphoria and despair cloud judgment equally.' },
                      { cat: 'Technical', color: 'cyan', tip: 'The 200-day moving average is the most-watched indicator by institutions. Price above it = bullish bias, below = bearish.' },
                      { cat: 'Fundamentals', color: 'emerald', tip: 'Earnings surprises move stocks more than earnings themselves. Focus on the delta between expectations and results.' },
                      { cat: 'Strategy', color: 'amber', tip: 'Trade the first pullback, not the first breakout. Let others test the waters — then follow the confirmed direction.' },
                      { cat: 'Risk', color: 'rose', tip: 'Correlation kills diversification. Holding 10 tech stocks is not diversified — check sector exposure regularly.' },
                      { cat: 'Psychology', color: 'violet', tip: 'Journal every trade. The pattern you keep repeating (and losing on) only becomes visible when you write it down.' },
                      { cat: 'Technical', color: 'cyan', tip: 'RSI divergence is one of the most reliable reversal signals. When price makes new highs but RSI doesn\'t, momentum is fading.' },
                      { cat: 'Strategy', color: 'amber', tip: 'Scale into positions rather than going all-in. Start with 1/3, add on confirmation, and save dry powder for dips.' },
                      { cat: 'Fundamentals', color: 'emerald', tip: 'Free cash flow matters more than revenue growth. A company that generates real cash can survive almost anything.' },
                      { cat: 'Risk', color: 'rose', tip: 'Set a daily loss limit. If you lose 3% in a day, step away. Tomorrow is a new opportunity with a fresh mindset.' },
                      { cat: 'Technical', color: 'cyan', tip: 'Support and resistance levels work because everyone watches them. Self-fulfilling prophecy is real in markets.' },
                      { cat: 'Psychology', color: 'violet', tip: 'FOMO is not a strategy. The market offers new opportunities every single day — missing one trade won\'t make or break you.' },
                      { cat: 'Strategy', color: 'amber', tip: 'The best trade setups have multiple confluences: trend, volume, support/resistance, and a catalyst all aligning.' },
                      { cat: 'Fundamentals', color: 'emerald', tip: 'Watch insider buying more than insider selling. Insiders sell for many reasons, but they buy for only one: they expect the stock to go up.' },
                      { cat: 'Risk', color: 'rose', tip: 'Never average down on a losing trade without a plan. Adding to losers is how small losses become account-ending disasters.' },
                      { cat: 'Psychology', color: 'violet', tip: 'Your win rate doesn\'t matter as much as your risk-reward ratio. You can be wrong 60% of the time and still be profitable.' },
                      { cat: 'Technical', color: 'cyan', tip: 'VWAP (Volume Weighted Average Price) acts like a magnet during the trading day. Institutional traders use it as a benchmark.' },
                      { cat: 'Strategy', color: 'amber', tip: 'Trade with the trend on higher timeframes. A 5-minute buy signal against the daily downtrend is fighting the current.' },
                      { cat: 'Fundamentals', color: 'emerald', tip: 'Debt-to-equity ratio above 2x is a red flag for most industries. High leverage amplifies both gains and losses.' },
                      { cat: 'Risk', color: 'rose', tip: 'Keep a cash reserve of at least 20-30%. Dry powder lets you capitalize on sudden opportunities instead of watching from the sidelines.' },
                      { cat: 'Psychology', color: 'violet', tip: 'The market doesn\'t care about your entry price. Making decisions based on what you "need" the stock to do is a recipe for disaster.' },
                      { cat: 'Technical', color: 'cyan', tip: 'Candlestick patterns are most reliable at key support/resistance levels. A doji in the middle of a range means nothing.' },
                      { cat: 'Strategy', color: 'amber', tip: 'Paper trade new strategies for at least 2 weeks before risking real money. Your live results will always be worse than paper.' },
                      { cat: 'Fundamentals', color: 'emerald', tip: 'Compare P/E ratios within the same sector, not across sectors. A 30 P/E tech stock and a 30 P/E utility stock are very different.' },
                      { cat: 'Psychology', color: 'violet', tip: 'Consistency beats intensity. Trading less with higher quality setups will outperform overtrading every time.' },
                    ];
                    const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0).getTime()) / 86400000);
                    const todayTip = tradingTips[dayOfYear % tradingTips.length];
                    const colorMap = { rose: 'from-rose-500/20 to-rose-600/5 border-rose-500/20 text-rose-400', violet: 'from-violet-500/20 to-violet-600/5 border-violet-500/20 text-violet-400', cyan: 'from-cyan-500/20 to-cyan-600/5 border-cyan-500/20 text-cyan-400', amber: 'from-amber-500/20 to-amber-600/5 border-amber-500/20 text-amber-400', emerald: 'from-emerald-500/20 to-emerald-600/5 border-emerald-500/20 text-emerald-400' };
                    const badgeMap = { rose: 'bg-rose-500/20 text-rose-400', violet: 'bg-violet-500/20 text-violet-400', cyan: 'bg-cyan-500/20 text-cyan-400', amber: 'bg-amber-500/20 text-amber-400', emerald: 'bg-emerald-500/20 text-emerald-400' };
                    return (
                      <div {...wrapProps}>
                        <div className={`bg-gradient-to-br ${colorMap[todayTip.color] || colorMap.violet} rounded-xl border p-4 relative overflow-hidden h-full`}>
                          <div className="absolute top-2 right-3 text-3xl opacity-[0.06]">💡</div>
                          <h3 className="text-sm font-bold mb-2 flex items-center gap-2">
                            <div className="p-1 bg-white/10 rounded-md"><Lightbulb className="w-3.5 h-3.5" /></div>
                            Daily Tip
                            <span className={`text-[10px] ${badgeMap[todayTip.color]} px-1.5 py-0.5 rounded-full ml-auto font-semibold`}>{todayTip.cat}</span>
                          </h3>
                          <p className="text-xs text-slate-200 leading-relaxed">{todayTip.tip}</p>
                          <div className="mt-3 flex items-center justify-between">
                            <span className="text-[10px] text-slate-500">Tip #{(dayOfYear % tradingTips.length) + 1} of {tradingTips.length}</span>
                            <button onClick={() => { const nextTip = tradingTips[(dayOfYear + Math.floor(Math.random() * (tradingTips.length - 1)) + 1) % tradingTips.length]; setToast({ type: 'success', message: `💡 ${nextTip.cat}: ${nextTip.tip}` }); }} className="text-[10px] text-slate-400 hover:text-white transition-colors">Random tip ↻</button>
                          </div>
                        </div>
                      </div>
                    );
                  }

                  // ─── Watchlist ─────────────────────
                  case 'watchlist': {
                    const groupNames = Object.keys(watchlistGroups);
                    const filteredWatchlist = activeWatchlistGroup === 'All' ? watchlist : (watchlistGroups[activeWatchlistGroup] || []).filter(s => watchlist.includes(s));
                    return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-violet-500/8 to-slate-900/0 rounded-xl border border-violet-500/10 p-4 h-full hover:border-violet-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-2 flex items-center gap-2">
                          <div className="p-1 bg-violet-500/15 rounded-md"><Eye className="w-3.5 h-3.5 text-violet-400" /></div>
                          Watchlist
                          <span className="text-[10px] bg-violet-500/15 text-violet-400 px-1.5 py-0.5 rounded-full ml-auto font-medium">{filteredWatchlist.length}</span>
                        </h3>
                        {/* Group Tabs (Feature 6) — with remove group */}
                        <div className="flex items-center gap-1 mb-2 flex-wrap">
                          {groupNames.map(g => (
                            <div key={g} className="relative group/grp flex items-center">
                              <button onClick={() => setActiveWatchlistGroup(g)}
                                className={`text-[9px] px-2 py-0.5 rounded-full transition-all ${activeWatchlistGroup === g ? 'bg-violet-600 text-white' : 'bg-slate-700/30 text-slate-500 hover:text-white'}`}>
                                {g}
                              </button>
                              {g !== 'All' && (
                                <button onClick={(e) => { e.stopPropagation(); setWatchlistGroups(prev => { const u = {...prev}; delete u[g]; return u; }); if (activeWatchlistGroup === g) setActiveWatchlistGroup('All'); }}
                                  className="absolute -top-1 -right-1 w-3 h-3 bg-red-500/80 rounded-full text-white text-[7px] flex items-center justify-center opacity-0 group-hover/grp:opacity-100 transition-opacity hover:bg-red-500"
                                  title={`Delete ${g} group`}>×</button>
                              )}
                            </div>
                          ))}
                          {!showGroupManager ? (
                            <button onClick={() => setShowGroupManager(true)} className="text-[9px] text-violet-400 hover:text-violet-300 px-1">+</button>
                          ) : (
                            <div className="flex items-center gap-1">
                              <input value={newGroupName} onChange={e => setNewGroupName(e.target.value)} placeholder="Group name"
                                onKeyDown={e => { if (e.key === 'Enter' && newGroupName.trim()) { setWatchlistGroups(prev => ({...prev, [newGroupName.trim()]: []})); setNewGroupName(''); setShowGroupManager(false); } }}
                                className="text-[9px] bg-slate-700/30 border border-slate-600/30 rounded px-1.5 py-0.5 w-16 text-white outline-none focus:border-violet-500/50" />
                              <button onClick={() => { if (newGroupName.trim()) { setWatchlistGroups(prev => ({...prev, [newGroupName.trim()]: []})); setNewGroupName(''); setShowGroupManager(false); }}}
                                className="text-[9px] text-emerald-400">✓</button>
                              <button onClick={() => setShowGroupManager(false)} className="text-[9px] text-red-400">✕</button>
                            </div>
                          )}
                        </div>
                        {filteredWatchlist.length === 0 ? (
                          <div className="text-center py-4">
                            <Eye className="w-8 h-8 text-slate-700 mx-auto mb-2" />
                            <p className="text-xs text-slate-500 mb-2">{activeWatchlistGroup === 'All' ? 'No symbols tracked yet' : `No stocks in ${activeWatchlistGroup}`}</p>
                            <button onClick={() => setActiveTab('ticker')} className="text-[10px] text-violet-400 hover:text-violet-300 border border-violet-500/20 hover:border-violet-500/40 px-2.5 py-1 rounded-lg transition-all">
                              + Add from Live Ticker
                            </button>
                          </div>
                        ) : (
                          <div className="space-y-1.5 max-h-48 overflow-y-auto">
                            {filteredWatchlist.slice(0, 8).map(sym => {
                              const p = watchlistPrices[sym];
                              return (
                                <div key={sym} className="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-slate-800/50 cursor-pointer group" onClick={() => { setTickerSymbol(sym); setActiveTab('ticker'); }}>
                                  <div className="flex items-center gap-1.5">
                                    <span className="text-sm font-medium group-hover:text-violet-300 transition-colors">{sym}</span>
                                    {/* Group assign dropdown on hover */}
                                    <div className="relative hidden group-hover:inline-flex items-center gap-0.5">
                                      <select
                                        onClick={e => e.stopPropagation()}
                                        onChange={e => { e.stopPropagation(); if (e.target.value) addToWatchlistGroup(sym, e.target.value); }}
                                        className="text-[8px] bg-slate-700 border-none rounded text-slate-400 w-8 h-4 appearance-none cursor-pointer"
                                        defaultValue=""
                                      >
                                        <option value="">+</option>
                                        {groupNames.filter(g => g !== 'All').map(g => <option key={g} value={g}>{g}</option>)}
                                      </select>
                                    </div>
                                  </div>
                                  <div className="flex items-center gap-1.5">
                                    <div className="text-right">
                                      {p?.price > 0 && <span className="text-xs font-mono">${p.price.toFixed(2)}</span>}
                                      {p?.changePercent !== undefined && (
                                        <span className={`text-[10px] ml-1 ${p.changePercent >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                          {p.changePercent >= 0 ? '+' : ''}{p.changePercent.toFixed(2)}%
                                        </span>
                                      )}
                                    </div>
                                    {/* Remove from group (only when in a specific group) */}
                                    {activeWatchlistGroup !== 'All' && (
                                      <button onClick={(e) => { e.stopPropagation(); removeFromWatchlistGroup(sym, activeWatchlistGroup); }}
                                        className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 p-0.5 transition-opacity"
                                        title={`Remove from ${activeWatchlistGroup}`}>
                                        <X className="w-3 h-3" />
                                      </button>
                                    )}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    </div>
                    );
                  }

                  // ─── Daily Pick ─────────────────────
                  case 'dailypick': {
                    const dpConf = dailyPick ? (dailyPick.confidence || 0) : 0;
                    return (
                    <div {...wrapProps}>
                      <div className={`rounded-xl border p-4 h-full transition-all ${dailyPick ? (dailyPick.direction === 'LONG' ? 'bg-emerald-500/5 border-emerald-500/15 hover:border-emerald-500/30' : 'bg-red-500/5 border-red-500/15 hover:border-red-500/30') : 'bg-slate-800/30 border-slate-700/20 hover:border-slate-600/30'}`}>
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <Star className="w-4 h-4 text-yellow-400" /> Daily Pick
                          {dailyPick && <span className="text-[9px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded-full ml-auto font-semibold">TODAY</span>}
                        </h3>
                        {dailyPick ? (
                          <div>
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-lg font-bold">{dailyPick.asset || dailyPick.symbol}</span>
                              <span className={`px-2 py-0.5 rounded text-xs font-bold ${dailyPick.direction === 'LONG' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                                {dailyPick.direction === 'LONG' ? '↑ LONG' : '↓ SHORT'}
                              </span>
                            </div>
                            <div className="grid grid-cols-3 gap-2 mb-2 text-xs">
                              <div>
                                <div className="text-[10px] text-slate-500">Entry</div>
                                <div className="font-semibold text-white">${parseFloat(dailyPick.entry || 0).toFixed(2)}</div>
                              </div>
                              <div>
                                <div className="text-[10px] text-slate-500">Target</div>
                                <div className="font-semibold text-emerald-400">${parseFloat(dailyPick.target || 0).toFixed(2)}</div>
                              </div>
                              <div>
                                <div className="text-[10px] text-slate-500">Stop</div>
                                <div className="font-semibold text-red-400">${parseFloat(dailyPick.stopLoss || 0).toFixed(2)}</div>
                              </div>
                            </div>
                            {/* Confidence bar */}
                            <div className="mb-2">
                              <div className="flex items-center justify-between text-[10px] mb-0.5">
                                <span className="text-slate-500">Confidence</span>
                                <span className={`font-bold ${dpConf >= 70 ? 'text-emerald-400' : dpConf >= 50 ? 'text-amber-400' : 'text-red-400'}`}>{dpConf}%</span>
                              </div>
                              <div className="h-1.5 bg-slate-700/30 rounded-full overflow-hidden">
                                <div className={`h-full rounded-full transition-all duration-700 ${dpConf >= 70 ? 'bg-emerald-500' : dpConf >= 50 ? 'bg-amber-500' : 'bg-red-500'}`} style={{ width: `${dpConf}%` }} />
                              </div>
                            </div>
                            <button onClick={() => setActiveTab('daily')} className="w-full text-xs text-violet-400 hover:text-violet-300 transition-colors text-center py-1 border border-violet-500/20 rounded-lg hover:bg-violet-500/10">View full analysis →</button>
                          </div>
                        ) : (
                          <div className="text-center py-3">
                            <Star className="w-8 h-8 text-slate-700 mx-auto mb-2" />
                            <p className="text-xs text-slate-500 mb-2">No pick generated today</p>
                            <button onClick={() => setActiveTab('daily')} className="text-xs text-violet-400 hover:text-violet-300 px-3 py-1.5 border border-violet-500/20 rounded-lg hover:bg-violet-500/10 transition-all">Generate Daily Pick →</button>
                          </div>
                        )}
                      </div>
                    </div>
                    );
                  }

                  // ─── Portfolio ─────────────────────
                  case 'portfolio': {
                    const totalValue = portfolio.reduce((s, p) => s + (parseFloat(p.avgPrice || 0) * parseInt(p.quantity || 0)), 0);
                    return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-emerald-500/8 to-slate-900/0 rounded-xl border border-emerald-500/10 p-4 h-full hover:border-emerald-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-emerald-500/15 rounded-md"><DollarSign className="w-3.5 h-3.5 text-emerald-400" /></div>
                          Portfolio
                          <span className="text-[10px] bg-emerald-500/15 text-emerald-400 px-1.5 py-0.5 rounded-full ml-auto font-medium">{portfolio.length} positions</span>
                        </h3>
                        {portfolio.length > 0 ? (
                          <div>
                            {totalValue > 0 && (
                              <div className="mb-3 pb-2 border-b border-slate-700/20">
                                <div className="text-[10px] text-slate-500 uppercase">Total Value</div>
                                <div className="text-lg font-bold text-emerald-400">${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                              </div>
                            )}
                            <div className="space-y-1.5 max-h-36 overflow-y-auto">
                              {portfolio.slice(0, 5).map(pos => {
                                const posValue = parseFloat(pos.avgPrice || 0) * parseInt(pos.quantity || 0);
                                const pct = totalValue > 0 ? (posValue / totalValue * 100) : 0;
                                return (
                                  <div key={pos.symbol} className="flex items-center justify-between py-1.5 px-2 rounded-lg hover:bg-slate-800/40 transition-all cursor-pointer group" onClick={() => { setTickerSymbol(pos.symbol); setActiveTab('ticker'); }}>
                                    <div className="flex items-center gap-2">
                                      <span className="text-xs font-bold group-hover:text-violet-300 transition-colors">{pos.symbol}</span>
                                      <div className="w-12 h-1 bg-slate-700/30 rounded-full overflow-hidden"><div className="h-full bg-emerald-500/50 rounded-full" style={{ width: `${pct}%` }} /></div>
                                    </div>
                                    <span className="text-[10px] text-slate-400">{pos.quantity} @ ${parseFloat(pos.avgPrice || 0).toFixed(2)}</span>
                                  </div>
                                );
                              })}
                            </div>
                            <button onClick={() => setActiveTab('portfolio')} className="mt-2 text-[10px] text-emerald-400 hover:text-emerald-300 transition-colors">View all →</button>
                          </div>
                        ) : (
                          <div className="text-center py-4">
                            <div className="w-12 h-12 mx-auto mb-2 rounded-full bg-emerald-500/10 flex items-center justify-center"><DollarSign className="w-6 h-6 text-emerald-500/40" /></div>
                            <p className="text-xs text-slate-400 mb-1">No positions tracked yet</p>
                            <p className="text-[10px] text-slate-600 mb-3">Add your holdings to track portfolio value</p>
                            <button onClick={() => setActiveTab('portfolio')} className="text-[10px] text-emerald-400 hover:text-emerald-300 border border-emerald-500/20 hover:border-emerald-500/40 px-3 py-1.5 rounded-lg transition-all">
                              + Add position
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                    );
                  }

                  // ─── Active Alerts ─────────────────────
                  case 'alerts': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-orange-500/8 to-slate-900/0 rounded-xl border border-orange-500/10 p-4 h-full hover:border-orange-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-orange-500/15 rounded-md"><Bell className="w-3.5 h-3.5 text-orange-400" /></div>
                          Active Alerts
                          <span className={`text-[10px] px-1.5 py-0.5 rounded-full ml-auto font-medium ${enabledAlertCount > 0 ? 'bg-orange-500/15 text-orange-400' : 'bg-slate-700/50 text-slate-500'}`}>{enabledAlertCount} active</span>
                        </h3>
                        {alerts.filter(a => a.enabled).length > 0 ? (
                          <div className="space-y-1.5 max-h-40 overflow-y-auto">
                            {alerts.filter(a => a.enabled).slice(0, 5).map(alert => (
                              <div key={alert.id} className="flex items-center justify-between px-2.5 py-2 bg-slate-800/30 rounded-lg text-xs border border-slate-700/10 hover:border-orange-500/15 transition-all group">
                                <div className="flex items-center gap-2">
                                  <div className={`w-1.5 h-1.5 rounded-full ${alert.condition === 'above' ? 'bg-emerald-400' : 'bg-red-400'} animate-pulse`} />
                                  <span className="font-bold group-hover:text-orange-300 transition-colors">{alert.symbol}</span>
                                </div>
                                <span className="text-slate-400 font-mono">{alert.condition === 'above' ? '↑' : '↓'} ${parseFloat(alert.price || 0).toFixed(2)}</span>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <div className="text-center py-4">
                            <div className="w-12 h-12 mx-auto mb-2 rounded-full bg-orange-500/10 flex items-center justify-center"><Bell className="w-6 h-6 text-orange-500/40" /></div>
                            <p className="text-xs text-slate-400 mb-1">No active alerts</p>
                            <p className="text-[10px] text-slate-600 mb-3">Get notified when stocks hit your target price</p>
                            <button onClick={() => setActiveTab('alerts')} className="text-[10px] text-orange-400 hover:text-orange-300 border border-orange-500/20 hover:border-orange-500/40 px-3 py-1.5 rounded-lg transition-all">
                              + Set a price alert
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // ─── Performance ─────────────────────
                  case 'performance': {
                    const pm = performanceMetrics;
                    const wins = pm.totalTrades > 0 ? Math.round(pm.totalTrades * pm.winRate / 100) : 0;
                    const losses = pm.totalTrades - wins;
                    const perfColor = pm.totalPnL >= 0 ? 'from-blue-500/10' : 'from-red-500/8';
                    const perfBorder = pm.totalPnL >= 0 ? 'border-blue-500/10 hover:border-blue-500/20' : 'border-red-500/10 hover:border-red-500/20';
                    return (
                    <div {...wrapProps}>
                      <div className={`bg-gradient-to-br ${perfColor} to-slate-900/0 rounded-xl border ${perfBorder} p-4 h-full transition-all`}>
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-blue-500/15 rounded-md"><BarChart3 className="w-3.5 h-3.5 text-blue-400" /></div>
                          Performance
                          <button onClick={() => setActiveTab('performance')} className="ml-auto text-[9px] text-blue-400 hover:text-blue-300 transition-colors">Details →</button>
                        </h3>
                        {pm.totalTrades > 0 ? (
                          <div>
                            {/* Big P&L number */}
                            <div className="text-center mb-3">
                              <div className={`text-2xl font-bold ${pm.totalPnL >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                {pm.totalPnL >= 0 ? '+' : ''}${pm.totalPnL.toFixed(0)}
                              </div>
                              <div className="text-[10px] text-slate-500 mt-0.5">Total P&L</div>
                            </div>
                            {/* Win/Loss Visual Bar */}
                            <div className="mb-3">
                              <div className="flex items-center justify-between text-[10px] mb-1.5">
                                <span className="text-emerald-400 font-bold">{wins}W</span>
                                <span className="text-white font-semibold">{pm.winRate.toFixed(0)}% win rate</span>
                                <span className="text-red-400 font-bold">{losses}L</span>
                              </div>
                              <div className="flex h-2.5 rounded-full overflow-hidden bg-slate-700/30">
                                <div className="bg-emerald-500 rounded-l-full transition-all duration-700" style={{ width: `${pm.winRate}%` }} />
                                <div className="bg-red-500 rounded-r-full transition-all duration-700" style={{ width: `${100 - pm.winRate}%` }} />
                              </div>
                            </div>
                            {/* Stats row */}
                            <div className="grid grid-cols-2 gap-2 pt-2 border-t border-slate-700/20">
                              <div className="bg-slate-800/30 rounded-lg p-2 text-center">
                                <div className="text-[9px] text-slate-500 uppercase">Avg/Trade</div>
                                <div className={`text-sm font-bold ${(pm.totalPnL / pm.totalTrades) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                  {(pm.totalPnL / pm.totalTrades) >= 0 ? '+' : ''}${(pm.totalPnL / pm.totalTrades).toFixed(0)}
                                </div>
                              </div>
                              <div className="bg-slate-800/30 rounded-lg p-2 text-center">
                                <div className="text-[9px] text-slate-500 uppercase">Profit Factor</div>
                                <div className="text-sm font-bold text-white">{pm.profitFactor === Infinity ? '∞' : pm.profitFactor.toFixed(2)}</div>
                              </div>
                            </div>
                          </div>
                        ) : (
                          <div className="text-center py-3">
                            <div className="w-12 h-12 mx-auto mb-2 rounded-full bg-blue-500/10 flex items-center justify-center"><BarChart3 className="w-6 h-6 text-blue-500/40" /></div>
                            <p className="text-xs text-slate-400 mb-1">No performance data yet</p>
                            <p className="text-[10px] text-slate-600 mb-3">Log trades to track win rate, P&L, and profit factor</p>
                            <button onClick={() => setActiveTab('journal')} className="text-[10px] text-blue-400 hover:text-blue-300 border border-blue-500/20 hover:border-blue-500/40 px-3 py-1.5 rounded-lg transition-all">Go to Journal →</button>
                          </div>
                        )}
                      </div>
                    </div>
                    );
                  }

                  // ─── Market Summary ─────────────────────
                  case 'marketsummary': {
                    const allChgs = ['SPY', 'QQQ', 'DIA', 'IWM'].map(s => marketData.indices[s]?.changePercent || 0);
                    const avgMkt = allChgs.reduce((a, b) => a + b, 0) / allChgs.length;
                    const mktGrad = avgMkt >= 0 ? 'from-cyan-500/8' : 'from-red-500/8';
                    const mktBrd = avgMkt >= 0 ? 'border-cyan-500/10 hover:border-cyan-500/20' : 'border-red-500/10 hover:border-red-500/20';
                    return (
                    <div {...wrapProps}>
                      <div className={`bg-gradient-to-br ${mktGrad} to-slate-900/0 rounded-xl border ${mktBrd} p-4 h-full transition-all`}>
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-cyan-500/15 rounded-md"><Activity className="w-3.5 h-3.5 text-cyan-400" /></div>
                          Market Summary
                          <div className={`ml-auto text-[10px] font-semibold px-1.5 py-0.5 rounded ${avgMkt >= 0 ? 'bg-emerald-500/15 text-emerald-400' : 'bg-red-500/15 text-red-400'}`}>
                            {avgMkt >= 0 ? '↑' : '↓'} {Math.abs(avgMkt).toFixed(2)}%
                          </div>
                        </h3>
                        <div className="space-y-1.5">
                          {['SPY', 'QQQ', 'DIA', 'IWM'].map(idx => {
                            const d = marketData.indices[idx];
                            const chg = d?.changePercent || 0;
                            const nameMap = { SPY: 'S&P 500', QQQ: 'Nasdaq', DIA: 'Dow Jones', IWM: 'Russell 2K' };
                            return (
                              <button key={idx} onClick={() => { setTickerSymbol(idx); setActiveTab('ticker'); }} className="w-full flex items-center justify-between text-xs py-2 px-2.5 rounded-lg hover:bg-slate-800/40 border border-transparent hover:border-slate-700/20 transition-all group">
                                <div>
                                  <span className="font-bold text-white group-hover:text-cyan-300 transition-colors">{idx}</span>
                                  <span className="text-[9px] text-slate-500 ml-1.5">{nameMap[idx]}</span>
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className="font-mono text-slate-300 text-[11px]">${(d?.price || 0).toFixed(2)}</span>
                                  <div className={`flex items-center gap-0.5 px-1.5 py-0.5 rounded-md font-semibold ${chg >= 0 ? 'bg-emerald-500/12 text-emerald-400' : 'bg-red-500/12 text-red-400'}`}>
                                    {chg >= 0 ? <TrendingUp className="w-2.5 h-2.5" /> : <TrendingDown className="w-2.5 h-2.5" />}
                                    <span>{chg >= 0 ? '+' : ''}{chg.toFixed(2)}%</span>
                                  </div>
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                    );
                  }

                  // ─── Latest News ─────────────────────
                  case 'news': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-indigo-500/8 to-slate-900/0 rounded-xl border border-indigo-500/10 p-4 h-full hover:border-indigo-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-indigo-500/15 rounded-md"><Newspaper className="w-3.5 h-3.5 text-indigo-400" /></div>
                          Latest News
                          <button onClick={() => generateNewsFeed()} className="ml-auto p-1.5 rounded-md hover:bg-slate-700/50 text-slate-500 hover:text-indigo-400 transition-all" title="Refresh news">
                            <RefreshCw className={`w-3.5 h-3.5 ${loadingNews ? 'animate-spin' : ''}`} />
                          </button>
                        </h3>
                        {loadingNews ? (
                          <div className="flex flex-col items-center justify-center py-6 gap-2">
                            <Loader2 className="w-5 h-5 animate-spin text-indigo-400" />
                            <span className="text-[10px] text-slate-500">Fetching latest news...</span>
                          </div>
                        ) : newsFeed.length > 0 ? (
                          <div className="space-y-1.5 max-h-48 overflow-y-auto">
                            {newsFeed.slice(0, 5).map((item, i) => {
                              const sentColor = item.sentiment === 'bullish' ? 'border-l-emerald-500' : item.sentiment === 'bearish' ? 'border-l-red-500' : 'border-l-slate-600';
                              const newsDate = item.timestamp ? new Date(item.timestamp) : null;
                              const timeAgo = newsDate ? (() => {
                                const mins = Math.floor((Date.now() - newsDate.getTime()) / 60000);
                                if (mins < 60) return `${mins}m ago`;
                                if (mins < 1440) return `${Math.floor(mins/60)}h ago`;
                                return `${Math.floor(mins/1440)}d ago`;
                              })() : '';
                              return (
                                <div key={item.url || item.title || i} className={`text-xs text-slate-300 py-2 px-2.5 rounded-lg bg-slate-800/20 border-l-2 ${sentColor} hover:bg-slate-800/40 transition-all`}>
                                  <div className="flex items-center gap-1.5 mb-1">
                                    {item.symbol && item.symbol !== 'INFO' && item.symbol !== 'ERROR' && (
                                      <span className="text-[9px] font-bold bg-violet-500/20 text-violet-300 px-1.5 py-0.5 rounded">{item.symbol}</span>
                                    )}
                                    {timeAgo && <span className="text-[9px] text-slate-500">{timeAgo}</span>}
                                    {item.sentiment && item.sentiment !== 'neutral' && (
                                      <span className={`text-[9px] ${item.sentiment === 'bullish' ? 'text-emerald-400' : 'text-red-400'}`}>
                                        {item.sentiment === 'bullish' ? '▲' : '▼'}
                                      </span>
                                    )}
                                  </div>
                                  <span className="leading-relaxed">{(item.headline || item.title || '').substring(0, 90)}{(item.headline || item.title || '').length > 90 ? '...' : ''}</span>
                                </div>
                              );
                            })}
                            <button onClick={() => setActiveTab('news')} className="text-[10px] text-indigo-400 hover:text-indigo-300 transition-colors mt-1">View all news →</button>
                          </div>
                        ) : (
                          <div className="text-center py-4">
                            <div className="w-12 h-12 mx-auto mb-2 rounded-full bg-indigo-500/10 flex items-center justify-center"><Newspaper className="w-6 h-6 text-indigo-500/40" /></div>
                            <p className="text-xs text-slate-400 mb-1">No news loaded yet</p>
                            <p className="text-[10px] text-slate-600 mb-3">Get AI-curated market news and sentiment</p>
                            <button onClick={() => generateNewsFeed()} className="text-[10px] text-indigo-400 hover:text-indigo-300 border border-indigo-500/20 hover:border-indigo-500/40 px-3 py-1.5 rounded-lg transition-all">Load market news</button>
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // ─── Hot Stocks ─────────────────────
                  case 'hotstocks': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-orange-500/10 to-slate-900/0 rounded-xl border border-orange-500/10 p-4 h-full hover:border-orange-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-orange-500/15 rounded-md"><Flame className="w-3.5 h-3.5 text-orange-400" /></div>
                          Hot Stocks
                          <button onClick={() => setActiveTab('hotstocks')} className="ml-auto text-[9px] text-orange-400 hover:text-orange-300 transition-colors">View all →</button>
                        </h3>
                        {hotStocks.gainers?.length > 0 || hotStocks.losers?.length > 0 ? (
                          <div>
                            {(hotStocks.gainers || []).length > 0 && <div className="text-[9px] text-emerald-500/60 uppercase tracking-wider font-bold mb-1">Gainers</div>}
                            <div className="space-y-1 mb-2">
                              {(hotStocks.gainers || []).slice(0, 4).map((s, i) => (
                                <button key={s.symbol || `g${i}`} onClick={() => { setTickerSymbol(s.symbol); setActiveTab('ticker'); }} className="w-full flex items-center justify-between text-xs py-1.5 px-2 rounded-lg hover:bg-emerald-500/5 border border-transparent hover:border-emerald-500/10 transition-all group">
                                  <span className="font-bold group-hover:text-emerald-300 transition-colors">{s.symbol}</span>
                                  <div className="flex items-center gap-1">
                                    <TrendingUp className="w-2.5 h-2.5 text-emerald-400" />
                                    <span className="text-emerald-400 font-semibold bg-emerald-500/10 px-1.5 py-0.5 rounded-md">+{(s.changePercent || 0).toFixed(2)}%</span>
                                  </div>
                                </button>
                              ))}
                            </div>
                            {(hotStocks.losers || []).length > 0 && <div className="text-[9px] text-red-500/60 uppercase tracking-wider font-bold mb-1 pt-1 border-t border-slate-700/20">Losers</div>}
                            <div className="space-y-1">
                              {(hotStocks.losers || []).slice(0, 2).map((s, i) => (
                                <button key={s.symbol || `l${i}`} onClick={() => { setTickerSymbol(s.symbol); setActiveTab('ticker'); }} className="w-full flex items-center justify-between text-xs py-1.5 px-2 rounded-lg hover:bg-red-500/5 border border-transparent hover:border-red-500/10 transition-all group">
                                  <span className="font-bold group-hover:text-red-300 transition-colors">{s.symbol}</span>
                                  <div className="flex items-center gap-1">
                                    <TrendingDown className="w-2.5 h-2.5 text-red-400" />
                                    <span className="text-red-400 font-semibold bg-red-500/10 px-1.5 py-0.5 rounded-md">{(s.changePercent || 0).toFixed(2)}%</span>
                                  </div>
                                </button>
                              ))}
                            </div>
                          </div>
                        ) : (
                          <div className="text-center py-4">
                            <div className="w-12 h-12 mx-auto mb-2 rounded-full bg-orange-500/10 flex items-center justify-center"><Flame className="w-6 h-6 text-orange-500/40" /></div>
                            <p className="text-xs text-slate-400 mb-1">No scan data yet</p>
                            <p className="text-[10px] text-slate-600 mb-3">Scan the market for top movers</p>
                            <button onClick={() => setActiveTab('hotstocks')} className="text-[10px] text-orange-400 hover:text-orange-300 border border-orange-500/20 hover:border-orange-500/40 px-3 py-1.5 rounded-lg transition-all">Run Market Scanner</button>
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // ─── Trading Streak ─────────────────────
                  case 'tradingstreak': {
                    const today = new Date();
                    const sortedTrades = [...trades].sort((a, b) => new Date(b.date || b.entryDate) - new Date(a.date || a.entryDate));
                    let streak = 0;
                    let checkDate = new Date(today);
                    checkDate.setHours(0, 0, 0, 0);
                    for (let d = 0; d < 365; d++) {
                      const dateStr = checkDate.toISOString().split('T')[0];
                      const hasTrade = sortedTrades.some(t => {
                        const td = (t.date || t.entryDate || '').split('T')[0];
                        return td === dateStr;
                      });
                      if (hasTrade) {
                        streak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                      } else if (d === 0) {
                        checkDate.setDate(checkDate.getDate() - 1);
                        continue;
                      } else {
                        break;
                      }
                    }
                    const recentWins = sortedTrades.slice(0, 10).filter(t => {
                      const pnl = t.pnl ?? ((t.exitPrice || 0) - (t.entryPrice || 0)) * (t.quantity || 0) * (t.side === 'short' ? -1 : 1);
                      return pnl > 0;
                    }).length;
                    const streakEmoji = streak >= 7 ? '🔥' : streak >= 3 ? '⚡' : streak >= 1 ? '✅' : '💤';
                    const streakLabel = streak >= 7 ? 'On Fire!' : streak >= 3 ? 'Building Momentum' : streak >= 1 ? 'Active' : 'Start Your Streak';
                    const streakColor = streak >= 7 ? 'text-orange-400' : streak >= 3 ? 'text-yellow-400' : streak >= 1 ? 'text-emerald-400' : 'text-slate-500';
                    return (
                      <div {...wrapProps}>
                        <div className="bg-gradient-to-br from-orange-500/10 to-amber-600/5 rounded-xl border border-orange-500/20 p-4 h-full">
                          <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                            <Flame className="w-4 h-4 text-orange-400" /> Trading Streak
                          </h3>
                          <div className="text-center py-2">
                            <div className="text-3xl mb-1">{streakEmoji}</div>
                            <div className={`text-2xl font-bold ${streakColor}`}>{streak} Day{streak !== 1 ? 's' : ''}</div>
                            <div className="text-[10px] text-slate-400 mt-1">{streakLabel}</div>
                          </div>
                          <div className="flex items-center justify-between mt-3 pt-3 border-t border-slate-700/20">
                            <div className="text-center flex-1">
                              <div className="text-xs font-semibold text-slate-300">{trades.length}</div>
                              <div className="text-[10px] text-slate-500">Total Trades</div>
                            </div>
                            <div className="w-px h-6 bg-slate-700/30" />
                            <div className="text-center flex-1">
                              <div className="text-xs font-semibold text-emerald-400">{recentWins}/10</div>
                              <div className="text-[10px] text-slate-500">Last 10 Wins</div>
                            </div>
                          </div>
                          {streak === 0 && (
                            <button onClick={() => setActiveTab('journal')} className="w-full mt-3 text-xs text-orange-400 hover:text-orange-300 py-1.5 border border-orange-500/20 rounded-lg hover:bg-orange-500/10 transition-all">
                              Log a trade to start →
                            </button>
                          )}
                        </div>
                      </div>
                    );
                  }

                  // ─── Market Mood / Fear & Greed Estimate ─────────────────────
                  case 'feargreed': {
                    const spyData = marketData?.indices?.SPY || {};
                    const vixData = marketData?.vix || {};
                    const vixPrice = vixData.price || 0;
                    const spyChange = spyData.changePercent || 0;
                    // Individual factor scores for breakdown
                    let vixSignal = 'Neutral';
                    let vixPoints = 0;
                    if (vixPrice > 0) {
                      if (vixPrice < 15) { vixSignal = 'Very Low'; vixPoints = 25; }
                      else if (vixPrice < 20) { vixSignal = 'Low'; vixPoints = 15; }
                      else if (vixPrice < 25) { vixSignal = 'Normal'; vixPoints = 0; }
                      else if (vixPrice < 30) { vixSignal = 'Elevated'; vixPoints = -15; }
                      else { vixSignal = 'High'; vixPoints = -25; }
                    }
                    let spySignal = 'Flat';
                    let spyPoints = 0;
                    if (spyChange > 1) { spySignal = 'Strong Rally'; spyPoints = 15; }
                    else if (spyChange > 0.3) { spySignal = 'Up'; spyPoints = 8; }
                    else if (spyChange < -1) { spySignal = 'Sharp Drop'; spyPoints = -15; }
                    else if (spyChange < -0.3) { spySignal = 'Down'; spyPoints = -8; }
                    const gainCount = (hotStocks.gainers || []).length;
                    const loserCount = (hotStocks.losers || []).length;
                    let breadthSignal = 'Balanced';
                    let breadthPoints = 0;
                    if (gainCount > loserCount * 1.5) { breadthSignal = 'More Gainers'; breadthPoints = 5; }
                    else if (loserCount > gainCount * 1.5) { breadthSignal = 'More Losers'; breadthPoints = -5; }
                    const moodScore = Math.max(0, Math.min(100, 50 + vixPoints + spyPoints + breadthPoints));
                    const moodLabel = moodScore >= 75 ? 'Extreme Greed' : moodScore >= 60 ? 'Greed' : moodScore >= 45 ? 'Neutral' : moodScore >= 30 ? 'Fear' : 'Extreme Fear';
                    const moodColor = moodScore >= 75 ? 'text-emerald-400' : moodScore >= 60 ? 'text-green-400' : moodScore >= 45 ? 'text-yellow-400' : moodScore >= 30 ? 'text-orange-400' : 'text-red-400';
                    const moodBg = moodScore >= 75 ? 'from-emerald-500/20' : moodScore >= 60 ? 'from-green-500/15' : moodScore >= 45 ? 'from-yellow-500/15' : moodScore >= 30 ? 'from-orange-500/15' : 'from-red-500/20';
                    const moodBarColor = moodScore >= 75 ? 'bg-emerald-500' : moodScore >= 60 ? 'bg-green-500' : moodScore >= 45 ? 'bg-yellow-500' : moodScore >= 30 ? 'bg-orange-500' : 'bg-red-500';
                    const moodExplain = moodScore >= 75
                      ? 'Markets are very optimistic — investors are buying aggressively. Be cautious, this can signal a top.'
                      : moodScore >= 60
                      ? 'Markets are leaning bullish — confidence is above average. Good for riding trends, but watch for overextension.'
                      : moodScore >= 45
                      ? 'Markets are balanced — no strong bias either way. Wait for a clearer signal before making big moves.'
                      : moodScore >= 30
                      ? 'Markets are nervous — investors are pulling back. Potential buying opportunity if you have conviction.'
                      : 'Markets are in panic — heavy selling and high volatility. Historically, extreme fear can signal a bottom.';
                    return (
                      <div {...wrapProps}>
                        <div className={`bg-gradient-to-br ${moodBg} to-slate-900/0 rounded-xl border border-slate-700/20 p-4 h-full`}>
                          <h3 className="text-sm font-bold mb-2 flex items-center gap-2">
                            <Activity className="w-4 h-4 text-violet-400" /> Market Mood
                            <div className="relative ml-auto group">
                              <AlertCircle className="w-3.5 h-3.5 text-slate-500 cursor-help" />
                              <div className="absolute bottom-full right-0 mb-2 w-64 p-3 bg-slate-800 border border-slate-700/50 rounded-xl shadow-2xl text-[11px] text-slate-300 leading-relaxed opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50 pointer-events-none">
                                <div className="font-bold text-white mb-1.5">What is Market Mood?</div>
                                <p className="mb-2">A 0-100 score estimating overall market sentiment, similar to CNN's Fear &amp; Greed Index.</p>
                                <div className="space-y-1 text-[10px]">
                                  <div className="flex justify-between"><span className="text-red-400">0-29</span><span>Extreme Fear — markets panicking</span></div>
                                  <div className="flex justify-between"><span className="text-orange-400">30-44</span><span>Fear — investors are cautious</span></div>
                                  <div className="flex justify-between"><span className="text-yellow-400">45-59</span><span>Neutral — no strong bias</span></div>
                                  <div className="flex justify-between"><span className="text-green-400">60-74</span><span>Greed — bullish confidence</span></div>
                                  <div className="flex justify-between"><span className="text-emerald-400">75-100</span><span>Extreme Greed — possible top</span></div>
                                </div>
                                <div className="mt-2 pt-2 border-t border-slate-700/50 text-slate-500">Based on VIX, S&amp;P 500, and market breadth</div>
                                <div className="absolute bottom-[-6px] right-3 w-3 h-3 bg-slate-800 border-r border-b border-slate-700/50 transform rotate-45" />
                              </div>
                            </div>
                          </h3>
                          {/* Score + Label */}
                          <div className="text-center py-1">
                            <div className={`text-3xl font-bold ${moodColor}`}>{moodScore}</div>
                            <div className={`text-sm font-semibold ${moodColor} mt-0.5`}>{moodLabel}</div>
                          </div>
                          {/* Gauge bar with segment markers */}
                          <div className="mt-2 relative">
                            <div className="h-2.5 bg-slate-800/50 rounded-full overflow-hidden flex">
                              <div className="h-full bg-red-500/30 flex-1" />
                              <div className="h-full bg-orange-500/30 flex-1" />
                              <div className="h-full bg-yellow-500/30 flex-1" />
                              <div className="h-full bg-green-500/30 flex-1" />
                              <div className="h-full bg-emerald-500/30 flex-1" />
                            </div>
                            {/* Needle indicator */}
                            <div className="absolute top-0 h-2.5 flex items-center transition-all duration-700" style={{ left: `${moodScore}%`, transform: 'translateX(-50%)' }}>
                              <div className={`w-1 h-4 ${moodBarColor} rounded-full shadow-lg`} style={{ marginTop: '-2px' }} />
                            </div>
                            <div className="flex justify-between text-[8px] text-slate-600 mt-1 px-0.5">
                              <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
                            </div>
                          </div>
                          {/* What it means */}
                          <p className="text-[10px] text-slate-400 leading-relaxed mt-2 mb-2">{moodExplain}</p>
                          {/* Factor breakdown */}
                          <div className="space-y-1.5 pt-2 border-t border-slate-700/20">
                            <div className="flex items-center justify-between text-[10px]">
                              <span className="text-slate-500">VIX Volatility</span>
                              <span className={`font-medium ${vixPoints > 0 ? 'text-emerald-400' : vixPoints < 0 ? 'text-red-400' : 'text-slate-400'}`}>
                                {vixPrice > 0 ? vixPrice.toFixed(1) : '—'} · {vixSignal}
                              </span>
                            </div>
                            <div className="flex items-center justify-between text-[10px]">
                              <span className="text-slate-500">S&P 500 (SPY)</span>
                              <span className={`font-medium ${spyPoints > 0 ? 'text-emerald-400' : spyPoints < 0 ? 'text-red-400' : 'text-slate-400'}`}>
                                {spyChange >= 0 ? '+' : ''}{spyChange.toFixed(2)}% · {spySignal}
                              </span>
                            </div>
                            <div className="flex items-center justify-between text-[10px]">
                              <span className="text-slate-500">Market Breadth</span>
                              <span className={`font-medium ${breadthPoints > 0 ? 'text-emerald-400' : breadthPoints < 0 ? 'text-red-400' : 'text-slate-400'}`}>
                                {gainCount}G / {loserCount}L · {breadthSignal}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  }

                  // ─── Earnings Calendar Widget (Feature 1) ───
                  case 'earnings': {
                    const now = new Date();
                    const upcomingEarnings = earningsData.filter(e => e.date >= now).slice(0, 5);
                    const watchlistEarnings = upcomingEarnings.filter(e => watchlist.includes(e.ticker));
                    return (
                      <div {...wrapProps}>
                        <div className="bg-gradient-to-br from-amber-500/8 to-slate-900/0 rounded-xl p-4 border border-amber-500/10 hover:border-amber-500/20 transition-all">
                          <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                            <div className="p-1 bg-amber-500/15 rounded-md"><Calendar className="w-3.5 h-3.5 text-amber-400" /></div>
                            Earnings Calendar
                            {watchlistEarnings.length > 0 && (
                              <span className="text-[9px] bg-amber-500/15 text-amber-400 px-1.5 py-0.5 rounded-full font-medium ml-auto">{watchlistEarnings.length} on watchlist</span>
                            )}
                          </h3>
                          {upcomingEarnings.length > 0 ? (
                            <div className="space-y-1.5">
                              {upcomingEarnings.map((e, i) => {
                                const daysDiff = Math.ceil((e.date - now) / 86400000);
                                const dayLabel = daysDiff === 0 ? 'TDY' : daysDiff === 1 ? '1D' : `${daysDiff}D`;
                                const isOnWatchlist = watchlist.includes(e.ticker);
                                const urgencyColor = daysDiff <= 1 ? 'bg-red-500/20 text-red-400 border-red-500/20' : daysDiff <= 3 ? 'bg-amber-500/15 text-amber-400 border-amber-500/15' : 'bg-slate-700/30 text-slate-400 border-slate-700/20';
                                return (
                                  <button key={i} onClick={() => { setTickerSymbol(e.ticker); setActiveTab('ticker'); }}
                                    className={`w-full flex items-center gap-2.5 p-2.5 rounded-lg text-left transition-all hover:bg-slate-800/40 border ${isOnWatchlist ? 'border-amber-500/15 bg-amber-500/5' : 'border-slate-700/10 hover:border-amber-500/10'}`}>
                                    <div className={`w-9 h-9 rounded-lg flex items-center justify-center text-[10px] font-extrabold border ${urgencyColor}`}>
                                      {dayLabel}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                      <div className="flex items-center gap-1.5">
                                        <span className="text-xs font-bold text-white">{e.ticker}</span>
                                        <span className={`text-[8px] px-1 py-0.5 rounded-md font-medium ${e.time === 'BMO' ? 'bg-sky-500/15 text-sky-400' : 'bg-violet-500/15 text-violet-400'}`}>{e.time === 'BMO' ? 'Pre-Mkt' : 'After-Hrs'}</span>
                                        {isOnWatchlist && <Eye className="w-3 h-3 text-amber-400" />}
                                      </div>
                                      <div className="text-[10px] text-slate-500 truncate">{e.company}</div>
                                    </div>
                                    <div className="text-right">
                                      <div className="text-[9px] text-slate-500 uppercase">Est. EPS</div>
                                      <div className="text-xs font-bold text-emerald-400">{e.estEPS}</div>
                                    </div>
                                  </button>
                                );
                              })}
                            </div>
                          ) : (
                            <div className="text-center py-4">
                              <div className="w-12 h-12 mx-auto mb-2 rounded-full bg-amber-500/10 flex items-center justify-center"><Calendar className="w-6 h-6 text-amber-500/40" /></div>
                              <p className="text-xs text-slate-400">No upcoming earnings</p>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  }

                  // ─── Risk Dashboard Widget (Feature 3) ───
                  case 'risk': {
                    const riskColor = dashRiskMetrics.riskScore <= 30 ? 'text-emerald-400' : dashRiskMetrics.riskScore <= 60 ? 'text-amber-400' : 'text-red-400';
                    const riskBarColor = dashRiskMetrics.riskScore <= 30 ? 'bg-emerald-500' : dashRiskMetrics.riskScore <= 60 ? 'bg-amber-500' : 'bg-red-500';
                    const riskLabel = dashRiskMetrics.riskScore <= 30 ? 'Low Risk' : dashRiskMetrics.riskScore <= 60 ? 'Moderate' : 'High Risk';
                    const riskGrad = dashRiskMetrics.riskScore <= 30 ? 'from-emerald-500/8' : dashRiskMetrics.riskScore <= 60 ? 'from-amber-500/8' : 'from-red-500/8';
                    return (
                      <div {...wrapProps}>
                        <div className={`bg-gradient-to-br ${riskGrad} to-slate-900/0 rounded-xl p-4 border border-slate-700/10 hover:border-violet-500/20 transition-all`}>
                          <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                            <div className="p-1 bg-blue-500/15 rounded-md"><Shield className="w-3.5 h-3.5 text-blue-400" /></div>
                            Risk Dashboard
                          </h3>
                          {trades.length > 0 ? (
                            <div className="space-y-3">
                              {/* Risk Score */}
                              <div className="text-center">
                                <div className={`text-2xl font-bold ${riskColor}`}>{dashRiskMetrics.riskScore}</div>
                                <div className={`text-xs font-semibold ${riskColor}`}>{riskLabel}</div>
                                <div className="mt-1.5 h-1.5 bg-slate-700/30 rounded-full overflow-hidden">
                                  <div className={`h-full ${riskBarColor} rounded-full transition-all duration-700`} style={{ width: `${dashRiskMetrics.riskScore}%` }} />
                                </div>
                              </div>
                              {/* Metrics Grid */}
                              <div className="grid grid-cols-2 gap-2 pt-2 border-t border-slate-700/20">
                                <div>
                                  <div className="text-[10px] text-slate-500 uppercase">Exposure</div>
                                  <div className="text-sm font-bold text-white">${dashRiskMetrics.exposure.toLocaleString()}</div>
                                </div>
                                <div>
                                  <div className="text-[10px] text-slate-500 uppercase">Open Pos.</div>
                                  <div className="text-sm font-bold text-white">{dashRiskMetrics.openPositions}</div>
                                </div>
                                <div>
                                  <div className="text-[10px] text-slate-500 uppercase">Concentration</div>
                                  <div className={`text-sm font-bold ${dashRiskMetrics.concentration > 50 ? 'text-red-400' : 'text-white'}`}>{dashRiskMetrics.concentration.toFixed(1)}%</div>
                                </div>
                                <div>
                                  <div className="text-[10px] text-slate-500 uppercase">Max Drawdown</div>
                                  <div className={`text-sm font-bold ${dashRiskMetrics.maxDrawdown > 20 ? 'text-red-400' : 'text-amber-400'}`}>{dashRiskMetrics.maxDrawdown.toFixed(1)}%</div>
                                </div>
                              </div>
                            </div>
                          ) : (
                            <div className="text-center py-4">
                              <Shield className="w-8 h-8 text-slate-700 mx-auto mb-2" />
                              <p className="text-xs text-slate-500 mb-2">Log trades to see risk metrics</p>
                              <button onClick={() => setActiveTab('journal')} className="text-[10px] text-violet-400 hover:text-violet-300 border border-violet-500/20 px-2.5 py-1 rounded-lg transition-all">
                                Open Journal
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  }

                  // ─── Price Target Tracking Widget (Feature 5) ───
                  case 'pricetargets': {
                    const activeTargets = priceTargets.filter(t => t.status === 'active').slice(0, 5);
                    const hitCount = priceTargets.filter(t => t.status === 'hit').length;
                    const totalTracked = priceTargets.filter(t => t.status !== 'active').length;
                    const hitRate = totalTracked > 0 ? Math.round((hitCount / totalTracked) * 100) : 0;
                    return (
                      <div {...wrapProps}>
                        <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-700/20 hover:border-violet-500/20 transition-all">
                          <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                            <Target className="w-4 h-4 text-violet-400" />
                            Price Targets
                            {totalTracked > 0 && (
                              <span className={`text-[9px] px-1.5 py-0.5 rounded-full font-medium ${hitRate >= 60 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`}>{hitRate}% hit rate</span>
                            )}
                          </h3>
                          {activeTargets.length > 0 ? (
                            <div className="space-y-2">
                              {activeTargets.map((t, i) => {
                                const isUp = t.verdict?.toLowerCase()?.includes('buy') || t.verdict?.toLowerCase()?.includes('bullish');
                                return (
                                  <div key={t.id || i} className="flex items-center gap-2 p-2 rounded-lg bg-slate-700/20">
                                    <div className={`text-xs font-bold ${isUp ? 'text-emerald-400' : 'text-red-400'}`}>{t.ticker}</div>
                                    <div className="flex-1">
                                      <div className="flex items-center gap-1 text-[10px]">
                                        <span className="text-slate-500">Entry:</span>
                                        <span className="text-slate-300">${parseFloat(t.entryPrice).toFixed(2)}</span>
                                        <span className="text-slate-600 mx-0.5">→</span>
                                        <span className="text-emerald-400">${t.targetPrice?.toFixed(2)}</span>
                                      </div>
                                      <div className="text-[9px] text-slate-500">{new Date(t.createdAt).toLocaleDateString()}</div>
                                    </div>
                                    <div className={`text-[9px] font-semibold px-1.5 py-0.5 rounded ${isUp ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                                      {t.confidence}%
                                    </div>
                                  </div>
                                );
                              })}
                              {priceTargets.length > 5 && <div className="text-[10px] text-slate-500 text-center">+{priceTargets.length - 5} more targets</div>}
                            </div>
                          ) : (
                            <div className="text-center py-4">
                              <Target className="w-8 h-8 text-slate-700 mx-auto mb-2" />
                              <p className="text-xs text-slate-500 mb-2">Run Quick Analysis to track targets</p>
                              <button onClick={() => setActiveTab('quickanalysis')} className="text-[10px] text-violet-400 hover:text-violet-300 border border-violet-500/20 px-2.5 py-1 rounded-lg transition-all">
                                Quick Analysis
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  }

                  // ─── Community Feed Widget (Feature 4) ───
                  case 'socialfeed': {
                    const recentPosts = socialFeed.slice(0, 4);
                    return (
                      <div {...wrapProps}>
                        <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-700/20 hover:border-violet-500/20 transition-all">
                          <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                            <MessageCircle className="w-4 h-4 text-cyan-400" />
                            Community Feed
                            {socialFeed.length > 0 && <span className="text-[9px] bg-cyan-500/20 text-cyan-400 px-1.5 py-0.5 rounded-full">{socialFeed.length}</span>}
                          </h3>
                          {recentPosts.length > 0 ? (
                            <div className="space-y-2">
                              {recentPosts.map((post, i) => (
                                <div key={post.id || i} className="p-2 rounded-lg bg-slate-700/20">
                                  <div className="flex items-center gap-2 mb-1">
                                    <div className="w-5 h-5 rounded-full bg-gradient-to-br from-violet-500 to-cyan-500 flex items-center justify-center text-[9px] font-bold text-white">{post.avatar}</div>
                                    <span className="text-[10px] font-semibold text-white">{post.user}</span>
                                    <span className="text-[9px] text-slate-500 ml-auto">{new Date(post.timestamp).toLocaleDateString()}</span>
                                  </div>
                                  {post.ticker && <div className={`text-xs font-bold ${post.verdict?.toLowerCase().includes('buy') ? 'text-emerald-400' : 'text-red-400'}`}>{post.ticker} — {post.verdict}</div>}
                                  {post.text && <div className="text-[10px] text-slate-400 line-clamp-2">{post.text}</div>}
                                </div>
                              ))}
                            </div>
                          ) : (
                            <div className="text-center py-4">
                              <MessageCircle className="w-8 h-8 text-slate-700 mx-auto mb-2" />
                              <p className="text-xs text-slate-500 mb-1">No shared analyses yet</p>
                              <p className="text-[10px] text-slate-600">Share from Quick Analysis to post here</p>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  }

                  // ─── Sector Heatmap ─────────────────────
                  case 'sectorheatmap': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-emerald-500/8 to-slate-900/0 rounded-xl border border-emerald-500/10 p-4 h-full hover:border-emerald-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-emerald-500/15 rounded-md"><BarChart2 className="w-3.5 h-3.5 text-emerald-400" /></div>
                          Sector Allocation
                        </h3>
                        {sectorHeatmapData.length === 0 ? (
                          <div className="text-center py-4"><BarChart2 className="w-8 h-8 text-slate-700 mx-auto mb-2" /><p className="text-xs text-slate-500">Execute trades to see sector breakdown</p></div>
                        ) : (
                          <div className="space-y-2 max-h-40 overflow-y-auto">
                            {sectorHeatmapData.map((s, i) => {
                              const maxVol = Math.max(...sectorHeatmapData.map(x => x.volume), 1);
                              return (
                                <div key={i} className="space-y-1">
                                  <div className="flex items-center justify-between text-[11px]">
                                    <span className="font-medium text-slate-200">{s.name} <span className="text-slate-500">({s.count})</span></span>
                                    <span className={s.color === 'emerald' ? 'text-emerald-400' : 'text-red-400'}>{s.pnl >= 0 ? '+' : ''}${s.pnl.toFixed(0)}</span>
                                  </div>
                                  <div className="h-1.5 bg-slate-700/30 rounded-full overflow-hidden">
                                    <div className={`h-full rounded-full ${s.color === 'emerald' ? 'bg-emerald-500/60' : 'bg-red-500/60'}`} style={{width: `${(s.volume / maxVol * 100).toFixed(0)}%`}} />
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // ─── Economic Calendar ─────────────────────
                  case 'econevents': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-cyan-500/8 to-slate-900/0 rounded-xl border border-cyan-500/10 p-4 h-full hover:border-cyan-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-cyan-500/15 rounded-md"><Calendar className="w-3.5 h-3.5 text-cyan-400" /></div>
                          Economic Calendar
                        </h3>
                        <div className="space-y-1.5 max-h-48 overflow-y-auto">
                          {econEvents.slice(0, 5).map((evt, i) => {
                            const evtDate = new Date(evt.date);
                            const daysUntil = Math.ceil((evtDate - new Date()) / 86400000);
                            const dateLabel = daysUntil <= 0 ? 'Today' : daysUntil === 1 ? 'Tmrw' : `${daysUntil}D`;
                            return (
                              <div key={i} className="px-2 py-1.5 bg-slate-800/20 rounded-lg border border-slate-700/15">
                                <div className="flex items-center justify-between mb-0.5">
                                  <span className="text-[11px] font-medium text-slate-200 flex-1">{evt.event}</span>
                                  <div className="flex items-center gap-1.5">
                                    <span className={`text-[8px] px-1.5 py-0.5 rounded font-bold uppercase ${evt.impact === 'high' ? 'bg-red-500/20 text-red-400' : evt.impact === 'medium' ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-600/30 text-slate-500'}`}>{evt.impact}</span>
                                    <span className={`text-[9px] px-1.5 py-0.5 rounded font-medium ${daysUntil <= 1 ? 'bg-red-500/15 text-red-400' : daysUntil <= 3 ? 'bg-amber-500/15 text-amber-400' : 'bg-slate-700/30 text-slate-500'}`}>{dateLabel}</span>
                                  </div>
                                </div>
                                <div className="flex justify-between text-[9px] text-slate-500">
                                  <span>{evt.date} • {evt.time}</span>
                                  <span>Est: {evt.forecast} | Prev: {evt.previous}</span>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  );

                  // ─── Pre-Market Movers ─────────────────────
                  case 'premarket': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-blue-500/8 to-slate-900/0 rounded-xl border border-blue-500/10 p-4 h-full hover:border-blue-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-blue-500/15 rounded-md"><TrendingUp className="w-3.5 h-3.5 text-blue-400" /></div>
                          Pre-Market Movers
                        </h3>
                        <div className="grid grid-cols-2 gap-1.5">
                          <div>
                            <div className="text-[9px] text-emerald-400 font-bold mb-1 uppercase">Gainers</div>
                            {(preMarketMovers || []).filter(m => m && m.type === 'gainer').map((m, i) => (
                              <div key={i} className="flex items-center justify-between px-2 py-1 rounded-lg hover:bg-slate-800/40 cursor-pointer" onClick={() => { setTickerSymbol(m.ticker); setActiveTab('ticker'); }}>
                                <span className="text-[11px] font-medium">{m.ticker}</span>
                                <span className="text-[10px] font-bold text-emerald-400">+{(m.changePercent ?? 0).toFixed(1)}%</span>
                              </div>
                            ))}
                          </div>
                          <div>
                            <div className="text-[9px] text-red-400 font-bold mb-1 uppercase">Losers</div>
                            {(preMarketMovers || []).filter(m => m && m.type === 'loser').map((m, i) => (
                              <div key={i} className="flex items-center justify-between px-2 py-1 rounded-lg hover:bg-slate-800/40 cursor-pointer" onClick={() => { setTickerSymbol(m.ticker); setActiveTab('ticker'); }}>
                                <span className="text-[11px] font-medium">{m.ticker}</span>
                                <span className="text-[10px] font-bold text-red-400">{(m.changePercent ?? 0).toFixed(1)}%</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                  );

                  // ─── Correlation Matrix ─────────────────────
                  case 'correlation': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-orange-500/8 to-slate-900/0 rounded-xl border border-orange-500/10 p-4 h-full hover:border-orange-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-orange-500/15 rounded-md"><BarChart2 className="w-3.5 h-3.5 text-orange-400" /></div>
                          Correlations
                        </h3>
                        {correlationPairs.length === 0 ? (
                          <div className="text-center py-4"><BarChart2 className="w-8 h-8 text-slate-700 mx-auto mb-2" /><p className="text-xs text-slate-500">Add 2+ stocks to watchlist</p></div>
                        ) : (
                          <div className="space-y-1.5 max-h-40 overflow-y-auto">
                            {correlationPairs.slice(0, 6).map((p, i) => (
                              <div key={i} className="flex items-center justify-between px-2 py-1 bg-slate-800/20 rounded-lg text-[10px]">
                                <span className="text-slate-300 font-medium">{p.ticker1}/{p.ticker2}</span>
                                <div className="flex items-center gap-1.5">
                                  <div className="w-10 h-1.5 bg-slate-700/40 rounded-full overflow-hidden">
                                    <div className={`h-full rounded-full ${p.correlation > 0 ? 'bg-emerald-500/60' : 'bg-red-500/60'}`} style={{width: `${Math.abs(p.correlation) * 100}%`}} />
                                  </div>
                                  <span className={`font-semibold ${p.correlation > 0 ? 'text-emerald-400' : 'text-red-400'}`}>{p.correlation.toFixed(2)}</span>
                                  <span className={`text-[8px] px-1 py-0.5 rounded ${p.strength === 'strong' ? 'bg-violet-500/20 text-violet-400' : p.strength === 'medium' ? 'bg-slate-600/30 text-slate-400' : 'bg-slate-700/20 text-slate-500'}`}>{p.strength}</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // ─── Position Performance ─────────────────────
                  case 'portfolioheatmap': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-amber-500/8 to-slate-900/0 rounded-xl border border-amber-500/10 p-4 h-full hover:border-amber-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-amber-500/15 rounded-md"><PieChart className="w-3.5 h-3.5 text-amber-400" /></div>
                          Position Performance
                        </h3>
                        {portfolioHeatmap.length === 0 ? (
                          <div className="text-center py-4"><PieChart className="w-8 h-8 text-slate-700 mx-auto mb-2" /><p className="text-xs text-slate-500">Log trades to see position P&L</p></div>
                        ) : (
                          <div className="grid grid-cols-2 gap-1.5 max-h-40 overflow-y-auto">
                            {portfolioHeatmap.slice(0, 8).map((pos, i) => (
                              <div key={i} className={`p-2 rounded-lg border cursor-pointer hover:scale-[1.02] transition-all ${pos.color === 'emerald' ? 'bg-emerald-500/8 border-emerald-500/20' : 'bg-red-500/8 border-red-500/20'}`}
                                onClick={() => { setTickerSymbol(pos.name); setActiveTab('ticker'); }}>
                                <div className="text-[11px] font-bold text-slate-200">{pos.name}</div>
                                <div className={`text-[10px] font-semibold ${pos.color === 'emerald' ? 'text-emerald-400' : 'text-red-400'}`}>{pos.pnl >= 0 ? '+' : ''}${pos.pnl.toFixed(0)}</div>
                                <div className="text-[8px] text-slate-500">{pos.count} trades</div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // ─── Dividend Calendar ─────────────────────
                  case 'dividends': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-rose-500/8 to-slate-900/0 rounded-xl border border-rose-500/10 p-4 h-full hover:border-rose-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-rose-500/15 rounded-md"><DollarSign className="w-3.5 h-3.5 text-rose-400" /></div>
                          Dividend Calendar
                        </h3>
                        {dividends.length === 0 ? (
                          <div className="text-center py-4"><DollarSign className="w-8 h-8 text-slate-700 mx-auto mb-2" /><p className="text-xs text-slate-500">No upcoming dividends tracked</p></div>
                        ) : (
                          <div className="space-y-1.5 max-h-48 overflow-y-auto">
                            {dividends.map((d, i) => {
                              const daysUntil = Math.ceil((new Date(d.exDate) - new Date()) / 86400000);
                              return (
                                <div key={i} className="px-2 py-1.5 bg-slate-800/20 rounded-lg border border-slate-700/15 flex items-center justify-between">
                                  <div>
                                    <div className="text-[11px] font-medium text-slate-200">{d.ticker}</div>
                                    <div className="text-[9px] text-slate-500">Ex: {d.exDate}</div>
                                  </div>
                                  <div className="text-right">
                                    <div className="text-[11px] font-semibold text-rose-400">${d.dividend.toFixed(2)}</div>
                                    <div className="text-[9px] text-slate-500">{d.yield}% yield • {daysUntil > 0 ? `${daysUntil}D` : 'Past'}</div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // ─── What-If Simulator ─────────────────────
                  case 'whatif': {
                    const wPnL = (whatIfParams.direction === 'long' ? whatIfParams.exitPrice - whatIfParams.entryPrice : whatIfParams.entryPrice - whatIfParams.exitPrice) * whatIfParams.shares;
                    const wPct = whatIfParams.entryPrice > 0 ? (wPnL / (whatIfParams.entryPrice * whatIfParams.shares) * 100).toFixed(2) : '0';
                    return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-indigo-500/8 to-slate-900/0 rounded-xl border border-indigo-500/10 p-4 h-full hover:border-indigo-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-2 flex items-center gap-2">
                          <div className="p-1 bg-indigo-500/15 rounded-md"><Target className="w-3.5 h-3.5 text-indigo-400" /></div>
                          What-If Simulator
                        </h3>
                        <div className="grid grid-cols-2 gap-1.5 text-[10px] mb-2">
                          <div>
                            <label className="text-slate-500 block mb-0.5">Entry $</label>
                            <input type="number" value={whatIfParams.entryPrice} onChange={e => setWhatIfParams(p => ({...p, entryPrice: +e.target.value || 0}))} className="w-full bg-slate-800/50 border border-slate-700/30 rounded px-2 py-1 text-white text-[10px]" />
                          </div>
                          <div>
                            <label className="text-slate-500 block mb-0.5">Exit $</label>
                            <input type="number" value={whatIfParams.exitPrice} onChange={e => setWhatIfParams(p => ({...p, exitPrice: +e.target.value || 0}))} className="w-full bg-slate-800/50 border border-slate-700/30 rounded px-2 py-1 text-white text-[10px]" />
                          </div>
                          <div>
                            <label className="text-slate-500 block mb-0.5">Shares</label>
                            <input type="number" value={whatIfParams.shares} onChange={e => setWhatIfParams(p => ({...p, shares: +e.target.value || 0}))} className="w-full bg-slate-800/50 border border-slate-700/30 rounded px-2 py-1 text-white text-[10px]" />
                          </div>
                          <div>
                            <label className="text-slate-500 block mb-0.5">Direction</label>
                            <select value={whatIfParams.direction} onChange={e => setWhatIfParams(p => ({...p, direction: e.target.value}))} className="w-full bg-slate-800/50 border border-slate-700/30 rounded px-2 py-1 text-white text-[10px]">
                              <option value="long">Long</option><option value="short">Short</option>
                            </select>
                          </div>
                        </div>
                        <div className={`p-2 rounded-lg text-center ${wPnL >= 0 ? 'bg-emerald-500/10 border border-emerald-500/20' : 'bg-red-500/10 border border-red-500/20'}`}>
                          <div className={`text-lg font-bold ${wPnL >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{wPnL >= 0 ? '+' : ''}${wPnL.toFixed(2)}</div>
                          <div className="text-[10px] text-slate-400">{wPnL >= 0 ? '+' : ''}{wPct}% return</div>
                        </div>
                      </div>
                    </div>
                    );
                  }

                  // ─── Mistake Tracker ─────────────────────
                  case 'mistakes': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-red-500/8 to-slate-900/0 rounded-xl border border-red-500/10 p-4 h-full hover:border-red-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-red-500/15 rounded-md"><AlertTriangle className="w-3.5 h-3.5 text-red-400" /></div>
                          Mistake Tracker
                          <button onClick={() => setTradeMistakes(prev => [...prev, { category: 'FOMO', description: 'Chased entry after missing setup', timestamp: new Date().toISOString() }])} className="ml-auto text-[9px] text-red-400 hover:text-red-300 border border-red-500/20 px-1.5 py-0.5 rounded transition-all">+ Log</button>
                        </h3>
                        {tradeMistakes.length === 0 ? (
                          <div className="text-center py-4"><AlertTriangle className="w-8 h-8 text-slate-700 mx-auto mb-2" /><p className="text-xs text-slate-500">No mistakes logged — great discipline!</p></div>
                        ) : (
                          <div className="space-y-1.5 max-h-40 overflow-y-auto">
                            {tradeMistakes.slice(-5).reverse().map((m, i) => (
                              <div key={i} className="px-2 py-1.5 bg-slate-800/20 rounded-lg border border-red-500/10">
                                <div className="flex items-center justify-between">
                                  <span className="text-[10px] font-bold text-red-400">{m.category}</span>
                                  <span className="text-[8px] text-slate-500">{new Date(m.timestamp).toLocaleDateString()}</span>
                                </div>
                                <p className="text-[10px] text-slate-400 mt-0.5">{m.description}</p>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // ─── AI Trade Coach ─────────────────────
                  case 'coach': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-violet-500/8 to-slate-900/0 rounded-xl border border-violet-500/10 p-4 h-full hover:border-violet-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-violet-500/15 rounded-md"><Brain className="w-3.5 h-3.5 text-violet-400" /></div>
                          Trade Coach
                          <button onClick={() => setCoachMode(!coachMode)} className={`ml-auto text-[9px] px-2 py-0.5 rounded-full font-medium transition-all ${coachMode ? 'bg-violet-600 text-white' : 'bg-slate-700/50 text-slate-400'}`}>{coachMode ? 'ON' : 'OFF'}</button>
                        </h3>
                        {!coachMode ? (
                          <div className="text-center py-4"><Brain className="w-8 h-8 text-slate-700 mx-auto mb-2" /><p className="text-xs text-slate-500 mb-2">Toggle coach for trading insights</p><button onClick={() => setCoachMode(true)} className="text-[10px] text-violet-400 hover:text-violet-300 border border-violet-500/20 px-2.5 py-1 rounded-lg transition-all">Enable Coach</button></div>
                        ) : (
                          <div className="space-y-1.5 max-h-40 overflow-y-auto">
                            {coachMessages.map((msg, i) => (
                              <div key={i} className={`px-2 py-1.5 rounded-lg text-[10px] leading-relaxed ${msg.type === 'warning' ? 'bg-amber-500/10 border border-amber-500/15 text-amber-200' : 'bg-emerald-500/8 border border-emerald-500/15 text-emerald-200'}`}>
                                <span className="mr-1">{msg.type === 'warning' ? '⚠️' : '💡'}</span>{msg.message}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // ─── Pattern Scanner ─────────────────────
                  case 'patterns': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-teal-500/8 to-slate-900/0 rounded-xl border border-teal-500/10 p-4 h-full hover:border-teal-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-teal-500/15 rounded-md"><BarChart2 className="w-3.5 h-3.5 text-teal-400" /></div>
                          Chart Patterns
                        </h3>
                        <div className="space-y-1.5 max-h-40 overflow-y-auto">
                          {patternResults.map((r, i) => (
                            <div key={i} className="px-2 py-1.5 bg-slate-800/20 rounded-lg border border-slate-700/15 flex items-center justify-between cursor-pointer hover:bg-slate-800/40" onClick={() => { setTickerSymbol(r.ticker); setActiveTab('ticker'); }}>
                              <div>
                                <div className="text-[11px] font-medium text-slate-200">{r.ticker} — {r.pattern}</div>
                                <div className="text-[9px] text-slate-500">{r.timeframe} timeframe</div>
                              </div>
                              <div className={`text-[11px] font-bold px-1.5 py-0.5 rounded ${r.confidence >= 80 ? 'bg-emerald-500/15 text-emerald-400' : r.confidence >= 60 ? 'bg-amber-500/15 text-amber-400' : 'bg-slate-600/20 text-slate-400'}`}>{r.confidence}%</div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  );

                  // ─── Sentiment Pulse ─────────────────────
                  case 'sentiment': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-pink-500/8 to-slate-900/0 rounded-xl border border-pink-500/10 p-4 h-full hover:border-pink-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-pink-500/15 rounded-md"><Flame className="w-3.5 h-3.5 text-pink-400" /></div>
                          Sentiment Pulse
                        </h3>
                        {sentimentData.total === 0 ? (
                          <div className="text-center py-4"><Flame className="w-8 h-8 text-slate-700 mx-auto mb-2" /><p className="text-xs text-slate-500">Load news to see sentiment</p></div>
                        ) : (
                          <div className="space-y-3">
                            {[{ label: 'Bullish', count: sentimentData.bullish, color: 'emerald' }, { label: 'Bearish', count: sentimentData.bearish, color: 'red' }, { label: 'Neutral', count: sentimentData.neutral, color: 'slate' }].map(s => (
                              <div key={s.label}>
                                <div className="flex justify-between mb-1 text-[10px]">
                                  <span className="text-slate-400">{s.label}</span>
                                  <span className={`font-semibold text-${s.color}-400`}>{s.count} ({sentimentData.total > 0 ? (s.count / sentimentData.total * 100).toFixed(0) : 0}%)</span>
                                </div>
                                <div className="h-2 bg-slate-700/30 rounded-full overflow-hidden">
                                  <div className={`h-full rounded-full bg-${s.color}-500/60 transition-all duration-500`} style={{width: `${sentimentData.total > 0 ? s.count / sentimentData.total * 100 : 0}%`}} />
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  // ─── Position Sizing ─────────────────────
                  case 'positionsize': {
                    const riskAmt = positionSizeParams.accountSize * positionSizeParams.riskPercent / 100;
                    const riskPerShare = Math.abs(positionSizeParams.entryPrice - positionSizeParams.stopLoss);
                    const recShares = riskPerShare > 0 ? Math.floor(riskAmt / riskPerShare) : 0;
                    const posValue = recShares * positionSizeParams.entryPrice;
                    return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-lime-500/8 to-slate-900/0 rounded-xl border border-lime-500/10 p-4 h-full hover:border-lime-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-2 flex items-center gap-2">
                          <div className="p-1 bg-lime-500/15 rounded-md"><Calculator className="w-3.5 h-3.5 text-lime-400" /></div>
                          Position Sizing
                        </h3>
                        <div className="grid grid-cols-2 gap-1.5 text-[10px] mb-2">
                          <div><label className="text-slate-500">Account $</label><input type="number" value={positionSizeParams.accountSize} onChange={e => setPositionSizeParams(p => ({...p, accountSize: +e.target.value || 0}))} className="w-full bg-slate-800/50 border border-slate-700/30 rounded px-1.5 py-1 text-white text-[10px] mt-0.5" /></div>
                          <div><label className="text-slate-500">Risk %</label><input type="number" value={positionSizeParams.riskPercent} onChange={e => setPositionSizeParams(p => ({...p, riskPercent: +e.target.value || 0}))} className="w-full bg-slate-800/50 border border-slate-700/30 rounded px-1.5 py-1 text-white text-[10px] mt-0.5" step="0.5" /></div>
                          <div><label className="text-slate-500">Entry $</label><input type="number" value={positionSizeParams.entryPrice} onChange={e => setPositionSizeParams(p => ({...p, entryPrice: +e.target.value || 0}))} className="w-full bg-slate-800/50 border border-slate-700/30 rounded px-1.5 py-1 text-white text-[10px] mt-0.5" /></div>
                          <div><label className="text-slate-500">Stop $</label><input type="number" value={positionSizeParams.stopLoss} onChange={e => setPositionSizeParams(p => ({...p, stopLoss: +e.target.value || 0}))} className="w-full bg-slate-800/50 border border-slate-700/30 rounded px-1.5 py-1 text-white text-[10px] mt-0.5" /></div>
                        </div>
                        <div className="bg-lime-500/8 border border-lime-500/15 rounded-lg p-2 text-center">
                          <div className="text-[10px] text-slate-400 mb-0.5">Recommended Size</div>
                          <div className="text-lg font-bold text-lime-400">{recShares} shares</div>
                          <div className="text-[9px] text-slate-500">${posValue.toLocaleString()} position • ${riskAmt.toFixed(0)} risk</div>
                        </div>
                      </div>
                    </div>
                    );
                  }

                  // ─── Monthly P&L Calendar ─────────────────────
                  case 'monthlypl': {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = now.getMonth();
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const calDays = [];
                    for (let d = 0; d < firstDay; d++) calDays.push(null);
                    for (let d = 1; d <= daysInMonth; d++) calDays.push(d);
                    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-fuchsia-500/8 to-slate-900/0 rounded-xl border border-fuchsia-500/10 p-4 h-full hover:border-fuchsia-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-2 flex items-center gap-2">
                          <div className="p-1 bg-fuchsia-500/15 rounded-md"><Calendar className="w-3.5 h-3.5 text-fuchsia-400" /></div>
                          {monthNames[month]} P&L
                        </h3>
                        <div className="grid grid-cols-7 gap-0.5 text-[8px]">
                          {['S','M','T','W','T','F','S'].map((d,i) => <div key={i} className="text-center text-slate-500 font-bold py-0.5">{d}</div>)}
                          {calDays.map((day, i) => {
                            if (!day) return <div key={i} />;
                            const key = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                            const pnl = monthlyPnL[key] || 0;
                            const isToday = day === now.getDate();
                            return (
                              <div key={i} className={`text-center py-1 rounded ${isToday ? 'ring-1 ring-fuchsia-500/50' : ''} ${pnl > 0 ? 'bg-emerald-500/20 text-emerald-400' : pnl < 0 ? 'bg-red-500/20 text-red-400' : 'text-slate-600'}`}>
                                <div className="font-semibold">{day}</div>
                                {pnl !== 0 && <div className="text-[7px]">{pnl > 0 ? '+' : ''}{pnl.toFixed(0)}</div>}
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                    );
                  }

                  // ─── Weekly Report ─────────────────────
                  case 'weeklyreport': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-cyan-500/8 to-slate-900/0 rounded-xl border border-cyan-500/10 p-4 h-full hover:border-cyan-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-cyan-500/15 rounded-md"><BarChart2 className="w-3.5 h-3.5 text-cyan-400" /></div>
                          This Week
                        </h3>
                        {weeklyReport.tradeCount === 0 ? (
                          <div className="text-center py-4"><BarChart2 className="w-8 h-8 text-slate-700 mx-auto mb-2" /><p className="text-xs text-slate-500">No trades this week yet</p></div>
                        ) : (
                          <div className="space-y-1.5">
                            <div className="flex justify-between items-center p-2 bg-slate-800/20 rounded-lg text-[11px]"><span className="text-slate-400">Trades</span><span className="text-white font-bold">{weeklyReport.tradeCount}</span></div>
                            <div className="flex justify-between items-center p-2 bg-slate-800/20 rounded-lg text-[11px]"><span className="text-slate-400">Win Rate</span><span className={`font-bold ${parseFloat(weeklyReport.winRate) >= 50 ? 'text-emerald-400' : 'text-red-400'}`}>{weeklyReport.winRate}%</span></div>
                            <div className="flex justify-between items-center p-2 bg-slate-800/20 rounded-lg text-[11px]"><span className="text-slate-400">W/L</span><span className="font-bold"><span className="text-emerald-400">{weeklyReport.wins}W</span> / <span className="text-red-400">{weeklyReport.losses}L</span></span></div>
                            <div className={`p-2 rounded-lg text-center ${parseFloat(weeklyReport.totalPnL) >= 0 ? 'bg-emerald-500/10 border border-emerald-500/15' : 'bg-red-500/10 border border-red-500/15'}`}>
                              <div className="text-[10px] text-slate-400">Total P&L</div>
                              <div className={`text-lg font-bold ${parseFloat(weeklyReport.totalPnL) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>${weeklyReport.totalPnL}</div>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  );

                  case 'equitycurve': {
                    const eqData = trades.length > 0 ? trades.sort((a,b) => new Date(a.date) - new Date(b.date)).reduce((acc, t) => {
                      const pnl = t.type === 'sell' ? ((t.exitPrice || t.price) - t.price) * (t.shares || 1) : t.pnl || 0;
                      const cumPnl = (acc.length > 0 ? acc[acc.length-1].cumPnl : 0) + pnl;
                      return [...acc, { date: t.date, cumPnl }];
                    }, []) : [];
                    const maxPnl = Math.max(...eqData.map(d => d.cumPnl), 1);
                    const minPnl = Math.min(...eqData.map(d => d.cumPnl), 0);
                    const range = maxPnl - minPnl || 1;
                    return (
                      <div {...wrapProps}>
                        <div className="bg-gradient-to-br from-sky-500/8 to-slate-900/0 rounded-xl border border-sky-500/10 p-4 h-full hover:border-sky-500/20 transition-all">
                          <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                            <div className="p-1 bg-sky-500/15 rounded-md"><TrendingUp className="w-3.5 h-3.5 text-sky-400" /></div>
                            Equity Curve
                          </h3>
                          {eqData.length < 2 ? (
                            <div className="text-center py-4"><TrendingUp className="w-8 h-8 text-slate-700 mx-auto mb-2" /><p className="text-xs text-slate-500">Log 2+ trades to see equity curve</p></div>
                          ) : (
                            <div className="relative h-24">
                              <svg width="100%" height="100%" viewBox={`0 0 ${eqData.length} 100`} preserveAspectRatio="none">
                                <polyline fill="none" stroke="#38bdf8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
                                  points={eqData.map((d, i) => `${i},${100 - ((d.cumPnl - minPnl) / range * 100)}`).join(' ')} />
                              </svg>
                              <div className="absolute top-0 right-0 text-[10px] text-slate-500">{maxPnl >= 0 ? '+' : ''}{maxPnl.toFixed(0)}</div>
                              <div className="absolute bottom-0 right-0 text-[10px] text-slate-500">{minPnl >= 0 ? '+' : ''}{minPnl.toFixed(0)}</div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  }

                  case 'achievements': {
                    const totalTrades = trades.length;
                    const winRate = trades.length > 0 ? (trades.filter(t => (t.pnl || 0) > 0).length / totalTrades * 100) : 0;
                    const badges = [
                      { name: 'First Trade', icon: '🎯', earned: totalTrades >= 1, desc: 'Log your first trade' },
                      { name: 'Streak of 3', icon: '🔥', earned: (() => { let streak = 0, max = 0; trades.forEach(t => { if ((t.pnl||0) > 0) { streak++; max = Math.max(max, streak); } else streak = 0; }); return max >= 3; })(), desc: '3 wins in a row' },
                      { name: '10 Trades', icon: '📊', earned: totalTrades >= 10, desc: 'Complete 10 trades' },
                      { name: 'Sharp Shooter', icon: '🎯', earned: winRate >= 60, desc: '60%+ win rate' },
                      { name: 'Diversified', icon: '🌐', earned: new Set(trades.map(t => t.ticker || t.symbol)).size >= 5, desc: 'Trade 5+ different stocks' },
                      { name: 'Disciplined', icon: '🛡️', earned: trades.filter(t => t.stopLoss).length >= 5, desc: 'Set 5+ stop losses' },
                    ];
                    return (
                      <div {...wrapProps}>
                        <div className="bg-gradient-to-br from-amber-500/8 to-slate-900/0 rounded-xl border border-amber-500/10 p-4 h-full hover:border-amber-500/20 transition-all">
                          <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                            <div className="p-1 bg-amber-500/15 rounded-md"><Trophy className="w-3.5 h-3.5 text-amber-400" /></div>
                            Achievements
                            <span className="text-[9px] bg-amber-500/20 text-amber-400 px-1.5 py-0.5 rounded-full ml-auto">{badges.filter(b => b.earned).length}/{badges.length}</span>
                          </h3>
                          <div className="grid grid-cols-3 gap-1.5">
                            {badges.map((b, i) => (
                              <div key={i} className={`text-center p-1.5 rounded-lg border ${b.earned ? 'bg-amber-500/10 border-amber-500/20' : 'bg-slate-800/20 border-slate-700/10 opacity-40'}`}>
                                <div className="text-lg">{b.icon}</div>
                                <div className="text-[8px] font-medium text-slate-300 mt-0.5">{b.name}</div>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    );
                  }

                  case 'emotionlog': return (
                    <div {...wrapProps}>
                      <div className="bg-gradient-to-br from-purple-500/8 to-slate-900/0 rounded-xl border border-purple-500/10 p-4 h-full hover:border-purple-500/20 transition-all">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <div className="p-1 bg-purple-500/15 rounded-md"><Brain className="w-3.5 h-3.5 text-purple-400" /></div>
                          Trade Emotions
                        </h3>
                        <div className="grid grid-cols-4 gap-1">
                          {['😤 Fear', '🤑 Greed', '😰 Anxiety', '😎 Confident', '🤔 Uncertain', '😤 Revenge', '🧘 Calm', '🎯 Focused'].map((e, i) => (
                            <button key={i} onClick={() => setTradeMistakes(prev => [...prev, { category: 'Emotion', description: e.split(' ')[1], timestamp: new Date().toISOString() }])}
                              className="p-1.5 bg-slate-800/30 border border-slate-700/20 rounded-lg text-center hover:border-purple-500/30 transition-all">
                              <div className="text-sm">{e.split(' ')[0]}</div>
                              <div className="text-[7px] text-slate-500">{e.split(' ')[1]}</div>
                            </button>
                          ))}
                        </div>
                        <p className="text-[9px] text-slate-500 text-center mt-2">Tap your current emotion before trading</p>
                      </div>
                    </div>
                  );

                  case 'dayofweek': {
                    const dayStats = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map((day, di) => {
                      const dayTrades = trades.filter(t => new Date(t.date).getDay() === di);
                      const wins = dayTrades.filter(t => (t.pnl || 0) > 0).length;
                      const losses = dayTrades.filter(t => (t.pnl || 0) < 0).length;
                      return { day, wins, losses, total: dayTrades.length };
                    }).filter(d => d.total > 0);
                    const maxTotal = Math.max(...dayStats.map(d => d.total), 1);
                    return (
                      <div {...wrapProps}>
                        <div className="bg-gradient-to-br from-blue-500/8 to-slate-900/0 rounded-xl border border-blue-500/10 p-4 h-full hover:border-blue-500/20 transition-all">
                          <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                            <div className="p-1 bg-blue-500/15 rounded-md"><Calendar className="w-3.5 h-3.5 text-blue-400" /></div>
                            Win/Loss by Day
                          </h3>
                          {dayStats.length === 0 ? (
                            <div className="text-center py-4"><Calendar className="w-8 h-8 text-slate-700 mx-auto mb-2" /><p className="text-xs text-slate-500">Log trades to see day analysis</p></div>
                          ) : (
                            <div className="space-y-1.5">
                              {dayStats.map(d => (
                                <div key={d.day} className="flex items-center gap-2">
                                  <span className="text-[10px] text-slate-400 w-6 font-medium">{d.day}</span>
                                  <div className="flex-1 flex h-3 rounded-full overflow-hidden bg-slate-800/30">
                                    <div className="bg-emerald-500/60 h-full" style={{width: `${d.wins / maxTotal * 100}%`}} />
                                    <div className="bg-red-500/60 h-full" style={{width: `${d.losses / maxTotal * 100}%`}} />
                                  </div>
                                  <span className="text-[9px] text-slate-500 w-8">{d.wins}W/{d.losses}L</span>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  }

                  default: return null;
                }
                } catch (err) {
                  console.error(`Widget rendering error for ${widgetKey}:`, err);
                  return null;
                }
              })}
            </div>
          </div>
        )}

        {/* NEW: Live Ticker Tab */}
        {activeTab === "ticker" && (
          <div className="space-y-4 md:space-y-6 animate-fadeIn">
            <div className="rounded-xl md:rounded-2xl p-4 md:p-6 card-premium">
              <h2 className="text-xl md:text-2xl font-bold mb-3 md:mb-4 flex items-center gap-3">
                <div className="p-2 bg-violet-500/20 rounded-lg">
                  <LineChart className="w-6 h-6 text-violet-400" />
                </div>
                <span className="bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">Live Stock Ticker</span>
              </h2>
              
              <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-6">
                <div className="flex items-start gap-3">
                  <AlertCircle className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
                  <div className="text-sm text-blue-200">
                    <p className="font-semibold mb-1">Smart Multi-API System:</p>
                    <ol className="list-decimal list-inside space-y-1 text-blue-300">
                      <li><span className="font-semibold">Works WITHOUT API key!</span> Uses free Yahoo Finance</li>
                      <li><span className="font-semibold">Optional:</span> Add Finnhub key in Settings for best quality (free at finnhub.io)</li>
                      <li>Tries multiple APIs automatically: Finnhub → Yahoo Finance → Alpha Vantage</li>
                      <li>Enter any symbol (AAPL, TSLA, NVDA) and click "Get Live Data"</li>
                    </ol>
                  </div>
                </div>
              </div>

              {/* Demo Mode Toggle */}
              <div className="bg-violet-900/20 border border-violet-500/30 rounded-lg p-4 mb-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <Sparkles className="w-5 h-5 text-violet-400" />
                    <div>
                      <h4 className="font-semibold text-violet-300">Demo Mode</h4>
                      <p className="text-xs text-slate-400">Use sample data for testing (when market is closed)</p>
                    </div>
                  </div>
                  <button
                    onClick={() => setUseDemoMode(!useDemoMode)}
                    className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                      useDemoMode
                        ? "bg-violet-600 text-white shadow-lg"
                        : "bg-slate-700 text-slate-300 hover:bg-slate-600"
                    }`}
                  >
                    {useDemoMode ? "✓ ON" : "OFF"}
                  </button>
                </div>
                {useDemoMode && (
                  <div className="mt-2 text-xs text-violet-300 bg-violet-950/50 rounded px-3 py-2">
                    🎮 Demo mode active! Will generate realistic sample data for any symbol.
                  </div>
                )}
              </div>

              {/* Auto-Refresh Controls */}
              <div className="bg-green-900/20 border border-green-500/30 rounded-lg p-3 md:p-4 mb-4 md:mb-6">
                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                  <div className="flex items-center gap-3">
                    <div className={`w-3 h-3 rounded-full ${tickerAutoRefresh && tickerData ? 'bg-green-400 animate-pulse' : 'bg-slate-500'}`} />
                    <div>
                      <h4 className="font-semibold text-green-300 flex items-center gap-2">
                        Auto-Refresh Chart
                        {isRefreshing && (
                          <span className="text-xs text-yellow-400 font-normal flex items-center gap-1 animate-pulse">
                            <RefreshCw className="w-3 h-3 animate-spin" />
                            Refreshing...
                          </span>
                        )}
                      </h4>
                      <p className="text-xs text-slate-400">
                        Automatically refresh data every {tickerRefreshInterval} seconds
                        {tickerAutoRefresh && tickerData && nextRefreshIn !== null && !isRefreshing && (
                          <span className="text-cyan-400 ml-2 font-mono">
                            • Next in {nextRefreshIn}s
                          </span>
                        )}
                        {tickerLastRefresh && tickerAutoRefresh && tickerData && (
                          <span className="text-green-400 ml-2">
                            • Last: {tickerLastRefresh.toLocaleTimeString()}
                          </span>
                        )}
                      </p>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    {/* Price Change Badge */}
                    {priceChange && tickerAutoRefresh && (
                      <div className={`px-3 py-1.5 rounded-lg text-sm font-semibold flex items-center gap-1 ${
                        priceChange.direction === 'up'
                          ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'
                          : 'bg-red-500/20 text-red-400 border border-red-500/30'
                      }`}>
                        <span>{priceChange.direction === 'up' ? '▲' : '▼'}</span>
                        <span>{priceChange.direction === 'up' ? '+' : ''}{priceChange.amount.toFixed(2)}</span>
                        <span className="text-xs opacity-75">({priceChange.percent.toFixed(2)}%)</span>
                      </div>
                    )}
                    {/* Interval Selector */}
                    <div className="flex items-center gap-2">
                      <span className="text-xs text-slate-400">Every</span>
                      <select
                        value={tickerRefreshInterval}
                        onChange={(e) => setTickerRefreshInterval(parseInt(e.target.value))}
                        className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm"
                      >
                        <option value={5}>5s ⚡</option>
                        <option value={10}>10s</option>
                        <option value={15}>15s</option>
                        <option value={20}>20s</option>
                        <option value={30}>30s</option>
                      </select>
                    </div>
                    <button
                      onClick={() => setTickerAutoRefresh(!tickerAutoRefresh)}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                        tickerAutoRefresh
                          ? "bg-green-600 text-white shadow-lg"
                          : "bg-slate-700 text-slate-300 hover:bg-slate-600"
                      }`}
                    >
                      {tickerAutoRefresh ? "✓ ON" : "OFF"}
                    </button>
                  </div>
                </div>
                {tickerAutoRefresh && tickerData && (
                  <div className="mt-2 text-xs text-green-300 bg-green-950/50 rounded px-3 py-2 flex items-center justify-between">
                    <span>🔄 Chart will automatically refresh every {tickerRefreshInterval} seconds while viewing {tickerSymbol || "this stock"}</span>
                    {previousPrice && tickerData.currentPrice && (
                      <span className="text-slate-400">
                        Previous: ${previousPrice.toFixed(2)}
                      </span>
                    )}
                  </div>
                )}
              </div>

              <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 mb-4">
                <input
                  type="text"
                  value={tickerSymbol}
                  onChange={(e) => setTickerSymbol(e.target.value.toUpperCase())}
                  onKeyPress={(e) => e.key === 'Enter' && fetchTickerData()}
                  placeholder="Enter symbol (e.g., AAPL)"
                  className="flex-1 bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500 font-mono text-base"
                />
                <button
                  onClick={() => fetchTickerData(false)}
                  disabled={loadingTicker || !tickerSymbol}
                  className={`px-6 py-3 bg-gradient-to-r ${
                    isRefreshing
                      ? 'from-cyan-600 to-cyan-700'
                      : 'from-violet-600 to-violet-700 hover:from-violet-500 hover:to-violet-600'
                  } disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed text-white rounded-xl font-semibold transition-all duration-200 flex items-center gap-2 shadow-lg shadow-violet-500/25 hover:shadow-violet-500/40 btn-press`}
                >
                  {loadingTicker ? (
                    <>
                      <Loader2 className="w-5 h-5 animate-spin" />
                      <span>Loading...</span>
                    </>
                  ) : isRefreshing ? (
                    <>
                      <RefreshCw className="w-5 h-5 animate-spin" />
                      <span>Refreshing...</span>
                    </>
                  ) : (
                    <>
                      <RefreshCw className="w-5 h-5" />
                      <span>Get Live Data</span>
                    </>
                  )}
                </button>
              </div>
              
              {/* Timeframe Tips */}
              <div className="bg-slate-800/30 border border-slate-700/50 rounded-lg p-3 mb-4">
                <div className="flex items-start gap-2">
                  <Info className="w-4 h-4 text-blue-400 flex-shrink-0 mt-0.5" />
                  <div className="text-xs text-slate-400">
                    <span className="font-medium text-blue-300">Timeframe Tips:</span> Short intervals (1m-5m) work best during market hours. If data fails to load, try <span className="text-green-400">1h</span> or <span className="text-green-400">1d</span> timeframes which are more reliable, especially on weekends or after hours.
                  </div>
                </div>
              </div>

              {/* Chart Configuration */}
              <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 mb-4 md:mb-6">
                <div className="flex-1">
                  <label className="block text-xs text-slate-400 font-medium mb-2">Timeframe</label>
                  <select
                    value={tickerTimeframe}
                    onChange={(e) => {
                      const newValue = e.target.value;
                      console.log(`[UI] Timeframe changed to: ${newValue}`);
                      setTickerTimeframe(newValue);
                    }}
                    className="w-full bg-slate-800/80 border border-slate-600/50 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 text-sm cursor-pointer hover:border-slate-500 transition-colors"
                  >
                    <option value="1m">1 Minute ⚡</option>
                    <option value="2m">2 Minutes ⚡</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="30m">30 Minutes</option>
                    <option value="60m">60 Minutes ✓</option>
                    <option value="90m">90 Minutes</option>
                    <option value="1h">1 Hour ✓</option>
                    <option value="1d">1 Day ★</option>
                    <option value="5d">5 Days</option>
                    <option value="1wk">1 Week</option>
                    <option value="1mo">1 Month</option>
                  </select>
                </div>
                <div className="flex-1">
                  <label className="block text-xs text-slate-500 mb-2">Candles to Show</label>
                  <select
                    value={tickerCandleCount}
                    onChange={(e) => {
                      const newValue = parseInt(e.target.value);
                      console.log(`[UI] Candle count changed to: ${newValue}`);
                      if (!isNaN(newValue)) {
                        setTickerCandleCount(newValue);
                      }
                    }}
                    className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-violet-500 text-sm cursor-pointer"
                  >
                    <option value="50">50 Candles</option>
                    <option value="100">100 Candles</option>
                    <option value="200">200 Candles</option>
                    <option value="300">300 Candles</option>
                  </select>
                </div>
                <div className="flex-1">
                  <label className="block text-xs text-slate-500 mb-2">Data Source</label>
                  <div className="bg-slate-800/30 border border-slate-700 rounded-lg px-4 py-2.5 text-sm text-slate-400">
                    {useDemoMode ? "Demo Mode" : "Yahoo Finance (Free)"}
                  </div>
                </div>
              </div>

              {tickerError && (
                <div className="space-y-4 mb-6">
                  <div className="bg-red-500/10 border-2 border-red-500/50 rounded-lg p-5">
                    <div className="flex items-start gap-3">
                      <AlertTriangle className="w-6 h-6 text-red-400 flex-shrink-0 mt-0.5" />
                      <div className="flex-1">
                        <div className="font-bold text-red-400 mb-3 text-lg">APIs Not Working</div>
                        <div className="text-sm text-slate-300 whitespace-pre-line leading-relaxed">{tickerError}</div>
                      </div>
                    </div>
                  </div>
                  
                  {!useDemoMode && (
                    <div className="bg-gradient-to-r from-violet-600 to-purple-600 rounded-xl p-6 shadow-2xl border-2 border-violet-400">
                      <div className="flex flex-col gap-4">
                        <div className="flex items-center gap-3">
                          <div className="bg-white/20 p-3 rounded-lg">
                            <Sparkles className="w-8 h-8 text-white" />
                          </div>
                          <div className="flex-1">
                            <h4 className="font-bold text-white text-xl mb-1">Quick Fix: Use Demo Mode! 🎯</h4>
                            <p className="text-violet-100 text-sm">
                              Works instantly, no setup needed. All features enabled!
                            </p>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-3 text-sm">
                          <div className="bg-white/10 rounded-lg p-3">
                            <div className="text-white font-semibold mb-1">✓ 101 Chart Bars</div>
                            <div className="text-violet-100 text-xs">Realistic price data</div>
                          </div>
                          <div className="bg-white/10 rounded-lg p-3">
                            <div className="text-white font-semibold mb-1">✓ All Features</div>
                            <div className="text-violet-100 text-xs">Full functionality</div>
                          </div>
                          <div className="bg-white/10 rounded-lg p-3">
                            <div className="text-white font-semibold mb-1">✓ No APIs</div>
                            <div className="text-violet-100 text-xs">Works offline</div>
                          </div>
                          <div className="bg-white/10 rounded-lg p-3">
                            <div className="text-white font-semibold mb-1">✓ Always Works</div>
                            <div className="text-violet-100 text-xs">24/7 availability</div>
                          </div>
                        </div>
                        
                        <button
                          onClick={() => {
                            setUseDemoMode(true);
                            setTickerError(null);
                          }}
                          className="bg-white hover:bg-violet-50 text-violet-700 px-8 py-4 rounded-lg font-bold text-lg transition-all shadow-xl hover:shadow-2xl hover:scale-105 flex items-center justify-center gap-3"
                        >
                          <Sparkles className="w-6 h-6" />
                          <span>Enable Demo Mode Now - Fix Everything!</span>
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {tickerData && (
                <div className="space-y-4 md:space-y-6">
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className={`bg-slate-800/30 rounded-lg p-4 transition-all duration-300 ${
                      priceFlash === 'up' ? 'ring-2 ring-green-500' : 
                      priceFlash === 'down' ? 'ring-2 ring-red-500' : ''
                    }`}>
                      <div className="text-xs text-slate-400 mb-1 flex items-center justify-between">
                        <span className="font-medium">Current Price</span>
                        <span className={`text-[10px] flex items-center gap-1 px-2 py-0.5 rounded-full ${
                          tickerData.isLive === false ? 'text-yellow-400 bg-yellow-500/10' : 'text-emerald-400 bg-emerald-500/10'
                        }`}>
                          <span className="w-1.5 h-1.5 rounded-full animate-pulse" style={{ backgroundColor: tickerData.isLive === false ? '#facc15' : '#10b981' }}></span>
                          {tickerData.isLive === false ? 'DELAYED' : 'LIVE'}
                        </span>
                      </div>
                      <div className="text-3xl font-bold flex items-center gap-2 tabular-nums">
                        <span className="text-white">${(tickerData.currentPrice || 0).toFixed(2)}</span>
                        {priceFlash === 'up' && <span className="text-emerald-400 text-xl animate-bounce">▲</span>}
                        {priceFlash === 'down' && <span className="text-red-400 text-xl animate-bounce">▼</span>}
                      </div>
                      <div className={`text-sm font-bold mt-1 flex items-center gap-2 ${(tickerData.change || 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                        <span className={`px-2 py-0.5 rounded ${(tickerData.change || 0) >= 0 ? 'bg-emerald-500/20' : 'bg-red-500/20'}`}>
                          {(tickerData.change || 0) >= 0 ? '+' : ''}{(tickerData.change || 0).toFixed(2)} ({(tickerData.changePercent || 0).toFixed(2)}%)
                        </span>
                      </div>
                      <div className="text-[10px] text-slate-500 mt-2 flex items-center justify-between">
                        <span>Updated: {new Date(lastPriceUpdate).toLocaleTimeString()}</span>
                        {tickerData.marketState && tickerData.marketState !== 'REGULAR' && (
                          <span className="text-yellow-400 px-1.5 py-0.5 bg-yellow-500/10 rounded">
                            {tickerData.marketState === 'POST' ? '🌙 After Hours' : 
                             tickerData.marketState === 'PRE' ? '🌅 Pre-Market' : '⏸ Closed'}
                          </span>
                        )}
                      </div>
                      {tickerData.isLive === false && (
                        <div className="mt-2 text-[10px] text-yellow-400 bg-yellow-900/20 rounded-lg px-2 py-1.5 flex items-center gap-1">
                          <AlertTriangle className="w-3 h-3" />
                          Real-time updates unavailable
                        </div>
                      )}
                    </div>
                    <div className="bg-slate-800/40 rounded-xl p-4 border border-slate-700/30">
                      <div className="text-[10px] text-slate-500 mb-1 font-medium uppercase tracking-wide">Open</div>
                      <div className="text-xl font-bold text-white tabular-nums">${(tickerData.open || 0).toFixed(2)}</div>
                    </div>
                    <div className="bg-slate-800/40 rounded-xl p-4 border border-slate-700/30">
                      <div className="text-[10px] text-slate-500 mb-1 font-medium uppercase tracking-wide">Day Range</div>
                      <div className="text-sm font-bold">
                        <span className="text-red-400">${(tickerData.low || 0).toFixed(2)}</span>
                        <span className="text-slate-500 mx-1">—</span>
                        <span className="text-emerald-400">${(tickerData.high || 0).toFixed(2)}</span>
                      </div>
                    </div>
                    <div className="bg-slate-800/40 rounded-xl p-4 border border-slate-700/30">
                      <div className="text-[10px] text-slate-500 mb-1 font-medium uppercase tracking-wide">Volume</div>
                      <div className="text-xl font-bold text-white tabular-nums">{((tickerData.volume || 0) / 1000000).toFixed(2)}M</div>
                    </div>
                  </div>

                  {/* Data Source Info - Collapsible */}
                  <details className="bg-slate-800/30 border border-slate-700/30 rounded-xl">
                    <summary className="px-4 py-2 cursor-pointer text-xs text-slate-400 hover:text-slate-300 flex items-center gap-2">
                      <Info className="w-3 h-3" />
                      Data Source: {tickerData.source || 'Unknown'} • {tickerData.timeSeries?.length || 0} bars
                    </summary>
                    <div className="px-4 pb-3 text-xs text-slate-500 space-y-1">
                      <div>Symbol: <span className="text-slate-300 font-medium">{tickerData.symbol}</span></div>
                      <div>Last Update: <span className="text-slate-300">{tickerData.lastUpdate?.toLocaleTimeString() || 'N/A'}</span></div>
                      {tickerData.timeSeries?.length === 0 && (
                        <div className="mt-2 text-yellow-400 text-[10px]">
                          ⚠️ No chart data - market may be closed or symbol doesn't have intraday data
                        </div>
                      )}
                    </div>
                  </details>

                  {/* Fallback Timeframe Notification */}
                  {tickerData.usedFallback && tickerData.fallbackMessage && (
                    <div className="bg-yellow-900/30 border border-yellow-500/50 rounded-xl p-4 mb-4">
                      <div className="flex items-start gap-3">
                        <AlertTriangle className="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5" />
                        <div>
                          <div className="font-semibold text-yellow-300 mb-1">Timeframe Adjusted Automatically</div>
                          <div className="text-sm text-yellow-200/80">{tickerData.fallbackMessage}</div>
                          <div className="text-xs text-slate-400 mt-2">
                            💡 Small timeframes (1m-30m) require the market to be open. Try again during market hours (9:30 AM - 4:00 PM ET).
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  <div ref={tickerChartRef} className={`bg-slate-800/30 rounded-xl p-6 border border-slate-700/30 chart-container ${isRefreshing ? 'refreshing' : ''}`}>
                    <h3 className="text-lg font-bold mb-4 flex items-center gap-3">
                      <span className="text-white">{tickerData.symbol}</span>
                      <span className="text-sm font-normal text-slate-400">{tickerData.timeSeries.length} Candles • {tickerTimeframe}</span>
                      {isRefreshing && (
                        <span className="text-[10px] text-cyan-400 bg-cyan-500/20 px-2 py-0.5 rounded-full flex items-center gap-1">
                          <RefreshCw className="w-3 h-3 animate-spin" />
                          Updating...
                        </span>
                      )}
                      {tickerData.usedFallback && <span className="text-[10px] text-yellow-400 bg-yellow-500/10 px-2 py-0.5 rounded-full">showing {tickerData.timeframe}</span>}
                      {tickerData.source && <span className="text-[10px] text-violet-400 bg-violet-500/10 px-2 py-0.5 rounded-full">{tickerData.source}</span>}
                    </h3>
                    
                    {tickerData.timeSeries && tickerData.timeSeries.length > 0 ? (
                      <>
                        {/* Chart Controls - Overlays */}
                        <div className="mb-2">
                          <div className="text-xs text-slate-500 mb-1">Chart Overlays</div>
                          <div className="flex flex-wrap gap-2">
                            <button
                              onClick={() => setShowSMA(!showSMA)}
                              className={`px-3 py-1.5 rounded text-sm font-semibold transition ${
                                showSMA ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'
                              }`}
                            >
                              {showSMA ? '✅' : '☐'} SMA (20)
                            </button>
                            <button
                              onClick={() => setShowEMA(!showEMA)}
                              className={`px-3 py-1.5 rounded text-sm font-semibold transition ${
                                showEMA ? 'bg-orange-600 text-white' : 'bg-slate-800 text-slate-400'
                              }`}
                            >
                              {showEMA ? '✅' : '☐'} EMA (20)
                            </button>
                            <button
                              onClick={() => setShowBollinger(!showBollinger)}
                              className={`px-3 py-1.5 rounded text-sm font-semibold transition ${
                                showBollinger ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400'
                              }`}
                            >
                              {showBollinger ? '✅' : '☐'} Bollinger
                            </button>
                            <button
                              onClick={() => setShowVWAP(!showVWAP)}
                              className={`px-3 py-1.5 rounded text-sm font-semibold transition ${
                                showVWAP ? 'bg-pink-600 text-white' : 'bg-slate-800 text-slate-400'
                              }`}
                            >
                              {showVWAP ? '✅' : '☐'} VWAP
                            </button>

                            {/* Chart Comparison Overlay */}
                            <div className="flex items-center gap-2 ml-2 pl-2 border-l border-slate-600">
                              <button
                                onClick={() => {
                                  if (showComparison) {
                                    setShowComparison(false);
                                    setComparisonData(null);
                                    setComparisonSymbol('');
                                  }
                                }}
                                className={`px-3 py-1.5 rounded text-sm font-semibold transition ${
                                  showComparison ? 'bg-amber-600 text-white' : 'bg-slate-800 text-slate-400'
                                }`}
                                title={showComparison ? 'Click to remove comparison' : 'Type a symbol and press Enter to compare'}
                              >
                                {showComparison ? `✅ vs ${comparisonData?.symbol || ''}` : '📊 Compare'}
                              </button>
                              {!showComparison && (
                                <div className="relative">
                                  <input
                                    type="text"
                                    value={comparisonSymbol}
                                    onChange={(e) => setComparisonSymbol(e.target.value.toUpperCase())}
                                    onKeyDown={(e) => {
                                      if (e.key === 'Enter' && comparisonSymbol.trim()) {
                                        fetchComparisonData(comparisonSymbol);
                                      }
                                    }}
                                    placeholder="e.g. SPY"
                                    className="w-24 bg-slate-800/80 border border-slate-600/50 rounded-lg px-2.5 py-1.5 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-amber-500/50"
                                  />
                                  {loadingComparison && (
                                    <RefreshCw className="absolute right-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-amber-400 animate-spin" />
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                        </div>

                        {/* Chart Controls - Separate Panels */}
                        <div className="mb-4">
                          <div className="text-xs text-slate-500 mb-1">Indicator Panels</div>
                          <div className="flex flex-wrap gap-2">
                            <button
                              onClick={() => setShowVolume(!showVolume)}
                              className={`px-3 py-1.5 rounded text-sm font-semibold transition ${
                                showVolume ? 'bg-violet-600 text-white' : 'bg-slate-800 text-slate-400'
                              }`}
                            >
                              {showVolume ? '✅' : '☐'} Volume
                            </button>
                            <button
                              onClick={() => setShowRSI(!showRSI)}
                              className={`px-3 py-1.5 rounded text-sm font-semibold transition ${
                                showRSI ? 'bg-violet-600 text-white' : 'bg-slate-800 text-slate-400'
                              }`}
                            >
                              {showRSI ? '✅' : '☐'} RSI
                            </button>
                            <button
                              onClick={() => setShowMACD(!showMACD)}
                              className={`px-3 py-1.5 rounded text-sm font-semibold transition ${
                                showMACD ? 'bg-violet-600 text-white' : 'bg-slate-800 text-slate-400'
                              }`}
                            >
                              {showMACD ? '✅' : '☐'} MACD
                            </button>
                            <button
                              onClick={() => setShowStochastic(!showStochastic)}
                              className={`px-3 py-1.5 rounded text-sm font-semibold transition ${
                                showStochastic ? 'bg-violet-600 text-white' : 'bg-slate-800 text-slate-400'
                              }`}
                            >
                              {showStochastic ? '✅' : '☐'} Stochastic
                            </button>
                            <button
                              onClick={() => setShowATR(!showATR)}
                              className={`px-3 py-1.5 rounded text-sm font-semibold transition ${
                                showATR ? 'bg-violet-600 text-white' : 'bg-slate-800 text-slate-400'
                              }`}
                            >
                              {showATR ? '✅' : '☐'} ATR
                            </button>
                          </div>
                        </div>
                        
                        {/* INDICATOR GUIDE TOOLBAR */}
                        {(showRSI || showMACD || showStochastic || showATR || showVolume) && (
                          <div className="bg-gradient-to-r from-slate-800/80 to-slate-900/80 rounded-xl p-4 mt-4 border border-slate-700/50">
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center gap-2">
                                <span className="text-violet-400 text-lg">📊</span>
                                <span className="text-sm font-semibold text-slate-300">Active Indicators Guide</span>
                              </div>
                              <span className="text-xs text-slate-500">Hover for details</span>
                            </div>
                            <div className="flex flex-wrap gap-2">
                              {showVolume && (
                                <div className="group relative inline-block">
                                  <div className="px-3 py-1.5 bg-violet-600/20 border border-violet-500/30 rounded-lg text-xs text-violet-300 cursor-help flex items-center gap-1.5 hover:bg-violet-600/30 transition-colors">
                                    <span className="w-2 h-2 bg-emerald-500 rounded-full"></span>
                                    Volume
                                  </div>
                                  <div className="absolute left-full top-0 ml-2 hidden group-hover:block w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl z-[65]">
                                    <div className="font-semibold text-violet-400 mb-1">📊 Volume</div>
                                    <p>Shows trading activity. High volume confirms price moves; low volume suggests weak conviction. Green = buying pressure, Red = selling pressure.</p>
                                  </div>
                                </div>
                              )}
                              {showRSI && (
                                <div className="group relative inline-block">
                                  <div className="px-3 py-1.5 bg-violet-600/20 border border-violet-500/30 rounded-lg text-xs text-violet-300 cursor-help flex items-center gap-1.5 hover:bg-violet-600/30 transition-colors">
                                    <span className="w-2 h-2 bg-violet-500 rounded-full"></span>
                                    RSI (14)
                                  </div>
                                  <div className="absolute left-full top-0 ml-2 hidden group-hover:block w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl z-[65]">
                                    <div className="font-semibold text-violet-400 mb-1">📈 RSI - Relative Strength Index</div>
                                    <p className="mb-2">Momentum oscillator (0-100) measuring speed of price changes.</p>
                                    <div className="space-y-1 text-[10px]">
                                      <div className="flex items-center gap-2"><span className="text-red-400">●</span> Above 70 = Overbought</div>
                                      <div className="flex items-center gap-2"><span className="text-emerald-400">●</span> Below 30 = Oversold</div>
                                    </div>
                                  </div>
                                </div>
                              )}
                              {showMACD && (
                                <div className="group relative inline-block">
                                  <div className="px-3 py-1.5 bg-blue-600/20 border border-blue-500/30 rounded-lg text-xs text-blue-300 cursor-help flex items-center gap-1.5 hover:bg-blue-600/30 transition-colors">
                                    <span className="w-2 h-2 bg-blue-500 rounded-full"></span>
                                    MACD
                                  </div>
                                  <div className="absolute left-full top-0 ml-2 hidden group-hover:block w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl z-[65]">
                                    <div className="font-semibold text-blue-400 mb-1">📉 MACD</div>
                                    <p className="mb-2">Trend-following momentum indicator.</p>
                                    <div className="space-y-1 text-[10px]">
                                      <div className="flex items-center gap-2"><span className="text-emerald-400">●</span> Green = Bullish</div>
                                      <div className="flex items-center gap-2"><span className="text-red-400">●</span> Red = Bearish</div>
                                    </div>
                                  </div>
                                </div>
                              )}
                              {showStochastic && (
                                <div className="group relative inline-block">
                                  <div className="px-3 py-1.5 bg-cyan-600/20 border border-cyan-500/30 rounded-lg text-xs text-cyan-300 cursor-help flex items-center gap-1.5 hover:bg-cyan-600/30 transition-colors">
                                    <span className="w-2 h-2 bg-cyan-500 rounded-full"></span>
                                    Stochastic
                                  </div>
                                  <div className="absolute left-full top-0 ml-2 hidden group-hover:block w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl z-[65]">
                                    <div className="font-semibold text-cyan-400 mb-1">🔄 Stochastic (14,3,3)</div>
                                    <p className="mb-2">Compares closing price to price range.</p>
                                    <div className="space-y-1 text-[10px]">
                                      <div className="flex items-center gap-2"><span className="text-red-400">●</span> Above 80 = Overbought</div>
                                      <div className="flex items-center gap-2"><span className="text-emerald-400">●</span> Below 20 = Oversold</div>
                                    </div>
                                  </div>
                                </div>
                              )}
                              {showATR && (
                                <div className="group relative inline-block">
                                  <div className="px-3 py-1.5 bg-amber-600/20 border border-amber-500/30 rounded-lg text-xs text-amber-300 cursor-help flex items-center gap-1.5 hover:bg-amber-600/30 transition-colors">
                                    <span className="w-2 h-2 bg-amber-500 rounded-full"></span>
                                    ATR
                                  </div>
                                  <div className="absolute left-full top-0 ml-2 hidden group-hover:block w-56 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl z-[65]">
                                    <div className="font-semibold text-amber-400 mb-1">📏 ATR - Average True Range</div>
                                    <p className="mb-2">Measures market volatility.</p>
                                    <div className="space-y-1 text-[10px]">
                                      <div className="flex items-center gap-2"><span className="text-red-400">●</span> High = High volatility</div>
                                      <div className="flex items-center gap-2"><span className="text-emerald-400">●</span> Low = Low volatility</div>
                                    </div>
                                  </div>
                                </div>
                              )}
                              {(showSMA || showEMA || showBollinger || showVWAP) && (
                                <div className="border-l border-slate-600 pl-2 ml-1 flex gap-2">
                                  {showSMA && (
                                    <div className="group relative inline-block">
                                      <div className="px-2 py-1 bg-blue-600/20 border border-blue-500/30 rounded text-[10px] text-blue-300 cursor-help hover:bg-blue-600/30 transition-colors">SMA</div>
                                      <div className="absolute left-full top-0 ml-2 hidden group-hover:block w-44 bg-slate-800 border border-slate-600 rounded-lg p-2 text-xs text-slate-300 shadow-2xl z-[65]">
                                        <div className="font-semibold text-blue-400 mb-1">SMA (20)</div>
                                        <p>Simple Moving Average - trend direction.</p>
                                      </div>
                                    </div>
                                  )}
                                  {showEMA && (
                                    <div className="group relative inline-block">
                                      <div className="px-2 py-1 bg-orange-600/20 border border-orange-500/30 rounded text-[10px] text-orange-300 cursor-help hover:bg-orange-600/30 transition-colors">EMA</div>
                                      <div className="absolute left-full top-0 ml-2 hidden group-hover:block w-44 bg-slate-800 border border-slate-600 rounded-lg p-2 text-xs text-slate-300 shadow-2xl z-[65]">
                                        <div className="font-semibold text-orange-400 mb-1">EMA (20)</div>
                                        <p>Exponential MA - more responsive.</p>
                                      </div>
                                    </div>
                                  )}
                                  {showBollinger && (
                                    <div className="group relative inline-block">
                                      <div className="px-2 py-1 bg-cyan-600/20 border border-cyan-500/30 rounded text-[10px] text-cyan-300 cursor-help hover:bg-cyan-600/30 transition-colors">BB</div>
                                      <div className="absolute left-full top-0 ml-2 hidden group-hover:block w-48 bg-slate-800 border border-slate-600 rounded-lg p-2 text-xs text-slate-300 shadow-2xl z-[65]">
                                        <div className="font-semibold text-cyan-400 mb-1">Bollinger Bands</div>
                                        <p>Volatility bands at 2 std deviations.</p>
                                      </div>
                                    </div>
                                  )}
                                  {showVWAP && (
                                    <div className="group relative inline-block">
                                      <div className="px-2 py-1 bg-pink-600/20 border border-pink-500/30 rounded text-[10px] text-pink-300 cursor-help hover:bg-pink-600/30 transition-colors">VWAP</div>
                                      <div className="absolute left-full top-0 ml-2 hidden group-hover:block w-48 bg-slate-800 border border-slate-600 rounded-lg p-2 text-xs text-slate-300 shadow-2xl z-[65]">
                                        <div className="font-semibold text-pink-400 mb-1">VWAP</div>
                                        <p>Volume Weighted Average Price - institutional benchmark.</p>
                                      </div>
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                        
                        {/* ENHANCED CHART - Scrollable with Grid + TICKER OVERLAY */}
                        <div 
                          className="bg-slate-900 rounded-lg p-4 border-2 border-slate-700 overflow-x-auto relative"
                          id="chart-scroll-container"
                        >
                          
                          {/* STICKY TICKER OVERLAY - ALWAYS VISIBLE */}
                          {showTickerOverlay && (
                            <div className="sticky left-4 top-4 z-50 inline-block mb-2">
                              <div className="bg-slate-900/95 backdrop-blur-sm border-2 border-violet-500 rounded-lg px-4 py-2 shadow-2xl">
                                <div className="flex items-center gap-3">
                                  <span className="text-lg font-bold text-violet-400">{tickerData.symbol}</span>
                                  <span className="text-2xl font-bold text-white">
                                    ${(tickerData.timeSeries[tickerData.timeSeries.length - 1]?.close || 0).toFixed(2) || '0.00'}
                                  </span>
                                  {(() => {
                                    const latest = tickerData.timeSeries[tickerData.timeSeries.length - 1];
                                    const change = latest?.close - (latest?.open || latest?.close);
                                    const changePercent = (change / (latest?.open || latest?.close)) * 100;
                                    const isPositive = change >= 0;
                                    return (
                                      <span className={`text-lg font-semibold ${isPositive ? 'text-emerald-400' : 'text-red-400'}`}>
                                        {isPositive ? '↑' : '↓'} {isPositive ? '+' : ''}{(changePercent || 0).toFixed(2)}%
                                      </span>
                                    );
                                  })()}
                                </div>
                              </div>
                            </div>
                          )}
                          
                          <div 
                            className="h-96 relative" 
                            style={{ 
                              width: `${Math.max(tickerData.timeSeries.length * 8, 800)}px`,
                              backgroundImage: 'linear-gradient(to right, rgb(51 65 85 / 0.3) 1px, transparent 1px), linear-gradient(to bottom, rgb(51 65 85 / 0.3) 1px, transparent 1px)',
                              backgroundSize: '40px 32px'
                            }}
                          >
                            {/* Price labels on Y-axis */}
                            <div className="absolute left-0 top-0 bottom-0 w-16 flex flex-col justify-between text-xs text-slate-400 pointer-events-none z-10">
                              {(() => {
                                const validBars = tickerData.timeSeries.filter(b => b && b.low && b.high && !isNaN(b.low) && !isNaN(b.high));
                                if (validBars.length === 0) return null;
                                const minPrice = Math.min(...validBars.map(b => b.low));
                                const maxPrice = Math.max(...validBars.map(b => b.high));
                                const steps = 5;
                                const priceStep = (maxPrice - minPrice) / (steps - 1);
                                return Array.from({ length: steps }, (_, i) => (
                                  <div key={i} className="text-right pr-2 bg-slate-900/80">${((maxPrice - i * priceStep) || 0).toFixed(2)}</div>
                                ));
                              })()}
                            </div>
                            
                            {/* Candles container */}
                            <div className="absolute inset-0 flex items-end gap-0.5 pl-16 pr-2 pb-8">
                              {(() => {
                                // PRE-CALCULATE price range ONCE outside the loop for performance
                                const validBars = tickerData.timeSeries.filter(b => b && b.low && b.high && !isNaN(b.low) && !isNaN(b.high));
                                if (validBars.length === 0) return null;
                                
                                const minPrice = Math.min(...validBars.map(b => b.low));
                                const maxPrice = Math.max(...validBars.map(b => b.high));
                                const priceRange = maxPrice - minPrice || 1;
                                
                                return tickerData.timeSeries.map((bar, i) => {
                                  // Skip if data is invalid
                                  if (!bar || bar.close === null || bar.close === undefined || isNaN(bar.close)) {
                                    return null;
                                  }
                                
                                  // Calculate heights using pre-computed values
                                  const highHeight = ((bar.high - minPrice) / priceRange) * 95 + 5;
                                  const lowHeight = ((bar.low - minPrice) / priceRange) * 95 + 5;
                                  const closeHeight = ((bar.close - minPrice) / priceRange) * 95 + 5;
                                  const openHeight = bar.open ? ((bar.open - minPrice) / priceRange) * 95 + 5 : closeHeight;
                                  
                                  // Determine color
                                  const isGreen = bar.close >= (bar.open || bar.close);
                                  
                                  // Calculate body position
                                  const bodyTop = Math.max(closeHeight, openHeight);
                                  const bodyBottom = Math.min(closeHeight, openHeight);
                                  const bodyHeight = Math.max(bodyTop - bodyBottom, 1);
                                  
                                  return (
                                    <div
                                      key={i}
                                      className="relative group"
                                      style={{ 
                                        height: '100%',
                                        width: '6px',
                                      minWidth: '6px'
                                    }}
                                  >
                                    {/* Wick (high-low line) */}
                                    <div
                                      className={`absolute left-1/2 transform -translate-x-1/2 w-0.5 ${
                                        isGreen ? 'bg-emerald-400' : 'bg-red-400'
                                      }`}
                                      style={{
                                        bottom: `${lowHeight}%`,
                                        height: `${highHeight - lowHeight}%`
                                      }}
                                    />
                                    
                                    {/* Candlestick body */}
                                    <div
                                      className={`absolute left-0 right-0 ${
                                        isGreen ? 'bg-emerald-500 border-emerald-400' : 'bg-red-500 border-red-400'
                                      } border hover:opacity-100 transition-all cursor-pointer hover:scale-x-150 hover:z-10`}
                                      style={{
                                        bottom: `${bodyBottom}%`,
                                        height: `${bodyHeight}%`,
                                        minHeight: '2px'
                                      }}
                                    >
                                    </div>
                                    
                                    {/* TOOLTIP - Smart positioning: above by default, below when near top */}
                                    {(() => {
                                      // Show tooltip below if candle is in top 30% of chart
                                      const showBelow = highHeight > 70;
                                      return (
                                        <div 
                                          className="absolute left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-200"
                                          style={{
                                            ...(showBelow ? {
                                              top: `${100 - lowHeight}%`,
                                              marginTop: '8px',
                                            } : {
                                              bottom: `${highHeight}%`,
                                              marginBottom: '8px',
                                            }),
                                            zIndex: 1000
                                          }}
                                        >
                                          <div className="bg-slate-800 border-2 border-violet-500 rounded-lg px-3 py-2.5 text-xs whitespace-nowrap shadow-2xl">
                                            <div className="text-violet-300 font-bold border-b border-slate-700 pb-1.5 mb-1">
                                              {bar.time ? new Date(bar.time).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : `Bar ${i + 1}`}
                                            </div>
                                            <div className="flex justify-between gap-4">
                                              <span className="text-slate-400">Open:</span>
                                              <span className="font-semibold text-white">${(bar.open || bar.close).toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between gap-4">
                                              <span className="text-slate-400">High:</span>
                                              <span className="font-semibold text-emerald-400">${(bar.high || bar.close).toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between gap-4">
                                              <span className="text-slate-400">Low:</span>
                                              <span className="font-semibold text-red-400">${(bar.low || bar.close).toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between gap-4">
                                              <span className="text-slate-400">Close:</span>
                                              <span className={`font-semibold ${isGreen ? 'text-emerald-400' : 'text-red-400'}`}>
                                                ${(bar.close || 0).toFixed(2)}
                                              </span>
                                            </div>
                                            {bar.volume > 0 && (
                                              <div className="flex justify-between gap-4 border-t border-slate-700 pt-1.5 mt-1">
                                                <span className="text-slate-400">Volume:</span>
                                                <span className="font-semibold text-blue-400">{(bar.volume || 0).toLocaleString()}</span>
                                              </div>
                                            )}
                                            <div className="flex justify-between gap-4 border-t border-slate-700 pt-1.5 mt-1">
                                              <span className="text-slate-400">Change:</span>
                                              <span className={`font-semibold ${isGreen ? 'text-emerald-400' : 'text-red-400'}`}>
                                                {isGreen ? '+' : ''}{((bar.close - (bar.open || bar.close)) / (bar.open || bar.close) * 100).toFixed(2)}%
                                              </span>
                                            </div>
                                          </div>
                                        </div>
                                      );
                                    })()}
                                  </div>
                                );
                              });
                              })()}
                            </div>
                            
                            {/* OVERLAY INDICATORS (SMA, EMA, Bollinger, VWAP) */}
                            {(() => {
                              const validBars = tickerData.timeSeries.filter(b => b && b.low && b.high && !isNaN(b.low) && !isNaN(b.high));
                              if (validBars.length === 0) return null;
                              
                              const closes = tickerData.timeSeries.map(b => b.close);
                              const highs = tickerData.timeSeries.map(b => b.high);
                              const lows = tickerData.timeSeries.map(b => b.low);
                              const volumes = tickerData.timeSeries.map(b => b.volume || 0);
                              const minPrice = Math.min(...validBars.map(b => b.low));
                              const maxPrice = Math.max(...validBars.map(b => b.high));
                              const priceRange = maxPrice - minPrice || 1;
                              
                              // Helper to convert price to Y position (percentage from bottom)
                              const priceToY = (price) => 100 - (((price - minPrice) / priceRange) * 95 + 5);
                              
                              // Calculate SMA
                              const calcSMA = (data, period) => {
                                return data.map((_, i) => {
                                  if (i < period - 1) return null;
                                  const slice = data.slice(i - period + 1, i + 1);
                                  return slice.reduce((a, b) => a + b, 0) / period;
                                });
                              };
                              
                              // Calculate EMA
                              const calcEMA = (data, period) => {
                                const k = 2 / (period + 1);
                                const emaArray = [];
                                let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
                                for (let i = 0; i < data.length; i++) {
                                  if (i < period - 1) {
                                    emaArray.push(null);
                                  } else if (i === period - 1) {
                                    emaArray.push(ema);
                                  } else {
                                    ema = data[i] * k + ema * (1 - k);
                                    emaArray.push(ema);
                                  }
                                }
                                return emaArray;
                              };
                              
                              // Calculate Bollinger Bands
                              const calcBollinger = (data, period, stdDev) => {
                                const sma = calcSMA(data, period);
                                return data.map((_, i) => {
                                  if (sma[i] === null) return { upper: null, middle: null, lower: null };
                                  const slice = data.slice(Math.max(0, i - period + 1), i + 1);
                                  const mean = sma[i];
                                  const variance = slice.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / slice.length;
                                  const std = Math.sqrt(variance);
                                  return {
                                    upper: mean + stdDev * std,
                                    middle: mean,
                                    lower: mean - stdDev * std
                                  };
                                });
                              };
                              
                              // Calculate VWAP
                              const calcVWAP = () => {
                                let cumTypicalPriceVolume = 0;
                                let cumVolume = 0;
                                return tickerData.timeSeries.map((bar, i) => {
                                  const typicalPrice = (bar.high + bar.low + bar.close) / 3;
                                  cumTypicalPriceVolume += typicalPrice * (bar.volume || 1);
                                  cumVolume += (bar.volume || 1);
                                  return cumVolume > 0 ? cumTypicalPriceVolume / cumVolume : null;
                                });
                              };
                              
                              const smaValues = showSMA ? calcSMA(closes, smaPeriod) : [];
                              const emaValues = showEMA ? calcEMA(closes, emaPeriod) : [];
                              const bollingerValues = showBollinger ? calcBollinger(closes, bollingerPeriod, bollingerStdDev) : [];
                              const vwapValues = showVWAP ? calcVWAP() : [];
                              
                              const chartWidth = Math.max(tickerData.timeSeries.length * 8, 800);
                              
                              return (
                                <svg 
                                  className="absolute inset-0 pointer-events-none" 
                                  style={{ left: '64px', right: '8px', top: 0, bottom: '32px', width: `calc(100% - 72px)`, height: 'calc(100% - 32px)' }}
                                  preserveAspectRatio="none"
                                  viewBox={`0 0 ${tickerData.timeSeries.length} 100`}
                                >
                                  {/* Bollinger Bands - Draw first so it's behind everything */}
                                  {showBollinger && bollingerValues.length > 0 && (
                                    <>
                                      {/* Upper band */}
                                      <polyline
                                        points={bollingerValues.map((b, i) => b.upper !== null ? `${i},${priceToY(b.upper)}` : '').filter(p => p).join(' ')}
                                        fill="none"
                                        stroke="#22d3ee"
                                        strokeWidth="0.3"
                                        strokeDasharray="2,2"
                                        opacity="0.7"
                                      />
                                      {/* Middle band (SMA) */}
                                      <polyline
                                        points={bollingerValues.map((b, i) => b.middle !== null ? `${i},${priceToY(b.middle)}` : '').filter(p => p).join(' ')}
                                        fill="none"
                                        stroke="#22d3ee"
                                        strokeWidth="0.4"
                                        opacity="0.8"
                                      />
                                      {/* Lower band */}
                                      <polyline
                                        points={bollingerValues.map((b, i) => b.lower !== null ? `${i},${priceToY(b.lower)}` : '').filter(p => p).join(' ')}
                                        fill="none"
                                        stroke="#22d3ee"
                                        strokeWidth="0.3"
                                        strokeDasharray="2,2"
                                        opacity="0.7"
                                      />
                                    </>
                                  )}
                                  
                                  {/* SMA Line */}
                                  {showSMA && smaValues.length > 0 && (
                                    <polyline
                                      points={smaValues.map((v, i) => v !== null ? `${i},${priceToY(v)}` : '').filter(p => p).join(' ')}
                                      fill="none"
                                      stroke="#3b82f6"
                                      strokeWidth="0.5"
                                    />
                                  )}
                                  
                                  {/* EMA Line */}
                                  {showEMA && emaValues.length > 0 && (
                                    <polyline
                                      points={emaValues.map((v, i) => v !== null ? `${i},${priceToY(v)}` : '').filter(p => p).join(' ')}
                                      fill="none"
                                      stroke="#f97316"
                                      strokeWidth="0.5"
                                    />
                                  )}
                                  
                                  {/* VWAP Line */}
                                  {showVWAP && vwapValues.length > 0 && (
                                    <polyline
                                      points={vwapValues.map((v, i) => v !== null ? `${i},${priceToY(v)}` : '').filter(p => p).join(' ')}
                                      fill="none"
                                      stroke="#ec4899"
                                      strokeWidth="0.5"
                                    />
                                  )}

                                  {/* COMPARISON OVERLAY LINE */}
                                  {showComparison && comparisonData?.timeSeries?.length > 0 && (() => {
                                    // Normalize comparison data to overlay on the main chart's price scale
                                    const mainCloses = tickerData.timeSeries.map(b => b.close);
                                    const compCloses = comparisonData.timeSeries.map(b => b.close);

                                    // Use percentage change from start to normalize both to same scale
                                    const mainStart = mainCloses[0] || 1;
                                    const compStart = compCloses[0] || 1;

                                    // Map comparison closes to the main chart's price range
                                    const normalizedComp = compCloses.map(c => {
                                      const compPctChange = (c - compStart) / compStart;
                                      return mainStart * (1 + compPctChange);
                                    });

                                    // Sample comparison data to match main chart length
                                    const mainLen = mainCloses.length;
                                    const compLen = normalizedComp.length;
                                    const sampledComp = [];
                                    for (let ci = 0; ci < mainLen; ci++) {
                                      const compIdx = Math.round((ci / mainLen) * compLen);
                                      const val = normalizedComp[Math.min(compIdx, compLen - 1)];
                                      if (val != null) sampledComp.push({ x: ci, y: priceToY(val) });
                                    }

                                    return sampledComp.length > 1 ? (
                                      <polyline
                                        points={sampledComp.map(p => `${p.x},${p.y}`).join(' ')}
                                        fill="none"
                                        stroke="#fbbf24"
                                        strokeWidth="0.7"
                                        strokeDasharray="3,1"
                                        opacity="0.85"
                                      />
                                    ) : null;
                                  })()}
                                </svg>
                              );
                            })()}
                            
                            {/* Overlay Legend */}
                            {(showSMA || showEMA || showBollinger || showVWAP || showComparison) && (
                              <div className="absolute top-2 right-20 bg-slate-900/90 rounded px-2 py-1 text-xs flex gap-3 z-20">
                                {showSMA && <span className="text-blue-400">━ SMA({smaPeriod})</span>}
                                {showEMA && <span className="text-orange-400">━ EMA({emaPeriod})</span>}
                                {showBollinger && <span className="text-cyan-400">┄ BB({bollingerPeriod},{bollingerStdDev})</span>}
                                {showVWAP && <span className="text-pink-400">━ VWAP</span>}
                                {showComparison && comparisonData && <span className="text-amber-400">┄ {comparisonData.symbol} (normalized)</span>}
                              </div>
                            )}
                            
                            {/* Date labels on X-axis */}
                            <div className="absolute bottom-0 left-16 right-0 h-8 flex justify-between items-center text-xs text-slate-400 border-t border-slate-700 px-2 bg-slate-900/80">
                              {(() => {
                                const labelCount = Math.min(10, tickerData.timeSeries.length);
                                const step = Math.floor(tickerData.timeSeries.length / labelCount);
                                return Array.from({ length: labelCount }, (_, i) => {
                                  const index = i * step;
                                  const bar = tickerData.timeSeries[index];
                                  if (!bar || !bar.time) return null;
                                  
                                  const barDate = new Date(bar.time);
                                  const numCandles = tickerData.timeSeries.length;
                                  
                                  // Smart date/time display logic
                                  // If we have data over multiple days (>50 candles or time span > 1 day), show dates
                                  // Otherwise show times (for intraday charts)
                                  const firstBar = tickerData.timeSeries[0];
                                  const lastBar = tickerData.timeSeries[tickerData.timeSeries.length - 1];
                                  if (firstBar && lastBar && firstBar.time && lastBar.time) {
                                    const timeSpanDays = (new Date(lastBar.time) - new Date(firstBar.time)) / (1000 * 60 * 60 * 24);
                                    
                                    // Show times for intraday (< 1 day) or very small datasets
                                    // Show dates for multi-day charts
                                    const showTimes = timeSpanDays < 1 && numCandles < 100;
                                    
                                    return (
                                      <div key={i} className="text-center text-xs">
                                        {showTimes 
                                          ? barDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
                                          : barDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                                        }
                                      </div>
                                    );
                                  }
                                  
                                  return (
                                    <div key={i} className="text-center text-xs">
                                      {barDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                    </div>
                                  );
                                });
                              })()}
                            </div>
                          </div>
                          
                          <div className="text-xs text-slate-500 mt-2 text-center">
                            💡 Hover over candles for details • Scroll horizontally to see all {tickerData.timeSeries.length} candles
                          </div>
                          
                          {/* VOLUME BARS - Inside same scroll container */}
                          {showVolume && (
                            <div className="mt-4 border-t border-slate-700 pt-4">
                              <div className="text-xs text-slate-400 mb-2 font-semibold">Volume</div>
                              <div className="h-24 flex items-end gap-0.5 pl-16" style={{ width: `${Math.max(tickerData.timeSeries.length * 8, 800)}px` }}>
                                {(() => {
                                  // PRE-CALCULATE maxVol ONCE for performance
                                  const maxVol = Math.max(...tickerData.timeSeries.map(b => b.volume || 0).filter(v => v > 0));
                                  if (maxVol === 0) return null;
                                  
                                  return tickerData.timeSeries.map((bar, i) => {
                                    const height = ((bar.volume || 0) / maxVol) * 100;
                                    const isGreen = bar.close >= (bar.open || bar.close);
                                    
                                    return (
                                      <div
                                        key={i}
                                        className={`relative group ${isGreen ? 'bg-emerald-500/60' : 'bg-red-500/60'} hover:opacity-100 transition-opacity duration-150`}
                                        style={{ 
                                          height: `${height}%`,
                                          width: '6px',
                                          minWidth: '6px'
                                        }}
                                        title={`Volume: ${(bar.volume || 0).toLocaleString()}`}
                                      >
                                        <div className="opacity-0 group-hover:opacity-100 absolute left-1/2 -translate-x-1/2 bottom-full mb-1 bg-slate-800 border border-violet-500 rounded px-2 py-1 text-xs whitespace-nowrap pointer-events-none z-50 transition-opacity duration-150">
                                          Vol: {(bar.volume || 0).toLocaleString()}
                                        </div>
                                      </div>
                                    );
                                  });
                                })()}
                              </div>
                            </div>
                          )}
                        </div>
                        
                        {/* RSI INDICATOR - FIXED */}
                        {showRSI && (() => {
                          const closes = tickerData.timeSeries.map(b => b.close).filter(p => p && !isNaN(p));
                          if (closes.length < 15) return (
                            <div className="bg-slate-900 rounded-lg p-4 border-2 border-slate-700 mt-4">
                              <div className="text-xs text-slate-400 font-semibold mb-2">RSI (14)</div>
                              <div className="text-center text-slate-500 py-4">
                                Need at least 15 data points for RSI. Current: {closes.length}
                              </div>
                            </div>
                          );
                          
                          // Calculate RSI using Wilder's Smoothed Moving Average
                          const period = 14;
                          const rsiValues = [];
                          
                          // Step 1: Calculate price changes
                          const changes = [];
                          for (let i = 1; i < closes.length; i++) {
                            changes.push(closes[i] - closes[i - 1]);
                          }
                          
                          // Step 2: Separate gains and losses
                          const gains = changes.map(c => c > 0 ? c : 0);
                          const losses = changes.map(c => c < 0 ? Math.abs(c) : 0);
                          
                          // Step 3: Calculate RSI for each point
                          let avgGain = 0;
                          let avgLoss = 0;
                          
                          for (let i = 0; i < changes.length; i++) {
                            if (i < period - 1) {
                              // Not enough data yet, use placeholder
                              rsiValues.push(null);
                            } else if (i === period - 1) {
                              // First RSI: simple average of first 14 periods
                              avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
                              avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
                              
                              if (avgLoss === 0) {
                                rsiValues.push(100);
                              } else {
                                const rs = avgGain / avgLoss;
                                rsiValues.push(100 - (100 / (1 + rs)));
                              }
                            } else {
                              // Subsequent RSI: Wilder's smoothing
                              avgGain = ((avgGain * (period - 1)) + gains[i]) / period;
                              avgLoss = ((avgLoss * (period - 1)) + losses[i]) / period;
                              
                              if (avgLoss === 0) {
                                rsiValues.push(100);
                              } else {
                                const rs = avgGain / avgLoss;
                                rsiValues.push(100 - (100 / (1 + rs)));
                              }
                            }
                          }
                          
                          // Filter out nulls for display
                          const validRSI = rsiValues.filter(v => v !== null);
                          const currentRSI = validRSI.length > 0 ? validRSI[validRSI.length - 1] : 50;
                          
                          // For line chart, we need to align with candle positions
                          const chartWidth = tickerData.timeSeries.length;
                          
                          return (
                            <div className="bg-slate-900 rounded-lg p-4 border-2 border-slate-700 mt-4">
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                  <div className="text-xs text-slate-400 font-semibold">RSI (14)</div>
                                  <div className="group relative">
                                    <HelpCircle className="w-3.5 h-3.5 text-slate-500 cursor-help hover:text-violet-400 transition-colors" />
                                    <div className="absolute left-0 top-full mt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl transition-all duration-200" style={{ zIndex: 9999 }}>
                                      <div className="font-semibold text-violet-400 mb-1">📈 RSI (Relative Strength Index)</div>
                                      <p className="mb-2">Momentum oscillator measuring speed of price changes.</p>
                                      <div className="space-y-1 text-[10px]">
                                        <div className="flex items-center gap-2"><span className="text-red-400">●</span> Above 70 = Overbought</div>
                                        <div className="flex items-center gap-2"><span className="text-emerald-400">●</span> Below 30 = Oversold</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                <div className="flex items-center gap-3">
                                  <div className={`text-lg font-bold tabular-nums ${
                                    currentRSI > 70 ? 'text-red-400' : currentRSI < 30 ? 'text-emerald-400' : 'text-violet-400'
                                  }`}>
                                    {currentRSI.toFixed(1)}
                                  </div>
                                  <div className={`text-xs px-2.5 py-1 rounded-full font-medium ${
                                    currentRSI > 70 ? 'bg-red-500/20 text-red-300' : 
                                    currentRSI < 30 ? 'bg-emerald-500/20 text-emerald-300' : 
                                    'bg-violet-500/20 text-violet-300'
                                  }`}>
                                    {currentRSI > 70 ? 'Overbought' : currentRSI < 30 ? 'Oversold' : 'Neutral'}
                                  </div>
                                </div>
                              </div>
                              
                              <div className="h-24 relative bg-slate-800/50 rounded border border-slate-700">
                                {/* Overbought zone (70-100) */}
                                <div className="absolute w-full bg-red-500/10" style={{ top: 0, height: '30%' }} />
                                {/* Oversold zone (0-30) */}
                                <div className="absolute w-full bg-emerald-500/10" style={{ bottom: 0, height: '30%' }} />
                                
                                {/* 70 line */}
                                <div className="absolute w-full border-t border-red-500/50" style={{ top: '30%' }}>
                                  <span className="absolute right-1 -top-2.5 text-[10px] text-red-400">70</span>
                                </div>
                                {/* 50 line */}
                                <div className="absolute w-full border-t border-slate-600/50" style={{ top: '50%' }}>
                                  <span className="absolute right-1 -top-2.5 text-[10px] text-slate-500">50</span>
                                </div>
                                {/* 30 line */}
                                <div className="absolute w-full border-t border-emerald-500/50" style={{ top: '70%' }}>
                                  <span className="absolute right-1 -top-2.5 text-[10px] text-emerald-400">30</span>
                                </div>
                                
                                {/* RSI Line */}
                                <svg
                                  className="absolute inset-0 w-full h-full"
                                  viewBox={`0 0 ${validRSI.length + 4} 100`}
                                  preserveAspectRatio="none"
                                >
                                  <polyline
                                    points={validRSI.map((val, i) => `${i + 1},${100 - val}`).join(' ')}
                                    fill="none"
                                    stroke="#8b5cf6"
                                    strokeWidth="1.5"
                                    vectorEffect="non-scaling-stroke"
                                    strokeLinejoin="round"
                                    strokeLinecap="round"
                                  />
                                </svg>
                                {/* Current value dot - CSS positioned to avoid SVG distortion */}
                                <div
                                  className="absolute w-2 h-2 bg-violet-500 rounded-full shadow-lg shadow-violet-500/50"
                                  style={{
                                    right: `${(3 / (validRSI.length + 4)) * 100}%`,
                                    top: `${100 - currentRSI}%`,
                                    transform: 'translate(50%, -50%)',
                                  }}
                                />
                              </div>
                            </div>
                          );
                        })()}
                        
                        {/* MACD INDICATOR */}
                        {showMACD && (() => {
                          const prices = tickerData.timeSeries.map(b => b.close).filter(p => p && !isNaN(p));
                          if (prices.length < 35) return (
                            <div className="bg-slate-900 rounded-lg p-4 border-2 border-slate-700 mt-4">
                              <div className="text-xs text-slate-400 font-semibold mb-2">MACD (12, 26, 9)</div>
                              <div className="text-center text-slate-500 py-4">
                                Need at least 35 data points for MACD. Current: {prices.length}
                              </div>
                            </div>
                          );
                          
                          // Calculate EMA helper function
                          const calculateEMA = (data, period) => {
                            const k = 2 / (period + 1);
                            const emaArray = [];
                            let emaValue = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
                            
                            for (let i = 0; i < data.length; i++) {
                              if (i < period - 1) {
                                emaArray.push(null);
                              } else if (i === period - 1) {
                                emaArray.push(emaValue);
                              } else {
                                emaValue = data[i] * k + emaValue * (1 - k);
                                emaArray.push(emaValue);
                              }
                            }
                            return emaArray;
                          };
                          
                          // Calculate MACD line, Signal line, and Histogram
                          const fastEMA = calculateEMA(prices, 12);
                          const slowEMA = calculateEMA(prices, 26);
                          
                          // MACD Line = Fast EMA - Slow EMA
                          const macdLine = prices.map((_, i) => {
                            if (fastEMA[i] === null || slowEMA[i] === null) return null;
                            return fastEMA[i] - slowEMA[i];
                          });
                          
                          // Filter out nulls for signal line calculation
                          const validMacdValues = macdLine.filter(v => v !== null);
                          const signalEMA = calculateEMA(validMacdValues, 9);
                          
                          // Build full arrays with proper alignment
                          const macdValues = [];
                          const signalValues = [];
                          const histogramValues = [];
                          
                          let macdIdx = 0;
                          for (let i = 0; i < prices.length; i++) {
                            if (macdLine[i] === null) {
                              macdValues.push(null);
                              signalValues.push(null);
                              histogramValues.push(0);
                            } else {
                              macdValues.push(macdLine[i]);
                              const signal = signalEMA[macdIdx] || null;
                              signalValues.push(signal);
                              histogramValues.push(signal !== null ? macdLine[i] - signal : 0);
                              macdIdx++;
                            }
                          }
                          
                          // Get current values
                          const currentMACD = macdValues.filter(v => v !== null).slice(-1)[0] || 0;
                          const currentSignal = signalValues.filter(v => v !== null).slice(-1)[0] || 0;
                          const currentHistogram = currentMACD - currentSignal;
                          
                          // Get last N histogram values for display
                          const displayCount = Math.min(100, histogramValues.length);
                          const displayHistogram = histogramValues.slice(-displayCount);
                          const maxHist = Math.max(...displayHistogram.map(Math.abs), 0.001);
                          
                          return (
                            <div className="bg-slate-900 rounded-lg p-4 border-2 border-slate-700 mt-4 overflow-x-auto">
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                  <div className="text-xs text-slate-400 font-semibold">MACD (12, 26, 9)</div>
                                  <div className="group relative">
                                    <HelpCircle className="w-3.5 h-3.5 text-slate-500 cursor-help hover:text-blue-400 transition-colors" />
                                    <div className="absolute left-0 top-full mt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible w-72 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl transition-all duration-200" style={{ zIndex: 9999 }}>
                                      <div className="font-semibold text-blue-400 mb-1">📉 MACD (Moving Average Convergence Divergence)</div>
                                      <p className="mb-2">Trend-following momentum indicator showing relationship between two EMAs.</p>
                                      <div className="space-y-1 text-[10px]">
                                        <div className="flex items-center gap-2"><span className="text-emerald-400">●</span> Green bars = Bullish (MACD &gt; Signal)</div>
                                        <div className="flex items-center gap-2"><span className="text-red-400">●</span> Red bars = Bearish (MACD &lt; Signal)</div>
                                        <div className="flex items-center gap-2"><span className="text-yellow-400">●</span> Crossover = Trend change signal</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                <div className="flex gap-4 text-xs tabular-nums">
                                  <span className="text-blue-400">MACD: {currentMACD.toFixed(2)}</span>
                                  <span className="text-orange-400">Signal: {currentSignal.toFixed(2)}</span>
                                  <span className={currentHistogram > 0 ? 'text-emerald-400' : 'text-red-400'}>
                                    Hist: {currentHistogram.toFixed(2)}
                                  </span>
                                </div>
                              </div>
                              
                              <div className="h-32 relative bg-slate-800/50 rounded border border-slate-700" style={{ width: `${Math.max(displayHistogram.length * 6, 400)}px`, minWidth: '100%' }}>
                                {/* Zero line */}
                                <div className="absolute w-full border-t border-slate-500" style={{ top: '50%' }}>
                                  <span className="absolute right-2 -top-3 text-xs text-slate-500 bg-slate-900 px-1">0</span>
                                </div>
                                
                                {/* Histogram bars */}
                                <div className="absolute inset-0 flex items-center px-1" style={{ gap: '1px' }}>
                                  {displayHistogram.map((hist, i) => {
                                    const isPositive = hist >= 0;
                                    const heightPercent = Math.abs(hist) / maxHist * 45; // Max 45% in each direction
                                    
                                    return (
                                      <div 
                                        key={i} 
                                        className="relative"
                                        style={{ 
                                          flex: '1 1 0',
                                          minWidth: '4px',
                                          height: '100%'
                                        }}
                                      >
                                        <div
                                          className={`absolute left-0 right-0 ${isPositive ? 'bg-emerald-500' : 'bg-red-500'}`}
                                          style={{
                                            height: `${heightPercent}%`,
                                            ...(isPositive ? {
                                              bottom: '50%',
                                            } : {
                                              top: '50%',
                                            })
                                          }}
                                          title={`Histogram: ${hist.toFixed(3)}`}
                                        />
                                      </div>
                                    );
                                  })}
                                </div>
                                
                                {/* Signal indicator */}
                                <div className="absolute top-2 left-2 text-xs">
                                  {currentMACD > currentSignal && currentHistogram > 0 && (
                                    <span className="bg-emerald-500/20 text-emerald-300 px-2 py-1 rounded border border-emerald-500/50">
                                      ↑ Bullish
                                    </span>
                                  )}
                                  {currentMACD < currentSignal && currentHistogram < 0 && (
                                    <span className="bg-red-500/20 text-red-300 px-2 py-1 rounded border border-red-500/50">
                                      ↓ Bearish
                                    </span>
                                  )}
                                  {Math.abs(currentHistogram) < 0.01 && (
                                    <span className="bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded border border-yellow-500/50">
                                      ⚡ Crossover
                                    </span>
                                  )}
                                </div>
                              </div>
                            </div>
                          );
                        })()}
                        
                        {/* STOCHASTIC OSCILLATOR */}
                        {showStochastic && (() => {
                          const bars = tickerData.timeSeries;
                          if (bars.length < 14) return (
                            <div className="bg-slate-900 rounded-lg p-4 border-2 border-slate-700 mt-4">
                              <div className="text-xs text-slate-400 font-semibold mb-2">Stochastic (14,3,3)</div>
                              <div className="text-center text-slate-500 py-4">
                                Need at least 14 data points. Current: {bars.length}
                              </div>
                            </div>
                          );
                          
                          const period = 14;
                          const smoothK = 3;
                          const smoothD = 3;
                          
                          // Calculate %K values
                          const rawK = [];
                          for (let i = 0; i < bars.length; i++) {
                            if (i < period - 1) {
                              rawK.push(null);
                            } else {
                              const slice = bars.slice(i - period + 1, i + 1);
                              const highestHigh = Math.max(...slice.map(b => b.high));
                              const lowestLow = Math.min(...slice.map(b => b.low));
                              const currentClose = bars[i].close;
                              
                              if (highestHigh === lowestLow) {
                                rawK.push(50);
                              } else {
                                rawK.push(((currentClose - lowestLow) / (highestHigh - lowestLow)) * 100);
                              }
                            }
                          }
                          
                          // Smooth %K with SMA
                          const kValues = rawK.map((_, i) => {
                            if (i < period - 1 + smoothK - 1) return null;
                            const slice = rawK.slice(i - smoothK + 1, i + 1).filter(v => v !== null);
                            if (slice.length === 0) return null;
                            return slice.reduce((a, b) => a + b, 0) / slice.length;
                          });
                          
                          // Calculate %D (SMA of %K)
                          const dValues = kValues.map((_, i) => {
                            if (i < period - 1 + smoothK - 1 + smoothD - 1) return null;
                            const slice = kValues.slice(i - smoothD + 1, i + 1).filter(v => v !== null);
                            if (slice.length === 0) return null;
                            return slice.reduce((a, b) => a + b, 0) / slice.length;
                          });
                          
                          const validK = kValues.filter(v => v !== null);
                          const validD = dValues.filter(v => v !== null);
                          const currentK = validK.length > 0 ? validK[validK.length - 1] : 50;
                          const currentD = validD.length > 0 ? validD[validD.length - 1] : 50;
                          
                          return (
                            <div className="bg-slate-900 rounded-lg p-4 border-2 border-slate-700 mt-4">
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                  <div className="text-xs text-slate-400 font-semibold">Stochastic (14,3,3)</div>
                                  <div className="group relative">
                                    <HelpCircle className="w-3.5 h-3.5 text-slate-500 cursor-help hover:text-cyan-400 transition-colors" />
                                    <div className="absolute left-0 top-full mt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible w-72 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl transition-all duration-200" style={{ zIndex: 9999 }}>
                                      <div className="font-semibold text-cyan-400 mb-1">🔄 Stochastic Oscillator (14,3,3)</div>
                                      <p className="mb-2">Compares closing price to price range over time.</p>
                                      <div className="space-y-1 text-[10px]">
                                        <div className="flex items-center gap-2"><span className="text-blue-400">━</span> Blue = %K (fast line)</div>
                                        <div className="flex items-center gap-2"><span className="text-orange-400">┄</span> Orange = %D (slow signal)</div>
                                        <div className="flex items-center gap-2"><span className="text-red-400">●</span> Above 80 = Overbought</div>
                                        <div className="flex items-center gap-2"><span className="text-emerald-400">●</span> Below 20 = Oversold</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                <div className="flex items-center gap-3 text-sm tabular-nums">
                                  <span className="text-blue-400">%K: {currentK.toFixed(1)}</span>
                                  <span className="text-orange-400">%D: {currentD.toFixed(1)}</span>
                                  <div className={`text-xs px-2.5 py-1 rounded-full font-medium ${
                                    currentK > 80 ? 'bg-red-500/20 text-red-300' : 
                                    currentK < 20 ? 'bg-emerald-500/20 text-emerald-300' : 
                                    'bg-violet-500/20 text-violet-300'
                                  }`}>
                                    {currentK > 80 ? 'Overbought' : currentK < 20 ? 'Oversold' : 'Neutral'}
                                  </div>
                                </div>
                              </div>
                              
                              <div className="h-24 relative bg-slate-800/50 rounded border border-slate-700">
                                {/* Overbought zone */}
                                <div className="absolute w-full bg-red-500/10" style={{ top: 0, height: '20%' }} />
                                {/* Oversold zone */}
                                <div className="absolute w-full bg-emerald-500/10" style={{ bottom: 0, height: '20%' }} />
                                
                                <div className="absolute w-full border-t border-red-500/50" style={{ top: '20%' }}>
                                  <span className="absolute right-1 -top-2.5 text-[10px] text-red-400">80</span>
                                </div>
                                <div className="absolute w-full border-t border-emerald-500/50" style={{ top: '80%' }}>
                                  <span className="absolute right-1 -top-2.5 text-[10px] text-emerald-400">20</span>
                                </div>
                                
                                <svg 
                                  className="absolute inset-0 w-full h-full" 
                                  viewBox={`0 0 ${validK.length} 100`}
                                  preserveAspectRatio="none"
                                >
                                  {/* %K line */}
                                  <polyline
                                    points={validK.map((val, i) => `${i},${100 - val}`).join(' ')}
                                    fill="none"
                                    stroke="#3b82f6"
                                    strokeWidth="2"
                                    vectorEffect="non-scaling-stroke"
                                  />
                                  {/* %D line */}
                                  {validD.length > 0 && (
                                    <polyline
                                      points={validD.map((val, i) => val !== null ? `${i + (validK.length - validD.length)},${100 - val}` : '').filter(p => p).join(' ')}
                                      fill="none"
                                      stroke="#f97316"
                                      strokeWidth="2"
                                      strokeDasharray="4,2"
                                      vectorEffect="non-scaling-stroke"
                                    />
                                  )}
                                </svg>
                              </div>
                            </div>
                          );
                        })()}
                        
                        {/* ATR (Average True Range) */}
                        {showATR && (() => {
                          const bars = tickerData.timeSeries;
                          if (bars.length < 15) return (
                            <div className="bg-slate-900 rounded-lg p-4 border-2 border-slate-700 mt-4">
                              <div className="text-xs text-slate-400 font-semibold mb-2">ATR (14)</div>
                              <div className="text-center text-slate-500 py-4">
                                Need at least 15 data points. Current: {bars.length}
                              </div>
                            </div>
                          );
                          
                          const period = 14;
                          
                          // Calculate True Range
                          const trueRanges = [];
                          for (let i = 0; i < bars.length; i++) {
                            if (i === 0) {
                              trueRanges.push(bars[i].high - bars[i].low);
                            } else {
                              const highLow = bars[i].high - bars[i].low;
                              const highClose = Math.abs(bars[i].high - bars[i - 1].close);
                              const lowClose = Math.abs(bars[i].low - bars[i - 1].close);
                              trueRanges.push(Math.max(highLow, highClose, lowClose));
                            }
                          }
                          
                          // Calculate ATR using Wilder's smoothing
                          const atrValues = [];
                          let atr = 0;
                          
                          for (let i = 0; i < trueRanges.length; i++) {
                            if (i < period - 1) {
                              atrValues.push(null);
                            } else if (i === period - 1) {
                              atr = trueRanges.slice(0, period).reduce((a, b) => a + b, 0) / period;
                              atrValues.push(atr);
                            } else {
                              atr = ((atr * (period - 1)) + trueRanges[i]) / period;
                              atrValues.push(atr);
                            }
                          }
                          
                          const validATR = atrValues.filter(v => v !== null);
                          const currentATR = validATR.length > 0 ? validATR[validATR.length - 1] : 0;
                          const maxATR = Math.max(...validATR);
                          const minATR = Math.min(...validATR);
                          const currentPrice = bars[bars.length - 1].close;
                          const atrPercent = (currentATR / currentPrice) * 100;
                          
                          return (
                            <div className="bg-slate-900 rounded-lg p-4 border-2 border-slate-700 mt-4">
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                  <div className="text-xs text-slate-400 font-semibold">ATR (14)</div>
                                  <div className="group relative">
                                    <HelpCircle className="w-3.5 h-3.5 text-slate-500 cursor-help hover:text-amber-400 transition-colors" />
                                    <div className="absolute left-0 top-full mt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl transition-all duration-200" style={{ zIndex: 9999 }}>
                                      <div className="font-semibold text-amber-400 mb-1">📏 ATR (Average True Range)</div>
                                      <p className="mb-2">Measures market volatility by averaging true range of price movement.</p>
                                      <div className="space-y-1 text-[10px]">
                                        <div className="flex items-center gap-2"><span className="text-red-400">●</span> High ATR = High volatility</div>
                                        <div className="flex items-center gap-2"><span className="text-emerald-400">●</span> Low ATR = Low volatility</div>
                                        <div className="flex items-center gap-2"><span className="text-slate-400">●</span> Use 2x ATR for stop-loss</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                <div className="flex items-center gap-3 text-sm tabular-nums">
                                  <span className="text-amber-400 font-bold">${currentATR.toFixed(2)}</span>
                                  <span className="text-slate-400">({atrPercent.toFixed(2)}%)</span>
                                  <div className={`text-xs px-2.5 py-1 rounded-full font-medium ${
                                    atrPercent >= 4 ? 'bg-red-500/20 text-red-300' :
                                    atrPercent >= 2.5 ? 'bg-amber-500/20 text-amber-300' :
                                    atrPercent >= 1.5 ? 'bg-violet-500/20 text-violet-300' :
                                    atrPercent >= 0.8 ? 'bg-blue-500/20 text-blue-300' :
                                    'bg-cyan-500/20 text-cyan-300'
                                  }`}>
                                    {atrPercent >= 4 ? 'High' : atrPercent >= 2.5 ? 'Med-High' : atrPercent >= 1.5 ? 'Medium' : atrPercent >= 0.8 ? 'Low-Med' : 'Low'}
                                  </div>
                                </div>
                              </div>
                              
                              <div className="h-20 relative bg-slate-800/50 rounded border border-slate-700">
                                <svg 
                                  className="absolute inset-0 w-full h-full" 
                                  viewBox={`0 0 ${validATR.length} ${maxATR - minATR || 1}`}
                                  preserveAspectRatio="none"
                                >
                                  {/* ATR area fill */}
                                  <polygon
                                    points={`0,${maxATR - minATR} ${validATR.map((val, i) => `${i},${maxATR - val}`).join(' ')} ${validATR.length - 1},${maxATR - minATR}`}
                                    fill="rgba(139, 92, 246, 0.2)"
                                  />
                                  {/* ATR line */}
                                  <polyline
                                    points={validATR.map((val, i) => `${i},${maxATR - val}`).join(' ')}
                                    fill="none"
                                    stroke="#8b5cf6"
                                    strokeWidth="2"
                                    vectorEffect="non-scaling-stroke"
                                  />
                                </svg>
                                
                                {/* Y-axis labels */}
                                <div className="absolute right-1 top-1 text-[10px] text-slate-500">${maxATR.toFixed(2)}</div>
                                <div className="absolute right-1 bottom-1 text-[10px] text-slate-500">${minATR.toFixed(2)}</div>
                              </div>
                            </div>
                          );
                        })()}
                        
                        {/* Enhanced price scale */}
                        <div className="mt-4 bg-slate-800/50 rounded px-4 py-2">
                          <div className="flex justify-between text-sm">
                            <div className="flex items-center gap-2">
                              <div className="w-3 h-3 bg-red-500 rounded"></div>
                              <span className="text-slate-400">Low:</span>
                              <span className="font-semibold text-red-400">
                                ${(Math.min(...tickerData.timeSeries.filter(b => b && b.low).map(b => b.low)) || 0).toFixed(2)}
                              </span>
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-slate-400">Bars:</span>
                              <span className="font-semibold text-violet-400">{tickerData.timeSeries.length}</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <div className="w-3 h-3 bg-emerald-500 rounded"></div>
                              <span className="text-slate-400">High:</span>
                              <span className="font-semibold text-emerald-400">
                                ${(Math.max(...tickerData.timeSeries.filter(b => b && b.high).map(b => b.high)) || 0).toFixed(2)}
                              </span>
                            </div>
                          </div>
                        </div>
                      </>
                    ) : (
                      <div className="h-80 flex items-center justify-center bg-slate-900 rounded-lg border-2 border-red-500/30">
                        <div className="text-center">
                          <LineChart className="w-16 h-16 mx-auto mb-3 text-red-400 opacity-50" />
                          <p className="text-lg font-semibold text-red-400">No Chart Data Available</p>
                          <p className="text-sm text-slate-500 mt-2">
                            Try enabling Demo Mode or check if market is open
                          </p>
                        </div>
                      </div>
                    )}
                  </div>

                  <button
                    onClick={captureTickerChart}
                    className="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-500 hover:to-emerald-600 text-white rounded-xl py-4 font-bold transition-all duration-200 flex items-center justify-center gap-3 shadow-lg shadow-emerald-500/25 hover:shadow-emerald-500/40 btn-press text-lg"
                  >
                    <Camera className="w-6 h-6" />
                    <span>Capture & Analyze Chart</span>
                  </button>
                </div>
              )}
            </div>
          </div>
        )}

        {activeTab === "analyze" && (
          <div className="space-y-4 md:space-y-6 animate-fadeIn">
            {/* Upload Section */}
            <div className="rounded-xl md:rounded-2xl p-4 md:p-6 card-premium">
              <div className="flex items-center justify-between mb-3 md:mb-6">
                <div className="flex items-center gap-3">
                  <div className="p-2.5 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl shadow-lg shadow-violet-500/20">
                    <BarChart3 className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <h2 className="text-xl font-bold bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">Consistent Chart Analysis</h2>
                    <p className="text-sm text-slate-400">Same image = same analysis every time</p>
                  </div>
                </div>
                
                <div className="flex items-center gap-3">
                  <select
                    value={selectedTimeframe}
                    onChange={(e) => setSelectedTimeframe(e.target.value)}
                    className="bg-slate-800/80 border border-slate-600/50 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/50 hover:border-slate-500 transition-colors cursor-pointer"
                  >
                    <option value="auto">Auto Timeframe</option>
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="30m">30 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="4h">4 Hours</option>
                    <option value="1D">Daily</option>
                    <option value="1W">Weekly</option>
                  </select>
                  
                  <select
                    value={selectedAssetType}
                    onChange={(e) => setSelectedAssetType(e.target.value)}
                    className="bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/50"
                  >
                    <option value="auto">Auto Asset</option>
                    <option value="Stock">Stock</option>
                    <option value="Crypto">Crypto</option>
                    <option value="Forex">Forex</option>
                    <option value="Commodity">Commodity</option>
                  </select>
                </div>
              </div>

              {/* NEW: Trade Type Selector with Auto-Detection */}
              <div className="mb-4 md:mb-6 bg-slate-800/30 rounded-xl p-3 md:p-4 border border-slate-700/30">
                <div className="flex items-center justify-between mb-2 md:mb-3">
                  <div className="flex items-center gap-2">
                    <Target className="w-4 h-4 text-violet-400" />
                    <span className="text-sm font-semibold text-slate-300">Trade Type</span>
                    <div className="relative group">
                      <HelpCircle className="w-4 h-4 text-slate-500 cursor-help hover:text-violet-400 transition-colors" />
                      <div className="hidden group-hover:block absolute left-full top-0 ml-2 z-50 w-64 p-3 bg-slate-900 border border-slate-700 rounded-lg shadow-xl text-xs text-slate-300">
                        Select your trading style or let MODUS auto-detect based on chart timeframe.
                      </div>
                    </div>
                  </div>
                  {/* Auto-detect toggle */}
                  <div className="flex items-center gap-2">
                    <span className="text-xs text-slate-400">Auto-detect</span>
                    <button
                      onClick={() => setUseAutoTradeType(!useAutoTradeType)}
                      className={`relative w-10 h-5 rounded-full transition-colors ${
                        useAutoTradeType ? 'bg-violet-600' : 'bg-slate-700'
                      }`}
                    >
                      <span className={`absolute top-0.5 left-0.5 w-4 h-4 rounded-full bg-white transition-transform ${
                        useAutoTradeType ? 'translate-x-5' : 'translate-x-0'
                      }`} />
                    </button>
                  </div>
                </div>
                {/* Show auto-detected style if available */}
                {useAutoTradeType && autoDetectedTradeType && (
                  <div className="mb-2 md:mb-3 px-3 py-2 bg-violet-900/30 border border-violet-500/30 rounded-lg">
                    <div className="flex items-center gap-2 text-sm">
                      <span className="text-violet-400">🎯 Auto-detected:</span>
                      <span className="font-semibold text-white">{autoDetectedTradeType.icon} {autoDetectedTradeType.name}</span>
                      <span className="text-xs text-slate-400 flex items-center gap-1 relative group">
                        ({autoDetectedTradeType.confidence} confidence)
                        <HelpCircle className="w-3 h-3 text-slate-500 hover:text-violet-400 cursor-help" />
                        {/* Auto-detect confidence tooltip */}
                        <div className="absolute left-0 top-full mt-2 w-56 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-xl z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                          <div className="text-xs text-slate-200 font-semibold mb-2">Detection Confidence:</div>
                          <div className="text-xs text-slate-300 space-y-1">
                            <p className="text-emerald-400">• High = Clear timeframe match</p>
                            <p className="text-yellow-400">• Medium = Good match</p>
                            <p className="text-orange-400">• Low = Ambiguous timeframe</p>
                          </div>
                          <div className="text-xs text-slate-400 mt-2 pt-2 border-t border-slate-700">
                            Based on chart timeframe detected
                          </div>
                        </div>
                      </span>
                    </div>
                    <div className="text-xs text-slate-400 mt-1">{autoDetectedTradeType.reason}</div>
                  </div>
                )}
                <div className="flex flex-wrap gap-1.5 md:gap-2">
                  {/* Scalp Trade */}
                  <div className="relative group">
                    <button
                      onClick={() => setSelectedTradeType("scalp")}
                      className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                        selectedTradeType === "scalp"
                          ? "bg-cyan-600 text-white border-2 border-cyan-400 shadow-lg shadow-cyan-500/20"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-cyan-500/50"
                      }`}
                    >
                      ⚡ Scalp
                    </button>
                    <div className="hidden group-hover:block absolute bottom-full left-0 mb-2 z-50 w-56 p-3 bg-slate-900 border border-slate-700 rounded-lg shadow-xl text-xs">
                      <div className="font-semibold text-cyan-400 mb-1">Scalp Trade</div>
                      <div className="text-slate-300">
                        <p>• Hold: Minutes to 1 hour</p>
                        <p>• Stop: 0.3-0.5%</p>
                        <p>• Target: 0.5-1%</p>
                        <p className="mt-1 text-slate-400">Quick in-and-out trades capturing small moves. Requires active monitoring.</p>
                      </div>
                    </div>
                  </div>

                  {/* Day Trade */}
                  <div className="relative group">
                    <button
                      onClick={() => setSelectedTradeType("day")}
                      className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                        selectedTradeType === "day"
                          ? "bg-blue-600 text-white border-2 border-blue-400 shadow-lg shadow-blue-500/20"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-blue-500/50"
                      }`}
                    >
                      📊 Day Trade
                    </button>
                    <div className="hidden group-hover:block absolute bottom-full left-0 mb-2 z-50 w-56 p-3 bg-slate-900 border border-slate-700 rounded-lg shadow-xl text-xs">
                      <div className="font-semibold text-blue-400 mb-1">Day Trade</div>
                      <div className="text-slate-300">
                        <p>• Hold: 1 hour to end of day</p>
                        <p>• Stop: 1-2%</p>
                        <p>• Target: 2-4%</p>
                        <p className="mt-1 text-slate-400">Close all positions before market close. No overnight risk.</p>
                      </div>
                    </div>
                  </div>

                  {/* Swing Trade */}
                  <div className="relative group">
                    <button
                      onClick={() => setSelectedTradeType("swing")}
                      className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                        selectedTradeType === "swing"
                          ? "bg-violet-600 text-white border-2 border-violet-400 shadow-lg shadow-violet-500/20"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-violet-500/50"
                      }`}
                    >
                      📈 Swing
                    </button>
                    <div className="hidden group-hover:block absolute bottom-full left-0 mb-2 z-50 w-56 p-3 bg-slate-900 border border-slate-700 rounded-lg shadow-xl text-xs">
                      <div className="font-semibold text-violet-400 mb-1">Swing Trade</div>
                      <div className="text-slate-300">
                        <p>• Hold: 2-10 days</p>
                        <p>• Stop: 2-4%</p>
                        <p>• Target: 5-10%</p>
                        <p className="mt-1 text-slate-400">Capture multi-day price swings. Most popular style for part-time traders.</p>
                      </div>
                    </div>
                  </div>

                  {/* Position Trade */}
                  <div className="relative group">
                    <button
                      onClick={() => setSelectedTradeType("position")}
                      className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                        selectedTradeType === "position"
                          ? "bg-emerald-600 text-white border-2 border-emerald-400 shadow-lg shadow-emerald-500/20"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-emerald-500/50"
                      }`}
                    >
                      🏔️ Position
                    </button>
                    <div className="hidden group-hover:block absolute bottom-full left-0 mb-2 z-50 w-56 p-3 bg-slate-900 border border-slate-700 rounded-lg shadow-xl text-xs">
                      <div className="font-semibold text-emerald-400 mb-1">Position Trade</div>
                      <div className="text-slate-300">
                        <p>• Hold: Weeks to months</p>
                        <p>• Stop: 5-10%</p>
                        <p>• Target: 15-30%</p>
                        <p className="mt-1 text-slate-400">Follow major trends. Requires patience and wider stops.</p>
                      </div>
                    </div>
                  </div>

                  {/* Short Selling */}
                  <div className="relative group">
                    <button
                      onClick={() => setSelectedTradeType("short")}
                      className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                        selectedTradeType === "short"
                          ? "bg-red-600 text-white border-2 border-red-400 shadow-lg shadow-red-500/20"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-red-500/50"
                      }`}
                    >
                      📉 Short
                    </button>
                    <div className="hidden group-hover:block absolute bottom-full left-0 mb-2 z-50 w-56 p-3 bg-slate-900 border border-slate-700 rounded-lg shadow-xl text-xs">
                      <div className="font-semibold text-red-400 mb-1">Short Selling</div>
                      <div className="text-slate-300">
                        <p>• Profit when price drops</p>
                        <p>• Stop: 3-5% ABOVE entry</p>
                        <p>• Target: 5-15% below</p>
                        <p className="mt-1 text-slate-400">Bet against the stock. Higher risk - unlimited loss potential.</p>
                      </div>
                    </div>
                  </div>

                  {/* Options */}
                  <div className="relative group">
                    <button
                      onClick={() => setSelectedTradeType("options")}
                      className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                        selectedTradeType === "options"
                          ? "bg-amber-600 text-white border-2 border-amber-400 shadow-lg shadow-amber-500/20"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-amber-500/50"
                      }`}
                    >
                      🎯 Options
                    </button>
                    <div className="hidden group-hover:block absolute bottom-full left-0 mb-2 z-50 w-56 p-3 bg-slate-900 border border-slate-700 rounded-lg shadow-xl text-xs">
                      <div className="font-semibold text-amber-400 mb-1">Options Play</div>
                      <div className="text-slate-300">
                        <p>• Calls (bullish) or Puts (bearish)</p>
                        <p>• Leverage: 10-100x moves</p>
                        <p>• Risk: Premium paid</p>
                        <p className="mt-1 text-slate-400">Leveraged bets with defined risk. Time decay works against you.</p>
                      </div>
                    </div>
                  </div>
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  Selected: <span className="text-violet-400 font-medium">
                    {selectedTradeType === 'scalp' && '⚡ Scalp Trade (minutes)'}
                    {selectedTradeType === 'day' && '📊 Day Trade (same day)'}
                    {selectedTradeType === 'swing' && '📈 Swing Trade (2-10 days)'}
                    {selectedTradeType === 'position' && '🏔️ Position Trade (weeks+)'}
                    {selectedTradeType === 'short' && '📉 Short Selling (bearish)'}
                    {selectedTradeType === 'options' && '🎯 Options Play (leveraged)'}
                  </span>
                </p>
              </div>

              <input
                type="file"
                ref={fileInputRef}
                onChange={handleImageUpload}
                accept="image/*"
                className="hidden"
              />

              {!image && (
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full border-2 border-dashed border-slate-700 rounded-xl p-6 md:p-12 hover:border-violet-500/50 hover:bg-slate-800/30 transition-all group"
                >
                  <Upload className="w-12 md:w-16 h-12 md:h-16 text-slate-600 group-hover:text-violet-400 mx-auto mb-3 md:mb-4 transition-colors" />
                  <p className="text-base md:text-lg font-semibold text-slate-300 group-hover:text-violet-300 transition-colors">
                    Upload Trading Chart
                  </p>
                  <p className="text-xs md:text-sm text-slate-500 mt-1 md:mt-2">
                    Supports all chart images • Consistent analysis guaranteed
                  </p>
                </button>
              )}

              {image && (
                <div className="space-y-3 md:space-y-4">
                  <div className="relative rounded-xl overflow-hidden border border-slate-700/50">
                    <img src={image} alt="Chart" className="w-full" />
                    <button
                      onClick={() => {
                        setImage(null);
                        setImageData(null);
                        setImageHash(null);
                        setAnalysis(null);
                        setAnalysisError(null);
                        clearChartQA();
                        if (fileInputRef.current) fileInputRef.current.value = "";
                      }}
                      className="absolute top-3 right-3 p-2 bg-red-500/90 hover:bg-red-600 rounded-lg transition-colors"
                    >
                      <X className="w-5 h-5" />
                    </button>
                  </div>

                  {!loadingAnalysis && !analysis && !analysisError && (
                    <button
                      onClick={analyzeChart}
                      className="w-full py-4 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-xl font-semibold text-lg shadow-lg shadow-violet-600/30 transition-all flex items-center justify-center gap-3"
                    >
                      <Zap className="w-6 h-6" />
                      <span>Analyze Chart (Consistent Mode)</span>
                    </button>
                  )}

                  {loadingAnalysis && (
                    <div className="bg-violet-500/10 border border-violet-500/20 rounded-xl p-6">
                      <div className="flex items-center gap-3 mb-4">
                        <Loader2 className="w-6 h-6 animate-spin text-violet-400" />
                        <div className="flex-1">
                          <div className="flex justify-between mb-2">
                            <span className="font-semibold text-violet-300">{analysisStage}</span>
                            <span className="text-sm text-slate-400">{analysisProgress}%</span>
                          </div>
                          <div className="w-full bg-slate-800 rounded-full h-2 overflow-hidden">
                            <div
                              className="h-full bg-gradient-to-r from-violet-500 to-purple-500 transition-all duration-500"
                              style={{ width: `${analysisProgress}%` }}
                            />
                          </div>
                        </div>
                      </div>
                      <p className="text-sm text-slate-400">
                        Performing deterministic 5-pass analysis for maximum consistency...
                      </p>
                    </div>
                  )}

                  {analysisError && (
                    <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-5">
                      <div className="flex items-start gap-3">
                        <AlertTriangle className="w-6 h-6 text-red-400 mt-0.5 flex-shrink-0" />
                        <div className="flex-1">
                          <h4 className="font-semibold text-red-400 mb-2">Analysis Error</h4>
                          <p className="text-sm text-slate-300 whitespace-pre-line">{analysisError}</p>
                        </div>
                      </div>
                      <button
                        onClick={analyzeChart}
                        className="mt-4 px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-semibold transition-colors flex items-center gap-2"
                      >
                        <RefreshCw className="w-4 h-4" />
                        <span>Retry Analysis</span>
                      </button>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Analysis Results */}
            {loadingAnalysis && !analysis ? (
              <div className="space-y-4 md:space-y-6">
                <SkeletonChart />
                <SkeletonCard lines={4} className="h-48" />
                <SkeletonCard lines={3} />
              </div>
            ) : analysis && (
              <div className="space-y-4 md:space-y-6">
                {/* Reconciliation Warning - if AI and calculated conflict */}
                {analysis.final?.reconciled && (
                  <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4">
                    <div className="flex items-start gap-3">
                      <AlertTriangle className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" />
                      <div>
                        <div className="font-semibold text-amber-300 mb-1">Recommendation Adjusted</div>
                        <p className="text-sm text-amber-200">{analysis.final.reconciliationNote}</p>
                      </div>
                    </div>
                  </div>
                )}

                {/* Technical Indicators Panel - Always Shows */}
                {(() => {
                  // Get data from realIndicators (live) or fallback to AI analysis
                  const live = analysis.realIndicators;
                  const aiIndicators = analysis.indicators?.indicatorScores;
                  const aiTrend = analysis.patterns?.trendAnalysis;
                  const hasLiveData = !!live;

                  // Merged indicator data with fallbacks
                  const ind = {
                    rsi: live?.rsi || null,
                    macdHistogram: live?.macdHistogram || null,
                    trend: live?.trend || aiTrend?.trend || 'N/A',
                    bullishScore: live?.bullishScore ?? aiIndicators?.bullishScore ?? '—',
                    bearishScore: live?.bearishScore ?? aiIndicators?.bearishScore ?? '—',
                    netScore: live?.netScore ?? aiIndicators?.netScore ?? 0,
                    calculatedRecommendation: live?.calculatedRecommendation ||
                      (aiIndicators?.interpretation?.replace('STRONG_', 'STRONG ').replace('_', ' ')) || null,
                    direction: live?.direction || (aiIndicators?.netScore > 0 ? 'LONG' : aiIndicators?.netScore < 0 ? 'SHORT' : 'NEUTRAL'),
                    aboveSMA20: live?.aboveSMA20,
                    aboveSMA50: live?.aboveSMA50,
                    currentPrice: live?.currentPrice || analysis.context?.priceRange?.current?.replace('$', ''),
                    changePercent: live?.changePercent,
                    barsAnalyzed: live?.barsAnalyzed,
                    ticker: live?.ticker || analysis.context?.ticker,
                    dataSource: hasLiveData ? live.dataSource : 'AI Analysis'
                  };

                  const rsiValue = parseFloat(ind.rsi) || 0;
                  const macdValue = parseFloat(ind.macdHistogram) || 0;

                  return (
                    <div className={`${hasLiveData ? 'bg-blue-500/10 border-blue-500/20' : 'bg-violet-500/10 border-violet-500/20'} border rounded-xl p-5`}>
                      <h4 className={`font-semibold mb-3 ${hasLiveData ? 'text-blue-300' : 'text-violet-300'} flex items-center gap-2`}>
                        <BarChart3 className="w-5 h-5" />
                        Technical Indicator Analysis {ind.ticker ? `(${ind.ticker})` : ''}
                        <span className={`ml-2 text-xs ${hasLiveData ? 'bg-blue-500/20 text-blue-300' : 'bg-violet-500/20 text-violet-300'} px-2 py-0.5 rounded`}>
                          {ind.dataSource}
                        </span>
                        {!hasLiveData && (
                          <span className="ml-auto text-xs text-amber-400 flex items-center gap-1">
                            <AlertCircle className="w-3 h-3" />
                            Live data unavailable
                          </span>
                        )}
                      </h4>
                      <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">RSI (14)</div>
                          <div className={`font-bold text-xl ${
                            ind.rsi ? (rsiValue > 70 ? 'text-red-400' : rsiValue < 30 ? 'text-emerald-400' : 'text-violet-400') : 'text-slate-500'
                          }`}>
                            {ind.rsi || '—'}
                          </div>
                          <div className="text-xs text-slate-500">
                            {ind.rsi ? (rsiValue > 70 ? 'Overbought' : rsiValue < 30 ? 'Oversold' : 'Neutral') : 'No data'}
                          </div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">MACD</div>
                          <div className={`font-bold text-xl ${
                            ind.macdHistogram ? (macdValue > 0 ? 'text-emerald-400' : 'text-red-400') : 'text-slate-500'
                          }`}>
                            {ind.macdHistogram ? `${macdValue > 0 ? '▲' : '▼'} ${ind.macdHistogram}` : '—'}
                          </div>
                          <div className="text-xs text-slate-500">
                            {ind.macdHistogram ? (macdValue > 0 ? 'Bullish' : 'Bearish') : 'No data'}
                          </div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Trend</div>
                          <div className={`font-bold text-lg ${
                            ind.trend === 'UPTREND' ? 'text-emerald-400' :
                            ind.trend === 'DOWNTREND' ? 'text-red-400' :
                            ind.trend === 'SIDEWAYS' ? 'text-yellow-400' : 'text-slate-500'
                          }`}>
                            {ind.trend}
                          </div>
                          {aiTrend?.trendStrength && (
                            <div className="text-xs text-slate-500">{aiTrend.trendStrength}</div>
                          )}
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Score</div>
                          <div className="font-bold text-lg">
                            <span className="text-emerald-400">{ind.bullishScore}</span>
                            <span className="text-slate-500 mx-1">/</span>
                            <span className="text-red-400">{ind.bearishScore}</span>
                          </div>
                          <div className="text-xs text-slate-500">Bull / Bear</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3 relative group">
                          <div className="text-xs text-slate-500 mb-1 flex items-center gap-1">
                            Technical Signal
                            <HelpCircle className="w-3 h-3 text-slate-600 cursor-help" />
                          </div>
                          <div className={`font-bold text-lg ${
                            ind.calculatedRecommendation?.includes('BUY') ? 'text-emerald-400' :
                            ind.calculatedRecommendation?.includes('SELL') ? 'text-red-400' :
                            ind.calculatedRecommendation?.includes('BULLISH') ? 'text-emerald-400' :
                            ind.calculatedRecommendation?.includes('BEARISH') ? 'text-red-400' :
                            'text-yellow-400'
                          }`}>
                            {ind.calculatedRecommendation?.replace(/_/g, ' ') || '—'}
                          </div>
                          <div className="text-xs text-slate-500">{ind.direction}</div>
                          {/* Tooltip explaining technical signal */}
                          <div className="hidden group-hover:block absolute bottom-full left-0 mb-2 z-50 w-64 p-3 bg-slate-900 border border-slate-600 rounded-lg shadow-xl text-xs">
                            <div className="font-semibold text-slate-200 mb-1">Raw Indicator Reading</div>
                            <p className="text-slate-400">This shows what the technical indicators suggest. The final recommendation may differ based on trend, risk/reward, and setup quality.</p>
                          </div>
                        </div>
                      </div>
                      <div className="flex flex-wrap gap-2 text-xs">
                        {ind.aboveSMA20 !== undefined && (
                          <span className={`px-2 py-1 rounded ${ind.aboveSMA20 ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}`}>
                            {ind.aboveSMA20 ? '✓' : '✗'} Above SMA20
                          </span>
                        )}
                        {ind.aboveSMA50 !== undefined && ind.aboveSMA50 !== null && (
                          <span className={`px-2 py-1 rounded ${ind.aboveSMA50 ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}`}>
                            {ind.aboveSMA50 ? '✓' : '✗'} Above SMA50
                          </span>
                        )}
                        {ind.currentPrice && (
                          <span className="px-2 py-1 rounded bg-slate-700 text-slate-300">
                            Price: ${ind.currentPrice}{ind.changePercent ? ` (${parseFloat(ind.changePercent) > 0 ? '+' : ''}${ind.changePercent}%)` : ''}
                          </span>
                        )}
                        {ind.barsAnalyzed && (
                          <span className="px-2 py-1 rounded bg-slate-700 text-slate-300">
                            {ind.barsAnalyzed} bars analyzed
                          </span>
                        )}
                      </div>
                    {/* Signal vs Recommendation discrepancy notice - ALWAYS show when there's a difference */}
                    {(() => {
                      const techSignal = ind.calculatedRecommendation?.replace(/_/g, ' ');
                      const finalRec = analysis.final?.recommendation?.replace(/_/g, ' ');

                      // Normalize for comparison (remove STRONG_, MODERATE_, LEAN_ prefixes)
                      const normalizeRec = (rec) => {
                        if (!rec) return '';
                        return rec.replace(/STRONG |MODERATE |LEAN /gi, '').trim();
                      };

                      const techNorm = normalizeRec(techSignal);
                      const finalNorm = normalizeRec(finalRec);

                      // Check if intensity differs (STRONG vs LEAN vs regular)
                      const getIntensity = (rec) => {
                        if (!rec) return 'normal';
                        if (rec.includes('STRONG')) return 'strong';
                        if (rec.includes('LEAN')) return 'lean';
                        if (rec.includes('MODERATE')) return 'moderate';
                        return 'normal';
                      };
                      const techIntensity = getIntensity(techSignal);
                      const finalIntensity = getIntensity(finalRec);
                      const intensityDiffers = techIntensity !== finalIntensity;

                      // Show if there's any meaningful difference (direction OR intensity)
                      const isDifferent = techSignal && finalRec && (
                        (techNorm.includes('BUY') && !finalNorm.includes('BUY')) ||
                        (techNorm.includes('SELL') && !finalNorm.includes('SELL')) ||
                        (finalNorm.includes('WAIT') && !techNorm.includes('WAIT')) ||
                        (finalNorm.includes('HOLD') && !techNorm.includes('HOLD')) ||
                        (techNorm !== finalNorm) ||
                        intensityDiffers
                      );

                      if (!isDifferent) return null;

                      const techColor = techSignal?.includes('BUY') ? 'text-emerald-400' :
                                        techSignal?.includes('SELL') ? 'text-red-400' : 'text-amber-400';
                      const finalColor = finalRec?.includes('BUY') ? 'text-emerald-400' :
                                         finalRec?.includes('SELL') ? 'text-red-400' : 'text-amber-400';

                      // Collect all reasons
                      const reasons = [];
                      if (analysis.patterns?.trendAnalysis?.trend === 'SIDEWAYS') {
                        reasons.push('Trend is SIDEWAYS - no clear direction');
                      }
                      if (analysis.final?.setupQuality === 'D' || analysis.final?.setupQuality === 'C') {
                        reasons.push(`Setup quality is ${analysis.final.setupQuality === 'D' ? 'poor' : 'fair'} (grade ${analysis.final.setupQuality})`);
                      }
                      if (analysis.final?.biasStrength === 'WEAK') {
                        reasons.push('Directional bias is weak');
                      }
                      if (analysis.final?.confidenceScore && analysis.final.confidenceScore < 60) {
                        reasons.push(`Confidence score is below threshold (${analysis.final.confidenceScore}%)`);
                      }
                      if (analysis.tradeSetup?.immediateEntry?.riskRewardRatio) {
                        const rrParts = analysis.tradeSetup.immediateEntry.riskRewardRatio.split(':');
                        const rrVal = parseFloat(rrParts[1]);
                        if (!isNaN(rrVal) && rrVal < 2) {
                          reasons.push(`Risk/reward ratio is suboptimal (${analysis.tradeSetup.immediateEntry.riskRewardRatio})`);
                        }
                      }
                      if (ind.netScore !== undefined && ind.netScore !== 0) {
                        if (Math.abs(ind.netScore) < 15) {
                          reasons.push('Mixed signals - indicator readings are conflicting');
                        }
                      }
                      if (finalRec?.includes('WAIT')) {
                        reasons.push('Better entry conditions recommended');
                      }
                      if (finalRec?.includes('BUY') && techSignal?.includes('SELL')) {
                        reasons.push('Oversold bounce opportunity despite bearish technicals');
                      }
                      if (finalRec?.includes('SELL') && techSignal?.includes('BUY')) {
                        reasons.push('Overbought condition despite bullish technicals');
                      }

                      // Add reason for intensity difference
                      if (intensityDiffers && techNorm === finalNorm) {
                        const intensityDesc = {
                          'strong': 'strong conviction',
                          'lean': 'weak/cautious',
                          'moderate': 'moderate conviction',
                          'normal': 'standard'
                        };
                        reasons.push(`Signal strength adjusted from ${intensityDesc[techIntensity]} to ${intensityDesc[finalIntensity]} based on setup quality`);
                      }

                      // Add default if no specific reasons
                      if (reasons.length === 0) {
                        reasons.push('Technical signals and overall setup quality differ');
                      }

                      return (
                        <div className="mt-3 px-4 py-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                          <div className="flex items-start gap-2">
                            <AlertTriangle className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" />
                            <div className="text-sm">
                              <span className="font-semibold text-amber-400">Why the difference?</span>
                              <p className="text-slate-300 mt-1">
                                Technical indicators show <span className={`font-semibold ${techColor}`}>{techSignal}</span> but
                                the final recommendation is <span className={`font-semibold ${finalColor}`}>{finalRec}</span> because:
                              </p>
                              <ul className="text-slate-400 mt-2 list-disc list-inside space-y-1">
                                {reasons.map((reason, idx) => (
                                  <li key={idx}>{reason}</li>
                                ))}
                              </ul>
                              <p className="text-xs text-slate-500 mt-3 pt-2 border-t border-slate-700/50">
                                💡 <span className="text-slate-400">Technical Signal</span> = raw indicator reading.
                                <span className="text-white"> Final Recommendation</span> = considers trend, risk/reward, and setup quality.
                              </p>
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                  );
                })()}

                {/* Recommendation Card */}
                <div className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl border border-slate-700/50 p-8 shadow-2xl">
                  <div className="flex items-start justify-between mb-6">
                    <div className="flex items-start gap-4">
                      <div className={`p-4 bg-gradient-to-br ${
                        analysis.final.recommendation?.includes("STRONG_BUY") || analysis.final.recommendation?.includes("STRONG BUY")
                          ? "from-emerald-600 to-green-600"
                          : analysis.final.recommendation?.includes("BUY")
                          ? "from-green-600 to-emerald-600"
                          : analysis.final.recommendation?.includes("SELL")
                          ? "from-red-600 to-rose-600"
                          : "from-yellow-600 to-orange-600"
                      } rounded-xl shadow-lg`}>
                        {getRecommendationIcon(analysis.final.recommendation)}
                      </div>
                      <div>
                        <h3 className={`text-3xl font-bold mb-2 ${getRecommendationColor(analysis.final.recommendation)}`}>
                          {analysis.final.recommendation?.replace(/_/g, " ")}
                        </h3>
                        <p className="text-lg text-slate-300">{analysis.final.summary}</p>
                        {/* WAIT explanation - helps users understand why it says WAIT */}
                        {analysis.final.recommendation?.includes("WAIT") && (
                          <div className="mt-3 px-3 py-2 bg-amber-500/10 border border-amber-500/30 rounded-lg text-sm">
                            <span className="font-semibold text-amber-400">⏳ Why WAIT?</span>
                            <span className="text-slate-300 ml-2">
                              {analysis.patterns?.trendAnalysis?.trend === 'SIDEWAYS'
                                ? "The trend is SIDEWAYS/unclear - wait for a directional breakout before entering."
                                : analysis.final.confidenceScore < 50
                                ? "Confidence is too low for a high-probability trade. Wait for better setup."
                                : analysis.tradeSetup?.immediateEntry?.riskRewardRatio?.includes("1:1") || (() => { const rr = parseFloat(analysis.tradeSetup?.immediateEntry?.riskRewardRatio?.split(':')[1]); return !isNaN(rr) && rr < 2; })()
                                ? "Risk/reward ratio is unfavorable. Wait for better entry or clearer levels."
                                : "Mixed signals detected. Technical indicators conflict with price action or trend."}
                            </span>
                          </div>
                        )}
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="text-sm text-slate-500 mb-1 flex items-center gap-1 justify-end group relative">
                        Confidence
                        <HelpCircle className="w-3.5 h-3.5 text-slate-500 hover:text-violet-400 cursor-help" />
                        <div className="absolute right-0 top-6 w-72 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-xl z-50 text-left opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                          <div className="text-xs text-slate-200 font-semibold mb-2">Confidence Score Breakdown:</div>
                          <ul className="text-xs text-slate-300 space-y-1">
                            <li className="flex items-start gap-1">
                              <span className="text-violet-400 mt-0.5">•</span>
                              <span><strong>Base Score (40%):</strong> Starting baseline for any analysis</span>
                            </li>
                            <li className="flex items-start gap-1">
                              <span className="text-emerald-400 mt-0.5">•</span>
                              <span><strong>Trend Alignment (+15%):</strong> Price above/below key MAs</span>
                            </li>
                            <li className="flex items-start gap-1">
                              <span className="text-blue-400 mt-0.5">•</span>
                              <span><strong>Indicator Signals (+20%):</strong> RSI, MACD, volume confirmation</span>
                            </li>
                            <li className="flex items-start gap-1">
                              <span className="text-amber-400 mt-0.5">•</span>
                              <span><strong>Pattern Recognition (+15%):</strong> Chart patterns detected</span>
                            </li>
                            <li className="flex items-start gap-1">
                              <span className="text-cyan-400 mt-0.5">•</span>
                              <span><strong>Support/Resistance (+10%):</strong> Near key S/R levels</span>
                            </li>
                          </ul>
                          <div className="text-xs text-slate-400 mt-2 pt-2 border-t border-slate-700">
                            Max: 95% • High confidence = 70%+ • Medium = 50-69%
                          </div>
                        </div>
                      </div>
                      <div className="text-4xl font-bold text-violet-400">
                        {analysis.final.calculatedConfidence || analysis.final.confidenceScore}%
                      </div>
                      <div className="text-xs text-slate-500 mt-1">Setup Quality: {analysis.final.setupQuality || '—'}</div>
                      {analysis.final.directionalBias && (
                        <div
                          className="relative inline-block"
                          onMouseEnter={() => setActiveTooltip('bias')}
                          onMouseLeave={() => setActiveTooltip(null)}
                        >
                          <div
                            className={`text-xs mt-1 px-2 py-0.5 rounded inline-block cursor-help ${
                              analysis.final.directionalBias === 'LONG'
                                ? 'text-emerald-400 bg-emerald-500/20'
                                : 'text-red-400 bg-red-500/20'
                            }`}
                          >
                            Bias: {analysis.final.directionalBias} ({analysis.final.biasStrength || 'MODERATE'}) ⓘ
                          </div>
                          {/* State-based Tooltip */}
                          {activeTooltip === 'bias' && (
                            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-56 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                              <div className={`font-semibold mb-1 ${analysis.final.directionalBias === 'LONG' ? 'text-emerald-400' : 'text-red-400'}`}>
                                {analysis.final.directionalBias === 'LONG' ? '📈 LONG Position' : '📉 SHORT Position'}
                              </div>
                              <p>{analysis.final.directionalBias === 'LONG'
                                ? "Buy position. You profit when the price goes UP."
                                : "Sell position. You profit when the price goes DOWN."}</p>
                            </div>
                          )}
                        </div>
                      )}
                      {analysis.final.dataValidated && (
                        <div className="text-xs text-emerald-400 mt-1 flex items-center gap-1 justify-end">
                          <Check className="w-3 h-3" /> Data Validated
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div className="bg-slate-800/50 rounded-xl p-4">
                      <div className="text-xs text-slate-500 mb-1">Asset</div>
                      <div className="font-bold text-lg">{analysis.context.ticker}</div>
                      <div className="text-xs text-slate-400" title={getCompanyName(analysis.context.ticker) || analysis.context.assetType}>
                        {getCompanyName(analysis.context.ticker) ? (
                          <span className="truncate block max-w-[120px]">{getCompanyName(analysis.context.ticker)}</span>
                        ) : analysis.context.assetType}
                      </div>
                    </div>
                    <div className="bg-slate-800/50 rounded-xl p-4">
                      <div className="text-xs text-slate-500 mb-1">Timeframe</div>
                      <div className="font-bold text-lg">{analysis.context.timeframe}</div>
                      <div className="text-xs text-slate-400">{analysis.tradeSetup.timeHorizon || '—'}</div>
                    </div>
                    <div className="bg-slate-800/50 rounded-xl p-4">
                      <div className="text-xs text-slate-500 mb-1">
                        Trade Type
                        {analysis.autoDetectedStyle && (
                          <span className="text-violet-400 ml-1">🎯 Auto</span>
                        )}
                      </div>
                      <div className={`font-bold text-lg ${
                        analysis.tradeSetup.tradeType?.includes('Short') ? 'text-red-400' :
                        analysis.tradeSetup.tradeType?.includes('Scalp') ? 'text-cyan-400' :
                        analysis.tradeSetup.tradeType?.includes('Day') ? 'text-blue-400' :
                        analysis.tradeSetup.tradeType?.includes('Position') ? 'text-emerald-400' :
                        analysis.tradeSetup.tradeType?.includes('Options') ? 'text-amber-400' :
                        'text-violet-400'
                      }`}>
                        {analysis.autoDetectedStyle?.icon || ''} {analysis.tradeSetup.tradeType || 'Swing Trade'}
                      </div>
                      <div className="text-xs text-slate-400">
                        {analysis.tradeSetup.tradeDirection || 'NEUTRAL'}
                      </div>
                    </div>
                    <div className="bg-slate-800/50 rounded-xl p-4">
                      <div className="text-xs text-slate-500 mb-1">Current Price</div>
                      <div className="font-bold text-lg">{analysis.context.priceRange.current}</div>
                      <div className="text-xs text-slate-400">Last Close</div>
                    </div>
                    <div className="bg-slate-800/50 rounded-xl p-4">
                      <div className="text-xs text-slate-500 mb-1">Risk:Reward</div>
                      <div className="font-bold text-lg text-violet-400">
                        {analysis.tradeSetup.immediateEntry?.riskRewardRatio || '—'}
                      </div>
                      <div className="text-xs text-slate-400">
                        {analysis.tradeSetup.immediateEntry?.winProbability ? `${analysis.tradeSetup.immediateEntry.winProbability}% Win Rate` : '—'}
                      </div>
                    </div>
                  </div>

                  {/* KEY TAKEAWAYS - Quick Summary Box */}
                  <div className="bg-gradient-to-r from-violet-500/10 to-purple-500/10 border border-violet-500/30 rounded-xl p-5 mb-6">
                    <h4 className="font-semibold mb-3 text-violet-300 flex items-center gap-2">
                      <Sparkles className="w-5 h-5" />
                      Key Takeaways
                    </h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <div className="flex items-start gap-2">
                          <span className={`text-lg ${
                            analysis.final?.recommendation?.includes('BUY') ? '✅' :
                            analysis.final?.recommendation?.includes('SELL') ? '🔻' : '⏸️'
                          }`}></span>
                          <div>
                            <span className="text-sm font-semibold text-slate-200">Action:</span>
                            <span className={`ml-2 text-sm ${
                              analysis.final?.recommendation?.includes('BUY') ? 'text-emerald-400' :
                              analysis.final?.recommendation?.includes('SELL') ? 'text-red-400' : 'text-amber-400'
                            }`}>
                              {analysis.final?.recommendation?.includes('BUY') ? 'Look for long entry' :
                               analysis.final?.recommendation?.includes('SELL') ? 'Look for short entry or exit longs' :
                               'Wait for better setup'}
                            </span>
                          </div>
                        </div>
                        <div className="flex items-start gap-2">
                          <span className="text-lg">📊</span>
                          <div>
                            <span className="text-sm font-semibold text-slate-200">Trend:</span>
                            <span className={`ml-2 text-sm ${
                              analysis.patterns?.trendAnalysis?.trend === 'UPTREND' ? 'text-emerald-400' :
                              analysis.patterns?.trendAnalysis?.trend === 'DOWNTREND' ? 'text-red-400' : 'text-yellow-400'
                            }`}>
                              {analysis.patterns?.trendAnalysis?.trend || 'Unknown'} - {
                                analysis.patterns?.trendAnalysis?.trend === 'UPTREND' ? 'Favor long positions' :
                                analysis.patterns?.trendAnalysis?.trend === 'DOWNTREND' ? 'Favor short positions' :
                                'No clear direction, be cautious'
                              }
                            </span>
                          </div>
                        </div>
                        <div className="flex items-start gap-2">
                          <span className="text-lg">🎯</span>
                          <div>
                            <span className="text-sm font-semibold text-slate-200">Key Levels:</span>
                            <span className="ml-2 text-sm text-slate-300">
                              Entry: {analysis.tradeSetup?.immediateEntry?.entry || 'N/A'} |
                              Stop: {analysis.tradeSetup?.immediateEntry?.stopLoss || 'N/A'} |
                              Target: {analysis.tradeSetup?.immediateEntry?.target1 || 'N/A'}
                            </span>
                          </div>
                        </div>
                      </div>
                      <div className="space-y-2">
                        <div className="flex items-start gap-2">
                          <span className="text-lg">⚠️</span>
                          <div>
                            <span className="text-sm font-semibold text-slate-200">Main Risk:</span>
                            <span className="ml-2 text-sm text-slate-300">
                              {analysis.patterns?.trendAnalysis?.trend === 'SIDEWAYS' ? 'Choppy market, false breakouts likely' :
                               analysis.realIndicators?.rsi > 70 ? 'Overbought - potential pullback' :
                               analysis.realIndicators?.rsi < 30 ? 'Oversold - potential bounce but may continue down' :
                               analysis.final?.setupQuality === 'D' ? 'Poor setup quality - high failure rate' :
                               'Monitor for trend change'}
                            </span>
                          </div>
                        </div>
                        <div className="flex items-start gap-2">
                          <span className="text-lg">💡</span>
                          <div>
                            <span className="text-sm font-semibold text-slate-200">Best Action:</span>
                            <span className="ml-2 text-sm text-slate-300">
                              {analysis.final?.recommendation?.includes('STRONG_BUY') || analysis.final?.recommendation?.includes('STRONG BUY')
                                ? 'Enter with full position size'
                                : analysis.final?.recommendation?.includes('BUY')
                                ? 'Enter with reduced size, scale in on confirmation'
                                : analysis.final?.recommendation?.includes('WAIT')
                                ? 'Set alerts at key levels, wait for clarity'
                                : 'Consider taking profits or hedging'}
                            </span>
                          </div>
                        </div>
                        <div className="flex items-start gap-2">
                          <span className="text-lg">⏱️</span>
                          <div>
                            <span className="text-sm font-semibold text-slate-200">Time Horizon:</span>
                            <span className="ml-2 text-sm text-slate-300">
                              {analysis.tradeSetup?.timeHorizon || analysis.autoDetectedStyle?.name || 'Swing Trade'}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Risk/Reward Visual Bar */}
                  {analysis?.tradeSetup?.immediateEntry?.entry && analysis?.tradeSetup?.immediateEntry?.stopLoss && analysis?.tradeSetup?.immediateEntry?.target1 && (
                    <div className="mt-4 p-4 bg-slate-800/30 rounded-xl border border-slate-700/20">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs font-bold text-slate-300">Risk / Reward Visualizer</span>
                        {(() => {
                          const entry = parseFloat(analysis.tradeSetup.immediateEntry.entry);
                          const stop = parseFloat(analysis.tradeSetup.immediateEntry.stopLoss);
                          const target = parseFloat(analysis.tradeSetup.immediateEntry.target1);
                          const risk = Math.abs(entry - stop);
                          const reward = Math.abs(target - entry);
                          const ratio = risk > 0 ? (reward / risk).toFixed(2) : '∞';
                          return (
                            <span className={`text-xs font-bold px-2 py-0.5 rounded ${
                              parseFloat(ratio) >= 2 ? 'bg-emerald-500/20 text-emerald-400' :
                              parseFloat(ratio) >= 1 ? 'bg-yellow-500/20 text-yellow-400' :
                              'bg-red-500/20 text-red-400'
                            }`}>
                              R/R: 1:{ratio}
                            </span>
                          );
                        })()}
                      </div>

                      {(() => {
                        const entry = parseFloat(analysis.tradeSetup.immediateEntry.entry);
                        const stop = parseFloat(analysis.tradeSetup.immediateEntry.stopLoss);
                        const target1 = parseFloat(analysis.tradeSetup.immediateEntry.target1);
                        const target2 = analysis.tradeSetup.immediateEntry.target2 ? parseFloat(analysis.tradeSetup.immediateEntry.target2) : null;
                        const isLong = entry > stop;

                        const low = Math.min(stop, entry, target1, target2 || Infinity);
                        const high = Math.max(stop, entry, target1, target2 || -Infinity);
                        const range = high - low || 1;

                        const entryPct = ((entry - low) / range) * 100;
                        const stopPct = ((stop - low) / range) * 100;
                        const t1Pct = ((target1 - low) / range) * 100;
                        const t2Pct = target2 ? ((target2 - low) / range) * 100 : null;

                        return (
                          <div className="relative h-8 bg-slate-900 rounded-lg overflow-hidden">
                            {/* Risk zone (red) */}
                            <div className="absolute top-0 bottom-0 bg-red-500/20 border-r border-red-500/50" style={{
                              left: `${Math.min(stopPct, entryPct)}%`,
                              width: `${Math.abs(entryPct - stopPct)}%`
                            }} />
                            {/* Reward zone (green) */}
                            <div className="absolute top-0 bottom-0 bg-emerald-500/20 border-l border-emerald-500/50" style={{
                              left: `${Math.min(entryPct, t1Pct)}%`,
                              width: `${Math.abs(t1Pct - entryPct)}%`
                            }} />
                            {target2 && (
                              <div className="absolute top-0 bottom-0 bg-emerald-500/10" style={{
                                left: `${Math.min(t1Pct, t2Pct)}%`,
                                width: `${Math.abs(t2Pct - t1Pct)}%`
                              }} />
                            )}

                            {/* Stop marker */}
                            <div className="absolute top-0 bottom-0 w-0.5 bg-red-500" style={{ left: `${stopPct}%` }}>
                              <span className="absolute -top-5 left-1/2 -translate-x-1/2 text-[8px] text-red-400 font-bold whitespace-nowrap">Stop ${stop.toFixed(2)}</span>
                            </div>
                            {/* Entry marker */}
                            <div className="absolute top-0 bottom-0 w-1 bg-white" style={{ left: `${entryPct}%` }}>
                              <span className="absolute -top-5 left-1/2 -translate-x-1/2 text-[8px] text-white font-bold whitespace-nowrap">Entry ${entry.toFixed(2)}</span>
                            </div>
                            {/* Target 1 marker */}
                            <div className="absolute top-0 bottom-0 w-0.5 bg-emerald-500" style={{ left: `${t1Pct}%` }}>
                              <span className="absolute -top-5 left-1/2 -translate-x-1/2 text-[8px] text-emerald-400 font-bold whitespace-nowrap">T1 ${target1.toFixed(2)}</span>
                            </div>
                            {/* Target 2 marker */}
                            {target2 && t2Pct && (
                              <div className="absolute top-0 bottom-0 w-0.5 bg-emerald-400" style={{ left: `${t2Pct}%` }}>
                                <span className="absolute -top-5 left-1/2 -translate-x-1/2 text-[8px] text-emerald-300 font-bold whitespace-nowrap">T2 ${target2.toFixed(2)}</span>
                              </div>
                            )}
                          </div>
                        );
                      })()}

                      <div className="flex items-center justify-between mt-3 text-[10px] text-slate-500">
                        <span className="text-red-400">← Risk Zone</span>
                        <span className="text-emerald-400">Reward Zone →</span>
                      </div>
                    </div>
                  )}

                  {/* PRE-TRADE CHECKLIST */}
                  {(analysis.final?.recommendation?.includes('BUY') || analysis.final?.recommendation?.includes('SELL')) && (
                    <div className="bg-slate-800/30 border border-slate-700/50 rounded-xl p-5 mb-6">
                      <h4 className="font-semibold mb-3 text-slate-300 flex items-center gap-2">
                        <Check className="w-5 h-5 text-emerald-400" />
                        Pre-Trade Checklist
                        <span className="text-xs text-slate-500 font-normal ml-2">Verify before entering</span>
                      </h4>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div className={`flex items-center gap-2 p-2 rounded ${
                          analysis.patterns?.trendAnalysis?.trend !== 'SIDEWAYS' ? 'bg-emerald-500/10' : 'bg-red-500/10'
                        }`}>
                          <span className={analysis.patterns?.trendAnalysis?.trend !== 'SIDEWAYS' ? 'text-emerald-400' : 'text-red-400'}>
                            {analysis.patterns?.trendAnalysis?.trend !== 'SIDEWAYS' ? '✓' : '✗'}
                          </span>
                          <span className="text-slate-300">Clear trend direction</span>
                        </div>
                        <div className={`flex items-center gap-2 p-2 rounded ${
                          analysis.final?.confidenceScore >= 60 ? 'bg-emerald-500/10' : 'bg-amber-500/10'
                        }`}>
                          <span className={analysis.final?.confidenceScore >= 60 ? 'text-emerald-400' : 'text-amber-400'}>
                            {analysis.final?.confidenceScore >= 60 ? '✓' : '⚠'}
                          </span>
                          <span className="text-slate-300">Confidence above 60%</span>
                        </div>
                        <div className={`flex items-center gap-2 p-2 rounded ${
                          (() => { const rr = parseFloat(analysis.tradeSetup?.immediateEntry?.riskRewardRatio?.split(':')[1]); return !isNaN(rr) && rr >= 2; })() ? 'bg-emerald-500/10' : 'bg-amber-500/10'
                        }`}>
                          <span className={(() => { const rr = parseFloat(analysis.tradeSetup?.immediateEntry?.riskRewardRatio?.split(':')[1]); return !isNaN(rr) && rr >= 2; })() ? 'text-emerald-400' : 'text-amber-400'}>
                            {(() => { const rr = parseFloat(analysis.tradeSetup?.immediateEntry?.riskRewardRatio?.split(':')[1]); return !isNaN(rr) && rr >= 2; })() ? '✓' : '⚠'}
                          </span>
                          <span className="text-slate-300">Risk:Reward at least 1:2</span>
                        </div>
                        <div className={`flex items-center gap-2 p-2 rounded ${
                          analysis.final?.setupQuality !== 'D' ? 'bg-emerald-500/10' : 'bg-red-500/10'
                        }`}>
                          <span className={analysis.final?.setupQuality !== 'D' ? 'text-emerald-400' : 'text-red-400'}>
                            {analysis.final?.setupQuality !== 'D' ? '✓' : '✗'}
                          </span>
                          <span className="text-slate-300">Setup quality acceptable</span>
                        </div>
                        <div className="flex items-center gap-2 p-2 rounded bg-slate-700/30">
                          <span className="text-slate-400">☐</span>
                          <span className="text-slate-300">Position size calculated (1-2% max risk)</span>
                        </div>
                        <div className="flex items-center gap-2 p-2 rounded bg-slate-700/30">
                          <span className="text-slate-400">☐</span>
                          <span className="text-slate-300">Stop loss order ready to place</span>
                        </div>
                      </div>
                      <p className="text-xs text-slate-500 mt-3">
                        💡 Tip: Only trade when most boxes are checked. Missing criteria = higher risk of failure.
                      </p>
                    </div>
                  )}

                  {/* Stock Catalysts & News - LIVE DATA */}
                  {analysis.stockCatalysts && (analysis.stockCatalysts.recentNews?.length > 0 || analysis.stockCatalysts.catalysts?.length > 0 || analysis.stockCatalysts.upcomingEvents?.length > 0) && (
                    <div className="bg-blue-500/10 border border-blue-500/20 rounded-xl p-5 mb-6">
                      <h4 className="font-semibold mb-3 text-blue-300 flex items-center gap-2">
                        <Newspaper className="w-5 h-5" />
                        News & Catalysts for {analysis.context.ticker}
                        <span className="ml-auto text-xs px-2 py-0.5 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center gap-1">
                          <span className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                          LIVE DATA
                        </span>
                      </h4>
                      {/* Recent News Headlines */}
                      {analysis.stockCatalysts.recentNews?.length > 0 && (
                        <div className="mb-4">
                          <div className="text-xs text-slate-500 mb-2">📰 Latest News Headlines</div>
                          <ul className="space-y-2">
                            {analysis.stockCatalysts.recentNews.slice(0, 4).map((news, i) => (
                              <li key={i} className="text-sm text-slate-300 flex items-start gap-2 bg-slate-800/30 rounded-lg p-2">
                                <span className={`mt-0.5 ${
                                  news.sentiment === 'bullish' ? 'text-emerald-400' :
                                  news.sentiment === 'bearish' ? 'text-red-400' :
                                  'text-slate-400'
                                }`}>
                                  {news.sentiment === 'bullish' ? '📈' : news.sentiment === 'bearish' ? '📉' : '📊'}
                                </span>
                                <div className="flex-1">
                                  <div className="line-clamp-2">{news.headline}</div>
                                  <div className="text-xs text-slate-500 mt-1 flex items-center gap-2">
                                    <span>{news.source}</span>
                                    <span>•</span>
                                    <span>{new Date(news.timestamp).toLocaleString()}</span>
                                  </div>
                                </div>
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {analysis.stockCatalysts.upcomingEvents?.length > 0 && (
                          <div>
                            <div className="text-xs text-slate-500 mb-2">📅 Upcoming Events</div>
                            <ul className="space-y-1">
                              {analysis.stockCatalysts.upcomingEvents.slice(0, 3).map((event, i) => (
                                <li key={i} className="text-sm text-slate-300 flex items-start gap-1">
                                  <span className="text-blue-400">•</span> {event}
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                        {analysis.stockCatalysts.catalysts?.length > 0 && (
                          <div>
                            <div className="text-xs text-slate-500 mb-2">🚀 Key Catalysts</div>
                            <ul className="space-y-1">
                              {analysis.stockCatalysts.catalysts.slice(0, 3).map((cat, i) => (
                                <li key={i} className="text-sm text-slate-300 flex items-start gap-1">
                                  <span className="text-emerald-400">•</span> {cat}
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                        {analysis.stockCatalysts.risks?.length > 0 && (
                          <div>
                            <div className="text-xs text-slate-500 mb-2">⚠️ Risk Factors</div>
                            <ul className="space-y-1">
                              {analysis.stockCatalysts.risks.slice(0, 3).map((risk, i) => (
                                <li key={i} className="text-sm text-slate-300 flex items-start gap-1">
                                  <span className="text-amber-400">•</span> {risk}
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                        <div>
                          <div className="text-xs text-slate-500 mb-2">📊 Market Context</div>
                          <div className="space-y-1 text-sm">
                            {analysis.stockCatalysts.seasonality && (
                              <div className="flex items-center gap-2">
                                <span className="text-slate-400">Seasonality:</span>
                                <span className={`px-2 py-0.5 rounded text-xs ${
                                  analysis.stockCatalysts.seasonality === 'bullish' ? 'bg-emerald-500/20 text-emerald-400' :
                                  analysis.stockCatalysts.seasonality === 'bearish' ? 'bg-red-500/20 text-red-400' :
                                  'bg-slate-500/20 text-slate-400'
                                }`}>
                                  {analysis.stockCatalysts.seasonality}
                                </span>
                              </div>
                            )}
                            {analysis.stockCatalysts.sectorTrend && (
                              <div className="text-slate-300">
                                <span className="text-slate-400">Sentiment:</span> {analysis.stockCatalysts.sectorTrend}
                              </div>
                            )}
                            {analysis.stockCatalysts.lastUpdated && (
                              <div className="text-xs text-slate-500 mt-2">
                                Updated: {new Date(analysis.stockCatalysts.lastUpdated).toLocaleString()}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Trade Instruction */}
                  {analysis.final.tradeInstruction && (() => {
                    const ti = analysis.final.tradeInstruction;
                    const ts = analysis.tradeSetup || {};
                    const ie = ts.immediateEntry || {};
                    const entryPrice = parseFloat(ti.action?.match(/[\d.]+/)?.[0] || ie.entryPrice || analysis.context?.currentPrice || 0);
                    const stopPrice = parseFloat(String(ti.stop || ie.stopLoss || '').replace(/[^0-9.]/g, '')) || null;
                    const targetPrice = parseFloat(String(ti.target || ie.targetPrice || '').replace(/[^0-9.]/g, '')) || null;
                    const isBuy = ti.action?.toUpperCase().includes('BUY') || analysis.final.directionalBias === 'LONG';
                    const riskPerShare = stopPrice && entryPrice ? Math.abs(entryPrice - stopPrice) : null;
                    const rewardPerShare = targetPrice && entryPrice ? Math.abs(targetPrice - entryPrice) : null;

                    // Determine recommended order types
                    const orderTooltips = {
                      'Market': 'Executes immediately at the current market price. Best for highly liquid stocks when you need instant execution.',
                      'Limit': 'Sets a maximum price (buy) or minimum price (sell). Only fills at your price or better. Use when you want a specific entry price.',
                      'Stop Loss': 'Triggers a market sell when price falls to your stop price. Protects against large losses. Essential risk management tool.',
                      'Stop Limit': 'Like a Stop Loss but converts to a Limit order instead of Market. Gives price control but may not fill in fast-moving markets.',
                      'Trailing Stop Loss ($)': 'Stop price trails the market price by a fixed dollar amount. Locks in profits as price rises while protecting downside.',
                      'Trailing Stop Loss (%)': 'Stop price trails by a percentage. Better for volatile stocks where a fixed dollar amount might be too tight or too loose.',
                      'Trailing Stop Limit ($)': 'Combines trailing stop with limit order. Trails by a dollar amount but converts to a limit order (may not fill in gaps).',
                      'Trailing Stop Limit (%)': 'Combines trailing stop with limit order using a percentage trail. Good for volatile stocks with limit price protection.',
                    };

                    return (
                    <div className="bg-violet-500/10 border border-violet-500/20 rounded-xl p-5 mb-6">
                      <h4 className="font-semibold mb-3 text-violet-300 flex items-center gap-2">
                        <Target className="w-5 h-5" />
                        Trade Setup
                      </h4>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                          <div className="text-xs text-slate-500 mb-1">Action</div>
                          <div className="font-bold text-lg">{ti.action || (isBuy ? `BUY at ${entryPrice.toFixed(2)}` : `SELL at ${entryPrice.toFixed(2)}`)}</div>
                        </div>
                        <div>
                          <div className="text-xs text-slate-500 mb-1">Stop Loss</div>
                          <div className="font-bold text-lg text-red-400">{stopPrice ? `$${stopPrice.toFixed(2)}` : (ti.stop || 'Use support level')}</div>
                        </div>
                        <div>
                          <div className="text-xs text-slate-500 mb-1">Target</div>
                          <div className="font-bold text-lg text-green-400">{targetPrice ? `$${targetPrice.toFixed(2)}` : (ti.target || 'Use resistance level')}</div>
                        </div>
                      </div>
                      <div className="mt-4 pt-4 border-t border-violet-500/20">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                          <div>
                            <div className="text-xs text-slate-500 mb-1">Entry Price</div>
                            <div className="font-semibold">{entryPrice > 0 ? `$${entryPrice.toFixed(2)}` : '--'}</div>
                          </div>
                          <div>
                            <div className="text-xs text-slate-500 mb-1">Risk/Share</div>
                            <div className="font-semibold text-red-400">{riskPerShare ? `$${riskPerShare.toFixed(2)}` : '--'}</div>
                          </div>
                          <div>
                            <div className="text-xs text-slate-500 mb-1">Reward/Share</div>
                            <div className="font-semibold text-emerald-400">{rewardPerShare ? `$${rewardPerShare.toFixed(2)}` : '--'}</div>
                          </div>
                          <div>
                            <div className="text-xs text-slate-500 mb-1">Invalidation</div>
                            <div className="font-semibold text-amber-400">{analysis.final.invalidationPrice || (stopPrice ? `close below $${stopPrice.toFixed(2)}` : '--')}</div>
                          </div>
                        </div>
                      </div>

                      {/* Entry Conditions */}
                      {(analysis.recommendations?.scenarioAnalysis?.bullishScenario?.requiredConditions?.length > 0 ||
                        analysis.recommendations?.scenarioAnalysis?.bearishScenario?.requiredConditions?.length > 0 ||
                        setup.pullbackEntry?.triggerCondition) && (
                        <div className="mt-4 pt-4 border-t border-violet-500/20">
                          <div className="text-xs text-slate-500 mb-2 font-semibold uppercase tracking-wider">Entry Conditions</div>
                          <div className="space-y-1.5">
                            {setup.pullbackEntry?.triggerCondition && (
                              <div className="flex items-start gap-2 text-xs">
                                <span className="text-violet-400 mt-0.5">▸</span>
                                <span className="text-slate-300">{setup.pullbackEntry.triggerCondition}</span>
                              </div>
                            )}
                            {(isBuy ? analysis.recommendations?.scenarioAnalysis?.bullishScenario?.requiredConditions : analysis.recommendations?.scenarioAnalysis?.bearishScenario?.requiredConditions)?.slice(0, 4).map((cond, i) => (
                              <div key={i} className="flex items-start gap-2 text-xs">
                                <span className="text-violet-400 mt-0.5">▸</span>
                                <span className="text-slate-300">{typeof cond === 'string' ? cond : cond?.condition || JSON.stringify(cond)}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Recommended Order Types */}
                      <div className="mt-4 pt-4 border-t border-violet-500/20">
                        <div className="text-xs text-slate-500 mb-2 font-semibold uppercase tracking-wider">Recommended Order Types</div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                          {[
                            { type: 'Limit', rec: true, desc: isBuy ? `Buy Limit at $${entryPrice > 0 ? entryPrice.toFixed(2) : '--'}` : `Sell Limit at $${entryPrice > 0 ? entryPrice.toFixed(2) : '--'}` },
                            { type: 'Stop Loss', rec: true, desc: stopPrice ? `Stop at $${stopPrice.toFixed(2)}` : 'Set at support' },
                            { type: 'Trailing Stop Loss (%)', rec: riskPerShare && entryPrice ? true : false, desc: riskPerShare && entryPrice ? `Trail ${((riskPerShare / entryPrice) * 100).toFixed(1)}%` : 'Based on volatility' },
                            { type: 'Stop Limit', rec: false, desc: stopPrice ? `Stop $${stopPrice.toFixed(2)}, Limit $${(stopPrice * (isBuy ? 0.995 : 1.005)).toFixed(2)}` : 'For gap protection' },
                          ].map(order => (
                            <div key={order.type} className="group relative">
                              <div className={`p-2.5 rounded-lg text-xs border transition-all ${order.rec ? 'bg-violet-500/15 border-violet-500/30 text-violet-300' : 'bg-slate-800/40 border-slate-700/20 text-slate-400'}`}>
                                <div className="font-semibold flex items-center gap-1">
                                  {order.type}
                                  {order.rec && <span className="text-[8px] bg-violet-500/30 text-violet-300 px-1 rounded">REC</span>}
                                  <HelpCircle className="w-3 h-3 text-slate-500 ml-auto" />
                                </div>
                                <div className="text-[10px] text-slate-500 mt-0.5">{order.desc}</div>
                              </div>
                              <div className="absolute left-0 bottom-full mb-2 w-64 bg-slate-900 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none" style={{ zIndex: 9999 }}>
                                <div className="font-semibold text-violet-400 mb-1">{order.type}</div>
                                <p>{orderTooltips[order.type]}</p>
                              </div>
                            </div>
                          ))}
                        </div>
                        <div className="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2">
                          {[
                            { type: 'Market', desc: 'Instant execution' },
                            { type: 'Trailing Stop Loss ($)', desc: riskPerShare ? `Trail $${riskPerShare.toFixed(2)}` : 'Trail by $ amount' },
                            { type: 'Trailing Stop Limit ($)', desc: riskPerShare ? `Trail $${riskPerShare.toFixed(2)}, limit` : 'Trail with limit' },
                            { type: 'Trailing Stop Limit (%)', desc: riskPerShare && entryPrice ? `Trail ${((riskPerShare / entryPrice) * 100).toFixed(1)}%, limit` : 'Trail % with limit' },
                          ].map(order => (
                            <div key={order.type} className="group relative">
                              <div className="p-2.5 rounded-lg text-xs bg-slate-800/40 border border-slate-700/20 text-slate-400 transition-all">
                                <div className="font-semibold flex items-center gap-1">
                                  {order.type}
                                  <HelpCircle className="w-3 h-3 text-slate-500 ml-auto" />
                                </div>
                                <div className="text-[10px] text-slate-500 mt-0.5">{order.desc}</div>
                              </div>
                              <div className="absolute left-0 bottom-full mb-2 w-64 bg-slate-900 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none" style={{ zIndex: 9999 }}>
                                <div className="font-semibold text-violet-400 mb-1">{order.type}</div>
                                <p>{orderTooltips[order.type]}</p>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Time in Force */}
                      <div className="mt-4 pt-4 border-t border-violet-500/20">
                        <div className="text-xs text-slate-500 mb-2 font-semibold uppercase tracking-wider flex items-center gap-1">
                          Time in Force
                          <span className="group relative inline-flex">
                            <HelpCircle className="w-3 h-3 text-slate-500 cursor-help" />
                            <span className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-56 bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-xs text-slate-300 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all pointer-events-none font-normal normal-case tracking-normal" style={{ zIndex: 9999 }}>
                              <span className="font-semibold text-violet-400 block mb-1">Time in Force (TIF)</span>
                              Tells your broker how long an order should remain active before it's automatically canceled. Choose based on your trading urgency and strategy.
                            </span>
                          </span>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                          {[
                            { name: 'Day Order', rec: true, short: 'Cancels at market close', tip: 'Your order is only active for the current trading day. If not filled by 4:00 PM ET, it is automatically canceled. This is the default at most brokers and works best for active day traders.' },
                            { name: 'Good \'til Canceled', rec: true, short: 'Active up to 180 days', tip: 'Your order stays active until it executes or you cancel it (most brokers auto-cancel after 60-180 days). Best for swing traders who want to set entries/exits at specific prices and wait.' },
                            { name: 'Fill or Kill', rec: false, short: 'All or nothing, instant', tip: 'The entire order must be filled immediately and completely, or it is canceled entirely. No partial fills allowed. Used for large orders where incomplete execution would be problematic.' },
                            { name: 'Immediate or Cancel', rec: false, short: 'Fill what you can, cancel rest', tip: 'Fills as many shares as possible immediately, then cancels any unfilled portion. Unlike Fill or Kill, partial fills ARE allowed. Good when you want quick execution but can accept fewer shares.' },
                            { name: 'On the Open', rec: false, short: 'Fills at opening price', tip: 'Your order executes only at the market opening price. Must be placed between 4:15 PM and 9:28 AM ET (pre-market). Useful for reacting to overnight news at the first available price.' },
                          ].map(tif => (
                            <div key={tif.name} className="group relative">
                              <div className={`p-2.5 rounded-lg text-xs border transition-all ${tif.rec ? 'bg-cyan-500/10 border-cyan-500/20 text-cyan-300' : 'bg-slate-800/40 border-slate-700/20 text-slate-400'}`}>
                                <div className="font-semibold flex items-center gap-1">
                                  {tif.name}
                                  {tif.rec && <span className="text-[8px] bg-cyan-500/30 text-cyan-300 px-1 rounded">REC</span>}
                                  <HelpCircle className="w-3 h-3 text-slate-500 ml-auto" />
                                </div>
                                <div className="text-[10px] text-slate-500 mt-0.5">{tif.short}</div>
                              </div>
                              <div className="absolute left-0 bottom-full mb-2 w-64 bg-slate-900 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none" style={{ zIndex: 9999 }}>
                                <div className="font-semibold text-cyan-400 mb-1">{tif.name}</div>
                                <p>{tif.tip}</p>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                    );
                  })()}

                  {/* Position Size Calculator for Analysis */}
                  {analysis.final?.tradeInstruction && (
                    <div className="bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border border-emerald-500/30 rounded-xl p-5 mb-6">
                      <div className="flex items-center justify-between mb-4">
                        <h4 className="font-semibold text-emerald-300 flex items-center gap-2">
                          <Calculator className="w-5 h-5" />
                          Position Size Calculator
                        </h4>
                        <div className="text-xs text-slate-400">Calculate your position based on risk</div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                          <label className="text-xs text-slate-400 mb-1 block">Your Portfolio Value</label>
                          <div className="flex items-center gap-2">
                            <span className="text-slate-400">$</span>
                            <input
                              type="number"
                              value={portfolioSettings.totalCapital}
                              onChange={(e) => setPortfolioSettings(prev => ({
                                ...prev,
                                totalCapital: parseInt(e.target.value) || 0
                              }))}
                              className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-right font-mono"
                              placeholder="10000"
                            />
                          </div>
                        </div>
                        <div>
                          <label className="text-xs text-slate-400 mb-1 block">Risk Per Trade</label>
                          <div className="flex items-center gap-2">
                            <input
                              type="number"
                              value={portfolioSettings.riskPercent}
                              onChange={(e) => setPortfolioSettings(prev => ({
                                ...prev,
                                riskPercent: Math.min(10, Math.max(0.5, parseFloat(e.target.value) || 2))
                              }))}
                              className="w-20 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-right font-mono"
                              min="0.5"
                              max="10"
                              step="0.5"
                            />
                            <span className="text-slate-400">%</span>
                            <div className="flex gap-1 ml-2">
                              {[1, 2, 5].map(pct => (
                                <button
                                  key={pct}
                                  onClick={() => setPortfolioSettings(prev => ({ ...prev, riskPercent: pct }))}
                                  className={`px-2 py-1 rounded text-xs font-semibold ${
                                    portfolioSettings.riskPercent === pct
                                      ? 'bg-emerald-600 text-white'
                                      : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                  }`}
                                >
                                  {pct}%
                                </button>
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>
                      {/* Calculated Results */}
                      {(() => {
                        // Parse entry and stop from the analysis - ensure strings
                        const entryStr = String(analysis.final.tradeInstruction.action || '');
                        const stopStr = String(analysis.final.tradeInstruction.stop || '');
                        const entryMatch = entryStr.match(/\$?([\d.]+)/);
                        const stopMatch = stopStr.match(/\$?([\d.]+)/);
                        const entry = entryMatch ? parseFloat(entryMatch[1]) : (tickerData.price || 0);
                        const stopLoss = stopMatch ? parseFloat(stopMatch[1]) : entry * 0.97;
                        const riskPerShare = Math.abs(entry - stopLoss);
                        const maxRiskAmount = (portfolioSettings.totalCapital * portfolioSettings.riskPercent) / 100;
                        const recommendedShares = riskPerShare > 0 ? Math.floor(maxRiskAmount / riskPerShare) : 0;
                        const positionValue = recommendedShares * entry;
                        const portfolioAllocation = portfolioSettings.totalCapital > 0 ? (positionValue / portfolioSettings.totalCapital) * 100 : 0;

                        return (
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-emerald-500/20">
                            <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                              <div className="text-xs text-slate-500 mb-1">Max Risk Amount</div>
                              <div className="text-lg font-bold text-amber-400">${maxRiskAmount.toFixed(0)}</div>
                            </div>
                            <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                              <div className="text-xs text-slate-500 mb-1">Recommended Shares</div>
                              <div className="text-lg font-bold text-emerald-400">{recommendedShares}</div>
                            </div>
                            <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                              <div className="text-xs text-slate-500 mb-1">Position Value</div>
                              <div className="text-lg font-bold text-blue-400">${positionValue.toLocaleString()}</div>
                            </div>
                            <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                              <div className="text-xs text-slate-500 mb-1">Portfolio %</div>
                              <div className={`text-lg font-bold ${portfolioAllocation > 25 ? 'text-red-400' : 'text-violet-400'}`}>
                                {portfolioAllocation.toFixed(1)}%
                              </div>
                            </div>
                          </div>
                        );
                      })()}
                      <div className="text-xs text-slate-500 mt-3 flex items-center gap-1">
                        <AlertCircle className="w-3 h-3" />
                        Position sized to risk ${((portfolioSettings.totalCapital * portfolioSettings.riskPercent) / 100).toFixed(0)} if stop loss is hit
                      </div>
                    </div>
                  )}

                  {/* If You Must Trade - Shown for lower confidence setups */}
                  {analysis.final.ifYouMustTrade && (
                    <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-5 mb-6">
                      <h4 className="font-semibold mb-3 text-amber-400 flex items-center gap-2">
                        <AlertTriangle className="w-5 h-5" />
                        If You Must Trade (Reduced Risk Setup)
                      </h4>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="relative">
                          <div className="text-xs text-slate-500 mb-1">Direction</div>
                          <div
                            className="relative inline-block"
                            onMouseEnter={() => setActiveTooltip('ifmusttrade')}
                            onMouseLeave={() => setActiveTooltip(null)}
                          >
                            <div
                              className={`font-bold text-lg cursor-help ${
                                analysis.final.ifYouMustTrade.direction === 'LONG' ? 'text-emerald-400' : 'text-red-400'
                              }`}
                            >
                              {analysis.final.ifYouMustTrade.direction} <span className="text-xs opacity-60">ⓘ</span>
                            </div>
                            {/* State-based Tooltip */}
                            {activeTooltip === 'ifmusttrade' && (
                              <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-56 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                                <div className={`font-semibold mb-1 ${analysis.final.ifYouMustTrade.direction === 'LONG' ? 'text-emerald-400' : 'text-red-400'}`}>
                                  {analysis.final.ifYouMustTrade.direction === 'LONG' ? '📈 LONG Position' : '📉 SHORT Position'}
                                </div>
                                <p>{analysis.final.ifYouMustTrade.direction === 'LONG'
                                  ? "Buy position. You profit when the price goes UP. Buy low, sell high."
                                  : "Sell position. You profit when the price goes DOWN. Sell high, buy back lower."}</p>
                              </div>
                            )}
                          </div>
                        </div>
                        <div>
                          <div className="text-xs text-slate-500 mb-1">Entry</div>
                          <div className="font-bold text-lg text-white">{analysis.final.ifYouMustTrade.entry}</div>
                        </div>
                        <div>
                          <div className="text-xs text-slate-500 mb-1">Tight Stop</div>
                          <div className="font-bold text-lg text-red-400">{analysis.final.ifYouMustTrade.tightStop}</div>
                        </div>
                        <div>
                          <div className="text-xs text-slate-500 mb-1">Conservative Target</div>
                          <div className="font-bold text-lg text-green-400">{analysis.final.ifYouMustTrade.conservativeTarget}</div>
                        </div>
                      </div>
                      <div className="mt-3 text-sm text-amber-300">
                        ⚠️ Position Size: {analysis.final.ifYouMustTrade.positionSize}
                      </div>
                    </div>
                  )}

                  {/* Wait For Conditions - ALWAYS SHOW with fallback generation */}
                  {(() => {
                    // Generate wait conditions if not provided
                    let waitConditions = analysis.final.waitForConditions || [];

                    // If no wait conditions provided, generate smart defaults
                    if (waitConditions.length === 0) {
                      const entry = analysis.tradeSetup?.immediateEntry;
                      const trend = analysis.patterns?.trendAnalysis?.trend;
                      const rsi = analysis.realIndicators?.rsi;

                      if (trend === 'SIDEWAYS') {
                        waitConditions.push('Trend direction to emerge from sideways action');
                      }
                      if (entry?.entry) {
                        const entryPrice = parseFloat(entry.entry?.replace(/[^0-9.]/g, ''));
                        if (entryPrice && analysis.final.directionalBias === 'LONG') {
                          waitConditions.push(`Clear break above ${entryPrice.toFixed(2)} with volume`);
                        } else if (entryPrice && analysis.final.directionalBias === 'SHORT') {
                          waitConditions.push(`Clear break below ${entryPrice.toFixed(2)} with volume`);
                        }
                      }
                      if (!entry?.riskRewardRatio || entry?.riskRewardRatio === 'N/A' || parseFloat(entry?.riskRewardRatio?.split(':')[1]) < 2) {
                        waitConditions.push('Better risk:reward ratio definition');
                      }
                      if (rsi && rsi > 65) {
                        waitConditions.push('RSI pullback from overbought levels');
                      } else if (rsi && rsi < 35) {
                        waitConditions.push('RSI bounce confirmation from oversold levels');
                      }
                      if (analysis.final.biasStrength === 'WEAK') {
                        waitConditions.push('Stronger directional confirmation');
                      }
                      if (waitConditions.length === 0) {
                        waitConditions.push('Confirmation of entry signal');
                        waitConditions.push('Volume confirmation on breakout');
                      }
                    }

                    const isWaitRec = analysis.final.recommendation?.includes("WAIT");

                    return (
                      <div className={`rounded-xl p-5 mb-6 ${
                        isWaitRec
                          ? "bg-amber-500/15 border-2 border-amber-500/50 shadow-lg shadow-amber-500/10"
                          : "bg-cyan-500/10 border border-cyan-500/30"
                      }`}>
                        <h4 className={`font-semibold mb-3 flex items-center gap-2 ${
                          isWaitRec ? "text-amber-400" : "text-cyan-400"
                        }`}>
                          <Clock className="w-5 h-5" />
                          🎯 Before You Trade - Wait For:
                        </h4>
                        <ul className="space-y-2">
                          {waitConditions.map((condition, i) => (
                            <li key={i} className="flex items-start gap-2">
                              <span className={`mt-0.5 ${isWaitRec ? "text-amber-400" : "text-cyan-400"}`}>→</span>
                              <span className="text-sm text-slate-300">{condition}</span>
                            </li>
                          ))}
                        </ul>
                        <p className="text-xs text-slate-400 mt-3 pt-3 border-t border-slate-700">
                          💡 Set alerts for these levels so you don't miss the entry when conditions are met.
                        </p>
                      </div>
                    );
                  })()}

                  {/* Factors Analysis - ALWAYS SHOW with smart fallbacks */}
                  {(() => {
                    // Generate bullish factors if not provided
                    let bullishFactors = analysis.final.bullishFactors || [];
                    let bearishFactors = analysis.final.bearishFactors || [];

                    // Generate smart bullish factors from analysis data
                    if (bullishFactors.length === 0) {
                      const indicators = analysis.realIndicators || {};
                      const trend = analysis.patterns?.trendAnalysis?.trend;
                      const patterns = analysis.patterns;

                      if (indicators.netScore > 20) {
                        bullishFactors.push(`Indicator net score above ${indicators.netScore > 40 ? '40' : '20'}`);
                      }
                      if (trend === 'UPTREND') {
                        bullishFactors.push('Price in confirmed uptrend');
                      }
                      if (indicators.aboveSMA20) {
                        bullishFactors.push('Trading above 20-period moving average');
                      }
                      if (indicators.aboveSMA50) {
                        bullishFactors.push('Trading above 50-period moving average');
                      }
                      if (indicators.macd > 0) {
                        bullishFactors.push('Positive MACD momentum');
                      }
                      if (indicators.rsi && indicators.rsi > 50 && indicators.rsi < 70) {
                        bullishFactors.push('RSI showing bullish momentum');
                      }
                      if (indicators.rsi && indicators.rsi < 30) {
                        bullishFactors.push('Oversold RSI suggesting potential bounce');
                      }
                      if (patterns?.quality && patterns.quality !== 'LOW') {
                        bullishFactors.push(`${patterns.quality === 'HIGH' ? 'High' : 'Medium'} pattern quality`);
                      }
                      if (analysis.stockCatalysts?.upcomingEvents?.length > 0) {
                        bullishFactors.push('Upcoming ' + (analysis.stockCatalysts.upcomingEvents[0]?.toLowerCase().includes('earning') ? 'earnings event' : 'catalyst event'));
                      }
                    }

                    // Generate smart bearish factors from analysis data
                    if (bearishFactors.length === 0) {
                      const indicators = analysis.realIndicators || {};
                      const trend = analysis.patterns?.trendAnalysis?.trend;
                      const entry = analysis.tradeSetup?.immediateEntry;

                      if (trend === 'SIDEWAYS') {
                        bearishFactors.push('Sideways trend lacks directional momentum');
                      }
                      if (trend === 'DOWNTREND') {
                        bearishFactors.push('Price in confirmed downtrend');
                      }
                      if (!entry?.riskRewardRatio || entry?.riskRewardRatio === 'N/A') {
                        bearishFactors.push('No defined risk:reward ratio');
                      }
                      if (entry?.winProbability === '0%' || entry?.winProbability === 0) {
                        bearishFactors.push('0% win probability');
                      }
                      if (indicators.netScore < 0) {
                        bearishFactors.push('Negative indicator net score');
                      }
                      if (indicators.rsi && indicators.rsi > 70) {
                        bearishFactors.push('Overbought RSI conditions');
                      }
                      if (indicators.macd < 0) {
                        bearishFactors.push('Negative MACD momentum');
                      }
                      if (!indicators.aboveSMA20 && !indicators.aboveSMA50) {
                        bearishFactors.push('Below key moving averages');
                      }
                      if (analysis.final.setupQuality === 'D') {
                        bearishFactors.push('Poor setup quality grade');
                      }
                      if (analysis.stockCatalysts?.sentiment === 'mixed' || analysis.stockCatalysts?.overallSentiment === 'mixed') {
                        bearishFactors.push('Mixed sector sentiment');
                      }
                    }

                    // Ensure at least some content
                    if (bullishFactors.length === 0) {
                      bullishFactors.push('Monitoring for bullish signals');
                    }
                    if (bearishFactors.length === 0) {
                      bearishFactors.push('No significant bearish signals detected');
                    }

                    return (
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
                        <div className="bg-emerald-500/5 border border-emerald-500/20 rounded-xl p-5">
                          <h4 className="font-semibold mb-3 text-emerald-400 flex items-center gap-2">
                            <ArrowUpRight className="w-5 h-5" />
                            Bullish Factors
                          </h4>
                          <ul className="space-y-2">
                            {bullishFactors.map((factor, i) => (
                              <li key={i} className="flex items-start gap-2">
                                <Check className="w-4 h-4 text-emerald-400 mt-0.5 flex-shrink-0" />
                                <span className="text-sm">{typeof factor === 'string' ? factor : factor.factor || factor.explanation}</span>
                              </li>
                            ))}
                          </ul>
                        </div>

                        <div className="bg-red-500/5 border border-red-500/20 rounded-xl p-5">
                          <h4 className="font-semibold mb-3 text-red-400 flex items-center gap-2">
                            <ArrowDownRight className="w-5 h-5" />
                            Bearish Factors
                          </h4>
                          <ul className="space-y-2">
                            {bearishFactors.map((factor, i) => (
                              <li key={i} className="flex items-start gap-2">
                                <X className="w-4 h-4 text-red-400 mt-0.5 flex-shrink-0" />
                                <span className="text-sm">{typeof factor === 'string' ? factor : factor.factor || factor.explanation}</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                      </div>
                    );
                  })()}

                  {/* Key Levels & Risk Warning - ALWAYS SHOW with smart fallbacks */}
                  {(() => {
                    // Generate key levels if not provided
                    let keyLevels = analysis.final.keyLevels || [];
                    let riskWarning = analysis.final.riskWarning || '';

                    // Generate smart key levels from analysis data
                    if (keyLevels.length === 0) {
                      const entry = analysis.tradeSetup?.immediateEntry;
                      const priceRange = analysis.context?.priceRange;
                      const sr = analysis.supportResistance || analysis.patterns?.supportResistance;

                      if (entry?.entry) {
                        keyLevels.push(`${entry.entry} entry level`);
                      }
                      if (entry?.stopLoss) {
                        keyLevels.push(`${entry.stopLoss} stop loss`);
                      }
                      if (entry?.target1) {
                        keyLevels.push(`${entry.target1} first target`);
                      }
                      if (sr?.resistance && sr.resistance.length > 0) {
                        keyLevels.push(`${sr.resistance[0]} resistance breakout level`);
                      }
                      if (sr?.support && sr.support.length > 0) {
                        keyLevels.push(`${sr.support[0]} support zone`);
                      }
                      if (entry?.target2) {
                        keyLevels.push(`${entry.target2} extended target`);
                      }
                      // Fallback to current price levels
                      if (keyLevels.length === 0 && priceRange?.current) {
                        const current = parseFloat(priceRange.current?.replace(/[^0-9.]/g, '')) || 0;
                        if (current > 0) {
                          keyLevels.push(`${(current * 1.02).toFixed(2)} resistance (+2%)`);
                          keyLevels.push(`${(current * 0.98).toFixed(2)} support (-2%)`);
                          keyLevels.push(`${(current * 1.05).toFixed(2)} target (+5%)`);
                        }
                      }
                    }

                    // Generate smart risk warning if not provided
                    if (!riskWarning) {
                      const trend = analysis.patterns?.trendAnalysis?.trend;
                      const entry = analysis.tradeSetup?.immediateEntry;
                      const indicators = analysis.realIndicators || {};

                      const risks = [];
                      if (trend === 'SIDEWAYS') {
                        risks.push('Sideways trend with no clear direction');
                      }
                      if (!entry?.riskRewardRatio || entry?.riskRewardRatio === 'N/A') {
                        risks.push('undefined risk parameters');
                      }
                      if (entry?.winProbability === '0%' || entry?.winProbability === 0) {
                        risks.push('0% historical win probability');
                      }
                      if (analysis.final.setupQuality === 'D') {
                        risks.push('poor setup quality');
                      }
                      if (indicators.rsi > 75) {
                        risks.push('extremely overbought conditions');
                      } else if (indicators.rsi < 25) {
                        risks.push('extremely oversold conditions');
                      }

                      if (risks.length > 0) {
                        riskWarning = `Main risk: ${risks.slice(0, 2).join(', ')}${risks.length > 2 ? ', and ' + (risks.length - 2) + ' other factors' : ''} make this a ${risks.length > 2 ? 'high-risk' : 'cautious'} setup`;
                      } else {
                        riskWarning = 'Standard market risk applies. Always use proper position sizing and stop losses.';
                      }
                    }

                    return (
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div className="bg-slate-800/50 rounded-xl p-5">
                          <h4 className="font-semibold mb-3">Key Watch Levels</h4>
                          <div className="space-y-2">
                            {keyLevels.map((level, i) => (
                              <div key={i} className="flex items-center gap-2">
                                <Target className="w-4 h-4 text-violet-400" />
                                <span className="font-mono text-sm">{level}</span>
                              </div>
                            ))}
                          </div>
                        </div>

                        <div className="bg-amber-500/5 border border-amber-500/20 rounded-xl p-5">
                          <h4 className="font-semibold mb-3 text-amber-400 flex items-center gap-2">
                            <Shield className="w-5 h-5" />
                            Risk Warning
                          </h4>
                          <p className="text-sm text-slate-300">{riskWarning}</p>
                        </div>
                      </div>
                    );
                  })()}

                  {/* Consistency Badge */}
                  {imageHash && cachedAnalyses[imageHash] && (
                    <div className="mt-6 pt-6 border-t border-slate-700/50">
                      <div className="flex items-center justify-center gap-2 text-sm text-emerald-400">
                        <Sparkles className="w-4 h-4" />
                        <span>Analysis retrieved from cache - 100% consistent results</span>
                      </div>
                    </div>
                  )}
                </div>

                {/* Detailed Analysis Tabs */}
                <div className="bg-slate-900/50 rounded-2xl border border-slate-800/50 p-6">
                  <div className="flex gap-2 mb-6 overflow-x-auto">
                    <button
                      onClick={() => setAnalysisTab("overview")}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap ${
                        analysisTab === "overview"
                          ? "bg-violet-600 text-white"
                          : "bg-slate-800/50 text-slate-400 hover:bg-slate-800"
                      }`}
                    >
                      Overview
                    </button>
                    <button
                      onClick={() => setAnalysisTab("patterns")}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap ${
                        analysisTab === "patterns"
                          ? "bg-violet-600 text-white"
                          : "bg-slate-800/50 text-slate-400 hover:bg-slate-800"
                      }`}
                    >
                      Patterns
                    </button>
                    <button
                      onClick={() => setAnalysisTab("indicators")}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap ${
                        analysisTab === "indicators"
                          ? "bg-violet-600 text-white"
                          : "bg-slate-800/50 text-slate-400 hover:bg-slate-800"
                      }`}
                    >
                      Indicators
                    </button>
                    <button
                      onClick={() => setAnalysisTab("setups")}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap ${
                        analysisTab === "setups"
                          ? "bg-violet-600 text-white"
                          : "bg-slate-800/50 text-slate-400 hover:bg-slate-800"
                      }`}
                    >
                      Trade Setups
                    </button>
                    <button
                      onClick={() => setAnalysisTab("predictions")}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap ${
                        analysisTab === "predictions"
                          ? "bg-violet-600 text-white"
                          : "bg-slate-800/50 text-slate-400 hover:bg-slate-800"
                      }`}
                    >
                      Predictions
                    </button>
                    <button
                      onClick={() => setAnalysisTab("recommendations")}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap ${
                        analysisTab === "recommendations"
                          ? "bg-violet-600 text-white"
                          : "bg-slate-800/50 text-slate-400 hover:bg-slate-800"
                      }`}
                    >
                      Indicator Setup
                    </button>
                    <button
                      onClick={() => setAnalysisTab("qa")}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap ${
                        analysisTab === "qa"
                          ? "bg-violet-600 text-white"
                          : "bg-slate-800/50 text-slate-400 hover:bg-slate-800"
                      }`}
                    >
                      Ask About Chart
                    </button>
                  </div>

                  {/* Tab Content */}
                  {analysisTab === "overview" && (
                    <div className="space-y-4 md:space-y-6">
                      <div>
                        <h4 className="font-semibold mb-4">Chart Context</h4>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                          <div className="bg-slate-800/30 rounded-lg p-4">
                            <div className="text-xs text-slate-500 mb-1">Chart Type</div>
                            <div className="font-medium">{formatValue(analysis.context.chartType)}</div>
                          </div>
                          <div className="bg-slate-800/30 rounded-lg p-4">
                            <div className="text-xs text-slate-500 mb-1">Date Range</div>
                            <div className="font-medium text-sm">
                              {formatValue(analysis.context.dateRange?.start)} — {formatValue(analysis.context.dateRange?.end)}
                            </div>
                          </div>
                          <div className="bg-slate-800/30 rounded-lg p-4">
                            <div className="text-xs text-slate-500 mb-1">Last Candle</div>
                            <div className={`font-medium ${
                              analysis.context.lastCandle?.color === "GREEN" ? "text-green-400" : "text-red-400"
                            }`}>
                              {formatValue(analysis.context.lastCandle?.color)} Candle
                            </div>
                            <div className="text-xs text-slate-400 mt-1">{formatValue(analysis.context.lastCandle?.wickType)?.replace(/_/g, ' ')}</div>
                          </div>
                          {analysis.context.indicatorPanels && analysis.context.indicatorPanels.length > 0 && (
                            <div className="bg-slate-800/30 rounded-lg p-4 md:col-span-2">
                              <div className="text-xs text-slate-500 mb-1">Indicators Present</div>
                              <div className="flex flex-wrap gap-2 mt-2">
                                {formatArray(analysis.context.indicatorPanels).map((ind, i) => (
                                  <span key={i} className="px-2 py-1 bg-violet-600/20 rounded text-xs font-medium">
                                    {ind}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}
                          {analysis.context.movingAverageCount > 0 && (
                            <div className="bg-slate-800/30 rounded-lg p-4">
                              <div className="text-xs text-slate-500 mb-1">Moving Averages</div>
                              <div className="font-medium">{analysis.context.movingAverageCount} Lines</div>
                              {analysis.context.movingAveragePeriods && analysis.context.movingAveragePeriods !== "NOT_VISIBLE" && (
                                <div className="text-xs text-slate-400 mt-1">Periods: {analysis.context.movingAveragePeriods}</div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>

                      {analysis.final.pointsBreakdown && (
                        <div>
                          <h4 className="font-semibold mb-4">Scoring Breakdown</h4>
                          <div className="bg-slate-800/30 rounded-lg p-5">
                            <div className="space-y-2 md:space-y-3">
                              {Object.entries(analysis.final.pointsBreakdown).map(([key, value]) => {
                                if (key === 'totalPoints') return null;
                                return (
                                  <div key={key} className="flex items-center justify-between">
                                    <span className="text-sm capitalize">{key.replace(/([A-Z])/g, ' $1').trim()}</span>
                                    <div className="flex items-center gap-3">
                                      <div className="w-32 bg-slate-700 rounded-full h-2 overflow-hidden">
                                        <div
                                          className={`h-full ${value > 0 ? 'bg-emerald-500' : 'bg-red-500'}`}
                                          style={{ width: `${Math.abs(value) * 5}%` }}
                                        />
                                      </div>
                                      <span className={`font-mono text-sm font-semibold w-8 text-right ${
                                        value > 0 ? 'text-emerald-400' : 'text-red-400'
                                      }`}>
                                        {value > 0 ? '+' : ''}{value}
                                      </span>
                                    </div>
                                  </div>
                                );
                              })}
                              <div className="pt-3 border-t border-slate-700 flex items-center justify-between">
                                <span className="font-semibold">Total Score</span>
                                <span className="font-mono text-lg font-bold text-violet-400">
                                  {analysis.final.pointsBreakdown.totalPoints}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  )}

                  {analysisTab === "patterns" && (
                    <div className="space-y-4 md:space-y-6">
                      <div>
                        <h4 className="font-semibold mb-4">Trend Structure</h4>
                        <div className="bg-slate-800/30 rounded-lg p-5">
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div>
                              <div className="text-xs text-slate-500 mb-1">Primary Trend</div>
                              <div className={`font-bold text-lg ${getTrendColor(analysis.patterns.trendAnalysis.trend)}`}>
                                {formatValue(analysis.patterns.trendAnalysis.trend)}
                              </div>
                            </div>
                            <div>
                              <div className="text-xs text-slate-500 mb-1">Strength</div>
                              <span className={`inline-block px-3 py-1 rounded-lg font-semibold text-sm ${getStrengthBadge(analysis.patterns.trendAnalysis.trendStrength)}`}>
                                {formatValue(analysis.patterns.trendAnalysis.trendStrength)}
                              </span>
                            </div>
                            <div>
                              <div className="text-xs text-slate-500 mb-1">Swing Highs</div>
                              <div className="text-sm">
                                <span className="font-semibold">{analysis.patterns.trendAnalysis.swingHighsCount}</span> peaks
                                <div className={`text-xs mt-1 ${getTrendColor(analysis.patterns.trendAnalysis.last3HighsProgression)}`}>
                                  {formatValue(analysis.patterns.trendAnalysis.last3HighsProgression)}
                                </div>
                              </div>
                            </div>
                            <div>
                              <div className="text-xs text-slate-500 mb-1">Swing Lows</div>
                              <div className="text-sm">
                                <span className="font-semibold">{analysis.patterns.trendAnalysis.swingLowsCount}</span> troughs
                                <div className={`text-xs mt-1 ${getTrendColor(analysis.patterns.trendAnalysis.last3LowsProgression)}`}>
                                  {formatValue(analysis.patterns.trendAnalysis.last3LowsProgression)}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div>
                        <h4 className="font-semibold mb-4">Support & Resistance</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div className="bg-red-500/5 border border-red-500/20 rounded-lg p-4">
                            <h5 className="text-sm font-semibold text-red-400 mb-3 flex items-center gap-2">
                              <TrendingDown className="w-4 h-4" />
                              Resistance Levels
                            </h5>
                            <div className="space-y-2">
                              {analysis.patterns.keyLevels.resistance && analysis.patterns.keyLevels.resistance.length > 0 ? (
                                analysis.patterns.keyLevels.resistance.map((level, i) => (
                                  <div key={i} className="flex items-center justify-between text-sm">
                                    <span className="font-mono font-semibold">{formatPrice(level.price)}</span>
                                    <span className={`px-2 py-1 rounded text-xs ${
                                      level.classification === "MAJOR" ? "bg-red-500/20 text-red-300" : "bg-red-500/10 text-red-400"
                                    }`}>
                                      {level.touches} touch{level.touches > 1 ? 'es' : ''} • {level.classification}
                                    </span>
                                  </div>
                                ))
                              ) : (
                                <p className="text-xs text-slate-500 italic">No significant resistance identified</p>
                              )}
                            </div>
                          </div>

                          <div className="bg-green-500/5 border border-green-500/20 rounded-lg p-4">
                            <h5 className="text-sm font-semibold text-green-400 mb-3 flex items-center gap-2">
                              <TrendingUp className="w-4 h-4" />
                              Support Levels
                            </h5>
                            <div className="space-y-2">
                              {analysis.patterns.keyLevels.support && analysis.patterns.keyLevels.support.length > 0 ? (
                                analysis.patterns.keyLevels.support.map((level, i) => (
                                  <div key={i} className="flex items-center justify-between text-sm">
                                    <span className="font-mono font-semibold">{formatPrice(level.price)}</span>
                                    <span className={`px-2 py-1 rounded text-xs ${
                                      level.classification === "MAJOR" ? "bg-green-500/20 text-green-300" : "bg-green-500/10 text-green-400"
                                    }`}>
                                      {level.touches} touch{level.touches > 1 ? 'es' : ''} • {level.classification}
                                    </span>
                                  </div>
                                ))
                              ) : (
                                <p className="text-xs text-slate-500 italic">No significant support identified</p>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>

                      {(analysis.patterns.reversalPatterns || analysis.patterns.continuationPatterns) && (
                        <div>
                          <h4 className="font-semibold mb-4">Detected Patterns</h4>
                          <div className="space-y-2 md:space-y-3">
                            {analysis.patterns.reversalPatterns && Object.entries(analysis.patterns.reversalPatterns).map(([key, value]) => {
                              if (value === "NONE" || !value) return null;

                              // Pattern-specific details
                              const patternInfo = {
                                'doubleTop': {
                                  bias: 'BEARISH',
                                  description: 'Two peaks at similar price level indicating sellers are defending resistance',
                                  tradeTip: 'Wait for neckline break, target = distance from peaks to neckline',
                                  stopHint: 'Above the double top peaks'
                                },
                                'doubleBottom': {
                                  bias: 'BULLISH',
                                  description: 'Two troughs at similar price level indicating buyers are defending support',
                                  tradeTip: 'Wait for neckline break, target = distance from troughs to neckline',
                                  stopHint: 'Below the double bottom troughs'
                                },
                                'headAndShoulders': {
                                  bias: 'BEARISH',
                                  description: 'Three peaks with middle peak (head) highest - classic reversal pattern',
                                  tradeTip: 'Enter on neckline break, target = head to neckline distance',
                                  stopHint: 'Above the right shoulder'
                                },
                                'inverseHeadAndShoulders': {
                                  bias: 'BULLISH',
                                  description: 'Three troughs with middle trough (head) lowest - bullish reversal',
                                  tradeTip: 'Enter on neckline break, target = head to neckline distance',
                                  stopHint: 'Below the right shoulder'
                                }
                              };

                              const info = patternInfo[key] || {
                                bias: 'NEUTRAL',
                                description: 'Chart pattern detected',
                                tradeTip: 'Wait for confirmation before trading',
                                stopHint: 'Beyond pattern boundaries'
                              };

                              return (
                                <div key={key} className="bg-violet-500/10 border border-violet-500/20 rounded-lg p-4">
                                  <div className="flex items-start justify-between mb-3">
                                    <div>
                                      <div className="font-semibold text-lg capitalize">{key.replace(/([A-Z])/g, ' $1').trim()}</div>
                                      <div className="text-sm text-slate-400 mt-1">{value}</div>
                                    </div>
                                    <div className="flex gap-2">
                                      <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                        info.bias === 'BEARISH' ? 'bg-red-500/20 text-red-300' :
                                        info.bias === 'BULLISH' ? 'bg-green-500/20 text-green-300' :
                                        'bg-slate-500/20 text-slate-300'
                                      }`}>
                                        {info.bias}
                                      </span>
                                      <span className="px-2 py-1 bg-violet-600/20 rounded text-xs font-semibold">
                                        Reversal Pattern
                                      </span>
                                    </div>
                                  </div>
                                  <div className="bg-slate-800/50 rounded-lg p-3 space-y-2 text-sm">
                                    <p className="text-slate-300">{info.description}</p>
                                    <div className="grid grid-cols-2 gap-3 pt-2 border-t border-slate-700">
                                      <div>
                                        <span className="text-xs text-slate-500">Trade Setup:</span>
                                        <p className="text-xs text-slate-400 mt-1">{info.tradeTip}</p>
                                      </div>
                                      <div>
                                        <span className="text-xs text-slate-500">Stop Loss:</span>
                                        <p className="text-xs text-slate-400 mt-1">{info.stopHint}</p>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              );
                            })}

                            {analysis.patterns.continuationPatterns?.triangleType && analysis.patterns.continuationPatterns.triangleType !== "NONE" && (
                              <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
                                <div className="flex items-start justify-between mb-3">
                                  <div>
                                    <div className="font-semibold text-lg">{analysis.patterns.continuationPatterns.triangleType.replace(/_/g, ' ')}</div>
                                    <div className="text-sm text-slate-400 mt-1">
                                      Breakout direction: <span className={analysis.patterns.continuationPatterns.breakoutDirection === 'UP' ? 'text-green-400' : 'text-red-400'}>{analysis.patterns.continuationPatterns.breakoutDirection}</span>
                                    </div>
                                  </div>
                                  <span className="px-2 py-1 bg-blue-600/20 rounded text-xs font-semibold">
                                    Continuation Pattern
                                  </span>
                                </div>
                                <div className="bg-slate-800/50 rounded-lg p-3 text-sm">
                                  <p className="text-slate-300 mb-2">Price consolidating in a triangle - typically breaks in the direction of the prior trend.</p>
                                  <div className="text-xs text-slate-400">
                                    <span className="text-slate-500">Trade Tip:</span> Wait for breakout with volume confirmation, then enter in breakout direction.
                                  </div>
                                </div>
                              </div>
                            )}

                            {/* No patterns detected message */}
                            {(!analysis.patterns.reversalPatterns || Object.values(analysis.patterns.reversalPatterns).every(v => v === "NONE" || !v)) &&
                             (!analysis.patterns.continuationPatterns?.triangleType || analysis.patterns.continuationPatterns.triangleType === "NONE") && (
                              <div className="bg-slate-800/30 rounded-lg p-4 text-center">
                                <p className="text-slate-400 text-sm">No significant chart patterns detected at this time.</p>
                                <p className="text-xs text-slate-500 mt-1">Patterns may form as price action develops.</p>
                              </div>
                            )}
                          </div>
                        </div>
                      )}

                      {/* Price Position Analysis */}
                      <div>
                        <h4 className="font-semibold mb-4">Price Position Analysis</h4>
                        <div className="bg-slate-800/30 rounded-lg p-4">
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            {analysis.patterns.keyLevels.resistance?.[0] && (
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Nearest Resistance</div>
                                <div className="font-mono font-semibold text-red-400">{formatPrice(analysis.patterns.keyLevels.resistance[0].price)}</div>
                                <div className="text-xs text-slate-500 mt-1">
                                  {analysis.context.priceRange?.current && (
                                    <>Distance: {((parseFloat(String(analysis.patterns.keyLevels.resistance[0].price).replace(/[^0-9.]/g, '')) / parseFloat(String(analysis.context.priceRange.current).replace(/[^0-9.]/g, '')) - 1) * 100).toFixed(2)}%</>
                                  )}
                                </div>
                              </div>
                            )}
                            {analysis.patterns.keyLevels.support?.[0] && (
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Nearest Support</div>
                                <div className="font-mono font-semibold text-green-400">{formatPrice(analysis.patterns.keyLevels.support[0].price)}</div>
                                <div className="text-xs text-slate-500 mt-1">
                                  {analysis.context.priceRange?.current && (
                                    <>Distance: {((1 - parseFloat(String(analysis.patterns.keyLevels.support[0].price).replace(/[^0-9.]/g, '')) / parseFloat(String(analysis.context.priceRange.current).replace(/[^0-9.]/g, ''))) * 100).toFixed(2)}%</>
                                  )}
                                </div>
                              </div>
                            )}
                            <div>
                              <div className="text-xs text-slate-500 mb-1">Trend Direction</div>
                              <div className={`font-semibold ${
                                analysis.patterns.trendAnalysis.trend === 'UPTREND' ? 'text-green-400' :
                                analysis.patterns.trendAnalysis.trend === 'DOWNTREND' ? 'text-red-400' :
                                'text-yellow-400'
                              }`}>{analysis.patterns.trendAnalysis.trend}</div>
                              <div className="text-xs text-slate-500 mt-1">Strength: {analysis.patterns.trendAnalysis.trendStrength}</div>
                            </div>
                            <div>
                              <div className="text-xs text-slate-500 mb-1">Market Phase</div>
                              <div className="font-semibold text-slate-300">
                                {analysis.patterns.trendAnalysis.trend === 'SIDEWAYS' ? 'Consolidation' :
                                 analysis.patterns.trendAnalysis.trendStrength === 'STRONG' ? 'Trending' :
                                 'Transitioning'}
                              </div>
                              <div className="text-xs text-slate-500 mt-1">
                                {analysis.patterns.trendAnalysis.trend === 'SIDEWAYS' ? 'Wait for breakout' :
                                 'Trade with trend'}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {analysisTab === "indicators" && (
                    <div className="space-y-4 md:space-y-6">
                      {analysis.indicators.indicatorScores && (
                        <div className="bg-violet-500/10 border border-violet-500/20 rounded-xl p-6">
                          <h4 className="font-semibold mb-4">Overall Indicator Score</h4>
                          <div className="grid grid-cols-3 gap-4 mb-4">
                            <div className="text-center">
                              <div className="text-3xl font-bold text-green-400">
                                {analysis.indicators.indicatorScores.bullishScore}
                              </div>
                              <div className="text-xs text-slate-500 mt-1">Bullish</div>
                            </div>
                            <div className="text-center">
                              <div className="text-3xl font-bold text-violet-400">
                                {analysis.indicators.indicatorScores.netScore}
                              </div>
                              <div className="text-xs text-slate-500 mt-1">Net Score</div>
                            </div>
                            <div className="text-center">
                              <div className="text-3xl font-bold text-red-400">
                                {analysis.indicators.indicatorScores.bearishScore}
                              </div>
                              <div className="text-xs text-slate-500 mt-1">Bearish</div>
                            </div>
                          </div>
                          <div className="text-center">
                            <span className={`inline-block px-4 py-2 rounded-lg font-semibold ${
                              analysis.indicators.indicatorScores.interpretation.includes("STRONG_BULLISH") ? "bg-emerald-500/20 text-emerald-300" :
                              analysis.indicators.indicatorScores.interpretation.includes("BULLISH") ? "bg-green-500/20 text-green-300" :
                              analysis.indicators.indicatorScores.interpretation.includes("STRONG_BEARISH") ? "bg-rose-500/20 text-rose-300" :
                              analysis.indicators.indicatorScores.interpretation.includes("BEARISH") ? "bg-red-500/20 text-red-300" :
                              "bg-yellow-500/20 text-yellow-300"
                            }`}>
                              {analysis.indicators.indicatorScores.interpretation.replace(/_/g, ' ')}
                            </span>
                          </div>
                        </div>
                      )}

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {analysis.indicators.rsi && analysis.indicators.rsi.value && analysis.indicators.rsi.value !== "NOT_VISIBLE" && (
                          <div className="bg-slate-800/30 rounded-lg p-5">
                            <h5 className="font-semibold mb-3 flex items-center gap-2">
                              <Activity className="w-5 h-5 text-violet-400" />
                              Relative Strength Index (RSI)
                            </h5>
                            <div className="text-4xl font-bold text-violet-400 mb-3">
                              {formatValue(analysis.indicators.rsi.value)}
                            </div>
                            <div className="w-full bg-slate-700 rounded-full h-3 mb-4 overflow-hidden">
                              <div 
                                className={`h-full transition-all ${
                                  analysis.indicators.rsi.value > 70 ? "bg-red-500" :
                                  analysis.indicators.rsi.value < 30 ? "bg-green-500" :
                                  "bg-yellow-500"
                                }`}
                                style={{ width: `${analysis.indicators.rsi.value}%` }}
                              />
                            </div>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className="text-slate-400">Market Condition:</span>
                                <span className={`font-semibold ${
                                  analysis.indicators.rsi.zone === "OVERBOUGHT" ? "text-red-400" :
                                  analysis.indicators.rsi.zone === "OVERSOLD" ? "text-green-400" :
                                  "text-yellow-400"
                                }`}>
                                  {formatValue(analysis.indicators.rsi.zone)}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Momentum Direction:</span>
                                <span className={`font-semibold ${getTrendColor(analysis.indicators.rsi.slope)}`}>
                                  {formatValue(analysis.indicators.rsi.slope)}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Price Divergence:</span>
                                <span className={`font-semibold ${
                                  analysis.indicators.rsi.divergence === "BULLISH" ? "text-green-400" :
                                  analysis.indicators.rsi.divergence === "BEARISH" ? "text-red-400" :
                                  "text-slate-400"
                                }`}>
                                  {formatValue(analysis.indicators.rsi.divergence)}
                                </span>
                              </div>
                            </div>
                          </div>
                        )}

                        {analysis.indicators.macd && (
                          <div className="bg-slate-800/30 rounded-lg p-5">
                            <h5 className="font-semibold mb-3">MACD</h5>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className="text-slate-400">Position:</span>
                                <span className={`font-semibold ${
                                  analysis.indicators.macd.position === "ABOVE_SIGNAL" ? "text-green-400" : "text-red-400"
                                }`}>
                                  {analysis.indicators.macd.position?.replace(/_/g, ' ')}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Crossover:</span>
                                <span className="font-semibold">{analysis.indicators.macd.crossover}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Histogram:</span>
                                <span className="font-semibold">{analysis.indicators.macd.histogram}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Signal:</span>
                                <span className={`font-semibold ${
                                  analysis.indicators.macd.signal === "BULLISH" ? "text-green-400" : "text-red-400"
                                }`}>
                                  {analysis.indicators.macd.signal}
                                </span>
                              </div>
                            </div>
                          </div>
                        )}

                        {analysis.indicators.movingAverages && analysis.indicators.movingAverages.length > 0 && (
                          <div className="bg-slate-800/30 rounded-lg p-5">
                            <h5 className="font-semibold mb-3">Moving Averages</h5>
                            <div className="space-y-2 md:space-y-3">
                              {analysis.indicators.movingAverages.map((ma, i) => (
                                <div key={i} className="text-sm">
                                  <div className="flex justify-between mb-1">
                                    <span className="text-slate-400">MA {ma.period}:</span>
                                    <span className={`font-semibold ${
                                      ma.position === "ABOVE_PRICE" ? "text-red-400" : "text-green-400"
                                    }`}>
                                      {ma.position?.replace(/_/g, ' ')}
                                    </span>
                                  </div>
                                  <div className="text-xs text-slate-500">Slope: {ma.slope}</div>
                                </div>
                              ))}
                              {analysis.indicators.maAlignment && (
                                <div className="pt-3 border-t border-slate-700">
                                  <div className="text-xs text-slate-400">Alignment:</div>
                                  <div className={`font-semibold ${
                                    analysis.indicators.maAlignment === "BULLISH_ALIGNED" ? "text-green-400" :
                                    analysis.indicators.maAlignment === "BEARISH_ALIGNED" ? "text-red-400" :
                                    "text-yellow-400"
                                  }`}>
                                    {analysis.indicators.maAlignment.replace(/_/g, ' ')}
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        )}

                        {analysis.indicators.volume && (
                          <div className="bg-slate-800/30 rounded-lg p-5">
                            <h5 className="font-semibold mb-3">Volume</h5>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className="text-slate-400">Trend:</span>
                                <span className={`font-semibold ${
                                  analysis.indicators.volume.trend === "INCREASING" ? "text-green-400" : "text-red-400"
                                }`}>
                                  {analysis.indicators.volume.trend}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Last Candle:</span>
                                <span className="font-semibold">{analysis.indicators.volume.lastCandleVolume}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Confirmation:</span>
                                <span className="font-semibold">{analysis.indicators.volume.confirmation?.replace(/_/g, ' ')}</span>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {analysisTab === "setups" && (() => {
                    // Derive setup data from multiple sources for resilience
                    const setup = analysis.tradeSetup || {};
                    const entry = setup.immediateEntry || {};
                    const final = analysis.final || {};
                    const rec = (final.recommendation || '').replace(/_/g, ' ');
                    const isBuy = rec.includes('BUY');
                    const isSell = rec.includes('SELL');
                    const hasDirection = setup.tradeDirection && setup.tradeDirection !== 'NEUTRAL';
                    const hasEntryData = entry.entry || entry.stop || entry.target1;
                    const hasAnySetup = hasDirection || hasEntryData || isBuy || isSell;

                    // Derive direction from recommendation if tradeDirection is NEUTRAL
                    const effectiveDirection = hasDirection ? setup.tradeDirection : isBuy ? 'LONG' : isSell ? 'SHORT' : 'NEUTRAL';
                    const isLong = effectiveDirection === 'LONG';

                    // Fallback entry price from context
                    const currentPrice = analysis.context?.currentPrice || entry.entry;
                    const entryPrice = entry.entry || currentPrice || 'N/A';
                    const stopPrice = entry.stop || 'N/A';
                    const target1 = entry.target1 || 'N/A';
                    const rrRatio = entry.riskRewardRatio || 'N/A';

                    // Parse entry/stop/target for order type calculations
                    const entryNum = parseFloat(entryPrice) || 0;
                    const stopNum = parseFloat(stopPrice) || 0;
                    const riskPerShare = entryNum && stopNum ? Math.abs(entryNum - stopNum) : 0;
                    const trailingPct = entryNum && riskPerShare ? ((riskPerShare / entryNum) * 100).toFixed(1) : '2.0';

                    // Order type definitions for the setups tab
                    const setupOrderTypes = [
                      { name: 'Market Order', rec: true, desc: `Execute immediately at ~$${entryNum ? entryNum.toFixed(2) : '—'}. Guaranteed fill, price may vary slightly.`, tip: 'Executes at the best available current price. Use when speed matters more than exact price.' },
                      { name: 'Limit Order', rec: true, desc: `Set limit at $${entryNum ? entryNum.toFixed(2) : '—'} to control your entry price. Only fills at your price or better.`, tip: 'Only fills at your specified price or better. Use for precise entries.' },
                      { name: 'Stop Loss', rec: true, desc: `Place at $${stopNum ? stopNum.toFixed(2) : '—'} to cap your downside risk.`, tip: 'Triggers a market sell when price hits your stop level. Essential for risk management.' },
                      { name: 'Stop Limit', rec: false, desc: `Stop at $${stopNum ? stopNum.toFixed(2) : '—'} with limit to avoid slippage on exit.`, tip: 'Like a stop loss but converts to a limit order. Avoids slippage but may not fill in fast moves.' },
                      { name: `Trailing Stop Loss ($)`, rec: false, desc: `Trail by $${riskPerShare ? riskPerShare.toFixed(2) : '—'} — locks in profits as price moves favorably.`, tip: 'A stop loss that moves up with the price by a fixed dollar amount. Great for riding trends.' },
                      { name: `Trailing Stop Loss (%)`, rec: false, desc: `Trail by ${trailingPct}% — adapts to price level automatically.`, tip: 'A stop loss that trails by a percentage. Adapts better to different price levels than fixed dollar.' },
                      { name: `Trailing Stop Limit ($)`, rec: false, desc: `Trail $${riskPerShare ? riskPerShare.toFixed(2) : '—'} with limit order protection.`, tip: 'Combines trailing stop with limit order. More control but risks not filling in fast markets.' },
                      { name: `Trailing Stop Limit (%)`, rec: false, desc: `Trail ${trailingPct}% with limit protection on exit.`, tip: 'Percentage-based trailing stop with limit order. Best of both worlds but may miss fast drops.' },
                    ];

                    return (
                    <div className="space-y-4 md:space-y-6">
                      {hasAnySetup ? (
                        <>
                          {/* Direction Banner */}
                          <div className={`rounded-xl p-4 flex items-center gap-3 ${isLong ? 'bg-emerald-500/10 border border-emerald-500/20' : 'bg-red-500/10 border border-red-500/20'}`}>
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-lg ${isLong ? 'bg-emerald-500/20' : 'bg-red-500/20'}`}>
                              {isLong ? '📈' : '📉'}
                            </div>
                            <div>
                              <div className={`font-bold text-lg ${isLong ? 'text-emerald-400' : 'text-red-400'}`}>
                                {effectiveDirection} — {isLong ? 'Buy Setup' : 'Sell/Short Setup'}
                              </div>
                              <div className="text-xs text-slate-400">
                                {setup.confidence ? `${setup.confidence} confidence` : ''}{setup.confidence && setup.timeHorizon ? ' · ' : ''}{setup.timeHorizon || ''}
                              </div>
                            </div>
                          </div>

                          {/* Entry/Exit Grid */}
                          <div className="bg-violet-500/10 border border-violet-500/20 rounded-xl p-6">
                            <h4 className="font-semibold mb-4 text-violet-300 flex items-center gap-2">
                              <Zap className="w-5 h-5" />
                              Entry & Exit Levels
                            </h4>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Entry Price</div>
                                <div className="font-bold text-lg text-violet-400">{entryPrice !== 'N/A' ? `$${parseFloat(entryPrice).toFixed(2)}` : 'Market'}</div>
                              </div>
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Stop Loss</div>
                                <div className="font-bold text-lg text-red-400">{stopPrice !== 'N/A' ? `$${parseFloat(stopPrice).toFixed(2)}` : '—'}</div>
                                {riskPerShare > 0 && <div className="text-[10px] text-red-400/60">Risk: ${riskPerShare.toFixed(2)}/share</div>}
                              </div>
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Target 1</div>
                                <div className="font-bold text-lg text-green-400">{target1 !== 'N/A' ? `$${parseFloat(target1).toFixed(2)}` : '—'}</div>
                              </div>
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Risk:Reward</div>
                                <div className={`font-bold text-lg ${(() => { const rr = parseFloat(rrRatio.split(':')[1]); return !isNaN(rr) && rr >= 2; })() ? 'text-emerald-400' : 'text-amber-400'}`}>{rrRatio}</div>
                              </div>
                            </div>
                            {/* Extra targets + details */}
                            <div className="mt-4 pt-4 border-t border-violet-500/20 grid grid-cols-2 md:grid-cols-4 gap-4">
                              {entry.target2 && (
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Target 2</div>
                                  <div className="font-semibold text-green-400">${parseFloat(entry.target2).toFixed(2)}</div>
                                </div>
                              )}
                              {entry.target3 && (
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Target 3</div>
                                  <div className="font-semibold text-green-400">${parseFloat(entry.target3).toFixed(2)}</div>
                                </div>
                              )}
                              {entry.winProbability && (
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Win Probability</div>
                                  <div className="font-semibold">{entry.winProbability}%</div>
                                </div>
                              )}
                              {entry.positionSize && entry.positionSize !== 'null' && (
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Position Size</div>
                                  <div className="font-semibold">{entry.positionSize}</div>
                                </div>
                              )}
                            </div>
                          </div>

                          {/* Pullback Entry */}
                          {setup.pullbackEntry && (
                            <div className="bg-blue-500/10 border border-blue-500/20 rounded-xl p-6">
                              <h4 className="font-semibold mb-4 text-blue-300 flex items-center gap-2">
                                <Target className="w-5 h-5" />
                                Pullback Entry (Better R:R)
                              </h4>
                              <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Entry Zone</div>
                                  <div className="font-semibold">{setup.pullbackEntry.entryZone}</div>
                                </div>
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Stop Loss</div>
                                  <div className="font-semibold text-red-400">{setup.pullbackEntry.stop}</div>
                                </div>
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">R:R Ratio</div>
                                  <div className="font-semibold text-emerald-400">{setup.pullbackEntry.riskRewardRatio}</div>
                                </div>
                              </div>
                              {setup.pullbackEntry.triggerCondition && (
                                <div className="mt-4 pt-4 border-t border-blue-500/20">
                                  <div className="text-xs text-slate-500 mb-1">Trigger Condition</div>
                                  <div className="text-sm">{setup.pullbackEntry.triggerCondition}</div>
                                </div>
                              )}
                            </div>
                          )}

                          {/* Recommended Order Types for this setup */}
                          <div className="bg-slate-800/30 border border-slate-700/20 rounded-xl p-6">
                            <h4 className="font-semibold mb-1 flex items-center gap-2">
                              <DollarSign className="w-5 h-5 text-violet-400" />
                              Brokerage Order Types
                            </h4>
                            <p className="text-xs text-slate-500 mb-4">How to execute this trade in your brokerage. Hover for details.</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                              {setupOrderTypes.map(ot => (
                                <div key={ot.name} className="group relative">
                                  <div className={`p-3 rounded-lg border transition-all ${ot.rec ? 'bg-violet-500/5 border-violet-500/20 hover:border-violet-500/40' : 'bg-slate-800/40 border-slate-700/20 hover:border-slate-600/40'}`}>
                                    <div className="flex items-center gap-2 mb-1">
                                      <span className="font-semibold text-sm text-white">{ot.name}</span>
                                      {ot.rec && <span className="text-[9px] font-bold bg-violet-500/30 text-violet-300 px-1.5 py-0.5 rounded">REC</span>}
                                    </div>
                                    <p className="text-[11px] text-slate-400 leading-relaxed">{ot.desc}</p>
                                  </div>
                                  {/* Tooltip */}
                                  <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none" style={{ zIndex: 9999 }}>
                                    <div className="font-semibold text-violet-300 mb-1">{ot.name}</div>
                                    <p>{ot.tip}</p>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Time in Force */}
                          <div className="bg-slate-800/30 border border-slate-700/20 rounded-xl p-6">
                            <h4 className="font-semibold mb-1 flex items-center gap-2">
                              <Clock className="w-5 h-5 text-cyan-400" />
                              Time in Force
                              <span className="group relative inline-flex">
                                <HelpCircle className="w-3.5 h-3.5 text-slate-500 cursor-help" />
                                <span className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-56 bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-xs text-slate-300 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all pointer-events-none" style={{ zIndex: 9999 }}>
                                  <span className="font-semibold text-cyan-400 block mb-1">Time in Force (TIF)</span>
                                  Tells your broker how long an order should remain active before it's automatically canceled. Choose based on your trading urgency and strategy.
                                </span>
                              </span>
                            </h4>
                            <p className="text-xs text-slate-500 mb-4">How long your order stays active. Hover for details.</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                              {[
                                { name: 'Day Order', rec: true, desc: 'Cancels at market close if not executed. Default at most brokers.', tip: 'Your order is only active for the current trading day. If not filled by 4:00 PM ET, it is automatically canceled. This is the default at most brokers and best for active day traders.' },
                                { name: 'Good \'til Canceled (GTC)', rec: true, desc: 'Stays active up to 180 days until filled or manually canceled.', tip: 'Your order stays active until it executes or you cancel it (most brokers auto-cancel after 60-180 days). Best for swing traders setting entries/exits at specific price levels.' },
                                { name: 'Fill or Kill (FOK)', rec: false, desc: 'Must fill completely and immediately, or cancels entirely.', tip: 'The entire order must be filled immediately in its entirety, or it is canceled completely. No partial fills allowed. Used for large orders where incomplete execution would be a problem.' },
                                { name: 'Immediate or Cancel (IOC)', rec: false, desc: 'Fills as many shares as possible, cancels the remainder.', tip: 'Fills as many shares as it can immediately, then cancels any unfilled portion. Unlike FOK, partial fills ARE allowed. Good when you want quick execution but can accept fewer shares than requested.' },
                                { name: 'On the Open (OPG)', rec: false, desc: 'Fills only at the opening price. Submit 4:15 PM - 9:28 AM ET.', tip: 'Your order executes only at the market opening price. Must be placed between 4:15 PM and 9:28 AM ET. Useful for reacting to overnight news with execution at the first available price.' },
                              ].map(tif => (
                                <div key={tif.name} className="group relative">
                                  <div className={`p-3 rounded-lg border transition-all ${tif.rec ? 'bg-cyan-500/5 border-cyan-500/20 hover:border-cyan-500/40' : 'bg-slate-800/40 border-slate-700/20 hover:border-slate-600/40'}`}>
                                    <div className="flex items-center gap-2 mb-1">
                                      <span className="font-semibold text-sm text-white">{tif.name}</span>
                                      {tif.rec && <span className="text-[9px] font-bold bg-cyan-500/30 text-cyan-300 px-1.5 py-0.5 rounded">REC</span>}
                                    </div>
                                    <p className="text-[11px] text-slate-400 leading-relaxed">{tif.desc}</p>
                                  </div>
                                  <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none" style={{ zIndex: 9999 }}>
                                    <div className="font-semibold text-cyan-300 mb-1">{tif.name}</div>
                                    <p>{tif.tip}</p>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Invalidation + Trade Info */}
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {setup.invalidation && (
                              <div className="bg-amber-500/10 border border-amber-500/20 rounded-lg p-5">
                                <h5 className="font-semibold mb-3 text-amber-400">Setup Invalidation</h5>
                                <div className="text-sm space-y-2">
                                  {setup.invalidation.longInvalidation && (
                                    <div>
                                      <span className="text-slate-400">Long invalid below:</span>
                                      <span className="ml-2 font-semibold">{setup.invalidation.longInvalidation}</span>
                                    </div>
                                  )}
                                  {setup.invalidation.shortInvalidation && (
                                    <div>
                                      <span className="text-slate-400">Short invalid above:</span>
                                      <span className="ml-2 font-semibold">{setup.invalidation.shortInvalidation}</span>
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                            <div className="bg-slate-800/30 rounded-lg p-5">
                              <h5 className="font-semibold mb-3">Trade Details</h5>
                              <div className="text-sm space-y-2">
                                <div className="flex justify-between">
                                  <span className="text-slate-400">Direction:</span>
                                  <span className={`font-semibold ${isLong ? 'text-green-400' : 'text-red-400'}`}>{effectiveDirection}</span>
                                </div>
                                {setup.timeHorizon && (
                                  <div className="flex justify-between">
                                    <span className="text-slate-400">Time Horizon:</span>
                                    <span className="font-semibold">{setup.timeHorizon}</span>
                                  </div>
                                )}
                                {setup.confidence && (
                                  <div className="flex justify-between">
                                    <span className="text-slate-400">Confidence:</span>
                                    <span className={`font-semibold ${setup.confidence === 'HIGH' ? 'text-green-400' : setup.confidence === 'MEDIUM' ? 'text-yellow-400' : 'text-red-400'}`}>{setup.confidence}</span>
                                  </div>
                                )}
                                <div className="flex justify-between">
                                  <span className="text-slate-400">Setup Grade:</span>
                                  <span className="font-semibold">{final.setupQuality || 'N/A'}</span>
                                </div>
                                <div className="flex justify-between">
                                  <span className="text-slate-400">Overall Score:</span>
                                  <span className="font-semibold">{final.confidenceScore ? `${Math.round(final.confidenceScore)}%` : 'N/A'}</span>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Key Factors */}
                          {(final.bullishFactors?.length > 0 || final.bearishFactors?.length > 0) && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              {final.bullishFactors?.length > 0 && (
                                <div className="bg-emerald-500/5 border border-emerald-500/20 rounded-lg p-4">
                                  <h5 className="font-semibold text-emerald-400 mb-2 text-sm">Bullish Factors</h5>
                                  <div className="space-y-1">
                                    {final.bullishFactors.slice(0, 5).map((f, i) => (
                                      <div key={i} className="text-xs text-slate-300 flex items-start gap-2">
                                        <span className="text-emerald-400 mt-0.5">+</span> {typeof f === 'string' ? f : f.factor || f.description || JSON.stringify(f)}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}
                              {final.bearishFactors?.length > 0 && (
                                <div className="bg-red-500/5 border border-red-500/20 rounded-lg p-4">
                                  <h5 className="font-semibold text-red-400 mb-2 text-sm">Bearish Factors</h5>
                                  <div className="space-y-1">
                                    {final.bearishFactors.slice(0, 5).map((f, i) => (
                                      <div key={i} className="text-xs text-slate-300 flex items-start gap-2">
                                        <span className="text-red-400 mt-0.5">−</span> {typeof f === 'string' ? f : f.factor || f.description || JSON.stringify(f)}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </div>
                          )}
                        </>
                      ) : (
                        <div className="text-center py-12">
                          <AlertTriangle className="w-16 h-16 text-yellow-500 mx-auto mb-4" />
                          <h3 className="text-xl font-semibold mb-2">No Clear Setup</h3>
                          <p className="text-slate-400 max-w-md mx-auto mb-4">
                            The analysis shows a NEUTRAL stance — no high-probability trade setup was identified. Consider waiting for clearer signals or checking a different timeframe.
                          </p>
                          {final.summary && (
                            <div className="bg-slate-800/30 rounded-lg p-4 max-w-lg mx-auto text-left">
                              <div className="text-xs text-slate-500 mb-1">Analysis Summary</div>
                              <p className="text-sm text-slate-300">{final.summary}</p>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    );
                  })()}

                  {analysisTab === "predictions" && analysis.recommendations && (
                    <div className="space-y-4 md:space-y-6">
                      {/* Price Predictions */}
                      <div>
                        <h4 className="font-semibold mb-4 flex items-center gap-2">
                          <TrendingUp className="w-5 h-5 text-violet-400" />
                          Price Predictions
                        </h4>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                          {/* Next Key Level */}
                          <div className="bg-gradient-to-br from-violet-500/10 to-purple-500/10 border border-violet-500/20 rounded-xl p-5">
                            <div className="text-xs text-slate-500 mb-2">Next Key Level</div>
                            <div className="text-2xl font-bold text-violet-400 mb-2">
                              {formatPrice(analysis.recommendations.pricePredictions?.nextKeyLevel?.price)}
                            </div>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className="text-slate-400">Direction:</span>
                                <span className={`font-semibold ${
                                  analysis.recommendations.pricePredictions?.nextKeyLevel?.direction === "ABOVE" 
                                    ? "text-green-400" : "text-red-400"
                                }`}>
                                  {formatValue(analysis.recommendations.pricePredictions?.nextKeyLevel?.direction)}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Probability:</span>
                                <span className="font-semibold">{formatPercentage(analysis.recommendations.pricePredictions?.nextKeyLevel?.probability)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Timeframe:</span>
                                <span className="font-semibold">{formatValue(analysis.recommendations.pricePredictions?.nextKeyLevel?.timeframe)}</span>
                              </div>
                              <div className="mt-2 pt-2 border-t border-violet-500/20">
                                <span className={`inline-block px-2 py-1 rounded text-xs font-semibold ${
                                  analysis.recommendations.pricePredictions?.nextKeyLevel?.type === "Resistance"
                                    ? "bg-red-500/20 text-red-300"
                                    : "bg-green-500/20 text-green-300"
                                }`}>
                                  {formatValue(analysis.recommendations.pricePredictions?.nextKeyLevel?.type)}
                                </span>
                              </div>
                            </div>
                          </div>

                          {/* Short Term */}
                          <div className="bg-slate-800/30 rounded-xl p-5">
                            <div className="text-xs text-slate-500 mb-2">Short-Term Target</div>
                            <div className="text-2xl font-bold text-emerald-400 mb-2">
                              {formatPrice(analysis.recommendations.pricePredictions?.shortTerm?.targetPrice)}
                            </div>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className="text-slate-400">Timeframe:</span>
                                <span className="font-semibold">{formatValue(analysis.recommendations.pricePredictions?.shortTerm?.timeframe)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Confidence:</span>
                                <span className="font-semibold">{formatPercentage(analysis.recommendations.pricePredictions?.shortTerm?.confidence)}</span>
                              </div>
                              <div className="mt-2 pt-2 border-t border-slate-700">
                                <div className="text-xs text-slate-500 mb-1">Key Trigger:</div>
                                <div className="text-xs">{formatValue(analysis.recommendations.pricePredictions?.shortTerm?.keyTrigger)}</div>
                              </div>
                            </div>
                          </div>

                          {/* Medium Term */}
                          <div className="bg-slate-800/30 rounded-xl p-5">
                            <div className="text-xs text-slate-500 mb-2">Medium-Term Target</div>
                            <div className="text-2xl font-bold text-blue-400 mb-2">
                              {formatPrice(analysis.recommendations.pricePredictions?.mediumTerm?.targetPrice)}
                            </div>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className="text-slate-400">Timeframe:</span>
                                <span className="font-semibold">{formatValue(analysis.recommendations.pricePredictions?.mediumTerm?.timeframe)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Confidence:</span>
                                <span className="font-semibold">{formatPercentage(analysis.recommendations.pricePredictions?.mediumTerm?.confidence)}</span>
                              </div>
                              <div className="mt-2 pt-2 border-t border-slate-700">
                                <div className="text-xs text-slate-500 mb-1">Key Trigger:</div>
                                <div className="text-xs">{formatValue(analysis.recommendations.pricePredictions?.mediumTerm?.keyTrigger)}</div>
                              </div>
                            </div>
                          </div>

                          {/* Long Term */}
                          <div className="bg-slate-800/30 rounded-xl p-5">
                            <div className="text-xs text-slate-500 mb-2">Long-Term Target</div>
                            <div className="text-2xl font-bold text-purple-400 mb-2">
                              {formatPrice(analysis.recommendations.pricePredictions?.longTerm?.targetPrice)}
                            </div>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className="text-slate-400">Timeframe:</span>
                                <span className="font-semibold">{formatValue(analysis.recommendations.pricePredictions?.longTerm?.timeframe)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-400">Confidence:</span>
                                <span className="font-semibold">{formatPercentage(analysis.recommendations.pricePredictions?.longTerm?.confidence)}</span>
                              </div>
                              <div className="mt-2 pt-2 border-t border-slate-700">
                                <div className="text-xs text-slate-500 mb-1">Key Trigger:</div>
                                <div className="text-xs">{formatValue(analysis.recommendations.pricePredictions?.longTerm?.keyTrigger)}</div>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Expected Volatility */}
                        {analysis.recommendations.pricePredictions?.expectedVolatility && (
                          <div className="bg-amber-500/10 border border-amber-500/20 rounded-xl p-5">
                            <h5 className="font-semibold mb-3 text-amber-300">Expected Volatility</h5>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Volatility Level</div>
                                <span className={`inline-block px-3 py-1 rounded-lg font-semibold ${
                                  analysis.recommendations.pricePredictions.expectedVolatility.level?.includes("High") ||
                                  analysis.recommendations.pricePredictions.expectedVolatility.level?.includes("Extreme")
                                    ? "bg-red-500/20 text-red-300"
                                    : analysis.recommendations.pricePredictions.expectedVolatility.level?.includes("Moderate")
                                    ? "bg-yellow-500/20 text-yellow-300"
                                    : "bg-green-500/20 text-green-300"
                                }`}>
                                  {formatValue(analysis.recommendations.pricePredictions.expectedVolatility.level)}
                                </span>
                              </div>
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Expected Range</div>
                                <div className="font-semibold">{formatValue(analysis.recommendations.pricePredictions.expectedVolatility.priceRange)}</div>
                              </div>
                              <div className="md:col-span-1">
                                <div className="text-xs text-slate-500 mb-1">Reasoning</div>
                                <div className="text-sm">{formatValue(analysis.recommendations.pricePredictions.expectedVolatility.reasoning)}</div>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>

                      {/* Scenario Analysis */}
                      <div>
                        <h4 className="font-semibold mb-4 flex items-center gap-2">
                          <Activity className="w-5 h-5 text-violet-400" />
                          Scenario Analysis
                        </h4>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                          {/* Bullish Scenario */}
                          <div className="bg-emerald-500/5 border border-emerald-500/20 rounded-xl p-5">
                            <div className="flex items-center justify-between mb-4">
                              <h5 className="font-semibold text-emerald-400">Bullish Scenario</h5>
                              <ArrowUpRight className="w-5 h-5 text-emerald-400" />
                            </div>
                            <div className="space-y-3 text-sm">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Trigger Price</div>
                                <div className="font-bold text-lg text-emerald-400">
                                  {formatPrice(analysis.recommendations.scenarioAnalysis?.bullishScenario?.trigger)}
                                </div>
                              </div>
                              <div className="grid grid-cols-2 gap-3">
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Target 1</div>
                                  <div className="font-semibold">{formatPrice(analysis.recommendations.scenarioAnalysis?.bullishScenario?.firstTarget)}</div>
                                </div>
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Target 2</div>
                                  <div className="font-semibold">{formatPrice(analysis.recommendations.scenarioAnalysis?.bullishScenario?.secondTarget)}</div>
                                </div>
                              </div>
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Final Target</div>
                                <div className="font-semibold text-emerald-400">{formatPrice(analysis.recommendations.scenarioAnalysis?.bullishScenario?.finalTarget)}</div>
                              </div>
                              <div className="pt-3 border-t border-emerald-500/20">
                                <div className="flex justify-between mb-2">
                                  <span className="text-slate-400">Probability:</span>
                                  <span className="font-semibold">{formatPercentage(analysis.recommendations.scenarioAnalysis?.bullishScenario?.probability)}</span>
                                </div>
                                <div className="flex justify-between">
                                  <span className="text-slate-400">Timeframe:</span>
                                  <span className="font-semibold">{formatValue(analysis.recommendations.scenarioAnalysis?.bullishScenario?.timeframe)}</span>
                                </div>
                              </div>
                              <div className="pt-3 border-t border-emerald-500/20">
                                <div className="text-xs text-slate-500 mb-2">Required Conditions:</div>
                                <ul className="space-y-1">
                                  {formatArray(analysis.recommendations.scenarioAnalysis?.bullishScenario?.requiredConditions).map((cond, i) => (
                                    <li key={i} className="flex items-start gap-2">
                                      <Check className="w-3 h-3 text-emerald-400 mt-0.5 flex-shrink-0" />
                                      <span className="text-xs">{cond}</span>
                                    </li>
                                  ))}
                                </ul>
                              </div>
                              <div className="pt-3 border-t border-emerald-500/20">
                                <div className="text-xs text-slate-500 mb-1">Invalidation Level</div>
                                <div className="font-semibold text-red-400">{formatPrice(analysis.recommendations.scenarioAnalysis?.bullishScenario?.invalidation)}</div>
                              </div>
                            </div>
                          </div>

                          {/* Bearish Scenario */}
                          <div className="bg-red-500/5 border border-red-500/20 rounded-xl p-5">
                            <div className="flex items-center justify-between mb-4">
                              <h5 className="font-semibold text-red-400">Bearish Scenario</h5>
                              <ArrowDownRight className="w-5 h-5 text-red-400" />
                            </div>
                            <div className="space-y-3 text-sm">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Trigger Price</div>
                                <div className="font-bold text-lg text-red-400">
                                  {formatPrice(analysis.recommendations.scenarioAnalysis?.bearishScenario?.trigger)}
                                </div>
                              </div>
                              <div className="grid grid-cols-2 gap-3">
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Target 1</div>
                                  <div className="font-semibold">{formatPrice(analysis.recommendations.scenarioAnalysis?.bearishScenario?.firstTarget)}</div>
                                </div>
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Target 2</div>
                                  <div className="font-semibold">{formatPrice(analysis.recommendations.scenarioAnalysis?.bearishScenario?.secondTarget)}</div>
                                </div>
                              </div>
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Final Target</div>
                                <div className="font-semibold text-red-400">{formatPrice(analysis.recommendations.scenarioAnalysis?.bearishScenario?.finalTarget)}</div>
                              </div>
                              <div className="pt-3 border-t border-red-500/20">
                                <div className="flex justify-between mb-2">
                                  <span className="text-slate-400">Probability:</span>
                                  <span className="font-semibold">{formatPercentage(analysis.recommendations.scenarioAnalysis?.bearishScenario?.probability)}</span>
                                </div>
                                <div className="flex justify-between">
                                  <span className="text-slate-400">Timeframe:</span>
                                  <span className="font-semibold">{formatValue(analysis.recommendations.scenarioAnalysis?.bearishScenario?.timeframe)}</span>
                                </div>
                              </div>
                              <div className="pt-3 border-t border-red-500/20">
                                <div className="text-xs text-slate-500 mb-2">Required Conditions:</div>
                                <ul className="space-y-1">
                                  {formatArray(analysis.recommendations.scenarioAnalysis?.bearishScenario?.requiredConditions).map((cond, i) => (
                                    <li key={i} className="flex items-start gap-2">
                                      <X className="w-3 h-3 text-red-400 mt-0.5 flex-shrink-0" />
                                      <span className="text-xs">{cond}</span>
                                    </li>
                                  ))}
                                </ul>
                              </div>
                              <div className="pt-3 border-t border-red-500/20">
                                <div className="text-xs text-slate-500 mb-1">Invalidation Level</div>
                                <div className="font-semibold text-green-400">{formatPrice(analysis.recommendations.scenarioAnalysis?.bearishScenario?.invalidation)}</div>
                              </div>
                            </div>
                          </div>

                          {/* Neutral Scenario */}
                          <div className="bg-yellow-500/5 border border-yellow-500/20 rounded-xl p-5">
                            <div className="flex items-center justify-between mb-4">
                              <h5 className="font-semibold text-yellow-400">Neutral Scenario</h5>
                              <Minus className="w-5 h-5 text-yellow-400" />
                            </div>
                            <div className="space-y-3 text-sm">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Range High</div>
                                <div className="font-bold text-lg text-yellow-400">
                                  {formatPrice(analysis.recommendations.scenarioAnalysis?.neutralScenario?.rangeHigh)}
                                </div>
                              </div>
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Range Low</div>
                                <div className="font-bold text-lg text-yellow-400">
                                  {formatPrice(analysis.recommendations.scenarioAnalysis?.neutralScenario?.rangeLow)}
                                </div>
                              </div>
                              <div className="pt-3 border-t border-yellow-500/20">
                                <div className="flex justify-between mb-2">
                                  <span className="text-slate-400">Duration:</span>
                                  <span className="font-semibold">{formatValue(analysis.recommendations.scenarioAnalysis?.neutralScenario?.expectedDuration)}</span>
                                </div>
                                <div className="flex justify-between">
                                  <span className="text-slate-400">Probability:</span>
                                  <span className="font-semibold">{formatPercentage(analysis.recommendations.scenarioAnalysis?.neutralScenario?.probability)}</span>
                                </div>
                              </div>
                              <div className="pt-3 border-t border-yellow-500/20">
                                <div className="text-xs text-slate-500 mb-1">Trading Strategy</div>
                                <div className="text-xs">{formatValue(analysis.recommendations.scenarioAnalysis?.neutralScenario?.tradingStrategy)}</div>
                              </div>
                              <div className="pt-3 border-t border-yellow-500/20">
                                <div className="text-xs text-slate-500 mb-1">Expected Breakout Direction</div>
                                <div className={`font-semibold ${
                                  analysis.recommendations.scenarioAnalysis?.neutralScenario?.breakoutDirection?.toUpperCase().includes("UP")
                                    ? "text-green-400"
                                    : analysis.recommendations.scenarioAnalysis?.neutralScenario?.breakoutDirection?.toUpperCase().includes("DOWN")
                                    ? "text-red-400"
                                    : "text-slate-300"
                                }`}>
                                  {formatValue(analysis.recommendations.scenarioAnalysis?.neutralScenario?.breakoutDirection)}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Action Plan */}
                      {analysis.recommendations.actionPlan && (
                        <div className="bg-violet-500/10 border border-violet-500/20 rounded-xl p-6">
                          <h4 className="font-semibold mb-4 text-violet-300 flex items-center gap-2">
                            <Target className="w-5 h-5" />
                            Action Plan
                          </h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                              <div className="text-xs text-slate-500 mb-2">Immediate Action</div>
                              <p className="text-sm font-medium">{formatValue(analysis.recommendations.actionPlan.immediateAction)}</p>
                            </div>
                            <div>
                              <div className="text-xs text-slate-500 mb-2">Waiting For</div>
                              <p className="text-sm font-medium">{formatValue(analysis.recommendations.actionPlan.waitingFor)}</p>
                            </div>
                            <div>
                              <div className="text-xs text-slate-500 mb-2">Plan B (If Primary Fails)</div>
                              <p className="text-sm font-medium">{formatValue(analysis.recommendations.actionPlan.planB)}</p>
                            </div>
                            <div>
                              <div className="text-xs text-slate-500 mb-2">Exit Strategy</div>
                              <p className="text-sm font-medium">{formatValue(analysis.recommendations.actionPlan.exitStrategy)}</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  )}

                  {analysisTab === "recommendations" && analysis.recommendations && (
                    <div className="space-y-4 md:space-y-6">
                      {/* Current Indicator Assessment */}
                      <div className="bg-slate-800/30 rounded-xl p-6">
                        <h4 className="font-semibold mb-4 flex items-center gap-2">
                          <BarChart3 className="w-5 h-5 text-violet-400" />
                          Current Indicator Setup
                        </h4>
                        <div className="space-y-3 md:space-y-4">
                          <div>
                            <div className="text-xs text-slate-500 mb-2">Present Indicators</div>
                            <div className="flex flex-wrap gap-2">
                              {formatArray(analysis.recommendations.currentIndicatorAssessment?.presentIndicators).map((indicator, i) => (
                                <span key={i} className="px-3 py-1.5 bg-emerald-600/20 text-emerald-300 rounded-lg text-sm font-medium">
                                  {indicator}
                                </span>
                              ))}
                            </div>
                          </div>
                          <div>
                            <div className="text-xs text-slate-500 mb-2">Coverage Analysis</div>
                            <p className="text-sm">{formatValue(analysis.recommendations.currentIndicatorAssessment?.coverageAnalysis)}</p>
                          </div>
                          {analysis.recommendations.currentIndicatorAssessment?.gaps && 
                           analysis.recommendations.currentIndicatorAssessment.gaps.length > 0 && (
                            <div>
                              <div className="text-xs text-slate-500 mb-2">Identified Gaps</div>
                              <ul className="space-y-2">
                                {formatArray(analysis.recommendations.currentIndicatorAssessment.gaps).map((gap, i) => (
                                  <li key={i} className="flex items-start gap-2 text-sm">
                                    <AlertTriangle className="w-4 h-4 text-amber-400 mt-0.5 flex-shrink-0" />
                                    <span>{gap}</span>
                                  </li>
                                ))}
                              </ul>
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Recommended Indicators */}
                      <div>
                        <h4 className="font-semibold mb-4 flex items-center gap-2">
                          <Sparkles className="w-5 h-5 text-violet-400" />
                          Recommended Indicators to Add
                        </h4>
                        <div className="space-y-3 md:space-y-4">
                          {analysis.recommendations.indicatorRecommendations?.map((rec, i) => (
                            <div key={i} className={`rounded-xl p-5 border ${
                              rec.priority === "Essential" 
                                ? "bg-violet-500/10 border-violet-500/30"
                                : rec.priority === "Highly Recommended"
                                ? "bg-blue-500/10 border-blue-500/30"
                                : "bg-slate-800/30 border-slate-700/50"
                            }`}>
                              <div className="flex items-start justify-between mb-3">
                                <div className="flex-1">
                                  <div className="flex items-center gap-3 mb-2">
                                    <h5 className="font-bold text-lg">{formatValue(rec.indicator)}</h5>
                                    <span className={`px-2.5 py-1 rounded-lg text-xs font-semibold ${
                                      rec.priority === "Essential"
                                        ? "bg-violet-600/30 text-violet-200"
                                        : rec.priority === "Highly Recommended"
                                        ? "bg-blue-600/30 text-blue-200"
                                        : "bg-slate-700 text-slate-300"
                                    }`}>
                                      {formatValue(rec.priority)}
                                    </span>
                                    <span className="px-2.5 py-1 bg-slate-700 rounded-lg text-xs font-semibold text-slate-300">
                                      {formatValue(rec.category)}
                                    </span>
                                  </div>
                                  <p className="text-sm text-slate-300 mb-3">{formatValue(rec.reasoning)}</p>
                                </div>
                              </div>
                              
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-3 border-t border-slate-700/50">
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Expected Benefit</div>
                                  <p className="text-sm font-medium">{formatValue(rec.expectedBenefit)}</p>
                                </div>
                                <div>
                                  <div className="text-xs text-slate-500 mb-1">Recommended Settings</div>
                                  <p className="text-sm font-mono font-medium text-violet-400">{formatValue(rec.settings)}</p>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}

                  {analysisTab === "qa" && (
                    <div className="space-y-4 md:space-y-6">
                      <div className="flex items-center gap-3 mb-2">
                        <div className="p-2 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl">
                          <MessageCircle className="w-5 h-5 text-white" />
                        </div>
                        <div>
                          <h4 className="font-semibold text-lg">Ask About This Chart</h4>
                          <p className="text-sm text-slate-400">Ask follow-up questions about your chart analysis</p>
                        </div>
                      </div>

                      <div className="mb-4">
                        <textarea
                          value={chartQuestion}
                          onChange={(e) => setChartQuestion(e.target.value)}
                          placeholder="e.g., Why is the stop loss set at that level? What if price breaks above resistance? Is the RSI divergence significant here?"
                          className="w-full bg-slate-800/40 border border-slate-700/30 rounded-xl hover-lift px-4 py-4 min-h-[120px] text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/50 resize-none placeholder:text-slate-500"
                          maxLength={500}
                        />
                        <div className="flex items-center justify-between mt-3">
                          <span className="text-xs text-slate-500">{chartQuestion.length}/500</span>
                          <button
                            onClick={askChartQuestion}
                            disabled={loadingChartAnswer || chartQuestion.length < 5}
                            className="px-6 py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 text-white rounded-xl font-semibold disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed flex items-center gap-2 shadow-lg"
                          >
                            {loadingChartAnswer ? (
                              <><Loader2 className="w-4 h-4 animate-spin" />Thinking...</>
                            ) : (
                              <><Send className="w-4 h-4" />Ask Question</>
                            )}
                          </button>
                        </div>
                      </div>

                      {/* Error State */}
                      {analysisError && analysisError.includes('Chart Q&A') && (
                        <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-4">
                          <div className="flex items-start gap-3">
                            <AlertTriangle className="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" />
                            <div>
                              <p className="font-medium text-red-300">Unable to get AI response</p>
                              <p className="text-xs text-slate-400 mt-1">{analysisError}</p>
                              <button onClick={() => setAnalysisError(null)} className="mt-2 text-xs text-red-400 hover:text-red-300">Dismiss</button>
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Loading State */}
                      {loadingChartAnswer && (
                        <div className="bg-violet-500/10 border border-violet-500/30 rounded-xl p-4">
                          <div className="flex items-center gap-3">
                            <div className="relative">
                              <Loader2 className="w-8 h-8 animate-spin text-violet-400" />
                              <div className="absolute inset-0 w-8 h-8 border-2 border-violet-500/20 rounded-full animate-ping" />
                            </div>
                            <div>
                              <p className="font-medium text-violet-300">AI is analyzing your chart question...</p>
                              <p className="text-xs text-slate-400 mt-1">Using the uploaded chart and analysis context for an accurate answer</p>
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Answer Display - Matches Ask AI style */}
                      {chartAnswer && (
                        <div className="bg-gradient-to-br from-violet-500/10 to-purple-500/5 border border-violet-500/20 rounded-xl overflow-hidden">
                          <div className="bg-violet-600/20 px-6 py-3 border-b border-violet-500/20">
                            <h5 className="font-semibold flex items-center gap-2 text-violet-200">
                              <Sparkles className="w-5 h-5 text-violet-400" />
                              AI Response
                            </h5>
                          </div>
                          <div className="p-6">
                            <div className="space-y-3 md:space-y-4">
                              {chartAnswer.split('\n\n').map((block, blockIdx) => {
                                const formatInline = (text) => text.split(/(\*\*[^*]+\*\*)/).map((part, i) => {
                                  if (part.startsWith('**') && part.endsWith('**')) {
                                    return <strong key={i} className="text-white font-semibold">{part.replace(/\*\*/g, '')}</strong>;
                                  }
                                  return part;
                                });
                                if (block.match(/^#{1,3}\s+/)) {
                                  return <h3 key={blockIdx} className="text-lg font-bold text-white flex items-center gap-2 mt-3"><div className="w-1 h-5 bg-violet-500 rounded-full" />{block.replace(/^#{1,3}\s+/, '').replace(/\*\*/g, '')}</h3>;
                                }
                                if (block.startsWith('**') && block.endsWith('**') && !block.slice(2, -2).includes('**')) {
                                  return <h3 key={blockIdx} className="text-lg font-bold text-white flex items-center gap-2 mt-2"><div className="w-1 h-5 bg-violet-500 rounded-full" />{block.replace(/\*\*/g, '')}</h3>;
                                }
                                const hasListItems = block.includes('\n•') || block.includes('\n-') || block.startsWith('•') || block.startsWith('-') || /\n\d+[\.\)]\s/.test(block) || /^\d+[\.\)]\s/.test(block);
                                if (hasListItems) {
                                  const lines = block.split('\n');
                                  return (
                                    <div key={blockIdx} className="space-y-2">
                                      {lines.map((line, lineIdx) => {
                                        const trimmed = line.trim();
                                        if (trimmed.startsWith('•') || trimmed.startsWith('-')) {
                                          return <div key={lineIdx} className="flex items-start gap-3 pl-2"><div className="w-1.5 h-1.5 rounded-full bg-violet-400 mt-2 flex-shrink-0" /><span className="text-slate-300 text-sm leading-relaxed">{formatInline(trimmed.replace(/^[•-]\s*/, ''))}</span></div>;
                                        }
                                        const numMatch = trimmed.match(/^(\d+)[\.\)]\s+(.*)/);
                                        if (numMatch) {
                                          return <div key={lineIdx} className="flex items-start gap-3 pl-2"><span className="text-xs font-bold text-violet-400 bg-violet-500/15 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">{numMatch[1]}</span><span className="text-slate-300 text-sm leading-relaxed">{formatInline(numMatch[2])}</span></div>;
                                        }
                                        if (trimmed) return <p key={lineIdx} className="text-slate-200 font-medium">{formatInline(trimmed)}</p>;
                                        return null;
                                      })}
                                    </div>
                                  );
                                }
                                return <p key={blockIdx} className="text-slate-300 text-sm leading-relaxed">{formatInline(block)}</p>;
                              })}
                            </div>
                          </div>
                          <div className="bg-slate-800/30 px-6 py-3 border-t border-violet-500/10 flex items-center justify-between">
                            <span className="text-xs text-slate-500">Based on your uploaded chart analysis</span>
                            <button onClick={() => setChartAnswer(null)} className="text-xs text-slate-400 hover:text-slate-200 transition-colors">Clear</button>
                          </div>
                        </div>
                      )}

                      {/* Previous Questions History */}
                      {chartQaHistory.length > 0 && (
                        <div>
                          <h5 className="font-semibold mb-4 text-slate-400">Previous Questions</h5>
                          <div className="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                            {chartQaHistory.slice().reverse().map((item, i) => (
                              <div key={i} className="bg-slate-800/30 rounded-xl p-4 hover:bg-slate-800/50 transition-colors">
                                <p className="font-medium text-slate-200 mb-2">{item.q}</p>
                                <p className="text-xs text-slate-400 line-clamp-3">{(item.a || '').replace(/\*\*/g, '').replace(/#{1,3}\s+/g, '').replace(/[•●]\s*/g, '').slice(0, 200)}...</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Empty State */}
                      {!chartAnswer && !loadingChartAnswer && chartQaHistory.length === 0 && (
                        <div className="text-center py-8">
                          <MessageCircle className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                          <h3 className="text-lg font-semibold mb-2">Ask Anything About This Chart</h3>
                          <p className="text-slate-400 max-w-md mx-auto mb-4 text-sm">
                            The AI has full context from your chart analysis. Ask about patterns, setups, risk levels, or anything else you see.
                          </p>
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 max-w-lg mx-auto text-left">
                            {["Why is the stop loss at that level?", "What confirms the trend direction?", "Is the RSI divergence significant?", "What's the best entry timing?"].map((q, i) => (
                              <button
                                key={i}
                                onClick={() => setChartQuestion(q)}
                                className="bg-slate-800/30 rounded-lg p-3 text-left hover:bg-slate-800/60 transition-colors"
                              >
                                <p className="text-xs text-slate-400">{q}</p>
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Daily Pick Tab */}

        {/* NEW: Alerts Tab */}
        {activeTab === "alerts" && (
          <div className="space-y-4 md:space-y-6">
            <div className="bg-slate-900/50 rounded-xl md:rounded-2xl border border-slate-800/50 p-4 md:p-6">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 md:mb-6 gap-3 sm:gap-0">
                <h2 className="text-xl md:text-2xl font-bold flex items-center gap-3">
                  <Bell className="w-6 md:w-7 h-6 md:h-7 text-violet-400" />
                  <span>Price Alerts</span>
                </h2>
                <div className="flex flex-col sm:flex-row gap-2 md:gap-3 w-full sm:w-auto">
                  {/* Notification Permission Status */}
                  <div className={`px-4 py-2 rounded-lg border ${
                    typeof Notification !== 'undefined' && Notification.permission === 'granted'
                      ? 'bg-green-900/20 border-green-600/30 text-green-400'
                      : 'bg-yellow-900/20 border-yellow-600/30 text-yellow-400'
                  }`}>
                    <div className="text-xs font-semibold">
                      {typeof Notification !== 'undefined' && Notification.permission === 'granted' ? '✓ Notifications ON' : '⚠️ Enable Notifications'}
                    </div>
                  </div>
                  
                  {/* Test Alerts Button */}
                  <button
                    onClick={() => {
                      console.log('=== MANUAL ALERT TEST ===');
                      console.log('Watchlist prices:', watchlistPrices);
                      console.log('Total alerts:', alerts.length);
                      console.log('Enabled alerts:', enabledAlertCount);
                      
                      if (Object.keys(watchlistPrices).length > 0) {
                        checkAllAlertsAgainstPrices(watchlistPrices);
                        alert(`Checked ${enabledAlertCount} enabled alerts against ${Object.keys(watchlistPrices).length} monitored prices`);
                      } else {
                        alert('No prices available yet. Add stocks to watchlist or create alerts first!');
                      }
                    }}
                    className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold transition-colors flex items-center gap-2"
                  >
                    <AlertCircle className="w-4 h-4" />
                    <span>Test Alerts Now</span>
                  </button>
                  
                  <button
                    onClick={() => setShowCreateAlert(true)}
                    className="px-4 py-2 bg-violet-600 hover:bg-violet-500 text-white rounded-lg font-semibold transition-colors flex items-center gap-2"
                  >
                    <Bell className="w-4 h-4" />
                    <span>Create Alert</span>
                  </button>
                </div>
              </div>

              <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-3 md:p-4 mb-4 md:mb-6">
                <div className="flex items-start gap-3">
                  <AlertCircle className="w-5 h-5 text-emerald-400 flex-shrink-0 mt-0.5" />
                  <div className="text-sm text-emerald-200">
                    <p className="font-semibold mb-1">🔔 Background Monitoring Active:</p>
                    <ul className="list-disc list-inside space-y-1 text-emerald-300">
                      <li><strong>Auto-Check:</strong> All alerts checked every 10 seconds in background</li>
                      <li><strong>Any Symbol:</strong> Alerts work for ANY stock, not just current ticker</li>
                      <li><strong>Smart Ringing:</strong> Only rings when price CROSSES threshold (not continuous)</li>
                      <li><strong>Triple Beep:</strong> 3 rapid beeps when alert triggers (1 second apart)</li>
                      <li><strong>Re-triggers:</strong> Alert fires again when price crosses threshold again</li>
                    </ul>
                    <p className="mt-2 text-emerald-400">
                      Monitoring: <strong>{Object.keys(watchlistPrices).length}</strong> symbols | 
                      Active alerts: <strong>{enabledAlertCount}</strong>
                    </p>
                  </div>
                </div>
              </div>
              
              {/* Alert History Button */}
              {alertHistory.length > 0 && (
                <div className="mb-4 md:mb-6">
                  <button
                    onClick={() => setShowAlertHistory(true)}
                    className="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-semibold transition-colors flex items-center gap-2"
                  >
                    <Calendar className="w-4 h-4" />
                    <span>Alert History ({alertHistory.length} triggered)</span>
                  </button>
                </div>
              )}

              {alerts.length === 0 ? (
                <div className="text-center py-12">
                  <BellOff className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                  <p className="text-slate-400 text-lg">No alerts created yet</p>
                  <p className="text-slate-500 text-sm mt-2">Click "Create Alert" to get started</p>
                </div>
              ) : (
                <div className="space-y-2 md:space-y-3">
                  {alerts.map(alert => (
                    <div key={alert.id} className={`bg-slate-800/30 rounded-lg p-3 md:p-4 card-shine ${!alert.enabled ? 'opacity-50' : ''} ${alert.triggered ? 'border border-yellow-500/30' : ''}`}>
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <span className="font-bold text-lg">{alert.symbol}</span>
                            <span className="px-2 py-0.5 bg-violet-600/20 text-violet-300 rounded text-xs font-semibold">
                              {alert.condition.replace('_', ' ').toUpperCase()}
                            </span>
                            <span className="font-mono text-lg">${alert.price}</span>
                            {alertRingCounts[alert.id] > 0 && (
                              <span className="px-2 py-0.5 bg-orange-600/20 text-orange-400 rounded text-xs font-semibold">
                                🔔 {alertRingCounts[alert.id]}x
                              </span>
                            )}
                            {alert.triggered && (
                              <span className="px-2 py-0.5 bg-yellow-600/20 text-yellow-400 rounded text-xs font-semibold">
                                ✓ TRIGGERED
                              </span>
                            )}
                          </div>
                          {alert.message && (
                            <p className="text-sm text-slate-400">{alert.message}</p>
                          )}
                          {/* Show current price from watchlist */}
                          {watchlistPrices[alert.symbol] && (
                            <p className="text-xs text-slate-500 mt-1">
                              Current: ${watchlistPrices[alert.symbol].current?.toFixed(2) || '---'}
                            </p>
                          )}
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => toggleAlert(alert.id)}
                            className={`p-2 rounded-lg transition-colors ${
                              alert.enabled
                                ? 'bg-green-600/20 text-green-400 hover:bg-green-600/30'
                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600'
                            }`}
                            title={alert.enabled ? 'Disable' : 'Enable (resets ring count)'}
                          >
                            {alert.enabled ? <Bell className="w-5 h-5" /> : <BellOff className="w-5 h-5" />}
                          </button>
                          <button
                            onClick={() => deleteAlert(alert.id)}
                            className="p-2 bg-red-600/20 text-red-400 hover:bg-red-600/30 rounded-lg transition-colors"
                            title="Delete"
                          >
                            <X className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* NEW: Multi-Timeframe Analysis Tab */}
        {activeTab === "multiframe" && (
          <div className="space-y-4 md:space-y-6">
            {!image && (
              <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                <div className="flex items-start gap-3">
                  <AlertTriangle className="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5" />
                  <div className="text-sm text-yellow-200">
                    <p className="font-semibold mb-1">No Chart Uploaded</p>
                    <p className="text-yellow-300">Please upload a chart in the "Chart Analysis" tab first.</p>
                  </div>
                </div>
              </div>
            )}

            {image && (
              <div className="bg-slate-900/50 rounded-2xl border border-slate-800/50 p-6">
                <h2 className="text-2xl font-bold mb-4 flex items-center gap-3">
                  <Layers className="w-7 h-7 text-violet-400" />
                  <span>Multi-Timeframe Analysis</span>
                </h2>

                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-6">
                  <div className="flex items-start gap-3">
                    <AlertCircle className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
                    <div className="text-sm text-blue-200">
                      <p className="font-semibold mb-1">Multi-Timeframe Analysis:</p>
                      <p className="text-blue-300">Select multiple timeframes to analyze the same chart. The AI will identify if trends and signals align across timeframes for stronger confirmation.</p>
                    </div>
                  </div>
                </div>

                <div className="mb-6">
                  <label className="block text-sm font-semibold mb-3">Select Timeframes (up to 4):</label>
                  <div className="flex flex-wrap gap-2">
                    {['5M', '15M', '30M', '1H', '4H', '1D', '1W', '1M'].map(tf => (
                      <button
                        key={tf}
                        onClick={() => {
                          if (selectedTimeframes.includes(tf)) {
                            setSelectedTimeframes(selectedTimeframes.filter(t => t !== tf));
                          } else if (selectedTimeframes.length < 4) {
                            setSelectedTimeframes([...selectedTimeframes, tf]);
                          }
                        }}
                        className={`px-4 py-2 rounded-lg font-semibold transition-colors ${
                          selectedTimeframes.includes(tf)
                            ? 'bg-violet-600 text-white'
                            : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                        }`}
                      >
                        {tf}
                      </button>
                    ))}
                  </div>
                  <p className="text-xs text-slate-500 mt-2">Selected: {selectedTimeframes.join(', ')}</p>
                </div>

                <button
                  onClick={analyzeMultiTimeframe}
                  disabled={loadingMultiTimeframe || selectedTimeframes.length === 0}
                  className="w-full bg-violet-600 hover:bg-violet-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded-lg py-3 font-semibold transition-colors flex items-center justify-center gap-2 mb-6"
                >
                  {loadingMultiTimeframe ? (
                    <>
                      <Loader2 className="w-5 h-5 animate-spin" />
                      <span>Analyzing {selectedTimeframes.length} Timeframes...</span>
                    </>
                  ) : (
                    <>
                      <Layers className="w-5 h-5" />
                      <span>Analyze {selectedTimeframes.length} Timeframes</span>
                    </>
                  )}
                </button>

                {multiTimeframeAnalysis && (
                  <div className="space-y-3 md:space-y-4">
                    <div className={`bg-gradient-to-r ${
                      multiTimeframeAnalysis.alignment.strength === 'STRONG' ? 'from-green-900/30 to-green-800/20 border-green-500/50' :
                      multiTimeframeAnalysis.alignment.strength === 'MODERATE' ? 'from-yellow-900/30 to-yellow-800/20 border-yellow-500/50' :
                      'from-red-900/30 to-red-800/20 border-red-500/50'
                    } border rounded-lg p-5`}>
                      <div className="flex items-center justify-between mb-3">
                        <h3 className="text-xl font-bold">Alignment Status</h3>
                        <span className={`px-3 py-1 rounded-lg font-bold ${
                          multiTimeframeAnalysis.alignment.strength === 'STRONG' ? 'bg-green-600 text-white' :
                          multiTimeframeAnalysis.alignment.strength === 'MODERATE' ? 'bg-yellow-600 text-white' :
                          'bg-red-600 text-white'
                        }`}>
                          {multiTimeframeAnalysis.alignment.strength}
                        </span>
                      </div>
                      <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <span className="text-slate-400">Trend Alignment:</span>
                          <span className={`ml-2 font-semibold ${multiTimeframeAnalysis.alignment.trend ? 'text-green-400' : 'text-red-400'}`}>
                            {multiTimeframeAnalysis.alignment.trend ? 'ALIGNED ✓' : 'CONFLICTING ✗'}
                          </span>
                        </div>
                        <div>
                          <span className="text-slate-400">Recommendation Alignment:</span>
                          <span className={`ml-2 font-semibold ${multiTimeframeAnalysis.alignment.recommendation ? 'text-green-400' : 'text-red-400'}`}>
                            {multiTimeframeAnalysis.alignment.recommendation ? 'ALIGNED ✓' : 'CONFLICTING ✗'}
                          </span>
                        </div>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {Object.entries(multiTimeframeAnalysis.analyses).map(([tf, analysis]) => (
                        <div key={tf} className="bg-slate-800/30 rounded-lg p-4">
                          <div className="flex items-center justify-between mb-3">
                            <h4 className="font-bold text-lg">{tf}</h4>
                            <span className={`px-2 py-1 rounded text-xs font-semibold ${
                              analysis.trend === 'UPTREND' ? 'bg-green-600/20 text-green-300' :
                              analysis.trend === 'DOWNTREND' ? 'bg-red-600/20 text-red-300' :
                              'bg-yellow-600/20 text-yellow-300'
                            }`}>
                              {analysis.trend}
                            </span>
                          </div>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-slate-400">Strength:</span>
                              <span className="font-semibold">{analysis.strength}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-slate-400">Recommendation:</span>
                              <span className={`font-semibold ${
                                analysis.recommendation === 'BUY' ? 'text-green-400' :
                                analysis.recommendation === 'SELL' ? 'text-red-400' :
                                'text-yellow-400'
                              }`}>
                                {analysis.recommendation}
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-slate-400">Confidence:</span>
                              <span className="font-semibold">{analysis.confidence}%</span>
                            </div>
                            <div className="pt-2 border-t border-slate-700">
                              <span className="text-slate-400 text-xs">Key Level:</span>
                              <p className="text-sm mt-1">{analysis.keyLevel}</p>
                            </div>
                            <div className="pt-2 border-t border-slate-700">
                              <span className="text-slate-400 text-xs">Reasoning:</span>
                              <p className="text-sm mt-1">{analysis.reasoning}</p>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        )}
        
        {/* ============================================ */}
        {/* OPTIONS TRADING TAB */}
        {/* ============================================ */}
        {activeTab === "options" && (
          <div className="space-y-4 md:space-y-6">
            <div className="bg-slate-900/50 rounded-xl md:rounded-2xl border border-slate-800/50 p-4 md:p-6">
              <div className="flex items-center justify-between mb-3 md:mb-6">
                <div className="flex items-center gap-3">
                  <TrendingUp className="w-7 h-7 text-violet-400" />
                  <div>
                    <h2 className="text-xl md:text-2xl font-bold">Options Trading Platform</h2>
                    <p className="text-sm text-slate-500">Calculate strategies, Greeks, and P/L</p>
                  </div>
                </div>
              </div>
              
              {/* Strategy Selector */}
              <div className="mb-3 md:mb-6">
                <label className="block text-sm font-semibold mb-3">Select Strategy:</label>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-2">
                  {[
                    { id: 'covered_call', name: 'Covered Call', icon: '📈' },
                    { id: 'protective_put', name: 'Protective Put', icon: '🛡️' },
                    { id: 'bull_call_spread', name: 'Bull Call Spread', icon: '🐂' },
                    { id: 'bear_put_spread', name: 'Bear Put Spread', icon: '🐻' },
                    { id: 'iron_condor', name: 'Iron Condor', icon: '🦅' }
                  ].map(strategy => (
                    <button
                      key={strategy.id}
                      onClick={() => setSelectedStrategy(strategy.id)}
                      className={`px-4 py-3 rounded-lg font-semibold transition-all flex flex-col items-center gap-1 ${
                        selectedStrategy === strategy.id
                          ? 'bg-violet-600 text-white scale-105 shadow-lg'
                          : 'bg-slate-800 text-slate-300 hover:bg-slate-700'
                      }`}
                    >
                      <span className="text-2xl">{strategy.icon}</span>
                      <span className="text-xs text-center">{strategy.name}</span>
                    </button>
                  ))}
                </div>
              </div>
              
              {/* Strategy Inputs */}
              <div className="bg-slate-800/50 rounded-lg p-4 md:p-6 mb-3 md:mb-6">
                <h3 className="text-base md:text-lg font-semibold mb-3 md:mb-4 flex items-center gap-2">
                  <DollarSign className="w-5 h-5 text-emerald-400" />
                  Strategy Parameters
                </h3>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-xs text-slate-400 mb-2">Underlying Price ($)</label>
                    <input
                      type="number"
                      value={underlyingPrice}
                      onChange={(e) => setUnderlyingPrice(e.target.value)}
                      placeholder="e.g., 150"
                      className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                    />
                  </div>
                  
                  {selectedStrategy === 'covered_call' && (
                    <>
                      <div>
                        <label className="block text-xs text-slate-400 mb-2">Call Strike ($)</label>
                        <input
                          type="number"
                          value={callStrike}
                          onChange={(e) => setCallStrike(e.target.value)}
                          placeholder="e.g., 155"
                          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-slate-400 mb-2">Premium Received ($)</label>
                        <input
                          type="number"
                          value={callPremium}
                          onChange={(e) => setCallPremium(e.target.value)}
                          placeholder="e.g., 3.50"
                          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                      </div>
                    </>
                  )}
                  
                  {selectedStrategy === 'protective_put' && (
                    <>
                      <div>
                        <label className="block text-xs text-slate-400 mb-2">Put Strike ($)</label>
                        <input
                          type="number"
                          value={putStrike}
                          onChange={(e) => setPutStrike(e.target.value)}
                          placeholder="e.g., 145"
                          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-slate-400 mb-2">Premium Paid ($)</label>
                        <input
                          type="number"
                          value={putPremium}
                          onChange={(e) => setPutPremium(e.target.value)}
                          placeholder="e.g., 2.50"
                          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                      </div>
                    </>
                  )}
                  
                  {(selectedStrategy === 'bull_call_spread' || selectedStrategy === 'bear_put_spread') && (
                    <>
                      <div>
                        <label className="block text-xs text-slate-400 mb-2">Long Strike ($)</label>
                        <input
                          type="number"
                          value={longStrike}
                          onChange={(e) => setLongStrike(e.target.value)}
                          placeholder="e.g., 150"
                          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-slate-400 mb-2">Short Strike ($)</label>
                        <input
                          type="number"
                          value={shortStrike}
                          onChange={(e) => setShortStrike(e.target.value)}
                          placeholder="e.g., 155"
                          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-slate-400 mb-2">Net Debit ($)</label>
                        <input
                          type="number"
                          value={netDebit}
                          onChange={(e) => setNetDebit(e.target.value)}
                          placeholder="e.g., 2.00"
                          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                      </div>
                    </>
                  )}
                  
                  {selectedStrategy === 'iron_condor' && (
                    <>
                      <div>
                        <label className="block text-xs text-slate-400 mb-2">Spread Width ($)</label>
                        <input
                          type="number"
                          value={spreadWidth}
                          onChange={(e) => setSpreadWidth(e.target.value)}
                          placeholder="e.g., 5"
                          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-slate-400 mb-2">Net Credit ($)</label>
                        <input
                          type="number"
                          value={netCredit}
                          onChange={(e) => setNetCredit(e.target.value)}
                          placeholder="e.g., 1.50"
                          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                      </div>
                    </>
                  )}
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                  <div>
                    <label className="block text-xs text-slate-400 mb-2">Days to Expiration</label>
                    <input
                      type="number"
                      value={daysToExpiration}
                      onChange={(e) => setDaysToExpiration(parseInt(e.target.value))}
                      placeholder="e.g., 30"
                      className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-slate-400 mb-2">Implied Volatility (%)</label>
                    <input
                      type="number"
                      value={impliedVolatility}
                      onChange={(e) => setImpliedVolatility(parseInt(e.target.value))}
                      placeholder="e.g., 30"
                      className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-slate-400 mb-2">Position Size (contracts)</label>
                    <input
                      type="number"
                      value={positionSize}
                      onChange={(e) => setPositionSize(parseInt(e.target.value))}
                      placeholder="e.g., 1"
                      className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                    />
                  </div>
                </div>
              </div>
              
              {/* Quick Results Dashboard - LIVE CALCULATIONS */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4 mb-3 md:mb-6">
                <div className="bg-gradient-to-br from-emerald-600/20 to-emerald-800/10 border border-emerald-500/30 rounded-lg p-3 md:p-4">
                  <div className="text-xs text-emerald-400 mb-1">Max Profit</div>
                  <div className="text-xl md:text-2xl font-bold text-white">
                    {typeof calculatedResults.maxProfit === 'number' 
                      ? `$${Math.round(calculatedResults.maxProfit)}` 
                      : calculatedResults.maxProfit || 'Enter parameters'}
                  </div>
                  <div className="text-xs text-emerald-300 mt-1">
                    {calculatedResults.maxProfit > 0 ? 'Per contract (100 shares)' : ''}
                  </div>
                </div>
                <div className="bg-gradient-to-br from-red-600/20 to-red-800/10 border border-red-500/30 rounded-lg p-4">
                  <div className="text-xs text-red-400 mb-1">Max Loss</div>
                  <div className="text-2xl font-bold text-white">
                    {typeof calculatedResults.maxLoss === 'number'
                      ? `$${Math.round(calculatedResults.maxLoss)}`
                      : calculatedResults.maxLoss || 'Enter parameters'}
                  </div>
                  <div className="text-xs text-red-300 mt-1">
                    {calculatedResults.maxLoss < 0 ? 'Limited risk' : ''}
                  </div>
                </div>
                <div className="bg-gradient-to-br from-violet-600/20 to-violet-800/10 border border-violet-500/30 rounded-lg p-4">
                  <div className="text-xs text-violet-400 mb-1">Breakeven</div>
                  <div className="text-2xl font-bold text-white">
                    {typeof calculatedResults.breakeven === 'number'
                      ? `$${(calculatedResults.breakeven || 0).toFixed(2)}`
                      : calculatedResults.breakeven || 'Enter parameters'}
                  </div>
                  <div className="text-xs text-violet-300 mt-1">
                    {underlyingPrice && calculatedResults.breakeven 
                      ? `${((((calculatedResults.breakeven || 0) - parseFloat(underlyingPrice)) / parseFloat(underlyingPrice) * 100) || 0).toFixed(1)}% from current`
                      : ''}
                  </div>
                </div>
                <div className="bg-gradient-to-br from-blue-600/20 to-blue-800/10 border border-blue-500/30 rounded-lg p-4">
                  <div className="text-xs text-blue-400 mb-1">Win Probability</div>
                  <div className="text-2xl font-bold text-white">
                    {calculatedResults.winProbability > 0 
                      ? `${Math.round(calculatedResults.winProbability)}%`
                      : 'Enter parameters'}
                  </div>
                  <div className="text-xs text-blue-300 mt-1">Based on Black-Scholes</div>
                </div>
              </div>
              
              {/* Greeks Display - LIVE VALUES */}
              <div className="bg-slate-800/50 rounded-lg p-6 mb-6">
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <Activity className="w-5 h-5 text-blue-400" />
                  Position Greeks {underlyingPrice && (callStrike || putStrike || longStrike) ? '(Live)' : '(Enter parameters)'}
                </h3>
                
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                  <div className="text-center group relative">
                    <div className={`text-3xl font-bold ${liveGreeks.delta >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                      {liveGreeks.delta !== 0 ? (liveGreeks.delta > 0 ? '+' : '') + (liveGreeks.delta || 0).toFixed(2) : '--'}
                    </div>
                    <div className="flex items-center justify-center gap-1 text-xs text-slate-400 mt-1">
                      <span>Delta</span>
                      <HelpCircle className="w-3 h-3 text-slate-500 cursor-help" />
                    </div>
                    <div className="text-xs text-slate-500">Price sensitivity</div>
                    <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block w-56 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-xl z-50">
                      <div className="font-semibold text-emerald-400 mb-1">Delta (Δ)</div>
                      <p>Measures how much option price changes for every $1 move in underlying. Delta of 0.50 means option moves $0.50 for every $1 in stock.</p>
                    </div>
                  </div>
                  <div className="text-center group relative">
                    <div className={`text-3xl font-bold ${liveGreeks.gamma >= 0 ? 'text-blue-400' : 'text-orange-400'}`}>
                      {liveGreeks.gamma !== 0 ? (liveGreeks.gamma > 0 ? '+' : '') + (liveGreeks.gamma || 0).toFixed(3) : '--'}
                    </div>
                    <div className="flex items-center justify-center gap-1 text-xs text-slate-400 mt-1">
                      <span>Gamma</span>
                      <HelpCircle className="w-3 h-3 text-slate-500 cursor-help" />
                    </div>
                    <div className="text-xs text-slate-500">Delta change rate</div>
                    <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block w-56 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-xl z-50">
                      <div className="font-semibold text-blue-400 mb-1">Gamma (Γ)</div>
                      <p>Measures rate of change in Delta. High gamma means Delta changes quickly as stock price moves. Important for risk management.</p>
                    </div>
                  </div>
                  <div className="text-center group relative">
                    <div className={`text-3xl font-bold ${liveGreeks.theta <= 0 ? 'text-red-400' : 'text-emerald-400'}`}>
                      {liveGreeks.theta !== 0 ? (liveGreeks.theta || 0).toFixed(2) : '--'}
                    </div>
                    <div className="flex items-center justify-center gap-1 text-xs text-slate-400 mt-1">
                      <span>Theta</span>
                      <HelpCircle className="w-3 h-3 text-slate-500 cursor-help" />
                    </div>
                    <div className="text-xs text-slate-500">Daily decay</div>
                    <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block w-56 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-xl z-50">
                      <div className="font-semibold text-red-400 mb-1">Theta (Θ)</div>
                      <p>Time decay - how much option loses in value each day, all else equal. Negative theta means option loses value as expiration approaches.</p>
                    </div>
                  </div>
                  <div className="text-center group relative">
                    <div className={`text-3xl font-bold ${liveGreeks.vega >= 0 ? 'text-violet-400' : 'text-pink-400'}`}>
                      {liveGreeks.vega !== 0 ? (liveGreeks.vega > 0 ? '+' : '') + (liveGreeks.vega || 0).toFixed(2) : '--'}
                    </div>
                    <div className="flex items-center justify-center gap-1 text-xs text-slate-400 mt-1">
                      <span>Vega</span>
                      <HelpCircle className="w-3 h-3 text-slate-500 cursor-help" />
                    </div>
                    <div className="text-xs text-slate-500">IV sensitivity</div>
                    <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block w-56 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-xl z-50">
                      <div className="font-semibold text-violet-400 mb-1">Vega (ν)</div>
                      <p>Measures sensitivity to volatility changes. Vega of 0.15 means option price changes $0.15 for every 1% change in implied volatility.</p>
                    </div>
                  </div>
                  <div className="text-center group relative">
                    <div className={`text-3xl font-bold ${liveGreeks.rho >= 0 ? 'text-yellow-400' : 'text-orange-400'}`}>
                      {liveGreeks.rho !== 0 ? (liveGreeks.rho > 0 ? '+' : '') + (liveGreeks.rho || 0).toFixed(2) : '--'}
                    </div>
                    <div className="flex items-center justify-center gap-1 text-xs text-slate-400 mt-1">
                      <span>Rho</span>
                      <HelpCircle className="w-3 h-3 text-slate-500 cursor-help" />
                    </div>
                    <div className="text-xs text-slate-500">Rate sensitivity</div>
                    <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block w-56 bg-slate-800 border border-slate-600 rounded-lg p-3 text-xs text-slate-300 shadow-xl z-50">
                      <div className="font-semibold text-yellow-400 mb-1">Rho (ρ)</div>
                      <p>Measures sensitivity to interest rate changes. Rho of 0.02 means option price changes $0.02 for every 1% change in risk-free rate.</p>
                    </div>
                  </div>
                </div>
                
                {/* Explanation */}
                {liveGreeks.delta !== 0 && (
                  <div className="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded text-xs text-blue-200">
                    <p><strong>Reading the Greeks:</strong></p>
                    <p className="mt-1">• Delta {(liveGreeks.delta || 0).toFixed(2)}: Position moves ${Math.abs(liveGreeks.delta * 100).toFixed(0)} for every $1 move in underlying</p>
                    <p>• Theta {(liveGreeks.theta || 0).toFixed(2)}: Losing ${Math.abs(liveGreeks.theta * 100).toFixed(2)} per day from time decay</p>
                    <p>• Vega {(liveGreeks.vega || 0).toFixed(2)}: Position gains ${(liveGreeks.vega * 100).toFixed(0)} if IV increases 1%</p>
                  </div>
                )}
              </div>
              
              {/* Strategy Description */}
              <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                <div className="flex items-start gap-3">
                  <AlertCircle className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
                  <div className="text-sm text-blue-200">
                    <p className="font-semibold mb-2">
                      {selectedStrategy === 'covered_call' && 'Covered Call Strategy:'}
                      {selectedStrategy === 'protective_put' && 'Protective Put Strategy:'}
                      {selectedStrategy === 'bull_call_spread' && 'Bull Call Spread Strategy:'}
                      {selectedStrategy === 'bear_put_spread' && 'Bear Put Spread Strategy:'}
                      {selectedStrategy === 'iron_condor' && 'Iron Condor Strategy:'}
                    </p>
                    <p className="text-blue-300">
                      {selectedStrategy === 'covered_call' && 'Own 100 shares + sell 1 call. Generates income from premium. Max profit is capped at strike price. Best for neutral to slightly bullish outlook.'}
                      {selectedStrategy === 'protective_put' && 'Own 100 shares + buy 1 put. Protects against downside. Acts as insurance. Cost is the premium paid. Best for protecting gains during uncertainty.'}
                      {selectedStrategy === 'bull_call_spread' && 'Buy lower strike call + sell higher strike call. Limited risk and reward. Cheaper than buying calls outright. Best for moderately bullish outlook.'}
                      {selectedStrategy === 'bear_put_spread' && 'Buy higher strike put + sell lower strike put. Limited risk and reward. Cheaper than buying puts outright. Best for moderately bearish outlook.'}
                      {selectedStrategy === 'iron_condor' && 'Sell OTM put spread + sell OTM call spread. Profits from low volatility. Max profit is net credit. Best for range-bound markets with stable prices.'}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
        
        {activeTab === "daily" && (
          <div className="space-y-4 md:space-y-6">
            <div className="bg-slate-900/50 rounded-xl md:rounded-2xl border border-slate-800/50 p-4 md:p-6">
              <div className="flex items-center justify-between mb-3 md:mb-6">
                <div className="flex items-center gap-3 md:gap-4">
                  <div className="p-3 md:p-3.5 bg-gradient-to-br from-amber-500 via-orange-500 to-red-600 rounded-xl md:rounded-2xl shadow-lg shadow-orange-500/30 flex-shrink-0">
                    <Star className="w-6 h-6 md:w-7 md:h-7 text-white" />
                  </div>
                  <div className="flex-1">
                    <h2 className="text-xl md:text-2xl font-bold bg-gradient-to-r from-amber-400 to-orange-400 bg-clip-text text-transparent">Today's Top Trade</h2>
                    <p className="text-xs md:text-sm text-slate-400 mt-0.5">AI-selected high-probability setup</p>
                  </div>
                </div>

                <div className="flex gap-3">
                  <select
                    value={pickAssetClass}
                    onChange={(e) => {
                      setPickAssetClass(e.target.value);
                      setDailyPick(null);
                    }}
                    className="bg-slate-800/50 border border-slate-700/50 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500/50"
                  >
                    <option value="all">All Assets</option>
                    <option value="stocks">Stocks Only</option>
                    <option value="crypto">Crypto Only</option>
                    <option value="forex">Forex Only</option>
                    <option value="commodities">Commodities Only</option>
                  </select>
                </div>
              </div>
              
              {/* Timeframe Selector */}
              <div className="mb-3 md:mb-6">
                <div className="text-sm text-slate-400 mb-3 flex items-center gap-2">
                  <Clock className="w-4 h-4" />
                  <span>Select Holding Period:</span>
                </div>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-2 md:gap-3">
                  {/* Short Timeframes */}
                  <button
                    onClick={() => setPickTimeframe("5-7h")}
                    className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                      pickTimeframe === "5-7h"
                        ? "bg-blue-600 text-white border-2 border-blue-400"
                        : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-blue-500/50"
                    }`}
                  >
                    <div className="text-xs opacity-70">Short</div>
                    <div>5-7 Hours</div>
                  </button>
                  <button
                    onClick={() => setPickTimeframe("12-24h")}
                    className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                      pickTimeframe === "12-24h"
                        ? "bg-blue-600 text-white border-2 border-blue-400"
                        : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-blue-500/50"
                    }`}
                  >
                    <div className="text-xs opacity-70">Short</div>
                    <div>12-24 Hours</div>
                  </button>
                  <button
                    onClick={() => setPickTimeframe("24-48h")}
                    className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                      pickTimeframe === "24-48h"
                        ? "bg-violet-600 text-white border-2 border-violet-400"
                        : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-violet-500/50"
                    }`}
                  >
                    <div className="text-xs opacity-70">Swing</div>
                    <div>24-48 Hours</div>
                  </button>
                  {/* Medium Timeframes */}
                  <button
                    onClick={() => setPickTimeframe("3-5d")}
                    className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                      pickTimeframe === "3-5d"
                        ? "bg-emerald-600 text-white border-2 border-emerald-400"
                        : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-emerald-500/50"
                    }`}
                  >
                    <div className="text-xs opacity-70">Medium</div>
                    <div>3-5 Days</div>
                  </button>
                  <button
                    onClick={() => setPickTimeframe("5-7d")}
                    className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                      pickTimeframe === "5-7d"
                        ? "bg-emerald-600 text-white border-2 border-emerald-400"
                        : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-emerald-500/50"
                    }`}
                  >
                    <div className="text-xs opacity-70">Medium</div>
                    <div>5-7 Days</div>
                  </button>
                  {/* Long Timeframes */}
                  <button
                    onClick={() => setPickTimeframe("1-2w")}
                    className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                      pickTimeframe === "1-2w"
                        ? "bg-amber-600 text-white border-2 border-amber-400"
                        : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-amber-500/50"
                    }`}
                  >
                    <div className="text-xs opacity-70">Long</div>
                    <div>1-2 Weeks</div>
                  </button>
                  <button
                    onClick={() => setPickTimeframe("3-4w")}
                    className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                      pickTimeframe === "3-4w"
                        ? "bg-amber-600 text-white border-2 border-amber-400"
                        : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-amber-500/50"
                    }`}
                  >
                    <div className="text-xs opacity-70">Long</div>
                    <div>3-4 Weeks</div>
                  </button>
                </div>
                <div className="mt-2 text-xs text-slate-500">
                  {pickTimeframe === "5-7h" && "⚡ Intraday trade within market hours (-1% stop). Best for active day traders."}
                  {pickTimeframe === "12-24h" && "🌙 Overnight hold with moderate risk (-1.5%). Good for end-of-day entries."}
                  {pickTimeframe === "24-48h" && "📊 Standard swing setup (-2% stop). Balanced risk/reward."}
                  {pickTimeframe === "3-5d" && "📈 Multi-day swing with room to breathe (-3% stop). For patient traders."}
                  {pickTimeframe === "5-7d" && "🎯 Extended swing for larger moves (-4% stop). Requires conviction."}
                  {pickTimeframe === "1-2w" && "🏔️ Position trade for trend following (-5% stop). For high-conviction setups."}
                  {pickTimeframe === "3-4w" && "🌟 Extended position for major moves only (-7% stop). Maximum patience required."}
                </div>
              </div>

              {/* Volatility Selector - 5 Levels + Any */}
              <div className="mb-3 md:mb-6">
                <div className="text-sm text-slate-400 mb-3 flex items-center gap-2">
                  <Activity className="w-4 h-4" />
                  <span>Select Risk/Volatility Level:</span>
                </div>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2">
                  {/* Low Volatility */}
                  <div
                    className="relative"
                    onMouseEnter={() => setActiveTooltip('vol-low')}
                    onMouseLeave={() => setActiveTooltip(null)}
                  >
                    <button
                      onClick={() => setPickVolatility("low")}
                      className={`w-full px-2 py-2 rounded-lg text-sm font-medium transition-all ${
                        pickVolatility === "low"
                          ? "bg-cyan-600 text-white border-2 border-cyan-400"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-cyan-500/50"
                      }`}
                    >
                      <div className="text-lg">🐢</div>
                      <div className="text-xs">Low</div>
                    </button>
                    {activeTooltip === 'vol-low' && (
                      <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-48 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                        <div className="font-semibold mb-1 text-cyan-400">🐢 Low Volatility</div>
                        <p>Very stable stocks (utilities, consumer staples). Slow but steady. Best for conservative traders.</p>
                      </div>
                    )}
                  </div>
                  {/* Low-Medium Volatility */}
                  <div
                    className="relative"
                    onMouseEnter={() => setActiveTooltip('vol-lowmed')}
                    onMouseLeave={() => setActiveTooltip(null)}
                  >
                    <button
                      onClick={() => setPickVolatility("lowmed")}
                      className={`w-full px-2 py-2 rounded-lg text-sm font-medium transition-all ${
                        pickVolatility === "lowmed"
                          ? "bg-blue-600 text-white border-2 border-blue-400"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-blue-500/50"
                      }`}
                    >
                      <div className="text-lg">🏛️</div>
                      <div className="text-xs">Low-Med</div>
                    </button>
                    {activeTooltip === 'vol-lowmed' && (
                      <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-48 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                        <div className="font-semibold mb-1 text-blue-400">🏛️ Low-Medium Volatility</div>
                        <p>Established companies (AAPL, HD, JPM). Reliable with moderate price movements.</p>
                      </div>
                    )}
                  </div>
                  {/* Medium Volatility */}
                  <div
                    className="relative"
                    onMouseEnter={() => setActiveTooltip('vol-medium')}
                    onMouseLeave={() => setActiveTooltip(null)}
                  >
                    <button
                      onClick={() => setPickVolatility("medium")}
                      className={`w-full px-2 py-2 rounded-lg text-sm font-medium transition-all ${
                        pickVolatility === "medium"
                          ? "bg-violet-600 text-white border-2 border-violet-400"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-violet-500/50"
                      }`}
                    >
                      <div className="text-lg">⚖️</div>
                      <div className="text-xs">Medium</div>
                    </button>
                    {activeTooltip === 'vol-medium' && (
                      <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-48 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                        <div className="font-semibold mb-1 text-violet-400">⚖️ Medium Volatility</div>
                        <p>Balanced risk/reward. Most tech stocks fall here. Good for swing traders.</p>
                      </div>
                    )}
                  </div>
                  {/* Medium-High Volatility */}
                  <div
                    className="relative"
                    onMouseEnter={() => setActiveTooltip('vol-medhigh')}
                    onMouseLeave={() => setActiveTooltip(null)}
                  >
                    <button
                      onClick={() => setPickVolatility("medhigh")}
                      className={`w-full px-2 py-2 rounded-lg text-sm font-medium transition-all ${
                        pickVolatility === "medhigh"
                          ? "bg-amber-600 text-white border-2 border-amber-400"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-amber-500/50"
                      }`}
                    >
                      <div className="text-lg">📈</div>
                      <div className="text-xs">Med-High</div>
                    </button>
                    {activeTooltip === 'vol-medhigh' && (
                      <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-48 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                        <div className="font-semibold mb-1 text-amber-400">📈 Medium-High Volatility</div>
                        <p>Growth stocks, volatile tech (AMD, TSLA). Larger moves, more risk but more reward.</p>
                      </div>
                    )}
                  </div>
                  {/* High Volatility */}
                  <div
                    className="relative"
                    onMouseEnter={() => setActiveTooltip('vol-high')}
                    onMouseLeave={() => setActiveTooltip(null)}
                  >
                    <button
                      onClick={() => setPickVolatility("high")}
                      className={`w-full px-2 py-2 rounded-lg text-sm font-medium transition-all ${
                        pickVolatility === "high"
                          ? "bg-red-600 text-white border-2 border-red-400"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-red-500/50"
                      }`}
                    >
                      <div className="text-lg">🔥</div>
                      <div className="text-xs">High Risk</div>
                    </button>
                    {activeTooltip === 'vol-high' && (
                      <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-52 bg-slate-900 border border-red-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                        <div className="font-semibold mb-1 text-red-400">🔥 HIGH RISK</div>
                        <p>AI stocks, small caps, meme stocks. Big swings - experienced traders only!</p>
                      </div>
                    )}
                  </div>
                  {/* Any Volatility */}
                  <div
                    className="relative"
                    onMouseEnter={() => setActiveTooltip('vol-any')}
                    onMouseLeave={() => setActiveTooltip(null)}
                  >
                    <button
                      onClick={() => setPickVolatility("any")}
                      className={`w-full px-2 py-2 rounded-lg text-sm font-medium transition-all ${
                        pickVolatility === "any"
                          ? "bg-slate-600 text-white border-2 border-slate-400"
                          : "bg-slate-800/50 text-slate-300 border border-slate-700 hover:border-slate-500/50"
                      }`}
                    >
                      <div className="text-lg">🎲</div>
                      <div className="text-xs">Any</div>
                    </button>
                    {activeTooltip === 'vol-any' && (
                      <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-48 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                        <div className="font-semibold mb-1 text-slate-300">🎲 Any Volatility</div>
                        <p>No volatility filter. Best available setup regardless of risk level.</p>
                      </div>
                    )}
                  </div>
                </div>
                <div className="mt-2 text-xs text-slate-500">
                  {pickVolatility === "low" && "🐢 Very stable stocks like utilities, consumer staples. Slow but steady. Conservative traders."}
                  {pickVolatility === "lowmed" && "🏛️ Established companies like AAPL, HD, JPM. Reliable with moderate moves."}
                  {pickVolatility === "medium" && "⚖️ Balanced risk/reward. Most tech stocks. Good for swing traders."}
                  {pickVolatility === "medhigh" && "📈 Growth stocks, volatile tech like AMD, TSLA. Larger moves, more risk."}
                  {pickVolatility === "high" && "🔥 HIGH RISK: AI stocks, small caps, meme stocks. Big swings, experienced traders only!"}
                  {pickVolatility === "any" && "🎲 No volatility filter. Best available setup regardless of risk level."}
                </div>
              </div>

              <div className="flex flex-col sm:flex-row gap-2 mb-3 md:mb-6">
                <button
                  onClick={() => fetchDailyPick(false)}
                  disabled={loadingPick}
                  className="flex-1 py-3 md:py-4 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 disabled:from-slate-700 disabled:to-slate-700 rounded-lg md:rounded-xl font-semibold text-sm md:text-lg shadow-lg transition-all flex items-center justify-center gap-3"
                >
                  {loadingPick ? (
                    <><Loader2 className="w-6 h-6 animate-spin" />⚡ Scanning...</>
                  ) : (
                    <><Sparkles className="w-6 h-6" />⚡ Get Today's Pick</>
                  )}
                </button>
                {dailyPick && (
                  <button
                    onClick={() => fetchDailyPick(true)}
                    disabled={loadingPick}
                    className="px-4 py-4 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 rounded-xl font-medium transition-all flex items-center justify-center"
                    title="Force refresh - scan for new pick"
                  >
                    <RefreshCw className={`w-5 h-5 ${loadingPick ? 'animate-spin' : ''}`} />
                  </button>
                )}
              </div>

              {/* Daily Pick Progress Indicator */}
              {loadingPick && dailyPickProgress.total > 0 && (
                <div className="bg-slate-800/50 border border-amber-500/30 rounded-lg p-4 mb-6">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 bg-amber-500 rounded-full animate-pulse" />
                      <span className="text-sm text-amber-300 font-medium">
                        {dailyPickProgress.phase === 'starting' ? 'Starting scan...' :
                         dailyPickProgress.phase === 'scanning' ? `Scanning ${dailyPickProgress.current} of ${dailyPickProgress.total} stocks...` :
                         dailyPickProgress.phase === 'complete' ? 'Finding best pick!' : 'Processing...'}
                      </span>
                    </div>
                    <span className="text-sm text-amber-400 font-bold">
                      {Math.round((dailyPickProgress.current / dailyPickProgress.total) * 100)}%
                    </span>
                  </div>
                  <div className="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                    <div
                      className="bg-gradient-to-r from-amber-500 to-orange-500 h-full rounded-full transition-all duration-300"
                      style={{ width: `${(dailyPickProgress.current / dailyPickProgress.total) * 100}%` }}
                    />
                  </div>
                  <p className="text-xs text-slate-500 mt-2">
                    ⚡ Parallel processing: analyzing 10 stocks per batch across 220+ symbols with 5-minute cache
                  </p>
                </div>
              )}

              {/* Scan Complete Message */}
              {!loadingPick && dailyPickProgress.scanTime > 0 && dailyPick && (
                <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg px-4 py-2 flex items-center justify-between mb-6">
                  <span className="text-sm text-emerald-300">
                    ✅ Best pick found from {dailyPickProgress.total} stocks
                  </span>
                  <span className="text-sm text-emerald-400 font-bold">
                    ⚡ {dailyPickProgress.scanTime}s scan time
                  </span>
                </div>
              )}

              {/* Daily Pick Error Display */}
              {dailyPickError && !loadingPick && (
                <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-6">
                  <div className="flex items-start gap-3">
                    <AlertTriangle className="w-5 h-5 text-red-400 mt-0.5 flex-shrink-0" />
                    <div className="flex-1">
                      <h4 className="font-semibold text-red-400 mb-1">Unable to Generate Pick</h4>
                      <p className="text-sm text-slate-300">{dailyPickError}</p>
                    </div>
                  </div>
                  <button
                    onClick={() => fetchDailyPick(true)}
                    className="mt-3 px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-medium text-sm transition-colors flex items-center gap-2"
                  >
                    <RefreshCw className="w-4 h-4" />
                    <span>Retry</span>
                  </button>
                </div>
              )}

              {dailyPick && (() => { try { return (
                <div className="space-y-5">
                  {/* LIVE DATA INDICATOR */}
                  {dailyPick.generatedWithLiveData && (
                    <div className="flex items-center justify-between bg-green-500/10 border border-green-500/30 rounded-lg px-4 py-2">
                      <div className="flex items-center gap-2">
                        <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse" />
                        <span className="text-sm text-green-400 font-medium">
                          LIVE DATA • {dailyPick.livePricesFetched} prices fetched
                        </span>
                        {dailyPick.marketSentiment && (
                          <span className={`ml-2 px-2 py-0.5 rounded text-xs ${
                            dailyPick.marketSentiment === 'bullish' ? 'bg-green-500/20 text-green-300' :
                            dailyPick.marketSentiment === 'bearish' ? 'bg-red-500/20 text-red-300' :
                            'bg-slate-500/20 text-slate-300'
                          }`}>
                            {dailyPick.marketSentiment.toUpperCase()}
                          </span>
                        )}
                      </div>
                      <div className="text-xs text-green-400/70">
                        {dailyPick.liveDataTimestamp}
                      </div>
                    </div>
                  )}
                  
                  <div className="bg-gradient-to-br from-amber-500/10 to-orange-500/10 border border-amber-500/20 rounded-lg md:rounded-xl p-3 md:p-6">
                    <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-3 md:gap-4 mb-3 md:mb-4">
                      <div>
                        <h3 className="text-lg md:text-2xl font-bold mb-1 bg-gradient-to-r from-amber-400 to-orange-400 bg-clip-text text-transparent">{dailyPick.assetName}</h3>
                        <p className="text-sm md:text-base text-slate-400">{dailyPick.asset} • {dailyPick.assetType}</p>
                        {/* Show current price prominently */}
                        <p className="text-base md:text-lg font-semibold text-white mt-1">
                          Current: <span className="text-violet-400">${dailyPick.currentPrice}</span>
                        </p>
                      </div>
                      <div className="flex flex-wrap md:flex-col items-start md:items-end gap-2">
                        {/* UNIFIED Recommendation Badge - matches main analyzer */}
                        {dailyPick.recommendation && (
                          <div className={`px-4 py-2 rounded-xl font-bold text-lg shadow-lg ${
                            dailyPick.recommendation === 'STRONG_BUY' ? 'bg-gradient-to-r from-emerald-600 to-green-600 text-white' :
                            dailyPick.recommendation === 'BUY' ? 'bg-gradient-to-r from-green-600 to-emerald-500 text-white' :
                            dailyPick.recommendation === 'STRONG_SELL' ? 'bg-gradient-to-r from-red-600 to-rose-600 text-white' :
                            dailyPick.recommendation === 'SELL' ? 'bg-gradient-to-r from-red-500 to-rose-500 text-white' :
                            dailyPick.recommendation.includes('SPECULATIVE') ? 'bg-gradient-to-r from-amber-600 to-orange-600 text-white' :
                            'bg-gradient-to-r from-yellow-600 to-amber-600 text-white'
                          }`}>
                            {dailyPick.recommendation.includes('BUY') ? (
                              <TrendingUp className="w-4 h-4 inline mr-1" />
                            ) : dailyPick.recommendation.includes('SELL') ? (
                              <TrendingDown className="w-4 h-4 inline mr-1" />
                            ) : null}
                            {dailyPick.recommendation.replace(/_/g, ' ')}
                          </div>
                        )}
                        <div
                          className="relative"
                          onMouseEnter={() => setActiveTooltip('pickdir')}
                          onMouseLeave={() => setActiveTooltip(null)}
                        >
                          <div
                            className={`px-5 py-2 rounded-full font-bold text-sm md:text-base cursor-help shadow-lg inline-flex items-center gap-1.5 transition-all ${
                              dailyPick.direction === "LONG" ? "bg-gradient-to-r from-emerald-600 to-green-600 text-white" : "bg-gradient-to-r from-red-600 to-rose-600 text-white"
                            }`}
                          >
                            {dailyPick.direction === "LONG" ? <TrendingUp className="w-4 h-4" /> : <TrendingDown className="w-4 h-4" />}
                            {dailyPick.direction} <span className="text-xs opacity-70">ⓘ</span>
                          </div>
                          {/* State-based Tooltip */}
                          {activeTooltip === 'pickdir' && (
                            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-56 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                              <div className={`font-semibold mb-1 ${dailyPick.direction === 'LONG' ? 'text-emerald-400' : 'text-red-400'}`}>
                                {dailyPick.direction === 'LONG' ? '📈 LONG Position' : '📉 SHORT Position'}
                              </div>
                              <p>{dailyPick.direction === 'LONG'
                                ? "Buy position. You profit when the price goes UP. Buy low, sell high."
                                : "Sell position. You profit when the price goes DOWN. Sell high, buy back lower."}</p>
                            </div>
                          )}
                        </div>
                        {/* Holding Period Badge */}
                        <div className="px-3 py-1.5 rounded-lg bg-blue-500/20 border border-blue-500/30 text-blue-300">
                          <div className="text-xs opacity-70">{dailyPick.timeframe || 'Swing'}</div>
                          <div className="font-semibold text-sm flex items-center gap-1">
                            <Clock className="w-3 h-3" />
                            {dailyPick.holdingPeriod || '24-48 Hours'}
                          </div>
                        </div>
                        {/* Recommended Chart Timeframe Badge */}
                        {dailyPick.recommendedLiveTimeframeLabel && (
                          <div
                            className="px-3 py-1.5 rounded-lg bg-emerald-500/20 border border-emerald-500/30 text-emerald-300 cursor-help"
                            title="Use this timeframe in Live Ticker for optimal analysis alignment with this recommendation"
                          >
                            <div className="text-xs opacity-70">View Chart In</div>
                            <div className="font-semibold text-sm flex items-center gap-1">
                              <BarChart3 className="w-3 h-3" />
                              {dailyPick.recommendedLiveTimeframeLabel}
                            </div>
                          </div>
                        )}
                        {/* Volatility Badge - 5 Levels with Hover Tooltip */}
                        {dailyPick.volatility && (
                          <div
                            className="relative"
                            onMouseEnter={() => setActiveTooltip('volatility')}
                            onMouseLeave={() => setActiveTooltip(null)}
                          >
                            <div
                              className={`px-3 py-1.5 rounded-lg border cursor-help ${
                                dailyPick.volatility.category === 'Low' ? 'bg-cyan-500/20 border-cyan-500/30 text-cyan-300' :
                                dailyPick.volatility.category === 'Low-Medium' ? 'bg-blue-500/20 border-blue-500/30 text-blue-300' :
                                dailyPick.volatility.category === 'Medium' ? 'bg-violet-500/20 border-violet-500/30 text-violet-300' :
                                dailyPick.volatility.category === 'Medium-High' ? 'bg-amber-500/20 border-amber-500/30 text-amber-300' :
                                dailyPick.volatility.category === 'High' ? 'bg-red-500/20 border-red-500/30 text-red-300' :
                                'bg-violet-500/20 border-violet-500/30 text-violet-300'
                              }`}
                            >
                              <div className="text-xs opacity-70">Risk Level</div>
                              <div className="font-semibold text-sm flex items-center gap-1">
                                <Activity className="w-3 h-3" />
                                {dailyPick.volatility.category} ({dailyPick.volatility.atrPercent}%) <span className="text-xs opacity-60">ⓘ</span>
                              </div>
                            </div>
                            {/* State-based Tooltip */}
                            {activeTooltip === 'volatility' && (
                              <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                                <div className={`font-semibold mb-1 ${
                                  dailyPick.volatility.category === 'Low' ? 'text-cyan-400' :
                                  dailyPick.volatility.category === 'Low-Medium' ? 'text-blue-400' :
                                  dailyPick.volatility.category === 'Medium' ? 'text-violet-400' :
                                  dailyPick.volatility.category === 'Medium-High' ? 'text-amber-400' :
                                  dailyPick.volatility.category === 'High' ? 'text-red-400' : 'text-violet-400'
                                }`}>
                                  {dailyPick.volatility.category === 'Low' ? '🐢 Low Volatility' :
                                   dailyPick.volatility.category === 'Low-Medium' ? '🏛️ Low-Medium Volatility' :
                                   dailyPick.volatility.category === 'Medium' ? '⚖️ Medium Volatility' :
                                   dailyPick.volatility.category === 'Medium-High' ? '📈 Medium-High Volatility' :
                                   dailyPick.volatility.category === 'High' ? '🔥 High Volatility' : 'Volatility'}
                                </div>
                                <p>
                                  {dailyPick.volatility.category === 'Low' ? 'Very stable stocks (utilities, consumer staples). Slow but steady moves. Best for conservative traders.' :
                                   dailyPick.volatility.category === 'Low-Medium' ? 'Established companies (AAPL, HD, JPM). Reliable with moderate price movements.' :
                                   dailyPick.volatility.category === 'Medium' ? 'Balanced risk/reward. Most tech stocks fall here. Good for swing traders.' :
                                   dailyPick.volatility.category === 'Medium-High' ? 'Growth stocks, volatile tech (AMD, TSLA). Larger moves, more risk but more reward.' :
                                   dailyPick.volatility.category === 'High' ? 'HIGH RISK: AI stocks, small caps, meme stocks. Big swings - experienced traders only!' :
                                   'Volatility level of this stock'}
                                </p>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Volatility Warning */}
                    {dailyPick.volatility?.warning && (
                      <div className="mb-4 px-4 py-2 bg-amber-500/10 border border-amber-500/30 rounded-lg text-amber-300 text-sm flex items-center gap-2">
                        <AlertTriangle className="w-4 h-4 flex-shrink-0" />
                        {dailyPick.volatility.warning}
                      </div>
                    )}

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="bg-gradient-to-br from-emerald-600/30 to-green-600/20 border border-emerald-500/40 rounded-lg md:rounded-xl p-4 shadow-md">
                        <div className="text-xs text-emerald-300 font-semibold mb-2 flex items-center gap-1">
                          <ChevronUp className="w-3 h-3" />
                          Entry Point
                        </div>
                        <div className="font-bold text-xl md:text-2xl text-emerald-300">${dailyPick.entry}</div>
                      </div>
                      <div className="bg-gradient-to-br from-red-600/30 to-rose-600/20 border border-red-500/40 rounded-lg md:rounded-xl p-4 shadow-md">
                        <div className="text-xs text-red-300 font-semibold mb-2 flex items-center gap-1">
                          <AlertCircle className="w-3 h-3" />
                          Stop Loss
                        </div>
                        <div className="font-bold text-xl md:text-2xl text-red-300">${dailyPick.stopLoss}</div>
                      </div>
                      <div className="bg-gradient-to-br from-blue-600/30 to-cyan-600/20 border border-blue-500/40 rounded-lg md:rounded-xl p-4 shadow-md">
                        <div className="text-xs text-blue-300 font-semibold mb-2 flex items-center gap-1">
                          <Target className="w-3 h-3" />
                          Target
                        </div>
                        <div className="font-bold text-xl md:text-2xl text-blue-300">${dailyPick.target1}</div>
                      </div>
                      <div className="bg-gradient-to-br from-violet-600/30 to-purple-600/20 border border-violet-500/40 rounded-lg md:rounded-xl p-4 shadow-md">
                        <div className="text-xs text-violet-300 font-semibold mb-2 flex items-center gap-1">
                          <Zap className="w-3 h-3" />
                          Risk:Reward
                        </div>
                        <div className="font-bold text-xl md:text-2xl text-violet-300">{dailyPick.riskReward}</div>
                      </div>
                    </div>

                    {/* View in Live Ticker Button with Auto-Timeframe */}
                    {dailyPick.recommendedLiveTimeframe && (
                      <button
                        onClick={() => {
                          setTickerSymbol(dailyPick.asset);
                          setTickerTimeframe(dailyPick.recommendedLiveTimeframe);
                          setActiveTab("ticker");
                          setTimeout(() => fetchTickerData(), 100);
                        }}
                        className="mt-4 w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 rounded-xl font-semibold text-white shadow-lg flex items-center justify-center gap-2 transition-all"
                      >
                        <LineChart className="w-5 h-5" />
                        View {dailyPick.asset} in Live Ticker ({dailyPick.recommendedLiveTimeframeLabel})
                      </button>
                    )}
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-gradient-to-br from-violet-600/40 to-purple-600/30 border border-violet-500/50 rounded-lg md:rounded-xl p-4 relative group shadow-lg shadow-violet-500/20 md:col-span-1">
                      <div className="text-xs text-violet-300 font-semibold mb-2 flex items-center gap-1">
                        <Zap className="w-3 h-3" />
                        Confidence
                        <HelpCircle className="w-3 h-3 text-violet-400 cursor-help" />
                      </div>
                      <div className="text-3xl md:text-4xl font-bold text-violet-200">{dailyPick.confidence}%</div>
                      {/* Confidence Score Bar */}
                      <div className="mt-3 w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div
                          className="h-full bg-gradient-to-r from-violet-500 to-purple-500 transition-all duration-500"
                          style={{ width: `${dailyPick.confidence}%` }}
                        />
                      </div>
                      {/* Confidence Tooltip */}
                      <div className="absolute left-0 top-full mt-2 w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-xl z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                        <div className="text-xs text-slate-200 font-semibold mb-2">What makes this score:</div>
                        <ul className="text-xs text-slate-300 space-y-1">
                          <li className="flex items-start gap-1">
                            <span className="text-emerald-400">•</span>
                            <span>Technical indicator alignment (RSI, MACD)</span>
                          </li>
                          <li className="flex items-start gap-1">
                            <span className="text-blue-400">•</span>
                            <span>Trend direction vs. trade direction</span>
                          </li>
                          <li className="flex items-start gap-1">
                            <span className="text-amber-400">•</span>
                            <span>Volume confirmation</span>
                          </li>
                          <li className="flex items-start gap-1">
                            <span className="text-violet-400">•</span>
                            <span>Risk/reward ratio quality</span>
                          </li>
                        </ul>
                        <div className="text-xs text-slate-400 mt-2 pt-2 border-t border-slate-700">
                          70%+ = High confidence trade
                        </div>
                      </div>
                    </div>
                    <div className="bg-slate-800/50 rounded-lg p-4">
                      <div className="text-xs text-slate-500 mb-1">Setup</div>
                      <div className="font-semibold">{dailyPick.setup}</div>
                    </div>
                    <div className="bg-slate-800/50 rounded-lg p-4">
                      <div className="text-xs text-slate-500 mb-1">Timeframe</div>
                      <div className="font-semibold">{dailyPick.timeframe}</div>
                    </div>
                    <div className="bg-slate-800/50 rounded-lg p-4">
                      <div className="text-xs text-slate-500 mb-1">Hold Period</div>
                      <div className="font-semibold">{dailyPick.holdingPeriod}</div>
                    </div>
                  </div>

                  {/* Position Size Calculator */}
                  <div className="bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border border-emerald-500/30 rounded-xl p-5">
                    <div className="flex items-center justify-between mb-4">
                      <h4 className="font-semibold text-emerald-300 flex items-center gap-2">
                        <Calculator className="w-5 h-5" />
                        Position Size Calculator
                      </h4>
                      <div className="text-xs text-slate-400">Based on your risk tolerance</div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div>
                        <label className="text-xs text-slate-400 mb-1 block">Your Portfolio Value</label>
                        <div className="flex items-center gap-2">
                          <span className="text-slate-400">$</span>
                          <input
                            type="number"
                            value={portfolioSettings.totalCapital}
                            onChange={(e) => setPortfolioSettings(prev => ({
                              ...prev,
                              totalCapital: parseInt(e.target.value) || 0
                            }))}
                            className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-right font-mono"
                            placeholder="10000"
                          />
                        </div>
                      </div>
                      <div>
                        <label className="text-xs text-slate-400 mb-1 block">Risk Per Trade</label>
                        <div className="flex items-center gap-2">
                          <input
                            type="number"
                            value={portfolioSettings.riskPercent}
                            onChange={(e) => setPortfolioSettings(prev => ({
                              ...prev,
                              riskPercent: Math.min(10, Math.max(0.5, parseFloat(e.target.value) || 2))
                            }))}
                            className="w-20 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-right font-mono"
                            placeholder="2"
                            min="0.5"
                            max="10"
                            step="0.5"
                          />
                          <span className="text-slate-400">%</span>
                          <div className="flex gap-1 ml-2">
                            {[1, 2, 5].map(pct => (
                              <button
                                key={pct}
                                onClick={() => setPortfolioSettings(prev => ({ ...prev, riskPercent: pct }))}
                                className={`px-2 py-1 rounded text-xs font-semibold ${
                                  portfolioSettings.riskPercent === pct
                                    ? 'bg-emerald-600 text-white'
                                    : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                }`}
                              >
                                {pct}%
                              </button>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                    {/* Calculated Results */}
                    {(() => {
                      const entry = parseFloat(dailyPick.entry);
                      const stopLoss = parseFloat(dailyPick.stopLoss);
                      const riskPerShare = Math.abs(entry - stopLoss);
                      const maxRiskAmount = (portfolioSettings.totalCapital * portfolioSettings.riskPercent) / 100;
                      const recommendedShares = riskPerShare > 0 ? Math.floor(maxRiskAmount / riskPerShare) : 0;
                      const positionValue = recommendedShares * entry;
                      const portfolioAllocation = (positionValue / portfolioSettings.totalCapital) * 100;

                      return (
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-emerald-500/20">
                          <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                            <div className="text-xs text-slate-500 mb-1">Max Risk Amount</div>
                            <div className="text-lg font-bold text-amber-400">${maxRiskAmount.toFixed(0)}</div>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                            <div className="text-xs text-slate-500 mb-1">Recommended Shares</div>
                            <div className="text-lg font-bold text-emerald-400">{recommendedShares}</div>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                            <div className="text-xs text-slate-500 mb-1">Position Value</div>
                            <div className="text-lg font-bold text-blue-400">${positionValue.toLocaleString()}</div>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                            <div className="text-xs text-slate-500 mb-1">Portfolio %</div>
                            <div className={`text-lg font-bold ${portfolioAllocation > 25 ? 'text-red-400' : 'text-violet-400'}`}>
                              {portfolioAllocation.toFixed(1)}%
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                    <div className="text-xs text-slate-500 mt-3 flex items-center gap-1">
                      <AlertCircle className="w-3 h-3" />
                      Position sized to risk ${((portfolioSettings.totalCapital * portfolioSettings.riskPercent) / 100).toFixed(0)} if stop loss is hit
                    </div>
                  </div>

                  <div className="bg-violet-500/10 border border-violet-500/20 rounded-xl p-5">
                    <h4 className="font-semibold mb-3 text-violet-300">Technical Justification</h4>
                    <p className="text-sm text-slate-200 mb-4">{dailyPick.keyReason}</p>
                    <div className="flex flex-wrap gap-2">
                      {dailyPick.technicalSignals?.map((signal, i) => (
                        <span key={i} className="px-3 py-1.5 bg-violet-600/20 rounded-lg text-sm font-medium">
                          {signal}
                        </span>
                      ))}
                    </div>
                  </div>

                  {/* NEW: Expected Profit Section */}
                  {dailyPick.expectedProfit && (
                    <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-5">
                      <h4 className="font-semibold mb-4 text-emerald-300 flex items-center gap-2">
                        <DollarSign className="w-5 h-5" />
                        Expected Profit Analysis
                      </h4>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Profit per Share (T1)</div>
                          <div className="font-bold text-xl text-emerald-400">${dailyPick.expectedProfit.profitPerShare}</div>
                          <div className="text-xs text-emerald-300">+{dailyPick.expectedProfit.profitPercent}%</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Profit per Share (T2)</div>
                          <div className="font-bold text-xl text-emerald-400">${dailyPick.expectedProfit.profitPerShareT2}</div>
                          <div className="text-xs text-emerald-300">+{dailyPick.expectedProfit.profitPercentT2}%</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Risk per Share</div>
                          <div className="font-bold text-xl text-red-400">${dailyPick.expectedProfit.riskPerShare}</div>
                          <div className="text-xs text-red-300">-{dailyPick.expectedProfit.riskPercent}%</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3 relative group">
                          <div className="text-xs text-slate-500 mb-1 flex items-center gap-1">
                            Win Probability
                            <HelpCircle className="w-3 h-3 text-slate-500 hover:text-violet-400 cursor-help" />
                          </div>
                          <div className="font-bold text-xl text-violet-400">{dailyPick.expectedProfit.winProbability}%</div>
                          <div className="text-xs text-slate-400">Estimated</div>
                          {/* Win Probability Tooltip */}
                          <div className="absolute right-0 top-full mt-2 w-60 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-xl z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                            <div className="text-xs text-slate-200 font-semibold mb-2">Win Probability Formula:</div>
                            <div className="text-xs text-slate-300 space-y-1">
                              <p>Based on confidence score (80%) + trend alignment bonus/penalty (+/-10%)</p>
                              <p className="text-slate-400 mt-1">Capped at 45-75% range to reflect realistic market conditions.</p>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Position Sizing Example */}
                      <div className="bg-slate-800/30 rounded-lg p-4 border border-slate-700/50">
                        <div className="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
                          <Wallet className="w-4 h-4" />
                          Position Example (${dailyPick.expectedProfit.exampleAccount.toLocaleString()} Account, {dailyPick.expectedProfit.exampleRiskPercent}% Risk)
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                          <div>
                            <div className="text-xs text-slate-500">Shares to Buy</div>
                            <div className="font-bold text-white">{dailyPick.expectedProfit.exampleShares} shares</div>
                          </div>
                          <div>
                            <div className="text-xs text-slate-500">Position Value</div>
                            <div className="font-bold text-white">${parseFloat(dailyPick.expectedProfit.examplePositionValue).toLocaleString()}</div>
                          </div>
                          <div>
                            <div className="text-xs text-slate-500">Expected Profit (T1)</div>
                            <div className="font-bold text-emerald-400">+${dailyPick.expectedProfit.exampleExpectedProfit}</div>
                          </div>
                          <div>
                            <div className="text-xs text-slate-500">Max Loss</div>
                            <div className="font-bold text-red-400">-${dailyPick.expectedProfit.exampleMaxLoss}</div>
                          </div>
                        </div>
                        <div className="mt-3 pt-3 border-t border-slate-700/50 flex items-center justify-between">
                          <div className="text-xs text-slate-400">
                            Expected Value: <span className={parseFloat(dailyPick.expectedProfit.expectedValuePercent) > 0 ? 'text-emerald-400' : 'text-red-400'}>
                              {parseFloat(dailyPick.expectedProfit.expectedValuePercent) > 0 ? '+' : ''}{dailyPick.expectedProfit.expectedValuePercent}%
                            </span> per trade
                          </div>
                          <div className="text-xs text-slate-500">
                            Formula: (Win% × Profit%) - (Loss% × Risk%)
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* NEW: Stock Catalysts & Events Section */}
                  {dailyPick.catalystData && (
                    <div className="bg-gradient-to-br from-amber-500/10 to-orange-500/10 border border-amber-500/30 rounded-xl p-5">
                      <h4 className="font-semibold mb-4 text-amber-300 flex items-center gap-2">
                        <Flame className="w-5 h-5" />
                        Stock Catalysts & Events
                        {dailyPick.catalystData.catalystBonus !== 0 && (
                          <span className={`ml-2 text-xs px-2 py-0.5 rounded-full ${
                            dailyPick.catalystData.catalystBonus > 0
                              ? 'bg-emerald-500/20 text-emerald-300'
                              : 'bg-red-500/20 text-red-300'
                          }`}>
                            {dailyPick.catalystData.catalystBonus > 0 ? '+' : ''}{dailyPick.catalystData.catalystBonus} Score Adjustment
                          </span>
                        )}
                      </h4>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        {/* Upcoming Events */}
                        {dailyPick.catalystData.upcomingEvents?.length > 0 && (
                          <div className="bg-slate-800/50 rounded-lg p-4">
                            <div className="text-xs text-amber-400 font-semibold mb-2 flex items-center gap-1">
                              <Calendar className="w-3 h-3" />
                              UPCOMING EVENTS
                            </div>
                            <ul className="space-y-1.5">
                              {dailyPick.catalystData.upcomingEvents.map((event, i) => (
                                <li key={i} className="flex items-start gap-2 text-sm">
                                  <Sparkles className="w-3 h-3 text-amber-400 mt-1 flex-shrink-0" />
                                  <span className="text-slate-200">{event}</span>
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}

                        {/* Bullish Catalysts */}
                        {dailyPick.catalystData.catalysts?.length > 0 && (
                          <div className="bg-slate-800/50 rounded-lg p-4">
                            <div className="text-xs text-emerald-400 font-semibold mb-2 flex items-center gap-1">
                              <TrendingUp className="w-3 h-3" />
                              BULLISH CATALYSTS
                            </div>
                            <ul className="space-y-1.5">
                              {dailyPick.catalystData.catalysts.map((catalyst, i) => (
                                <li key={i} className="flex items-start gap-2 text-sm">
                                  <ArrowUpRight className="w-3 h-3 text-emerald-400 mt-1 flex-shrink-0" />
                                  <span className="text-slate-200">{catalyst}</span>
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}

                        {/* Risk Events */}
                        {dailyPick.catalystData.risks?.length > 0 && (
                          <div className="bg-slate-800/50 rounded-lg p-4">
                            <div className="text-xs text-red-400 font-semibold mb-2 flex items-center gap-1">
                              <AlertTriangle className="w-3 h-3" />
                              RISK FACTORS
                            </div>
                            <ul className="space-y-1.5">
                              {dailyPick.catalystData.risks.map((risk, i) => (
                                <li key={i} className="flex items-start gap-2 text-sm">
                                  <X className="w-3 h-3 text-red-400 mt-1 flex-shrink-0" />
                                  <span className="text-slate-200">{risk}</span>
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}

                        {/* Earnings */}
                        {dailyPick.catalystData.earnings && (
                          <div className="bg-slate-800/50 rounded-lg p-4">
                            <div className="text-xs text-violet-400 font-semibold mb-2 flex items-center gap-1">
                              <DollarSign className="w-3 h-3" />
                              EARNINGS
                            </div>
                            <p className="text-sm text-slate-200">{dailyPick.catalystData.earnings}</p>
                          </div>
                        )}
                      </div>

                      {/* Seasonality & Sector Trend */}
                      <div className="flex flex-wrap gap-3">
                        {dailyPick.catalystData.seasonality && dailyPick.catalystData.seasonality !== 'neutral' && (
                          <div className={`px-3 py-1.5 rounded-lg text-sm flex items-center gap-1.5 ${
                            dailyPick.catalystData.seasonality === 'bullish'
                              ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30'
                              : 'bg-red-500/20 text-red-300 border border-red-500/30'
                          }`}>
                            {dailyPick.catalystData.seasonality === 'bullish' ? <TrendingUp className="w-3 h-3" /> : <TrendingDown className="w-3 h-3" />}
                            {dailyPick.catalystData.seasonality === 'bullish' ? 'Bullish' : 'Bearish'} Seasonality
                          </div>
                        )}
                        {dailyPick.catalystData.sectorTrend && (
                          <div className="px-3 py-1.5 rounded-lg text-sm bg-blue-500/20 text-blue-300 border border-blue-500/30 flex items-center gap-1.5">
                            <Activity className="w-3 h-3" />
                            {dailyPick.catalystData.sectorTrend}
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div className="bg-slate-800/50 rounded-xl p-5">
                      <h4 className="font-semibold mb-3">Market Context</h4>
                      <p className="text-sm text-slate-300">{dailyPick.marketContext}</p>
                    </div>
                    <div className="bg-red-500/5 border border-red-500/20 rounded-xl p-5">
                      <h4 className="font-semibold mb-3 text-red-400">Risk Factors</h4>
                      <ul className="space-y-2">
                        {dailyPick.riskFactors?.map((risk, i) => (
                          <li key={i} className="flex items-start gap-2 text-sm">
                            <AlertTriangle className="w-4 h-4 text-red-400 mt-0.5 flex-shrink-0" />
                            <span>{risk}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </div>

                  <div className="bg-amber-500/10 border border-amber-500/20 rounded-xl p-5">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Optimal Entry Time</div>
                        <div className="font-semibold">{dailyPick.optimalEntry}</div>
                      </div>
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Setup Invalidation</div>
                        <div className="font-semibold text-amber-400">{dailyPick.invalidation}</div>
                      </div>
                    </div>
                  </div>

                  {/* NEW: Technical Data Panel - Shows actual calculated indicators */}
                  {dailyPick.technicalData && (
                    <div className="bg-blue-500/10 border border-blue-500/20 rounded-xl p-5">
                      <h4 className="font-semibold mb-3 text-blue-300 flex items-center gap-2">
                        <BarChart3 className="w-4 h-4" />
                        Calculated Technical Indicators
                      </h4>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">RSI (14)</div>
                          <div className={`font-bold text-lg ${
                            parseFloat(dailyPick.technicalData.rsi) > 70 ? 'text-red-400' :
                            parseFloat(dailyPick.technicalData.rsi) < 30 ? 'text-emerald-400' :
                            'text-violet-400'
                          }`}>
                            {dailyPick.technicalData.rsi || 'N/A'}
                          </div>
                          <div className="text-xs text-slate-500">
                            {parseFloat(dailyPick.technicalData.rsi) > 70 ? 'Overbought' :
                             parseFloat(dailyPick.technicalData.rsi) < 30 ? 'Oversold' : 'Neutral'}
                          </div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">MACD Histogram</div>
                          <div className={`font-bold text-lg ${
                            parseFloat(dailyPick.technicalData.macdHistogram) > 0 ? 'text-emerald-400' : 'text-red-400'
                          }`}>
                            {parseFloat(dailyPick.technicalData.macdHistogram) > 0 ? '+' : ''}{dailyPick.technicalData.macdHistogram || 'N/A'}
                          </div>
                          <div className="text-xs text-slate-500">
                            {parseFloat(dailyPick.technicalData.macdHistogram) > 0 ? 'Bullish' : 'Bearish'}
                          </div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Trend</div>
                          <div className={`font-bold text-lg ${
                            dailyPick.technicalData.trend === 'UPTREND' ? 'text-emerald-400' :
                            dailyPick.technicalData.trend === 'DOWNTREND' ? 'text-red-400' :
                            'text-yellow-400'
                          }`}>
                            {dailyPick.technicalData.trend || 'N/A'}
                          </div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Score</div>
                          <div className="font-bold text-lg">
                            <span className="text-emerald-400">{dailyPick.technicalData.bullishScore}</span>
                            <span className="text-slate-500 mx-1">/</span>
                            <span className="text-red-400">{dailyPick.technicalData.bearishScore}</span>
                          </div>
                          <div className="text-xs text-slate-500">Bull / Bear</div>
                        </div>
                      </div>
                      <div className="mt-3 flex flex-wrap gap-2 text-xs">
                        <span className={`px-2 py-1 rounded ${dailyPick.technicalData.aboveSMA20 ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}`}>
                          {dailyPick.technicalData.aboveSMA20 ? '✓' : '✗'} Above SMA20
                        </span>
                        <span className={`px-2 py-1 rounded ${dailyPick.technicalData.aboveSMA50 ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}`}>
                          {dailyPick.technicalData.aboveSMA50 ? '✓' : '✗'} Above SMA50
                        </span>
                      </div>
                    </div>
                  )}

                  {/* NEW: Other Candidates - Show what else was considered */}
                  {dailyPick.otherCandidates && dailyPick.otherCandidates.length > 0 && (
                    <div className="bg-slate-800/30 border border-slate-700/50 rounded-xl p-5">
                      <h4 className="font-semibold mb-3 text-slate-400 text-sm">Other Candidates Analyzed</h4>
                      <div className="flex flex-wrap gap-2">
                        {dailyPick.otherCandidates.map((candidate, i) => (
                          <div key={i} className="bg-slate-800/50 rounded-lg px-3 py-2 text-sm">
                            <span className="font-medium text-slate-200">{candidate.symbol}</span>
                            <span
                              className={`ml-2 px-1.5 py-0.5 rounded text-xs cursor-help ${
                                candidate.direction === 'LONG' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'
                              }`}
                              title={candidate.direction === 'LONG'
                                ? "LONG = Buy position (profit when price rises)"
                                : "SHORT = Sell position (profit when price falls)"}
                            >
                              {candidate.direction}
                            </span>
                            <span className="ml-2 text-slate-500">Score: {candidate.score}</span>
                            {candidate.rsi && <span className="ml-2 text-violet-400">RSI: {candidate.rsi}</span>}
                          </div>
                        ))}
                      </div>
                      <p className="text-xs text-slate-500 mt-2">
                        These stocks were analyzed but scored lower than the top pick based on technical indicators.
                      </p>
                    </div>
                  )}

                  {lastPickTime && (
                    <p className="text-xs text-slate-500 text-center">
                      Generated at {lastPickTime instanceof Date ? lastPickTime.toLocaleTimeString() : String(lastPickTime)}
                    </p>
                  )}
                </div>
              ); } catch (renderErr) { console.error('[Daily Pick Render] Crash caught:', renderErr); return (
                <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-6 text-center">
                  <AlertTriangle className="w-8 h-8 text-red-400 mx-auto mb-3" />
                  <h4 className="font-semibold text-red-400 mb-2">Pick Display Error</h4>
                  <p className="text-sm text-slate-400 mb-4">Something went wrong rendering the daily pick.</p>
                  <p className="text-xs text-red-300/60 mb-4 font-mono break-all">{renderErr?.message || 'Unknown error'}</p>
                  <button onClick={() => { setDailyPick(null); localStorage.removeItem(`modus_daily_pick_${pickTimeframe}_${pickVolatility}`); fetchDailyPick(true); }} className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg font-medium text-sm transition-colors">Clear Cache & Retry</button>
                </div>
              ); } })()}

              {!loadingPick && !dailyPick && (
                <div className="text-center py-16">
                  <Star className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                  <h3 className="text-xl font-semibold mb-2">Generate Today's Top Trade</h3>
                  <p className="text-slate-400 max-w-md mx-auto">
                    Click above to have AI analyze current market conditions and provide a high-probability trade recommendation.
                  </p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Quick Analysis Tab */}
        {activeTab === "quickanalysis" && (
          <div className="max-w-4xl mx-auto space-y-8">
            {/* Header */}
            <div className="bg-gradient-to-br from-violet-500/10 to-cyan-500/10 border border-violet-500/20 rounded-2xl p-6">
              <div className="flex items-center gap-3 mb-3">
                <div className="p-3 bg-gradient-to-br from-violet-500 to-cyan-600 rounded-xl shadow-lg">
                  <Zap className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h2 className="text-2xl font-bold">Quick Analysis</h2>
                  <p className="text-sm text-slate-400">Enter any ticker for an instant buy/sell verdict powered by real market data + AI</p>
                </div>
              </div>
              <div className="flex gap-2 mt-4">
                <input
                  type="text"
                  value={quickAnalysisTicker}
                  onChange={(e) => setQuickAnalysisTicker(e.target.value.toUpperCase())}
                  onKeyDown={(e) => { if (e.key === 'Enter') runQuickAnalysis(quickAnalysisTicker); }}
                  placeholder="Enter ticker (e.g. AAPL, TSLA, NVDA)..."
                  className="flex-1 bg-slate-800/60 border border-slate-700/30 rounded-xl px-4 py-3 text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500/30 placeholder:text-slate-600 uppercase"
                  disabled={quickAnalysisLoading}
                />
                <button
                  onClick={() => runQuickAnalysis(quickAnalysisTicker)}
                  disabled={quickAnalysisLoading || !quickAnalysisTicker.trim()}
                  className="px-6 py-3 bg-violet-600 hover:bg-violet-500 disabled:bg-slate-700 disabled:text-slate-500 rounded-xl font-bold transition-all flex items-center gap-2"
                >
                  {quickAnalysisLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Zap className="w-5 h-5" />}
                  {quickAnalysisLoading ? 'Analyzing...' : 'Analyze'}
                </button>
              </div>
              {/* Quick picks */}
              <div className="flex items-center gap-2 mt-3 flex-wrap">
                <span className="text-xs text-slate-500">Popular:</span>
                {['AAPL', 'TSLA', 'NVDA', 'AMZN', 'MSFT', 'META', 'GOOGL', 'SPY'].map(sym => (
                  <button
                    key={sym}
                    onClick={() => { setQuickAnalysisTicker(sym); runQuickAnalysis(sym); }}
                    className="px-2.5 py-1 text-xs font-semibold bg-slate-800/60 hover:bg-violet-500/20 border border-slate-700/20 hover:border-violet-500/30 rounded-lg text-slate-400 hover:text-violet-300 transition-all"
                    disabled={quickAnalysisLoading}
                  >
                    {sym}
                  </button>
                ))}
              </div>
            </div>

            {/* Loading State */}
            {quickAnalysisLoading && (
              <div className="bg-slate-900/50 rounded-2xl border border-violet-500/20 p-8 text-center relative overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-violet-500/5 to-transparent animate-pulse" />
                <div className="relative">
                  <div className="relative w-20 h-20 mx-auto mb-5">
                    <div className="absolute inset-0 bg-violet-500/20 rounded-full animate-ping" style={{ animationDuration: '1.5s' }} />
                    <Loader2 className="w-20 h-20 animate-spin text-violet-500" />
                    <Zap className="w-7 h-7 text-violet-400 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" />
                  </div>
                  <h3 className="text-lg font-semibold mb-2">Analyzing {quickAnalysisTicker}...</h3>
                  <p className="text-sm text-slate-400 mb-5">Fetching real-time data and running AI analysis</p>
                  <div className="max-w-xs mx-auto space-y-2">
                    <div className="flex items-center gap-2 text-xs text-slate-500">
                      <div className="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse" />
                      <span>Fetching price data...</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-slate-500">
                      <div className="w-1.5 h-1.5 bg-violet-400 rounded-full animate-pulse" style={{ animationDelay: '0.5s' }} />
                      <span>Computing technical indicators...</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-slate-500">
                      <div className="w-1.5 h-1.5 bg-cyan-400 rounded-full animate-pulse" style={{ animationDelay: '1s' }} />
                      <span>Running AI analysis...</span>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Result Card */}
            {quickAnalysisResult && !quickAnalysisResult.error && !quickAnalysisLoading && (() => {
              const r = quickAnalysisResult;
              const isBuy = r.verdict?.includes('BUY');
              const isSell = r.verdict?.includes('SELL');
              const isStrong = r.verdict?.includes('STRONG');
              const verdictColor = isBuy ? (isStrong ? 'from-emerald-600 to-green-600' : 'from-green-600 to-emerald-600') : isSell ? (isStrong ? 'from-red-600 to-rose-600' : 'from-rose-600 to-red-600') : 'from-amber-600 to-yellow-600';
              const verdictBg = isBuy ? 'bg-emerald-500/10 border-emerald-500/20' : isSell ? 'bg-red-500/10 border-red-500/20' : 'bg-amber-500/10 border-amber-500/20';
              const verdictText = isBuy ? 'text-emerald-400' : isSell ? 'text-red-400' : 'text-amber-400';

              return (
                <div className="space-y-5">
                  {/* Main Verdict */}
                  <div className={`rounded-2xl border p-6 ${verdictBg}`}>
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex items-center gap-4">
                        <div className={`p-4 bg-gradient-to-br ${verdictColor} rounded-xl shadow-lg`}>
                          {isBuy ? <TrendingUp className="w-8 h-8 text-white" /> : isSell ? <TrendingDown className="w-8 h-8 text-white" /> : <AlertTriangle className="w-8 h-8 text-white" />}
                        </div>
                        <div>
                          <div className={`text-3xl font-black ${verdictText}`}>{r.verdict}</div>
                          <div className="text-slate-400 text-sm">{r.ticker} · ${r.price?.toFixed(2)} <span className={`${r.dayChange >= 0 ? 'text-green-400' : 'text-red-400'}`}>({r.dayChange >= 0 ? '+' : ''}{r.dayChange}%)</span></div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-sm text-slate-500">Confidence</div>
                        <div className={`text-3xl font-bold ${r.confidence >= 70 ? 'text-emerald-400' : r.confidence >= 50 ? 'text-amber-400' : 'text-red-400'}`}>{r.confidence}%</div>
                      </div>
                    </div>
                    <p className="text-slate-300 leading-relaxed">{r.summary}</p>
                  </div>

                  {/* Key Metrics Grid */}
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-4">
                      <div className="text-xs text-slate-500 mb-1">Target Price</div>
                      <div className="text-lg font-bold text-green-400">{r.targetPrice ? `$${r.targetPrice.toFixed(2)}` : '—'}</div>
                      <div className="text-[10px] text-emerald-400/60">{r.price && r.targetPrice ? `${r.targetPrice > r.price ? '+' : ''}${((r.targetPrice / r.price - 1) * 100).toFixed(1)}% ${r.targetPrice > r.price ? 'upside' : 'downside'}` : ''}</div>
                    </div>
                    <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-4">
                      <div className="text-xs text-slate-500 mb-1">Stop Loss</div>
                      <div className="text-lg font-bold text-red-400">{r.stopLoss ? `$${r.stopLoss.toFixed(2)}` : '—'}</div>
                      <div className="text-[10px] text-red-400/60">{r.price && r.stopLoss ? `${((r.stopLoss / r.price - 1) * 100).toFixed(1)}% risk` : ''}</div>
                    </div>
                    <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-4">
                      <div className="text-xs text-slate-500 mb-1">Timeframe</div>
                      <div className="text-lg font-bold">{r.timeframe || '—'}</div>
                    </div>
                    <div className="bg-slate-800/40 rounded-xl border border-slate-700/20 p-4">
                      <div className="text-xs text-slate-500 mb-1">Risk Level</div>
                      <div className={`text-lg font-bold ${r.riskLevel === 'LOW' ? 'text-green-400' : r.riskLevel === 'HIGH' ? 'text-red-400' : 'text-amber-400'}`}>{r.riskLevel || '—'}</div>
                    </div>
                  </div>

                  {/* Support / Resistance + R:R */}
                  <div className="grid grid-cols-3 gap-3">
                    <div className="bg-emerald-500/5 rounded-xl border border-emerald-500/15 p-3 text-center">
                      <div className="text-[10px] text-emerald-400/70 mb-0.5">Support</div>
                      <div className="text-sm font-bold text-emerald-400">{r.support ? `$${r.support.toFixed(2)}` : '—'}</div>
                    </div>
                    <div className="bg-violet-500/5 rounded-xl border border-violet-500/15 p-3 text-center">
                      <div className="text-[10px] text-violet-400/70 mb-0.5">Risk : Reward</div>
                      <div className="text-sm font-bold text-violet-400">{r.riskRewardRatio || '—'}</div>
                    </div>
                    <div className="bg-red-500/5 rounded-xl border border-red-500/15 p-3 text-center">
                      <div className="text-[10px] text-red-400/70 mb-0.5">Resistance</div>
                      <div className="text-sm font-bold text-red-400">{r.resistance ? `$${r.resistance.toFixed(2)}` : '—'}</div>
                    </div>
                  </div>

                  {/* Technical Indicators */}
                  <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <div className="bg-slate-800/40 rounded-lg border border-slate-700/20 p-3 text-center">
                      <div className="text-[10px] text-slate-500">RSI (14)</div>
                      <div className={`text-sm font-bold ${r.rsi > 70 ? 'text-red-400' : r.rsi < 30 ? 'text-green-400' : 'text-white'}`}>{r.rsi}</div>
                      <div className="text-[9px] text-slate-600">{r.rsi > 70 ? 'Overbought' : r.rsi < 30 ? 'Oversold' : 'Neutral'}</div>
                    </div>
                    <div className="bg-slate-800/40 rounded-lg border border-slate-700/20 p-3 text-center">
                      <div className="text-[10px] text-slate-500">vs SMA20</div>
                      <div className={`text-sm font-bold ${r.sma20 && r.price > r.sma20 ? 'text-green-400' : r.sma20 ? 'text-red-400' : 'text-slate-500'}`}>{r.sma20 ? (r.price > r.sma20 ? 'Above' : 'Below') : '—'}</div>
                      {r.sma20 && <div className="text-[9px] text-slate-600">${r.sma20.toFixed(2)}</div>}
                    </div>
                    <div className="bg-slate-800/40 rounded-lg border border-slate-700/20 p-3 text-center">
                      <div className="text-[10px] text-slate-500">vs SMA50</div>
                      <div className={`text-sm font-bold ${r.sma50 && r.price > r.sma50 ? 'text-green-400' : r.sma50 ? 'text-red-400' : 'text-slate-500'}`}>{r.sma50 ? (r.price > r.sma50 ? 'Above' : 'Below') : '—'}</div>
                      {r.sma50 && <div className="text-[9px] text-slate-600">${r.sma50.toFixed(2)}</div>}
                    </div>
                    <div className="bg-slate-800/40 rounded-lg border border-slate-700/20 p-3 text-center">
                      <div className="text-[10px] text-slate-500">Volume</div>
                      <div className={`text-sm font-bold ${r.volRatio > 1.5 ? 'text-green-400' : r.volRatio < 0.5 ? 'text-red-400' : 'text-white'}`}>{r.volRatio}x</div>
                      <div className="text-[9px] text-slate-600">{r.volRatio > 1.5 ? 'High' : r.volRatio < 0.5 ? 'Low' : 'Normal'}</div>
                    </div>
                    <div className="bg-slate-800/40 rounded-lg border border-slate-700/20 p-3 text-center">
                      <div className="text-[10px] text-slate-500">3M Range</div>
                      <div className="text-sm font-bold">{r.rangePosition}%</div>
                      <div className="text-[9px] text-slate-600">{r.rangePosition > 75 ? 'Near High' : r.rangePosition < 25 ? 'Near Low' : 'Mid Range'}</div>
                    </div>
                  </div>

                  {/* Bullish / Bearish Factors */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="bg-emerald-500/5 border border-emerald-500/20 rounded-xl p-4">
                      <h4 className="font-semibold text-emerald-400 mb-3 text-sm flex items-center gap-2">
                        <TrendingUp className="w-4 h-4" /> Bullish Factors
                      </h4>
                      <div className="space-y-2">
                        {(r.bullish || []).map((f, i) => (
                          <div key={i} className="flex items-start gap-2 text-xs text-slate-300">
                            <span className="text-emerald-400 mt-0.5">+</span> {f}
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="bg-red-500/5 border border-red-500/20 rounded-xl p-4">
                      <h4 className="font-semibold text-red-400 mb-3 text-sm flex items-center gap-2">
                        <TrendingDown className="w-4 h-4" /> Bearish Factors
                      </h4>
                      <div className="space-y-2">
                        {(r.bearish || []).map((f, i) => (
                          <div key={i} className="flex items-start gap-2 text-xs text-slate-300">
                            <span className="text-red-400 mt-0.5">−</span> {f}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* Key Level + Entry Strategy */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {r.keyLevel && (
                      <div className="bg-violet-500/5 border border-violet-500/20 rounded-xl p-4">
                        <h4 className="font-semibold text-violet-400 mb-2 text-sm">Key Level to Watch</h4>
                        <p className="text-sm text-slate-300">{r.keyLevel}</p>
                      </div>
                    )}
                    {r.entryStrategy && (
                      <div className="bg-cyan-500/5 border border-cyan-500/20 rounded-xl p-4">
                        <h4 className="font-semibold text-cyan-400 mb-2 text-sm">Entry Strategy</h4>
                        <p className="text-sm text-slate-300">{r.entryStrategy}</p>
                      </div>
                    )}
                  </div>

                  {/* Tell Me More Button */}
                  <div className="flex items-center gap-3">
                    <button
                      onClick={runQuickAnalysisDetail}
                      disabled={quickAnalysisDetailLoading}
                      className="flex-1 py-3.5 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 disabled:from-slate-700 disabled:to-slate-700 rounded-xl font-bold transition-all flex items-center justify-center gap-2"
                    >
                      {quickAnalysisDetailLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <MessageCircle className="w-5 h-5" />}
                      {quickAnalysisDetailLoading ? 'Loading detailed analysis...' : 'Tell Me More — Deep Dive Analysis'}
                    </button>
                    <button
                      onClick={() => { setTickerSymbol(r.ticker); setActiveTab('ticker'); }}
                      className="px-4 py-3.5 bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/30 rounded-xl font-semibold text-sm transition-all flex items-center gap-2"
                    >
                      <LineChart className="w-4 h-4" /> View Chart
                    </button>
                    {/* Share to Feed (Feature 4) */}
                    <button
                      onClick={() => addToSocialFeed({ type: 'analysis', ticker: r.ticker, verdict: r.verdict, text: `${r.verdict} on ${r.ticker} — Confidence: ${r.confidence}% | Target: $${r.target} | Stop: $${r.stop}`, confidence: r.confidence })}
                      className="px-4 py-3.5 bg-cyan-600/10 hover:bg-cyan-600/20 border border-cyan-500/20 rounded-xl font-semibold text-sm transition-all flex items-center gap-2 text-cyan-400"
                      title="Share to community feed"
                    >
                      <MessageCircle className="w-4 h-4" /> Share
                    </button>
                    {/* Track Target (Feature 5) */}
                    <button
                      onClick={() => { addPriceTarget(r.ticker, r.price, r.target, r.stop, r.verdict, r.confidence); }}
                      className="px-4 py-3.5 bg-amber-600/10 hover:bg-amber-600/20 border border-amber-500/20 rounded-xl font-semibold text-sm transition-all flex items-center gap-2 text-amber-400"
                      title="Track price target"
                    >
                      <Target className="w-4 h-4" /> Track
                    </button>
                  </div>

                  {/* Detailed Analysis Expansion — Structured Cards */}
                  {quickAnalysisDetail && (() => {
                    // Handle raw text fallback — render markdown properly
                    if (quickAnalysisDetail._raw) {
                      const rawText = quickAnalysisDetail.text || '';
                      return (
                        <div className="bg-slate-900/50 rounded-2xl border border-violet-500/20 p-6">
                          <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                            <MessageCircle className="w-5 h-5 text-violet-400" /> Deep Dive — {r.ticker}
                          </h3>
                          <div className="text-sm leading-relaxed space-y-2">
                            {rawText.split('\n').map((line, li) => {
                              if (!line.trim()) return <div key={li} className="h-2" />;
                              // Section headers: **Bold Text** on its own line or ### Headers
                              if (line.match(/^\*\*.*\*\*\s*$/) || line.match(/^#{1,3}\s+/)) {
                                const headerText = line.replace(/\*\*/g, '').replace(/^#{1,3}\s+/, '').trim();
                                return <h4 key={li} className="text-violet-400 font-bold text-base mt-5 mb-2 border-b border-slate-700/30 pb-1">{headerText}</h4>;
                              }
                              // Bullet points
                              if (line.trim().match(/^[•\-\*]\s/) || line.trim().match(/^\d+\.\s/)) {
                                const bulletText = line.trim().replace(/^[•\-\*]\s*/, '').replace(/^\d+\.\s*/, '');
                                const formatted = bulletText.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>');
                                return <div key={li} className="flex items-start gap-2 ml-2 text-slate-300" dangerouslySetInnerHTML={{ __html: `<span class="text-violet-400 mt-0.5 flex-shrink-0">▸</span> <span>${formatted}</span>` }} />;
                              }
                              // Regular paragraph — strip inline bold markdown
                              const formatted = line.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>');
                              return <p key={li} className="text-slate-300" dangerouslySetInnerHTML={{ __html: formatted }} />;
                            })}
                          </div>
                        </div>
                      );
                    }
                    const d = quickAnalysisDetail;
                    return (
                      <div className="space-y-4">
                        <h3 className="font-bold text-lg flex items-center gap-2">
                          <MessageCircle className="w-5 h-5 text-violet-400" /> Deep Dive Analysis — {r.ticker}
                        </h3>

                        {/* 1. Technical Analysis */}
                        {d.technicalAnalysis && (
                          <div className="bg-slate-900/50 rounded-2xl border border-violet-500/20 p-5">
                            <h4 className="font-bold text-sm text-violet-400 mb-2 flex items-center gap-2">
                              <BarChart3 className="w-4 h-4" /> {d.technicalAnalysis.title || 'Technical Analysis'}
                            </h4>
                            <p className="text-xs text-slate-400 mb-4">{d.technicalAnalysis.summary}</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {(d.technicalAnalysis.indicators || []).map((ind, i) => (
                                <div key={i} className={`rounded-lg border p-3 ${ind.signal === 'Bullish' ? 'bg-emerald-500/5 border-emerald-500/15' : ind.signal === 'Bearish' ? 'bg-red-500/5 border-red-500/15' : 'bg-slate-800/30 border-slate-700/20'}`}>
                                  <div className="flex items-center justify-between mb-1">
                                    <span className="text-xs font-semibold text-white">{ind.name}</span>
                                    <span className={`text-[10px] px-1.5 py-0.5 rounded-full font-bold ${ind.signal === 'Bullish' ? 'bg-emerald-500/20 text-emerald-400' : ind.signal === 'Bearish' ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-slate-400'}`}>{ind.signal}</span>
                                  </div>
                                  <div className="text-sm font-bold mb-1">{ind.value}</div>
                                  <p className="text-[11px] text-slate-400 leading-relaxed">{ind.explanation}</p>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* 2. Entry & Exit Strategy */}
                        {d.entryExit && (
                          <div className="bg-slate-900/50 rounded-2xl border border-cyan-500/20 p-5">
                            <h4 className="font-bold text-sm text-cyan-400 mb-3 flex items-center gap-2">
                              <Target className="w-4 h-4" /> {d.entryExit.title || 'Entry & Exit Strategy'}
                            </h4>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                              <div className="bg-slate-800/40 rounded-lg p-3">
                                <div className="text-[10px] text-slate-500">Order Type</div>
                                <div className="text-xs font-bold text-cyan-400">{d.entryExit.entryType || '—'}</div>
                              </div>
                              <div className="bg-slate-800/40 rounded-lg p-3">
                                <div className="text-[10px] text-slate-500">Entry Price</div>
                                <div className="text-xs font-bold text-white">{d.entryExit.entryPrice || '—'}</div>
                              </div>
                              <div className="bg-slate-800/40 rounded-lg p-3">
                                <div className="text-[10px] text-slate-500">Exit Target</div>
                                <div className="text-xs font-bold text-emerald-400">{d.entryExit.exitTarget || '—'}</div>
                              </div>
                              <div className="bg-slate-800/40 rounded-lg p-3">
                                <div className="text-[10px] text-slate-500">Position Size</div>
                                <div className="text-xs font-bold text-amber-400">{d.entryExit.positionSize || '—'}</div>
                              </div>
                            </div>
                            {d.entryExit.orderFlow && d.entryExit.orderFlow.length > 0 && (
                              <div className="bg-slate-800/30 rounded-lg p-3">
                                <div className="text-[10px] text-slate-500 mb-2 font-semibold">ORDER FLOW</div>
                                <div className="space-y-2">
                                  {d.entryExit.orderFlow.map((step, i) => (
                                    <div key={i} className="flex items-start gap-2 text-xs text-slate-300">
                                      <span className="text-cyan-400 font-bold mt-0.5">{i + 1}.</span>
                                      <span>{step}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* 3. Risk Assessment */}
                        {d.riskAssessment && (
                          <div className="bg-slate-900/50 rounded-2xl border border-amber-500/20 p-5">
                            <h4 className="font-bold text-sm text-amber-400 mb-3 flex items-center gap-2">
                              <Shield className="w-4 h-4" /> {d.riskAssessment.title || 'Risk Assessment'}
                              <span className={`ml-auto text-[10px] px-2 py-0.5 rounded-full font-bold ${d.riskAssessment.overallRisk === 'LOW' ? 'bg-emerald-500/20 text-emerald-400' : d.riskAssessment.overallRisk === 'HIGH' ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'}`}>{d.riskAssessment.overallRisk} RISK</span>
                            </h4>
                            {d.riskAssessment.maxLoss && (
                              <div className="text-xs text-slate-400 mb-3">Max potential loss: <span className="text-red-400 font-semibold">{d.riskAssessment.maxLoss}</span></div>
                            )}
                            {d.riskAssessment.risks && d.riskAssessment.risks.length > 0 && (
                              <div className="space-y-2 mb-4">
                                {d.riskAssessment.risks.map((risk, i) => (
                                  <div key={i} className={`rounded-lg border p-3 ${risk.severity === 'High' ? 'bg-red-500/5 border-red-500/15' : risk.severity === 'Medium' ? 'bg-amber-500/5 border-amber-500/15' : 'bg-slate-800/30 border-slate-700/20'}`}>
                                    <div className="flex items-center justify-between mb-1">
                                      <span className="text-xs font-semibold text-white">{risk.risk}</span>
                                      <span className={`text-[10px] font-bold ${risk.severity === 'High' ? 'text-red-400' : risk.severity === 'Medium' ? 'text-amber-400' : 'text-emerald-400'}`}>{risk.severity}</span>
                                    </div>
                                    <p className="text-[11px] text-slate-400">{risk.mitigation}</p>
                                  </div>
                                ))}
                              </div>
                            )}
                            {d.riskAssessment.warningSignals && d.riskAssessment.warningSignals.length > 0 && (
                              <div className="bg-slate-800/30 rounded-lg p-3">
                                <div className="text-[10px] text-slate-500 mb-2 font-semibold">WARNING SIGNALS TO WATCH</div>
                                {d.riskAssessment.warningSignals.map((sig, i) => (
                                  <div key={i} className="flex items-start gap-2 text-xs text-slate-300 mb-1">
                                    <AlertTriangle className="w-3 h-3 text-amber-400 mt-0.5 flex-shrink-0" />
                                    <span>{sig}</span>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        )}

                        {/* 4. Sector Context */}
                        {d.sectorContext && (
                          <div className="bg-slate-900/50 rounded-2xl border border-blue-500/20 p-5">
                            <h4 className="font-bold text-sm text-blue-400 mb-3 flex items-center gap-2">
                              <Globe className="w-4 h-4" /> {d.sectorContext.title || 'Sector & Market Context'}
                              {d.sectorContext.sectorTrend && (
                                <span className={`ml-auto text-[10px] px-2 py-0.5 rounded-full font-bold ${d.sectorContext.sectorTrend === 'Bullish' ? 'bg-emerald-500/20 text-emerald-400' : d.sectorContext.sectorTrend === 'Bearish' ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-slate-400'}`}>{d.sectorContext.sector} · {d.sectorContext.sectorTrend}</span>
                              )}
                            </h4>
                            {d.sectorContext.marketCondition && (
                              <p className="text-xs text-slate-300 mb-3 leading-relaxed">{d.sectorContext.marketCondition}</p>
                            )}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {d.sectorContext.catalysts && d.sectorContext.catalysts.length > 0 && (
                                <div className="bg-emerald-500/5 border border-emerald-500/15 rounded-lg p-3">
                                  <div className="text-[10px] text-emerald-400 mb-2 font-semibold">CATALYSTS</div>
                                  {d.sectorContext.catalysts.map((c, i) => (
                                    <div key={i} className="flex items-start gap-2 text-xs text-slate-300 mb-1">
                                      <span className="text-emerald-400">+</span> {c}
                                    </div>
                                  ))}
                                </div>
                              )}
                              {d.sectorContext.headwinds && d.sectorContext.headwinds.length > 0 && (
                                <div className="bg-red-500/5 border border-red-500/15 rounded-lg p-3">
                                  <div className="text-[10px] text-red-400 mb-2 font-semibold">HEADWINDS</div>
                                  {d.sectorContext.headwinds.map((h, i) => (
                                    <div key={i} className="flex items-start gap-2 text-xs text-slate-300 mb-1">
                                      <span className="text-red-400">−</span> {h}
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>
                          </div>
                        )}

                        {/* 5. Scenario Analysis */}
                        {d.scenarios && (
                          <div className="bg-slate-900/50 rounded-2xl border border-purple-500/20 p-5">
                            <h4 className="font-bold text-sm text-purple-400 mb-3 flex items-center gap-2">
                              <Layers className="w-4 h-4" /> {d.scenarios.title || 'Scenario Analysis'}
                            </h4>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                              {d.scenarios.bullCase && (
                                <div className="bg-emerald-500/5 border border-emerald-500/20 rounded-xl p-4">
                                  <div className="flex items-center justify-between mb-2">
                                    <span className="text-xs font-bold text-emerald-400">Bull Case</span>
                                    <span className="text-[10px] bg-emerald-500/20 text-emerald-400 px-1.5 py-0.5 rounded-full">{d.scenarios.bullCase.probability}</span>
                                  </div>
                                  <div className="text-lg font-bold text-emerald-400 mb-1">{d.scenarios.bullCase.target}</div>
                                  <p className="text-[11px] text-slate-400">{d.scenarios.bullCase.description}</p>
                                </div>
                              )}
                              {d.scenarios.baseCase && (
                                <div className="bg-blue-500/5 border border-blue-500/20 rounded-xl p-4">
                                  <div className="flex items-center justify-between mb-2">
                                    <span className="text-xs font-bold text-blue-400">Base Case</span>
                                    <span className="text-[10px] bg-blue-500/20 text-blue-400 px-1.5 py-0.5 rounded-full">{d.scenarios.baseCase.probability}</span>
                                  </div>
                                  <div className="text-lg font-bold text-blue-400 mb-1">{d.scenarios.baseCase.target}</div>
                                  <p className="text-[11px] text-slate-400">{d.scenarios.baseCase.description}</p>
                                </div>
                              )}
                              {d.scenarios.bearCase && (
                                <div className="bg-red-500/5 border border-red-500/20 rounded-xl p-4">
                                  <div className="flex items-center justify-between mb-2">
                                    <span className="text-xs font-bold text-red-400">Bear Case</span>
                                    <span className="text-[10px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded-full">{d.scenarios.bearCase.probability}</span>
                                  </div>
                                  <div className="text-lg font-bold text-red-400 mb-1">{d.scenarios.bearCase.target}</div>
                                  <p className="text-[11px] text-slate-400">{d.scenarios.bearCase.description}</p>
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })()}

                  {/* Analyze Another + Timestamp */}
                  <div className="flex items-center justify-between">
                    <button
                      onClick={() => { setQuickAnalysisResult(null); setQuickAnalysisDetail(null); setQuickAnalysisExpanded(false); setQuickAnalysisTicker(''); }}
                      className="px-4 py-2.5 bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/30 rounded-xl text-sm font-semibold transition-all flex items-center gap-2"
                    >
                      <Search className="w-4 h-4" /> Analyze Another Stock
                    </button>
                    {r.timestamp && (
                      <div className="text-[10px] text-slate-600 flex items-center gap-1">
                        <Clock className="w-3 h-3" /> Analyzed {new Date(r.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                      </div>
                    )}
                  </div>

                  {/* Disclaimer */}
                  <div className="text-[10px] text-slate-600 text-center px-4">
                    Quick Analysis uses real-time market data and AI. This is for educational purposes only — not financial advice. Always do your own research before trading.
                  </div>
                </div>
              );
            })()}

            {/* Error State */}
            {quickAnalysisResult?.error && !quickAnalysisLoading && (
              <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-6 text-center">
                <AlertTriangle className="w-8 h-8 text-red-400 mx-auto mb-3" />
                <h3 className="font-semibold text-red-400 mb-2">Analysis Failed</h3>
                <p className="text-sm text-slate-400">{quickAnalysisResult.message}</p>
                <button onClick={() => runQuickAnalysis(quickAnalysisResult.ticker)} className="mt-4 px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg font-semibold text-sm transition-all">
                  Try Again
                </button>
              </div>
            )}

            {/* History */}
            {quickAnalysisHistory.length > 0 && !quickAnalysisLoading && (
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h4 className="font-semibold text-slate-400 text-sm flex items-center gap-2">
                    <Clock className="w-3.5 h-3.5" /> Recent Analyses
                    <span className="text-[10px] bg-slate-700/60 text-slate-500 px-1.5 py-0.5 rounded-full">{quickAnalysisHistory.length}</span>
                  </h4>
                  {quickAnalysisHistory.length > 1 && (
                    <button onClick={() => { setQuickAnalysisHistory([]); setToast({ type: 'success', message: 'History cleared' }); }} className="text-[10px] text-slate-500 hover:text-red-400 transition-colors">Clear all</button>
                  )}
                </div>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                  {quickAnalysisHistory.map((h, i) => {
                    const isBuy = h.verdict?.includes('BUY');
                    const isSell = h.verdict?.includes('SELL');
                    return (
                      <button
                        key={`${h.ticker}-${i}`}
                        onClick={() => { setQuickAnalysisTicker(h.ticker); setQuickAnalysisResult(h); setQuickAnalysisDetail(null); }}
                        className={`bg-slate-800/40 border hover:border-violet-500/30 rounded-xl p-3 text-left transition-all group ${isBuy ? 'border-emerald-500/10' : isSell ? 'border-red-500/10' : 'border-slate-700/20'}`}
                      >
                        <div className="flex items-center justify-between mb-1.5">
                          <span className="font-bold text-sm group-hover:text-violet-300 transition-colors">{h.ticker}</span>
                          <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded-full ${isBuy ? 'bg-emerald-500/20 text-emerald-400' : isSell ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'}`}>{h.verdict}</span>
                        </div>
                        <div className="text-xs text-slate-500">${h.price?.toFixed(2)}</div>
                        <div className="mt-1.5 flex items-center justify-between">
                          <div className="w-full bg-slate-700/30 rounded-full h-1">
                            <div className={`h-full rounded-full ${isBuy ? 'bg-emerald-500' : isSell ? 'bg-red-500' : 'bg-amber-500'}`} style={{ width: `${h.confidence || 0}%` }} />
                          </div>
                          <span className="text-[9px] text-slate-500 ml-2 flex-shrink-0">{h.confidence}%</span>
                        </div>
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Empty State */}
            {!quickAnalysisResult && !quickAnalysisLoading && quickAnalysisHistory.length === 0 && (
              <div className="text-center py-12">
                <div className="relative inline-block mb-4">
                  <div className="absolute inset-0 bg-violet-500/20 blur-2xl rounded-full" />
                  <Zap className="w-16 h-16 text-slate-600 relative" />
                </div>
                <h3 className="text-xl font-semibold mb-2">Instant Stock Verdict</h3>
                <p className="text-slate-400 max-w-md mx-auto mb-6">
                  Enter any ticker above to get a real-time buy/sell/hold recommendation backed by live market data, technical indicators, and AI analysis.
                </p>
                <div className="flex flex-wrap justify-center gap-2 mb-6">
                  {['AAPL', 'TSLA', 'NVDA', 'MSFT', 'AMZN', 'META', 'GOOG', 'AMD'].map(sym => (
                    <button key={sym} onClick={() => { setQuickAnalysisTicker(sym); runQuickAnalysis(sym); }} className="px-3 py-1.5 text-xs font-semibold bg-slate-800/60 hover:bg-violet-500/20 border border-slate-700/20 hover:border-violet-500/30 rounded-lg text-slate-400 hover:text-violet-300 transition-all">
                      {sym}
                    </button>
                  ))}
                </div>
                <div className="text-xs text-slate-600 space-y-1">
                  <p>Powered by real-time prices, RSI, moving averages, volume analysis, and more.</p>
                  <p>Click "Tell Me More" after analysis for a deep-dive educational breakdown.</p>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Ask AI Tab */}
        {activeTab === "ask" && (
          <div className="max-w-4xl mx-auto">
            <div className="bg-slate-900/50 rounded-2xl border border-slate-800/50 p-6">
              <div className="flex items-center gap-3 mb-6">
                <div className="p-2.5 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl">
                  <MessageCircle className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h2 className="text-xl font-semibold">Trading Q&A Assistant</h2>
                  <p className="text-sm text-slate-400">Ask any trading or technical analysis question</p>
                </div>
              </div>

              <div className="mb-6">
                <textarea
                  value={question}
                  onChange={(e) => setQuestion(e.target.value)}
                  placeholder="Ask about technical analysis, trading strategies, risk management, chart patterns, indicators, market psychology, or any trading concept..."
                  className="w-full bg-slate-800/40 border border-slate-700/30 rounded-xl hover-lift px-4 py-4 min-h-[120px] text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/50 resize-none placeholder:text-slate-500"
                  maxLength={1000}
                />
                <div className="flex items-center justify-between mt-3">
                  <span className="text-xs text-slate-500">{question.length}/1000 characters</span>
                  <button
                    onClick={askQuestion}
                    disabled={loadingAnswer || question.length < 10}
                    className="px-6 py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 text-white rounded-xl font-semibold disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed flex items-center gap-2 shadow-lg"
                  >
                    {loadingAnswer ? (
                      <><Loader2 className="w-4 h-4 animate-spin" />Thinking...</>
                    ) : (
                      <><Send className="w-4 h-4" />Ask Question</>
                    )}
                  </button>
                </div>
              </div>

              {/* Error State for Q&A */}
              {analysisError && analysisError.includes('Q&A') && (
                <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-4">
                  <div className="flex items-start gap-3">
                    <AlertTriangle className="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" />
                    <div>
                      <p className="font-medium text-red-300">Unable to get AI response</p>
                      <p className="text-xs text-slate-400 mt-1">{analysisError}</p>
                      <p className="text-xs text-slate-500 mt-2">Make sure you have an API key configured in Settings, or try again later.</p>
                      <button
                        onClick={() => setAnalysisError(null)}
                        className="mt-2 text-xs text-red-400 hover:text-red-300"
                      >
                        Dismiss
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Enhanced Loading State */}
              {loadingAnswer && (
                <div className="bg-violet-500/10 border border-violet-500/30 rounded-xl p-4 mb-4">
                  <div className="flex items-center gap-3">
                    <div className="relative">
                      <Loader2 className="w-8 h-8 animate-spin text-violet-400" />
                      <div className="absolute inset-0 w-8 h-8 border-2 border-violet-500/20 rounded-full animate-ping" />
                    </div>
                    <div>
                      <p className="font-medium text-violet-300">AI is analyzing your question...</p>
                      <p className="text-xs text-slate-400 mt-1">This typically takes 3-8 seconds depending on complexity</p>
                    </div>
                  </div>
                </div>
              )}

              {answer && (
                <div className="bg-gradient-to-br from-violet-500/10 to-purple-500/5 border border-violet-500/20 rounded-xl overflow-hidden mb-6">
                  <div className="bg-violet-600/20 px-6 py-3 border-b border-violet-500/20">
                    <h4 className="font-semibold flex items-center gap-2 text-violet-200">
                      <Sparkles className="w-5 h-5 text-violet-400" />
                      AI Response
                    </h4>
                  </div>
                  <div className="p-6">
                    {/* Formatted response with markdown parsing */}
                    <div className="space-y-3 md:space-y-4">
                      {answer.split('\n\n').map((block, blockIdx) => {
                        const formatInline = (text) => text.split(/(\*\*[^*]+\*\*)/).map((part, i) => {
                          if (part.startsWith('**') && part.endsWith('**')) {
                            return <strong key={i} className="text-white font-semibold">{part.replace(/\*\*/g, '')}</strong>;
                          }
                          return part;
                        });

                        // Handle markdown ### headers
                        if (block.match(/^#{1,3}\s+/)) {
                          const headerText = block.replace(/^#{1,3}\s+/, '').replace(/\*\*/g, '');
                          return (
                            <h3 key={blockIdx} className="text-lg font-bold text-white flex items-center gap-2 mt-3">
                              <div className="w-1 h-5 bg-violet-500 rounded-full" />
                              {headerText}
                            </h3>
                          );
                        }

                        // Handle bold-only headers (lines starting AND ending with **)
                        if (block.startsWith('**') && block.endsWith('**') && !block.slice(2, -2).includes('**')) {
                          const headerText = block.replace(/\*\*/g, '');
                          return (
                            <h3 key={blockIdx} className="text-lg font-bold text-white flex items-center gap-2 mt-2">
                              <div className="w-1 h-5 bg-violet-500 rounded-full" />
                              {headerText}
                            </h3>
                          );
                        }

                        // Handle bullet or numbered lists
                        const hasListItems = block.includes('\n•') || block.includes('\n-') || block.startsWith('•') || block.startsWith('-') || /\n\d+[\.\)]\s/.test(block) || /^\d+[\.\)]\s/.test(block);
                        if (hasListItems) {
                          const lines = block.split('\n');
                          return (
                            <div key={blockIdx} className="space-y-2">
                              {lines.map((line, lineIdx) => {
                                const trimmed = line.trim();
                                // Bullet items
                                if (trimmed.startsWith('•') || trimmed.startsWith('-')) {
                                  const bulletText = trimmed.replace(/^[•-]\s*/, '');
                                  return (
                                    <div key={lineIdx} className="flex items-start gap-3 pl-2">
                                      <div className="w-1.5 h-1.5 rounded-full bg-violet-400 mt-2 flex-shrink-0" />
                                      <span className="text-slate-300 text-sm leading-relaxed">{formatInline(bulletText)}</span>
                                    </div>
                                  );
                                }
                                // Numbered items (1. or 1))
                                const numMatch = trimmed.match(/^(\d+)[\.\)]\s+(.*)/);
                                if (numMatch) {
                                  return (
                                    <div key={lineIdx} className="flex items-start gap-3 pl-2">
                                      <span className="text-xs font-bold text-violet-400 bg-violet-500/15 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">{numMatch[1]}</span>
                                      <span className="text-slate-300 text-sm leading-relaxed">{formatInline(numMatch[2])}</span>
                                    </div>
                                  );
                                }
                                if (trimmed) {
                                  return <p key={lineIdx} className="text-slate-200 font-medium">{formatInline(trimmed)}</p>;
                                }
                                return null;
                              })}
                            </div>
                          );
                        }

                        // Regular paragraph
                        return (
                          <p key={blockIdx} className="text-slate-300 text-sm leading-relaxed">
                            {formatInline(block)}
                          </p>
                        );
                      })}
                    </div>
                  </div>
                  <div className="bg-slate-800/30 px-6 py-3 border-t border-violet-500/10 flex items-center justify-between">
                    <span className="text-xs text-slate-500">Response from AI Assistant</span>
                    <button
                      onClick={() => setAnswer(null)}
                      className="text-xs text-slate-400 hover:text-slate-200 transition-colors whitespace-nowrap"
                    >
                      Clear
                    </button>
                  </div>
                </div>
              )}

              {qaHistory.length > 0 && (
                <div>
                  <h4 className="font-semibold mb-4 text-slate-400">Previous Questions</h4>
                  <div className="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                    {qaHistory.slice().reverse().map((item, i) => (
                      <div key={i} className="bg-slate-800/30 rounded-xl p-4 hover:bg-slate-800/50 transition-colors">
                        <p className="font-medium text-slate-200 mb-2">{item.q}</p>
                        <p className="text-xs text-slate-400 line-clamp-3">{(item.a || '').replace(/\*\*/g, '').replace(/#{1,3}\s+/g, '').replace(/[•●]\s*/g, '').slice(0, 200)}...</p>
                        <p className="text-xs text-slate-600 mt-2">{new Date(item.time).toLocaleString()}</p>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {!answer && qaHistory.length === 0 && (
                <div className="text-center py-12">
                  <MessageCircle className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                  <h3 className="text-xl font-semibold mb-2">Ask Anything About Trading</h3>
                  <p className="text-slate-400 max-w-md mx-auto mb-6">
                    Get detailed, educational explanations about technical analysis, trading strategies, risk management, and market concepts.
                  </p>
                  <div className="grid grid-cols-2 gap-3 max-w-lg mx-auto text-left">
                    <div className="bg-slate-800/30 rounded-lg p-3">
                      <p className="text-xs font-medium text-violet-400">Example questions:</p>
                    </div>
                    <div className="bg-slate-800/30 rounded-lg p-3">
                      <p className="text-xs text-slate-400">"What is RSI divergence?"</p>
                    </div>
                    <div className="bg-slate-800/30 rounded-lg p-3">
                      <p className="text-xs text-slate-400">"How to calculate position size?"</p>
                    </div>
                    <div className="bg-slate-800/30 rounded-lg p-3">
                      <p className="text-xs text-slate-400">"Explain head and shoulders pattern"</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Trading Journal Tab */}
        {activeTab === "journal" && (
          <div className="max-w-7xl mx-auto">
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 md:mb-4 gap-3 sm:gap-0">
              <div>
                <h2 className="text-2xl md:text-3xl font-bold flex items-center gap-3">
                  <Target className="w-7 md:w-8 h-7 md:h-8 text-violet-400" />
                  Trading Journal
                </h2>
                <p className="text-slate-400 text-xs md:text-sm mt-1">Track and analyze your trading performance</p>
              </div>
              <div className="flex gap-2 w-full sm:w-auto flex-col sm:flex-row">
                <button
                  onClick={openAddTrade}
                  className="bg-violet-600 hover:bg-violet-500 px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold transition-colors flex items-center gap-2 justify-center"
                >
                  <span>+</span>
                  <span>Add Trade</span>
                </button>
                {trades.length > 0 && (
                  <button
                    onClick={exportTradesToCSV}
                    className="bg-slate-700 hover:bg-slate-600 px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold transition-colors flex items-center gap-2 justify-center"
                  >
                    <Download className="w-5 h-5" />
                    <span>Export CSV</span>
                  </button>
                )}
              </div>
            </div>

            {/* Important Disclaimer */}
            <div className="mb-4 md:mb-6 px-3 md:px-4 py-2 md:py-3 bg-amber-500/10 border border-amber-500/30 rounded-lg flex items-start gap-3">
              <AlertTriangle className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" />
              <div className="text-sm">
                <span className="font-semibold text-amber-400">Paper Trading Only:</span>
                <span className="text-slate-300 ml-1">
                  This journal is for <span className="font-semibold">tracking and logging your trades only</span>.
                  It is NOT connected to any real brokerage account. No actual trades are executed.
                  Use this to practice, track performance, and improve your trading strategy.
                </span>
              </div>
            </div>

            {/* Journal Sub-tabs Navigation */}
            <div className="mb-6 flex gap-2 border-b border-slate-700">
              {[
                { id: 'log', label: 'Trade Log', icon: BookOpen },
                { id: 'analytics', label: 'Analytics', icon: BarChart2 },
                { id: 'monthlypl', label: 'Monthly P&L', icon: Calendar },
                { id: 'weeklyreport', label: 'Weekly Report', icon: Trophy },
                { id: 'mistakes', label: 'Mistakes', icon: AlertCircle }
              ].map(tab => {
                const TabIcon = tab.icon;
                return (
                  <button
                    key={tab.id}
                    onClick={() => setJournalSubTab(tab.id)}
                    className={`px-4 py-3 font-medium text-sm flex items-center gap-2 border-b-2 transition-colors ${
                      journalSubTab === tab.id
                        ? 'border-violet-500 text-violet-400'
                        : 'border-transparent text-slate-500 hover:text-slate-400'
                    }`}
                  >
                    <TabIcon className="w-4 h-4" />
                    {tab.label}
                  </button>
                );
              })}
            </div>

            {/* PERFORMANCE DASHBOARD (Log Sub-tab) */}
            {journalSubTab === 'log' && (
              <div>
                {trades.length > 0 && (
              <div className="mb-6 animate-fadeIn">
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                  <div className="p-3 bg-slate-800/40 rounded-xl border border-slate-700/20">
                    <div className="text-[10px] text-slate-500 uppercase tracking-wider mb-1">Win Rate</div>
                    <div className={`text-xl font-bold ${performanceMetrics.winRate >= 50 ? 'text-emerald-400' : 'text-red-400'}`}>
                      {performanceMetrics.winRate.toFixed(1)}%
                    </div>
                    <div className="text-[10px] text-slate-500">{performanceMetrics.wins}W / {performanceMetrics.losses}L</div>
                  </div>
                  <div className="p-3 bg-slate-800/40 rounded-xl border border-slate-700/20">
                    <div className="text-[10px] text-slate-500 uppercase tracking-wider mb-1">Total P&L</div>
                    <div className={`text-xl font-bold ${performanceMetrics.totalPnL >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                      {performanceMetrics.totalPnL >= 0 ? '+' : ''}{performanceMetrics.totalPnL < 1000 ? `$${performanceMetrics.totalPnL.toFixed(2)}` : `$${(performanceMetrics.totalPnL/1000).toFixed(1)}k`}
                    </div>
                    <div className="text-[10px] text-slate-500">{performanceMetrics.closedTrades || 0} closed trades</div>
                  </div>
                  <div className="p-3 bg-slate-800/40 rounded-xl border border-slate-700/20">
                    <div className="text-[10px] text-slate-500 uppercase tracking-wider mb-1">Profit Factor</div>
                    <div className={`text-xl font-bold ${performanceMetrics.profitFactor >= 1.5 ? 'text-emerald-400' : performanceMetrics.profitFactor >= 1 ? 'text-yellow-400' : 'text-red-400'}`}>
                      {performanceMetrics.profitFactor === Infinity ? '∞' : performanceMetrics.profitFactor.toFixed(2)}
                    </div>
                    <div className="text-[10px] text-slate-500">
                      {performanceMetrics.profitFactor >= 1.5 ? 'Excellent' : performanceMetrics.profitFactor >= 1 ? 'Break Even' : 'Needs Work'}
                    </div>
                  </div>
                  <div className="p-3 bg-slate-800/40 rounded-xl border border-slate-700/20">
                    <div className="text-[10px] text-slate-500 uppercase tracking-wider mb-1">Streak</div>
                    <div className={`text-xl font-bold ${performanceMetrics.streak > 0 ? 'text-emerald-400' : performanceMetrics.streak < 0 ? 'text-red-400' : 'text-slate-400'}`}>
                      {performanceMetrics.streak > 0 ? `${performanceMetrics.streak}W` : performanceMetrics.streak < 0 ? `${Math.abs(performanceMetrics.streak)}L` : '-'}
                    </div>
                    <div className="text-[10px] text-slate-500">
                      Avg hold: {performanceMetrics.avgHoldTime.toFixed(1)}d
                    </div>
                  </div>
                </div>

                {/* Quick stats bar */}
                <div className="flex flex-wrap items-center gap-4 px-4 py-2.5 bg-slate-800/20 rounded-lg text-xs text-slate-400">
                  <span>Avg Win: <span className="text-emerald-400 font-medium">${performanceMetrics.avgWin.toFixed(2)}</span></span>
                  <span>Avg Loss: <span className="text-red-400 font-medium">${performanceMetrics.avgLoss.toFixed(2)}</span></span>
                  {performanceMetrics.bestTrade && (
                    <span>Best: <span className="text-emerald-400 font-medium">{performanceMetrics.bestTrade.symbol} +${performanceMetrics.bestTrade.pnl?.toFixed(2) || '0'}</span></span>
                  )}
                  {performanceMetrics.sharpe !== 0 && (
                    <span className="relative group cursor-help">Sharpe: <span className={`font-medium ${performanceMetrics.sharpe >= 1 ? 'text-emerald-400' : 'text-yellow-400'}`}>{performanceMetrics.sharpe.toFixed(2)}</span>
                      <div className="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-3 bg-slate-800 border border-slate-600 rounded-lg shadow-2xl text-xs text-slate-300 z-50">
                        <div className="font-semibold text-violet-400 mb-1.5">Sharpe Ratio</div>
                        <p className="mb-2">Measures your risk-adjusted return. It tells you how much profit you're making per unit of risk taken.</p>
                        <div className="space-y-1 text-[10px]">
                          <div className="flex items-center gap-2"><span className="text-red-400">●</span> Below 1.0 = Needs improvement</div>
                          <div className="flex items-center gap-2"><span className="text-yellow-400">●</span> 1.0 – 2.0 = Good</div>
                          <div className="flex items-center gap-2"><span className="text-emerald-400">●</span> Above 2.0 = Excellent</div>
                        </div>
                        <div className="absolute top-full left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-800 border-r border-b border-slate-600 transform rotate-45 -mt-1"></div>
                      </div>
                    </span>
                  )}
                </div>

                {/* TRADE TIMELINE */}
                {trades.length > 1 && trades.some(t => t.entryDate) && (
                  <div className="mb-6 bg-slate-800/30 rounded-xl border border-slate-700/20 p-5">
                    <h3 className="text-sm font-bold mb-4 flex items-center gap-2">
                      <Clock className="w-4 h-4 text-violet-400" />
                      Trade Timeline
                    </h3>
                    <div className="relative">
                      {/* Timeline line */}
                      <div className="absolute top-4 left-0 right-0 h-0.5 bg-slate-700/50" />

                      {/* Trade markers */}
                      <div className="flex items-start justify-between gap-1 overflow-x-auto pb-4 relative">
                        {trades
                          .filter(t => t.entryDate)
                          .sort((a, b) => new Date(a.entryDate) - new Date(b.entryDate))
                          .slice(-20) // Show last 20 trades
                          .map((trade, i) => {
                            const entry = parseFloat(trade.entry) || 0;
                            const exit = parseFloat(trade.exit) || 0;
                            const isWin = trade.side === 'long' ? exit > entry : exit < entry;
                            const hasExit = exit > 0;
                            return (
                              <div key={trade.id || i} className="flex flex-col items-center min-w-[48px] group relative">
                                {/* Marker */}
                                <div className={`w-3 h-3 rounded-full border-2 z-10 transition-transform group-hover:scale-150 ${
                                  !hasExit ? 'bg-blue-500 border-blue-400 animate-pulse' :
                                  isWin ? 'bg-emerald-500 border-emerald-400' : 'bg-red-500 border-red-400'
                                }`} />
                                {/* Symbol */}
                                <span className="text-[9px] font-bold mt-1.5 text-slate-300">{trade.symbol}</span>
                                {/* Date */}
                                <span className="text-[8px] text-slate-600">{new Date(trade.entryDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                                {/* P&L on hover */}
                                {hasExit && (
                                  <span className={`text-[8px] font-medium ${isWin ? 'text-emerald-400' : 'text-red-400'}`}>
                                    {isWin ? '+' : ''}{trade.side === 'long' ? ((exit - entry) * (parseFloat(trade.quantity) || 1)).toFixed(0) : ((entry - exit) * (parseFloat(trade.quantity) || 1)).toFixed(0)}
                                  </span>
                                )}
                                {!hasExit && <span className="text-[8px] text-blue-400">Open</span>}
                              </div>
                            );
                          })}
                      </div>

                      {/* Legend */}
                      <div className="flex items-center gap-4 mt-2 text-[10px] text-slate-500">
                        <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-emerald-500" /> Win</span>
                        <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500" /> Loss</span>
                        <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse" /> Open</span>
                        <span className="ml-auto">Showing last {Math.min(20, trades.filter(t => t.entryDate).length)} trades</span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {trades.length === 0 ? (
              <div className="bg-slate-800/30 rounded-lg p-6 md:p-12 text-center">
                <Target className="w-12 md:w-16 h-12 md:h-16 text-slate-700 mx-auto mb-3 md:mb-4" />
                <h3 className="text-lg md:text-xl font-semibold mb-2">No Trades Yet</h3>
                <p className="text-slate-400 mb-4 md:mb-6">Start tracking your trades to improve your performance</p>
                <button
                  onClick={openAddTrade}
                  className="bg-violet-600 hover:bg-violet-500 px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold transition-colors"
                >
                  Add Your First Trade
                </button>
              </div>
            ) : (
              <>
                {/* Summary Stats */}
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-4 md:mb-6">
                  <div className="bg-slate-800/30 rounded-lg p-3 md:p-4 card-shine">
                    <div className="text-xs text-slate-500 mb-1">Total Trades</div>
                    <div className="text-2xl font-bold">{trades.length}</div>
                  </div>
                  <div className="bg-green-900/20 rounded-lg p-4">
                    <div className="text-xs text-slate-500 mb-1">Open</div>
                    <div className="text-2xl font-bold text-green-400">
                      {trades.filter(t => t.status === "open").length}
                    </div>
                  </div>
                  <div className="bg-blue-900/20 rounded-lg p-4">
                    <div className="text-xs text-slate-500 mb-1">Closed</div>
                    <div className="text-2xl font-bold text-blue-400">
                      {trades.filter(t => t.status === "closed").length}
                    </div>
                  </div>
                  <div className="bg-violet-900/20 rounded-lg p-4">
                    <div className="text-xs text-slate-500 mb-1">Win Rate</div>
                    <div className="text-2xl font-bold text-violet-400">
                      {trades.filter(t => t.status === "closed").length > 0
                        ? Math.round((trades.filter(t => t.pnl > 0).length / trades.filter(t => t.status === "closed").length) * 100)
                        : 0}%
                    </div>
                  </div>
                </div>

                {/* Trades Table */}
                <div className="bg-slate-800/30 rounded-lg overflow-hidden">
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-slate-900/50">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Symbol</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Side</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Shares</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Entry</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Exit</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">P&L</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Conf.</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Status</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Date</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-700">
                        {trades.map((trade) => (
                          <tr key={trade.id} className="hover:bg-slate-800/50">
                            <td className="px-4 py-3">
                              <div className="flex items-center gap-2">
                                <span className="font-semibold">{trade.symbol}</span>
                                {trade.isPaperTrade && (
                                  <span className="px-2 py-0.5 bg-blue-600/20 text-blue-400 text-xs rounded border border-blue-600/30">
                                    PAPER
                                  </span>
                                )}
                              </div>
                            </td>
                            <td className="px-4 py-3">
                              <span
                                className={`px-2 py-1 rounded text-xs cursor-help ${
                                  trade.side === "long" ? "bg-green-900/30 text-green-400" : "bg-red-900/30 text-red-400"
                                }`}
                                title={trade.side === "long"
                                  ? "LONG = Buy position. Profit when price rises."
                                  : "SHORT = Sell position. Profit when price falls."}
                              >
                                {trade.side.toUpperCase()}
                              </span>
                            </td>
                            <td className="px-4 py-3 font-medium">
                              {trade.quantity || 1}
                            </td>
                            <td className="px-4 py-3">
                              <div>
                                <div className="font-semibold">${(parseFloat(trade.entry) || 0).toFixed(2)}</div>
                                {trade.avgPrice && (
                                  <div className="text-xs text-slate-500">Avg: ${(parseFloat(trade.avgPrice) || 0).toFixed(2)}</div>
                                )}
                              </div>
                            </td>
                            <td className="px-4 py-3">
                              {trade.exit ? `$${(parseFloat(trade.exit) || 0).toFixed(2)}` : "-"}
                            </td>
                            <td className="px-4 py-3">
                              {trade.pnl !== null ? (
                                <span className={trade.pnl >= 0 ? "text-green-400" : "text-red-400"}>
                                  {trade.pnl >= 0 ? "+" : ""}${(trade.pnl || 0).toFixed(2)} ({(trade.pnlPercent || 0).toFixed(2)}%)
                                </span>
                              ) : (
                                "-"
                              )}
                            </td>
                            <td className="px-4 py-3">
                              {trade.confidence && trade.confidence !== "" ? (
                                <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                  (parseFloat(trade.confidence) || 0) >= 75 ? "bg-green-900/30 text-green-400" :
                                  (parseFloat(trade.confidence) || 0) >= 60 ? "bg-yellow-900/30 text-yellow-400" :
                                  "bg-slate-700 text-slate-300"
                                }`}>
                                  {trade.confidence}%
                                </span>
                              ) : (
                                <span className="text-slate-500">-</span>
                              )}
                            </td>
                            <td className="px-4 py-3">
                              <span className={`px-2 py-1 rounded text-xs ${
                                trade.status === "open" ? "bg-blue-900/30 text-blue-400" : "bg-slate-700 text-slate-300"
                              }`}>
                                {trade.status}
                              </span>
                            </td>
                            <td className="px-4 py-3 text-sm text-slate-400">
                              {new Date(trade.entryDate).toLocaleDateString()}
                            </td>
                            <td className="px-4 py-3">
                              <div className="flex items-center gap-2">
                                <button
                                  onClick={() => openEditTrade(trade)}
                                  className="text-violet-400 hover:text-violet-300 text-sm flex items-center gap-1"
                                  title="Edit trade"
                                >
                                  <Pencil className="w-3.5 h-3.5" />
                                  Edit
                                </button>
                                {/* Trade Replay (Feature 2) */}
                                {trade.exit && (
                                  <button
                                    onClick={() => { setReplayTrade({ ...trade, ticker: trade.symbol, entryPrice: trade.entry, exitPrice: trade.exit, shares: trade.quantity, direction: trade.side }); setTradeReplayOpen(true); }}
                                    className="text-cyan-400 hover:text-cyan-300 text-sm flex items-center gap-1"
                                    title="Replay trade"
                                  >
                                    <Activity className="w-3.5 h-3.5" />
                                    Replay
                                  </button>
                                )}
                                <button
                                  onClick={() => deleteTrade(trade.id)}
                                  className="text-red-400 hover:text-red-300 text-sm"
                                >
                                  Delete
                                </button>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </>
            )}
              </div>
            )}

            {/* ANALYTICS SUB-TAB */}
            {journalSubTab === 'analytics' && (
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="bg-slate-800/30 rounded-xl border border-slate-700/20 p-6">
                    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                      <BarChart2 className="w-5 h-5 text-violet-400" />
                      Win/Loss by Day
                    </h3>
                    {trades.length > 0 ? (
                      <div className="space-y-2">
                        {['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(day => {
                          const dayTrades = trades.filter(t => {
                            const d = new Date(t.entryDate || new Date());
                            return d.toLocaleDateString('en-US', { weekday: 'short' }) === day;
                          });
                          const wins = dayTrades.filter(t => t.pnl > 0).length;
                          const losses = dayTrades.filter(t => t.pnl < 0).length;
                          const total = wins + losses || 1;
                          return (
                            <div key={day} className="flex items-center gap-3">
                              <span className="w-10 text-xs font-medium text-slate-400">{day}</span>
                              <div className="flex-1 h-6 bg-slate-900/50 rounded overflow-hidden flex">
                                <div className="bg-emerald-500/60 h-full" style={{ width: `${(wins/total)*100}%` }} title={`${wins} wins`} />
                                <div className="bg-red-500/60 h-full" style={{ width: `${(losses/total)*100}%` }} title={`${losses} losses`} />
                              </div>
                              <span className="text-xs text-slate-400">{wins}W/{losses}L</span>
                            </div>
                          );
                        })}
                      </div>
                    ) : (
                      <p className="text-slate-400 text-sm">No trades data available</p>
                    )}
                  </div>

                  <div className="bg-slate-800/30 rounded-xl border border-slate-700/20 p-6">
                    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                      <Clock className="w-5 h-5 text-violet-400" />
                      Win/Loss by Hour
                    </h3>
                    {trades.length > 0 ? (
                      <div className="space-y-2">
                        {[9, 10, 11, 12, 13, 14, 15, 16].map(hour => {
                          const hourTrades = trades.filter(t => {
                            const d = new Date(t.entryDate || new Date());
                            return d.getHours() === hour;
                          });
                          const wins = hourTrades.filter(t => t.pnl > 0).length;
                          const losses = hourTrades.filter(t => t.pnl < 0).length;
                          const total = wins + losses || 1;
                          return (
                            <div key={hour} className="flex items-center gap-3">
                              <span className="w-12 text-xs font-medium text-slate-400">{hour}:00</span>
                              <div className="flex-1 h-5 bg-slate-900/50 rounded overflow-hidden flex">
                                <div className="bg-emerald-500/60 h-full" style={{ width: `${(wins/total)*100}%` }} />
                                <div className="bg-red-500/60 h-full" style={{ width: `${(losses/total)*100}%` }} />
                              </div>
                              <span className="text-xs text-slate-400 w-8 text-right">{wins}/{losses}</span>
                            </div>
                          );
                        })}
                      </div>
                    ) : (
                      <p className="text-slate-400 text-sm">No trades data available</p>
                    )}
                  </div>
                </div>

                <div className="bg-slate-800/30 rounded-xl border border-slate-700/20 p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <Timer className="w-5 h-5 text-violet-400" />
                    Trade Duration Stats
                  </h3>
                  {trades.length > 0 ? (
                    <div className="grid grid-cols-3 gap-4">
                      <div className="bg-slate-900/50 rounded-lg p-4">
                        <div className="text-xs text-slate-400 mb-1">Avg Hold Time</div>
                        <div className="text-2xl font-bold text-violet-400">
                          {performanceMetrics.avgHoldTime.toFixed(1)}d
                        </div>
                      </div>
                      <div className="bg-slate-900/50 rounded-lg p-4">
                        <div className="text-xs text-slate-400 mb-1">Shortest</div>
                        <div className="text-2xl font-bold text-blue-400">
                          {Math.min(...trades.filter(t => t.entryDate && t.exitDate).map(t => (new Date(t.exitDate) - new Date(t.entryDate)) / 86400000)).toFixed(2)}d
                        </div>
                      </div>
                      <div className="bg-slate-900/50 rounded-lg p-4">
                        <div className="text-xs text-slate-400 mb-1">Longest</div>
                        <div className="text-2xl font-bold text-orange-400">
                          {Math.max(...trades.filter(t => t.entryDate && t.exitDate).map(t => (new Date(t.exitDate) - new Date(t.entryDate)) / 86400000)).toFixed(2)}d
                        </div>
                      </div>
                    </div>
                  ) : (
                    <p className="text-slate-400 text-sm">No trades data available</p>
                  )}
                </div>
              </div>
            )}

            {/* MONTHLY P&L SUB-TAB */}
            {journalSubTab === 'monthlypl' && (
              <div className="space-y-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold flex items-center gap-2">
                    <Calendar className="w-5 h-5 text-violet-400" />
                    {plMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                  </h3>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setPlMonth(new Date(plMonth.getFullYear(), plMonth.getMonth() - 1))}
                      className="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                    >
                      Prev
                    </button>
                    <button
                      onClick={() => setPlMonth(new Date())}
                      className="px-3 py-1 bg-violet-600 hover:bg-violet-500 rounded text-sm"
                    >
                      Today
                    </button>
                    <button
                      onClick={() => setPlMonth(new Date(plMonth.getFullYear(), plMonth.getMonth() + 1))}
                      className="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                    >
                      Next
                    </button>
                  </div>
                </div>
                <div className="bg-slate-800/30 rounded-xl border border-slate-700/20 p-6">
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div className="bg-slate-900/50 rounded-lg p-4">
                      <div className="text-xs text-slate-400">Total P&L</div>
                      <div className="text-2xl font-bold text-emerald-400">$0.00</div>
                    </div>
                    <div className="bg-slate-900/50 rounded-lg p-4">
                      <div className="text-xs text-slate-400">Trading Days</div>
                      <div className="text-2xl font-bold text-blue-400">0</div>
                    </div>
                    <div className="bg-slate-900/50 rounded-lg p-4">
                      <div className="text-xs text-slate-400">Best Day</div>
                      <div className="text-2xl font-bold text-green-400">+$0.00</div>
                    </div>
                    <div className="bg-slate-900/50 rounded-lg p-4">
                      <div className="text-xs text-slate-400">Worst Day</div>
                      <div className="text-2xl font-bold text-red-400">-$0.00</div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* WEEKLY REPORT SUB-TAB */}
            {journalSubTab === 'weeklyreport' && (
              <div className="space-y-6">
                <div className="bg-slate-800/30 rounded-xl border border-slate-700/20 p-6">
                  <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                    <Trophy className="w-5 h-5 text-violet-400" />
                    This Week's Performance
                  </h3>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-slate-900/50 rounded-lg p-4">
                      <div className="text-xs text-slate-400 mb-2">Trades</div>
                      <div className="text-3xl font-bold">{weeklyReport.tradeCount}</div>
                    </div>
                    <div className="bg-slate-900/50 rounded-lg p-4">
                      <div className="text-xs text-slate-400 mb-2">Win Rate</div>
                      <div className="text-3xl font-bold text-emerald-400">{weeklyReport.winRate}%</div>
                    </div>
                    <div className="bg-slate-900/50 rounded-lg p-4">
                      <div className="text-xs text-slate-400 mb-2">Wins/Losses</div>
                      <div className="text-3xl font-bold">{weeklyReport.wins}/{weeklyReport.losses}</div>
                    </div>
                    <div className="bg-slate-900/50 rounded-lg p-4">
                      <div className="text-xs text-slate-400 mb-2">Total P&L</div>
                      <div className={`text-3xl font-bold ${parseFloat(weeklyReport.totalPnL) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                        ${weeklyReport.totalPnL}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* MISTAKES SUB-TAB */}
            {journalSubTab === 'mistakes' && (
              <div className="space-y-6">
                <div className="bg-slate-800/30 rounded-xl border border-slate-700/20 p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <AlertCircle className="w-5 h-5 text-violet-400" />
                    Trading Mistakes Tracker
                  </h3>
                  {tradeMistakes.length > 0 ? (
                    <div className="space-y-3">
                      {tradeMistakes.map((mistake, idx) => (
                        <div key={idx} className="bg-slate-900/50 rounded-lg p-4 border border-slate-700/30">
                          <div className="flex items-start justify-between mb-2">
                            <div>
                              <div className="font-semibold text-violet-400">{mistake.category || 'General'}</div>
                              <div className="text-sm text-slate-300 mt-1">{mistake.description}</div>
                            </div>
                            <span className="text-xs text-slate-500">{new Date(mistake.date).toLocaleDateString()}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-slate-400 text-sm">No mistakes recorded yet. Great job!</p>
                  )}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Backtesting Tab */}
        {activeTab === "backtest" && (
          <div className="max-w-5xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-3xl font-bold flex items-center gap-3">
                <Activity className="w-8 h-8 text-violet-400" />
                Backtest Analysis
              </h2>
              <button
                onClick={calculateBacktest}
                className="bg-violet-600 hover:bg-violet-500 px-6 py-3 rounded-lg font-semibold transition-colors flex items-center gap-2"
              >
                <RefreshCw className="w-5 h-5" />
                <span>Run Backtest</span>
              </button>
            </div>

            <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-6 mb-6">
              <h3 className="font-semibold text-blue-300 mb-2">📊 What is Backtesting?</h3>
              <p className="text-sm text-blue-200 mb-3">
                Backtesting analyzes your historical analyses to calculate win rate, average returns, and prediction accuracy. 
                This helps you understand how well the AI's recommendations perform over time.
              </p>
              <p className="text-xs text-blue-300">
                <strong>Data Source:</strong> Your analysis history ({analysisHistory.length} analyses saved)
              </p>
            </div>

            {analysisHistory.length === 0 ? (
              <div className="bg-slate-800/30 rounded-lg p-12 text-center">
                <Activity className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">No Data to Backtest</h3>
                <p className="text-slate-400 mb-6">
                  Analyze some charts first to build your history, then run backtests to measure accuracy
                </p>
              </div>
            ) : !backtestResults ? (
              <div className="bg-slate-800/30 rounded-lg p-12 text-center">
                <Activity className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">Ready to Backtest</h3>
                <p className="text-slate-400 mb-6">
                  Click "Run Backtest" to analyze your {analysisHistory.length} saved analyses
                </p>
                <button
                  onClick={calculateBacktest}
                  className="bg-violet-600 hover:bg-violet-500 px-8 py-3 rounded-lg font-semibold transition-colors"
                >
                  Run Backtest Now
                </button>
              </div>
            ) : (
              <div className="space-y-4 md:space-y-6">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-slate-800/30 rounded-lg p-6">
                    <div className="text-xs text-slate-500 mb-2">Total Analyses</div>
                    <div className="text-4xl font-bold">{backtestResults.totalAnalyses}</div>
                  </div>
                  <div className="bg-green-900/20 rounded-lg p-6">
                    <div className="text-xs text-slate-500 mb-2">Wins</div>
                    <div className="text-4xl font-bold text-green-400">{backtestResults.wins}</div>
                  </div>
                  <div className="bg-red-900/20 rounded-lg p-6">
                    <div className="text-xs text-slate-500 mb-2">Losses</div>
                    <div className="text-4xl font-bold text-red-400">{backtestResults.losses}</div>
                  </div>
                  <div className="bg-violet-900/20 rounded-lg p-6">
                    <div className="text-xs text-slate-500 mb-2">Win Rate</div>
                    <div className="text-4xl font-bold text-violet-400">{backtestResults.winRate}%</div>
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-4">
                  <div className="bg-slate-800/30 rounded-lg p-6">
                    <div className="text-xs text-slate-500 mb-2">Avg Return</div>
                    <div className="text-3xl font-bold text-green-400">+{backtestResults.avgReturn}%</div>
                  </div>
                  <div className="bg-slate-800/30 rounded-lg p-6">
                    <div className="text-xs text-slate-500 mb-2">Best Trade</div>
                    <div className="text-3xl font-bold text-green-400">+{backtestResults.bestTrade}%</div>
                  </div>
                  <div className="bg-slate-800/30 rounded-lg p-6">
                    <div className="text-xs text-slate-500 mb-2">Worst Trade</div>
                    <div className="text-3xl font-bold text-red-400">{backtestResults.worstTrade}%</div>
                  </div>
                </div>

                <div className="bg-slate-800/30 rounded-lg p-6">
                  <h3 className="font-semibold mb-4">Signal Distribution</h3>
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <div className="text-sm text-slate-400 mb-1">Buy Signals</div>
                      <div className="text-2xl font-bold text-green-400">{backtestResults.buySignals}</div>
                    </div>
                    <div>
                      <div className="text-sm text-slate-400 mb-1">Sell Signals</div>
                      <div className="text-2xl font-bold text-red-400">{backtestResults.sellSignals}</div>
                    </div>
                    <div>
                      <div className="text-sm text-slate-400 mb-1">Hold Signals</div>
                      <div className="text-2xl font-bold text-yellow-400">{backtestResults.holdSignals}</div>
                    </div>
                  </div>
                </div>

                <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-yellow-200">
                    <strong>Note:</strong> This is a simulated backtest. In production, you would track actual trade outcomes 
                    to calculate real accuracy metrics.
                  </p>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Portfolio Tab */}
        {activeTab === "portfolio" && (
          <div className="max-w-7xl mx-auto">
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-3 sm:gap-0">
              <h2 className="text-2xl md:text-3xl font-bold flex items-center gap-3">
                <DollarSign className="w-7 md:w-8 h-7 md:h-8 text-violet-400" />
                Portfolio Tracker
              </h2>
              <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 md:gap-4 w-full sm:w-auto">
                {/* Live Price Update Controls */}
                {portfolio.length > 0 && (
                  <div className="flex items-center gap-2 md:gap-3 bg-slate-800/50 rounded-lg px-3 md:px-4 py-2">
                    <div className="flex items-center gap-2">
                      <div className={`w-2 h-2 rounded-full ${portfolioAutoRefresh ? 'bg-green-400 animate-pulse' : 'bg-slate-500'}`} />
                      <span className="text-sm text-slate-400">Live Prices</span>
                    </div>
                    <button
                      onClick={() => setPortfolioAutoRefresh(!portfolioAutoRefresh)}
                      className={`px-3 py-1 rounded text-xs font-medium transition-colors ${
                        portfolioAutoRefresh
                          ? 'bg-green-600/20 text-green-400 border border-green-600/30'
                          : 'bg-slate-700 text-slate-400 border border-slate-600'
                      }`}
                    >
                      {portfolioAutoRefresh ? 'ON' : 'OFF'}
                    </button>
                    <button
                      onClick={updatePortfolioLivePrices}
                      disabled={portfolioUpdating}
                      className="p-1.5 bg-violet-600/20 hover:bg-violet-600/30 rounded text-violet-400 transition-colors disabled:opacity-50"
                      title="Refresh prices now"
                    >
                      <RefreshCw className={`w-4 h-4 ${portfolioUpdating ? 'animate-spin' : ''}`} />
                    </button>
                    {portfolioLastUpdate && (
                      <span className="text-xs text-slate-500">
                        Updated: {portfolioLastUpdate.toLocaleTimeString()}
                      </span>
                    )}
                  </div>
                )}
                <button
                  onClick={() => setShowAddPosition(true)}
                  className="bg-violet-600 hover:bg-violet-500 px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold transition-colors flex items-center gap-2 w-full sm:w-auto justify-center sm:justify-start"
                >
                  <span>+</span>
                  <span>Add Position</span>
                </button>
              </div>
            </div>

            {portfolio.length === 0 ? (
              <div className="bg-slate-800/30 rounded-lg p-6 md:p-12 text-center">
                <DollarSign className="w-12 md:w-16 h-12 md:h-16 text-slate-700 mx-auto mb-3 md:mb-4" />
                <h3 className="text-lg md:text-xl font-semibold mb-2">No Positions Yet</h3>
                <p className="text-slate-400 mb-4 md:mb-6">Track your holdings and monitor performance</p>
                <button
                  onClick={() => setShowAddPosition(true)}
                  className="bg-violet-600 hover:bg-violet-500 px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold transition-colors"
                >
                  Add Your First Position
                </button>
              </div>
            ) : (
              <>
                {/* Portfolio Summary */}
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-3 md:gap-4 mb-4 md:mb-6">
                  <div className="bg-slate-800/30 rounded-lg p-3 md:p-4 card-shine">
                    <div className="text-xs text-slate-500 mb-1">Total Positions</div>
                    <div className="text-2xl font-bold">{portfolio.length}</div>
                  </div>
                  <div className="bg-slate-800/30 rounded-lg p-4">
                    <div className="text-xs text-slate-500 mb-1">Total Shares</div>
                    <div className="text-2xl font-bold">{portfolio.reduce((sum, p) => sum + (p.quantity || 0), 0).toLocaleString()}</div>
                  </div>
                  <div className="bg-slate-800/30 rounded-lg p-4">
                    <div className="text-xs text-slate-500 mb-1">Total Value</div>
                    <div className="text-2xl font-bold">
                      ${portfolio.reduce((sum, p) => sum + (p.totalValue || 0), 0).toFixed(2)}
                    </div>
                  </div>
                  <div className="bg-slate-800/30 rounded-lg p-4">
                    <div className="text-xs text-slate-500 mb-1">Total Cost</div>
                    <div className="text-2xl font-bold">
                      ${portfolio.reduce((sum, p) => sum + (p.totalCost || 0), 0).toFixed(2)}
                    </div>
                  </div>
                  <div className="bg-slate-800/30 rounded-lg p-4">
                    <div className="text-xs text-slate-500 mb-1">Total P&L</div>
                    <div className={`text-2xl font-bold ${
                      portfolio.reduce((sum, p) => sum + (p.pnl || 0), 0) >= 0 ? "text-green-400" : "text-red-400"
                    }`}>
                      {portfolio.reduce((sum, p) => sum + (p.pnl || 0), 0) >= 0 ? "+" : ""}
                      ${portfolio.reduce((sum, p) => sum + (p.pnl || 0), 0).toFixed(2)}
                    </div>
                  </div>
                </div>

                {/* Positions Table */}
                <div className="bg-slate-800/30 rounded-lg overflow-hidden">
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-slate-900/50">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Symbol</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Shares</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Avg Cost</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Current Price</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Value</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">P&L</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">P&L %</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-700">
                        {portfolio.map((position) => (
                          <tr key={position.id} className="hover:bg-slate-800/50">
                            <td className="px-4 py-3 font-semibold">{position.symbol}</td>
                            <td className="px-4 py-3 font-medium">{position.quantity} <span className="text-slate-500 text-xs">shares</span></td>
                            <td className="px-4 py-3">${(position.avgPrice || 0).toFixed(2)}</td>
                            <td className="px-4 py-3">
                              <input
                                type="number"
                                step="0.01"
                                value={position.currentPrice || 0}
                                onChange={(e) => updatePositionPrice(position.id, e.target.value)}
                                className="w-24 bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm"
                              />
                            </td>
                            <td className="px-4 py-3">${(position.totalValue || 0).toFixed(2)}</td>
                            <td className="px-4 py-3">
                              <span className={(position.pnl || 0) >= 0 ? "text-green-400" : "text-red-400"}>
                                {(position.pnl || 0) >= 0 ? "+" : ""}${(position.pnl || 0).toFixed(2)}
                              </span>
                            </td>
                            <td className="px-4 py-3">
                              <span className={(position.pnlPercent || 0) >= 0 ? "text-green-400" : "text-red-400"}>
                                {(position.pnlPercent || 0) >= 0 ? "+" : ""}{(position.pnlPercent || 0).toFixed(2)}%
                              </span>
                            </td>
                            <td className="px-4 py-3">
                              <div className="flex items-center gap-2">
                                <button
                                  onClick={() => openEditPosition(position)}
                                  className="text-violet-400 hover:text-violet-300 text-sm flex items-center gap-1"
                                  title="Edit position"
                                >
                                  <Pencil className="w-3.5 h-3.5" />
                                  Edit
                                </button>
                                <button
                                  onClick={() => deletePosition(position.id)}
                                  className="text-red-400 hover:text-red-300 text-sm"
                                >
                                  Remove
                                </button>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </>
            )}
          </div>
        )}

        {/* MARKET OVERVIEW TAB */}
        {activeTab === "marketoverview" && (
          <div className="max-w-7xl mx-auto space-y-4 md:space-y-6">
            {/* Header */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0">
              <div>
                <h2 className="text-2xl md:text-3xl font-bold flex items-center gap-3">
                  <BarChart3 className="w-7 md:w-8 h-7 md:h-8 text-violet-400" />
                  Market Overview
                </h2>
                <p className="text-xs md:text-sm text-slate-400 mt-1">Real-time market indices, sectors & sentiment</p>
              </div>
              <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 md:gap-4 w-full sm:w-auto">
                {/* Market Status */}
                <div className={`px-3 md:px-4 py-2 rounded-lg font-semibold flex items-center gap-2 whitespace-nowrap ${
                  marketData.marketStatus === 'open' ? 'bg-green-600/20 text-green-400 border border-green-500/30' :
                  marketData.marketStatus === 'pre-market' ? 'bg-blue-600/20 text-blue-400 border border-blue-500/30' :
                  marketData.marketStatus === 'after-hours' ? 'bg-amber-600/20 text-amber-400 border border-amber-500/30' :
                  'bg-slate-700/50 text-slate-400 border border-slate-600'
                }`}>
                  <div className={`w-2 h-2 rounded-full ${
                    marketData.marketStatus === 'open' ? 'bg-green-400 animate-pulse' :
                    marketData.marketStatus === 'pre-market' || marketData.marketStatus === 'after-hours' ? 'bg-amber-400' :
                    'bg-slate-500'
                  }`} />
                  {marketData.marketStatus === 'open' ? 'Market Open' :
                   marketData.marketStatus === 'pre-market' ? 'Pre-Market' :
                   marketData.marketStatus === 'after-hours' ? 'After Hours' : 'Market Closed'}
                </div>

                {/* Refresh Controls */}
                <div className="flex items-center gap-2 bg-slate-800/50 rounded-lg px-3 py-2">
                  <button
                    onClick={() => setMarketAutoRefresh(!marketAutoRefresh)}
                    className={`px-3 py-1 rounded text-xs font-medium ${
                      marketAutoRefresh
                        ? 'bg-green-600/20 text-green-400 border border-green-600/30'
                        : 'bg-slate-700 text-slate-400'
                    }`}
                  >
                    Auto: {marketAutoRefresh ? 'ON' : 'OFF'}
                  </button>
                  <button
                    onClick={fetchMarketOverview}
                    disabled={loadingMarketData}
                    className="p-1.5 bg-violet-600/20 hover:bg-violet-600/30 rounded text-violet-400 disabled:opacity-50"
                  >
                    <RefreshCw className={`w-4 h-4 ${loadingMarketData ? 'animate-spin' : ''}`} />
                  </button>
                </div>
              </div>
            </div>

            {/* Major Indices */}
            {loadingMarketData ? (
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2 md:gap-4">
                {Array.from({ length: 4 }).map((_, i) => (
                  <div key={i} className="bg-slate-800/30 rounded-xl p-3 md:p-5 border border-slate-700/20 space-y-3">
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <SkeletonBlock height="20px" width="60px" rounded="rounded-md" className="mb-2" />
                        <SkeletonBlock height="12px" width="80px" rounded="rounded" />
                      </div>
                      <SkeletonBlock height="20px" width="20px" rounded="rounded-md" />
                    </div>
                    <SkeletonBlock height="28px" width="100%" rounded="rounded-md" />
                    <SkeletonBlock height="14px" width="80%" rounded="rounded" />
                  </div>
                ))}
              </div>
            ) : (
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2 md:gap-4">
                {[
                  { symbol: 'SPY', name: 'S&P 500', data: marketData.indices.SPY },
                  { symbol: 'QQQ', name: 'NASDAQ 100', data: marketData.indices.QQQ },
                  { symbol: 'DIA', name: 'Dow Jones', data: marketData.indices.DIA },
                  { symbol: 'IWM', name: 'Russell 2000', data: marketData.indices.IWM }
                ].map(index => (
                <div
                  key={index.symbol}
                  className={`${
                    index.data.changePercent >= 0
                      ? 'card-gain'
                      : 'card-loss'
                  } rounded-xl p-3 md:p-5 hover-lift cursor-pointer`}
                  onClick={() => {
                    setTickerSymbol(index.symbol);
                    setActiveTab("ticker");
                  }}
                >
                  <div className="flex justify-between items-start mb-3">
                    <div>
                      <div className="text-lg font-bold">{index.symbol}</div>
                      <div className="text-xs text-slate-400">{index.name}</div>
                    </div>
                    {index.data.changePercent >= 0 ? (
                      <TrendingUp className="w-5 h-5 text-emerald-400" />
                    ) : (
                      <TrendingDown className="w-5 h-5 text-red-400" />
                    )}
                  </div>
                  <div className="text-2xl font-bold mb-1">
                    ${index.data.price?.toFixed(2) || '---'}
                  </div>
                  <div className={`text-sm font-medium ${
                    index.data.changePercent >= 0 ? 'text-emerald-400' : 'text-red-400'
                  }`}>
                    {index.data.changePercent >= 0 ? '+' : ''}{index.data.changePercent?.toFixed(2) || '0.00'}%
                    <span className="text-slate-500 ml-2">
                      ({index.data.change >= 0 ? '+' : ''}${index.data.change?.toFixed(2) || '0.00'})
                    </span>
                  </div>
                </div>
              ))}
              </div>
            )}

            {/* VIX & Market Sentiment */}
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 md:gap-4">
              {/* VIX Card */}
              <div className={`bg-gradient-to-br ${
                !marketData.vix.price ? 'from-slate-900/30 to-slate-800/20 border-slate-500/40' :
                marketData.vix.price > 30 ? 'from-red-900/30 to-red-800/20 border-red-500/40' :
                marketData.vix.price > 20 ? 'from-amber-900/30 to-amber-800/20 border-amber-500/40' :
                'from-emerald-900/30 to-emerald-800/20 border-emerald-500/40'
              } border rounded-xl p-3 md:p-5`}>
                <div className="flex justify-between items-start mb-3">
                  <div>
                    <div className="text-lg font-bold">VIX</div>
                    <div className="text-xs text-slate-400">
                      Volatility Index {marketData.vix.isFallback && <span className="text-amber-400">(est.)</span>}
                    </div>
                  </div>
                  {!marketData.vix.price ? (
                    <div className="w-5 h-5 border-2 border-slate-400 border-t-transparent rounded-full animate-spin" />
                  ) : (
                    <Activity className={`w-5 h-5 ${
                      marketData.vix.price > 30 ? 'text-red-400' :
                      marketData.vix.price > 20 ? 'text-amber-400' : 'text-emerald-400'
                    }`} />
                  )}
                </div>
                <div className="text-3xl font-bold mb-2">
                  {marketData.vix.price ? marketData.vix.price.toFixed(2) : (
                    <span className="text-slate-400 text-xl">Loading...</span>
                  )}
                </div>
                <div className={`text-sm font-semibold px-3 py-1 rounded-full inline-block ${
                  !marketData.vix.price ? 'bg-slate-500/20 text-slate-300' :
                  marketData.vix.price > 30 ? 'bg-red-500/20 text-red-300' :
                  marketData.vix.price > 20 ? 'bg-amber-500/20 text-amber-300' :
                  marketData.vix.price > 15 ? 'bg-green-500/20 text-green-300' :
                  'bg-emerald-500/20 text-emerald-300'
                }`}>
                  {!marketData.vix.price ? '⏳ Fetching...' :
                   marketData.vix.price > 30 ? '😨 Extreme Fear' :
                   marketData.vix.price > 25 ? '😰 High Fear' :
                   marketData.vix.price > 20 ? '😟 Elevated' :
                   marketData.vix.price > 15 ? '😐 Normal' : '😊 Low / Complacent'}
                </div>
              </div>

              {/* Market Breadth Card */}
              <div className="bg-slate-800/40 border border-slate-700/30 rounded-xl hover-lift p-3 md:p-5">
                <div className="text-lg font-bold mb-1">Market Breadth</div>
                <div className="text-xs text-slate-400 mb-4">Based on sector performance</div>

                {(() => {
                  const sectors = Object.values(marketData.sectors);
                  const advancing = sectors.filter(s => s.changePercent > 0).length;
                  const declining = sectors.filter(s => s.changePercent < 0).length;
                  const unchanged = sectors.length - advancing - declining;

                  return (
                    <>
                      <div className="flex gap-2 mb-3">
                        <div className="flex-1 bg-emerald-600/20 rounded-lg p-3 text-center">
                          <div className="text-2xl font-bold text-emerald-400">{advancing}</div>
                          <div className="text-xs text-slate-400">Advancing</div>
                        </div>
                        <div className="flex-1 bg-slate-700/50 rounded-lg p-3 text-center">
                          <div className="text-2xl font-bold text-slate-400">{unchanged}</div>
                          <div className="text-xs text-slate-400">Unchanged</div>
                        </div>
                        <div className="flex-1 bg-red-600/20 rounded-lg p-3 text-center">
                          <div className="text-2xl font-bold text-red-400">{declining}</div>
                          <div className="text-xs text-slate-400">Declining</div>
                        </div>
                      </div>
                      <div className="h-2 bg-slate-700 rounded-full overflow-hidden flex">
                        <div
                          className="bg-emerald-500 transition-all"
                          style={{ width: `${(advancing / sectors.length) * 100}%` }}
                        />
                        <div
                          className="bg-slate-500 transition-all"
                          style={{ width: `${(unchanged / sectors.length) * 100}%` }}
                        />
                        <div
                          className="bg-red-500 transition-all"
                          style={{ width: `${(declining / sectors.length) * 100}%` }}
                        />
                      </div>
                    </>
                  );
                })()}
              </div>

              {/* Quick Stats */}
              <div className="bg-slate-800/40 border border-slate-700/30 rounded-xl hover-lift p-3 md:p-5">
                <div className="text-lg font-bold mb-3">Session Info</div>
                <div className="space-y-2 md:space-y-3">
                  <div className="flex justify-between">
                    <span className="text-slate-400">Last Update:</span>
                    <span className="font-medium">
                      {marketData.lastUpdate?.toLocaleTimeString() || 'Never'}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-400">Trading Day:</span>
                    <span className="font-medium">
                      {new Date().toLocaleDateString('en-US', { weekday: 'long' })}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-slate-400">Next Open:</span>
                    <span className="font-medium">
                      {marketData.marketStatus === 'open' ? 'Now' :
                       marketData.marketStatus === 'pre-market' ? '9:30 AM ET' :
                       getNextTradingDay()}
                    </span>
                  </div>
                  <button
                    onClick={fetchMarketOverview}
                    disabled={loadingMarketData}
                    className="w-full mt-2 bg-violet-600 hover:bg-violet-500 disabled:opacity-50 py-2 rounded-lg font-medium text-sm flex items-center justify-center gap-2"
                  >
                    <RefreshCw className={`w-4 h-4 ${loadingMarketData ? 'animate-spin' : ''}`} />
                    Refresh Data
                  </button>
                </div>
              </div>
            </div>

            {/* Sector Performance Heatmap */}
            <div className="bg-slate-900/50 border border-slate-800/50 rounded-xl p-6">
              <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                <PieChart className="w-5 h-5 text-violet-400" />
                Sector Performance
              </h3>
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                {Object.entries(marketData.sectors).map(([symbol, sector]) => (
                  <div
                    key={symbol}
                    className={`rounded-lg p-4 cursor-pointer transition-all hover:scale-105 ${
                      sector.changePercent > 1.5 ? 'bg-emerald-600/40 border border-emerald-500/50' :
                      sector.changePercent > 0.5 ? 'bg-emerald-600/25 border border-emerald-500/30' :
                      sector.changePercent > 0 ? 'bg-emerald-600/15 border border-emerald-500/20' :
                      sector.changePercent > -0.5 ? 'bg-red-600/15 border border-red-500/20' :
                      sector.changePercent > -1.5 ? 'bg-red-600/25 border border-red-500/30' :
                      'bg-red-600/40 border border-red-500/50'
                    }`}
                    onClick={() => {
                      setTickerSymbol(symbol);
                      setActiveTab("ticker");
                    }}
                  >
                    <div className="text-xs text-slate-300 mb-1 truncate">{sector.name}</div>
                    <div className="font-bold text-sm">{symbol}</div>
                    <div className={`text-lg font-bold ${
                      sector.changePercent >= 0 ? 'text-emerald-400' : 'text-red-400'
                    }`}>
                      {sector.changePercent >= 0 ? '+' : ''}{sector.changePercent?.toFixed(2) || '0.00'}%
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* SECTOR ROTATION TRACKER */}
            <div className="mt-6 bg-slate-800/30 rounded-xl border border-slate-700/20 p-5">
              <h3 className="text-lg font-bold mb-1 flex items-center gap-2">
                <Activity className="w-5 h-5 text-violet-400" />
                Sector Rotation
              </h3>
              <p className="text-xs text-slate-500 mb-4">Relative performance across sectors — green = money flowing in, red = money flowing out</p>

              {/* Rotation bar chart */}
              <div className="space-y-2">
                {Object.entries(marketData.sectors)
                  .sort((a, b) => (b[1].changePercent || 0) - (a[1].changePercent || 0))
                  .map(([symbol, sector]) => {
                    const change = sector.changePercent || 0;
                    const maxChange = Math.max(...Object.values(marketData.sectors).map(s => Math.abs(s.changePercent || 0)), 1);
                    const barWidth = Math.min(Math.abs(change) / maxChange * 100, 100);
                    const isPositive = change >= 0;

                    return (
                      <div key={symbol} className="flex items-center gap-3 group hover:bg-slate-800/40 rounded-lg px-2 py-1.5 transition-colors">
                        <div className="w-28 text-xs text-slate-400 font-medium truncate">{sector.name}</div>
                        <div className="flex-1 h-6 bg-slate-900/50 rounded relative overflow-hidden">
                          {/* Center line */}
                          <div className="absolute left-1/2 top-0 bottom-0 w-px bg-slate-700" />
                          {/* Bar */}
                          <div
                            className={`absolute top-0.5 bottom-0.5 rounded transition-all duration-500 ${
                              isPositive ? 'bg-emerald-500/60 left-1/2' : 'bg-red-500/60 right-1/2'
                            }`}
                            style={{ width: `${barWidth / 2}%` }}
                          />
                        </div>
                        <div className={`w-16 text-right text-xs font-bold tabular-nums ${
                          isPositive ? 'text-emerald-400' : 'text-red-400'
                        }`}>
                          {isPositive ? '+' : ''}{change.toFixed(2)}%
                        </div>
                      </div>
                    );
                  })}
              </div>

              {/* Rotation summary */}
              <div className="mt-4 pt-3 border-t border-slate-700/30 flex flex-wrap gap-4 text-xs">
                {(() => {
                  const sectors = Object.values(marketData.sectors);
                  const advancing = sectors.filter(s => (s.changePercent || 0) > 0).length;
                  const declining = sectors.length - advancing;
                  const avgChange = sectors.reduce((sum, s) => sum + (s.changePercent || 0), 0) / (sectors.length || 1);
                  const bestSector = Object.entries(marketData.sectors).sort((a, b) => (b[1].changePercent || 0) - (a[1].changePercent || 0))[0];
                  const worstSector = Object.entries(marketData.sectors).sort((a, b) => (a[1].changePercent || 0) - (b[1].changePercent || 0))[0];

                  return (
                    <>
                      <span className="text-slate-500">Breadth: <span className={`font-medium ${advancing > declining ? 'text-emerald-400' : 'text-red-400'}`}>{advancing}/{sectors.length} advancing</span></span>
                      <span className="text-slate-500">Avg: <span className={`font-medium ${avgChange >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{avgChange >= 0 ? '+' : ''}{avgChange.toFixed(2)}%</span></span>
                      {bestSector && <span className="text-slate-500">Leading: <span className="text-emerald-400 font-medium">{bestSector[1].name}</span></span>}
                      {worstSector && <span className="text-slate-500">Lagging: <span className="text-red-400 font-medium">{worstSector[1].name}</span></span>}
                    </>
                  );
                })()}
              </div>
            </div>

            {/* Quick Actions */}
            <div className="bg-slate-800/30 border border-slate-700/50 rounded-xl p-6">
              <h3 className="text-lg font-bold mb-4">Quick Actions</h3>
              <div className="flex flex-wrap gap-3">
                <button
                  onClick={() => setActiveTab("daily")}
                  className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg font-medium flex items-center gap-2"
                >
                  <Star className="w-4 h-4" />
                  Get Daily Pick
                </button>
                <button
                  onClick={() => setActiveTab("tradeideas")}
                  className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium flex items-center gap-2"
                >
                  <Sparkles className="w-4 h-4" />
                  Find Trade Ideas
                </button>
                <button
                  onClick={() => setActiveTab("economic")}
                  className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium flex items-center gap-2"
                >
                  <CalendarDays className="w-4 h-4" />
                  Economic Calendar
                </button>
                <button
                  onClick={() => setActiveTab("hotstocks")}
                  className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg font-medium flex items-center gap-2"
                >
                  <Flame className="w-4 h-4" />
                  Market Scanner
                </button>
              </div>
            </div>

            {marketData.lastUpdate && (
              <p className="text-xs text-slate-500 text-center">
                Data updates every 15 seconds when Market Overview is active • Last updated: {marketData.lastUpdate.toLocaleTimeString()}
              </p>
            )}
          </div>
        )}

        {/* PERFORMANCE DASHBOARD TAB */}
        {activeTab === "performance" && (
          <div className="space-y-4 md:space-y-6">
            <div className="flex items-center justify-between">
              <h2 className="text-3xl font-bold flex items-center gap-3">
                <PieChart className="w-8 h-8 text-violet-400" />
                Performance Dashboard
              </h2>
              <div className="flex gap-2">
                <button className="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm">
                  Last 30 Days
                </button>
                <button className="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm">
                  All Time
                </button>
              </div>
            </div>

            {trades.length === 0 ? (
              <div className="bg-slate-800/30 rounded-lg p-12 text-center">
                <PieChart className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">No Trading Data</h3>
                <p className="text-slate-400">
                  Add trades to your journal to see performance metrics
                </p>
              </div>
            ) : (
              <>
                {/* Overall Stats */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  {/* Win Rate */}
                  <div className="bg-gradient-to-br from-emerald-900/20 to-emerald-800/10 border border-emerald-600/30 rounded-lg p-6 relative group">
                    <div className="text-sm text-emerald-400 mb-2 flex items-center gap-1">
                      Win Rate
                      <HelpCircle className="w-3 h-3 text-emerald-500/50 hover:text-emerald-400 cursor-help" />
                    </div>
                    <div className="text-3xl font-bold text-emerald-300">
                      {trades.filter(t => t.status === "closed").length > 0
                        ? Math.round((trades.filter(t => t.pnl > 0).length / trades.filter(t => t.status === "closed").length) * 100)
                        : 0}%
                    </div>
                    <div className="text-xs text-slate-500 mt-2">
                      {trades.filter(t => t.pnl > 0).length} wins / {trades.filter(t => t.status === "closed").length} closed
                    </div>
                    {/* Win Rate Tooltip */}
                    <div className="absolute left-0 top-full mt-2 w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-xl z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                      <div className="text-xs text-slate-200 font-semibold mb-2">Win Rate Explained:</div>
                      <div className="text-xs text-slate-300 space-y-1">
                        <p><strong>Formula:</strong> Winning trades ÷ Total closed trades × 100</p>
                        <p className="mt-1">Note: A high win rate alone doesn't guarantee profitability. Combine with Profit Factor and Expectancy for full picture.</p>
                        <p className="text-emerald-400 mt-1">• 50%+ with positive expectancy = good system</p>
                      </div>
                    </div>
                  </div>

                  {/* Total P&L */}
                  <div className={`bg-gradient-to-br ${
                    trades.reduce((sum, t) => sum + (t.pnl || 0), 0) >= 0
                      ? 'from-green-900/20 to-green-800/10 border-green-600/30'
                      : 'from-red-900/20 to-red-800/10 border-red-600/30'
                  } border rounded-lg p-6`}>
                    <div className={`text-sm mb-2 ${
                      trades.reduce((sum, t) => sum + (t.pnl || 0), 0) >= 0 ? 'text-green-400' : 'text-red-400'
                    }`}>
                      Total P&L
                    </div>
                    <div className={`text-3xl font-bold ${
                      trades.reduce((sum, t) => sum + (t.pnl || 0), 0) >= 0 ? 'text-green-300' : 'text-red-300'
                    }`}>
                      {trades.reduce((sum, t) => sum + (t.pnl || 0), 0) >= 0 ? '+' : ''}
                      ${trades.reduce((sum, t) => sum + (t.pnl || 0), 0).toFixed(2)}
                    </div>
                    <div className="text-xs text-slate-500 mt-2">
                      {trades.filter(t => t.status === "closed").length} closed trades
                    </div>
                  </div>

                  {/* Average Win */}
                  <div className="bg-gradient-to-br from-blue-900/20 to-blue-800/10 border border-blue-600/30 rounded-lg p-6">
                    <div className="text-sm text-blue-400 mb-2">Avg Win</div>
                    <div className="text-3xl font-bold text-blue-300">
                      {trades.filter(t => t.pnl > 0).length > 0
                        ? `$${((trades.filter(t => t.pnl > 0).reduce((sum, t) => sum + (t.pnl || 0), 0) / trades.filter(t => t.pnl > 0).length) || 0).toFixed(2)}`
                        : '$0.00'}
                    </div>
                    <div className="text-xs text-slate-500 mt-2">
                      {trades.filter(t => t.pnl > 0).length} winning trades
                    </div>
                  </div>

                  {/* Average Loss */}
                  <div className="bg-gradient-to-br from-orange-900/20 to-orange-800/10 border border-orange-600/30 rounded-lg p-6">
                    <div className="text-sm text-orange-400 mb-2">Avg Loss</div>
                    <div className="text-3xl font-bold text-orange-300">
                      {trades.filter(t => t.pnl < 0).length > 0
                        ? `$${((trades.filter(t => t.pnl < 0).reduce((sum, t) => sum + (t.pnl || 0), 0) / trades.filter(t => t.pnl < 0).length) || 0).toFixed(2)}`
                        : '$0.00'}
                    </div>
                    <div className="text-xs text-slate-500 mt-2">
                      {trades.filter(t => t.pnl < 0).length} losing trades
                    </div>
                  </div>
                </div>

                {/* Best & Worst Trades */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Best Trade */}
                  <div className="bg-gradient-to-br from-emerald-900/20 to-green-900/10 rounded-lg p-6 border border-emerald-500/30">
                    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                      <TrendingUp className="w-5 h-5 text-emerald-400" />
                      🏆 Best Trade
                    </h3>
                    {(() => {
                      const bestTrade = trades.filter(t => t.pnl > 0).sort((a, b) => b.pnl - a.pnl)[0];
                      if (!bestTrade) return <p className="text-slate-500">No profitable trades yet</p>;
                      const entryPrice = parseFloat(bestTrade.entry) || parseFloat(bestTrade.entryPrice) || 0;
                      const exitPrice = parseFloat(bestTrade.exit) || parseFloat(bestTrade.exitPrice) || 0;
                      const quantity = parseFloat(bestTrade.quantity) || 1;
                      return (
                        <div className="space-y-2 md:space-y-3">
                          <div className="flex justify-between items-center">
                            <span className="text-slate-400">Symbol:</span>
                            <span className="font-bold text-xl text-emerald-300">{bestTrade.symbol}</span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-slate-400">Side:</span>
                            <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                              bestTrade.side === 'long' ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'
                            }`}>
                              {(bestTrade.side || 'long').toUpperCase()}
                            </span>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3 space-y-2">
                            <div className="flex justify-between">
                              <span className="text-slate-400 text-sm">Entry Price:</span>
                              <span className="font-semibold text-violet-400">${entryPrice.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-slate-400 text-sm">Exit Price:</span>
                              <span className="font-semibold text-emerald-400">${exitPrice.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-slate-400 text-sm">Quantity:</span>
                              <span className="font-semibold">{quantity} shares</span>
                            </div>
                          </div>
                          <div className="flex justify-between items-center pt-2 border-t border-slate-700">
                            <span className="text-slate-400">Total Profit:</span>
                            <span className="font-bold text-xl text-emerald-400">
                              +${(bestTrade.pnl || 0).toFixed(2)}
                            </span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-slate-400">Return:</span>
                            <span className="font-bold text-emerald-400">
                              +{(bestTrade.pnlPercent || 0).toFixed(2)}%
                            </span>
                          </div>
                          {bestTrade.entryDate && (
                            <div className="text-xs text-slate-500 pt-2 border-t border-slate-700/50">
                              📅 {new Date(bestTrade.entryDate).toLocaleDateString()}
                              {bestTrade.exitDate && ` → ${new Date(bestTrade.exitDate).toLocaleDateString()}`}
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>

                  {/* Worst Trade */}
                  <div className="bg-gradient-to-br from-red-900/20 to-rose-900/10 rounded-lg p-6 border border-red-500/30">
                    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                      <TrendingDown className="w-5 h-5 text-red-400" />
                      💥 Worst Trade
                    </h3>
                    {(() => {
                      const worstTrade = trades.filter(t => t.pnl < 0).sort((a, b) => a.pnl - b.pnl)[0];
                      if (!worstTrade) return <p className="text-slate-500">No losing trades yet</p>;
                      const entryPrice = parseFloat(worstTrade.entry) || parseFloat(worstTrade.entryPrice) || 0;
                      const exitPrice = parseFloat(worstTrade.exit) || parseFloat(worstTrade.exitPrice) || 0;
                      const quantity = parseFloat(worstTrade.quantity) || 1;
                      return (
                        <div className="space-y-2 md:space-y-3">
                          <div className="flex justify-between items-center">
                            <span className="text-slate-400">Symbol:</span>
                            <span className="font-bold text-xl text-red-300">{worstTrade.symbol}</span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-slate-400">Side:</span>
                            <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                              worstTrade.side === 'long' ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'
                            }`}>
                              {(worstTrade.side || 'long').toUpperCase()}
                            </span>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-3 space-y-2">
                            <div className="flex justify-between">
                              <span className="text-slate-400 text-sm">Entry Price:</span>
                              <span className="font-semibold text-violet-400">${entryPrice.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-slate-400 text-sm">Exit Price:</span>
                              <span className="font-semibold text-red-400">${exitPrice.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-slate-400 text-sm">Quantity:</span>
                              <span className="font-semibold">{quantity} shares</span>
                            </div>
                          </div>
                          <div className="flex justify-between items-center pt-2 border-t border-slate-700">
                            <span className="text-slate-400">Total Loss:</span>
                            <span className="font-bold text-xl text-red-400">
                              ${(worstTrade.pnl || 0).toFixed(2)}
                            </span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-slate-400">Return:</span>
                            <span className="font-bold text-red-400">
                              {(worstTrade.pnlPercent || 0).toFixed(2)}%
                            </span>
                          </div>
                          {worstTrade.entryDate && (
                            <div className="text-xs text-slate-500 pt-2 border-t border-slate-700/50">
                              📅 {new Date(worstTrade.entryDate).toLocaleDateString()}
                              {worstTrade.exitDate && ` → ${new Date(worstTrade.exitDate).toLocaleDateString()}`}
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>
                </div>

                {/* Monthly Performance */}
                <div className="bg-slate-900/50 rounded-lg p-6 border border-slate-700">
                  <h3 className="text-lg font-semibold mb-4">Monthly Performance</h3>
                  <div className="grid grid-cols-3 md:grid-cols-6 gap-4">
                    {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map((month, i) => {
                      const monthTrades = trades.filter(t => {
                        const date = new Date(t.entryDate);
                        return date.getMonth() === i && t.status === "closed";
                      });
                      const monthPnL = monthTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                      
                      return (
                        <div key={month} className={`text-center p-4 rounded-lg ${
                          monthPnL > 0 ? 'bg-emerald-900/20 border border-emerald-600/30' :
                          monthPnL < 0 ? 'bg-red-900/20 border border-red-600/30' :
                          'bg-slate-800/30 border border-slate-700'
                        }`}>
                          <div className="text-xs text-slate-400 mb-1">{month}</div>
                          <div className={`text-sm font-bold ${
                            monthPnL > 0 ? 'text-emerald-400' :
                            monthPnL < 0 ? 'text-red-400' :
                            'text-slate-500'
                          }`}>
                            {monthPnL !== 0 ? (monthPnL > 0 ? '+' : '') + (monthPnL || 0).toFixed(0) : '-'}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Trading Metrics */}
                <div className="bg-slate-900/50 rounded-lg p-6 border border-slate-700">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    Trading Metrics
                    <span className="text-xs text-slate-500 font-normal">(hover metrics for explanations)</span>
                  </h3>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div className="relative group">
                      <div className="text-sm text-slate-400 mb-1 flex items-center gap-1">
                        Profit Factor
                        <HelpCircle className="w-3 h-3 text-slate-500 hover:text-violet-400 cursor-help" />
                      </div>
                      <div className="text-2xl font-bold text-violet-400">
                        {trades.filter(t => t.pnl > 0).length > 0 && trades.filter(t => t.pnl < 0).length > 0
                          ? (Math.abs(trades.filter(t => t.pnl > 0).reduce((sum, t) => sum + t.pnl, 0)) /
                             Math.abs(trades.filter(t => t.pnl < 0).reduce((sum, t) => sum + t.pnl, 0))).toFixed(2)
                          : '0.00'}
                      </div>
                      {/* Profit Factor Tooltip */}
                      <div className="absolute left-0 top-full mt-2 w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-xl z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                        <div className="text-xs text-slate-200 font-semibold mb-2">Profit Factor Explained:</div>
                        <div className="text-xs text-slate-300 space-y-1">
                          <p><strong>Formula:</strong> Total Profits ÷ Total Losses</p>
                          <p className="text-emerald-400">• &gt;2.0 = Excellent system</p>
                          <p className="text-green-400">• 1.5-2.0 = Good system</p>
                          <p className="text-yellow-400">• 1.0-1.5 = Marginal</p>
                          <p className="text-red-400">• &lt;1.0 = Losing money</p>
                        </div>
                      </div>
                    </div>
                    <div className="relative group">
                      <div className="text-sm text-slate-400 mb-1 flex items-center gap-1">
                        Expectancy
                        <HelpCircle className="w-3 h-3 text-slate-500 hover:text-blue-400 cursor-help" />
                      </div>
                      <div className="text-2xl font-bold text-blue-400">
                        {trades.filter(t => t.status === "closed").length > 0
                          ? `$${(trades.reduce((sum, t) => sum + (t.pnl || 0), 0) / trades.filter(t => t.status === "closed").length).toFixed(2)}`
                          : '$0.00'}
                      </div>
                      {/* Expectancy Tooltip */}
                      <div className="absolute left-0 top-full mt-2 w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-xl z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                        <div className="text-xs text-slate-200 font-semibold mb-2">Expectancy Explained:</div>
                        <div className="text-xs text-slate-300 space-y-1">
                          <p><strong>Formula:</strong> Average profit/loss per trade</p>
                          <p>Total P&L ÷ Number of closed trades</p>
                          <p className="text-emerald-400 mt-1">• Positive = Making money on average</p>
                          <p className="text-red-400">• Negative = Losing money on average</p>
                        </div>
                      </div>
                    </div>
                    <div>
                      <div className="text-sm text-slate-400 mb-1">Total Trades</div>
                      <div className="text-2xl font-bold text-slate-300">
                        {trades.length}
                      </div>
                    </div>
                    <div>
                      <div className="text-sm text-slate-400 mb-1">Open Trades</div>
                      <div className="text-2xl font-bold text-yellow-400">
                        {trades.filter(t => t.status === "open").length}
                      </div>
                    </div>
                  </div>
                </div>
              </>
            )}
          </div>
        )}

        {/* PAPER TRADING TAB */}
        {activeTab === "papertrading" && (
          <div className="space-y-4 md:space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-3xl font-bold flex items-center gap-3">
                  <Wallet className="w-8 h-8 text-violet-400" />
                  Paper Trading
                </h2>
                <p className="text-slate-400 mt-1">Practice trading with virtual money</p>
              </div>
              <button
                onClick={() => {
                  setConfirmMessage(`Reset paper trading account to $${paperTradingAccount.initialBalance.toLocaleString()}? All paper trades will be deleted.`);
                  setConfirmAction(() => () => {
                    setPaperTradingAccount(prev => ({
                      balance: prev.initialBalance,
                      initialBalance: prev.initialBalance,
                      positions: [],
                      trades: []
                    }));
                    // Also clear paper trades from trades array
                    setTrades(prev => prev.filter(t => !t.isPaperTrade));
                    setShowConfirmModal(false);
                  });
                  setShowConfirmModal(true);
                }}
                className="px-4 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-lg font-semibold"
              >
                Reset Account
              </button>
            </div>

            {/* Account Overview */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div className="bg-gradient-to-br from-blue-900/20 to-blue-800/10 border border-blue-600/30 rounded-lg p-6">
                <div className="text-sm text-blue-400 mb-2">Account Balance</div>
                <div className="text-3xl font-bold text-blue-300">
                  ${paperTradingAccount.balance.toLocaleString()}
                </div>
                <div className="text-xs text-slate-500 mt-2">
                  Starting: ${paperTradingAccount.initialBalance.toLocaleString()}
                </div>
              </div>

              <div className={`bg-gradient-to-br ${
                paperTradingAccount.balance >= paperTradingAccount.initialBalance
                  ? 'from-emerald-900/20 to-emerald-800/10 border-emerald-600/30'
                  : 'from-red-900/20 to-red-800/10 border-red-600/30'
              } border rounded-lg p-6`}>
                <div className={`text-sm mb-2 ${
                  paperTradingAccount.balance >= paperTradingAccount.initialBalance ? 'text-emerald-400' : 'text-red-400'
                }`}>
                  Total P&L
                </div>
                <div className={`text-3xl font-bold ${
                  paperTradingAccount.balance >= paperTradingAccount.initialBalance ? 'text-emerald-300' : 'text-red-300'
                }`}>
                  {paperTradingAccount.balance >= paperTradingAccount.initialBalance ? '+' : ''}
                  ${(paperTradingAccount.balance - paperTradingAccount.initialBalance).toLocaleString()}
                </div>
                <div className={`text-xs mt-2 ${
                  (paperTradingAccount.balance || 0) >= (paperTradingAccount.initialBalance || 100000) ? 'text-emerald-500' : 'text-red-500'
                }`}>
                  {(((paperTradingAccount.balance - paperTradingAccount.initialBalance) / paperTradingAccount.initialBalance * 100) || 0).toFixed(2)}%
                </div>
              </div>

              <div className="bg-gradient-to-br from-violet-900/20 to-violet-800/10 border border-violet-600/30 rounded-lg p-6">
                <div className="text-sm text-violet-400 mb-2">Open Positions</div>
                <div className="text-3xl font-bold text-violet-300">
                  {paperTradingAccount.positions.length}
                </div>
                <div className="text-xs text-slate-500 mt-2">
                  Paper trades active
                </div>
              </div>

              <div className="bg-gradient-to-br from-orange-900/20 to-orange-800/10 border border-orange-600/30 rounded-lg p-6">
                <div className="text-sm text-orange-400 mb-2">Total Trades</div>
                <div className="text-3xl font-bold text-orange-300">
                  {paperTradingAccount.trades.length}
                </div>
                <div className="text-xs text-slate-500 mt-2">
                  Closed paper trades
                </div>
              </div>
            </div>

            {/* Starting Balance Configuration - Always visible, changing resets account */}
            <div className="bg-gradient-to-r from-violet-500/10 to-blue-500/10 border border-violet-500/30 rounded-lg p-5">
              <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div className="flex items-start gap-3">
                  <Settings className="w-5 h-5 text-violet-400 flex-shrink-0 mt-0.5" />
                  <div>
                    <p className="font-semibold text-violet-200 mb-1">Starting Balance</p>
                    <p className="text-sm text-slate-400">
                      {trades.filter(t => t.isPaperTrade).length > 0 || paperTradingAccount.trades.length > 0
                        ? '⚠️ Changing this will reset all paper trades'
                        : 'Set how much virtual money you want to practice with'}
                    </p>
                  </div>
                </div>
                <div className="flex items-center gap-3 flex-wrap">
                  <div className="flex items-center gap-2">
                    <span className="text-slate-400">$</span>
                    <input
                      type="number"
                      value={paperTradingAccount.initialBalance}
                      onChange={(e) => {
                        const newBalance = parseInt(e.target.value) || 100000;
                        const hasTrades = trades.filter(t => t.isPaperTrade).length > 0 || paperTradingAccount.trades.length > 0;

                        if (hasTrades) {
                          setConfirmMessage(`Change starting balance to $${newBalance.toLocaleString()}? This will reset your paper trading account and delete all paper trades.`);
                          setConfirmAction(() => () => {
                            setPaperTradingAccount({
                              balance: newBalance,
                              initialBalance: newBalance,
                              positions: [],
                              trades: []
                            });
                            setTrades(prev => prev.filter(t => !t.isPaperTrade));
                            setShowConfirmModal(false);
                          });
                          setShowConfirmModal(true);
                        } else {
                          setPaperTradingAccount(prev => ({
                            ...prev,
                            balance: newBalance,
                            initialBalance: newBalance
                          }));
                        }
                      }}
                      className="w-32 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-right font-mono"
                      placeholder="100000"
                      min="1000"
                      step="1000"
                    />
                  </div>
                  <div className="flex gap-2">
                    {[10000, 50000, 100000, 500000].map(amount => (
                      <button
                        key={amount}
                        onClick={() => {
                          const hasTrades = trades.filter(t => t.isPaperTrade).length > 0 || paperTradingAccount.trades.length > 0;

                          if (hasTrades && amount !== paperTradingAccount.initialBalance) {
                            setConfirmMessage(`Change starting balance to $${amount.toLocaleString()}? This will reset your paper trading account and delete all paper trades.`);
                            setConfirmAction(() => () => {
                              setPaperTradingAccount({
                                balance: amount,
                                initialBalance: amount,
                                positions: [],
                                trades: []
                              });
                              setTrades(prev => prev.filter(t => !t.isPaperTrade));
                              setShowConfirmModal(false);
                            });
                            setShowConfirmModal(true);
                          } else {
                            setPaperTradingAccount(prev => ({
                              ...prev,
                              balance: amount,
                              initialBalance: amount
                            }));
                          }
                        }}
                        className={`px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${
                          paperTradingAccount.initialBalance === amount
                            ? 'bg-violet-600 text-white'
                            : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                        }`}
                      >
                        ${(amount / 1000)}k
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Info Box */}
            <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
              <div className="flex items-start gap-3">
                <AlertCircle className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
                <div className="text-sm text-blue-200">
                  <p className="font-semibold mb-1">How Paper Trading Works:</p>
                  <ul className="list-disc list-inside space-y-1 text-blue-300">
                    <li>Practice trading with ${paperTradingAccount.initialBalance.toLocaleString()} virtual money</li>
                    <li>Add trades in the Journal with "Paper Trade" selected</li>
                    <li>Track your performance without risking real capital</li>
                    <li>Compare paper trading results vs real trades</li>
                  </ul>
                </div>
              </div>
            </div>

            {/* Paper Trades List */}
            {trades.filter(t => t.isPaperTrade).length === 0 ? (
              <div className="bg-slate-800/30 rounded-lg p-12 text-center">
                <Wallet className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">No Paper Trades Yet</h3>
                <p className="text-slate-400 mb-6">
                  Go to Trading Journal and add trades with "Paper Trade" selected
                </p>
                <button
                  onClick={() => setActiveTab("journal")}
                  className="px-6 py-3 bg-violet-600 hover:bg-violet-500 rounded-lg font-semibold"
                >
                  Go to Journal
                </button>
              </div>
            ) : (
              <div className="bg-slate-900/50 rounded-lg overflow-hidden border border-slate-700">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-slate-900/50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Symbol</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Side</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Entry</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Exit</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">P&L</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Status</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-700">
                      {trades.filter(t => t.isPaperTrade).map((trade) => (
                        <tr key={trade.id} className="hover:bg-slate-800/50">
                          <td className="px-4 py-3 font-semibold">{trade.symbol}</td>
                          <td className="px-4 py-3">
                            <span className={`px-2 py-1 rounded text-xs ${
                              trade.side === "long" ? "bg-green-900/30 text-green-400" : "bg-red-900/30 text-red-400"
                            }`}>
                              {trade.side.toUpperCase()}
                            </span>
                          </td>
                          <td className="px-4 py-3">${(parseFloat(trade.entry) || 0).toFixed(2)}</td>
                          <td className="px-4 py-3">
                            {trade.exit ? `$${(parseFloat(trade.exit) || 0).toFixed(2)}` : "-"}
                          </td>
                          <td className="px-4 py-3">
                            {trade.pnl !== null ? (
                              <span className={trade.pnl >= 0 ? "text-green-400" : "text-red-400"}>
                                {trade.pnl >= 0 ? "+" : ""}${(trade.pnl || 0).toFixed(2)}
                              </span>
                            ) : (
                              "-"
                            )}
                          </td>
                          <td className="px-4 py-3">
                            <span className={`px-2 py-1 rounded text-xs ${
                              trade.status === "open" ? "bg-blue-900/30 text-blue-400" : "bg-slate-700 text-slate-300"
                            }`}>
                              {trade.status}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        )}

        {/* ECONOMIC CALENDAR TAB */}

        {/* ECONOMIC CALENDAR TAB - ENHANCED */}
        {activeTab === "economic" && (
          <div className="space-y-4 md:space-y-6">
            {/* Header with View Toggles */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between flex-wrap gap-3 md:gap-4">
              <div>
                <h2 className="text-2xl md:text-3xl font-bold flex items-center gap-3">
                  <CalendarDays className="w-7 md:w-8 h-7 md:h-8 text-violet-400" />
                  Economic Calendar
                </h2>
                <p className="text-sm md:text-base text-slate-400 mt-1">Market-moving events and data releases</p>
              </div>
              <div className="flex gap-2 flex-wrap">
                <button
                  onClick={() => setCalendarView('list')}
                  className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                    calendarView === 'list' || calendarView === 'week'
                      ? 'bg-violet-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
                >
                  <List className="w-4 h-4 inline mr-1" />
                  List
                </button>
                <button
                  onClick={() => setCalendarView('month')}
                  className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                    calendarView === 'month'
                      ? 'bg-violet-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
                >
                  <Calendar className="w-4 h-4 inline mr-1" />
                  Calendar
                </button>
                <button
                  onClick={() => setCalendarMonthOffset(0)}
                  className="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-semibold transition-colors"
                >
                  Today
                </button>
                <button
                  onClick={() => {
                    console.log("[Economic Calendar] 🔄 Manual refresh triggered by user");
                    setLoadingEconomicEvents(true);
                    setTimeout(() => {
                      const newEvents = generateEconomicEvents();
                      setEconomicEvents(newEvents);
                      setLoadingEconomicEvents(false);
                      console.log("[Economic Calendar] ✅ Manual refresh complete!");
                    }, 500);
                  }}
                  disabled={loadingEconomicEvents}
                  className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg font-semibold flex items-center gap-2 disabled:opacity-50 transition-all"
                >
                  <RefreshCw className={`w-4 h-4 ${loadingEconomicEvents ? 'animate-spin' : ''}`} />
                  <span>{loadingEconomicEvents ? 'Loading...' : 'Refresh'}</span>
                </button>
              </div>
            </div>

            {/* Info Banner */}
            <div className="bg-gradient-to-r from-blue-500/10 to-violet-500/10 border border-blue-500/30 rounded-lg md:rounded-xl p-3 md:p-4">
              <div className="flex items-start gap-3">
                <AlertCircle className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
                <div className="text-xs md:text-sm text-blue-200">
                  <p className="font-semibold mb-1">📊 Economic Events Impact Trading</p>
                  <p className="text-blue-300/80">
                    High importance events (CPI, Fed decisions, jobs reports) can cause 1-3% market swings.
                    Plan your trades around these releases. Click any event for details and market impact analysis.
                  </p>
                </div>
              </div>
            </div>

            {economicEvents.length === 0 ? (
              <div className="bg-slate-800/30 rounded-lg md:rounded-xl p-6 md:p-12 text-center border border-slate-700/50">
                <CalendarDays className="w-12 md:w-16 h-12 md:h-16 text-slate-600 mx-auto mb-3 md:mb-4" />
                <h3 className="text-lg md:text-xl font-semibold mb-2">No Events Loaded</h3>
                <p className="text-sm md:text-base text-slate-400 mb-4 md:mb-6">
                  Click "Refresh" to load upcoming economic calendar events
                </p>
              </div>
            ) : (
              <>
                {/* LIST VIEW */}
                {(calendarView === 'list' || calendarView === 'week') && (
                  <div className="bg-gradient-to-br from-slate-900/80 to-slate-800/50 rounded-xl border border-slate-700/50 overflow-hidden">
                    {/* Month Navigation */}
                    <div className="flex items-center justify-between p-4 bg-slate-800/50 border-b border-slate-700/50">
                      <button
                        onClick={() => setCalendarMonthOffset(prev => prev - 1)}
                        className="p-2 bg-slate-700/50 hover:bg-slate-600 rounded-lg transition-colors flex items-center gap-1"
                      >
                        <ChevronLeft className="w-5 h-5" />
                        <span className="text-sm hidden sm:inline">Previous</span>
                      </button>

                      <h3 className="text-xl font-bold flex items-center gap-2">
                        <Calendar className="w-5 h-5 text-violet-400" />
                        {(() => {
                          const targetDate = new Date();
                          targetDate.setDate(1); // Fix: avoid day overflow (Jan 30 + 1mo = Mar 2)
                          targetDate.setMonth(targetDate.getMonth() + calendarMonthOffset);
                          return targetDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        })()}
                      </h3>

                      <button
                        onClick={() => setCalendarMonthOffset(prev => prev + 1)}
                        className="p-2 bg-slate-700/50 hover:bg-slate-600 rounded-lg transition-colors flex items-center gap-1"
                      >
                        <span className="text-sm hidden sm:inline">Next</span>
                        <ChevronRight className="w-5 h-5" />
                      </button>
                    </div>

                    {/* Events List */}
                    <div className="p-4 max-h-[600px] overflow-y-auto">
                      {(() => {
                        // FIX: Set to 1st of month BEFORE changing month to avoid day overflow issues
                        // (e.g., Jan 30 + 1 month = "Feb 30" which becomes Mar 2)
                        const targetDate = new Date();
                        targetDate.setDate(1); // Set to 1st to avoid overflow
                        targetDate.setMonth(targetDate.getMonth() + calendarMonthOffset);
                        const targetMonth = targetDate.getMonth();
                        const targetYear = targetDate.getFullYear();

                        const monthEvents = economicEvents.filter(event => {
                          const eventDate = new Date(event.date);
                          return eventDate.getMonth() === targetMonth &&
                                 eventDate.getFullYear() === targetYear;
                        });

                        if (monthEvents.length === 0) {
                          return (
                            <div className="text-center py-12">
                              <CalendarDays className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                              <p className="text-slate-400">No events scheduled for this month</p>
                              <p className="text-slate-500 text-sm mt-2">Try navigating to a different month</p>
                            </div>
                          );
                        }

                        // Group events by date
                        const groupedEvents = {};
                        monthEvents.forEach(event => {
                          if (!groupedEvents[event.date]) {
                            groupedEvents[event.date] = [];
                          }
                          groupedEvents[event.date].push(event);
                        });

                        return Object.entries(groupedEvents).map(([date, events]) => {
                          const eventDate = new Date(date);
                          const isToday = new Date().toDateString() === eventDate.toDateString();
                          const isPast = eventDate < new Date() && !isToday;

                          return (
                            <div key={date} className={`mb-4 last:mb-0 ${isPast ? 'opacity-60' : ''}`}>
                              {/* Date Header */}
                              <div className={`flex items-center gap-3 mb-3 pb-2 border-b ${
                                isToday ? 'border-violet-500/50' : 'border-slate-700/50'
                              }`}>
                                <div className={`px-3 py-2 rounded-lg text-center min-w-[70px] ${
                                  isToday
                                    ? 'bg-violet-600 text-white'
                                    : 'bg-slate-800'
                                }`}>
                                  <div className="text-xs uppercase tracking-wide opacity-80">
                                    {eventDate.toLocaleDateString('en-US', { weekday: 'short' })}
                                  </div>
                                  <div className="text-xl font-bold">
                                    {eventDate.getDate()}
                                  </div>
                                </div>
                                <div>
                                  <div className={`font-semibold ${isToday ? 'text-violet-300' : ''}`}>
                                    {eventDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                                    {isToday && <span className="ml-2 text-xs bg-violet-500/30 text-violet-300 px-2 py-0.5 rounded-full">TODAY</span>}
                                  </div>
                                  <div className="text-sm text-slate-500">{events.length} event{events.length > 1 ? 's' : ''}</div>
                                </div>
                              </div>

                              {/* Events for this date */}
                              <div className="space-y-2 pl-2">
                                {events.map((event) => (
                                  <div
                                    key={event.id}
                                    onClick={() => setSelectedEvent(event)}
                                    className={`flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all ${
                                      event.importance === 'high'
                                        ? 'bg-red-900/20 hover:bg-red-900/30 border border-red-700/30'
                                        : event.importance === 'medium'
                                        ? 'bg-yellow-900/20 hover:bg-yellow-900/30 border border-yellow-700/30'
                                        : 'bg-slate-800/50 hover:bg-slate-700/50 border border-slate-700/30'
                                    }`}
                                  >
                                    <div className="flex items-center gap-3 flex-1">
                                      <div className={`w-1 h-12 rounded-full ${
                                        event.importance === 'high' ? 'bg-red-500' :
                                        event.importance === 'medium' ? 'bg-yellow-500' :
                                        'bg-green-500'
                                      }`} />

                                      <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                          <span className="font-semibold">{event.event}</span>
                                          <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                            event.importance === 'high' ? 'bg-red-900/50 text-red-400' :
                                            event.importance === 'medium' ? 'bg-yellow-900/50 text-yellow-400' :
                                            'bg-green-900/50 text-green-400'
                                          }`}>
                                            {event.importance.toUpperCase()}
                                          </span>
                                        </div>
                                        <div className="text-sm text-slate-400 mt-1">
                                          <Clock className="w-3 h-3 inline mr-1" />
                                          {event.time}
                                          <span className="mx-2">•</span>
                                          Forecast: <span className="text-slate-300">{event.forecast}</span>
                                          <span className="mx-2">•</span>
                                          Previous: <span className="text-slate-300">{event.previous}</span>
                                        </div>
                                      </div>
                                    </div>

                                    <ChevronRight className="w-5 h-5 text-slate-500" />
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        });
                      })()}
                    </div>

                    {/* Legend */}
                    <div className="p-4 bg-slate-800/30 border-t border-slate-700/50">
                      <div className="flex items-center justify-center gap-6 text-xs">
                        <div className="flex items-center gap-2">
                          <div className="w-3 h-3 rounded bg-red-500" />
                          <span className="text-slate-400">High Impact</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <div className="w-3 h-3 rounded bg-yellow-500" />
                          <span className="text-slate-400">Medium Impact</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <div className="w-3 h-3 rounded bg-green-500" />
                          <span className="text-slate-400">Low Impact</span>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* CALENDAR GRID VIEW */}
                {calendarView === 'month' && (
                  <div className="bg-gradient-to-br from-slate-900/80 to-slate-800/50 rounded-xl border border-slate-700/50 overflow-hidden">
                    {/* Month Navigation Header */}
                    <div className="flex items-center justify-between p-4 bg-slate-800/50 border-b border-slate-700/50">
                      <button
                        onClick={() => setCalendarMonthOffset(prev => prev - 1)}
                        className="p-2 bg-slate-700/50 hover:bg-slate-600 rounded-lg transition-colors flex items-center gap-1"
                      >
                        <ChevronLeft className="w-5 h-5" />
                        <span className="text-sm hidden sm:inline">Previous</span>
                      </button>

                      <h3 className="text-xl font-bold flex items-center gap-2">
                        <Calendar className="w-5 h-5 text-violet-400" />
                        {(() => {
                          const targetDate = new Date();
                          targetDate.setDate(1); // Fix: avoid day overflow
                          targetDate.setMonth(targetDate.getMonth() + calendarMonthOffset);
                          return targetDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        })()}
                      </h3>

                      <button
                        onClick={() => setCalendarMonthOffset(prev => prev + 1)}
                        className="p-2 bg-slate-700/50 hover:bg-slate-600 rounded-lg transition-colors flex items-center gap-1"
                      >
                        <span className="text-sm hidden sm:inline">Next</span>
                        <ChevronRight className="w-5 h-5" />
                      </button>
                    </div>

                    {/* Calendar Grid */}
                    <div className="p-4">
                      {(() => {
                        const targetDate = new Date();
                        targetDate.setDate(1); // Fix: avoid day overflow (Jan 30 + 1mo = Mar 2)
                        targetDate.setMonth(targetDate.getMonth() + calendarMonthOffset);
                        const targetMonth = targetDate.getMonth();
                        const targetYear = targetDate.getFullYear();
                        const today = new Date();

                        const firstDay = new Date(targetYear, targetMonth, 1).getDay();
                        const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
                        const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;

                        const monthEvents = economicEvents.filter(event => {
                          const eventDate = new Date(event.date);
                          return eventDate.getMonth() === targetMonth &&
                                 eventDate.getFullYear() === targetYear;
                        });

                        return (
                          <>
                            {/* Day Headers */}
                            <div className="grid grid-cols-7 gap-1 mb-2">
                              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, idx) => (
                                <div
                                  key={day}
                                  className={`text-center text-xs font-bold py-2 rounded ${
                                    idx === 0 || idx === 6 ? 'text-slate-500' : 'text-slate-400'
                                  }`}
                                >
                                  {day}
                                </div>
                              ))}
                            </div>

                            {/* Calendar Days */}
                            <div className="grid grid-cols-7 gap-1">
                              {Array.from({ length: totalCells }).map((_, i) => {
                                const dayNum = i - firstDay + 1;
                                const isValidDay = dayNum > 0 && dayNum <= daysInMonth;
                                const currentDate = new Date(targetYear, targetMonth, dayNum);
                                const isToday = isValidDay && today.toDateString() === currentDate.toDateString();
                                const isWeekend = i % 7 === 0 || i % 7 === 6;

                                const dayEvents = isValidDay ? monthEvents.filter(e => {
                                  const eventDay = new Date(e.date).getDate();
                                  return eventDay === dayNum;
                                }) : [];

                                const hasEvent = dayEvents.length > 0;
                                const highImpactCount = dayEvents.filter(e => e.importance === 'high').length;
                                const mediumImpactCount = dayEvents.filter(e => e.importance === 'medium').length;

                                return (
                                  <div
                                    key={i}
                                    onClick={() => {
                                      if (hasEvent) {
                                        setSelectedEvent({
                                          isMultiEvent: dayEvents.length > 1,
                                          events: dayEvents,
                                          singleEvent: dayEvents[0],
                                          dayNum,
                                          month: targetMonth,
                                          year: targetYear
                                        });
                                      }
                                    }}
                                    className={`min-h-[80px] p-1.5 rounded-lg transition-all ${
                                      !isValidDay
                                        ? 'bg-slate-900/20'
                                        : isToday
                                        ? 'bg-violet-600/30 border-2 border-violet-500 ring-2 ring-violet-500/20'
                                        : hasEvent
                                        ? highImpactCount > 0
                                          ? 'bg-red-900/20 border border-red-700/40 cursor-pointer hover:bg-red-900/40 hover:border-red-600'
                                          : mediumImpactCount > 0
                                          ? 'bg-yellow-900/20 border border-yellow-700/40 cursor-pointer hover:bg-yellow-900/40 hover:border-yellow-600'
                                          : 'bg-green-900/20 border border-green-700/40 cursor-pointer hover:bg-green-900/40 hover:border-green-600'
                                        : isWeekend
                                        ? 'bg-slate-800/20 border border-transparent'
                                        : 'bg-slate-800/40 border border-transparent'
                                    }`}
                                  >
                                    {isValidDay && (
                                      <div className="h-full flex flex-col">
                                        <div className={`text-sm font-bold mb-1 ${
                                          isToday ? 'text-violet-300' : isWeekend ? 'text-slate-500' : 'text-slate-300'
                                        }`}>
                                          {dayNum}
                                          {isToday && <span className="ml-1 text-[10px] text-violet-400">TODAY</span>}
                                        </div>

                                        {hasEvent && (
                                          <div className="flex-1 flex flex-col gap-0.5 overflow-hidden">
                                            {/* Show event indicators */}
                                            {dayEvents.slice(0, 3).map((event, idx) => (
                                              <div
                                                key={idx}
                                                className={`text-[9px] px-1 py-0.5 rounded truncate ${
                                                  event.importance === 'high'
                                                    ? 'bg-red-500/30 text-red-300'
                                                    : event.importance === 'medium'
                                                    ? 'bg-yellow-500/30 text-yellow-300'
                                                    : 'bg-green-500/30 text-green-300'
                                                }`}
                                              >
                                                {event.event.split(' ').slice(0, 2).join(' ')}
                                              </div>
                                            ))}
                                            {dayEvents.length > 3 && (
                                              <div className="text-[9px] text-slate-400 px-1">
                                                +{dayEvents.length - 3} more
                                              </div>
                                            )}
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                          </>
                        );
                      })()}
                    </div>

                    {/* Legend */}
                    <div className="p-4 bg-slate-800/30 border-t border-slate-700/50">
                      <div className="flex items-center justify-between flex-wrap gap-4">
                        <div className="flex items-center gap-4 text-xs">
                          <div className="flex items-center gap-2">
                            <div className="w-3 h-3 rounded bg-red-500/50 border border-red-500" />
                            <span className="text-slate-400">High Impact</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="w-3 h-3 rounded bg-yellow-500/50 border border-yellow-500" />
                            <span className="text-slate-400">Medium</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="w-3 h-3 rounded bg-green-500/50 border border-green-500" />
                            <span className="text-slate-400">Low</span>
                          </div>
                        </div>
                        <span className="text-xs text-slate-500">Click any day with events to view details</span>
                      </div>
                    </div>
                  </div>
                )}
              </>
            )}

            {selectedEvent && (
              <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div className="bg-slate-900 border border-slate-700 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] flex flex-col">
                  {/* Header */}
                  <div className="flex items-start justify-between mb-4">
                    <div>
                      {selectedEvent.isMultiEvent ? (
                        <>
                          <h3 className="text-2xl font-bold mb-1">{selectedEvent.events.length} Events</h3>
                          <p className="text-slate-400">
                            {new Date(selectedEvent.year, selectedEvent.month, selectedEvent.dayNum).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                          </p>
                        </>
                      ) : (
                        <>
                          <h3 className="text-2xl font-bold mb-1">{selectedEvent.singleEvent?.event || selectedEvent.event}</h3>
                          <p className="text-slate-400">
                            {new Date(selectedEvent.singleEvent?.date || selectedEvent.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} at {selectedEvent.singleEvent?.time || selectedEvent.time}
                          </p>
                        </>
                      )}
                    </div>
                    <button
                      onClick={() => setSelectedEvent(null)}
                      className="text-slate-400 hover:text-white"
                    >
                      <X className="w-6 h-6" />
                    </button>
                  </div>

                  {/* Scrollable Content */}
                  <div className="overflow-y-auto flex-1 space-y-4" style={{ maxHeight: 'calc(80vh - 150px)' }}>
                    {selectedEvent.isMultiEvent ? (
                      // Multiple events - scrollable list
                      selectedEvent.events.map((event, idx) => (
                        <div key={idx} className="bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                          <div className="flex items-start justify-between mb-2">
                            <div>
                              <h4 className="font-semibold text-lg">{event.event}</h4>
                              <p className="text-sm text-slate-400">{event.time}</p>
                            </div>
                            <span className={`px-2 py-1 rounded text-xs font-semibold ${
                              event.importance === 'high' ? 'bg-red-900/50 text-red-400' :
                              event.importance === 'medium' ? 'bg-yellow-900/50 text-yellow-400' :
                              'bg-green-900/50 text-green-400'
                            }`}>
                              {event.importance?.toUpperCase()}
                            </span>
                          </div>
                          <div className="grid grid-cols-2 gap-2 mb-2 text-sm">
                            <div><span className="text-slate-500">Forecast:</span> {event.forecast}</div>
                            <div><span className="text-slate-500">Previous:</span> {event.previous}</div>
                          </div>
                          <p className="text-sm text-slate-300">{event.description}</p>
                        </div>
                      ))
                    ) : (
                      // Single event - original layout
                      <>
                        <div className={`px-4 py-2 rounded-lg inline-block ${
                          (selectedEvent.singleEvent?.importance || selectedEvent.importance) === 'high' ? 'bg-red-900/30 text-red-400' :
                          (selectedEvent.singleEvent?.importance || selectedEvent.importance) === 'medium' ? 'bg-yellow-900/30 text-yellow-400' :
                          'bg-green-900/30 text-green-400'
                        }`}>
                          {(selectedEvent.singleEvent?.importance || selectedEvent.importance)?.toUpperCase()} IMPACT
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div className="bg-slate-800/50 rounded-lg p-4">
                            <div className="text-xs text-slate-500 mb-1">Forecast</div>
                            <div className="text-xl font-bold">{selectedEvent.singleEvent?.forecast || selectedEvent.forecast}</div>
                          </div>
                          <div className="bg-slate-800/50 rounded-lg p-4">
                            <div className="text-xs text-slate-500 mb-1">Previous</div>
                            <div className="text-xl font-bold">{selectedEvent.singleEvent?.previous || selectedEvent.previous}</div>
                          </div>
                        </div>

                        <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                          <div className="text-sm font-semibold text-blue-300 mb-2">Description:</div>
                          <p className="text-sm text-blue-200">{selectedEvent.singleEvent?.description || selectedEvent.description}</p>
                        </div>

                        <div className="bg-violet-500/10 border border-violet-500/30 rounded-lg p-4">
                          <div className="text-sm font-semibold text-violet-300 mb-2">Market Impact:</div>
                          <p className="text-sm text-violet-200">{selectedEvent.singleEvent?.impact || selectedEvent.impact}</p>
                        </div>
                      </>
                    )}
                  </div>

                  <button
                    onClick={() => setSelectedEvent(null)}
                    className="w-full bg-violet-600 hover:bg-violet-500 py-3 rounded-lg font-semibold mt-4"
                  >
                    Close
                  </button>
                </div>
              </div>
            )}
          </div>
        )}

        {/* TRADE IDEAS TAB */}
        {activeTab === "tradeideas" && (
          <div className="space-y-4 md:space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-3xl font-bold flex items-center gap-3">
                  <Sparkles className="w-8 h-8 text-violet-400" />
                  Trade Ideas
                </h2>
                <p className="text-slate-400 mt-1">{new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
              </div>
              <button
                onClick={generateRealTradeIdeas}
                disabled={loadingTradeIdeas}
                className="px-6 py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-lg font-semibold flex items-center gap-2 disabled:opacity-50"
              >
                <Sparkles className={`w-5 h-5 ${loadingTradeIdeas ? 'animate-spin' : ''}`} />
                <span>{loadingTradeIdeas ? `⚡ Fast Scanning...` : '⚡ Find Trading Opportunities'}</span>
              </button>
            </div>

            <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4">
              <div className="flex items-start gap-3">
                <BarChart3 className="w-5 h-5 text-emerald-400 flex-shrink-0 mt-0.5" />
                <div className="text-sm text-emerald-200">
                  <p className="font-semibold mb-1">📊 Real Technical Analysis (Same as Daily Pick):</p>
                  <p className="text-emerald-300">
                    Scans <strong>220+ stocks across 15 sectors</strong> using parallel batch processing. Uses <strong>real-time indicators</strong>: RSI (14), MACD histogram, SMA20/SMA50, trend detection, and volume analysis. Results cached for 5 minutes.
                    Only shows stocks with clear <strong>BUY</strong> or <strong>SELL</strong> signals - HOLD recommendations are filtered out.
                  </p>
                </div>
              </div>
            </div>

            {/* Progress Indicator */}
            {loadingTradeIdeas && tradeIdeasProgress.total > 0 && (
              <div className="bg-slate-800/50 border border-violet-500/30 rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 bg-violet-500 rounded-full animate-pulse" />
                    <span className="text-sm text-violet-300 font-medium">
                      {tradeIdeasProgress.phase === 'starting' ? 'Starting scan...' :
                       tradeIdeasProgress.phase === 'scanning' ? `Scanning ${tradeIdeasProgress.current} of ${tradeIdeasProgress.total} stocks...` :
                       tradeIdeasProgress.phase === 'complete' ? 'Complete!' : 'Processing...'}
                    </span>
                  </div>
                  <span className="text-sm text-violet-400 font-bold">
                    {Math.round((tradeIdeasProgress.current / tradeIdeasProgress.total) * 100)}%
                  </span>
                </div>
                <div className="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                  <div
                    className="bg-gradient-to-r from-violet-500 to-purple-500 h-full rounded-full transition-all duration-300"
                    style={{ width: `${(tradeIdeasProgress.current / tradeIdeasProgress.total) * 100}%` }}
                  />
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  ⚡ Parallel processing: analyzing 10 stocks per batch across 220+ symbols with 5-minute cache
                </p>
              </div>
            )}

            {/* Scan Complete Message */}
            {!loadingTradeIdeas && tradeIdeasProgress.scanTime > 0 && tradeIdeas.length > 0 && (
              <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg px-4 py-2 flex items-center justify-between">
                <span className="text-sm text-emerald-300">
                  ✅ Found {tradeIdeas.length} opportunities
                </span>
                <span className="text-sm text-emerald-400 font-bold">
                  ⚡ {tradeIdeasProgress.scanTime}s scan time
                </span>
              </div>
            )}

            {tradeIdeas.length === 0 && !loadingTradeIdeas ? (
              <div className="bg-slate-800/30 rounded-lg p-12 text-center">
                <Sparkles className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">No Trade Ideas Yet</h3>
                <p className="text-slate-400 mb-6">
                  Click "Find Trading Opportunities" to scan 200+ stocks with real technical analysis. Only stocks with clear BUY or SELL signals are shown - no HOLD recommendations!
                </p>
              </div>
            ) : (
              <div className="space-y-3 md:space-y-4">
                {tradeIdeas.map((idea) => (
                  <div key={idea.id} className="bg-slate-900/50 rounded-lg p-6 border border-slate-700 hover:border-violet-600/50 transition-all">
                    <div className="flex justify-between items-start mb-4">
                      <div className="flex items-start gap-4">
                        {/* BUY/SELL Recommendation Badge */}
                        <div className={`px-4 py-3 rounded-xl font-bold text-lg ${
                          idea.recommendation?.includes('STRONG_BUY') ? 'bg-emerald-600 text-white' :
                          idea.recommendation?.includes('BUY') ? 'bg-green-600/80 text-white' :
                          idea.recommendation?.includes('STRONG_SELL') ? 'bg-red-600 text-white' :
                          idea.recommendation?.includes('SELL') ? 'bg-red-500/80 text-white' :
                          'bg-yellow-600/80 text-white'
                        }`}>
                          {idea.recommendation?.includes('BUY') ? (
                            <TrendingUp className="w-5 h-5 inline mr-1" />
                          ) : (
                            <TrendingDown className="w-5 h-5 inline mr-1" />
                          )}
                          {idea.recommendation?.replace(/_/g, ' ') || idea.direction}
                        </div>
                        <div>
                          <h3 className="text-2xl font-bold mb-1">{idea.symbol}</h3>
                          <p className="text-slate-400">{idea.analysis || idea.signal || 'Technical Setup'}</p>
                          <div className="flex items-center gap-3 mt-1">
                            {idea.usedLiveData && (
                              <div className="flex items-center gap-1">
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse" />
                                <span className="text-xs text-green-400">Live Data</span>
                              </div>
                            )}
                            {/* Volatility Indicator - 5 Levels */}
                            {idea.volatility && (
                              <div className={`flex items-center gap-1 px-2 py-0.5 rounded-full text-xs ${
                                idea.volatility.category === 'Low' ? 'bg-cyan-500/20 text-cyan-300' :
                                idea.volatility.category === 'Low-Medium' ? 'bg-blue-500/20 text-blue-300' :
                                idea.volatility.category === 'Medium' ? 'bg-violet-500/20 text-violet-300' :
                                idea.volatility.category === 'Medium-High' ? 'bg-amber-500/20 text-amber-300' :
                                idea.volatility.category === 'High' ? 'bg-red-500/20 text-red-300' :
                                'bg-violet-500/20 text-violet-300'
                              }`}>
                                <Activity className="w-3 h-3" />
                                {idea.volatility.category} ({idea.volatility.atrPercent}%)
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                      {/* Confidence Score with Tooltip */}
                      <div className="relative group">
                        <div className={`px-4 py-2 rounded-lg font-bold text-lg cursor-help flex items-center gap-1 ${
                          (idea.confidence || 70) >= 75 ? 'bg-emerald-600/20 text-emerald-400 border border-emerald-600/30' :
                          (idea.confidence || 70) >= 65 ? 'bg-blue-600/20 text-blue-400 border border-blue-600/30' :
                          'bg-yellow-600/20 text-yellow-400 border border-yellow-600/30'
                        }`}>
                          {idea.confidence || 75}%
                          <HelpCircle className="w-3 h-3 opacity-50" />
                        </div>
                        {/* Confidence Tooltip */}
                        <div className="absolute right-0 top-full mt-2 w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-xl z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                          <div className="text-xs text-slate-200 font-semibold mb-2">Confidence Score Breakdown:</div>
                          <ul className="text-xs text-slate-300 space-y-1">
                            <li className="flex items-start gap-1">
                              <span className="text-emerald-400">•</span>
                              <span>Technical indicator alignment (RSI, MACD, trend)</span>
                            </li>
                            <li className="flex items-start gap-1">
                              <span className="text-blue-400">•</span>
                              <span>Number of confirming signals</span>
                            </li>
                            <li className="flex items-start gap-1">
                              <span className="text-amber-400">•</span>
                              <span>Volume confirmation strength</span>
                            </li>
                            <li className="flex items-start gap-1">
                              <span className="text-violet-400">•</span>
                              <span>Catalyst & event bonuses</span>
                            </li>
                          </ul>
                          <div className="text-xs text-slate-400 mt-2 pt-2 border-t border-slate-700">
                            <div className="flex justify-between"><span>75%+ =</span><span className="text-emerald-400">High confidence</span></div>
                            <div className="flex justify-between"><span>65-74% =</span><span className="text-blue-400">Moderate confidence</span></div>
                            <div className="flex justify-between"><span>&lt;65% =</span><span className="text-yellow-400">Lower confidence</span></div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Technical Indicators Panel */}
                    {idea.technicalData && (
                      <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 mb-4">
                        <div className="text-xs text-blue-400 font-semibold mb-2">📊 CALCULATED INDICATORS</div>
                        <div className="grid grid-cols-5 gap-3">
                          <div className="text-center">
                            <div className="text-xs text-slate-500">RSI</div>
                            <div className={`font-bold ${
                              parseFloat(idea.technicalData.rsi) > 70 ? 'text-red-400' :
                              parseFloat(idea.technicalData.rsi) < 30 ? 'text-emerald-400' :
                              'text-violet-400'
                            }`}>
                              {idea.technicalData.rsi || 'N/A'}
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500">MACD</div>
                            <div className={`font-bold ${
                              parseFloat(idea.technicalData.macdHistogram) > 0 ? 'text-emerald-400' : 'text-red-400'
                            }`}>
                              {parseFloat(idea.technicalData.macdHistogram) > 0 ? '▲' : '▼'}
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500">Trend</div>
                            <div className={`font-bold text-sm ${
                              idea.technicalData.trend === 'UPTREND' ? 'text-emerald-400' :
                              idea.technicalData.trend === 'DOWNTREND' ? 'text-red-400' :
                              'text-yellow-400'
                            }`}>
                              {idea.technicalData.trend?.replace('TREND', '') || 'N/A'}
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500">Score</div>
                            <div className="font-bold">
                              <span className="text-emerald-400">{idea.technicalData.bullishScore}</span>
                              <span className="text-slate-500">/</span>
                              <span className="text-red-400">{idea.technicalData.bearishScore}</span>
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500">Volume</div>
                            <div className={`font-bold ${
                              parseFloat(idea.technicalData.volumeRatio) > 1.5 ? 'text-emerald-400' : 'text-slate-400'
                            }`}>
                              {idea.technicalData.volumeRatio || '1.0'}x
                            </div>
                          </div>
                        </div>
                        <div className="flex gap-2 mt-2">
                          <span className={`px-2 py-0.5 rounded text-xs ${idea.technicalData.aboveSMA20 ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}`}>
                            {idea.technicalData.aboveSMA20 ? '✓' : '✗'} SMA20
                          </span>
                          {idea.technicalData.aboveSMA50 !== null && (
                            <span className={`px-2 py-0.5 rounded text-xs ${idea.technicalData.aboveSMA50 ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}`}>
                              {idea.technicalData.aboveSMA50 ? '✓' : '✗'} SMA50
                            </span>
                          )}
                        </div>
                      </div>
                    )}

                    <div className="grid grid-cols-4 gap-4 mb-4">
                      <div className="bg-slate-800/50 rounded-lg p-3">
                        <div className="text-xs text-slate-500 mb-1">Entry</div>
                        <div className="text-lg font-bold text-green-400">${idea.entry || '---'}</div>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-3">
                        <div className="text-xs text-slate-500 mb-1">Stop Loss</div>
                        <div className="text-lg font-bold text-red-400">${idea.stopLoss || '---'}</div>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-3">
                        <div className="text-xs text-slate-500 mb-1">Target</div>
                        <div className="text-lg font-bold text-blue-400">${idea.target || '---'}</div>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-3">
                        <div className="text-xs text-slate-500 mb-1">R:R Ratio</div>
                        <div className="text-lg font-bold text-violet-400">{idea.riskReward || '1:2'}</div>
                      </div>
                    </div>

                    <div className="mb-4">
                      <div className="text-sm text-slate-400 mb-2 font-semibold">✓ Technical Signals:</div>
                      <div className="flex flex-wrap gap-2">
                        {(idea.factors || idea.momentumFactors || ['Signal']).map((factor, i) => (
                          <span key={i} className={`px-3 py-1 rounded-full text-xs ${
                            factor.toLowerCase().includes('bullish') || factor.toLowerCase().includes('above') || factor.toLowerCase().includes('uptrend')
                              ? 'bg-emerald-600/20 text-emerald-300'
                              : factor.toLowerCase().includes('bearish') || factor.toLowerCase().includes('below') || factor.toLowerCase().includes('downtrend')
                              ? 'bg-red-600/20 text-red-300'
                              : 'bg-violet-600/20 text-violet-300'
                          }`}>
                            {factor}
                          </span>
                        ))}
                      </div>
                    </div>

                    {/* Stock Catalysts & Events for Trade Ideas */}
                    {idea.catalystData && (idea.catalystData.upcomingEvents?.length > 0 || idea.catalystData.catalysts?.length > 0 || idea.catalystData.earnings) && (
                      <div className="bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/30 rounded-lg p-4 mb-4">
                        <div className="text-xs text-amber-400 font-semibold mb-2 flex items-center gap-1">
                          <Flame className="w-3 h-3" />
                          CATALYSTS & EVENTS
                          {idea.catalystData.catalystBonus !== 0 && (
                            <span className={`ml-2 px-1.5 py-0.5 rounded text-[10px] ${
                              idea.catalystData.catalystBonus > 0
                                ? 'bg-emerald-500/30 text-emerald-300'
                                : 'bg-red-500/30 text-red-300'
                            }`}>
                              {idea.catalystData.catalystBonus > 0 ? '+' : ''}{idea.catalystData.catalystBonus} score
                            </span>
                          )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                          {/* Upcoming Events */}
                          {idea.catalystData.upcomingEvents?.length > 0 && (
                            <div>
                              <div className="text-[10px] text-slate-400 mb-1">Upcoming:</div>
                              <ul className="space-y-0.5">
                                {idea.catalystData.upcomingEvents.slice(0, 2).map((event, i) => (
                                  <li key={i} className="text-xs text-slate-200 flex items-start gap-1">
                                    <Sparkles className="w-2.5 h-2.5 text-amber-400 mt-0.5 flex-shrink-0" />
                                    {event.length > 40 ? event.substring(0, 40) + '...' : event}
                                  </li>
                                ))}
                              </ul>
                            </div>
                          )}
                          {/* Catalysts */}
                          {idea.catalystData.catalysts?.length > 0 && (
                            <div>
                              <div className="text-[10px] text-slate-400 mb-1">Catalysts:</div>
                              <ul className="space-y-0.5">
                                {idea.catalystData.catalysts.slice(0, 2).map((catalyst, i) => (
                                  <li key={i} className="text-xs text-emerald-300 flex items-start gap-1">
                                    <ArrowUpRight className="w-2.5 h-2.5 mt-0.5 flex-shrink-0" />
                                    {catalyst.length > 35 ? catalyst.substring(0, 35) + '...' : catalyst}
                                  </li>
                                ))}
                              </ul>
                            </div>
                          )}
                          {/* Risks/Earnings */}
                          <div>
                            {idea.catalystData.earnings && (
                              <div className="mb-1">
                                <div className="text-[10px] text-slate-400">Earnings:</div>
                                <div className="text-xs text-violet-300">{idea.catalystData.earnings.substring(0, 30)}...</div>
                              </div>
                            )}
                            {idea.catalystData.risks?.length > 0 && (
                              <div>
                                <div className="text-[10px] text-slate-400">Key Risk:</div>
                                <div className="text-xs text-red-300 flex items-start gap-1">
                                  <AlertTriangle className="w-2.5 h-2.5 mt-0.5 flex-shrink-0" />
                                  {idea.catalystData.risks[0].length > 35 ? idea.catalystData.risks[0].substring(0, 35) + '...' : idea.catalystData.risks[0]}
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                        {/* Seasonality & Sector */}
                        <div className="flex gap-2 mt-2">
                          {idea.catalystData.seasonality && idea.catalystData.seasonality !== 'neutral' && (
                            <span className={`px-2 py-0.5 rounded text-[10px] ${
                              idea.catalystData.seasonality === 'bullish'
                                ? 'bg-emerald-500/20 text-emerald-300'
                                : 'bg-red-500/20 text-red-300'
                            }`}>
                              {idea.catalystData.seasonality === 'bullish' ? '📈' : '📉'} {idea.catalystData.seasonality}
                            </span>
                          )}
                          {idea.catalystData.sectorTrend && (
                            <span className="px-2 py-0.5 rounded text-[10px] bg-blue-500/20 text-blue-300">
                              {idea.catalystData.sectorTrend.length > 30 ? idea.catalystData.sectorTrend.substring(0, 30) + '...' : idea.catalystData.sectorTrend}
                            </span>
                          )}
                        </div>
                      </div>
                    )}

                    <div className="flex gap-2">
                      <button 
                        onClick={() => {
                          setTickerSymbol(idea.symbol);
                          setActiveTab("ticker");
                        }}
                        className="flex-1 bg-violet-600 hover:bg-violet-500 py-2 rounded-lg font-semibold flex items-center justify-center gap-2"
                      >
                        <LineChart className="w-4 h-4" />
                        View Chart
                      </button>
                      <button
                        onClick={() => {
                          setNewTrade({
                            symbol: idea.symbol,
                            side: idea.direction === 'LONG' ? "long" : "short",
                            entry: idea.entry?.toString() || "",
                            exit: "",
                            avgPrice: "",
                            stopLoss: idea.stopLoss?.toString() || "",
                            target: idea.target?.toString() || "",
                            quantity: "",
                            entryDate: new Date().toISOString().split('T')[0],
                            exitDate: "",
                            notes: `Trade idea: ${idea.recommendation?.replace(/_/g, ' ')} - ${idea.analysis || idea.signal || ''}`,
                            linkedAnalysisId: null,
                            isPaperTrade: false,
                            confidence: idea.confidence?.toString() || ""
                          });
                          setActiveTab("journal");
                        }}
                        className="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded-lg font-semibold flex items-center justify-center gap-2"
                      >
                        <Plus className="w-4 h-4" />
                        Add to Journal
                      </button>
                      <button 
                        onClick={() => {
                          setAlerts([...alerts, {
                            id: Date.now(),
                            symbol: idea.symbol,
                            type: "price",
                            condition: idea.direction === 'LONG' ? "above" : "below",
                            price: idea.entry.toString(),
                            enabled: true,
                            message: `${idea.symbol} ${idea.recommendation?.replace(/_/g, ' ')} @ ${idea.entry}`
                          }]);
                          setActiveTab("alerts");
                        }}
                        className="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded-lg font-semibold flex items-center justify-center gap-2"
                      >
                        <Bell className="w-4 h-4" />
                        Set Alert
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* STOCK SCREENER TAB */}
        {activeTab === "screener" && (
          <div className="space-y-4 md:space-y-6">
            <div className="flex items-center justify-between">
              <h2 className="text-3xl font-bold flex items-center gap-3">
                <Search className="w-8 h-8 text-violet-400" />
                Stock Screener
              </h2>
            </div>

            <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
              <div className="flex items-start gap-3">
                <Search className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
                <div className="text-sm text-blue-200">
                  <p className="font-semibold mb-1">Find Trading Opportunities:</p>
                  <p className="text-blue-300">
                    Use pre-built scans or create custom criteria to find stocks matching your strategy. Click any result to analyze instantly.
                  </p>
                </div>
              </div>
            </div>

            {/* Screener Sub-tabs Navigation */}
            <div className="mb-6 flex gap-2 border-b border-slate-700">
              {[
                { id: 'screener', label: 'Screener', icon: Search },
                { id: 'premarketmovers', label: 'Pre-Market Movers', icon: TrendingUp },
                { id: 'patterns', label: 'Patterns', icon: Crosshair }
              ].map(tab => {
                const TabIcon = tab.icon;
                return (
                  <button
                    key={tab.id}
                    onClick={() => setScreenerSubTab(tab.id)}
                    className={`px-4 py-3 font-medium text-sm flex items-center gap-2 border-b-2 transition-colors ${
                      screenerSubTab === tab.id
                        ? 'border-violet-500 text-violet-400'
                        : 'border-transparent text-slate-500 hover:text-slate-400'
                    }`}
                  >
                    <TabIcon className="w-4 h-4" />
                    {tab.label}
                  </button>
                );
              })}
            </div>

            {screenerSubTab === 'screener' && (<>
            {/* ADVANCED PRESET STRATEGY SELECTOR */}
            <div className="bg-slate-900/50 rounded-lg p-6 border border-slate-700">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold">Strategy Presets</h3>
                <span className="text-xs bg-violet-500/20 text-violet-300 px-2 py-1 rounded-full">
                  {selectedScanPreset === 'custom' ? 'Custom Mode' : SCAN_PRESETS[selectedScanPreset]?.name}
                </span>
              </div>
              <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 mb-4">
                {Object.entries(SCAN_PRESETS).filter(([key]) => key !== 'custom').map(([key, preset]) => (
                  <button
                    key={key}
                    onClick={async () => {
                      setSelectedScanPreset(key);
                      if (scanResults.length === 0) {
                        setLoadingScanner(true);
                        try {
                          await scanRealMarket();
                        } finally {
                          setLoadingScanner(false);
                        }
                      }
                    }}
                    className={`p-3 rounded-xl text-left transition-all border ${
                      selectedScanPreset === key
                        ? 'bg-violet-600/20 border-violet-500/50 shadow-lg shadow-violet-500/10'
                        : 'bg-slate-800/40 border-slate-700/30 hover:border-slate-600/50 hover:bg-slate-800/60'
                    }`}
                  >
                    <div className="text-lg mb-1">{preset.icon}</div>
                    <div className="font-semibold text-sm mb-0.5">{preset.name}</div>
                    <div className="text-[10px] text-slate-500 leading-tight">{preset.description}</div>
                  </button>
                ))}
              </div>

              {/* Full Market Scan Button */}
              <button
                onClick={async () => {
                  setLoadingScanner(true);
                  try {
                    await scanRealMarket();
                  } finally {
                    setLoadingScanner(false);
                  }
                }}
                disabled={loadingScanner}
                className="w-full bg-gradient-to-r from-violet-600 to-purple-700 hover:from-violet-500 hover:to-purple-600 py-3 rounded-xl font-semibold disabled:opacity-50 transition-all flex items-center justify-center gap-2"
              >
                {loadingScanner ? (
                  <>
                    <Loader2 className="w-4 h-4 animate-spin" />
                    Scanning 220+ Stocks...
                  </>
                ) : (
                  <>
                    <Search className="w-4 h-4" />
                    Run Full Market Scan (220+ Stocks)
                  </>
                )}
              </button>

              {/* Scanner Progress */}
              {loadingScanner && scannerProgress && (
                <div className="mt-3">
                  <div className="flex justify-between text-xs text-slate-500 mb-1">
                    <span>{scannerProgress.phase === 'scanning' ? 'Scanning...' : scannerProgress.phase}</span>
                    <span>{scannerProgress.current || 0}/{scannerProgress.total || 0}</span>
                  </div>
                  <div className="w-full bg-slate-800 rounded-full h-1.5">
                    <div
                      className="bg-violet-500 h-1.5 rounded-full transition-all duration-300"
                      style={{ width: `${scannerProgress.total ? (scannerProgress.current / scannerProgress.total) * 100 : 0}%` }}
                    />
                  </div>
                </div>
              )}
            </div>

            <div className="bg-slate-900/50 rounded-lg p-6 border border-slate-700">
              <h3 className="text-lg font-semibold mb-4">Quick Scans</h3>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                <button
                  onClick={async () => {
                    setLoadingScanner(true);
                    try {
                      const results = await scanRealMarket();
                      if (results?.gainers?.length > 0) {
                        const breakouts = results.gainers.filter(s => (s.aboveSMA20 || (s.rsi || 0) > 55) && (s.changePercent || s.change || 0) > 0);
                        setScanResults(breakouts.length > 0 ? breakouts.slice(0, 10) : results.gainers.slice(0, 5));
                        setToast({ type: 'success', message: `Found ${breakouts.length || results.gainers.length} breakout candidates` });
                      } else { setScanResults([]); setToast({ type: 'info', message: 'No breakout stocks found right now' }); }
                    } catch (err) { console.error("[Breakout Scan]", err); setScanResults([]); setToast({ type: 'error', message: 'Scan failed — try again' }); }
                    finally { setLoadingScanner(false); }
                  }}
                  disabled={loadingScanner}
                  className="bg-gradient-to-br from-blue-900/20 to-blue-800/10 border border-blue-600/30 hover:border-blue-600/50 p-4 rounded-lg text-left transition-all disabled:opacity-50"
                >
                  <div className="text-blue-400 font-semibold mb-1">📈 Breakouts</div>
                  <div className="text-xs text-slate-400">Trending above SMA</div>
                </button>

                <button
                  onClick={async () => {
                    setLoadingScanner(true);
                    try {
                      const results = await scanRealMarket();
                      if (results?.losers?.length > 0) {
                        const oversold = results.losers.filter(s => (s.rsi || 50) < 40);
                        setScanResults(oversold.length > 0 ? oversold.slice(0, 10) : results.losers.slice(0, 5));
                        setToast({ type: 'success', message: `Found ${oversold.length || results.losers.length} oversold stocks` });
                      } else { setScanResults([]); setToast({ type: 'info', message: 'No oversold stocks found' }); }
                    } catch (err) { console.error("[Oversold Scan]", err); setScanResults([]); setToast({ type: 'error', message: 'Scan failed — try again' }); }
                    finally { setLoadingScanner(false); }
                  }}
                  disabled={loadingScanner}
                  className="bg-gradient-to-br from-violet-900/20 to-violet-800/10 border border-violet-600/30 hover:border-violet-600/50 p-4 rounded-lg text-left transition-all disabled:opacity-50"
                >
                  <div className="text-violet-400 font-semibold mb-1">💎 Oversold</div>
                  <div className="text-xs text-slate-400">RSI below 40</div>
                </button>

                <button
                  onClick={async () => {
                    setLoadingScanner(true);
                    try {
                      const results = await scanRealMarket();
                      if (results?.gainers?.length > 0) {
                        const overbought = results.gainers.filter(s => (s.rsi || 50) > 70);
                        setScanResults(overbought.length > 0 ? overbought.slice(0, 10) : results.gainers.slice(0, 5));
                        setToast({ type: 'success', message: `Found ${overbought.length || results.gainers.length} overbought stocks` });
                      } else { setScanResults([]); setToast({ type: 'info', message: 'No overbought stocks found' }); }
                    } catch (err) { console.error("[Overbought Scan]", err); setScanResults([]); setToast({ type: 'error', message: 'Scan failed — try again' }); }
                    finally { setLoadingScanner(false); }
                  }}
                  disabled={loadingScanner}
                  className="bg-gradient-to-br from-orange-900/20 to-orange-800/10 border border-orange-600/30 hover:border-orange-600/50 p-4 rounded-lg text-left transition-all disabled:opacity-50"
                >
                  <div className="text-orange-400 font-semibold mb-1">📉 Overbought</div>
                  <div className="text-xs text-slate-400">RSI above 70</div>
                </button>

                <button
                  onClick={async () => {
                    setLoadingScanner(true);
                    try {
                      const results = await scanRealMarket();
                      if (results?.volume?.length > 0) {
                        setScanResults(results.volume.slice(0, 10));
                        setToast({ type: 'success', message: `Found ${results.volume.length} high-volume stocks` });
                      } else { setScanResults([]); setToast({ type: 'info', message: 'No high volume stocks found' }); }
                    } catch (err) { console.error("[Volume Scan]", err); setScanResults([]); setToast({ type: 'error', message: 'Scan failed — try again' }); }
                    finally { setLoadingScanner(false); }
                  }}
                  disabled={loadingScanner}
                  className="bg-gradient-to-br from-red-900/20 to-red-800/10 border border-red-600/30 hover:border-red-600/50 p-4 rounded-lg text-left transition-all disabled:opacity-50"
                >
                  <div className="text-red-400 font-semibold mb-1">💰 High Volume</div>
                  <div className="text-xs text-slate-400">Unusual activity</div>
                </button>

                <button
                  onClick={async () => {
                    setLoadingScanner(true);
                    try {
                      const results = await scanRealMarket();
                      if (results?.losers?.length > 0) {
                        const dips = results.losers.filter(s => (s.rsi || 50) < 45 && (s.rsi || 50) > 20);
                        setScanResults(dips.length > 0 ? dips.slice(0, 10) : results.losers.slice(0, 5));
                        setToast({ type: 'success', message: `Found ${dips.length || results.losers.length} dip candidates` });
                      } else { setScanResults([]); setToast({ type: 'info', message: 'No dip opportunities found' }); }
                    } catch (err) { console.error("[Dip Scan]", err); setScanResults([]); setToast({ type: 'error', message: 'Scan failed — try again' }); }
                    finally { setLoadingScanner(false); }
                  }}
                  disabled={loadingScanner}
                  className="bg-gradient-to-br from-emerald-900/20 to-emerald-800/10 border border-emerald-600/30 hover:border-emerald-600/50 p-4 rounded-lg text-left transition-all disabled:opacity-50"
                >
                  <div className="text-emerald-400 font-semibold mb-1">🛒 Buy the Dip</div>
                  <div className="text-xs text-slate-400">Quality stocks pulling back</div>
                </button>
              </div>
            </div>

            <div className="bg-slate-900/50 rounded-lg p-6 border border-slate-700">
              <h3 className="text-lg font-semibold mb-4">Custom Screen</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Price Range</label>
                  <div className="flex gap-2">
                    <input
                      type="number"
                      placeholder="Min"
                      value={scanCriteria.minPrice || ''}
                      onChange={(e) => setScanCriteria({...scanCriteria, minPrice: parseFloat(e.target.value) || 0})}
                      className="flex-1 bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"
                    />
                    <input
                      type="number"
                      placeholder="Max"
                      value={scanCriteria.maxPrice || ''}
                      onChange={(e) => setScanCriteria({...scanCriteria, maxPrice: parseFloat(e.target.value) || 1000})}
                      className="flex-1 bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm text-slate-400 mb-2">Min Volume (M)</label>
                  <input
                    type="number"
                    placeholder="e.g., 1"
                    value={scanCriteria.minVolume || ''}
                    onChange={(e) => setScanCriteria({...scanCriteria, minVolume: parseFloat(e.target.value) || 0})}
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"
                  />
                </div>

                <div>
                  <label className="block text-sm text-slate-400 mb-2">RSI Range</label>
                  <div className="flex gap-2">
                    <input
                      type="number"
                      placeholder="Min"
                      value={scanCriteria.rsiMin || ''}
                      onChange={(e) => setScanCriteria({...scanCriteria, rsiMin: parseFloat(e.target.value) || 0})}
                      className="flex-1 bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"
                    />
                    <input
                      type="number"
                      placeholder="Max"
                      value={scanCriteria.rsiMax || ''}
                      onChange={(e) => setScanCriteria({...scanCriteria, rsiMax: parseFloat(e.target.value) || 100})}
                      className="flex-1 bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"
                    />
                  </div>
                </div>

                <div className="flex items-end">
                  <button
                    onClick={async () => {
                      setLoadingScanner(true);
                      try {
                        console.log("[Custom Scan] Running custom scan with criteria:", scanCriteria);
                        
                        // Use scanRealMarket to get fresh data
                        const results = await scanRealMarket();
                        
                        if (!results || (!results.gainers?.length && !results.losers?.length && !results.volume?.length)) {
                          alert("No stocks found matching criteria. Try during market hours or adjust filters.");
                          setScanResults([]);
                          return;
                        }
                        
                        // Combine all results
                        const allStocks = [
                          ...(results.gainers || []),
                          ...(results.losers || []),
                          ...(results.volume || [])
                        ];
                        
                        // Filter based on custom criteria
                        let filtered = allStocks.filter((stock, index, self) => 
                          // Remove duplicates by symbol
                          index === self.findIndex(s => s.symbol === stock.symbol)
                        );
                        
                        // Apply price filter
                        if (scanCriteria.minPrice > 0) {
                          filtered = filtered.filter(s => s.price >= scanCriteria.minPrice);
                        }
                        if (scanCriteria.maxPrice > 0 && scanCriteria.maxPrice < 10000) {
                          filtered = filtered.filter(s => s.price <= scanCriteria.maxPrice);
                        }
                        
                        // Apply RSI filter
                        if (scanCriteria.rsiMin > 0) {
                          filtered = filtered.filter(s => (s.rsi || 50) >= scanCriteria.rsiMin);
                        }
                        if (scanCriteria.rsiMax > 0 && scanCriteria.rsiMax < 100) {
                          filtered = filtered.filter(s => (s.rsi || 50) <= scanCriteria.rsiMax);
                        }
                        
                        console.log(`[Custom Scan] Found ${filtered.length} stocks matching criteria`);
                        
                        if (filtered.length === 0) {
                          alert("No stocks match your criteria. Try broadening your filters.");
                        }
                        
                        setScanResults(filtered.slice(0, 20)); // Limit to 20 results
                        
                      } catch (err) {
                        console.error("[Custom Scan] Error:", err);
                        alert("Custom scan failed: " + err.message);
                        setScanResults([]);
                      } finally {
                        setLoadingScanner(false);
                      }
                    }}
                    disabled={loadingScanner}
                    className="w-full bg-violet-600 hover:bg-violet-500 py-2 rounded-lg font-semibold disabled:opacity-50"
                  >
                    {loadingScanner ? 'Scanning...' : 'Run Custom Scan'}
                  </button>
                </div>
              </div>
            </div>

            {scanResults.length > 0 && (
              <div className="bg-slate-900/50 rounded-lg overflow-hidden border border-slate-700">
                <div className="p-4 border-b border-slate-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                  <div>
                    <h3 className="text-lg font-semibold">
                      Results ({getFilteredScanResults().length} stocks)
                      {selectedScanPreset !== 'custom' && (
                        <span className="ml-2 text-xs bg-violet-500/20 text-violet-300 px-2 py-0.5 rounded-full">
                          {SCAN_PRESETS[selectedScanPreset]?.icon} {SCAN_PRESETS[selectedScanPreset]?.name}
                        </span>
                      )}
                    </h3>
                    {scanResults[0]?.isLive && (
                      <p className="text-[10px] text-emerald-400 mt-0.5 flex items-center gap-1">
                        <span className="w-1.5 h-1.5 bg-emerald-400 rounded-full inline-block" /> Live market data
                      </p>
                    )}
                  </div>
                  <div className="flex items-center gap-2">
                    {selectedScanPreset !== 'custom' && (
                      <button
                        onClick={() => setSelectedScanPreset('custom')}
                        className="text-xs text-slate-500 hover:text-white px-2 py-1 bg-slate-800 rounded-lg transition-colors"
                      >
                        Clear Filter
                      </button>
                    )}
                  </div>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-slate-900/50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Symbol</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Price</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Change</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Volume</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">RSI</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 hidden md:table-cell">Trend</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 hidden md:table-cell">Signal</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Action</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-700">
                      {getFilteredScanResults().map((stock, i) => (
                        <tr key={i} className="hover:bg-slate-800/50 transition-colors">
                          <td className="px-4 py-3">
                            <div className="font-semibold">{stock.symbol}</div>
                            <div className="text-[10px] text-slate-500">{getCompanyName(stock.symbol)}</div>
                          </td>
                          <td className="px-4 py-3 tabular-nums">${typeof stock.price === 'number' ? stock.price.toFixed(2) : stock.price || '---'}</td>
                          <td className="px-4 py-3">
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${(stock.change || 0) >= 0 ? "bg-emerald-500/10 text-emerald-400" : "bg-red-500/10 text-red-400"}`}>
                              {(stock.change || 0) >= 0 ? "+" : ""}{typeof stock.change === 'number' ? stock.change.toFixed(2) : stock.change || '0'}%
                            </span>
                          </td>
                          <td className="px-4 py-3 text-sm text-slate-400">{stock.volume || '---'}</td>
                          <td className="px-4 py-3">
                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                              (stock.rsi || 50) > 70 ? 'bg-red-500/15 text-red-400' :
                              (stock.rsi || 50) < 30 ? 'bg-emerald-500/15 text-emerald-400' :
                              'bg-slate-700/50 text-slate-300'
                            }`}>
                              {Math.round(stock.rsi || 50)}
                            </span>
                          </td>
                          <td className="px-4 py-3 hidden md:table-cell">
                            <span className={`text-xs font-medium ${
                              stock.trend === 'UP' ? 'text-emerald-400' : stock.trend === 'DOWN' ? 'text-red-400' : 'text-slate-500'
                            }`}>
                              {stock.trend === 'UP' ? '↑ Up' : stock.trend === 'DOWN' ? '↓ Down' : '→ Flat'}
                            </span>
                          </td>
                          <td className="px-4 py-3 hidden md:table-cell">
                            {stock.recommendation && (
                              <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${
                                stock.recommendation === 'BUY' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' :
                                stock.recommendation === 'SELL' ? 'bg-red-500/20 text-red-400 border border-red-500/30' :
                                stock.recommendation === 'LEAN_BUY' ? 'bg-emerald-500/10 text-emerald-500/70' :
                                stock.recommendation === 'LEAN_SELL' ? 'bg-red-500/10 text-red-500/70' :
                                'bg-slate-700/50 text-slate-400'
                              }`}>
                                {(stock.recommendation || 'HOLD').replace('_', ' ')}
                              </span>
                            )}
                          </td>
                          <td className="px-4 py-3">
                            <div className="flex items-center gap-2">
                              <button
                                onClick={() => {
                                  setTickerSymbol(stock.symbol);
                                  setActiveTab("ticker");
                                }}
                                className="text-violet-400 hover:text-violet-300 text-sm font-semibold"
                              >
                                Analyze →
                              </button>
                              <button
                                onClick={() => {
                                  if (!watchlist.includes(stock.symbol)) {
                                    setWatchlist([...watchlist, stock.symbol]);
                                  }
                                }}
                                className={`text-xs p-1 rounded ${watchlist.includes(stock.symbol) ? 'text-amber-400' : 'text-slate-600 hover:text-slate-400'}`}
                                title={watchlist.includes(stock.symbol) ? 'In watchlist' : 'Add to watchlist'}
                              >
                                <Star className="w-3.5 h-3.5" fill={watchlist.includes(stock.symbol) ? 'currentColor' : 'none'} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {scanResults.length === 0 && (
              <div className="bg-slate-800/30 rounded-lg p-12 text-center">
                <Search className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">No Results Yet</h3>
                <p className="text-slate-400">
                  Run a pre-built scan or create custom criteria to find stocks
                </p>
              </div>
            )}
            </>)}

            {/* PRE-MARKET MOVERS SUB-TAB */}
            {screenerSubTab === 'premarketmovers' && (
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="bg-slate-800/30 rounded-xl border border-slate-700/20 p-6">
                    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2 text-emerald-400">
                      <TrendingUp className="w-5 h-5" />
                      Top Gainers
                    </h3>
                    {scanResults.length > 0 ? (
                      <div className="space-y-2">
                        {scanResults
                          .filter(s => (s.changePercent || 0) > 0)
                          .sort((a, b) => (b.changePercent || 0) - (a.changePercent || 0))
                          .slice(0, 10)
                          .map((stock, idx) => (
                            <div key={idx} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg hover:bg-slate-900/80 cursor-pointer transition-colors">
                              <div>
                                <div className="font-semibold">{stock.symbol}</div>
                                <div className="text-xs text-slate-400">${stock.price?.toFixed(2) || '0.00'}</div>
                              </div>
                              <div className="text-right">
                                <div className="text-emerald-400 font-semibold">+{(stock.changePercent || 0).toFixed(2)}%</div>
                                <div className="text-xs text-slate-400">Vol: {(stock.volume || 0) / 1000000 > 1 ? `${(stock.volume / 1000000).toFixed(1)}M` : `${stock.volume || 0}K`}</div>
                              </div>
                            </div>
                          ))}
                      </div>
                    ) : (
                      <p className="text-slate-400">No data available</p>
                    )}
                  </div>

                  <div className="bg-slate-800/30 rounded-xl border border-slate-700/20 p-6">
                    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2 text-red-400">
                      <TrendingDown className="w-5 h-5" />
                      Top Losers
                    </h3>
                    {scanResults.length > 0 ? (
                      <div className="space-y-2">
                        {scanResults
                          .filter(s => (s.changePercent || 0) < 0)
                          .sort((a, b) => (a.changePercent || 0) - (b.changePercent || 0))
                          .slice(0, 10)
                          .map((stock, idx) => (
                            <div key={idx} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg hover:bg-slate-900/80 cursor-pointer transition-colors">
                              <div>
                                <div className="font-semibold">{stock.symbol}</div>
                                <div className="text-xs text-slate-400">${stock.price?.toFixed(2) || '0.00'}</div>
                              </div>
                              <div className="text-right">
                                <div className="text-red-400 font-semibold">{(stock.changePercent || 0).toFixed(2)}%</div>
                                <div className="text-xs text-slate-400">Vol: {(stock.volume || 0) / 1000000 > 1 ? `${(stock.volume / 1000000).toFixed(1)}M` : `${stock.volume || 0}K`}</div>
                              </div>
                            </div>
                          ))}
                      </div>
                    ) : (
                      <p className="text-slate-400">No data available</p>
                    )}
                  </div>
                </div>

                <div className="bg-slate-800/30 rounded-xl border border-slate-700/20 p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <Activity className="w-5 h-5 text-violet-400" />
                    High Volume Stocks
                  </h3>
                  {scanResults.length > 0 ? (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {scanResults
                        .filter(s => (s.volume || 0) > 1000000)
                        .sort((a, b) => (b.volume || 0) - (a.volume || 0))
                        .slice(0, 6)
                        .map((stock, idx) => (
                          <div key={idx} className="bg-slate-900/50 rounded-lg p-4 border border-slate-700/30">
                            <div className="flex items-center justify-between mb-2">
                              <span className="font-semibold text-lg">{stock.symbol}</span>
                              <span className={`text-sm ${(stock.changePercent || 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                {(stock.changePercent || 0) >= 0 ? '+' : ''}{(stock.changePercent || 0).toFixed(2)}%
                              </span>
                            </div>
                            <div className="text-xs text-slate-400 mb-3">
                              Volume: {(stock.volume / 1000000).toFixed(1)}M
                            </div>
                            <div className="w-full bg-slate-800 rounded h-2 overflow-hidden">
                              <div className="bg-violet-500 h-full" style={{ width: '100%' }} />
                            </div>
                          </div>
                        ))}
                    </div>
                  ) : (
                    <p className="text-slate-400">No data available</p>
                  )}
                </div>
              </div>
            )}

            {/* PATTERNS SUB-TAB */}
            {screenerSubTab === 'patterns' && (
              <div className="space-y-6">
                <div className="bg-slate-800/30 rounded-xl border border-slate-700/20 p-6">
                  <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                    <Crosshair className="w-5 h-5 text-violet-400" />
                    Chart Patterns Detected
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {patternResults && patternResults.length > 0 ? (
                      patternResults.map((pattern, idx) => (
                        <div key={idx} className="bg-slate-900/50 rounded-lg p-5 border border-slate-700/30 hover:border-violet-500/50 transition-colors">
                          <div className="flex items-start justify-between mb-3">
                            <div>
                              <div className="text-xl font-bold text-violet-400">{pattern.ticker}</div>
                              <div className="text-sm text-slate-400">{pattern.pattern}</div>
                            </div>
                            <div className="text-right">
                              <div className="text-2xl font-bold">{pattern.confidence}%</div>
                              <div className="text-xs text-emerald-400">Confidence</div>
                            </div>
                          </div>
                          <div className="flex items-center justify-between text-xs">
                            <span className="text-slate-500">Timeframe: {pattern.timeframe}</span>
                            <button
                              onClick={() => {
                                setTickerSymbol(pattern.ticker);
                                setActiveTab('ticker');
                              }}
                              className="text-violet-400 hover:text-violet-300"
                            >
                              View Chart →
                            </button>
                          </div>
                        </div>
                      ))
                    ) : (
                      <p className="text-slate-400 col-span-2">Run a scan to detect chart patterns</p>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* PHASE 1: LIVE PORTFOLIO TAB */}
        {activeTab === "liveportfolio" && (
          <div className="max-w-7xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-3xl font-bold flex items-center gap-3">
                  <TrendingUp className="w-8 h-8 text-violet-400" />
                  Live Portfolio Tracker
                  <span className="text-xs bg-emerald-600 px-2 py-1 rounded">NEW</span>
                </h2>
                <p className="text-slate-400 mt-2">Track real positions with live P&L updates every 5 seconds</p>
              </div>
              <button
                onClick={() => setShowAddPortfolioPosition(true)}
                className="bg-violet-600 hover:bg-violet-500 px-6 py-3 rounded-lg font-semibold transition-colors flex items-center gap-2"
              >
                <Plus className="w-5 h-5" />
                Add Position
              </button>
            </div>

            {/* Portfolio Summary Cards */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div className="bg-gradient-to-br from-violet-900/30 to-violet-800/10 border border-violet-500/30 rounded-lg p-6">
                <div className="text-xs text-slate-400 mb-2">Total Value</div>
                <div className="text-3xl font-bold">${(livePortfolio.totalValue || 0).toLocaleString()}</div>
              </div>
              
              <div className={`bg-gradient-to-br ${(livePortfolio.dailyChange || 0) >= 0 ? 'from-green-900/30 to-green-800/10 border-green-500/30' : 'from-red-900/30 to-red-800/10 border-red-500/30'} border rounded-lg p-6`}>
                <div className="text-xs text-slate-400 mb-2">Daily Change</div>
                <div className={`text-3xl font-bold ${(livePortfolio.dailyChange || 0) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                  {(livePortfolio.dailyChange || 0) >= 0 ? '+' : ''}${(livePortfolio.dailyChange || 0).toFixed(2)}
                </div>
              </div>
              
              <div className={`bg-gradient-to-br ${(livePortfolio.totalPnL || 0) >= 0 ? 'from-emerald-900/30 to-emerald-800/10 border-emerald-500/30' : 'from-red-900/30 to-red-800/10 border-red-500/30'} border rounded-lg p-6`}>
                <div className="text-xs text-slate-400 mb-2">Total P&L</div>
                <div className={`text-3xl font-bold ${(livePortfolio.totalPnL || 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                  {(livePortfolio.totalPnL || 0) >= 0 ? '+' : ''}${(livePortfolio.totalPnL || 0).toFixed(2)}
                </div>
              </div>
              
              <div className="bg-gradient-to-br from-blue-900/30 to-blue-800/10 border border-blue-500/30 rounded-lg p-6">
                <div className="text-xs text-slate-400 mb-2">Available Cash</div>
                <div className="text-3xl font-bold text-blue-400">${(livePortfolio.cash || 0).toLocaleString()}</div>
              </div>
            </div>

            {livePortfolio.positions.length === 0 ? (
              <div className="bg-slate-800/30 rounded-lg p-12 text-center">
                <TrendingUp className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">No Positions Yet</h3>
                <p className="text-slate-400 mb-6">Start tracking your real portfolio with live updates</p>
                <button
                  onClick={() => setShowAddPortfolioPosition(true)}
                  className="bg-violet-600 hover:bg-violet-500 px-6 py-3 rounded-lg font-semibold transition-colors"
                >
                  Add Your First Position
                </button>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {livePortfolio.positions.map((position, idx) => (
                  <div key={idx} className={`bg-slate-800/30 rounded-lg p-6 border-2 transition-all ${
                    position.pnl >= 0 ? 'border-green-500/30' : 'border-red-500/30'
                  }`}>
                    <div className="flex items-start justify-between mb-4">
                      <div>
                        <h3 className="text-2xl font-bold">{position.symbol}</h3>
                        <p className="text-xs text-slate-500">{position.quantity} shares</p>
                      </div>
                      <button
                        onClick={() => {
                          setLivePortfolio(prev => ({
                            ...prev,
                            positions: prev.positions.filter((_, i) => i !== idx)
                          }));
                        }}
                        className="text-red-400 hover:text-red-300 text-xs"
                      >
                        Remove
                      </button>
                    </div>
                    
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-slate-400">Entry Price:</span>
                        <span className="font-semibold">${(position.entryPrice || 0).toFixed(2)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-slate-400">Current Price:</span>
                        <span className="font-semibold">${(position.currentPrice || 0).toFixed(2)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-slate-400">P&L:</span>
                        <span className={`font-bold ${(position.pnl || 0) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                          {(position.pnl || 0) >= 0 ? '+' : ''}${(position.pnl || 0).toFixed(2)} ({(position.pnlPercent || 0) >= 0 ? '+' : ''}{(position.pnlPercent || 0).toFixed(2)}%)
                        </span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            <div className="mt-6 bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
              <p className="text-sm text-blue-200">
                <strong>Real-time updates:</strong> Prices update every 5 seconds. This portfolio is separate from Paper Trading.
              </p>
            </div>
          </div>
        )}

        {/* PHASE 1: WATCHLIST TAB */}
        {activeTab === "watchlist" && (
          <div className="max-w-7xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-3xl font-bold flex items-center gap-3">
                  <Eye className="w-8 h-8 text-violet-400" />
                  Watchlist
                </h2>
                <p className="text-slate-400 mt-2">Monitor multiple stocks with live price updates</p>
              </div>
              
              <div className="flex items-center gap-3">
                <input
                  type="text"
                  value={addToWatchlistSymbol}
                  onChange={(e) => setAddToWatchlistSymbol(e.target.value.toUpperCase())}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter' && addToWatchlistSymbol.trim()) {
                      if (!watchlist.includes(addToWatchlistSymbol.trim())) {
                        setWatchlist([...watchlist, addToWatchlistSymbol.trim()]);
                      }
                      setAddToWatchlistSymbol('');
                    }
                  }}
                  placeholder="Enter symbol..."
                  className="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm"
                />
                <button
                  onClick={() => {
                    if (addToWatchlistSymbol.trim() && !watchlist.includes(addToWatchlistSymbol.trim())) {
                      setWatchlist([...watchlist, addToWatchlistSymbol.trim()]);
                      setAddToWatchlistSymbol('');
                    }
                  }}
                  className="bg-violet-600 hover:bg-violet-500 px-6 py-2 rounded-lg font-semibold transition-colors"
                >
                  Add Symbol
                </button>
              </div>
            </div>

            {/* Group Tabs — synced with dashboard widget + floating panel */}
            {(() => {
              const pageGroupNames = Object.keys(watchlistGroups);
              const pageFilteredWatchlist = activeWatchlistGroup === 'All' ? watchlist : (watchlistGroups[activeWatchlistGroup] || []).filter(s => watchlist.includes(s));
              return (<>
              <div className="flex items-center gap-2 mb-4 flex-wrap">
                {pageGroupNames.map(g => (
                  <div key={g} className="relative group/grp">
                    <button onClick={() => setActiveWatchlistGroup(g)}
                      className={`text-sm px-4 py-1.5 rounded-lg transition-all font-medium ${activeWatchlistGroup === g ? 'bg-violet-600 text-white shadow-lg shadow-violet-500/20' : 'bg-slate-800/50 text-slate-400 hover:text-white hover:bg-slate-700/50'}`}>
                      {g}
                      {g !== 'All' && <span className="ml-1.5 text-[10px] opacity-60">({(watchlistGroups[g] || []).filter(s => watchlist.includes(s)).length})</span>}
                    </button>
                    {g !== 'All' && (
                      <button onClick={() => { setWatchlistGroups(prev => { const u = {...prev}; delete u[g]; return u; }); if (activeWatchlistGroup === g) setActiveWatchlistGroup('All'); }}
                        className="absolute -top-1.5 -right-1.5 w-4 h-4 bg-red-500/80 rounded-full text-white text-[8px] flex items-center justify-center opacity-0 group-hover/grp:opacity-100 transition-opacity hover:bg-red-500"
                        title={`Delete ${g} group`}>×</button>
                    )}
                  </div>
                ))}
                {!showGroupManager ? (
                  <button onClick={() => setShowGroupManager(true)}
                    className="text-sm px-3 py-1.5 rounded-lg border border-dashed border-slate-600 text-slate-500 hover:text-violet-400 hover:border-violet-500/40 transition-all">
                    + New Group
                  </button>
                ) : (
                  <div className="flex items-center gap-2">
                    <input value={newGroupName} onChange={e => setNewGroupName(e.target.value)} placeholder="Group name..."
                      onKeyDown={e => { if (e.key === 'Enter' && newGroupName.trim()) { setWatchlistGroups(prev => ({...prev, [newGroupName.trim()]: []})); setNewGroupName(''); setShowGroupManager(false); } if (e.key === 'Escape') setShowGroupManager(false); }}
                      className="text-sm bg-slate-800 border border-slate-600 rounded-lg px-3 py-1.5 w-32 text-white outline-none focus:border-violet-500/50"
                      autoFocus />
                    <button onClick={() => { if (newGroupName.trim()) { setWatchlistGroups(prev => ({...prev, [newGroupName.trim()]: []})); setNewGroupName(''); setShowGroupManager(false); }}}
                      className="text-emerald-400 hover:text-emerald-300 text-sm font-bold">✓</button>
                    <button onClick={() => { setShowGroupManager(false); setNewGroupName(''); }}
                      className="text-red-400 hover:text-red-300 text-sm font-bold">✕</button>
                  </div>
                )}
              </div>

              {pageFilteredWatchlist.length === 0 ? (
                <div className="bg-slate-800/30 rounded-lg p-12 text-center">
                  <Eye className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                  <h3 className="text-xl font-semibold mb-2">{activeWatchlistGroup === 'All' ? 'No Symbols in Watchlist' : `No stocks in "${activeWatchlistGroup}"`}</h3>
                  <p className="text-slate-400 mb-6">{activeWatchlistGroup === 'All' ? 'Add stocks to monitor their prices in real-time' : 'Add stocks to this group from the table below or the dashboard widget'}</p>
                  {activeWatchlistGroup !== 'All' && watchlist.length > 0 && (
                    <button onClick={() => setActiveWatchlistGroup('All')} className="text-violet-400 hover:text-violet-300 text-sm">← View all stocks</button>
                  )}
                </div>
              ) : (
                <div className="bg-slate-800/30 rounded-lg overflow-hidden">
                  <table className="w-full">
                    <thead className="bg-slate-900/50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Symbol</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Price</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Change</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Change %</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Groups</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-700">
                      {pageFilteredWatchlist.map((symbol, i) => {
                        const price = watchlistPrices[symbol] || { current: 0, change: 0, changePercent: 0 };
                        const symbolGroups = pageGroupNames.filter(g => g !== 'All' && (watchlistGroups[g] || []).includes(symbol));
                        return (
                          <tr
                            key={symbol}
                            draggable
                            onDragStart={(e) => { setDraggedWatchlistItem(i); e.dataTransfer.effectAllowed = 'move'; }}
                            onDragOver={(e) => { e.preventDefault(); setDragOverWatchlistItem(i); }}
                            onDragEnd={() => { setDraggedWatchlistItem(null); setDragOverWatchlistItem(null); }}
                            onDrop={(e) => { e.preventDefault(); if (draggedWatchlistItem !== null && draggedWatchlistItem !== i) reorderWatchlist(draggedWatchlistItem, i); }}
                            className={`hover:bg-slate-800/50 transition-all cursor-move ${dragOverWatchlistItem === i ? 'border-t-2 border-t-violet-500' : ''} ${draggedWatchlistItem === i ? 'opacity-50' : ''}`}
                          >
                            <td className="px-4 py-3">
                              <div className="flex items-center gap-3">
                                <span className="text-slate-500 text-sm opacity-0 hover:opacity-100 transition-opacity">⋮⋮</span>
                                <span className="font-bold text-lg">{symbol}</span>
                              </div>
                            </td>
                            <td className="px-4 py-3 font-semibold">${(price.current || 0).toFixed(2)}</td>
                            <td className="px-4 py-3">
                              <span className={(price.change || 0) >= 0 ? 'text-green-400' : 'text-red-400'}>
                                {(price.change || 0) >= 0 ? '+' : ''}{(price.change || 0).toFixed(2)}
                              </span>
                            </td>
                            <td className="px-4 py-3">
                              <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                (price.changePercent || 0) >= 0 ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'
                              }`}>
                                {(price.changePercent || 0) >= 0 ? '+' : ''}{(price.changePercent || 0).toFixed(2)}%
                              </span>
                            </td>
                            <td className="px-4 py-3">
                              <div className="flex items-center gap-1 flex-wrap">
                                {symbolGroups.map(g => (
                                  <span key={g} className="inline-flex items-center gap-0.5 text-[10px] bg-violet-500/15 text-violet-300 px-1.5 py-0.5 rounded-full">
                                    {g}
                                    <button onClick={(e) => { e.stopPropagation(); removeFromWatchlistGroup(symbol, g); }}
                                      className="text-red-400 hover:text-red-300 ml-0.5">×</button>
                                  </span>
                                ))}
                                <select
                                  onChange={(e) => { if (e.target.value) addToWatchlistGroup(symbol, e.target.value); e.target.value = ''; }}
                                  className="text-[10px] bg-slate-700/50 border-none rounded text-slate-400 appearance-none cursor-pointer px-1 py-0.5"
                                  defaultValue=""
                                >
                                  <option value="">+ Group</option>
                                  {pageGroupNames.filter(g => g !== 'All' && !(watchlistGroups[g] || []).includes(symbol)).map(g => <option key={g} value={g}>{g}</option>)}
                                </select>
                              </div>
                            </td>
                            <td className="px-4 py-3">
                              <div className="flex items-center gap-2">
                                <button
                                  onClick={() => { setTickerSymbol(symbol); setActiveTab('ticker'); }}
                                  className="text-violet-400 hover:text-violet-300 text-sm font-semibold"
                                >
                                  Analyze
                                </button>
                                {activeWatchlistGroup !== 'All' ? (
                                  <button
                                    onClick={() => removeFromWatchlistGroup(symbol, activeWatchlistGroup)}
                                    className="text-orange-400 hover:text-orange-300 text-sm"
                                  >
                                    Ungroup
                                  </button>
                                ) : null}
                                <button
                                  onClick={() => setWatchlist(watchlist.filter(s => s !== symbol))}
                                  className="text-red-400 hover:text-red-300 text-sm"
                                >
                                  Remove
                                </button>
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
              </>);
            })()}

            {/* CORRELATION HEATMAP */}
            {watchlist.length >= 2 && (
              <div className="mt-6 bg-slate-800/30 rounded-xl border border-slate-700/20 p-5">
                <h3 className="text-lg font-bold mb-1 flex items-center gap-2">
                  <Activity className="w-5 h-5 text-violet-400" />
                  Correlation Overview
                </h3>
                <p className="text-xs text-slate-500 mb-4">Based on current price movement similarity. Green = moving together, Red = moving apart.</p>

                <div className="overflow-x-auto">
                  <table className="w-full text-xs">
                    <thead>
                      <tr>
                        <th className="p-2 text-left text-slate-500"></th>
                        {watchlist.slice(0, 10).map(sym => (
                          <th key={sym} className="p-2 text-center text-slate-400 font-semibold" style={{ minWidth: '50px' }}>{sym}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {watchlist.slice(0, 10).map((symA, rowIdx) => (
                        <tr key={symA}>
                          <td className="p-2 text-slate-400 font-semibold">{symA}</td>
                          {watchlist.slice(0, 10).map((symB, colIdx) => {
                            if (rowIdx === colIdx) {
                              return <td key={symB} className="p-1"><div className="w-full h-8 bg-violet-500/30 rounded flex items-center justify-center text-[10px] text-violet-300 font-bold">1.00</div></td>;
                            }
                            const changeA = watchlistPrices[symA]?.changePercent || 0;
                            const changeB = watchlistPrices[symB]?.changePercent || 0;
                            // Simple directional correlation: same direction = positive, opposite = negative
                            const sameDirection = (changeA >= 0 && changeB >= 0) || (changeA < 0 && changeB < 0);
                            const magnitudeSimilarity = 1 - Math.min(Math.abs(Math.abs(changeA) - Math.abs(changeB)) / Math.max(Math.abs(changeA), Math.abs(changeB), 0.01), 1);
                            const correlation = sameDirection ? magnitudeSimilarity * 0.5 + 0.5 : -(magnitudeSimilarity * 0.5 + 0.5);
                            const normalized = Math.max(-1, Math.min(1, correlation));

                            const bg = normalized > 0.5 ? `rgba(16, 185, 129, ${Math.abs(normalized) * 0.5})` :
                                       normalized > 0 ? `rgba(16, 185, 129, ${Math.abs(normalized) * 0.3})` :
                                       normalized > -0.5 ? `rgba(239, 68, 68, ${Math.abs(normalized) * 0.3})` :
                                       `rgba(239, 68, 68, ${Math.abs(normalized) * 0.5})`;

                            return (
                              <td key={symB} className="p-1">
                                <div
                                  className="w-full h-8 rounded flex items-center justify-center text-[10px] font-bold tabular-nums transition-all hover:scale-110 cursor-default"
                                  style={{ backgroundColor: bg }}
                                  title={`${symA} vs ${symB}: ${normalized.toFixed(2)}`}
                                >
                                  <span className={normalized >= 0 ? 'text-emerald-300' : 'text-red-300'}>
                                    {normalized.toFixed(2)}
                                  </span>
                                </div>
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div className="mt-3 flex items-center justify-center gap-4 text-[10px] text-slate-500">
                  <div className="flex items-center gap-1.5">
                    <div className="w-4 h-3 rounded" style={{ backgroundColor: 'rgba(239, 68, 68, 0.4)' }} />
                    <span>Negatively correlated</span>
                  </div>
                  <div className="flex items-center gap-1.5">
                    <div className="w-4 h-3 rounded bg-slate-700" />
                    <span>Uncorrelated</span>
                  </div>
                  <div className="flex items-center gap-1.5">
                    <div className="w-4 h-3 rounded" style={{ backgroundColor: 'rgba(16, 185, 129, 0.4)' }} />
                    <span>Positively correlated</span>
                  </div>
                </div>
              </div>
            )}

            {/* UPCOMING EARNINGS */}
            {watchlist.length > 0 && (
              <div className="mt-6 bg-slate-800/30 rounded-xl border border-slate-700/20 p-5">
                <h3 className="text-lg font-bold mb-1 flex items-center gap-2">
                  <CalendarDays className="w-5 h-5 text-amber-400" />
                  Earnings Watch
                </h3>
                <p className="text-xs text-slate-500 mb-4">Estimated earnings seasons for your watchlist stocks. Always verify dates before trading.</p>

                <div className="space-y-2">
                  {getEstimatedEarnings(watchlist).map((earning) => (
                    <div key={earning.symbol} className={`flex items-center justify-between px-4 py-2.5 rounded-lg transition-colors ${
                      earning.isEarningsSeason ? 'bg-amber-500/10 border border-amber-500/20' : 'bg-slate-800/30 hover:bg-slate-800/50'
                    }`}>
                      <div className="flex items-center gap-3">
                        <span className="font-bold text-sm text-white w-14">{earning.symbol}</span>
                        {earning.isEarningsSeason && (
                          <span className="px-2 py-0.5 bg-amber-500/20 text-amber-300 text-[10px] font-bold rounded-full animate-pulse">EARNINGS SOON</span>
                        )}
                      </div>
                      <div className="text-right">
                        <div className="text-xs text-slate-300">
                          Next: <span className="font-medium text-white">{earning.nextSeason}</span> — ~{earning.approximateDate}
                        </div>
                        {earning.known && (
                          <div className="text-[10px] text-slate-500">{earning.known}</div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>

                <p className="text-[10px] text-slate-600 mt-3 text-center">
                  Dates are approximate. Check your broker for confirmed earnings dates before trading around announcements.
                </p>
              </div>
            )}

            <div className="mt-6 bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4">
              <p className="text-sm text-emerald-200">
                <strong>Live updates:</strong> Watchlist prices update automatically every 5 seconds.
              </p>
            </div>
          </div>
        )}

        {/* PHASE 1: HOT STOCKS TAB */}
        {activeTab === "hotstocks" && (
          <div className="max-w-7xl mx-auto">
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 md:mb-6 gap-3 sm:gap-0">
              <div>
                <h2 className="text-2xl md:text-3xl font-bold flex items-center gap-3">
                  <Flame className="w-7 md:w-8 h-7 md:h-8 text-orange-400" />
                  Hot Stocks Scanner
                </h2>
                <div className="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3 mt-2">
                  <p className="text-xs md:text-sm text-slate-400">Find biggest movers and volume leaders</p>
                  {hotStocks.isLive !== undefined && (
                    <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                      hotStocks.isLive 
                        ? 'bg-green-500/20 text-green-400 border border-green-500/30' 
                        : 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'
                    }`}>
                      {hotStocks.isLive ? '🟢 LIVE DATA' : '🟡 ESTIMATED'}
                    </span>
                  )}
                </div>
              </div>
              
              <button
                onClick={scanRealMarket}
                disabled={hotStocks.loading}
                className="w-full sm:w-auto bg-orange-600 hover:bg-orange-500 px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold text-sm md:text-base transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
              >
                <RefreshCw className={`w-5 h-5 ${hotStocks.loading ? 'animate-spin' : ''}`} />
                <span className="hidden sm:inline">{hotStocks.loading ? '⚡ Fast Scanning...' : '⚡ Refresh Scanner'}</span>
                <span className="sm:hidden">{hotStocks.loading ? 'Scanning...' : 'Refresh'}</span>
              </button>
            </div>

            {/* Scanner Progress Indicator */}
            {hotStocks.loading && scannerProgress.total > 0 && (
              <div className="bg-slate-800/50 border border-orange-500/30 rounded-lg p-3 md:p-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 bg-orange-500 rounded-full animate-pulse" />
                    <span className="text-sm text-orange-300 font-medium">
                      {scannerProgress.phase === 'starting' ? 'Starting scan...' :
                       scannerProgress.phase === 'scanning' ? `Scanning ${scannerProgress.current} of ${scannerProgress.total} stocks...` :
                       scannerProgress.phase === 'complete' ? 'Complete!' : 'Processing...'}
                    </span>
                  </div>
                  <span className="text-sm text-orange-400 font-bold">
                    {Math.round((scannerProgress.current / scannerProgress.total) * 100)}%
                  </span>
                </div>
                <div className="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                  <div
                    className="bg-gradient-to-r from-orange-500 to-amber-500 h-full rounded-full transition-all duration-300"
                    style={{ width: `${(scannerProgress.current / scannerProgress.total) * 100}%` }}
                  />
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  ⚡ Parallel processing: analyzing 10 stocks per batch across 220+ symbols with 5-minute cache
                </p>
              </div>
            )}

            {/* Scan Complete Message */}
            {!hotStocks.loading && scannerProgress.scanTime > 0 && hotStocks.gainers.length > 0 && (
              <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg px-4 py-2 flex items-center justify-between">
                <span className="text-sm text-emerald-300">
                  ✅ Found {hotStocks.gainers.length + hotStocks.losers.length + hotStocks.volume.length} stocks
                </span>
                <span className="text-sm text-emerald-400 font-bold">
                  ⚡ {scannerProgress.scanTime}s scan time
                </span>
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
              {/* Top Gainers */}
              <div className="card-gain rounded-xl p-4 md:p-6">
                <h3 className="text-base md:text-lg font-bold mb-3 md:mb-4 flex items-center gap-2 text-green-400">
                  <ArrowUpRight className="w-5 h-5" />
                  Top Gainers
                </h3>
                {hotStocks.gainers.length === 0 ? (
                  <p className="text-slate-400 text-sm">Click Refresh to scan</p>
                ) : (
                  <div className="space-y-2 md:space-y-3">
                    {hotStocks.gainers.map((stock, idx) => (
                      <div key={idx} className="bg-slate-800/50 rounded p-3">
                        <div className="flex justify-between items-start mb-1">
                          <div className="flex-1 min-w-0">
                            <span className="font-bold text-lg">{stock.symbol}</span>
                            {getCompanyName(stock.symbol) && (
                              <p className="text-xs text-slate-400 truncate" title={getCompanyName(stock.symbol)}>
                                {getCompanyName(stock.symbol)}
                              </p>
                            )}
                          </div>
                          <span className="text-green-400 font-bold">+{typeof stock.change === 'number' ? stock.change.toFixed(2) : stock.change || '0'}%</span>
                        </div>
                        <div className="flex justify-between text-sm text-slate-400 mb-2">
                          <span>${typeof stock.price === 'number' ? stock.price.toFixed(2) : stock.price || '---'}</span>
                          <span>{stock.volume || '---'} vol</span>
                        </div>
                        {/* Technical Indicators Row */}
                        <div className="flex items-center gap-2 flex-wrap mb-2">
                          {stock.rsi && (
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              stock.rsi > 70 ? 'bg-red-500/20 text-red-300' :
                              stock.rsi < 30 ? 'bg-green-500/20 text-green-300' :
                              'bg-slate-600/50 text-slate-300'
                            }`}>
                              RSI: {stock.rsi}
                            </span>
                          )}
                          {stock.macd !== undefined && (
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              stock.macd > 0 ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'
                            }`}>
                              MACD: {stock.macd > 0 ? '+' : ''}{typeof stock.macd === 'number' ? stock.macd.toFixed(2) : stock.macd}
                            </span>
                          )}
                          {stock.trend && (
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              stock.trend === 'UP' ? 'bg-green-500/20 text-green-300' :
                              stock.trend === 'DOWN' ? 'bg-red-500/20 text-red-300' :
                              'bg-yellow-500/20 text-yellow-300'
                            }`}>
                              {stock.trend === 'UP' ? '📈' : stock.trend === 'DOWN' ? '📉' : '➡️'} {stock.trend}
                            </span>
                          )}
                          {stock.recommendation && stock.recommendation !== 'HOLD' && (
                            <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                              stock.recommendation.includes('BUY') ? 'bg-emerald-500/30 text-emerald-300' :
                              stock.recommendation.includes('SELL') ? 'bg-red-500/30 text-red-300' :
                              'bg-slate-600/50 text-slate-300'
                            }`}>
                              {stock.recommendation.replace('LEAN_', '')}
                            </span>
                          )}
                        </div>
                        {/* SMA Status Row */}
                        {(stock.aboveSMA20 !== undefined || stock.aboveSMA50 !== undefined) && (
                          <div className="flex items-center gap-2 text-xs text-slate-400 mb-2">
                            {stock.aboveSMA20 !== undefined && (
                              <span className={stock.aboveSMA20 ? 'text-green-400' : 'text-red-400'}>
                                {stock.aboveSMA20 ? '✓' : '✗'} SMA20
                              </span>
                            )}
                            {stock.aboveSMA50 !== undefined && (
                              <span className={stock.aboveSMA50 ? 'text-green-400' : 'text-red-400'}>
                                {stock.aboveSMA50 ? '✓' : '✗'} SMA50
                              </span>
                            )}
                          </div>
                        )}
                        <button
                          onClick={() => {
                            setTickerSymbol(stock.symbol);
                            setActiveTab('ticker');
                          }}
                          className="text-xs text-violet-400 hover:text-violet-300 font-semibold"
                        >
                          Analyze →
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Top Losers */}
              <div className="card-loss rounded-xl p-4 md:p-6">
                <h3 className="text-base md:text-lg font-bold mb-3 md:mb-4 flex items-center gap-2 text-red-400">
                  <ArrowDownRight className="w-5 h-5" />
                  Top Losers
                </h3>
                {hotStocks.losers.length === 0 ? (
                  <p className="text-slate-400 text-sm">Click Refresh to scan</p>
                ) : (
                  <div className="space-y-2 md:space-y-3">
                    {hotStocks.losers.map((stock, idx) => (
                      <div key={idx} className="bg-slate-800/50 rounded p-3">
                        <div className="flex justify-between items-start mb-1">
                          <div className="flex-1 min-w-0">
                            <span className="font-bold text-lg">{stock.symbol}</span>
                            {getCompanyName(stock.symbol) && (
                              <p className="text-xs text-slate-400 truncate" title={getCompanyName(stock.symbol)}>
                                {getCompanyName(stock.symbol)}
                              </p>
                            )}
                          </div>
                          <span className="text-red-400 font-bold ml-2">{typeof stock.change === 'number' ? stock.change.toFixed(2) : stock.change || '0'}%</span>
                        </div>
                        <div className="flex justify-between text-sm text-slate-400 mb-2">
                          <span>${typeof stock.price === 'number' ? stock.price.toFixed(2) : stock.price || '---'}</span>
                          <span>{stock.volume || '---'} vol</span>
                        </div>
                        {/* Technical Indicators Row */}
                        <div className="flex items-center gap-2 flex-wrap mb-2">
                          {stock.rsi && (
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              stock.rsi > 70 ? 'bg-red-500/20 text-red-300' :
                              stock.rsi < 30 ? 'bg-green-500/20 text-green-300' :
                              'bg-slate-600/50 text-slate-300'
                            }`}>
                              RSI: {stock.rsi}
                            </span>
                          )}
                          {stock.macd !== undefined && (
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              stock.macd > 0 ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'
                            }`}>
                              MACD: {stock.macd > 0 ? '+' : ''}{typeof stock.macd === 'number' ? stock.macd.toFixed(2) : stock.macd}
                            </span>
                          )}
                          {stock.trend && (
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              stock.trend === 'UP' ? 'bg-green-500/20 text-green-300' :
                              stock.trend === 'DOWN' ? 'bg-red-500/20 text-red-300' :
                              'bg-yellow-500/20 text-yellow-300'
                            }`}>
                              {stock.trend === 'UP' ? '📈' : stock.trend === 'DOWN' ? '📉' : '➡️'} {stock.trend}
                            </span>
                          )}
                          {stock.recommendation && stock.recommendation !== 'HOLD' && (
                            <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                              stock.recommendation.includes('BUY') ? 'bg-emerald-500/30 text-emerald-300' :
                              stock.recommendation.includes('SELL') ? 'bg-red-500/30 text-red-300' :
                              'bg-slate-600/50 text-slate-300'
                            }`}>
                              {stock.recommendation.replace('LEAN_', '')}
                            </span>
                          )}
                        </div>
                        {/* SMA Status Row */}
                        {(stock.aboveSMA20 !== undefined || stock.aboveSMA50 !== undefined) && (
                          <div className="flex items-center gap-2 text-xs text-slate-400 mb-2">
                            {stock.aboveSMA20 !== undefined && (
                              <span className={stock.aboveSMA20 ? 'text-green-400' : 'text-red-400'}>
                                {stock.aboveSMA20 ? '✓' : '✗'} SMA20
                              </span>
                            )}
                            {stock.aboveSMA50 !== undefined && (
                              <span className={stock.aboveSMA50 ? 'text-green-400' : 'text-red-400'}>
                                {stock.aboveSMA50 ? '✓' : '✗'} SMA50
                              </span>
                            )}
                          </div>
                        )}
                        <button
                          onClick={() => {
                            setTickerSymbol(stock.symbol);
                            setActiveTab('ticker');
                          }}
                          className="text-xs text-violet-400 hover:text-violet-300 font-semibold"
                        >
                          Analyze →
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Volume Leaders */}
              <div className="bg-gradient-to-br from-blue-900/20 to-blue-800/10 border border-blue-500/30 rounded-lg p-6">
                <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-blue-400">
                  <Activity className="w-5 h-5" />
                  Volume Leaders
                </h3>
                {hotStocks.volume.length === 0 ? (
                  <p className="text-slate-400 text-sm">Click Refresh to scan</p>
                ) : (
                  <div className="space-y-2 md:space-y-3">
                    {hotStocks.volume.map((stock, idx) => (
                      <div key={idx} className="bg-slate-800/50 rounded p-3">
                        <div className="flex justify-between items-start mb-1">
                          <div className="flex-1 min-w-0">
                            <span className="font-bold text-lg">{stock.symbol}</span>
                            {getCompanyName(stock.symbol) && (
                              <p className="text-xs text-slate-400 truncate" title={getCompanyName(stock.symbol)}>
                                {getCompanyName(stock.symbol)}
                              </p>
                            )}
                          </div>
                          <span className={`font-bold ml-2 ${(stock.change || 0) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                            {(stock.change || 0) >= 0 ? '+' : ''}{typeof stock.change === 'number' ? stock.change.toFixed(2) : stock.change || '0'}%
                          </span>
                        </div>
                        <div className="flex justify-between text-sm text-slate-400 mb-2">
                          <span>${typeof stock.price === 'number' ? stock.price.toFixed(2) : stock.price || '---'}</span>
                          <span className="text-blue-400 font-semibold">{stock.volume || '---'}</span>
                        </div>
                        {/* Technical Indicators Row */}
                        <div className="flex items-center gap-2 flex-wrap mb-2">
                          {stock.rsi && (
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              stock.rsi > 70 ? 'bg-red-500/20 text-red-300' :
                              stock.rsi < 30 ? 'bg-green-500/20 text-green-300' :
                              'bg-slate-600/50 text-slate-300'
                            }`}>
                              RSI: {stock.rsi}
                            </span>
                          )}
                          {stock.volumeRatio && stock.volumeRatio > 1.3 && (
                            <span className="px-2 py-0.5 rounded text-xs font-medium bg-blue-500/20 text-blue-300">
                              🔥 {stock.volumeRatio.toFixed(1)}x Vol
                            </span>
                          )}
                          {stock.recommendation && stock.recommendation !== 'HOLD' && (
                            <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                              stock.recommendation.includes('BUY') ? 'bg-emerald-500/30 text-emerald-300' :
                              stock.recommendation.includes('SELL') ? 'bg-red-500/30 text-red-300' :
                              'bg-slate-600/50 text-slate-300'
                            }`}>
                              {stock.recommendation.replace('LEAN_', '')}
                            </span>
                          )}
                        </div>
                        <button
                          onClick={() => {
                            setTickerSymbol(stock.symbol);
                            setActiveTab('ticker');
                          }}
                          className="text-xs text-violet-400 hover:text-violet-300 font-semibold"
                        >
                          Analyze →
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {/* Indicator Legend */}
            <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                <div className="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
                  <HelpCircle className="w-4 h-4 text-violet-400" />
                  Indicator Guide
                </div>
                <div className="grid grid-cols-2 gap-3 text-xs">
                  <div>
                    <span className="text-violet-400 font-semibold">RSI (Relative Strength):</span>
                    <div className="text-slate-400 mt-1">
                      <span className="text-red-400">• &gt;70</span> = Overbought (may drop)<br/>
                      <span className="text-green-400">• &lt;30</span> = Oversold (may rise)<br/>
                      • 30-70 = Neutral zone
                    </div>
                  </div>
                  <div>
                    <span className="text-blue-400 font-semibold">MACD:</span>
                    <div className="text-slate-400 mt-1">
                      <span className="text-green-400">• Positive</span> = Bullish momentum<br/>
                      <span className="text-red-400">• Negative</span> = Bearish momentum
                    </div>
                  </div>
                  <div>
                    <span className="text-amber-400 font-semibold">SMA (Moving Averages):</span>
                    <div className="text-slate-400 mt-1">
                      <span className="text-green-400">✓</span> Above = Bullish trend<br/>
                      <span className="text-red-400">✗</span> Below = Bearish trend
                    </div>
                  </div>
                  <div>
                    <span className="text-cyan-400 font-semibold">Volume Ratio:</span>
                    <div className="text-slate-400 mt-1">
                      <span className="text-blue-400">🔥 &gt;1.5x</span> = High interest<br/>
                      Above average trading activity
                    </div>
                  </div>
                </div>
              </div>
              <div className="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4">
                <p className="text-sm text-orange-200">
                  <strong>⚡ Fast Scanner:</strong> Uses parallel processing to scan <strong>220+ stocks across 15 sectors</strong> (Tech, Financials, Healthcare, Energy, Consumer, etc.). Shows RSI, MACD, trend direction, and buy/sell recommendations for each stock. Data cached for 5 minutes to reduce API load. Click "Refresh Scanner" to get latest market movers.
                </p>
              </div>
            </div>
          </div>
        )}

        {/* TRADE PLANNER TAB */}
        {activeTab === "trademetrics" && (
          <div className="max-w-7xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-3xl font-bold flex items-center gap-3">
                  <Target className="w-8 h-8 text-violet-400" />
                  Trade Planner
                </h2>
                <p className="text-slate-400 mt-2">Plan your trades before execution • "Plan the trade, trade the plan"</p>
              </div>
              <button
                onClick={() => {
                  setNewPlan({
                    symbol: tickerSymbol || "",
                    side: "long",
                    entryPrice: "",
                    stopLoss: "",
                    target1: "",
                    target2: "",
                    quantity: "",
                    accountSize: "10000",
                    riskPercent: "1",
                    thesis: "",
                    setup: "",
                    timeframe: "day",
                    status: "planned",
                    createdAt: null
                  });
                  setShowAddPlan(true);
                }}
                className="bg-violet-600 hover:bg-violet-500 px-6 py-3 rounded-lg font-semibold transition-colors flex items-center gap-2"
              >
                <Plus className="w-5 h-5" />
                New Trade Plan
              </button>
            </div>

            {/* Quick Position Sizer Calculator */}
            <div className="bg-gradient-to-br from-violet-900/20 to-purple-900/10 border border-violet-500/30 rounded-xl p-6 mb-6">
              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <Shield className="w-5 h-5 text-violet-400" />
                Quick Position Size Calculator
              </h3>
              <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
                <div>
                  <label className="text-xs text-slate-400 block mb-1">Account Size</label>
                  <input
                    type="number"
                    value={newPlan.accountSize}
                    onChange={(e) => setNewPlan({...newPlan, accountSize: e.target.value})}
                    className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-3 py-2 text-sm"
                    placeholder="10000"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-400 block mb-1">Risk %</label>
                  <input
                    type="number"
                    value={newPlan.riskPercent}
                    onChange={(e) => setNewPlan({...newPlan, riskPercent: e.target.value})}
                    className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-3 py-2 text-sm"
                    placeholder="1"
                    step="0.5"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-400 block mb-1">Entry Price</label>
                  <input
                    type="number"
                    value={newPlan.entryPrice}
                    onChange={(e) => setNewPlan({...newPlan, entryPrice: e.target.value})}
                    className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-3 py-2 text-sm"
                    placeholder="150.00"
                    step="0.01"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-400 block mb-1">Stop Loss</label>
                  <input
                    type="number"
                    value={newPlan.stopLoss}
                    onChange={(e) => setNewPlan({...newPlan, stopLoss: e.target.value})}
                    className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-3 py-2 text-sm"
                    placeholder="145.00"
                    step="0.01"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-400 block mb-1">Target Price</label>
                  <input
                    type="number"
                    value={newPlan.target1}
                    onChange={(e) => setNewPlan({...newPlan, target1: e.target.value})}
                    className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-3 py-2 text-sm"
                    placeholder="160.00"
                    step="0.01"
                  />
                </div>
                <div className="flex items-end">
                  <button
                    onClick={() => {
                      const entry = parseFloat(newPlan.entryPrice);
                      const stop = parseFloat(newPlan.stopLoss);
                      const account = parseFloat(newPlan.accountSize);
                      const riskPct = parseFloat(newPlan.riskPercent);
                      if (entry && stop && account && riskPct) {
                        const riskAmount = account * (riskPct / 100);
                        const riskPerShare = Math.abs(entry - stop);
                        const shares = Math.floor(riskAmount / riskPerShare);
                        setNewPlan({...newPlan, quantity: shares.toString()});
                      }
                    }}
                    className="w-full bg-violet-600 hover:bg-violet-500 px-4 py-2 rounded-lg text-sm font-semibold"
                  >
                    Calculate
                  </button>
                </div>
              </div>

              {/* Results Display */}
              {newPlan.entryPrice && newPlan.stopLoss && newPlan.accountSize && newPlan.riskPercent && (
                <div className="mt-4 pt-4 border-t border-slate-700/50">
                  {(() => {
                    const entry = parseFloat(newPlan.entryPrice) || 0;
                    const stop = parseFloat(newPlan.stopLoss) || 0;
                    const target = parseFloat(newPlan.target1) || 0;
                    const account = parseFloat(newPlan.accountSize) || 10000;
                    const riskPct = parseFloat(newPlan.riskPercent) || 1;
                    const quantity = parseFloat(newPlan.quantity) || 0;

                    const riskAmount = account * (riskPct / 100);
                    const riskPerShare = Math.abs(entry - stop);
                    const calculatedShares = riskPerShare > 0 ? Math.floor(riskAmount / riskPerShare) : 0;
                    const positionValue = entry * (quantity || calculatedShares);
                    const maxLoss = riskPerShare * (quantity || calculatedShares);
                    const potentialProfit = target > 0 ? Math.abs(target - entry) * (quantity || calculatedShares) : 0;
                    const riskReward = riskPerShare > 0 && target > 0 ? (Math.abs(target - entry) / riskPerShare).toFixed(2) : 0;
                    const isLong = entry > stop;
                    const stopPercent = entry > 0 ? ((Math.abs(entry - stop) / entry) * 100).toFixed(2) : 0;
                    const targetPercent = entry > 0 && target > 0 ? ((Math.abs(target - entry) / entry) * 100).toFixed(2) : 0;

                    return (
                      <div className="grid grid-cols-2 md:grid-cols-6 gap-4 text-center">
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Position Size</div>
                          <div className="text-xl font-bold text-violet-400">{quantity || calculatedShares} shares</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Position Value</div>
                          <div className="text-xl font-bold text-blue-400">${positionValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Max Risk</div>
                          <div className="text-xl font-bold text-red-400">-${maxLoss.toFixed(2)}</div>
                          <div className="text-xs text-slate-500">({stopPercent}%)</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Potential Profit</div>
                          <div className="text-xl font-bold text-emerald-400">+${potentialProfit.toFixed(2)}</div>
                          <div className="text-xs text-slate-500">({targetPercent}%)</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3">
                          <div className="text-xs text-slate-500 mb-1">Risk:Reward</div>
                          <div className={`text-xl font-bold ${parseFloat(riskReward) >= 2 ? 'text-emerald-400' : parseFloat(riskReward) >= 1.5 ? 'text-yellow-400' : 'text-red-400'}`}>
                            1:{riskReward}
                          </div>
                        </div>
                        <div
                          className="bg-slate-800/50 rounded-lg p-3 relative"
                          onMouseEnter={() => setActiveTooltip('plandir')}
                          onMouseLeave={() => setActiveTooltip(null)}
                        >
                          <div className="text-xs text-slate-500 mb-1">Direction</div>
                          <div
                            className={`text-xl font-bold cursor-help ${isLong ? 'text-emerald-400' : 'text-red-400'}`}
                          >
                            {isLong ? '📈 LONG' : '📉 SHORT'} <span className="text-xs opacity-60">ⓘ</span>
                          </div>
                          {/* State-based Tooltip */}
                          {activeTooltip === 'plandir' && (
                            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-56 bg-slate-900 border border-slate-500 rounded-lg p-3 text-xs text-slate-200 shadow-2xl pointer-events-none" style={{ zIndex: 9999 }}>
                              <div className={`font-semibold mb-1 ${isLong ? 'text-emerald-400' : 'text-red-400'}`}>
                                {isLong ? '📈 LONG Position' : '📉 SHORT Position'}
                              </div>
                              <p>{isLong
                                ? "Buy position. You profit when the price goes UP."
                                : "Sell position. You profit when the price goes DOWN."}</p>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })()}
                </div>
              )}
            </div>

            {/* Saved Trade Plans */}
            <div className="bg-slate-900/50 rounded-xl border border-slate-800/50 p-6">
              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <List className="w-5 h-5 text-slate-400" />
                Saved Trade Plans
                <span className="text-xs text-slate-500 ml-2">({tradePlans.length} plans)</span>
              </h3>

              {tradePlans.length === 0 ? (
                <div className="text-center py-12">
                  <Target className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                  <h3 className="text-xl font-semibold mb-2">No Trade Plans Yet</h3>
                  <p className="text-slate-400 mb-6 max-w-md mx-auto">
                    Create trade plans before entering positions. Use the calculator above or click "New Trade Plan" to get started.
                  </p>
                  <div className="bg-slate-800/50 rounded-lg p-4 max-w-lg mx-auto text-left">
                    <div className="text-sm font-semibold text-violet-400 mb-2">💡 Why Plan Trades?</div>
                    <ul className="text-sm text-slate-400 space-y-1">
                      <li>• Define entry, stop loss, and targets BEFORE emotions kick in</li>
                      <li>• Calculate proper position size based on your risk tolerance</li>
                      <li>• Document your thesis to review later</li>
                      <li>• Track which setups work best for you</li>
                    </ul>
                  </div>
                </div>
              ) : (
                <div className="space-y-2 md:space-y-3">
                  {tradePlans.map((plan, idx) => {
                    const entry = parseFloat(plan.entryPrice) || 0;
                    const stop = parseFloat(plan.stopLoss) || 0;
                    const target = parseFloat(plan.target1) || 0;
                    const quantity = parseFloat(plan.quantity) || 0;
                    const riskPerShare = Math.abs(entry - stop);
                    const maxLoss = riskPerShare * quantity;
                    const potentialProfit = target > 0 ? Math.abs(target - entry) * quantity : 0;
                    const riskReward = riskPerShare > 0 && target > 0 ? (Math.abs(target - entry) / riskPerShare).toFixed(2) : 0;
                    const isLong = plan.side === 'long';

                    return (
                      <div key={idx} className={`bg-slate-800/30 rounded-lg p-4 border ${
                        plan.status === 'active' ? 'border-blue-500/50' :
                        plan.status === 'completed' ? 'border-emerald-500/50' :
                        plan.status === 'cancelled' ? 'border-red-500/30' :
                        'border-slate-700/50'
                      }`}>
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex items-center gap-3">
                            <span className="font-bold text-xl">{plan.symbol}</span>
                            <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                              isLong ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'
                            }`}>
                              {isLong ? '📈 LONG' : '📉 SHORT'}
                            </span>
                            <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                              plan.status === 'active' ? 'bg-blue-500/20 text-blue-300' :
                              plan.status === 'completed' ? 'bg-emerald-500/20 text-emerald-300' :
                              plan.status === 'cancelled' ? 'bg-red-500/20 text-red-300' :
                              'bg-slate-600/50 text-slate-300'
                            }`}>
                              {plan.status.toUpperCase()}
                            </span>
                            {getCompanyName(plan.symbol) && (
                              <span className="text-xs text-slate-500">{getCompanyName(plan.symbol)}</span>
                            )}
                          </div>
                          <div className="flex items-center gap-2">
                            <button
                              onClick={() => {
                                // Execute to journal
                                const newTrade = {
                                  id: Date.now(),
                                  symbol: plan.symbol,
                                  side: plan.side,
                                  entry: plan.entryPrice,
                                  exit: "",
                                  stopLoss: plan.stopLoss,
                                  target: plan.target1,
                                  quantity: plan.quantity,
                                  entryDate: new Date().toISOString().split('T')[0],
                                  exitDate: "",
                                  notes: `From Trade Plan: ${plan.thesis}`,
                                  status: "open",
                                  pnl: 0,
                                  pnlPercent: 0
                                };
                                setTrades([...trades, newTrade]);
                                // Update plan status
                                const updatedPlans = tradePlans.map((p, i) =>
                                  i === idx ? {...p, status: 'active'} : p
                                );
                                setTradePlans(updatedPlans);
                              }}
                              className="px-3 py-1 bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-400 rounded text-xs font-semibold"
                              disabled={plan.status !== 'planned'}
                            >
                              Execute
                            </button>
                            <button
                              onClick={() => {
                                const updatedPlans = tradePlans.filter((_, i) => i !== idx);
                                setTradePlans(updatedPlans);
                              }}
                              className="px-3 py-1 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded text-xs font-semibold"
                            >
                              Delete
                            </button>
                          </div>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-6 gap-3 text-sm mb-3">
                          <div>
                            <span className="text-slate-500">Entry:</span>
                            <span className="ml-2 font-semibold text-violet-400">${entry.toFixed(2)}</span>
                          </div>
                          <div>
                            <span className="text-slate-500">Stop:</span>
                            <span className="ml-2 font-semibold text-red-400">${stop.toFixed(2)}</span>
                          </div>
                          <div>
                            <span className="text-slate-500">Target:</span>
                            <span className="ml-2 font-semibold text-emerald-400">${target.toFixed(2)}</span>
                          </div>
                          <div>
                            <span className="text-slate-500">Size:</span>
                            <span className="ml-2 font-semibold">{quantity} shares</span>
                          </div>
                          <div>
                            <span className="text-slate-500">Risk:</span>
                            <span className="ml-2 font-semibold text-red-400">-${maxLoss.toFixed(2)}</span>
                          </div>
                          <div>
                            <span className="text-slate-500">R:R:</span>
                            <span className={`ml-2 font-semibold ${parseFloat(riskReward) >= 2 ? 'text-emerald-400' : 'text-yellow-400'}`}>
                              1:{riskReward}
                            </span>
                          </div>
                        </div>

                        {plan.thesis && (
                          <div className="bg-slate-900/50 rounded p-3 text-sm">
                            <span className="text-slate-500">Thesis: </span>
                            <span className="text-slate-300">{plan.thesis}</span>
                          </div>
                        )}

                        <div className="text-xs text-slate-600 mt-2">
                          Created: {plan.createdAt ? new Date(plan.createdAt).toLocaleString() : 'Unknown'}
                          {plan.setup && <span className="ml-3">Setup: {plan.setup}</span>}
                          {plan.timeframe && <span className="ml-3">Timeframe: {plan.timeframe}</span>}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Add/Edit Plan Modal */}
            {showAddPlan && (
              <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-900 rounded-2xl border border-slate-700 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                  <div className="p-6 border-b border-slate-800">
                    <h3 className="text-xl font-bold flex items-center gap-2">
                      <Target className="w-6 h-6 text-violet-400" />
                      Create Trade Plan
                    </h3>
                  </div>
                  <div className="p-6 space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="text-sm text-slate-400 block mb-1">Symbol *</label>
                        <input
                          type="text"
                          value={newPlan.symbol}
                          onChange={(e) => setNewPlan({...newPlan, symbol: e.target.value.toUpperCase()})}
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2"
                          placeholder="AAPL"
                        />
                      </div>
                      <div>
                        <label className="text-sm text-slate-400 block mb-1">Direction *</label>
                        <select
                          value={newPlan.side}
                          onChange={(e) => setNewPlan({...newPlan, side: e.target.value})}
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2"
                        >
                          <option value="long">📈 Long (Buy)</option>
                          <option value="short">📉 Short (Sell)</option>
                        </select>
                      </div>
                    </div>

                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <label className="text-sm text-slate-400 block mb-1">Entry Price *</label>
                        <input
                          type="number"
                          value={newPlan.entryPrice}
                          onChange={(e) => setNewPlan({...newPlan, entryPrice: e.target.value})}
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2"
                          placeholder="150.00"
                          step="0.01"
                        />
                      </div>
                      <div>
                        <label className="text-sm text-slate-400 block mb-1">Stop Loss *</label>
                        <input
                          type="number"
                          value={newPlan.stopLoss}
                          onChange={(e) => setNewPlan({...newPlan, stopLoss: e.target.value})}
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2"
                          placeholder="145.00"
                          step="0.01"
                        />
                      </div>
                      <div>
                        <label className="text-sm text-slate-400 block mb-1">Target 1 *</label>
                        <input
                          type="number"
                          value={newPlan.target1}
                          onChange={(e) => setNewPlan({...newPlan, target1: e.target.value})}
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2"
                          placeholder="160.00"
                          step="0.01"
                        />
                      </div>
                    </div>

                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <label className="text-sm text-slate-400 block mb-1">Target 2 (Optional)</label>
                        <input
                          type="number"
                          value={newPlan.target2}
                          onChange={(e) => setNewPlan({...newPlan, target2: e.target.value})}
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2"
                          placeholder="170.00"
                          step="0.01"
                        />
                      </div>
                      <div>
                        <label className="text-sm text-slate-400 block mb-1">Quantity *</label>
                        <input
                          type="number"
                          value={newPlan.quantity}
                          onChange={(e) => setNewPlan({...newPlan, quantity: e.target.value})}
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2"
                          placeholder="100"
                        />
                      </div>
                      <div>
                        <label className="text-sm text-slate-400 block mb-1">Timeframe</label>
                        <select
                          value={newPlan.timeframe}
                          onChange={(e) => setNewPlan({...newPlan, timeframe: e.target.value})}
                          className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2"
                        >
                          <option value="scalp">⚡ Scalp (Minutes)</option>
                          <option value="day">📊 Day Trade</option>
                          <option value="swing">📈 Swing (Days-Weeks)</option>
                          <option value="position">🏔️ Position (Weeks-Months)</option>
                        </select>
                      </div>
                    </div>

                    <div>
                      <label className="text-sm text-slate-400 block mb-1">Setup Type</label>
                      <input
                        type="text"
                        value={newPlan.setup}
                        onChange={(e) => setNewPlan({...newPlan, setup: e.target.value})}
                        className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-2"
                        placeholder="e.g., Breakout, Support bounce, Trend continuation..."
                      />
                    </div>

                    <div>
                      <label className="text-sm text-slate-400 block mb-1">Trade Thesis</label>
                      <textarea
                        value={newPlan.thesis}
                        onChange={(e) => setNewPlan({...newPlan, thesis: e.target.value})}
                        className="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 min-h-[100px]"
                        placeholder="Why are you taking this trade? What's your conviction? What could invalidate this setup?"
                      />
                    </div>

                    {/* Preview */}
                    {newPlan.entryPrice && newPlan.stopLoss && newPlan.quantity && (
                      <div className="bg-violet-500/10 border border-violet-500/30 rounded-lg p-4">
                        <div className="text-sm font-semibold text-violet-300 mb-2">Trade Preview</div>
                        {(() => {
                          const entry = parseFloat(newPlan.entryPrice) || 0;
                          const stop = parseFloat(newPlan.stopLoss) || 0;
                          const target = parseFloat(newPlan.target1) || 0;
                          const quantity = parseFloat(newPlan.quantity) || 0;
                          const riskPerShare = Math.abs(entry - stop);
                          const maxLoss = riskPerShare * quantity;
                          const potentialProfit = target > 0 ? Math.abs(target - entry) * quantity : 0;
                          const riskReward = riskPerShare > 0 && target > 0 ? (Math.abs(target - entry) / riskPerShare).toFixed(2) : '---';

                          return (
                            <div className="grid grid-cols-4 gap-4 text-sm">
                              <div>
                                <span className="text-slate-500">Position:</span>
                                <span className="ml-2 font-semibold">${(entry * quantity).toFixed(2)}</span>
                              </div>
                              <div>
                                <span className="text-slate-500">Max Loss:</span>
                                <span className="ml-2 font-semibold text-red-400">-${maxLoss.toFixed(2)}</span>
                              </div>
                              <div>
                                <span className="text-slate-500">Potential:</span>
                                <span className="ml-2 font-semibold text-emerald-400">+${potentialProfit.toFixed(2)}</span>
                              </div>
                              <div>
                                <span className="text-slate-500">R:R:</span>
                                <span className={`ml-2 font-semibold ${parseFloat(riskReward) >= 2 ? 'text-emerald-400' : 'text-yellow-400'}`}>
                                  1:{riskReward}
                                </span>
                              </div>
                            </div>
                          );
                        })()}
                      </div>
                    )}
                  </div>
                  <div className="p-6 border-t border-slate-800 flex justify-end gap-3">
                    <button
                      onClick={() => setShowAddPlan(false)}
                      className="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={() => {
                        if (newPlan.symbol && newPlan.entryPrice && newPlan.stopLoss && newPlan.quantity) {
                          const planToSave = {
                            ...newPlan,
                            createdAt: new Date().toISOString()
                          };
                          setTradePlans([...tradePlans, planToSave]);
                          setShowAddPlan(false);
                          setNewPlan({
                            symbol: "",
                            side: "long",
                            entryPrice: "",
                            stopLoss: "",
                            target1: "",
                            target2: "",
                            quantity: "",
                            accountSize: "10000",
                            riskPercent: "1",
                            thesis: "",
                            setup: "",
                            timeframe: "day",
                            status: "planned",
                            createdAt: null
                          });
                        }
                      }}
                      disabled={!newPlan.symbol || !newPlan.entryPrice || !newPlan.stopLoss || !newPlan.quantity}
                      className="px-6 py-2 bg-violet-600 hover:bg-violet-500 disabled:bg-slate-700 disabled:cursor-not-allowed rounded-lg font-semibold"
                    >
                      Save Trade Plan
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Tips Section */}
            <div className="mt-6 bg-slate-800/30 border border-slate-700/50 rounded-lg p-4">
              <div className="text-sm font-semibold text-slate-300 mb-2 flex items-center gap-2">
                <HelpCircle className="w-4 h-4 text-violet-400" />
                Trade Planning Tips
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs text-slate-400">
                <div>
                  <span className="text-emerald-400 font-semibold">Risk Management:</span>
                  <p>Never risk more than 1-2% of your account on a single trade. Use the position calculator to size properly.</p>
                </div>
                <div>
                  <span className="text-blue-400 font-semibold">Risk:Reward Ratio:</span>
                  <p>Aim for at least 1:2 R:R. This means even with 50% win rate, you'll be profitable long-term.</p>
                </div>
                <div>
                  <span className="text-amber-400 font-semibold">Document Everything:</span>
                  <p>Write your thesis before entering. Review your plans regularly to identify what setups work best for you.</p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* PHASE 2: ALERT PERFORMANCE TAB */}
        {activeTab === "alertperformance" && (
          <div className="max-w-7xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-3xl font-bold flex items-center gap-3">
                  <ArrowUpDown className="w-8 h-8 text-violet-400" />
                  Alert Performance Tracking
                </h2>
                <p className="text-slate-400 mt-2">Track how profitable your alerts have been</p>
              </div>
            </div>

            {alertPerformance.length === 0 ? (
              <div className="bg-slate-800/30 rounded-lg p-12 text-center">
                <Bell className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">No Alert History Yet</h3>
                <p className="text-slate-400 mb-6">
                  Create alerts and wait for them to trigger. We'll track price movement after each trigger to calculate profitability.
                </p>
                <button
                  onClick={() => setActiveTab('alerts')}
                  className="bg-violet-600 hover:bg-violet-500 px-6 py-3 rounded-lg font-semibold transition-colors"
                >
                  Create Alerts
                </button>
              </div>
            ) : (
              <div className="space-y-4 md:space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div className="bg-gradient-to-br from-violet-900/30 to-violet-800/10 border border-violet-500/30 rounded-lg p-6">
                    <div className="text-xs text-slate-400 mb-2">Total Triggered</div>
                    <div className="text-3xl font-bold">{alertPerformance.length}</div>
                  </div>
                  
                  <div className="bg-gradient-to-br from-green-900/30 to-green-800/10 border border-green-500/30 rounded-lg p-6">
                    <div className="text-xs text-slate-400 mb-2">Profitable</div>
                    <div className="text-3xl font-bold text-green-400">
                      {((alertPerformance.filter(a => a.profitable).length / alertPerformance.length) * 100).toFixed(1)}%
                    </div>
                  </div>
                  
                  <div className="bg-gradient-to-br from-blue-900/30 to-blue-800/10 border border-blue-500/30 rounded-lg p-6">
                    <div className="text-xs text-slate-400 mb-2">Avg Return</div>
                    <div className="text-3xl font-bold text-blue-400">
                      {(alertPerformance.reduce((sum, a) => sum + a.return24h, 0) / alertPerformance.length).toFixed(2)}%
                    </div>
                  </div>
                  
                  <div className="bg-gradient-to-br from-orange-900/30 to-orange-800/10 border border-orange-500/30 rounded-lg p-6">
                    <div className="text-xs text-slate-400 mb-2">Best Return</div>
                    <div className="text-3xl font-bold text-orange-400">
                      +{Math.max(...alertPerformance.map(a => a.return24h)).toFixed(2)}%
                    </div>
                  </div>
                </div>

                <div className="bg-slate-800/30 rounded-lg overflow-hidden">
                  <table className="w-full">
                    <thead className="bg-slate-900/50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Symbol</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Condition</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Trigger Price</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">1hr Return</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">24hr Return</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400">Status</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-700">
                      {alertPerformance.map((perf, idx) => (
                        <tr key={idx} className="hover:bg-slate-800/50">
                          <td className="px-4 py-3 font-bold">{perf.symbol}</td>
                          <td className="px-4 py-3 text-sm">{perf.condition}</td>
                          <td className="px-4 py-3">${(perf.triggerPrice || 0).toFixed(2)}</td>
                          <td className="px-4 py-3">
                            <span className={perf.return1h >= 0 ? 'text-green-400' : 'text-red-400'}>
                              {perf.return1h >= 0 ? '+' : ''}{(perf.return1h || 0).toFixed(2)}%
                            </span>
                          </td>
                          <td className="px-4 py-3">
                            <span className={perf.return24h >= 0 ? 'text-green-400' : 'text-red-400'}>
                              {perf.return24h >= 0 ? '+' : ''}{(perf.return24h || 0).toFixed(2)}%
                            </span>
                          </td>
                          <td className="px-4 py-3">
                            <span className={`px-2 py-1 rounded text-xs ${
                              perf.profitable ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'
                            }`}>
                              {perf.profitable ? 'Profitable' : 'Loss'}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        )}

        {/* NEWS & SENTIMENT FEED TAB */}
        {activeTab === "news" && (
          <div className="max-w-7xl mx-auto space-y-4 md:space-y-6">
            {/* Header */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 md:gap-4">
              <div className="flex-1">
                <h2 className="text-2xl md:text-3xl font-bold flex items-center gap-2 md:gap-3">
                  <MessageCircle className="w-7 md:w-8 h-7 md:h-8 text-violet-400" />
                  News & Sentiment Feed
                  <span className="text-xs md:text-sm px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center gap-1.5 font-normal whitespace-nowrap">
                    <span className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                    LIVE
                  </span>
                </h2>
                <p className="text-xs md:text-sm text-slate-400 mt-1">Real-time news from Yahoo Finance & Google News APIs</p>
              </div>
              <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3 w-full sm:w-auto">
                <select
                  value={newsFilter}
                  onChange={(e) => setNewsFilter(e.target.value)}
                  className="bg-slate-800 border border-slate-700 rounded-lg px-3 md:px-4 py-2 text-xs md:text-sm"
                >
                  <option value="all">All News</option>
                  <option value="bullish">Bullish Only</option>
                  <option value="bearish">Bearish Only</option>
                  <option value="high">High Impact</option>
                </select>
                <button
                  onClick={generateNewsFeed}
                  disabled={loadingNews}
                  className="bg-violet-600 hover:bg-violet-500 px-4 md:px-6 py-2 md:py-2.5 rounded-lg font-semibold text-xs md:text-sm transition-colors flex items-center justify-center gap-2 disabled:opacity-50 whitespace-nowrap"
                >
                  <RefreshCw className={`w-4 h-4 ${loadingNews ? 'animate-spin' : ''}`} />
                  <span className="hidden sm:inline">{loadingNews ? 'Loading...' : 'Refresh News'}</span>
                  <span className="sm:hidden">{loadingNews ? 'Loading' : 'Refresh'}</span>
                </button>
              </div>
            </div>

            {/* Sentiment Summary */}
            {newsFeed.length > 0 && (
              <div className="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4">
                <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg md:rounded-xl p-3 md:p-4">
                  <div className="text-xs md:text-sm text-emerald-400 mb-1">Bullish News</div>
                  <div className="text-2xl md:text-3xl font-bold text-emerald-400">
                    {newsFeed.filter(n => n.sentiment === 'bullish').length}
                  </div>
                </div>
                <div className="bg-red-500/10 border border-red-500/30 rounded-lg md:rounded-xl p-3 md:p-4">
                  <div className="text-xs md:text-sm text-red-400 mb-1">Bearish News</div>
                  <div className="text-2xl md:text-3xl font-bold text-red-400">
                    {newsFeed.filter(n => n.sentiment === 'bearish').length}
                  </div>
                </div>
                <div className="bg-slate-700/30 border border-slate-600/30 rounded-lg md:rounded-xl p-3 md:p-4">
                  <div className="text-xs md:text-sm text-slate-400 mb-1">Neutral</div>
                  <div className="text-2xl md:text-3xl font-bold text-slate-300">
                    {newsFeed.filter(n => n.sentiment === 'neutral').length}
                  </div>
                </div>
                <div className="bg-violet-500/10 border border-violet-500/30 rounded-lg md:rounded-xl p-3 md:p-4">
                  <div className="text-xs md:text-sm text-violet-400 mb-1">Overall Sentiment</div>
                  <div className={`text-xl md:text-2xl font-bold ${
                    newsFeed.filter(n => n.sentiment === 'bullish').length > newsFeed.filter(n => n.sentiment === 'bearish').length
                      ? 'text-emerald-400' : 'text-red-400'
                  }`}>
                    {newsFeed.filter(n => n.sentiment === 'bullish').length > newsFeed.filter(n => n.sentiment === 'bearish').length
                      ? '📈 Bullish' : '📉 Bearish'}
                  </div>
                </div>
              </div>
            )}

            {/* News Feed */}
            {newsFeed.length === 0 ? (
              <div className="bg-slate-800/30 rounded-lg md:rounded-xl p-6 md:p-12 text-center">
                <MessageCircle className="w-12 md:w-16 h-12 md:h-16 text-slate-600 mx-auto mb-3 md:mb-4" />
                <h3 className="text-lg md:text-xl font-semibold mb-2">No News Yet</h3>
                <p className="text-xs md:text-sm text-slate-400 mb-4 md:mb-6">Click "Refresh News" to load the latest market news and sentiment analysis</p>
                <button
                  onClick={generateNewsFeed}
                  disabled={loadingNews}
                  className="bg-violet-600 hover:bg-violet-500 px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold text-sm md:text-base"
                >
                  Load News Feed
                </button>
              </div>
            ) : (
              <div className="space-y-2 md:space-y-3">
                {newsFeed
                  .filter(news => {
                    if (newsFilter === 'all') return true;
                    if (newsFilter === 'bullish') return news.sentiment === 'bullish';
                    if (newsFilter === 'bearish') return news.sentiment === 'bearish';
                    if (newsFilter === 'high') return news.impact === 'high';
                    return true;
                  })
                  .map((news) => (
                  <div
                    key={news.id}
                    className={`bg-slate-900/50 border rounded-xl p-5 hover:border-violet-500/50 transition-all cursor-pointer ${
                      news.sentiment === 'bullish' ? 'border-emerald-500/30' :
                      news.sentiment === 'bearish' ? 'border-red-500/30' :
                      'border-slate-700/50'
                    }`}
                    onClick={() => {
                      if (news.symbol && news.symbol !== 'SPY' && news.symbol !== 'QQQ' && news.symbol !== 'VIX') {
                        setTickerSymbol(news.symbol);
                        setActiveTab("ticker");
                      }
                    }}
                  >
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <span className={`px-2.5 py-1 rounded-lg text-xs font-bold ${
                            news.sentiment === 'bullish' ? 'bg-emerald-500/20 text-emerald-400' :
                            news.sentiment === 'bearish' ? 'bg-red-500/20 text-red-400' :
                            'bg-slate-600/30 text-slate-400'
                          }`}>
                            {news.sentiment === 'bullish' ? '📈 BULLISH' :
                             news.sentiment === 'bearish' ? '📉 BEARISH' : '➖ NEUTRAL'}
                          </span>
                          <span className={`px-2 py-0.5 rounded text-xs ${
                            news.impact === 'high' ? 'bg-amber-500/20 text-amber-400' :
                            news.impact === 'medium' ? 'bg-blue-500/20 text-blue-400' :
                            'bg-slate-600/20 text-slate-400'
                          }`}>
                            {news.impact?.toUpperCase()} IMPACT
                          </span>
                          <span className="px-2 py-0.5 rounded text-xs bg-violet-500/20 text-violet-400">
                            {news.category}
                          </span>
                        </div>
                        <h3 className="font-semibold text-lg mb-2">{news.headline}</h3>
                        <div className="flex items-center gap-4 text-sm text-slate-400">
                          <span className="font-bold text-violet-400">${news.symbol}</span>
                          <span>{news.source}</span>
                          <span>
                            {news.timestamp instanceof Date
                              ? news.timestamp.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                              : new Date(news.timestamp).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                            }
                          </span>
                          {news.isReal && (
                            <span className="text-emerald-400 text-xs">✓ Live</span>
                          )}
                        </div>
                      </div>
                      <div className="flex flex-col items-end gap-2">
                        {news.symbol && news.symbol !== 'SPY' && news.symbol !== 'QQQ' && news.symbol !== 'VIX' && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setTickerSymbol(news.symbol);
                              setActiveTab("ticker");
                            }}
                            className="px-3 py-1.5 bg-violet-600/20 hover:bg-violet-600/40 text-violet-400 rounded-lg text-sm font-medium flex items-center gap-1"
                          >
                            <LineChart className="w-3 h-3" />
                            View Chart
                          </button>
                        )}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            if (!watchlist.includes(news.symbol)) {
                              setWatchlist([...watchlist, news.symbol]);
                            }
                          }}
                          className="px-3 py-1.5 bg-slate-700/50 hover:bg-slate-700 text-slate-300 rounded-lg text-sm font-medium flex items-center gap-1"
                        >
                          <Eye className="w-3 h-3" />
                          Watch
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Info Footer */}
            <div className="bg-violet-500/10 border border-violet-500/30 rounded-xl p-4">
              <p className="text-sm text-violet-200">
                <strong>AI Sentiment Analysis:</strong> News headlines are analyzed for bullish/bearish sentiment and categorized by impact level. Click any news item to view the stock's chart. Use filters to focus on specific sentiment or high-impact news.
              </p>
            </div>
          </div>
        )}

        {/* Main Content Footer */}
        <footer className="mt-12 pt-8 border-t border-slate-800/30">
          <div className="flex flex-col md:flex-row items-center justify-between gap-4 text-xs text-slate-500">
            <div className="flex items-center gap-2">
              <span className="font-semibold text-slate-400">MODUS Trading Platform</span>
            </div>
            <div className="text-center flex-1">
              <p className="text-slate-500">© {new Date().getFullYear()} MODUS. Not financial advice.</p>
            </div>
            <div className="text-right">
              <p className="text-slate-600">Educational tool only</p>
            </div>
          </div>
        </footer>

        {/* ============ INFO & LEGAL TAB ============ */}
        {activeTab === "info" && (
          <div className="p-4 md:p-8 animate-fadeIn">
            <div className="max-w-4xl mx-auto">
              {/* Tab header */}
              <div className="mb-6">
                <h1 className="text-2xl md:text-3xl font-bold mb-2">Info & Legal</h1>
                <p className="text-slate-400">Everything you need to know about MODUS — features, terms, and privacy.</p>
              </div>

              {/* Sub-navigation */}
              <div className="flex gap-2 mb-8 border-b border-slate-800/50 pb-3">
                {[
                  { key: 'features', label: 'All Features', icon: '⚡' },
                  { key: 'vocab', label: 'Vocabulary', icon: '📖' },
                  { key: 'terms', label: 'Terms of Service', icon: '📜' },
                  { key: 'privacy', label: 'Privacy Policy', icon: '🔒' }
                ].map(tab => (
                  <button
                    key={tab.key}
                    onClick={() => setInfoSubTab(tab.key)}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${
                      infoSubTab === tab.key
                        ? 'bg-violet-600 text-white shadow-lg shadow-violet-500/25'
                        : 'bg-slate-800/50 text-slate-400 hover:bg-slate-700/50 hover:text-white'
                    }`}
                  >
                    <span>{tab.icon}</span>
                    {tab.label}
                  </button>
                ))}
              </div>

              {/* VOCABULARY / GLOSSARY */}
              {infoSubTab === 'vocab' && (() => {
                const vocabCategories = [
                  { title: 'Order Types', color: 'violet', terms: [
                    { term: 'Market Order', def: 'An order to buy or sell a stock immediately at the best available current price. Guarantees execution but not price. Best for highly liquid stocks when you need instant fills.' },
                    { term: 'Limit Order', def: 'An order to buy or sell at a specific price or better. A buy limit order executes at the limit price or lower; a sell limit order executes at the limit price or higher. May not fill if the price never reaches your limit.' },
                    { term: 'Stop Loss Order', def: 'An order that becomes a market order once the stock hits a specified price (the stop price). Used to limit losses on a position. For example, if you buy at $100 and set a stop at $95, the stock auto-sells if it drops to $95.' },
                    { term: 'Stop Limit Order', def: 'Combines a stop order with a limit order. When the stop price is reached, it places a limit order instead of a market order. Offers more price control but may not fill if the stock gaps through your limit price.' },
                    { term: 'Trailing Stop Loss ($)', def: 'A stop order that follows the stock price upward by a fixed dollar amount. If you set a $5 trailing stop and the stock rises from $100 to $120, the stop moves from $95 to $115. Locks in profits while protecting against downside.' },
                    { term: 'Trailing Stop Loss (%)', def: 'Same as dollar trailing stop but uses a percentage. A 5% trail on a $100 stock sets the stop at $95. If it rises to $120, stop is at $114. Better for volatile stocks where a fixed dollar amount may be too tight.' },
                    { term: 'Trailing Stop Limit ($)', def: 'A trailing stop that converts to a limit order instead of a market order when triggered. Gives price control on the exit, but in a fast-moving market, the limit order may not fill, leaving you still in the position.' },
                    { term: 'Trailing Stop Limit (%)', def: 'Same as dollar trailing stop limit but uses a percentage-based trail distance. Combines the benefits of automatic trailing with limit order protection against poor fills.' },
                    { term: 'Time in Force (TIF)', def: 'A special instruction attached to an order that tells your broker how long the order should remain active before being automatically canceled. Time in Force determines the lifespan of your order — from seconds (Fill or Kill) to months (Good \'til Canceled). Choosing the right TIF is critical: use Day Orders for active trading, GTC for passive entries at target prices, and FOK/IOC for large institutional-size orders. Always match your TIF to your strategy and timeframe.' },
                    { term: 'Day Order', def: 'An order that is only valid for the current trading session and automatically cancels at 4:00 PM ET if not executed. This is the default Time in Force setting at most brokerages. Best for day traders who want a clean slate each session — no leftover orders that might fill unexpectedly the next morning on a gap.' },
                    { term: 'Good \'til Canceled (GTC)', def: 'An order that stays active until it either executes or you manually cancel it. Most brokers auto-cancel GTC orders after 60-180 days depending on the platform. Ideal for swing traders setting limit orders at specific support/resistance levels where you\'re willing to wait days or weeks for your price to be hit.' },
                    { term: 'Fill or Kill (FOK)', def: 'An order that must be executed immediately in its entirety — every single share — or it is canceled completely. No partial fills are allowed. Primarily used for large institutional orders where getting only half the shares would ruin the intended position sizing or hedging strategy. Rarely used by retail traders.' },
                    { term: 'Immediate or Cancel (IOC)', def: 'An order that attempts to fill as many shares as possible immediately at the specified price, then cancels any remaining unfilled portion. Unlike Fill or Kill, partial fills ARE accepted. Useful when you want speed and are okay getting 80 of 100 shares rather than waiting. Good for less liquid stocks where full immediate fills are unlikely.' },
                    { term: 'On the Open (OPG)', def: 'An order that executes only at the official market opening price. Must be submitted during a specific window — typically between 4:15 PM and 9:28 AM ET. Used by traders who want to react to overnight news, earnings announcements, or pre-market catalysts and get in at the very first traded price of the session.' },
                  ]},
                  { title: 'Position & Direction', color: 'emerald', terms: [
                    { term: 'Long Position', def: 'Buying a stock with the expectation that its price will rise. You profit when the price goes up. "Going long" simply means buying.' },
                    { term: 'Short Position (Shorting)', def: 'Selling borrowed shares with the expectation that the price will fall. You profit when the price goes down, then buy back at a lower price. Carries unlimited risk since a stock can theoretically rise forever.' },
                    { term: 'Short Squeeze', def: 'When a heavily shorted stock rises rapidly, forcing short sellers to buy back shares to cover their positions, which drives the price even higher in a feedback loop.' },
                    { term: 'Covering', def: 'Buying back shares to close a short position. "Short covering" can cause rapid price increases if many shorts close at once.' },
                    { term: 'Position Sizing', def: 'Determining how many shares to buy based on your risk tolerance. Formula: (Account Risk $) ÷ (Risk Per Share) = Number of Shares. Example: $200 risk ÷ $5 risk per share = 40 shares.' },
                    { term: 'Margin', def: 'Borrowed money from your broker used to buy securities. Margin trading amplifies both gains and losses. A "margin call" occurs when your account equity drops below the minimum requirement.' },
                    { term: 'Leverage', def: 'Using borrowed money or financial instruments to amplify potential returns. 2:1 leverage means you control $2 of stock for every $1 of your own money.' },
                  ]},
                  { title: 'Technical Analysis', color: 'cyan', terms: [
                    { term: 'Support Level', def: 'A price level where buying pressure is strong enough to prevent the price from falling further. Think of it as a "floor" — the more times price bounces off a support level, the stronger it is.' },
                    { term: 'Resistance Level', def: 'A price level where selling pressure is strong enough to prevent the price from rising further. Think of it as a "ceiling." When resistance is broken, it often becomes new support.' },
                    { term: 'RSI (Relative Strength Index)', def: 'A momentum oscillator (0-100) that measures the speed and magnitude of recent price changes. Above 70 = overbought (may pull back), below 30 = oversold (may bounce). Uses a 14-period default.' },
                    { term: 'MACD', def: 'Moving Average Convergence Divergence. Shows the relationship between two moving averages. MACD Line (12 EMA - 26 EMA) crossing above the Signal Line (9 EMA of MACD) is bullish; crossing below is bearish.' },
                    { term: 'Moving Average (MA)', def: 'The average price over a set number of periods. SMA (Simple) weights all periods equally; EMA (Exponential) weights recent prices more heavily. Common periods: 20, 50, 200 days.' },
                    { term: 'Bollinger Bands', def: 'Three lines: a 20-period SMA in the middle, with upper and lower bands 2 standard deviations away. When price touches the upper band, it may be overbought; lower band, oversold. Band squeeze indicates low volatility before a big move.' },
                    { term: 'VWAP', def: 'Volume Weighted Average Price. The average price weighted by volume throughout the day. Institutional traders use VWAP as a benchmark — buying below VWAP is considered "good" execution.' },
                    { term: 'Candlestick', def: 'A price chart element showing open, high, low, and close for a time period. Green/white candle = close above open (bullish). Red/black = close below open (bearish). Wicks show price extremes.' },
                    { term: 'Doji', def: 'A candlestick where open and close are nearly equal, creating a cross shape. Signals indecision in the market. Often precedes a reversal, especially at support/resistance levels.' },
                    { term: 'Head and Shoulders', def: 'A bearish reversal pattern with three peaks: left shoulder, head (highest), right shoulder. The "neckline" connects the lows. A break below the neckline confirms the reversal. Target = head-to-neckline distance.' },
                    { term: 'Double Top / Double Bottom', def: 'Reversal patterns where price tests a level twice and fails. Double top (bearish): two highs at similar prices then drops. Double bottom (bullish): two lows at similar prices then rises.' },
                    { term: 'Divergence', def: 'When price moves one direction but an indicator (like RSI) moves the opposite. Bullish divergence: price makes lower lows but RSI makes higher lows. Often signals an upcoming reversal.' },
                    { term: 'Breakout', def: 'When price moves above resistance or below support with increased volume. Breakouts signal the start of a new trend. Confirmed by volume — a breakout on low volume is suspect.' },
                    { term: 'Pullback', def: 'A temporary price decline within an uptrend, or a temporary rally within a downtrend. Pullbacks to support/moving averages are often viewed as buying opportunities in a bullish trend.' },
                    { term: 'Gap', def: 'A space on a chart where no trading occurred — price jumps from one level to another. Gap up = bullish, gap down = bearish. "Gap fills" happen when price returns to fill the empty space.' },
                  ]},
                  { title: 'Risk Management', color: 'rose', terms: [
                    { term: 'Risk/Reward Ratio (R:R)', def: 'The ratio of potential loss to potential gain. If risking $5 to make $15, R:R is 1:3. Generally, only take trades with at least 1:2 R:R. Even with a 40% win rate, 1:3 R:R is profitable.' },
                    { term: 'Stop Loss', def: 'A predetermined price at which you exit a losing trade to limit losses. Should be set BEFORE entering a trade. Common placement: below recent swing low (longs) or above recent swing high (shorts).' },
                    { term: 'Take Profit', def: 'A predetermined price at which you exit a winning trade to lock in gains. Can be based on resistance levels, Fibonacci extensions, or a fixed R:R multiple of your risk.' },
                    { term: 'Drawdown', def: 'The peak-to-trough decline in your account value. Max drawdown is the largest percentage drop from a peak. Professional traders try to keep max drawdown under 20%.' },
                    { term: 'Risk Per Trade', def: 'The maximum percentage of your account you\'re willing to lose on one trade. The "1-2% rule" means never risking more than 1-2% of total account value on a single trade.' },
                    { term: 'Win Rate', def: 'The percentage of trades that are profitable. A 60% win rate means 6 out of 10 trades are winners. Win rate alone doesn\'t determine profitability — R:R ratio matters equally.' },
                    { term: 'Profit Factor', def: 'Gross profit divided by gross loss. A profit factor above 1.0 means your strategy is profitable. Above 2.0 is considered very good. Example: $10,000 in gains ÷ $5,000 in losses = 2.0 profit factor.' },
                    { term: 'Volatility', def: 'The degree of price variation over time. High volatility = large price swings (more risk but more opportunity). Measured by ATR (Average True Range) or standard deviation. VIX measures market-wide volatility.' },
                  ]},
                  { title: 'Market Fundamentals', color: 'amber', terms: [
                    { term: 'Bull Market', def: 'A market condition where prices are rising or expected to rise, typically defined as a 20%+ increase from recent lows. Characterized by optimism, investor confidence, and economic growth.' },
                    { term: 'Bear Market', def: 'A market condition where prices are falling or expected to fall, typically defined as a 20%+ decline from recent highs. Characterized by pessimism and economic contraction.' },
                    { term: 'Market Cap', def: 'Total value of a company\'s outstanding shares. Calculated as share price × shares outstanding. Large cap: $10B+, Mid cap: $2-10B, Small cap: $300M-2B, Micro cap: under $300M.' },
                    { term: 'P/E Ratio', def: 'Price-to-Earnings ratio. Stock price divided by earnings per share. Shows how much investors pay per dollar of earnings. High P/E may mean overvalued or high growth expected. Average S&P 500 P/E is ~20-25.' },
                    { term: 'EPS (Earnings Per Share)', def: 'Company\'s net profit divided by shares outstanding. Higher EPS = more profitable. EPS growth over time is a key measure of company health. "EPS beat" means actual EPS exceeded analyst estimates.' },
                    { term: 'Volume', def: 'The number of shares traded in a given period. High volume confirms price moves — a breakout on high volume is more reliable than one on low volume. Average daily volume helps gauge liquidity.' },
                    { term: 'Liquidity', def: 'How easily a stock can be bought or sold without significantly affecting its price. High volume stocks are more liquid. Low liquidity = wider spreads and harder exits during volatile periods.' },
                    { term: 'Bid-Ask Spread', def: 'The difference between the highest price a buyer will pay (bid) and the lowest price a seller will accept (ask). Tight spread = liquid stock. Wide spread = illiquid, costs you more to enter/exit.' },
                    { term: 'Dividend', def: 'A portion of company profits paid to shareholders, usually quarterly. Dividend yield = annual dividend ÷ stock price. Companies with consistent dividend growth are often more stable long-term investments.' },
                    { term: 'Float', def: 'The number of shares available for public trading (total shares minus restricted/insider shares). Low float stocks are more volatile because fewer shares are available — small volume can cause big price moves.' },
                    { term: 'Catalyst', def: 'An event that causes a significant price move. Examples: earnings reports, FDA approvals, mergers, product launches, analyst upgrades. Catalysts can be planned (known dates) or unexpected.' },
                    { term: 'Pre-Market / After-Hours', def: 'Trading sessions outside regular market hours (9:30 AM - 4:00 PM ET). Pre-market: 4:00-9:30 AM. After-hours: 4:00-8:00 PM. Lower liquidity and wider spreads. Often reacts to earnings and news.' },
                  ]},
                  { title: 'Trading Psychology', color: 'purple', terms: [
                    { term: 'FOMO (Fear of Missing Out)', def: 'The anxiety that you\'re missing a profitable trade, causing impulsive entries without proper analysis. One of the most common reasons retail traders lose money. Antidote: stick to your trading plan.' },
                    { term: 'Revenge Trading', def: 'Taking impulsive trades to "win back" losses from a previous bad trade. Usually leads to larger losses and emotional decision-making. Solution: set a daily loss limit and walk away when hit.' },
                    { term: 'Confirmation Bias', def: 'Seeking only information that supports your existing view while ignoring contradictory evidence. Leads to holding losing positions too long or ignoring sell signals.' },
                    { term: 'Paper Hands / Diamond Hands', def: 'Paper hands: selling too early out of fear. Diamond hands: holding through volatility with conviction. Neither extreme is ideal — having a plan with predetermined exits is best.' },
                    { term: 'Averaging Down', def: 'Buying more shares of a losing position to lower your average cost. Can be a valid strategy with a plan, but dangerous without one — it\'s how small losses become account-ending disasters.' },
                    { term: 'Overtrading', def: 'Taking too many trades, often driven by boredom, FOMO, or the need for action. Quality over quantity — fewer, well-planned trades typically outperform high-frequency impulsive trading.' },
                  ]},
                  { title: 'Analytics & Performance', color: 'sky', terms: [
                    { term: 'Equity Curve', def: 'A visual chart plotting your cumulative profit and loss over time, starting from zero. An upward-sloping equity curve indicates consistent profitability, while a jagged or declining curve suggests issues with strategy or discipline. Professional traders monitor their equity curve to detect when a strategy stops working.' },
                    { term: 'Win Rate', def: 'The percentage of your trades that resulted in a profit. Calculated as (winning trades / total trades) × 100. A 50% win rate means half your trades are profitable. However, win rate alone does not determine profitability — a trader with 30% win rate can still be profitable if their winners are much larger than their losers (high reward:risk ratio).' },
                    { term: 'Max Drawdown', def: 'The largest peak-to-trough decline in your account equity. If your account grew from $10,000 to $15,000 then dropped to $12,000, your max drawdown is $3,000 or 20% from peak. This metric measures the worst-case scenario you have experienced and helps assess risk tolerance.' },
                    { term: 'Risk:Reward Ratio', def: 'The ratio of potential loss to potential gain on a trade. A 1:3 risk:reward means you risk $1 to potentially make $3. Professional traders typically aim for at least 1:2. Combined with win rate, this determines long-term profitability — you can have a low win rate and still be profitable with a high R:R.' },
                    { term: 'Sharpe Ratio', def: 'A measure of risk-adjusted return. It calculates how much excess return you earn per unit of risk (volatility). A Sharpe ratio above 1.0 is considered good, above 2.0 is very good, and above 3.0 is excellent. It helps compare strategies that have different levels of risk.' },
                    { term: 'Trade Duration', def: 'How long you hold a position from entry to exit. Day traders hold for minutes to hours, swing traders for days to weeks, position traders for weeks to months. Tracking trade duration helps identify whether you are holding winners long enough and cutting losers quickly enough.' },
                    { term: 'Consecutive Loss Lockout', def: 'A self-imposed rule where you stop trading for the day after a specified number of consecutive losses. Common thresholds are 3-5 consecutive losses. This prevents revenge trading and emotional decision-making after a losing streak.' },
                    { term: 'Position Sizing', def: 'The process of determining how many shares or contracts to trade based on your account size, risk tolerance, and the specific trade setup. The most common method is fixed-percentage risk: if you risk 1% of a $50,000 account per trade, your maximum risk per trade is $500. The number of shares is then calculated as risk amount divided by the distance between entry and stop loss.' },
                    { term: 'FOMO (Fear of Missing Out)', def: 'The anxiety that you are missing a profitable opportunity. FOMO leads traders to chase entries after a stock has already made a large move, enter positions without proper analysis, or increase position sizes beyond their risk parameters. It is one of the most common trading psychology mistakes.' },
                    { term: 'Revenge Trading', def: 'The act of immediately entering new trades after a loss in an attempt to recover the money quickly. This often leads to larger losses because the trader is acting emotionally rather than following their strategy. Setting a consecutive loss lockout rule helps prevent revenge trading.' },
                    { term: 'Gap (Gap Up / Gap Down)', def: 'When a stock opens at a price significantly different from its previous close, creating a visible "gap" on the chart. A gap up means the stock opened higher than the previous close; a gap down means it opened lower. Gaps are often caused by after-hours earnings, news events, or analyst upgrades/downgrades.' },
                    { term: 'Unusual Volume', def: 'When a stock trades significantly more shares than its average daily volume, typically 2x or more. Unusual volume often signals institutional activity, upcoming news, or a potential breakout/breakdown. Volume scanners track this to identify stocks with abnormal trading activity.' },
                    { term: 'Relative Strength', def: 'A comparison of one stock performance versus another stock or an index (like SPY). Stocks with high relative strength outperform the benchmark even in weak markets. This is different from RSI (Relative Strength Index) which measures overbought/oversold conditions within a single stock.' },
                    { term: 'Sector Rotation', def: 'The movement of investment capital from one industry sector to another as investors adjust their portfolios based on the economic cycle. During economic expansion, money flows into cyclical sectors (tech, consumer discretionary). During contraction, money flows into defensive sectors (utilities, healthcare, consumer staples).' },
                    { term: 'Portfolio Beta', def: 'A measure of how volatile your overall portfolio is compared to the market (S&P 500). A beta of 1.0 means your portfolio moves in line with the market. Beta above 1.0 means more volatile, below 1.0 means less volatile. A beta of 0 means no correlation to market movements.' },
                  ]},
                ];

                const filteredCategories = vocabSearch.length > 1
                  ? vocabCategories.map(cat => ({
                      ...cat,
                      terms: cat.terms.filter(t => t.term.toLowerCase().includes(vocabSearch.toLowerCase()) || t.def.toLowerCase().includes(vocabSearch.toLowerCase()))
                    })).filter(cat => cat.terms.length > 0)
                  : vocabCategories;
                const totalTerms = vocabCategories.reduce((sum, cat) => sum + cat.terms.length, 0);

                return (
                  <div className="space-y-6 animate-fadeIn">
                    <div className="bg-gradient-to-r from-violet-500/10 to-purple-500/10 border border-violet-500/20 rounded-xl p-6">
                      <h2 className="text-xl font-bold mb-2 flex items-center gap-3">
                        <span className="text-2xl">📖</span> Trading Vocabulary
                      </h2>
                      <p className="text-slate-400 text-sm mb-4">{totalTerms} essential trading terms across {vocabCategories.length} categories — from order types to psychology.</p>
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                        <input
                          type="text"
                          value={vocabSearch}
                          onChange={(e) => setVocabSearch(e.target.value)}
                          placeholder="Search terms..."
                          className="w-full bg-slate-800/50 border border-slate-700/30 rounded-lg pl-10 pr-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/50 placeholder:text-slate-500"
                        />
                      </div>
                    </div>

                    {filteredCategories.map(cat => {
                      const colorMap = { violet: 'border-violet-500/30 text-violet-400', emerald: 'border-emerald-500/30 text-emerald-400', cyan: 'border-cyan-500/30 text-cyan-400', rose: 'border-rose-500/30 text-rose-400', amber: 'border-amber-500/30 text-amber-400', purple: 'border-purple-500/30 text-purple-400' };
                      const bgMap = { violet: 'bg-violet-500/10', emerald: 'bg-emerald-500/10', cyan: 'bg-cyan-500/10', rose: 'bg-rose-500/10', amber: 'bg-amber-500/10', purple: 'bg-purple-500/10' };
                      return (
                        <div key={cat.title}>
                          <h3 className={`text-sm font-bold mb-3 flex items-center gap-2 ${colorMap[cat.color]?.split(' ')[1] || 'text-white'}`}>
                            <div className={`w-1.5 h-1.5 rounded-full ${bgMap[cat.color]?.replace('/10', '/60') || 'bg-white'}`} style={{ backgroundColor: cat.color === 'violet' ? '#8b5cf6' : cat.color === 'emerald' ? '#34d399' : cat.color === 'cyan' ? '#22d3ee' : cat.color === 'rose' ? '#fb7185' : cat.color === 'amber' ? '#fbbf24' : '#a78bfa' }} />
                            {cat.title} <span className="text-[10px] text-slate-500 font-normal">({cat.terms.length} terms)</span>
                          </h3>
                          <div className="space-y-2">
                            {cat.terms.map(t => (
                              <div key={t.term} className={`${bgMap[cat.color]} border ${colorMap[cat.color]?.split(' ')[0] || 'border-slate-700/20'} rounded-lg p-4`}>
                                <div className="font-semibold text-white text-sm mb-1">{t.term}</div>
                                <p className="text-xs text-slate-300 leading-relaxed">{t.def}</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                    {filteredCategories.length === 0 && (
                      <div className="text-center py-8 text-slate-500">
                        <Search className="w-8 h-8 mx-auto mb-2 opacity-50" />
                        <p className="text-sm">No terms found for "{vocabSearch}"</p>
                      </div>
                    )}
                  </div>
                );
              })()}

              {/* FEATURES CONTENT — DETAILED VERSION */}
              {infoSubTab === 'features' && (
                <div className="space-y-8 animate-fadeIn">
                  {/* Hero intro */}
                  <div className="bg-gradient-to-br from-violet-500/10 to-indigo-500/10 border border-violet-500/20 rounded-2xl p-6 md:p-8">
                    <h2 className="text-2xl font-bold text-white mb-3">Welcome to MODUS</h2>
                    <p className="text-lg text-slate-300 leading-relaxed mb-4">MODUS is an all-in-one trading analysis platform built for traders who want real tools — not gimmicks. Whether you are brand new to trading and learning the basics, or an experienced day trader looking for an edge, MODUS gives you institutional-grade analysis, smart automation, and a complete trading workflow in one place.</p>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                      <div className="text-center p-3 bg-slate-800/40 rounded-xl">
                        <div className="text-2xl font-bold text-violet-400">50+</div>
                        <div className="text-xs text-slate-400">Built-in Tools</div>
                      </div>
                      <div className="text-center p-3 bg-slate-800/40 rounded-xl">
                        <div className="text-2xl font-bold text-emerald-400">220+</div>
                        <div className="text-xs text-slate-400">Stocks Scanned</div>
                      </div>
                      <div className="text-center p-3 bg-slate-800/40 rounded-xl">
                        <div className="text-2xl font-bold text-amber-400">6</div>
                        <div className="text-xs text-slate-400">Timeframes</div>
                      </div>
                      <div className="text-center p-3 bg-slate-800/40 rounded-xl">
                        <div className="text-2xl font-bold text-cyan-400">Real-Time</div>
                        <div className="text-xs text-slate-400">Market Data</div>
                      </div>
                    </div>
                  </div>

                  {/* Section 1: AI Analysis */}
                  <div className="bg-slate-900/50 rounded-xl border border-slate-800/50 overflow-hidden">
                    <div className="px-6 py-5 border-b border-slate-800/50 bg-gradient-to-r from-violet-500/10 to-transparent">
                      <h2 className="text-xl font-bold flex items-center gap-3">
                        <span className="text-2xl">🧠</span>
                        AI-Powered Analysis
                        <span className="text-xs bg-violet-500/20 text-violet-300 px-2 py-0.5 rounded-full">Core Feature</span>
                      </h2>
                      <p className="text-sm text-slate-400 mt-2">The heart of MODUS — advanced AI that reads charts the way a professional technical analyst would, giving you actionable trade setups in seconds.</p>
                    </div>
                    <div className="divide-y divide-slate-800/30">
                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">AI Chart Analysis</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Upload a screenshot of any stock chart from TradingView, Thinkorswim, Webull, or any other charting platform, and MODUS will analyze it using advanced AI vision models. The AI identifies candlestick patterns (doji, engulfing, hammer, shooting star), chart patterns (head & shoulders, double tops/bottoms, triangles, flags), support and resistance levels, trend direction, and volume characteristics.</p>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Every analysis generates a complete trade setup including a specific entry price, stop loss, three take-profit target levels, a confidence score from 0-100, and a clear recommendation (Strong Buy, Buy, Hold, Sell, Strong Sell). The analysis is deterministic — uploading the same chart image twice will always give you the same result, so you can trust the consistency of the output.</p>
                        <div className="bg-slate-800/40 rounded-lg px-4 py-3 text-xs text-slate-500 border border-slate-700/30">
                          <span className="text-violet-400 font-semibold">How to use:</span> Go to the Analyze tab, upload or drag a chart screenshot, select your timeframe and asset type (or leave on Auto), and click "Analyze Chart." Results appear in seconds with full trade setup details.
                        </div>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Multi-Timeframe Analysis</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Professional traders always check multiple timeframes before entering a trade. MODUS automates this by analyzing the same stock across up to 6 timeframes at once: 1-minute, 5-minute, 15-minute, 1-hour, 4-hour, and daily. The system automatically captures live chart data for each timeframe, runs AI analysis on all of them in parallel, and then combines the results into a single multi-timeframe consensus.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">This helps you spot when a stock is bullish on the daily chart but overbought on the 15-minute — a common trap that catches beginners. Each timeframe shows its own score and recommendation, and the overall consensus tells you whether the timeframes are aligned or conflicting.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Ask AI Trading Assistant</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">A conversational AI assistant that understands trading. Ask it anything: "What does RSI divergence mean?", "Should I hold through earnings?", "Explain the difference between a limit order and a market order", or "What's a good strategy for trading AAPL?" The assistant draws on deep knowledge of technical analysis, fundamental analysis, risk management, trading psychology, and market mechanics.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">It is not limited to generic answers — if you have an active analysis loaded, the AI assistant can reference that specific data to give you context-aware guidance about your current trade idea.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Daily AI Pick</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Every day, the AI runs a comprehensive scan of over 220 stocks across 15 sectors using parallel batch processing. It evaluates each stock on multiple technical indicators — RSI (14-period), MACD histogram, SMA20/SMA50 crossovers, trend detection, and volume analysis — to identify the single best trade opportunity of the day.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">The daily pick comes with a complete analysis: confidence score, specific entry price, stop loss level, target prices, risk/reward ratio, and a detailed explanation of why this stock was selected. The scan results are cached for 5 minutes to prevent excessive API calls while keeping data fresh.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Quick Analysis</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Enter any stock ticker and get an instant AI-powered buy/sell/hold verdict in seconds. Quick Analysis fetches live data via an 8-proxy fallback chain to Yahoo Finance, computes technical indicators (RSI, SMA20/50, MACD, volume trends), and sends everything to the AI for a comprehensive verdict with confidence score, target price, stop loss, support/resistance levels, and risk:reward ratio.</p>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">The "Tell Me More" button expands into a structured deep-dive with 5 organized cards: Technical Analysis (indicator signals with Bullish/Bearish/Neutral badges), Entry &amp; Exit Strategy (order type, sizing, flow steps), Risk Assessment (severity matrix, max loss, warning signals), Sector &amp; Market Context (catalysts vs headwinds), and Scenario Analysis (bull/base/bear cases with probability and targets).</p>
                        <div className="bg-slate-800/40 rounded-lg px-4 py-3 text-xs text-slate-500 border border-slate-700/30">
                          <span className="text-violet-400 font-semibold">How to use:</span> Go to the Quick Analysis tab (or press "q"), type a ticker, and hit Analyze. Popular tickers are also available as one-click buttons. Your last 10 analyses are saved for easy comparison with color-coded confidence bars.
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Section 2: Market Data & Scanning */}
                  <div className="bg-slate-900/50 rounded-xl border border-slate-800/50 overflow-hidden">
                    <div className="px-6 py-5 border-b border-slate-800/50 bg-gradient-to-r from-blue-500/10 to-transparent">
                      <h2 className="text-xl font-bold flex items-center gap-3">
                        <span className="text-2xl">📊</span>
                        Market Data & Scanning
                      </h2>
                      <p className="text-sm text-slate-400 mt-2">Real-time market data from multiple sources with smart fallback, so you always have live prices and charts even when individual APIs go down.</p>
                    </div>
                    <div className="divide-y divide-slate-800/30">
                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Live Stock Ticker & Interactive Chart</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Type any US stock symbol and instantly see a full candlestick chart with real-time price data. The chart supports 8 timeframes (1m, 5m, 15m, 30m, 1h, 4h, Daily, Weekly) and automatically falls back to a larger timeframe if the requested one isn't available (e.g., 1-minute charts are only available during market hours). The chart is fully interactive — hover over any candle to see OHLCV data, and the ticker overlay stays pinned so you always see the current price.</p>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Chart overlays include: SMA (Simple Moving Average), EMA (Exponential Moving Average), Bollinger Bands, and VWAP (Volume Weighted Average Price). Separate indicator panels show Volume, RSI, MACD, Stochastic, and ATR. Each indicator has a built-in guide tooltip explaining what it measures and how to read it. You can also overlay a second stock for visual comparison — type any symbol in the Compare field to see normalized price lines side by side.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">Data is sourced from Yahoo Finance with automatic CORS proxy failover using parallel requests (Promise.any for fastest response), plus Finnhub and Alpha Vantage as additional fallbacks. Auto-refresh updates the chart every 10 seconds during market hours without full reloads.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Stock Screener</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">A powerful scanner that analyzes 220+ stocks across 15 sectors to find trade opportunities matching specific criteria. Comes with 8 built-in preset strategies: RSI Oversold (stocks below RSI 30), RSI Overbought (above RSI 70), Volume Breakout (unusual volume spikes), Bullish Momentum (strong uptrend with multiple confirmations), Bearish Momentum, Golden Cross (SMA20 crossing above SMA50), Death Cross, and High Volatility plays.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">You can also create custom filters by adjusting price range, volume minimum, RSI range, and volatility criteria. Stocks are ranked by a composite technical score and the results show key metrics for each: current price, RSI, change %, ATR, and the overall technical recommendation. Scanning uses parallel batch processing for speed — it can analyze all 220 stocks in under 30 seconds.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Market Overview & Sector Rotation</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">A dashboard-level view of the overall market. Displays live performance for major indices (SPY, QQQ, DIA, IWM), the VIX volatility index, and all 11 S&P 500 sectors (Technology, Healthcare, Financials, Energy, Consumer Discretionary, etc.) with sector ETF prices and daily change percentages. This helps you quickly gauge whether the broader market is risk-on or risk-off before trading individual stocks.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">The Sector Rotation tracker shows you which sectors are leading and lagging, so you can identify sector rotation trends — when money flows out of one sector and into another. A correlation heatmap visualizes how different stocks and sectors move relative to each other.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">News & Sentiment Feed</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">Aggregated financial news from multiple sources with real-time updates. Each headline includes AI-powered sentiment analysis classifying it as bullish, bearish, or neutral. You can filter news by sentiment type or by your watchlist stocks to see only the headlines that matter to your positions. This helps you stay ahead of market-moving events and understand the narrative driving price action.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Top Movers Ticker Strip</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">A live scrolling bar on the dashboard showing the top 5 gainers and top 3 losers from the market scanner, with symbol, change percentage, and color-coded badges (green for gainers, red for losers). Click any symbol to instantly navigate to its live chart. The strip is populated automatically when the market scanner runs and updates with the latest scan data.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Market Mood (Fear &amp; Greed Estimate)</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">A dashboard widget that estimates overall market sentiment on a 0-100 scale. The score is computed from three data points: the VIX volatility index (low VIX = greed, high VIX = fear), SPY daily performance, and the ratio of gainers to losers in the market scanner. The result is classified as Extreme Fear, Fear, Neutral, Greed, or Extreme Greed with a color-coded progress bar from red to green. Displays live VIX and SPY change values for transparency.</p>
                      </div>
                    </div>
                  </div>

                  {/* Section 3: Portfolio & Trading */}
                  <div className="bg-slate-900/50 rounded-xl border border-slate-800/50 overflow-hidden">
                    <div className="px-6 py-5 border-b border-slate-800/50 bg-gradient-to-r from-emerald-500/10 to-transparent">
                      <h2 className="text-xl font-bold flex items-center gap-3">
                        <span className="text-2xl">💰</span>
                        Portfolio & Trading Tools
                      </h2>
                      <p className="text-sm text-slate-400 mt-2">Track your real portfolio, practice risk-free with paper trading, and use built-in calculators to size positions correctly every time.</p>
                    </div>
                    <div className="divide-y divide-slate-800/30">
                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Portfolio Tracker & Live P&L</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Enter your real stock positions — symbol, quantity, and average cost — and MODUS will track them with live prices. The portfolio shows each position's current market value, unrealized P&L (profit/loss) in both dollars and percentage, daily change, and your total portfolio value. When you add more shares of a stock you already own, the system automatically recalculates your weighted average cost basis.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">Prices refresh automatically every 5 seconds during market hours, so your P&L is always current. You can see your portfolio from the custom Dashboard widget or the dedicated Portfolio tab.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Paper Trading Simulator</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Start with a virtual $100,000 balance and practice trading in a realistic simulated environment. Execute buy and sell orders using real-time market prices. Every paper trade is logged with timestamps and P&L, and your virtual balance updates accordingly. This is perfect for testing new strategies, building confidence before going live, or learning how the platform works without any financial risk.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">Paper trades integrate with the trading journal and performance metrics, so you can track your simulated win rate and see if your strategy is profitable before committing real capital.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Position Size Calculator</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">One of the most important tools for risk management. Enter your total account size, what percentage you're willing to risk on a single trade (e.g., 1-2%), your planned entry price, and your stop loss price. The calculator tells you exactly how many shares to buy, your maximum dollar risk, your expected risk per share, and the total position cost. This prevents the #1 mistake new traders make — risking too much on a single trade.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Options Profit Calculator</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">Visualize the profit/loss potential of options strategies before placing a trade. Supports calls, puts, vertical spreads, and straddles. Enter the option details (strike price, premium, expiration, number of contracts) and see an interactive payoff diagram showing your max profit, max loss, and breakeven point at various stock prices. This is powered by Black-Scholes pricing with full Greeks calculation (Delta, Gamma, Theta, Vega, Rho).</p>
                      </div>
                    </div>
                  </div>

                  {/* Section 4: Journal & Performance */}
                  <div className="bg-slate-900/50 rounded-xl border border-slate-800/50 overflow-hidden">
                    <div className="px-6 py-5 border-b border-slate-800/50 bg-gradient-to-r from-amber-500/10 to-transparent">
                      <h2 className="text-xl font-bold flex items-center gap-3">
                        <span className="text-2xl">📝</span>
                        Journaling & Performance Tracking
                      </h2>
                      <p className="text-sm text-slate-400 mt-2">The only way to improve as a trader is to track every trade and learn from your data. MODUS makes this effortless.</p>
                    </div>
                    <div className="divide-y divide-slate-800/30">
                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Trading Journal</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Log every trade with comprehensive details: symbol, side (long/short), entry price, exit price, quantity, stop loss, target, confidence level (1-5), strategy used, and free-form notes. Trades can be linked to AI analyses so you can later review what the AI recommended vs. what actually happened. Open trades show live P&L, and closing a trade automatically calculates your realized profit or loss.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">The journal includes a visual Trade Timeline showing your last 20 trades on a horizontal bar — each trade is color-coded green (win), red (loss), or blue (still open) with P&L labels, making it easy to spot patterns in your trading behavior at a glance.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Performance Dashboard & Metrics</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">A quantitative breakdown of your trading performance automatically calculated from your journal entries. Metrics include: win rate (percentage of profitable trades), total P&L, average winning trade, average losing trade, profit factor (gross profit divided by gross loss — above 1.5 is good), best and worst individual trades, current win/loss streak, average hold time, and Sharpe ratio (a risk-adjusted return metric used by hedge funds).</p>
                        <p className="text-sm text-slate-400 leading-relaxed">Monthly P&L is broken down so you can see which months were profitable and which weren't, helping you identify seasonal patterns or periods where you deviate from your strategy.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Trade Planner & Risk/Reward Visualizer</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Before entering any trade, use the trade planner to map out the full setup. Enter your entry price, stop loss, and target, and the planner calculates recommended share count (based on your risk settings), expected dollar profit, max dollar loss, risk per share, and the risk/reward ratio. A visual color-coded bar shows your stop, entry, and target zones so you can see the setup at a glance.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">The Risk/Reward Visualizer also appears directly in your AI analysis results, showing a color-coded bar with the stop zone (red), entry zone (amber), and target zone (green) with a clear R:R ratio badge.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Backtesting & Accuracy Tracking</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">After you've built up a history of AI analyses, the backtesting feature lets you measure how accurate those analyses were. It compares the AI's predicted direction and targets against what actually happened in the market. This gives you a real win rate for the AI's recommendations, helping you calibrate your trust in the system and adjust your strategy accordingly.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Trading Streak Widget</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">A dashboard widget that tracks your consecutive trading journal entries, encouraging daily accountability. The streak counts how many consecutive days you have logged at least one trade. Visual milestones unlock emoji badges: 3 days gets a fire badge, 7 days a star, 14 days a rocket, and 30+ days a trophy. Below the streak counter, you can see your total trade count and win count from your last 10 trades. If your streak is at zero, a "Log a trade to start" button takes you directly to the journal.</p>
                      </div>
                    </div>
                  </div>

                  {/* Section 5: Alerts & Monitoring */}
                  <div className="bg-slate-900/50 rounded-xl border border-slate-800/50 overflow-hidden">
                    <div className="px-6 py-5 border-b border-slate-800/50 bg-gradient-to-r from-red-500/10 to-transparent">
                      <h2 className="text-xl font-bold flex items-center gap-3">
                        <span className="text-2xl">🔔</span>
                        Alerts & Monitoring
                      </h2>
                      <p className="text-sm text-slate-400 mt-2">Set it and forget it — get notified the moment your price targets are hit, even when you're away from the screen.</p>
                    </div>
                    <div className="divide-y divide-slate-800/30">
                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Price Alerts System</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Create alerts for any stock with three condition types: price goes above a level, price drops below a level, or price crosses a specific price point. When your alert triggers, you can be notified through multiple channels: browser push notifications, an audible sound alert, and optionally through a Discord webhook (for sending alerts to your Discord server or DMs). Alerts check prices every 10 seconds while the app is open.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">Each alert shows its status (active, triggered, expired), the current price relative to the target, and how close the price is to triggering. Triggered alerts are logged in the Notification Center with timestamps so you have a full history.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Watchlist with Drag & Drop</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Build a list of stocks you're watching. Each watchlist entry shows the current price and daily change percentage, updated in real-time every 10 seconds. Click any stock to instantly load it in the Ticker tab for deeper analysis. Reorder your watchlist by dragging and dropping stocks to prioritize what matters most to you. Upcoming earnings dates are shown with "EARNINGS SOON" badges so you're never caught off guard by an earnings announcement.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">The watchlist also powers other features — the News feed can filter by your watchlist stocks, and alerts can be created directly from watchlist entries with one click.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Notification Center & Economic Calendar</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">The Notification Center keeps a full history of every alert that triggered, every system notification, and important events. Each notification is timestamped and clickable — clicking an alert notification takes you directly to that stock's chart. The Economic Calendar tracks major market-moving events like FOMC rate decisions, CPI inflation reports, Non-Farm Payrolls, earnings dates for major companies, and more, so you can plan your trades around high-impact news.</p>
                      </div>
                    </div>
                  </div>

                  {/* Section 6: Tools, Export & Customization */}
                  <div className="bg-slate-900/50 rounded-xl border border-slate-800/50 overflow-hidden">
                    <div className="px-6 py-5 border-b border-slate-800/50 bg-gradient-to-r from-slate-500/10 to-transparent">
                      <h2 className="text-xl font-bold flex items-center gap-3">
                        <span className="text-2xl">🛠️</span>
                        Tools, Export & Customization
                      </h2>
                      <p className="text-sm text-slate-400 mt-2">Export your work, customize your workspace, and keep your data safe.</p>
                    </div>
                    <div className="divide-y divide-slate-800/30">
                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Custom Dashboard</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">Your personal command center. The Dashboard shows configurable widgets in a responsive grid — choose which widgets to display from: Watchlist, Daily Pick, Portfolio, Alerts, Performance Metrics, Market Summary, News Feed, and Hot Stocks. Toggle widgets on and off with a single click, and your configuration is saved automatically between sessions. This is the default landing page when you open MODUS.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">PDF Reports & Social Sharing</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">Export any AI analysis as a professionally formatted PDF report. The PDF includes the confidence score, recommendation, detected patterns, trend analysis, support/resistance levels, the complete trade setup (entry, stop, targets), and indicator readings. Share your analyses directly to Twitter/X or Reddit with auto-formatted summaries, or copy a formatted summary to your clipboard for pasting anywhere.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Cloud Sync & Data Backup</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Sign in with Google or email/password to sync your data across all your devices. Your watchlist, trades, alerts, settings, analysis history, and dashboard configuration are stored securely in Firebase and automatically synced. You'll never lose your trading data if you clear your browser or switch computers.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">For an extra layer of protection, use the Data Backup & Restore feature in Settings to export all your local data (trades, watchlist, alerts, settings) as a JSON file. You can import this backup file at any time to restore your complete trading workspace.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">CSV Export & Mobile Support</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Export your trade journal or portfolio data as CSV files for use in Excel, Google Sheets, or your own analysis tools.</p>
                        <p className="text-sm text-slate-400 leading-relaxed">On mobile devices, a fixed bottom navigation bar provides quick access to all major sections (Dashboard, Ticker, Analysis, Daily Pick, Alerts, Journal) with a clean touch-friendly interface optimized for smaller screens.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Keyboard Shortcuts</h3>
                        <p className="text-sm text-slate-400 leading-relaxed mb-3">Full keyboard shortcut support lets power users navigate MODUS without touching the mouse. Press "?" at any time to see all available shortcuts. Mac users get native key symbols (⌘/⌥/⇧).</p>
                        <div className="bg-slate-800/40 rounded-lg px-4 py-3 text-xs text-slate-500 border border-slate-700/30 space-y-1.5">
                          <p><span className="text-violet-400 font-semibold">Dashboard shortcuts:</span> Press <kbd className="px-1 py-0.5 bg-slate-700/60 rounded text-[10px] font-mono border border-slate-600/30">/</kbd> to focus the Quick Analyze search bar instantly</p>
                          <p><span className="text-violet-400 font-semibold">Quick navigation:</span> Press <kbd className="px-1 py-0.5 bg-slate-700/60 rounded text-[10px] font-mono border border-slate-600/30">q</kbd> to jump to Quick Analysis tab from anywhere</p>
                          <p><span className="text-violet-400 font-semibold">Tab switching:</span> Number keys 1-9 to switch between tabs</p>
                          <p><span className="text-violet-400 font-semibold">Actions:</span> Ctrl+Enter to capture chart, Ctrl+E for PDF export, Ctrl+B to toggle sidebar</p>
                        </div>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Vocabulary / Glossary</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">A comprehensive glossary of 60+ trading terms organized into 6 categories: Order Types, Position &amp; Direction, Technical Analysis, Risk Management, Market Fundamentals, and Trading Styles. Each term includes a detailed, beginner-friendly definition with real examples, formulas, and practical tips. Searchable by keyword — type any term in the search bar to filter instantly. Available in the Info &amp; Legal tab.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Daily Trading Tip</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">A fresh trading tip every day on the dashboard, rotating through 30 curated tips across 5 categories: Risk Management, Psychology, Technical Analysis, Strategy, and Fundamentals. Each tip card is color-coded by category with a gradient background. Click "Random tip" for a bonus tip as a toast notification. Tips are educational, actionable, and designed to reinforce good trading habits over time.</p>
                      </div>

                      <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                        <h3 className="font-semibold text-white mb-2 text-lg">Guided Setup Wizard</h3>
                        <p className="text-sm text-slate-400 leading-relaxed">New to MODUS? The setup wizard walks you through getting started in 3 quick steps: a welcome overview of what the platform offers, building your first watchlist with one-click adds for popular stocks (AAPL, TSLA, MSFT, NVDA, AMZN, GOOGL, META, SPY), and a summary of next steps with tips for getting the most out of the platform. At the end, you'll be pointed to the Info & Legal tab for a full breakdown of every feature.</p>
                      </div>
                    </div>
                  </div>

                {/* Section: New in v2.2 */}
                <div className="bg-slate-900/50 rounded-xl border border-slate-800/50 overflow-hidden">
                  <div className="px-6 py-5 border-b border-slate-800/50 bg-gradient-to-r from-sky-500/10 to-transparent">
                    <h2 className="text-xl font-bold flex items-center gap-3">
                      <span className="text-2xl">🆕</span>
                      New in v2.2 — Detailed Pages & Analytics
                      <span className="text-xs bg-sky-500/20 text-sky-300 px-2 py-0.5 rounded-full">Latest</span>
                    </h2>
                    <p className="text-sm text-slate-400 mt-2">Expanded analytics, detailed sub-pages for every major feature, keyboard shortcuts, and quality-of-life improvements.</p>
                  </div>
                  <div className="divide-y divide-slate-800/30">
                    <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                      <h3 className="font-semibold text-white mb-2 text-lg">Journal Analytics Dashboard</h3>
                      <p className="text-sm text-slate-400 leading-relaxed">The Journal tab now includes an Analytics sub-tab with your Equity Curve (cumulative P&L over time plotted as an SVG line chart), Win/Loss by Day of Week (horizontal bar charts showing your best and worst days), Win/Loss by Time of Day (performance by market hour), and Trade Duration Analytics (average hold time, distribution). Access these from the sub-tab navigation at the top of the Journal page.</p>
                    </div>
                    <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                      <h3 className="font-semibold text-white mb-2 text-lg">Detailed Monthly P&L</h3>
                      <p className="text-sm text-slate-400 leading-relaxed">The Monthly P&L now has its own dedicated sub-tab in the Journal with a full-size calendar, month navigation (previous/next), summary statistics including best/worst day, average daily P&L, and total trading days. Much more detailed than the dashboard widget overview.</p>
                    </div>
                    <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                      <h3 className="font-semibold text-white mb-2 text-lg">Screener Sub-Pages</h3>
                      <p className="text-sm text-slate-400 leading-relaxed">The Stock Screener tab now includes dedicated sub-pages for Pre-Market Movers (separate tables for top gainers, top losers, and highest volume stocks with detailed metrics) and Chart Pattern Scanner (expanded pattern cards with confidence meters and pattern descriptions). The dashboard widgets remain as quick overviews.</p>
                    </div>
                    <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                      <h3 className="font-semibold text-white mb-2 text-lg">Keyboard Shortcuts</h3>
                      <p className="text-sm text-slate-400 leading-relaxed">Press ? anywhere to see all available keyboard shortcuts. Navigation: D for Dashboard, J for Journal, Q for Quick Analysis. Actions: N for Quick Trade Entry, T to cycle themes, / to focus the search bar. Shortcuts are disabled when typing in input fields.</p>
                    </div>
                    <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                      <h3 className="font-semibold text-white mb-2 text-lg">Achievements & Badges</h3>
                      <p className="text-sm text-slate-400 leading-relaxed">A new widget that tracks your trading milestones. Earn badges for completing your first trade, achieving a 3-win streak, completing 10 trades, maintaining 60%+ win rate, trading 5+ different stocks, and setting 5+ stop losses. Each badge shows earned/locked status with progress tracking.</p>
                    </div>
                    <div className="px-6 py-5 hover:bg-slate-800/20 transition-colors">
                      <h3 className="font-semibold text-white mb-2 text-lg">Trade Emotion Logger</h3>
                      <p className="text-sm text-slate-400 leading-relaxed">A dashboard widget that lets you log your emotional state before entering a trade. Choose from 8 emotions: Fear, Greed, Anxiety, Confident, Uncertain, Revenge, Calm, and Focused. Over time, this data helps you identify patterns between your emotional state and trade outcomes.</p>
                    </div>
                  </div>
                </div>

                  {/* Bottom CTA */}
                  <div className="bg-gradient-to-r from-violet-600/20 to-indigo-600/20 border border-violet-500/30 rounded-2xl p-8 text-center">
                    <h3 className="text-2xl font-bold mb-3 text-white">Ready to Trade Smarter?</h3>
                    <p className="text-slate-300 mb-6 max-w-xl mx-auto">Create a free account to sync your data across devices and unlock the full MODUS experience. All features are available — no credit card required.</p>
                    <button
                      onClick={() => { setActiveTab('dashboard'); }}
                      className="px-8 py-3 bg-violet-600 hover:bg-violet-500 rounded-xl font-semibold transition-all shadow-lg shadow-violet-500/25 hover:shadow-violet-500/40"
                    >
                      Go to Dashboard
                    </button>
                  </div>
                </div>
              )}

              {/* TERMS OF SERVICE CONTENT */}
              {infoSubTab === 'terms' && (
                <div className="space-y-6 text-slate-300 leading-relaxed animate-fadeIn">
                  <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4 text-sm text-amber-200">
                    <strong>Last Updated:</strong> February 2026. By accessing or using MODUS, you agree to be bound by these Terms of Service.
                  </div>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">1. Acceptance of Terms</h2>
                    <p>By accessing and using the MODUS trading analysis platform ("Service"), you accept and agree to be bound by these Terms of Service ("Terms"). If you do not agree to these Terms, you must not access or use the Service.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">2. Description of Service</h2>
                    <p>MODUS is a web-based trading analysis and education platform that provides technical analysis tools, AI-powered chart analysis, stock screening, portfolio tracking, and related features. The Service is designed for educational and informational purposes only.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">3. Not Financial Advice</h2>
                    <p><strong className="text-red-400">IMPORTANT:</strong> MODUS does not provide financial, investment, trading, or tax advice. All analysis, recommendations, scores, trade setups, and AI-generated content are for educational and informational purposes only. You should not rely on any information provided by MODUS as a substitute for professional financial advice. Always consult with a qualified financial advisor before making investment decisions.</p>
                    <p className="mt-2">Past performance does not guarantee future results. Trading stocks, options, and other financial instruments involves substantial risk of loss.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">4. User Accounts</h2>
                    <p>To access certain features, you may be required to create an account. You agree to provide accurate, current, and complete information during registration. You are responsible for safeguarding your account credentials and for all activities under your account.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">5. Acceptable Use</h2>
                    <p>You agree not to: (a) use the Service for any unlawful purpose; (b) attempt to gain unauthorized access; (c) interfere with or disrupt the Service; (d) use automated means to access the Service without permission; (e) redistribute or commercially exploit any content or data; (f) use the Service to manipulate markets or engage in market abuse.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">6. Market Data</h2>
                    <p>Market data is sourced from third-party providers including Yahoo Finance and other public APIs. We do not guarantee the accuracy, completeness, or timeliness of any market data. Data may be delayed. Do not rely solely on MODUS data for time-sensitive trading decisions.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">7. AI-Generated Content</h2>
                    <p>MODUS uses artificial intelligence models to generate analyses and content. AI-generated content may contain errors, inaccuracies, or biases. AI recommendations should be used as one of many inputs in your decision-making process, not as the sole basis for any trade.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">8. Limitation of Liability</h2>
                    <p>To the maximum extent permitted by law, MODUS and its creators shall not be liable for any indirect, incidental, special, consequential, or punitive damages, or any loss of profits or revenues resulting from your use of the Service or any trading decisions made based on information provided.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">9. Subscription & Payments</h2>
                    <p>Certain features may require a paid subscription. Subscription fees are billed in advance on a monthly or annual basis. You may cancel at any time. Refunds are handled on a case-by-case basis. We reserve the right to change pricing with 30 days' notice.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">10. Intellectual Property</h2>
                    <p>All content, features, and functionality are owned by MODUS and protected by copyright, trademark, and other intellectual property laws. You may not copy, modify, distribute, sell, or lease any part of the Service without prior written consent.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">11. Termination</h2>
                    <p>We may terminate or suspend your account at our sole discretion, without prior notice, for conduct that violates these Terms or is harmful to other users, us, or third parties.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">12. Changes to Terms</h2>
                    <p>We reserve the right to modify these Terms at any time. We will provide notice of material changes through the Service. Continued use after changes constitutes acceptance.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">13. Contact</h2>
                    <p>If you have any questions about these Terms, please contact us through the Feedback button in the application.</p>
                  </section>
                </div>
              )}

              {/* PRIVACY POLICY CONTENT */}
              {infoSubTab === 'privacy' && (
                <div className="space-y-6 text-slate-300 leading-relaxed animate-fadeIn">
                  <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 text-sm text-blue-200">
                    <strong>Last Updated:</strong> February 2026. This Privacy Policy describes how MODUS collects, uses, and protects your information.
                  </div>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">1. Information We Collect</h2>
                    <p><strong className="text-white">Account Information:</strong> Email address, display name, and authentication credentials (handled through Firebase/Google OAuth).</p>
                    <p className="mt-2"><strong className="text-white">Usage Data:</strong> Which features you use, stocks you analyze, and general interaction patterns. This data is anonymized.</p>
                    <p className="mt-2"><strong className="text-white">Trading Data:</strong> Watchlists, trade journal entries, portfolio positions, alerts, and analysis history are stored to provide the Service.</p>
                    <p className="mt-2"><strong className="text-white">Device Information:</strong> Browser type, operating system, and screen resolution for optimization.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">2. How We Use Your Information</h2>
                    <p>We use collected information to: (a) provide and maintain the Service; (b) sync your data across devices; (c) send price alert notifications you've configured; (d) improve and personalize the Service; (e) communicate about updates; (f) generate anonymized analytics.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">3. Data Storage & Security</h2>
                    <p>Your data is stored using Firebase (Google Cloud) with enterprise-grade encryption at rest and in transit. Local data is stored in your browser's localStorage and is not transmitted to our servers.</p>
                    <p className="mt-2">API keys you enter are stored only in your browser's sessionStorage and are never transmitted to our servers — they go directly to the respective API providers.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">4. Third-Party Services</h2>
                    <p><strong className="text-white">Firebase (Google):</strong> Authentication and cloud data storage.</p>
                    <p className="mt-1"><strong className="text-white">Yahoo Finance:</strong> Market data and stock prices (fetched client-side).</p>
                    <p className="mt-1"><strong className="text-white">AI Providers (Anthropic/OpenAI):</strong> Chart analysis — images sent directly from your browser.</p>
                    <p className="mt-1"><strong className="text-white">EmailJS:</strong> Optional SMS alert delivery.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">5. Data Sharing</h2>
                    <p>We do not sell, trade, or rent your personal information. We may share anonymized aggregate data for analytics. We may disclose your information if required by law.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">6. Your Rights</h2>
                    <p>You have the right to: access your personal data, correct inaccurate data, delete your account, export your data, and opt out of non-essential data collection.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">7. Cookies & Local Storage</h2>
                    <p>MODUS uses browser localStorage to store preferences and cached data locally. We do not use third-party tracking cookies. Firebase may use essential cookies for authentication.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">8. Children's Privacy</h2>
                    <p>MODUS is not intended for individuals under 18. We do not knowingly collect personal information from children.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-6 mb-3">9. Changes to This Policy</h2>
                    <p>We may update this Privacy Policy from time to time. Continued use after changes constitutes acceptance.</p>
                  </section>
                </div>
              )}
            </div>
          </div>
        )}

      </main>

      {/* MOBILE BOTTOM NAVIGATION */}
      {isMobile && (
        <nav className="fixed bottom-0 left-0 right-0 z-50 bg-slate-950/95 backdrop-blur-xl border-t border-slate-800/50 pt-2 pb-safe" style={{ paddingBottom: 'max(0.5rem, env(safe-area-inset-bottom))' }}>
          <div className="flex items-center justify-around h-16 px-2">
            {/* Dashboard Tab */}
            <button
              onClick={() => setActiveTab("dashboard")}
              className="flex flex-col items-center gap-1 py-1 transition-colors duration-200"
              title="Dashboard"
            >
              <div className="relative">
                {activeTab === "dashboard" && <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 bg-violet-400 rounded-full" />}
                <PieChart className={`w-5 h-5 ${activeTab === "dashboard" ? 'text-violet-400' : 'text-slate-500'}`} />
              </div>
              <span className={`text-7px font-medium ${activeTab === "dashboard" ? 'text-violet-400' : 'text-slate-500'}`}>Dashboard</span>
            </button>

            {/* Ticker Tab */}
            <button
              onClick={() => setActiveTab("ticker")}
              className="flex flex-col items-center gap-1 py-1 transition-colors duration-200"
              title="Ticker"
            >
              <div className="relative">
                {activeTab === "ticker" && <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 bg-violet-400 rounded-full" />}
                <LineChart className={`w-5 h-5 ${activeTab === "ticker" ? 'text-violet-400' : 'text-slate-500'}`} />
              </div>
              <span className={`text-7px font-medium ${activeTab === "ticker" ? 'text-violet-400' : 'text-slate-500'}`}>Ticker</span>
            </button>

            {/* Analysis Tab */}
            <button
              onClick={() => setActiveTab("analyze")}
              className="flex flex-col items-center gap-1 py-1 transition-colors duration-200"
              title="Analysis"
            >
              <div className="relative">
                {activeTab === "analyze" && <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 bg-violet-400 rounded-full" />}
                <BarChart3 className={`w-5 h-5 ${activeTab === "analyze" ? 'text-violet-400' : 'text-slate-500'}`} />
              </div>
              <span className={`text-7px font-medium ${activeTab === "analyze" ? 'text-violet-400' : 'text-slate-500'}`}>Analysis</span>
            </button>

            {/* Daily Pick Tab */}
            <button
              onClick={() => setActiveTab("daily")}
              className="flex flex-col items-center gap-1 py-1 transition-colors duration-200"
              title="Daily Pick"
            >
              <div className="relative">
                {activeTab === "daily" && <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 bg-violet-400 rounded-full" />}
                <Star className={`w-5 h-5 ${activeTab === "daily" ? 'text-violet-400' : 'text-slate-500'}`} />
              </div>
              <span className={`text-7px font-medium ${activeTab === "daily" ? 'text-violet-400' : 'text-slate-500'}`}>Daily</span>
            </button>

            {/* Alerts Tab */}
            <button
              onClick={() => setActiveTab("alerts")}
              className="flex flex-col items-center gap-1 py-1 transition-colors duration-200"
              title="Alerts"
            >
              <div className="relative">
                {activeTab === "alerts" && <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 bg-violet-400 rounded-full" />}
                <Bell className={`w-5 h-5 ${activeTab === "alerts" ? 'text-violet-400' : 'text-slate-500'}`} />
              </div>
              <span className={`text-7px font-medium ${activeTab === "alerts" ? 'text-violet-400' : 'text-slate-500'}`}>Alerts</span>
            </button>

            {/* Journal Tab */}
            <button
              onClick={() => setActiveTab("journal")}
              className="flex flex-col items-center gap-1 py-1 transition-colors duration-200"
              title="Journal"
            >
              <div className="relative">
                {activeTab === "journal" && <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 bg-violet-400 rounded-full" />}
                <Target className={`w-5 h-5 ${activeTab === "journal" ? 'text-violet-400' : 'text-slate-500'}`} />
              </div>
              <span className={`text-7px font-medium ${activeTab === "journal" ? 'text-violet-400' : 'text-slate-500'}`}>Journal</span>
            </button>

            {/* More Menu Button */}
            <button
              onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
              className="flex flex-col items-center gap-1 py-1 transition-colors duration-200"
              title="More Options"
            >
              <div className="relative">
                {mobileMenuOpen && <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 bg-violet-400 rounded-full" />}
                <Menu className={`w-5 h-5 ${mobileMenuOpen ? 'text-violet-400' : 'text-slate-500'}`} />
              </div>
              <span className={`text-7px font-medium ${mobileMenuOpen ? 'text-violet-400' : 'text-slate-500'}`}>More</span>
            </button>
          </div>
        </nav>
      )}

      {/* SITE FOOTER */}
      {!isMobile && (
      <footer className={`border-t border-slate-800/30 py-3 px-4 md:px-8 transition-all duration-300 ${
        sidebarCollapsed ? 'ml-16' : 'ml-64'
      }`} style={{ background: 'rgba(10, 15, 30, 0.6)' }}>
        <div className="flex flex-col sm:flex-row items-center justify-between gap-2 text-xs text-slate-500">
          <div className="flex items-center gap-1.5">
            <span className="font-semibold text-slate-400">MODUS</span>
            <span>© 2026 All rights reserved</span>
          </div>
          <div className="flex items-center gap-4">
            <button onClick={() => setShowInfoPage('features')} className="hover:text-violet-400 transition-colors">Features</button>
            <button onClick={() => setShowInfoPage('terms')} className="hover:text-violet-400 transition-colors">Terms of Service</button>
            <button onClick={() => setShowInfoPage('privacy')} className="hover:text-violet-400 transition-colors">Privacy Policy</button>
            <span className="text-slate-700">|</span>
            <span>Not financial advice. For educational purposes only.</span>
          </div>
        </div>
      </footer>
      )}

      {/* INFO PAGES */}
      {showInfoPage && (
        <div className="fixed inset-0 bg-slate-950/98 backdrop-blur-sm z-[70] overflow-y-auto">
          <div className="max-w-4xl mx-auto px-4 md:px-8 py-8 md:py-12">
            {/* Header with close */}
            <div className="flex items-center justify-between mb-8 sticky top-0 bg-slate-950/90 backdrop-blur-md py-4 -mx-4 px-4 z-10">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-violet-500/20 rounded-lg">
                  {showInfoPage === 'features' ? <Zap className="w-5 h-5 text-violet-400" /> :
                   showInfoPage === 'terms' ? <Shield className="w-5 h-5 text-violet-400" /> :
                   <Lock className="w-5 h-5 text-violet-400" />}
                </div>
                <h1 className="text-2xl md:text-3xl font-bold">
                  {showInfoPage === 'features' ? 'Platform Features' :
                   showInfoPage === 'terms' ? 'Terms of Service' :
                   'Privacy Policy'}
                </h1>
              </div>
              <button onClick={() => setShowInfoPage(null)} className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                <X className="w-6 h-6 text-slate-400" />
              </button>
            </div>

            {/* FEATURES PAGE */}
            {showInfoPage === 'features' && (
              <div className="space-y-8">
                <p className="text-lg text-slate-300 leading-relaxed">MODUS is a comprehensive trading analysis platform with 35+ tools designed for traders at every level. Here's everything included:</p>

                {[
                  {
                    category: 'Analysis & AI',
                    icon: '🧠',
                    color: 'violet',
                    features: [
                      { name: 'AI Chart Analysis', desc: 'Upload any stock chart and get instant technical analysis powered by Claude AI and GPT-4 Vision. Identifies patterns, support/resistance levels, and generates trade setups with entry, stop loss, and target prices.' },
                      { name: 'Multi-Timeframe Analysis', desc: 'Analyze the same stock across multiple timeframes simultaneously (1m, 5m, 15m, 1h, 4h, Daily) to confirm trend alignment and find high-probability entries.' },
                      { name: 'Ask AI Trading Assistant', desc: 'Natural language trading assistant that can answer any trading question, explain strategies, analyze market conditions, and help you understand technical indicators.' },
                      { name: 'Daily AI Pick', desc: 'Every day, the AI scans the market and delivers a top trade recommendation with full analysis, confidence score, entry/exit levels, and risk/reward ratio.' },
                      { name: 'Quick Analysis', desc: 'Enter any stock ticker and get an instant AI-powered buy/sell/hold verdict with confidence score, price targets, stop loss, support/resistance levels, risk:reward ratio, technical indicators (RSI, SMA, MACD, volume), bullish/bearish factors, and a detailed "Tell Me More" structured breakdown with 5 sections (Technical Analysis, Entry/Exit Strategy, Risk Assessment, Sector Context, Scenario Analysis). Uses live Yahoo Finance data with 8-proxy fallback for real-time accuracy.' }
                    ]
                  },
                  {
                    category: 'Market Data & Scanning',
                    icon: '📊',
                    color: 'blue',
                    features: [
                      { name: 'Live Stock Ticker', desc: 'Real-time stock data with candlestick charts, volume analysis, RSI, MACD, and Bollinger Bands. Supports any US stock symbol with automatic multi-API fallback.' },
                      { name: 'Stock Screener', desc: 'Scan 220+ stocks with 8 preset strategies (RSI Oversold, Volume Breakout, Bullish Momentum, Golden Cross, and more) or create custom filters by price, volume, and RSI range.' },
                      { name: 'Market Scanner', desc: 'Real-time market overview showing top gainers, losers, and volume leaders. Identifies the most active and volatile stocks of the day.' },
                      { name: 'Market Overview', desc: 'Dashboard showing major indices (SPY, QQQ, DIA, IWM), VIX, and all 11 S&P sectors with live performance data. Indices are clickable to open live charts.' },
                      { name: 'News & Sentiment Feed', desc: 'Aggregated financial news with sentiment analysis. Filter by bullish, bearish, or your watchlist stocks.' },
                      { name: 'Top Movers Ticker', desc: 'Live scrolling bar on the dashboard showing the top 5 gainers and top 3 losers from the market scanner. Click any symbol to instantly open its live chart.' }
                    ]
                  },
                  {
                    category: 'Portfolio & Trading',
                    icon: '💰',
                    color: 'emerald',
                    features: [
                      { name: 'Portfolio Tracker', desc: 'Track your real positions with live price updates, P&L calculations, and weighted average cost basis. Automatically combines positions when you add to existing holdings.' },
                      { name: 'Live Portfolio', desc: 'Real-time portfolio tracking with 5-second auto-refresh, daily change monitoring, and total P&L across all positions.' },
                      { name: 'Paper Trading', desc: 'Practice trading with $100K virtual balance. Execute simulated trades, track performance, and build confidence without risking real money.' },
                      { name: 'Position Size Calculator', desc: 'Calculate optimal position sizes based on your account size, risk tolerance (%), entry price, and stop loss. Ensures proper risk management on every trade.' },
                      { name: 'Options Profit Calculator', desc: 'Visualize potential outcomes for calls, puts, spreads, and straddles with interactive payoff diagrams.' }
                    ]
                  },
                  {
                    category: 'Journaling & Performance',
                    icon: '📝',
                    color: 'amber',
                    features: [
                      { name: 'Trading Journal', desc: 'Log every trade with entry/exit prices, quantity, side (long/short), stop loss, target, confidence level, and notes. Link trades to AI analyses for complete records.' },
                      { name: 'Performance Dashboard', desc: 'Visualize your trading performance with win rate, average P&L, profit factor, and equity curve. Compare your results over time.' },
                      { name: 'Trade Planner', desc: 'Plan trades with detailed risk/reward calculations before entering. Calculate recommended shares, expected profit, max loss, and risk per share.' },
                      { name: 'Backtesting', desc: 'Test your analysis accuracy against historical outcomes. Track win rates across all your past analyses.' },
                      { name: 'Alert Performance', desc: 'Track how your price alerts perform after triggering. See which alerts led to profitable opportunities.' },
                      { name: 'Trading Streak', desc: 'Dashboard widget tracking your consecutive journal entries. Build streaks and stay accountable with emoji milestones at 3, 7, 14, and 30+ day streaks.' },
                      { name: 'Market Mood (Fear & Greed)', desc: 'Dashboard widget estimating market sentiment on a 0-100 scale using VIX, SPY performance, and scanner breadth. Shows Extreme Fear, Fear, Neutral, Greed, or Extreme Greed with a color-coded bar.' }
                    ]
                  },
                  {
                    category: 'Alerts & Monitoring',
                    icon: '🔔',
                    color: 'red',
                    features: [
                      { name: 'Price Alerts', desc: 'Set alerts for any stock with conditions (above, below, crosses). Get notified via browser notifications, sound alerts, SMS (via EmailJS), and optional Discord webhook.' },
                      { name: 'Watchlist', desc: 'Monitor your favorite stocks with real-time prices updating every 10 seconds. See change percentage, and quickly navigate to any stock for deeper analysis.' },
                      { name: 'Notification Center', desc: 'Centralized notification history showing all triggered alerts with timestamps. Manage notification preferences for sound, browser, and push alerts.' },
                      { name: 'Economic Calendar', desc: 'Track upcoming economic events (FOMC, CPI, NFP, earnings) that could impact your trades. Plan around market-moving events.' }
                    ]
                  },
                  {
                    category: 'Tools & Export',
                    icon: '🛠️',
                    color: 'slate',
                    features: [
                      { name: 'PDF Reports', desc: 'Export comprehensive analysis reports as professional PDFs including score, recommendation, pattern analysis, trade setup, and technical indicators.' },
                      { name: 'Social Sharing', desc: 'Share your analyses on Twitter/X, Reddit, or copy to clipboard. Formatted summaries with score, recommendation, and key metrics.' },
                      { name: 'Trade Ideas Generator', desc: 'AI-generated trade ideas with full setups including entry, stop loss, targets, and reasoning. Scan for opportunities you might have missed.' },
                      { name: 'Cloud Sync', desc: 'Sign in with Google or email to sync your data across devices. Watchlists, trades, alerts, and settings stored securely in Firebase.' },
                      { name: 'CSV Export', desc: 'Export your trade journal and portfolio data as CSV files for use in Excel, Google Sheets, or other analysis tools.' },
                      { name: 'Keyboard Shortcuts', desc: 'Power-user shortcuts for fast navigation: press "/" on the dashboard to focus Quick Analyze, "q" to jump to Quick Analysis, number keys to switch tabs, Ctrl+Enter to capture charts, Ctrl+E for PDF export, Ctrl+B to toggle sidebar, and more. Press "?" to see all shortcuts.' },
                      { name: 'Vocabulary / Glossary', desc: 'Comprehensive glossary of 60+ trading terms organized by category (Order Types, Technical Analysis, Risk Management, Market Fundamentals, Trading Styles). Each term includes a detailed, beginner-friendly definition with real examples.' },
                      { name: 'Daily Trading Tip', desc: 'A fresh trading tip every day on the dashboard, rotating through 30 tips across 5 categories: Risk Management, Psychology, Technical Analysis, Strategy, and Fundamentals. Click "Random tip" for a bonus one.' },
                      { name: 'Guided Setup Wizard', desc: 'First-time setup wizard that walks you through a 3-step onboarding: welcome overview, building your initial watchlist, and next steps. Available any time from Settings.' }
                    ]
                  }
                ].map((section, idx) => (
                  <div key={idx} className="bg-slate-900/50 rounded-xl border border-slate-800/50 overflow-hidden">
                    <div className={`px-6 py-4 border-b border-slate-800/50 bg-${section.color}-500/5`}>
                      <h2 className="text-xl font-bold flex items-center gap-3">
                        <span className="text-2xl">{section.icon}</span>
                        {section.category}
                        <span className="text-xs bg-slate-800 text-slate-400 px-2 py-0.5 rounded-full">{section.features.length} tools</span>
                      </h2>
                    </div>
                    <div className="divide-y divide-slate-800/30">
                      {section.features.map((feature, fIdx) => (
                        <div key={fIdx} className="px-6 py-4 hover:bg-slate-800/20 transition-colors">
                          <h3 className="font-semibold text-white mb-1">{feature.name}</h3>
                          <p className="text-sm text-slate-400 leading-relaxed">{feature.desc}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}

                <div className="bg-violet-500/10 border border-violet-500/30 rounded-xl p-6 text-center">
                  <h3 className="text-xl font-bold mb-2">Ready to Start Trading Smarter?</h3>
                  <p className="text-slate-400 mb-4">Sign up to sync your data across devices and unlock the full potential of MODUS.</p>
                  <button onClick={() => { setShowInfoPage(null); setShowAuthModal(true); setAuthMode('signup'); }} className="px-8 py-3 bg-violet-600 hover:bg-violet-500 rounded-xl font-semibold transition-all">
                    Get Started Free
                  </button>
                </div>
              </div>
            )}

            {/* TERMS OF SERVICE */}
            {showInfoPage === 'terms' && (
              <div className="prose prose-invert prose-slate max-w-none">
                <div className="space-y-6 text-slate-300 leading-relaxed">
                  <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4 text-sm text-amber-200">
                    <strong>Last Updated:</strong> February 2026. By accessing or using MODUS, you agree to be bound by these Terms of Service.
                  </div>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">1. Acceptance of Terms</h2>
                    <p>By accessing and using the MODUS trading analysis platform ("Service"), you accept and agree to be bound by these Terms of Service ("Terms"). If you do not agree to these Terms, you must not access or use the Service. These Terms apply to all visitors, users, and others who access the Service.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">2. Description of Service</h2>
                    <p>MODUS is a web-based trading analysis and education platform that provides technical analysis tools, AI-powered chart analysis, stock screening, portfolio tracking, and related features. The Service is designed for educational and informational purposes only.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">3. Not Financial Advice</h2>
                    <p><strong className="text-red-400">IMPORTANT:</strong> MODUS does not provide financial, investment, trading, or tax advice. All analysis, recommendations, scores, trade setups, and AI-generated content provided through the Service are for educational and informational purposes only. You should not rely on any information provided by MODUS as a substitute for professional financial advice. Always consult with a qualified financial advisor before making investment decisions.</p>
                    <p className="mt-2">Past performance of any analysis or recommendation does not guarantee future results. Trading stocks, options, and other financial instruments involves substantial risk of loss and is not suitable for all investors.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">4. User Accounts</h2>
                    <p>To access certain features of the Service, you may be required to create an account. You agree to provide accurate, current, and complete information during registration and to update such information as necessary. You are responsible for safeguarding your account credentials and for all activities that occur under your account.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">5. Acceptable Use</h2>
                    <p>You agree not to: (a) use the Service for any unlawful purpose; (b) attempt to gain unauthorized access to any portion of the Service; (c) interfere with or disrupt the Service; (d) use automated means to access the Service without our permission; (e) redistribute, resell, or commercially exploit any content or data from the Service; (f) use the Service to manipulate markets or engage in any form of market abuse.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">6. Market Data</h2>
                    <p>Market data displayed on MODUS is sourced from third-party providers including Yahoo Finance and other public APIs. While we strive for accuracy, we do not guarantee the accuracy, completeness, or timeliness of any market data. Data may be delayed, and real-time prices are provided on a best-effort basis. Do not rely solely on MODUS data for time-sensitive trading decisions.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">7. AI-Generated Content</h2>
                    <p>MODUS uses artificial intelligence models to generate chart analyses, trade recommendations, and other content. AI-generated content may contain errors, inaccuracies, or biases. The AI does not have real-time market awareness and bases its analysis on the data provided to it. AI recommendations should be used as one of many inputs in your decision-making process, not as the sole basis for any trade.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">8. Limitation of Liability</h2>
                    <p>To the maximum extent permitted by law, MODUS and its creators shall not be liable for any indirect, incidental, special, consequential, or punitive damages, or any loss of profits or revenues, whether incurred directly or indirectly, or any loss of data, use, goodwill, or other intangible losses resulting from: (a) your use or inability to use the Service; (b) any trading decisions made based on information provided by the Service; (c) unauthorized access to your account; (d) errors or inaccuracies in content or data.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">9. Subscription & Payments</h2>
                    <p>Certain features of MODUS may require a paid subscription. Subscription fees are billed in advance on a monthly or annual basis. You may cancel your subscription at any time. Refunds are handled on a case-by-case basis. We reserve the right to change subscription pricing with 30 days' notice to existing subscribers.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">10. Intellectual Property</h2>
                    <p>All content, features, and functionality of the Service are owned by MODUS and are protected by copyright, trademark, and other intellectual property laws. You may not copy, modify, distribute, sell, or lease any part of the Service without our prior written consent.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">11. Termination</h2>
                    <p>We may terminate or suspend your account and access to the Service at our sole discretion, without prior notice, for conduct that we believe violates these Terms or is harmful to other users, us, or third parties. Upon termination, your right to use the Service will immediately cease.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">12. Changes to Terms</h2>
                    <p>We reserve the right to modify these Terms at any time. We will provide notice of material changes through the Service. Your continued use of the Service after such changes constitutes acceptance of the new Terms.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">13. Contact</h2>
                    <p>If you have any questions about these Terms, please contact us through the Feedback button in the application or email us at the address provided in the application.</p>
                  </section>
                </div>
              </div>
            )}

            {/* PRIVACY POLICY */}
            {showInfoPage === 'privacy' && (
              <div className="prose prose-invert prose-slate max-w-none">
                <div className="space-y-6 text-slate-300 leading-relaxed">
                  <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 text-sm text-blue-200">
                    <strong>Last Updated:</strong> February 2026. This Privacy Policy describes how MODUS collects, uses, and protects your information.
                  </div>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">1. Information We Collect</h2>
                    <p><strong className="text-white">Account Information:</strong> When you create an account, we collect your email address, display name, and authentication credentials (handled securely through Firebase Authentication/Google OAuth).</p>
                    <p className="mt-2"><strong className="text-white">Usage Data:</strong> We collect information about how you use the Service, including which features you use, stocks you analyze, and general interaction patterns. This data is anonymized and used to improve the Service.</p>
                    <p className="mt-2"><strong className="text-white">Trading Data:</strong> Your watchlists, trade journal entries, portfolio positions, alerts, and analysis history are stored to provide the Service functionality. This data is associated with your account.</p>
                    <p className="mt-2"><strong className="text-white">Device Information:</strong> We may collect browser type, operating system, and screen resolution for optimization purposes.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">2. How We Use Your Information</h2>
                    <p>We use collected information to: (a) provide and maintain the Service; (b) sync your data across devices via cloud storage; (c) send price alert notifications you've configured; (d) improve and personalize the Service; (e) communicate with you about updates or issues; (f) generate anonymized analytics about Service usage.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">3. Data Storage & Security</h2>
                    <p>Your data is stored using Firebase (Google Cloud) infrastructure, which provides enterprise-grade security including encryption at rest and in transit. Local data (settings, preferences) is stored in your browser's localStorage and is not transmitted to our servers.</p>
                    <p className="mt-2">API keys you enter (Finnhub, OpenAI, Anthropic) are stored only in your browser's sessionStorage and are never transmitted to our servers. They are sent directly from your browser to the respective API providers.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">4. Third-Party Services</h2>
                    <p>MODUS integrates with the following third-party services:</p>
                    <p className="mt-2"><strong className="text-white">Firebase (Google):</strong> Authentication and cloud data storage. Subject to Google's Privacy Policy.</p>
                    <p className="mt-1"><strong className="text-white">Yahoo Finance:</strong> Market data and stock prices. Data is fetched client-side.</p>
                    <p className="mt-1"><strong className="text-white">AI Providers (Anthropic/OpenAI):</strong> Chart analysis and AI features. Chart images are sent directly from your browser to the AI provider for analysis.</p>
                    <p className="mt-1"><strong className="text-white">EmailJS:</strong> Optional SMS alert delivery. Your phone number is used only for delivering alerts you configure.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">5. Data Sharing</h2>
                    <p>We do not sell, trade, or rent your personal information to third parties. We may share anonymized, aggregate data for analytics purposes. We may disclose your information if required by law or to protect our rights.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">6. Your Rights</h2>
                    <p>You have the right to: (a) access your personal data; (b) correct inaccurate data; (c) delete your account and associated data; (d) export your data; (e) opt out of non-essential data collection. To exercise these rights, contact us through the Feedback form or delete your account through the Settings menu.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">7. Cookies & Local Storage</h2>
                    <p>MODUS uses browser localStorage to store your preferences, settings, and cached data locally on your device. We do not use third-party tracking cookies. Firebase may use essential cookies for authentication purposes.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">8. Children's Privacy</h2>
                    <p>MODUS is not intended for use by individuals under the age of 18. We do not knowingly collect personal information from children. If you believe a child has provided us with personal information, please contact us immediately.</p>
                  </section>

                  <section>
                    <h2 className="text-xl font-bold text-white mt-8 mb-3">9. Changes to This Policy</h2>
                    <p>We may update this Privacy Policy from time to time. We will notify you of any material changes through the Service. Your continued use of the Service after changes constitutes acceptance of the updated policy.</p>
                  </section>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Watchlist Sidebar - Premium Floating Panel — synced groups */}
      {watchlistVisible && (() => {
        const floatGroupNames = Object.keys(watchlistGroups);
        const floatFilteredWL = activeWatchlistGroup === 'All' ? watchlist : (watchlistGroups[activeWatchlistGroup] || []).filter(s => watchlist.includes(s));
        return (
        <div className="fixed right-4 bottom-4 bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-700/50 rounded-2xl p-4 w-72 max-h-[28rem] overflow-hidden shadow-2xl z-40 animate-slideUp">
          <div className="flex items-center justify-between mb-3 pb-2 border-b border-slate-700/50">
            <h3 className="text-sm font-bold flex items-center gap-2 text-slate-200">
              <div className="p-1.5 bg-violet-500/20 rounded-lg">
                <List className="w-4 h-4 text-violet-400" />
              </div>
              Watchlist
              <span className="text-[10px] bg-violet-500/20 text-violet-300 px-2 py-0.5 rounded-full font-medium">
                {floatFilteredWL.length}
              </span>
            </h3>
            <div className="flex items-center gap-1">
              {tickerSymbol && (
                <button
                  onClick={() => addToWatchlist(tickerSymbol)}
                  className="text-xs text-violet-300 hover:text-white transition-all px-2.5 py-1.5 bg-violet-600/30 hover:bg-violet-600 rounded-lg font-medium"
                  title="Add current symbol"
                >
                  + Add
                </button>
              )}
              <button
                onClick={() => setWatchlistVisible(false)}
                className="text-slate-500 hover:text-white transition-colors p-1.5 hover:bg-slate-800 rounded-lg"
                title="Hide watchlist"
              >
                <X className="w-4 h-4" />
              </button>
            </div>
          </div>

          {/* Group Tabs — synced with dashboard + page */}
          <div className="flex items-center gap-1 mb-3 flex-wrap">
            {floatGroupNames.map(g => (
              <button key={g} onClick={() => setActiveWatchlistGroup(g)}
                className={`text-[9px] px-2 py-0.5 rounded-full transition-all ${activeWatchlistGroup === g ? 'bg-violet-600 text-white' : 'bg-slate-700/30 text-slate-500 hover:text-white'}`}>
                {g}
              </button>
            ))}
            <button onClick={() => { const name = prompt('New group name:'); if (name && name.trim()) setWatchlistGroups(prev => ({...prev, [name.trim()]: []})); }}
              className="text-[9px] text-violet-400 hover:text-violet-300 px-1">+</button>
          </div>

          {floatFilteredWL.length === 0 ? (
            <div className="text-center py-6">
              <div className="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-3">
                <Star className="w-6 h-6 text-slate-600" />
              </div>
              <p className="text-xs text-slate-500">{activeWatchlistGroup === 'All' ? 'No symbols in watchlist' : `No stocks in ${activeWatchlistGroup}`}</p>
              <p className="text-[10px] text-slate-600 mt-1">Add symbols to track them</p>
            </div>
          ) : (
            <div className="space-y-1.5 max-h-56 overflow-y-auto pr-1">
              {floatFilteredWL.map((symbol, i) => {
                const price = watchlistPrices[symbol];
                const changePercent = price?.changePercent || 0;
                const isPositive = changePercent >= 0;

                return (
                  <div
                    key={symbol}
                    draggable
                    onDragStart={(e) => { setDraggedWatchlistItem(i); e.dataTransfer.effectAllowed = 'move'; }}
                    onDragOver={(e) => { e.preventDefault(); setDragOverWatchlistItem(i); }}
                    onDragEnd={() => { setDraggedWatchlistItem(null); setDragOverWatchlistItem(null); }}
                    onDrop={(e) => { e.preventDefault(); if (draggedWatchlistItem !== null && draggedWatchlistItem !== i) reorderWatchlist(draggedWatchlistItem, i); }}
                    className={`flex items-center justify-between group bg-slate-800/30 hover:bg-slate-800/70 px-3 py-2.5 rounded-xl transition-all duration-200 cursor-move border border-slate-700/30 hover:border-slate-600/60 ${dragOverWatchlistItem === i ? 'border-t-2 border-t-violet-500' : ''} ${draggedWatchlistItem === i ? 'opacity-50' : ''}`}
                    onClick={() => loadWatchlistSymbol(symbol)}
                  >
                    <div className="text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity mr-2 flex items-center justify-center w-4 h-4 text-xs font-bold">
                      ⋮⋮
                    </div>
                    <div className="flex-1">
                      <div className="text-sm text-white font-semibold">{symbol}</div>
                      {price?.price > 0 && (
                        <div className={`text-[10px] tabular-nums font-medium ${
                          isPositive ? 'text-emerald-400' : 'text-red-400'
                        }`}>${price.price.toFixed(2)}</div>
                      )}
                    </div>
                    {price?.price > 0 && (
                      <div className={`text-xs font-semibold px-2.5 py-1.5 rounded-full ${
                        isPositive ? 'bg-emerald-500/25 text-emerald-300' : 'bg-red-500/25 text-red-300'
                      }`}>
                        {isPositive ? '+' : ''}{changePercent.toFixed(2)}%
                      </div>
                    )}
                    <div className="flex items-center gap-0.5 ml-1">
                      {/* Quick group assign */}
                      <select
                        onClick={(e) => e.stopPropagation()}
                        onChange={(e) => { e.stopPropagation(); if (e.target.value) addToWatchlistGroup(symbol, e.target.value); e.target.value = ''; }}
                        className="text-[8px] bg-transparent border-none text-slate-500 w-4 h-4 appearance-none cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity"
                        defaultValue=""
                        title="Add to group"
                      >
                        <option value="">+</option>
                        {floatGroupNames.filter(g => g !== 'All').map(g => <option key={g} value={g}>{g}</option>)}
                      </select>
                      {activeWatchlistGroup !== 'All' && (
                        <button
                          onClick={(e) => { e.stopPropagation(); removeFromWatchlistGroup(symbol, activeWatchlistGroup); }}
                          className="text-orange-400 opacity-0 group-hover:opacity-100 transition-opacity p-0.5 hover:bg-orange-500/20 rounded"
                          title={`Remove from ${activeWatchlistGroup}`}
                        >
                          <X className="w-3 h-3" />
                        </button>
                      )}
                      <button
                        onClick={(e) => { e.stopPropagation(); removeFromWatchlist(symbol); }}
                        className="text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-0.5 hover:bg-red-500/20 rounded"
                        title="Remove from watchlist"
                      >
                        <X className="w-3 h-3" />
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
        );
      })()}
      
      {/* Watchlist Toggle Button (when hidden) - Premium Floating Button */}
      {!watchlistVisible && (
        <button
          onClick={() => setWatchlistVisible(true)}
          className="fixed right-4 bottom-4 bg-slate-800/60 hover:bg-slate-700/80 text-white px-6 py-2.5 rounded-full shadow-lg shadow-black/40 z-40 flex items-center gap-2.5 transition-all duration-200 hover:shadow-lg hover:shadow-violet-500/20 border border-slate-700/50 hover:border-slate-600/80 backdrop-blur-sm btn-press"
          title="Show watchlist"
        >
          <List className="w-4 h-4" />
          <span className="text-sm font-semibold">Watchlist</span>
          {watchlist.length > 0 && (
            <span className="bg-violet-500/40 px-2 py-0.5 rounded-full text-xs font-bold text-violet-200">{watchlist.length}</span>
          )}
        </button>
      )}

      {/* History Modal */}
      {showHistory && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-slate-900 border border-slate-700 rounded-lg p-6 max-w-6xl w-full max-h-[85vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold flex items-center gap-2">
                <Calendar className="w-6 h-6 text-violet-400" />
                Analysis History ({analysisHistory.length})
              </h2>
              <button 
                onClick={() => setShowHistory(false)}
                className="p-2 hover:bg-slate-800 rounded-lg transition-colors"
              >
                <X className="w-6 h-6" />
              </button>
            </div>
            
            {analysisHistory.length === 0 ? (
              <div className="text-center py-12">
                <Calendar className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                <p className="text-slate-400">No analyses saved yet</p>
                <p className="text-sm text-slate-500 mt-2">Analyze a chart to start building your history</p>
              </div>
            ) : (
              <>
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={clearHistory}
                    className="text-sm text-red-400 hover:text-red-300 px-3 py-1 bg-red-900/20 rounded"
                  >
                    Clear All History
                  </button>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {analysisHistory.map(entry => (
                    <div key={entry.id} className="bg-slate-800 rounded-lg p-4 flex gap-4 hover:bg-slate-750 transition-colors">
                      <img 
                        src={entry.image} 
                        alt="Chart" 
                        className="w-24 h-24 object-cover rounded border border-slate-700" 
                      />
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between mb-2">
                          <h3 className="font-semibold text-lg">{entry.symbol}</h3>
                          <span className="text-xs text-slate-500">
                            {new Date(entry.timestamp).toLocaleDateString()}
                          </span>
                        </div>
                        <div className="flex items-center gap-2 mb-2">
                          <span className={`text-sm font-semibold px-2 py-1 rounded ${
                            entry.recommendation?.includes('BUY') ? 'bg-green-900/30 text-green-400' :
                            entry.recommendation?.includes('SELL') ? 'bg-red-900/30 text-red-400' :
                            'bg-yellow-900/30 text-yellow-400'
                          }`}>
                            {entry.recommendation}
                          </span>
                          <span className="text-sm text-slate-400">
                            Score: {entry.score}/100
                          </span>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => loadFromHistory(entry)}
                            className="text-xs bg-violet-600 hover:bg-violet-500 px-3 py-1 rounded transition-colors"
                          >
                            View Analysis
                          </button>
                          <button
                            onClick={() => deleteFromHistory(entry.id)}
                            className="text-xs bg-red-600/20 hover:bg-red-600/30 text-red-400 px-3 py-1 rounded transition-colors"
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}
          </div>
        </div>
      )}

      {/* Trading Journal Modal - Add Trade */}
      {showAddTrade && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-slate-900 border border-slate-700 rounded-lg p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold flex items-center gap-2">
                <Target className="w-6 h-6 text-violet-400" />
                Add Trade to Journal
              </h2>
              <button onClick={() => setShowAddTrade(false)}>
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="space-y-3 md:space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Symbol *</label>
                  <input
                    type="text"
                    value={newTrade.symbol}
                    onChange={(e) => setNewTrade({...newTrade, symbol: e.target.value.toUpperCase()})}
                    placeholder="TSLA"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Side *</label>
                  <select
                    value={newTrade.side}
                    onChange={(e) => setNewTrade({...newTrade, side: e.target.value})}
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  >
                    <option value="long">Long</option>
                    <option value="short">Short</option>
                  </select>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Entry Price *</label>
                  <input
                    type="number"
                    step="0.01"
                    value={newTrade.entry}
                    onChange={(e) => setNewTrade({...newTrade, entry: e.target.value})}
                    placeholder="405.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Exit Price</label>
                  <input
                    type="number"
                    step="0.01"
                    value={newTrade.exit}
                    onChange={(e) => setNewTrade({...newTrade, exit: e.target.value})}
                    placeholder="420.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">
                    Average Price <span className="text-slate-500">(Optional)</span>
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={newTrade.avgPrice}
                    onChange={(e) => setNewTrade({...newTrade, avgPrice: e.target.value})}
                    placeholder="407.50"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                  <p className="text-xs text-slate-500 mt-1">For multiple entries, enter average cost basis</p>
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Trade Type</label>
                  <div className="flex items-center gap-4 mt-3">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        checked={!newTrade.isPaperTrade}
                        onChange={() => setNewTrade({...newTrade, isPaperTrade: false})}
                        className="w-4 h-4 text-violet-600"
                      />
                      <span className="text-sm">Real Money</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        checked={newTrade.isPaperTrade}
                        onChange={() => setNewTrade({...newTrade, isPaperTrade: true})}
                        className="w-4 h-4 text-violet-600"
                      />
                      <span className="text-sm">Paper Trade</span>
                    </label>
                  </div>
                  {newTrade.isPaperTrade && (
                    <p className="text-xs text-blue-400 mt-1">✓ Practice mode - No real money</p>
                  )}
                </div>
              </div>
              
              <div className="grid grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Stop Loss</label>
                  <input
                    type="number"
                    step="0.01"
                    value={newTrade.stopLoss}
                    onChange={(e) => setNewTrade({...newTrade, stopLoss: e.target.value})}
                    placeholder="395.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Target</label>
                  <input
                    type="number"
                    step="0.01"
                    value={newTrade.target}
                    onChange={(e) => setNewTrade({...newTrade, target: e.target.value})}
                    placeholder="425.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Quantity</label>
                  <input
                    type="number"
                    value={newTrade.quantity}
                    onChange={(e) => setNewTrade({...newTrade, quantity: e.target.value})}
                    placeholder="10"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">
                    Confidence <span className="text-slate-500">(Optional)</span>
                  </label>
                  <div className="flex items-center gap-2">
                    <input
                      type="number"
                      min="0"
                      max="100"
                      value={newTrade.confidence}
                      onChange={(e) => setNewTrade({...newTrade, confidence: e.target.value})}
                      placeholder="75"
                      className="flex-1 bg-slate-800 border border-slate-700 rounded px-3 py-2"
                    />
                    <span className="text-slate-400">%</span>
                  </div>
                  <p className="text-xs text-slate-500 mt-1">Your confidence level in this trade</p>
                </div>
                <div className="flex items-end pb-6">
                  <div className="flex gap-1">
                    {[50, 65, 75, 85].map(pct => (
                      <button
                        key={pct}
                        type="button"
                        onClick={() => setNewTrade({...newTrade, confidence: pct.toString()})}
                        className={`px-3 py-1.5 rounded text-xs font-semibold transition-all ${
                          newTrade.confidence === pct.toString()
                            ? 'bg-violet-600 text-white'
                            : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                        }`}
                      >
                        {pct}%
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Entry Date</label>
                  <input
                    type="date"
                    value={newTrade.entryDate}
                    onChange={(e) => setNewTrade({...newTrade, entryDate: e.target.value})}
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Exit Date</label>
                  <input
                    type="date"
                    value={newTrade.exitDate}
                    onChange={(e) => setNewTrade({...newTrade, exitDate: e.target.value})}
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 mb-2">Notes</label>
                <textarea
                  value={newTrade.notes}
                  onChange={(e) => setNewTrade({...newTrade, notes: e.target.value})}
                  placeholder="Why did you take this trade? What was your analysis?"
                  rows="3"
                  className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                />
              </div>
              
              <div className="flex gap-3 pt-4">
                <button
                  onClick={saveTrade}
                  className="flex-1 bg-violet-600 hover:bg-violet-500 text-white rounded-lg py-3 font-semibold transition-colors"
                >
                  Save Trade
                </button>
                <button
                  onClick={() => setShowAddTrade(false)}
                  className="px-6 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Trading Journal Modal - Edit Trade */}
      {showEditTrade && editingTrade && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-slate-900 border border-slate-700 rounded-lg p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold flex items-center gap-2">
                <Pencil className="w-6 h-6 text-violet-400" />
                Edit Trade
              </h2>
              <button onClick={() => { setShowEditTrade(false); setEditingTrade(null); }}>
                <X className="w-6 h-6" />
              </button>
            </div>

            <div className="space-y-3 md:space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Symbol *</label>
                  <input
                    type="text"
                    value={editingTrade.symbol}
                    onChange={(e) => setEditingTrade({...editingTrade, symbol: e.target.value.toUpperCase()})}
                    placeholder="TSLA"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Side *</label>
                  <select
                    value={editingTrade.side}
                    onChange={(e) => setEditingTrade({...editingTrade, side: e.target.value})}
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  >
                    <option value="long">Long</option>
                    <option value="short">Short</option>
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Entry Price *</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingTrade.entry}
                    onChange={(e) => setEditingTrade({...editingTrade, entry: e.target.value})}
                    placeholder="405.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Exit Price</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingTrade.exit}
                    onChange={(e) => setEditingTrade({...editingTrade, exit: e.target.value})}
                    placeholder="420.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">
                    Average Price <span className="text-slate-500">(Optional)</span>
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingTrade.avgPrice || ""}
                    onChange={(e) => setEditingTrade({...editingTrade, avgPrice: e.target.value})}
                    placeholder="407.50"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                  <p className="text-xs text-slate-500 mt-1">For multiple entries, enter average cost basis</p>
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Trade Type</label>
                  <div className="flex items-center gap-4 mt-3">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        checked={!editingTrade.isPaperTrade}
                        onChange={() => setEditingTrade({...editingTrade, isPaperTrade: false})}
                        className="w-4 h-4 text-violet-600"
                      />
                      <span className="text-sm">Real Money</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        checked={editingTrade.isPaperTrade}
                        onChange={() => setEditingTrade({...editingTrade, isPaperTrade: true})}
                        className="w-4 h-4 text-violet-600"
                      />
                      <span className="text-sm">Paper Trade</span>
                    </label>
                  </div>
                  {editingTrade.isPaperTrade && (
                    <p className="text-xs text-blue-400 mt-1">✓ Practice mode - No real money</p>
                  )}
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Stop Loss</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingTrade.stopLoss || ""}
                    onChange={(e) => setEditingTrade({...editingTrade, stopLoss: e.target.value})}
                    placeholder="395.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Target</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingTrade.target || ""}
                    onChange={(e) => setEditingTrade({...editingTrade, target: e.target.value})}
                    placeholder="425.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Quantity</label>
                  <input
                    type="number"
                    value={editingTrade.quantity}
                    onChange={(e) => setEditingTrade({...editingTrade, quantity: e.target.value})}
                    placeholder="10"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">
                    Confidence <span className="text-slate-500">(Optional)</span>
                  </label>
                  <div className="flex items-center gap-2">
                    <input
                      type="number"
                      min="0"
                      max="100"
                      value={editingTrade.confidence || ""}
                      onChange={(e) => setEditingTrade({...editingTrade, confidence: e.target.value})}
                      placeholder="75"
                      className="flex-1 bg-slate-800 border border-slate-700 rounded px-3 py-2"
                    />
                    <span className="text-slate-400">%</span>
                  </div>
                </div>
                <div className="flex items-end pb-2">
                  <div className="flex gap-1">
                    {[50, 65, 75, 85].map(pct => (
                      <button
                        key={pct}
                        type="button"
                        onClick={() => setEditingTrade({...editingTrade, confidence: pct.toString()})}
                        className={`px-3 py-1.5 rounded text-xs font-semibold transition-all ${
                          editingTrade.confidence === pct.toString()
                            ? 'bg-violet-600 text-white'
                            : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                        }`}
                      >
                        {pct}%
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Entry Date</label>
                  <input
                    type="date"
                    value={editingTrade.entryDate || ""}
                    onChange={(e) => setEditingTrade({...editingTrade, entryDate: e.target.value})}
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Exit Date</label>
                  <input
                    type="date"
                    value={editingTrade.exitDate || ""}
                    onChange={(e) => setEditingTrade({...editingTrade, exitDate: e.target.value})}
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm text-slate-400 mb-2">Notes</label>
                <textarea
                  value={editingTrade.notes || ""}
                  onChange={(e) => setEditingTrade({...editingTrade, notes: e.target.value})}
                  placeholder="Why did you take this trade? What was your analysis?"
                  rows="3"
                  className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                />
              </div>

              <div className="flex gap-3 pt-4">
                <button
                  onClick={saveEditTrade}
                  className="flex-1 bg-violet-600 hover:bg-violet-500 text-white rounded-lg py-3 font-semibold transition-colors flex items-center justify-center gap-2"
                >
                  <Save className="w-5 h-5" />
                  Save Changes
                </button>
                <button
                  onClick={() => { setShowEditTrade(false); setEditingTrade(null); }}
                  className="px-6 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Portfolio Modal - Add Position */}
      {showAddPosition && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-slate-900 border border-slate-700 rounded-lg p-6 max-w-md w-full">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold flex items-center gap-2">
                <DollarSign className="w-6 h-6 text-violet-400" />
                Add Position
              </h2>
              <button onClick={() => setShowAddPosition(false)}>
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="space-y-3 md:space-y-4">
              <div>
                <label className="block text-sm text-slate-400 mb-2">Symbol *</label>
                <input
                  type="text"
                  value={newPosition.symbol}
                  onChange={(e) => setNewPosition({...newPosition, symbol: e.target.value.toUpperCase()})}
                  placeholder="TSLA"
                  className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Quantity *</label>
                  <input
                    type="number"
                    value={newPosition.quantity}
                    onChange={(e) => setNewPosition({...newPosition, quantity: e.target.value})}
                    placeholder="10"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Avg Price *</label>
                  <input
                    type="number"
                    step="0.01"
                    value={newPosition.avgPrice}
                    onChange={(e) => setNewPosition({...newPosition, avgPrice: e.target.value})}
                    placeholder="405.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 mb-2">Current Price</label>
                <input
                  type="number"
                  step="0.01"
                  value={newPosition.currentPrice}
                  onChange={(e) => setNewPosition({...newPosition, currentPrice: e.target.value})}
                  placeholder="420.00"
                  className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                />
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 mb-2">Notes</label>
                <textarea
                  value={newPosition.notes}
                  onChange={(e) => setNewPosition({...newPosition, notes: e.target.value})}
                  placeholder="Investment thesis, target price, etc."
                  rows="2"
                  className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                />
              </div>
              
              <div className="flex gap-3 pt-4">
                <button
                  onClick={addPosition}
                  className="flex-1 bg-violet-600 hover:bg-violet-500 text-white rounded-lg py-3 font-semibold transition-colors"
                >
                  Add Position
                </button>
                <button
                  onClick={() => setShowAddPosition(false)}
                  className="px-6 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Portfolio Modal - Edit Position */}
      {showEditPosition && editingPosition && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-slate-900 border border-slate-700 rounded-lg p-6 max-w-md w-full">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold flex items-center gap-2">
                <Pencil className="w-6 h-6 text-violet-400" />
                Edit Position
              </h2>
              <button onClick={() => { setShowEditPosition(false); setEditingPosition(null); }}>
                <X className="w-6 h-6" />
              </button>
            </div>

            <div className="space-y-3 md:space-y-4">
              <div>
                <label className="block text-sm text-slate-400 mb-2">Symbol</label>
                <input
                  type="text"
                  value={editingPosition.symbol}
                  disabled
                  className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-slate-400 cursor-not-allowed"
                />
                <p className="text-xs text-slate-500 mt-1">Symbol cannot be changed</p>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Quantity *</label>
                  <input
                    type="number"
                    value={editingPosition.quantity}
                    onChange={(e) => setEditingPosition({...editingPosition, quantity: e.target.value})}
                    placeholder="10"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Avg Price *</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingPosition.avgPrice}
                    onChange={(e) => setEditingPosition({...editingPosition, avgPrice: e.target.value})}
                    placeholder="405.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm text-slate-400 mb-2">Current Price</label>
                <input
                  type="number"
                  step="0.01"
                  value={editingPosition.currentPrice}
                  onChange={(e) => setEditingPosition({...editingPosition, currentPrice: e.target.value})}
                  placeholder="420.00"
                  className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                />
                <p className="text-xs text-slate-500 mt-1">Auto-updates with live prices when enabled</p>
              </div>

              <div>
                <label className="block text-sm text-slate-400 mb-2">Notes</label>
                <textarea
                  value={editingPosition.notes || ""}
                  onChange={(e) => setEditingPosition({...editingPosition, notes: e.target.value})}
                  placeholder="Investment thesis, target price, etc."
                  rows="2"
                  className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                />
              </div>

              <div className="flex gap-3 pt-4">
                <button
                  onClick={saveEditPosition}
                  className="flex-1 bg-violet-600 hover:bg-violet-500 text-white rounded-lg py-3 font-semibold transition-colors flex items-center justify-center gap-2"
                >
                  <Save className="w-5 h-5" />
                  Save Changes
                </button>
                <button
                  onClick={() => { setShowEditPosition(false); setEditingPosition(null); }}
                  className="px-6 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* PHASE 1: Live Portfolio - Add Position Modal */}
      {showAddPortfolioPosition && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-slate-900 border border-slate-700 rounded-lg p-6 max-w-md w-full">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold flex items-center gap-2">
                <TrendingUp className="w-6 h-6 text-violet-400" />
                Add Position to Live Portfolio
              </h2>
              <button onClick={() => setShowAddPortfolioPosition(false)}>
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="space-y-3 md:space-y-4">
              <div>
                <label className="block text-sm text-slate-400 mb-2">Symbol *</label>
                <input
                  type="text"
                  placeholder="AAPL"
                  onChange={(e) => {
                    const symbol = e.target.value.toUpperCase();
                    e.target.value = symbol;
                  }}
                  className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                  id="livePortfolioSymbol"
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Quantity *</label>
                  <input
                    type="number"
                    placeholder="10"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                    id="livePortfolioQuantity"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Entry Price *</label>
                  <input
                    type="number"
                    step="0.01"
                    placeholder="150.00"
                    className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                    id="livePortfolioEntry"
                  />
                </div>
              </div>
              
              <div className="flex gap-3 pt-4">
                <button
                  onClick={() => {
                    const symbol = document.getElementById('livePortfolioSymbol').value;
                    const quantity = parseFloat(document.getElementById('livePortfolioQuantity').value);
                    const entryPrice = parseFloat(document.getElementById('livePortfolioEntry').value);
                    
                    if (symbol && quantity && entryPrice) {
                      setLivePortfolio(prev => ({
                        ...prev,
                        positions: [...prev.positions, {
                          symbol,
                          quantity,
                          entryPrice,
                          currentPrice: entryPrice, // Will be updated by live updates
                          pnl: 0,
                          pnlPercent: 0
                        }]
                      }));
                      setShowAddPortfolioPosition(false);
                      document.getElementById('livePortfolioSymbol').value = '';
                      document.getElementById('livePortfolioQuantity').value = '';
                      document.getElementById('livePortfolioEntry').value = '';
                    }
                  }}
                  className="flex-1 bg-violet-600 hover:bg-violet-500 text-white rounded-lg py-3 font-semibold transition-colors"
                >
                  Add Position
                </button>
                <button
                  onClick={() => setShowAddPortfolioPosition(false)}
                  className="px-6 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Quick Trade Entry Modal */}
      {showQuickTradeEntry && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[60] p-4 animate-fadeIn" onClick={() => setShowQuickTradeEntry(false)}>
          <div className="bg-slate-900 border border-slate-700/50 rounded-2xl shadow-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-bold flex items-center gap-2"><Zap className="w-5 h-5 text-amber-400" /> Quick Trade Entry</h2>
                <button onClick={() => setShowQuickTradeEntry(false)} className="p-1.5 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors"><X className="w-5 h-5" /></button>
              </div>
              <div className="space-y-3">
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="text-xs text-slate-400 mb-1 block">Ticker</label>
                    <input type="text" placeholder="AAPL" className="w-full bg-slate-800/50 border border-slate-700/30 rounded-lg px-3 py-2 text-white text-sm focus:border-violet-500 focus:outline-none"
                      onKeyDown={e => { if (e.key === 'Enter') { const val = e.target.value.toUpperCase(); if (val) { setTickerSymbol(val); setActiveTab('ticker'); setShowQuickTradeEntry(false); } } }} />
                  </div>
                  <div>
                    <label className="text-xs text-slate-400 mb-1 block">Action</label>
                    <div className="flex gap-2">
                      <button onClick={() => { setActiveTab('journal'); setShowQuickTradeEntry(false); }} className="flex-1 py-2 bg-emerald-600/20 border border-emerald-500/30 rounded-lg text-emerald-400 text-sm font-medium hover:bg-emerald-600/30 transition-all">Buy</button>
                      <button onClick={() => { setActiveTab('journal'); setShowQuickTradeEntry(false); }} className="flex-1 py-2 bg-red-600/20 border border-red-500/30 rounded-lg text-red-400 text-sm font-medium hover:bg-red-600/30 transition-all">Sell</button>
                    </div>
                  </div>
                </div>
                <div className="grid grid-cols-3 gap-2">
                  {['AAPL', 'TSLA', 'NVDA', 'MSFT', 'AMZN', 'SPY'].map(t => (
                    <button key={t} onClick={() => { setTickerSymbol(t); setActiveTab('ticker'); setShowQuickTradeEntry(false); }}
                      className="py-1.5 bg-slate-800/50 border border-slate-700/30 rounded-lg text-xs font-medium text-slate-300 hover:border-violet-500/30 hover:text-violet-300 transition-all">{t}</button>
                  ))}
                </div>
                <p className="text-[10px] text-slate-500 text-center">Type a ticker and press Enter, or click a quick pick above</p>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Keyboard Shortcuts Overlay */}
      {showShortcutsOverlay && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[60] p-4 animate-fadeIn" onClick={() => setShowShortcutsOverlay(false)}>
          <div className="bg-slate-900 border border-slate-700/50 rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-xl font-bold flex items-center gap-2"><Command className="w-5 h-5 text-violet-400" /> Keyboard Shortcuts</h2>
                <button onClick={() => setShowShortcutsOverlay(false)} className="p-1.5 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors"><X className="w-5 h-5" /></button>
              </div>
              <div className="space-y-4">
                {[
                  { category: 'Navigation', shortcuts: [
                    { key: 'd', desc: 'Go to Dashboard' },
                    { key: 'j', desc: 'Go to Journal' },
                    { key: 'q', desc: 'Go to Quick Analysis' },
                  ]},
                  { category: 'Dashboard', shortcuts: [
                    { key: 't', desc: 'Cycle themes (Midnight → Dark → Light)' },
                    { key: '/', desc: 'Focus Quick Analyze bar' },
                  ]},
                  { category: 'Actions', shortcuts: [
                    { key: 'n', desc: 'Quick Trade Entry' },
                    { key: '?', desc: 'Show this shortcuts overlay' },
                  ]},
                ].map(group => (
                  <div key={group.category}>
                    <h3 className="text-xs font-bold text-violet-400 uppercase tracking-wider mb-2">{group.category}</h3>
                    <div className="space-y-1">
                      {group.shortcuts.map(s => (
                        <div key={s.key} className="flex items-center justify-between py-1.5 px-3 rounded-lg hover:bg-slate-800/50">
                          <span className="text-sm text-slate-300">{s.desc}</span>
                          <kbd className="px-2 py-0.5 bg-slate-800 border border-slate-600 rounded text-xs font-mono text-violet-300">{s.key}</kbd>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Updates & Changelog Modal */}
      {showChangelog && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[60] p-4 animate-fadeIn" onClick={() => setShowChangelog(false)}>
          <div className="bg-slate-900 border border-slate-700/50 rounded-2xl shadow-2xl w-full max-w-lg max-h-[85vh] overflow-hidden" onClick={(e) => e.stopPropagation()} style={{ animation: 'slideUp 0.25s ease-out' }}>
            <div className="px-6 py-4 border-b border-slate-700/30 bg-gradient-to-r from-violet-500/10 to-purple-500/10">
              <div className="flex items-center justify-between">
                <h2 className="font-bold text-lg flex items-center gap-2">
                  <Sparkles className="w-5 h-5 text-violet-400" />
                  Updates & Changelog
                </h2>
                <button onClick={() => setShowChangelog(false)} className="p-1.5 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors">
                  <X className="w-5 h-5" />
                </button>
              </div>
              <p className="text-xs text-slate-500 mt-1">Latest improvements and bug fixes for MODUS</p>
            </div>
            <div className="overflow-y-auto max-h-[calc(85vh-80px)] p-4 space-y-4">
              {changelogEntries.map((entry, idx) => (
                <div key={entry.version} className={`rounded-xl border p-4 ${idx === 0 ? 'bg-violet-500/5 border-violet-500/20' : 'bg-slate-800/30 border-slate-700/20'}`}>
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <span className={`text-xs font-bold px-2 py-0.5 rounded-md ${idx === 0 ? 'bg-violet-500/20 text-violet-300' : 'bg-slate-700/50 text-slate-400'}`}>v{entry.version}</span>
                      {idx === 0 && <span className="text-[9px] bg-emerald-500/20 text-emerald-400 px-1.5 py-0.5 rounded font-bold">LATEST</span>}
                    </div>
                    <span className="text-xs text-slate-500">{new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                  </div>
                  <h4 className="font-semibold text-sm text-white mb-3">{entry.title}</h4>
                  <div className="space-y-1.5">
                    {entry.changes.map((c, i) => (
                      <div key={i} className="flex items-start gap-2.5 text-xs">
                        <span className={`mt-0.5 flex-shrink-0 w-4 h-4 rounded flex items-center justify-center text-[9px] font-bold ${
                          c.type === 'feature' ? 'bg-emerald-500/20 text-emerald-400' :
                          c.type === 'fix' ? 'bg-red-500/20 text-red-400' :
                          'bg-blue-500/20 text-blue-400'
                        }`}>
                          {c.type === 'feature' ? '✦' : c.type === 'fix' ? '✗' : '↑'}
                        </span>
                        <span className="text-slate-300 leading-relaxed">{c.text}</span>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* PHASE 1: Position Sizing Calculator Modal */}
      {showPositionSizer && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-700/50 rounded-2xl p-6 max-w-2xl w-full shadow-2xl">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold flex items-center gap-3">
                <div className="p-2.5 bg-violet-500/20 rounded-xl">
                  <Target className="w-6 h-6 text-violet-400" />
                </div>
                <span className="bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">Position Sizing Calculator</span>
              </h2>
              <button 
                onClick={() => setShowPositionSizer(false)}
                className="p-2 hover:bg-slate-800 rounded-xl transition-colors text-slate-400 hover:text-white"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            
            <div className="grid grid-cols-2 gap-4 mb-6">
              <div>
                <label className="block text-sm text-slate-400 font-medium mb-2">Account Size ($)</label>
                <input
                  type="number"
                  value={positionSizerInputs.accountSize}
                  onChange={(e) => setPositionSizerInputs({...positionSizerInputs, accountSize: parseFloat(e.target.value) || 0})}
                  placeholder="10000"
                  className="w-full bg-slate-800/80 border border-slate-600/50 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 transition-all"
                />
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 font-medium mb-2">Risk per Trade (%)</label>
                <input
                  type="number"
                  step="0.1"
                  value={positionSizerInputs.riskPercent}
                  onChange={(e) => {
                    const risk = parseFloat(e.target.value) || 0;
                    setPositionSizerInputs({
                      ...positionSizerInputs,
                      riskPercent: risk,
                      riskDollars: (positionSizerInputs.accountSize * risk) / 100
                    });
                  }}
                  placeholder="1"
                  className="w-full bg-slate-800/80 border border-slate-600/50 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 transition-all"
                />
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 font-medium mb-2">Entry Price ($)</label>
                <input
                  type="number"
                  step="0.01"
                  value={positionSizerInputs.entryPrice}
                  onChange={(e) => setPositionSizerInputs({...positionSizerInputs, entryPrice: e.target.value})}
                  placeholder="50.00"
                  className="w-full bg-slate-800/80 border border-slate-600/50 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 transition-all"
                />
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 font-medium mb-2">Stop Loss ($)</label>
                <input
                  type="number"
                  step="0.01"
                  value={positionSizerInputs.stopLoss}
                  onChange={(e) => setPositionSizerInputs({...positionSizerInputs, stopLoss: e.target.value})}
                  placeholder="48.00"
                  className="w-full bg-slate-800/80 border border-slate-600/50 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 transition-all"
                />
              </div>
              
              <div>
                <label className="block text-sm text-slate-400 mb-2">Target Price ($) - Optional</label>
                <input
                  type="number"
                  step="0.01"
                  value={positionSizerInputs.target}
                  onChange={(e) => setPositionSizerInputs({...positionSizerInputs, target: e.target.value})}
                  placeholder="55.00"
                  className="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
                />
              </div>
              
              <div className="flex items-end">
                <button
                  onClick={() => {
                    const entry = parseFloat(positionSizerInputs.entryPrice);
                    const stop = parseFloat(positionSizerInputs.stopLoss);
                    const target = parseFloat(positionSizerInputs.target);
                    const riskDollars = positionSizerInputs.riskDollars;
                    
                    if (entry && stop && riskDollars) {
                      const riskPerShare = Math.abs(entry - stop);
                      const shares = Math.floor(riskDollars / riskPerShare);
                      const positionSize = shares * entry;
                      const maxLoss = shares * riskPerShare;
                      const potentialGain = target ? shares * (target - entry) : 0;
                      const rr = target ? (target - entry) / (entry - stop) : 0;
                      
                      setPositionSizerResult({
                        shares,
                        positionSize,
                        maxLoss,
                        potentialGain,
                        riskReward: rr,
                        percentOfAccount: (positionSize / positionSizerInputs.accountSize) * 100
                      });
                    }
                  }}
                  className="w-full bg-violet-600 hover:bg-violet-500 text-white rounded-lg py-3 font-semibold transition-colors"
                >
                  Calculate
                </button>
              </div>
            </div>

            {positionSizerResult && (
              <div className="bg-violet-900/20 border border-violet-500/30 rounded-lg p-6">
                <h3 className="text-lg font-bold mb-4">Results</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <div className="text-xs text-slate-400 mb-1">Shares to Buy</div>
                    <div className="text-2xl font-bold text-violet-400">{positionSizerResult.shares}</div>
                  </div>
                  <div>
                    <div className="text-xs text-slate-400 mb-1">Position Size</div>
                    <div className="text-2xl font-bold text-violet-400">${positionSizerResult.positionSize.toFixed(2)}</div>
                  </div>
                  <div>
                    <div className="text-xs text-slate-400 mb-1">Max Loss</div>
                    <div className="text-2xl font-bold text-red-400">${positionSizerResult.maxLoss.toFixed(2)}</div>
                  </div>
                  <div>
                    <div className="text-xs text-slate-400 mb-1">% of Account</div>
                    <div className="text-2xl font-bold text-blue-400">{positionSizerResult.percentOfAccount.toFixed(2)}%</div>
                  </div>
                  {positionSizerResult.riskReward > 0 && (
                    <>
                      <div>
                        <div className="text-xs text-slate-400 mb-1">Potential Gain</div>
                        <div className="text-2xl font-bold text-green-400">${positionSizerResult.potentialGain.toFixed(2)}</div>
                      </div>
                      <div>
                        <div className="text-xs text-slate-400 mb-1">Risk:Reward</div>
                        <div className="text-2xl font-bold text-emerald-400">1:{positionSizerResult.riskReward.toFixed(2)}</div>
                      </div>
                    </>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Backtesting Results Modal */}
      {showBacktest && backtestResults && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-slate-900 border border-slate-700 rounded-lg p-6 max-w-3xl w-full">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold flex items-center gap-2">
                <Activity className="w-6 h-6 text-violet-400" />
                Backtest Results
              </h2>
              <button onClick={() => setShowBacktest(false)}>
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div className="bg-slate-800 rounded-lg p-4">
                <div className="text-xs text-slate-500 mb-1">Total Analyses</div>
                <div className="text-3xl font-bold">{backtestResults.totalAnalyses}</div>
              </div>
              <div className="bg-green-900/20 rounded-lg p-4">
                <div className="text-xs text-slate-500 mb-1">Wins</div>
                <div className="text-3xl font-bold text-green-400">{backtestResults.wins}</div>
              </div>
              <div className="bg-red-900/20 rounded-lg p-4">
                <div className="text-xs text-slate-500 mb-1">Losses</div>
                <div className="text-3xl font-bold text-red-400">{backtestResults.losses}</div>
              </div>
              <div className="bg-violet-900/20 rounded-lg p-4">
                <div className="text-xs text-slate-500 mb-1">Win Rate</div>
                <div className="text-3xl font-bold text-violet-400">{backtestResults.winRate}%</div>
              </div>
            </div>
            
            <div className="grid grid-cols-3 gap-4 mb-6">
              <div className="bg-slate-800 rounded-lg p-4">
                <div className="text-xs text-slate-500 mb-1">Avg Return</div>
                <div className="text-xl font-semibold text-green-400">+{backtestResults.avgReturn}%</div>
              </div>
              <div className="bg-slate-800 rounded-lg p-4">
                <div className="text-xs text-slate-500 mb-1">Best Trade</div>
                <div className="text-xl font-semibold text-green-400">+{backtestResults.bestTrade}%</div>
              </div>
              <div className="bg-slate-800 rounded-lg p-4">
                <div className="text-xs text-slate-500 mb-1">Worst Trade</div>
                <div className="text-xl font-semibold text-red-400">{backtestResults.worstTrade}%</div>
              </div>
            </div>
            
            <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mb-4">
              <p className="text-sm text-blue-200">
                📊 <strong>Signal Breakdown:</strong> {backtestResults.buySignals} Buy signals, 
                {backtestResults.sellSignals} Sell signals, {backtestResults.holdSignals} Hold signals
              </p>
            </div>
            
            <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4">
              <p className="text-xs text-yellow-200">
                <strong>Note:</strong> This is a simulated backtest based on your analysis history. 
                In a production version, actual trade outcomes would be tracked for real accuracy metrics.
              </p>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}

export default App;
